# 第 4 章 指令系统

## 指令系统

### 指令集体系结构

机器指令(简称指令)是指示计算机执行某种操作的命令。一台计算机的所有指令的集合构成该机的指令系统，也称指令集。

ISA 规定的内容 主要包括:

1. 指令格式，指令寻址方式，操作类型，以及每种操作对应的操作数的相应规定。

2. 操作数的类型，操作数寻址方式，以及是按大端方式还是按小端方式存放。

3. 程序可访问的寄存器编号、个数和位数，存储空间的大小和编址方式。

4. 指令执行过程的控制方式等，包括程序计数器、条件码定义等。

### 指令的基本格式

| 操作码 | 地址码字段 |

- 操作码：指出该指令应执行什么操作以及具有何种功能。
- 地址码：给出被操作的信息(指令或数据)的地址，包括参加运算的一个或多个操作数的地址、运算结果的保存地址、程序的转移地址、被调用子程序的入口地址等
- 指令字长：是指一条指令所包含的二进制代码的位数，其取决于操作码的长度、地址码的长度 和地址码的个数。把指令长度等于机器字长的指令称为单字长指令，指令长度等于半个机器 字长的指令称为半字长指令，指令长度等于两个机器字长的指令称 双字长指令。

在一个指令系统中，若所有指令的长度都是相等的，则称为定长指令字结构。定字长指令的执行速度快，控制简单。若各种指令的长度随指令功能而异，则称为变长指令字结构。然而，因为主在一般是按字节编址的，所以指令字长通常为字节的整数背。

常见指令格式：

1. 零地址指令
2. 一地址指令
3. 二地址指令
4. 三地址指令
5. 四地址指令

### 定长操作码指令格式

定长操作码指令在指令字的最高位部分分配固定的若干位(定长)表示操作码。一般 n 位操作码字段的指令系统量大能够表示 2^n 条指令。

### 扩展操作码指令格式

变长操作码 方法是扩展操作码，它使操作码 的长度随地址码的减少而增加，不同地址数的指令可具有不同长度的操作码，从而在满足需要的前提下，有效地缩短指令字长

![1694262218528](image/ComputerOrganization/1694262218528.png)

### 指令的操作类型

1. 数据传送
2. 算术和逻辑运算
3. 移位操作
4. 转移操作
5. 输入输出操作

## 指令的寻址方式

#### 指令地址码的个数

一条指令中必须明确地(显示)或隐含地包含以下信息。
(1)操作码。指定操作类型，如移位、加、减、乘、除、传送等
(2)源操作数或其地址。指出一个或多个源操作数或其所在地址，可能是主(虚)存地址，寄存器编号或 I/O 端口，也可以在指令中直接给出一个立即数。
(3)结果的地址。结果所存放的地址，可以是主存地址、寄存器编号或 I/O 端口。
(4)下一条指令地址。一般隐含在 PC 中，指令按顺序执行时，只要自动将 PC 的值加上指令的长度，就可以得出下一条指令的地址，如果遇到转移指令，则需要由指令给出转移到的目标地址。

#### 指令格式设计原则

(1)指令应尽量短。降低开销
(2)要有足够的操作码位数。向后兼容
(3)操作码的编码必须有唯一的解释。
(4)指令长度应是字节的整数倍。指令存放在内存中，而内存往往按字节编址，指令的长度为字节的整数倍，便于指令的读取和指令地址的计算。
(5)合理选择地址字段的个数。
(6)指令应尽量规整。

![1694262189366](image/ComputerOrganization/1694262189366.png)

### 指令系统设计

#### 基本设计问题

#### 拓展操作码

#### 操作数类型

(1)指针或地址
(2)数值数据。
(3)位、位串、字符和字符串。
(4)逻辑(布尔)数据

#### 寻址方式

通常把指令中给出的操作数所在的存储单元的地址称为有效地址，存储单元地址可能是主存物理地址，也可能是虚拟地址。
常见的寻址方式： 1.立即寻址
指令中直接给出操作数本身，这种操作数称为立即数。

op rs rt immediate 2.直接寻址
指令中给出的地址码是操作数的有效地址，这种地址称为直接地址或绝对地址。 3.间接寻址
指令中给出的地址码是存放操作数有效地址的主存单元地址。 4.寄存器寻址
指令中给出的地址码是操作数所在的寄存器编号，操作数在寄存器中。
优点：
(1)寄存器数量远小于内存单元数，故寄存器编号和存储地址短，因而寄存器寻址方式的指令较短。
(2)操作数已在 CPU 中，不用访存，因而指令执行的速度快。 5.寄存器间接寻址
指令中给出的地址码是一个寄存器编号，该寄存器中存放的是操作数的有效地址。指令长度和寄存器寻址指令差不多，但由于要访存，所以寄存器间接寻址指令的执行时间比寄存器寻址指令的执行时间更长。 6.变址寻址
变址寻址方式主要是用于对线性表之类的数组元素进行方便的访问。
采用变址寻址方式时，指令中的地址码字段 A 给出的是一个基准地址，例如数组的起始地址，而数组元素相对于基准地址的偏移量在指令中明显或隐含地由变址寄存器 I 给出，这样变址寄存器(简称变址器)的内容实际上就相当于数组元素的下标，每个元素的有效地址为基准地址加变址寄存器的内容，即操作数的有效地址 EA = (I) + A 其中 I 表示变址寄存器 I 的内容 7.相对寻址
如果某指令的操作数的有效地址或转移目标地址位于该指令所在位置的钱、后某个固定位置上，则该操作数或转移目标可用相对寻址方式。采用相对寻址方式时，指令中的地址码字段 A 给出一个偏移量，基准地址隐含由 PC 给出，即操作数有效地址或目标地址 EA = (PC) + A
相对寻址方式可用来实现公共子程序的浮动或实现相对转移。 8.基址寻址
基址寻址方式下，指令中的地址码字段 A 给出一个偏移量，基准地址可以明显或隐含地由基址寄存器 B 给出。
操作数有效地址 EA = (B)+A
![15](./img/基址寄存器寻址方式.png)
变址、基址和相对 3 中寻址方式，都是将某个寄存器的内容与一个形式地址相加来生成操作数的有效地址。统称为偏移寻址。 9.其他寻址方式
为了缩短指令字长度，有些指令采用隐含地址码方式。即在指令中不明显给出操作数地址或变址寄存器和基址寄存器编号，而是由操作码隐含给出。

#### 操作类型

1.算术和逻辑运算指令
加(ADD)、减(SUB)、比较(CMP)、乘(MUL)、除(DIV)、与(AND)、或(OR)、取反(NOT)、取负(NEG)、异或(XOR)、加 1(INC)、减 1(DEC)等。 2.移位指令
算术移位、逻辑移位、循环移位、半字交换。
算术左移：操作数的各位依次向左移，低位补零。有些机器将最高位移入进位标志 CF 位，这样可以通过判断符号标志和进位标志是否相等就可以判断是否发生了溢出。
算术右移：各位依次向右移，高位补符号。有些机器将最低位移入进位标志位。
逻辑左移：同算术左移。
逻辑右移：各位依次向右移，高位补零。
小循环左移：最高位移入进位标志位，同时也移入最低位。
小循环右移：最低位移入进位标志位，同时也移入最高位。
大循环左移：最高位移入进位标志位，而进位标志位移入最低位。
大循环右移：最低位移入进位标志位，而进位标志位移入最高位。 3.传送指令
传送指令通常有寄存器之间的传送 MOV、从内存单元读取数据到 CPU 寄存器 LOAD、从 CPU 寄存器写数据到内存单元 STORE 等。 4.串指令
串指令是对字符串进行操作的指令。如串传送，串比较，检索和传送出转换等指令。 5.顺序控制指令
顺序控制指令用来控制程序执行的顺序。有条件转移 BRANCH、无条件转移 JMP、跳步 SKIP、调用 CALL、返回 RET 等指令。
顺序控制类指令的功能通过将转移目标地址送到 PC 中来实现。
无条件转移指令在任何情况下都执行转移操作，而条件转移指令(分支指令)仅仅在特定条件满足时才执行转移操作。
调用指令也称为转子指令，和转移指令的根本区别在于执行调用指令时必须保存下一条指令的地址（返回地址）。调用指令用于子程序调用(即过程调用或函数调用)，当子程序执行结束时，根据返回地址回到主程序继续执行；而转移指令则不返回执行，因而无法保存返回地址。
返回指令的功能是在子程序执行完毕时，将事先保存的返回地址送到 PC，这样处理器就能回到原来的主程序继续执行。
6.CPU 控制指令
停机、开中断、关中断】系统模式切换以及进入特殊处理程序等指令。大多数机器将这类指令划为“特权”指令(也称为管态指令)，只能在内核代码执行时使用。 7.输入输出指令
这类指令用户完成 CPU 与外部设备交换数据或传送控制指令及状态信息。

#### 操作码编码

指令的操作码字段可以是固定长度，也可以是可变长度。 1.定长操作码编码
指令的操作码部分采用固定长度编码，这种译码方式方便，指令执行速度更快，但信息冗余。 2.拓展操作码编码
拓展操作码编码方式将操作码的编码长度分成几种固定长度的格式。操作码长度不固定，是可变的。

#### 标志信息的生成和使用

常用的条件转移指令：
![16](./img/常见的条件转移指令.png)
CF = Count 异或 Sub

#### 高级语言于机器级代码之间的对应

![1694518290426](image/ComputerOrganization/1694518290426.png)

#### 常见的 x86 汇编指令

![1694518300515](image/ComputerOrganization/1694518300515.png)

#### AT&T 格式和 Interl 格式

![1694518313870](image/ComputerOrganization/1694518313870.png)

#### 选择语句的机器级表示

![1694518331921](image/ComputerOrganization/1694518331921.png)

![1694518364500](image/ComputerOrganization/1694518364500.png)![1694518374706](image/ComputerOrganization/1694518374706.png)

#### 循环语句的机器级表示

![1694601803725](image/ComputerOrganization/1694601803725.png)

#### Call 和 Ret 指令（函数调用的机器级表示）

#### 指令系统设计风格

1.按操作数位置指定风格来分
1） 累加器型指令系统
总是把其中一个操作数隐含在累加器(一般用 AC 表示)中，指令执行的结果也总是送到累加器中。
2） 栈型指令系统
JAVA 虚拟机采用的是栈型指令系统。FILO。操作数总是来自栈顶。通常是零地址或异地址指令。
3）通用寄存器型指令系统
使用通用寄存器而不是累加寄存器。其指令的操作数可以是立即数，或来自通用寄存器(R)，或来自存储单元(S)。
4）load/Store 型指令系统
也是通过使用通用寄存器来来存放运算过程中的临时数据。只有取数指令和存数指令才可以访问存储器，运算类指令不能访存。

2.指令格式的复杂程度来分
1）CISC 风格指令系统(complex Instruction Set Computer )
特点：
（1）指令系统复杂。指令多，寻址方式多，指令格式多。
（2）指令周期长。绝大多数指令需要多个时钟周期才能完成。
（3）指令周期差距大。各种指令都能访问存储器，使得简单指令和复杂指令所用的时钟周期数相差很大，不利于指令流水线。
（4）采用微程序控制。
（5）难以进行编译优化。

2）RISC 风格指令系统 (Reduced Instruction Set Computer)
（1）指令数目少，只包含使用频度高的简单指令。
（2）指令格式规整。寻址方式少，指令格式少，指令长度一致
（3）采用 Load/Store 型指令设计风格。
（4）采用流水线方式执行指令。
（5）采用大量通用寄存器。
（6）采用硬连线控制器。
（7）采用优化的编译系统。
