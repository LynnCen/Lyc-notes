# ç¬¬7ç« ï¼šäº‹ä»¶ç³»ç»Ÿä¸ç¢°æ’æ£€æµ‹

## æœ¬ç« æ¦‚è¦

**æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•ç²¾ç¡®åˆ¤æ–­ç”¨æˆ·ç‚¹å‡»äº†å“ªä¸ªå…ƒç´ ï¼Ÿ

åœ¨å›¾å½¢ç¼–è¾‘å™¨ä¸­ï¼Œå½“ç”¨æˆ·ç‚¹å‡»ç”»å¸ƒæ—¶ï¼Œç³»ç»Ÿéœ€è¦å¿«é€Ÿå‡†ç¡®åœ°åˆ¤æ–­ç‚¹å‡»ä½ç½®å¯¹åº”å“ªä¸ªå›¾å½¢å…ƒç´ ã€‚è¿™æ¶‰åŠåˆ°ä¸¤ä¸ªæ ¸å¿ƒæŠ€æœ¯ï¼š

1. **äº‹ä»¶è¾¹ç•Œï¼ˆEventBoundaryï¼‰**ï¼šç®¡ç†æ•´ä¸ªç¢°æ’æ£€æµ‹ç³»ç»Ÿï¼Œåè°ƒå…ƒç´ éå†å’Œæ£€æµ‹ç­–ç•¥
2. **ç¢°æ’æ£€æµ‹ç®—æ³•**ï¼šå®é™…åˆ¤æ–­ç‚¹/çŸ©å½¢ä¸å…ƒç´ æ˜¯å¦ç›¸äº¤çš„æ•°å­¦æ–¹æ³•

æœ¬ç« å°†æ·±å…¥åˆ†æè¿™ä¸¤å¤§ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ã€‚

---

## ç›®å½•

- [7.1 EventBoundary äº‹ä»¶è¾¹ç•Œ](#71-eventboundary-äº‹ä»¶è¾¹ç•Œ)
  - [7.1.1 æ ¸å¿ƒèŒè´£](#711-æ ¸å¿ƒèŒè´£)
  - [7.1.2 æ¶æ„è®¾è®¡](#712-æ¶æ„è®¾è®¡)
  - [7.1.3 é€’å½’éå†ç­–ç•¥](#713-é€’å½’éå†ç­–ç•¥)
- [7.2 ç‚¹å‡»æ£€æµ‹ hitTest](#72-ç‚¹å‡»æ£€æµ‹-hittest)
  - [7.2.1 æ£€æµ‹ç±»å‹åˆ†å±‚](#721-æ£€æµ‹ç±»å‹åˆ†å±‚)
  - [7.2.2 å…ƒç´ çº§ç‚¹å‡»æ£€æµ‹](#722-å…ƒç´ çº§ç‚¹å‡»æ£€æµ‹)
  - [7.2.3 åŒ…å›´ç›’æ£€æµ‹](#723-åŒ…å›´ç›’æ£€æµ‹)
  - [7.2.4 æœ‰å‘åŒ…å›´ç›’æ£€æµ‹](#724-æœ‰å‘åŒ…å›´ç›’æ£€æµ‹)
- [7.3 åŒºåŸŸæ£€æµ‹ intersect](#73-åŒºåŸŸæ£€æµ‹-intersect)
  - [7.3.1 æ¡†é€‰åœºæ™¯åˆ†æ](#731-æ¡†é€‰åœºæ™¯åˆ†æ)
  - [7.3.2 ç›¸äº¤åˆ¤å®šç­–ç•¥](#732-ç›¸äº¤åˆ¤å®šç­–ç•¥)
  - [7.3.3 å•æ¬¡æ£€æµ‹ä¸æ‰¹é‡æ£€æµ‹](#733-å•æ¬¡æ£€æµ‹ä¸æ‰¹é‡æ£€æµ‹)
- [7.4 SAT åˆ†ç¦»è½´ç®—æ³•](#74-sat-åˆ†ç¦»è½´ç®—æ³•)
  - [7.4.1 ç®—æ³•åŸç†](#741-ç®—æ³•åŸç†)
  - [7.4.2 æ•°å­¦æ¨å¯¼](#742-æ•°å­¦æ¨å¯¼)
  - [7.4.3 ä»£ç å®ç°](#743-ä»£ç å®ç°)
  - [7.4.4 æ€§èƒ½ä¼˜åŒ–](#744-æ€§èƒ½ä¼˜åŒ–)
- [7.5 é®ç½©å±‚å¤„ç†](#75-é®ç½©å±‚å¤„ç†)
  - [7.5.1 Cover Mask æœºåˆ¶](#751-cover-mask-æœºåˆ¶)
  - [7.5.2 å…ƒç´  Mask æ£€æµ‹](#752-å…ƒç´ -mask-æ£€æµ‹)
  - [7.5.3 åƒç´ çº§ç¢°æ’æ£€æµ‹](#753-åƒç´ çº§ç¢°æ’æ£€æµ‹)
- [7.6 Bypass ç­–ç•¥](#76-bypass-ç­–ç•¥)
  - [7.6.1 ç­–ç•¥ç±»å‹](#761-ç­–ç•¥ç±»å‹)
  - [7.6.2 åº”ç”¨åœºæ™¯](#762-åº”ç”¨åœºæ™¯)
  - [7.6.3 å®ç°æœºåˆ¶](#763-å®ç°æœºåˆ¶)
- [7.7 æœ¬ç« å°ç»“](#77-æœ¬ç« å°ç»“)

---

## 7.1 EventBoundary äº‹ä»¶è¾¹ç•Œ

### 7.1.1 æ ¸å¿ƒèŒè´£

`EventBoundary` æ˜¯æ— é™ç”»å¸ƒä¸­äº‹ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EventBoundary èŒè´£                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. ç‚¹å‡»æ£€æµ‹ï¼ˆhitTestï¼‰                                       â”‚
â”‚     â”œâ”€â”€ åˆ¤æ–­ç‚¹å‡»ä½ç½®å‘½ä¸­å“ªä¸ªå…ƒç´                               â”‚
â”‚     â””â”€â”€ æ”¯æŒå¤šç§æ£€æµ‹ç²¾åº¦ï¼ˆå…ƒç´ /åŒ…å›´ç›’/æœ‰å‘åŒ…å›´ç›’ï¼‰             â”‚
â”‚                                                              â”‚
â”‚  2. åŒºåŸŸæ£€æµ‹ï¼ˆintersectï¼‰                                     â”‚
â”‚     â”œâ”€â”€ æŸ¥æ‰¾ä¸çŸ©å½¢åŒºåŸŸç›¸äº¤çš„æ‰€æœ‰å…ƒç´                           â”‚
â”‚     â””â”€â”€ ç”¨äºæ¡†é€‰ã€ç¢°æ’åˆ¤æ–­ç­‰åœºæ™¯                              â”‚
â”‚                                                              â”‚
â”‚  3. é®ç½©ç®¡ç†ï¼ˆmasksï¼‰                                         â”‚
â”‚     â”œâ”€â”€ ç®¡ç†è¦†ç›–é®ç½©é›†åˆ                                      â”‚
â”‚     â””â”€â”€ é®ç½©åŒºåŸŸé˜»æ–­ç‚¹å‡»äº‹ä»¶ç©¿é€                              â”‚
â”‚                                                              â”‚
â”‚  4. éå†æ§åˆ¶ï¼ˆBypassï¼‰                                        â”‚
â”‚     â”œâ”€â”€ æ§åˆ¶å…ƒç´ çš„æ£€æµ‹è¡Œä¸º                                    â”‚
â”‚     â””â”€â”€ æ”¯æŒ Skip/Pass/Hits/None ç­–ç•¥                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.1.2 æ¶æ„è®¾è®¡

`EventBoundary` çš„ç±»ç»“æ„ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

export interface EventBoundaryOptions {
    viewport: IViewport<IPageVm>;
}

export class EventBoundary implements IEventBoundary {
    // è§†å£å¼•ç”¨ï¼Œç”¨äºè·å–é¡µé¢å…ƒç´ æ ‘
    private viewport: IViewport<IPageVm>;
    
    // è¦†ç›–é®ç½©é›†åˆ
    private masks: Set<MaskTarget> = new Set();
    
    constructor(options: EventBoundaryOptions) {
        const { viewport } = options;
        this.viewport = viewport;
    }
    
    // å…¬å¼€ API
    hitTest(point: IPointData | Rectangle, test?: TestFn): IBaseElementVm | null;
    hitTestBounds(point: IPointData | Rectangle, test?: TestFn): IBaseElementVm | null;
    hitTestOrientedBounds(point: IPointData, test?: TestFn): IBaseElementVm | null;
    intersect(rect: Rectangle, test?: TestFn): IBaseElementVm[];
    intersectBounds(rect: Rectangle, test?: TestFn): IBaseElementVm[];
    intersectOrientedBounds(rect: Rectangle, test?: TestFn): IBaseElementVm[];
    
    // é®ç½©ç®¡ç†
    addCoverMask(mask: MaskTarget): void;
    removeCoverMask(mask: MaskTarget): void;
}
```

**è®¾è®¡è¦ç‚¹**ï¼š

1. **ä¾èµ– Viewport**ï¼šé€šè¿‡ viewport è·å–é¡µé¢çš„å…ƒç´ æ ‘ï¼ˆ`viewport.page.children`ï¼‰
2. **é®ç½©é›†åˆ**ï¼šä½¿ç”¨ `Set` å­˜å‚¨ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ /ç§»é™¤
3. **æ³›å‹æ£€æµ‹å‡½æ•°**ï¼š`TestFn` å…è®¸å¤–éƒ¨æ§åˆ¶æ¯ä¸ªå…ƒç´ çš„æ£€æµ‹è¡Œä¸º

### 7.1.3 é€’å½’éå†ç­–ç•¥

`EventBoundary` é‡‡ç”¨**æ·±åº¦ä¼˜å…ˆã€ä»åå‘å‰**çš„é€’å½’éå†ç­–ç•¥ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

private hitTestRecursive<T extends IPointData | Rectangle>(
    point: T,
    element: IBaseElementVm,
    hitTest: HitTest<T>,
    test: TestFn<IBaseElementVm>,
): IBaseElementVm | null {
    const bypass = test(element);
    
    // 1. Skip ç­–ç•¥ï¼šè·³è¿‡å…ƒç´ åŠå…¶å­å…ƒç´ 
    if (bypass === Bypass.Skip) {
        return null;
    }
    
    // 2. å…ˆæ£€æµ‹å½“å‰å…ƒç´ æ˜¯å¦å‘½ä¸­
    if (!hitTest(point, element)) {
        return null;
    }
    
    // 3. Hits ç­–ç•¥ï¼šç›´æ¥è¿”å›å½“å‰å…ƒç´ ï¼Œä¸å†æ£€æµ‹å­å…ƒç´ 
    if (bypass === Bypass.Hits) {
        return element;
    }
    
    // 4. é€’å½’æ£€æµ‹å­å…ƒç´ ï¼ˆä»åå‘å‰ï¼Œåç»˜åˆ¶çš„åœ¨ä¸Šå±‚ï¼‰
    for (let i = element.children.length - 1; i >= 0; i--) {
        const child = element.children[i];
        const hits = this.hitTestRecursive(point, child, hitTest, test);
        
        if (hits) {
            return hits;
        }
    }
    
    // 5. Pass ç­–ç•¥ï¼šç©¿é€å½“å‰å…ƒç´ 
    if (bypass === Bypass.Pass) {
        return null;
    }
    
    // 6. None ç­–ç•¥ï¼šè¿”å›å½“å‰å…ƒç´ 
    return element;
}
```

**éå†é¡ºåºå›¾ç¤º**ï¼š

```
å…ƒç´ å±‚çº§ï¼ˆç»˜åˆ¶é¡ºåºä»ä¸‹åˆ°ä¸Šï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Page                                 â”‚
â”‚ â”œâ”€â”€ Element A (index: 0, æœ€å…ˆç»˜åˆ¶)   â”‚
â”‚ â”‚   â”œâ”€â”€ A1                           â”‚
â”‚ â”‚   â””â”€â”€ A2                           â”‚
â”‚ â”œâ”€â”€ Element B (index: 1)             â”‚
â”‚ â”‚   â”œâ”€â”€ B1                           â”‚
â”‚ â”‚   â””â”€â”€ B2                           â”‚
â”‚ â””â”€â”€ Element C (index: 2, æœ€åç»˜åˆ¶)   â”‚ â† æœ€ä¸Šå±‚
â”‚     â”œâ”€â”€ C1                           â”‚
â”‚     â””â”€â”€ C2                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

hitTest éå†é¡ºåºï¼š
1. ä» Page.children æœ«å°¾å¼€å§‹ â†’ Element C
2. é€’å½’è¿›å…¥ C çš„å­å…ƒç´  â†’ C2, C1ï¼ˆä»åå‘å‰ï¼‰
3. è‹¥ C æœªå‘½ä¸­ï¼Œç»§ç»­ â†’ Element B
4. é€’å½’è¿›å…¥ B çš„å­å…ƒç´  â†’ B2, B1
5. è‹¥ B æœªå‘½ä¸­ï¼Œç»§ç»­ â†’ Element A
6. é€’å½’è¿›å…¥ A çš„å­å…ƒç´  â†’ A2, A1
```

**ä¸ºä»€ä¹ˆä»åå‘å‰éå†ï¼Ÿ**

åœ¨å›¾å½¢æ¸²æŸ“ä¸­ï¼Œåæ·»åŠ çš„å…ƒç´ ç»‘å®šåœ¨ä¸Šå±‚ã€‚ç”¨æˆ·ç‚¹å‡»æ—¶ï¼ŒæœŸæœ›å‘½ä¸­è§†è§‰ä¸Šæœ€ä¸Šå±‚çš„å…ƒç´ ã€‚ä»åå‘å‰éå†ç¡®ä¿ä¸Šå±‚å…ƒç´ ä¼˜å…ˆè¢«æ£€æµ‹åˆ°ã€‚

---

## 7.2 ç‚¹å‡»æ£€æµ‹ hitTest

### 7.2.1 æ£€æµ‹ç±»å‹åˆ†å±‚

ç³»ç»Ÿæä¾›ä¸‰ç§ç²¾åº¦çš„ç‚¹å‡»æ£€æµ‹ï¼š

```
æ£€æµ‹ç²¾åº¦å±‚çº§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  Level 1: hitTestBoundsï¼ˆåŒ…å›´ç›’æ£€æµ‹ï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  â”Œâ”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”    â”‚ AABB åŒ…å›´ç›’       â”‚
â”‚  â”‚  â”‚                             â”‚    â”‚ æœ€å¿«ä½†æœ€ä¸ç²¾ç¡®     â”‚
â”‚  â”‚  â”‚    â•±â•²                       â”‚    â”‚                   â”‚
â”‚  â”‚  â”‚   â•±  â•²                      â”‚    â”‚                   â”‚
â”‚  â”‚  â”‚  â•±    â•²                     â”‚    â”‚                   â”‚
â”‚  â”‚  â”‚ â•±______â•²                    â”‚    â”‚                   â”‚
â”‚  â”‚  â””â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                             â”‚
â”‚  Level 2: hitTestOrientedBoundsï¼ˆæœ‰å‘åŒ…å›´ç›’æ£€æµ‹ï¼‰           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚       â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²             â”‚ OBB åŒ…å›´ç›’        â”‚
â”‚  â”‚      â•±    â•±â•²           â•²            â”‚ è€ƒè™‘æ—‹è½¬          â”‚
â”‚  â”‚     â•±    â•±  â•²           â•²           â”‚ ä¸­ç­‰ç²¾åº¦          â”‚
â”‚  â”‚    â•±    â•±    â•²           â•²          â”‚                   â”‚
â”‚  â”‚   â•±    â•±______â•²           â•²         â”‚                   â”‚
â”‚  â”‚  â•²_______________________________________________â•±      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                             â”‚
â”‚  Level 3: hitTestï¼ˆå…ƒç´ ç²¾ç¡®æ£€æµ‹ï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚         â•±â•²                          â”‚ ç²¾ç¡®å½¢çŠ¶          â”‚
â”‚  â”‚        â•±  â•²                         â”‚ è€ƒè™‘ hitArea/mask â”‚
â”‚  â”‚       â•±    â•²                        â”‚ æœ€ç²¾ç¡®ä½†æœ€æ…¢      â”‚
â”‚  â”‚      â•±______â•²                       â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2.2 å…ƒç´ çº§ç‚¹å‡»æ£€æµ‹

æœ€ç²¾ç¡®çš„æ£€æµ‹æ–¹å¼ï¼Œè€ƒè™‘å…ƒç´ çš„ `hitArea` å’Œ `mask`ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

// æ£€æµ‹å‡½æ•°å®šä¹‰
const hitTestElement: HitTest = (point, element) => element.contains(point);
const hitTestElementByRect: HitTest<Rectangle> = (rect, element) => element.hits(rect);

// å…¬å¼€ API
hitTest(point: IPointData | Rectangle, test: TestFn = defaultTest): IBaseElementVm | null {
    if (point instanceof Rectangle) {
        return this._hitTest(point, hitTestElementByRect, test);
    }
    return this._hitTest(point, hitTestElement, test);
}
```

å…ƒç´ çš„ `contains` æ–¹æ³•å®ç°ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/vms/base/base-element-vm.ts

contains(point: IPointData): boolean {
    // 1. è‹¥å…ƒç´ æœ‰ maskï¼Œä¼˜å…ˆæ£€æµ‹ mask
    if (this.view.mask) {
        const maskObject = (this.view.mask as MaskData)._isMaskData
            ? (this.view.mask as MaskData).maskObject
            : (this.view.mask as Graphics);
        
        // å›¾å½¢ Mask - æ£€æµ‹ç‚¹æ˜¯å¦åœ¨é®ç½©åŒºåŸŸå†…
        if (maskObject instanceof Graphics) {
            return !!maskObject.containsPoint(point);
        }
    }
    
    // 2. è‹¥å…ƒç´ æœ‰ hitAreaï¼Œæ£€æµ‹ hitArea
    if (this.view.hitArea) {
        // å°†ä¸–ç•Œåæ ‡è½¬æ¢ä¸ºå…ƒç´ æœ¬åœ°åæ ‡
        const pos = this.getLocalPoint(point, tempPoint);
        return !!this.view.hitArea.contains(pos.x, pos.y);
    }
    
    // 3. é»˜è®¤è¿”å› falseï¼ˆéœ€å­ç±»è¦†å†™ï¼‰
    return false;
}
```

**æ£€æµ‹æµç¨‹å›¾**ï¼š

```
contains(point) æ£€æµ‹æµç¨‹ï¼š

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   è¾“å…¥ç‚¹åæ ‡  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  æœ‰ maskï¼Ÿ   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           Yes  â”‚  No
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â–¼             â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
  â”‚ mask åŒ…å«ç‚¹ï¼Ÿ â”‚     â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
    Yes  â”‚  No         â”‚
    â”‚    â”‚             â”‚
    â–¼    â–¼             â–¼
  true false    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ æœ‰ hitAreaï¼Ÿ â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  Yes  â”‚  No
                â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                â–¼             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  false
         â”‚ åæ ‡è½¬æ¢åˆ°   â”‚
         â”‚ æœ¬åœ°åæ ‡ç³»   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚hitAreaåŒ…å«ç‚¹ï¼Ÿâ”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           Yes  â”‚  No
           â”‚    â”‚
           â–¼    â–¼
         true  false
```

### 7.2.3 åŒ…å›´ç›’æ£€æµ‹

ä½¿ç”¨ AABBï¼ˆAxis-Aligned Bounding Boxï¼‰è¿›è¡Œå¿«é€Ÿæ£€æµ‹ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

const tempRect = new Rectangle();

// ç‚¹æ£€æµ‹
const hitTestBounds: HitTest = (point, element) => {
    const bounds = element.getBounds(false, tempRect);
    return bounds.contains(point.x, point.y);
};

// çŸ©å½¢æ£€æµ‹
const hitTestBoundsByRect: HitTest<Rectangle> = (rect, element) => {
    const bounds = element.getBounds(false, tempRect);
    return bounds.intersects(rect);
};
```

**AABB åŸç†å›¾ç¤º**ï¼š

```
AABBï¼ˆè½´å¯¹é½åŒ…å›´ç›’ï¼‰ï¼š

åŸå§‹å›¾å½¢ï¼š               AABB åŒ…å›´ç›’ï¼š
    â•±â•²                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â•±  â•²                  â”‚  â•±â•²     â”‚
  â•±    â•²                 â”‚ â•±  â•²    â”‚
 â•±      â•²                â”‚â•±    â•²   â”‚
â•±________â•²               â”‚â•²____â•±   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ—‹è½¬åçš„å›¾å½¢ï¼š            AABB ä»ç„¶è½´å¯¹é½ï¼š
      â•±â•²                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â•±  â•²                â”‚    â•±â•²     â”‚
    â•±    â•²               â”‚   â•±  â•²    â”‚
   â•±      â•²              â”‚  â•±    â•²   â”‚
  â•±________â•²             â”‚ â•±______â•²  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†‘ AABB å˜å¤§äº†ï¼
```

**AABB ç›¸äº¤åˆ¤å®š**ï¼š

```typescript
// Rectangle.contains(x, y) - ç‚¹åŒ…å«æ£€æµ‹
contains(x: number, y: number): boolean {
    if (this.width <= 0 || this.height <= 0) return false;
    
    return x >= this.x 
        && x < this.x + this.width 
        && y >= this.y 
        && y < this.y + this.height;
}

// Rectangle.intersects(rect) - çŸ©å½¢ç›¸äº¤æ£€æµ‹
intersects(rect: Rectangle): boolean {
    if (this.width <= 0 || this.height <= 0 || rect.width <= 0 || rect.height <= 0) {
        return false;
    }
    
    // ä¸¤ä¸ªè½´å¯¹é½çŸ©å½¢ç›¸äº¤çš„å……è¦æ¡ä»¶
    return this.x < rect.x + rect.width
        && this.x + this.width > rect.x
        && this.y < rect.y + rect.height
        && this.y + this.height > rect.y;
}
```

### 7.2.4 æœ‰å‘åŒ…å›´ç›’æ£€æµ‹

ä½¿ç”¨ OBBï¼ˆOriented Bounding Boxï¼‰å¤„ç†æ—‹è½¬å…ƒç´ ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

const POLYGON = new Polygon();

const hitTestOrientedBounds: HitTest = (point, element) => {
    // è·å–å…ƒç´ çš„æœ‰å‘å¤šè¾¹å½¢é¡¶ç‚¹
    element.getOrientedPolygon(false, POLYGON.points);
    // åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…
    return POLYGON.contains(point.x, point.y);
};
```

**OBB vs AABB å¯¹æ¯”**ï¼š

```
åŒä¸€æ—‹è½¬çŸ©å½¢çš„ä¸¤ç§åŒ…å›´ç›’ï¼š

AABBï¼ˆè½´å¯¹é½ï¼‰ï¼š                    OBBï¼ˆæœ‰å‘ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
â”‚      â•±â”€â”€â”€â”€â”€â”€â•²       â”‚           â•±               â•²
â”‚     â•±        â•²      â”‚          â•±                 â•²
â”‚    â•±          â•²     â”‚         â•±                   â•²
â”‚   â•±            â•²    â”‚        â•±                     â•²
â”‚  â•±              â•²   â”‚       â•±                       â•²
â”‚ â•±                â•²  â”‚      â•²                       â•±
â”‚â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•² â”‚       â•²                     â•±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â•²                   â•±
                                â•²                 â•±
                                 â•²               â•±
                                  â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±

AABB é¢ç§¯: å¤§                     OBB é¢ç§¯: ç²¾ç¡®
æ£€æµ‹é€Ÿåº¦: å¿«                      æ£€æµ‹é€Ÿåº¦: ç¨æ…¢
è¯¯åˆ¤ç‡: é«˜                        è¯¯åˆ¤ç‡: ä½
```

**ç‚¹åœ¨å¤šè¾¹å½¢å†…åˆ¤å®šï¼ˆå°„çº¿æ³•ï¼‰**ï¼š

```typescript
// Polygon.contains - ä½¿ç”¨å°„çº¿æ³•åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…
contains(x: number, y: number): boolean {
    let inside = false;
    const points = this.points;
    const length = points.length / 2;
    
    for (let i = 0, j = length - 1; i < length; j = i++) {
        const xi = points[i * 2];
        const yi = points[i * 2 + 1];
        const xj = points[j * 2];
        const yj = points[j * 2 + 1];
        
        // å°„çº¿ä¸è¾¹ç›¸äº¤åˆ¤å®š
        const intersect = ((yi > y) !== (yj > y))
            && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        
        if (intersect) {
            inside = !inside;
        }
    }
    
    return inside;
}
```

**å°„çº¿æ³•åŸç†å›¾ç¤º**ï¼š

```
å°„çº¿æ³•åˆ¤æ–­ç‚¹åœ¨å¤šè¾¹å½¢å†…ï¼š

ä»ç‚¹ P å‘å³å‘å°„æ°´å¹³å°„çº¿ï¼Œ
è®¡ç®—ä¸å¤šè¾¹å½¢è¾¹çš„äº¤ç‚¹æ•°ï¼š
- å¥‡æ•°æ¬¡äº¤ç‚¹ â†’ ç‚¹åœ¨å†…éƒ¨
- å¶æ•°æ¬¡äº¤ç‚¹ â†’ ç‚¹åœ¨å¤–éƒ¨

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                â”‚
      â”‚    P1 â—â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â†’  äº¤ç‚¹æ•°: 1ï¼ˆå¥‡æ•°ï¼‰â†’ å†…éƒ¨
      â”‚                â”‚
      â”‚                â”‚
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€
      â”‚                â”‚
P2 â—â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â†’  äº¤ç‚¹æ•°: 2ï¼ˆå¶æ•°ï¼‰â†’ å¤–éƒ¨
      â”‚                â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7.3 åŒºåŸŸæ£€æµ‹ intersect

### 7.3.1 æ¡†é€‰åœºæ™¯åˆ†æ

åŒºåŸŸæ£€æµ‹ä¸»è¦ç”¨äºæ¡†é€‰åŠŸèƒ½ï¼š

```
æ¡†é€‰æ“ä½œç¤ºæ„ï¼š

       mousedown          mousemove           mouseup
          â”‚                   â”‚                  â”‚
          â–¼                   â–¼                  â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                          â”‚
       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
       â”‚   â”‚    æ¡†é€‰çŸ©å½¢          â”‚                â”‚
       â”‚   â”‚  â”Œâ”€â”€â”€â”€â”             â”‚                â”‚
       â”‚   â”‚  â”‚ A  â”‚   â”Œâ”€â”€â”€â”€â”    â”‚   â”Œâ”€â”€â”€â”€â”      â”‚
       â”‚   â”‚  â””â”€â”€â”€â”€â”˜   â”‚ B  â”‚    â”‚   â”‚ C  â”‚      â”‚
       â”‚   â”‚           â””â”€â”€â”€â”€â”˜    â”‚   â””â”€â”€â”€â”€â”˜      â”‚
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
       â”‚                                          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       
       intersect(æ¡†é€‰çŸ©å½¢) â†’ [Element A, Element B]
       Element C ä¸åœ¨æ¡†é€‰èŒƒå›´å†…
```

### 7.3.2 ç›¸äº¤åˆ¤å®šç­–ç•¥

ä¸ç‚¹å‡»æ£€æµ‹ç±»ä¼¼ï¼ŒåŒºåŸŸæ£€æµ‹ä¹Ÿæä¾›ä¸‰ç§ç²¾åº¦ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

// å…ƒç´ çº§ç›¸äº¤åˆ¤å®š
const intersectsElement: Intersects = (rect, element) => element.intersects(rect);

// åŒ…å›´ç›’ç›¸äº¤åˆ¤å®š
const intersectsBounds: Intersects = (rect, element) => {
    const bounds = element.getBounds(false, tempRect);
    return bounds.intersects(rect);
};

// æœ‰å‘åŒ…å›´ç›’ç›¸äº¤åˆ¤å®šï¼ˆä½¿ç”¨ SAT ç®—æ³•ï¼‰
const intersectsOrientedBounds: Intersects = (rect, element) => {
    const points = element.getOrientedPolygon(false, POLYGON.points);
    const rectPoints = getPoints(rect, tempPoints);
    return doPolygonsIntersectBySAT(points, rectPoints);
};
```

å…ƒç´ çº§ `intersects` æ–¹æ³•ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/vms/base/base-element-vm.ts

intersects(rect: Rectangle): boolean {
    const bounds = this.view.getBounds(false, RECTANGLE);
    
    // 1. å¿«é€Ÿå‰”é™¤ï¼šåŒ…å›´ç›’ä¸ç›¸äº¤åˆ™ç›´æ¥è¿”å› false
    if (!rect.intersects(bounds)) {
        return false;
    }
    
    // 2. å¿«é€Ÿåˆ¤å®šï¼šæ¡†é€‰å®Œå…¨åŒ…å«å…ƒç´ åŒ…å›´ç›’
    if (rect.containsRect(bounds)) {
        return true;
    }
    
    // 3. ç²¾ç¡®åˆ¤å®šï¼šæ£€æµ‹ mask
    if (this.view.mask) {
        const maskObject = (this.view.mask as MaskData)._isMaskData
            ? (this.view.mask as MaskData).maskObject
            : (this.view.mask as Graphics);
        
        // Graphics mask
        if (maskObject instanceof Graphics) {
            if (doesGraphicsIntersectRect(maskObject, rect)) {
                return true;
            }
        }
        
        // Sprite mask
        if (maskObject instanceof Sprite) {
            if (doesSpriteIntersectRect(maskObject, rect)) {
                return true;
            }
        }
    }
    
    // 4. ç²¾ç¡®åˆ¤å®šï¼šæ£€æµ‹ hitArea
    if (this.view.hitArea && this.view.hitArea instanceof Rectangle) {
        return doesHitAreaIntersectRect(
            this.view.hitArea, 
            rect, 
            this.view.worldTransform
        );
    }
    
    return false;
}
```

### 7.3.3 å•æ¬¡æ£€æµ‹ä¸æ‰¹é‡æ£€æµ‹

ç³»ç»Ÿæä¾›ä¸¤ç§åŒºåŸŸæ£€æµ‹æ¨¡å¼ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

// æ‰¹é‡æ£€æµ‹ï¼šè¿”å›æ‰€æœ‰ç›¸äº¤å…ƒç´ 
intersect(rect: Rectangle, test: TestFn = defaultTest): IBaseElementVm[] {
    return this._intersect(rect, intersectsElement, test);
}

// å•æ¬¡æ£€æµ‹ï¼šè¿”å›ç¬¬ä¸€ä¸ªç›¸äº¤å…ƒç´ 
intersectOnce(rect: Rectangle, test: TestFn = defaultTest): IBaseElementVm | null {
    return this._intersectOnce(rect, hitTestElementByRect, test);
}

// æ‰¹é‡æ£€æµ‹å†…éƒ¨å®ç°
private _intersect(
    rect: Rectangle,
    intersects: Intersects,
    test: TestFn = defaultTest,
): IBaseElementVm[] {
    const { children } = this.viewport.page;
    const results: IBaseElementVm[] = [];
    
    // ä»åå‘å‰éå†
    for (let i = children.length - 1; i >= 0; i--) {
        const child = children[i];
        this.intersectsRecursive(rect, child, intersects, test, results);
    }
    
    return results;
}
```

**é€’å½’ç›¸äº¤æ£€æµ‹**ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

private intersectsRecursive(
    rect: Rectangle,
    element: IBaseElementVm,
    intersects: Intersects,
    test: TestFn<IBaseElementVm>,
    results: IBaseElementVm[],
): void {
    const bypass = test(element);
    
    // Skipï¼šè·³è¿‡å…ƒç´ 
    if (bypass === Bypass.Skip) {
        return;
    }
    
    // ä¸ç›¸äº¤åˆ™è¿”å›
    if (!intersects(rect, element)) {
        return;
    }
    
    // é Pass ç­–ç•¥ï¼šå°†å…ƒç´ åŠ å…¥ç»“æœ
    if (bypass !== Bypass.Pass) {
        results.push(element);
    }
    
    // Hitsï¼šå‘½ä¸­åä¸å†æ£€æµ‹å­å…ƒç´ 
    if (bypass === Bypass.Hits) {
        return;
    }
    
    // Noneï¼šç»§ç»­é€’å½’æ£€æµ‹å­å…ƒç´ 
    if (bypass === Bypass.None) {
        for (let i = element.children.length - 1; i >= 0; i--) {
            const child = element.children[i];
            this.intersectsRecursive(rect, child, intersects, test, results);
        }
    }
}
```

**hitTest vs intersect å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | hitTest | intersect |
|------|---------|-----------|
| è¿”å›å€¼ | å•ä¸ªå…ƒç´ æˆ– null | å…ƒç´ æ•°ç»„ |
| æ‰¾åˆ°å | ç«‹å³è¿”å› | ç»§ç»­æ£€æµ‹ |
| åº”ç”¨åœºæ™¯ | ç‚¹å‡»é€‰æ‹© | æ¡†é€‰ |
| æ—¶é—´å¤æ‚åº¦ | O(n) æœ€å | O(n) |

---

## 7.4 SAT åˆ†ç¦»è½´ç®—æ³•

### 7.4.1 ç®—æ³•åŸç†

**åˆ†ç¦»è½´å®šç†ï¼ˆSeparating Axis Theoremï¼‰**ï¼šå¦‚æœä¸¤ä¸ªå‡¸å¤šè¾¹å½¢ä¸ç›¸äº¤ï¼Œåˆ™å¿…å®šå­˜åœ¨ä¸€æ¡åˆ†ç¦»è½´ï¼Œä½¿å¾—ä¸¤ä¸ªå¤šè¾¹å½¢åœ¨è¯¥è½´ä¸Šçš„æŠ•å½±ä¸é‡å ã€‚

```
SAT ç®—æ³•ç›´è§‚ç†è§£ï¼š

æƒ³è±¡ä¸€ä¸ªå…‰æºä»ä¸åŒè§’åº¦ç…§å°„ä¸¤ä¸ªç‰©ä½“ï¼Œ
è§‚å¯Ÿå®ƒä»¬åœ¨å¢™ä¸Šçš„å½±å­ï¼ˆæŠ•å½±ï¼‰ï¼š

è§’åº¦ 1ï¼šæŠ•å½±é‡å 
    â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”
    â”‚ A â”‚   â”‚ B â”‚
    â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜
â”â”â”â”â”â–‡â–‡â–‡â”â”â”â”â–‡â–‡â–‡â”â”â”â”â” â† å¢™ï¼ˆæŠ•å½±è½´ï¼‰
      â†‘       â†‘
    å½±å­A   å½±å­B
    
    å½±å­é‡å ï¼éœ€è¦ç»§ç»­æ£€æµ‹å…¶ä»–è§’åº¦...

è§’åº¦ 2ï¼šæŠ•å½±åˆ†ç¦»
    â”Œâ”€â”€â”€â”
    â”‚ A â”‚   
    â””â”€â”€â”€â”˜       â”Œâ”€â”€â”€â”
                â”‚ B â”‚
                â””â”€â”€â”€â”˜
â”â”â”â”â”â–‡â–‡â–‡â”â”â”â”â”â”â”â”â–‡â–‡â–‡â”â”â” â† å¢™ï¼ˆæŠ•å½±è½´ï¼‰
      â†‘           â†‘
    å½±å­A       å½±å­B
    
    å½±å­åˆ†ç¦»ï¼æ‰¾åˆ°åˆ†ç¦»è½´ï¼Œä¸¤ç‰©ä½“ä¸ç›¸äº¤
```

### 7.4.2 æ•°å­¦æ¨å¯¼

**æŠ•å½±è½´çš„é€‰æ‹©**ï¼š

å¯¹äºå‡¸å¤šè¾¹å½¢ï¼Œåªéœ€æ£€æµ‹æ¯æ¡è¾¹çš„æ³•çº¿æ–¹å‘ä½œä¸ºæŠ•å½±è½´ã€‚

```
çŸ©å½¢æœ‰ 4 æ¡è¾¹ï¼Œä½†åªæœ‰ 2 ä¸ªä¸åŒçš„æ³•çº¿æ–¹å‘ï¼š

      â”€â”€â”€â”€â”€â”€â”€â”€â†’ edge1 (æ³•çº¿: â†‘)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚ â† edge2 (æ³•çº¿: â†’)
    â”‚         â”‚
    â”‚         â”‚ â† edge4 (æ³•çº¿: â†, ç­‰ä»·äº â†’)
    â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†â”€â”€â”€â”€â”€â”€â”€â”€ edge3 (æ³•çº¿: â†“, ç­‰ä»·äº â†‘)

ä¸¤ä¸ªçŸ©å½¢æœ€å¤šéœ€è¦æ£€æµ‹ 4 æ¡è½´ï¼ˆæ¯ä¸ªçŸ©å½¢è´¡çŒ® 2 æ¡ï¼‰
```

**æŠ•å½±è®¡ç®—**ï¼š

ç‚¹ P åœ¨è½´ A ä¸Šçš„æŠ•å½±é•¿åº¦ï¼ˆæ ‡é‡ï¼‰ï¼š

```
proj = P Â· A / |A|

å…¶ä¸­ï¼š
- P Â· A æ˜¯ç‚¹ç§¯
- |A| æ˜¯è½´çš„é•¿åº¦

å¦‚æœè½´ A æ˜¯å•ä½å‘é‡ï¼Œåˆ™ï¼š
proj = P Â· A = Px * Ax + Py * Ay
```

**ä»£ç å®ç°**ï¼š

```typescript
// æ¥æºï¼šutils/src/rect.ts - ç®€åŒ–ç‰ˆ SAT å®ç°

class Vector {
    x: number;
    y: number;
    
    // ç‚¹ç§¯
    dotProduct(v: Vector): number {
        return this.x * v.x + this.y * v.y;
    }
    
    // è¾¹å‘é‡
    edge(v: Vector): Vector {
        return new Vector(v.x - this.x, v.y - this.y);
    }
    
    // æ³•å‘é‡ï¼ˆå‚ç›´å‘é‡ï¼‰
    normal(): Vector {
        // 2D ä¸­ï¼Œ(x, y) çš„æ³•å‘é‡æ˜¯ (-y, x) æˆ– (y, -x)
        return new Vector(-this.y, this.x);
    }
}

class Projection {
    min: number;
    max: number;
    
    constructor(min: number, max: number) {
        this.min = min;
        this.max = max;
    }
    
    // æŠ•å½±æ˜¯å¦é‡å 
    overlaps(p: Projection): boolean {
        return this.max >= p.min && p.max >= this.min;
    }
}
```

### 7.4.3 ä»£ç å®ç°

å®Œæ•´çš„ SAT ç›¸äº¤æ£€æµ‹ï¼š

```typescript
// æ¥æºï¼šutils/src/rect.ts

getRectIntersection(rectA: Rect, rectB: Rect) {
    const pointsA = this.getRectPoints(rectA);
    const pointsB = this.getRectPoints(rectB);
    
    // ä¼˜åŒ–ï¼šæ— æ—‹è½¬çŸ©å½¢ä½¿ç”¨ AABB æ£€æµ‹
    if (
        (rectA.rotate === 0 || rectA.rotate === 360) &&
        rectA.skewX === 0 && rectA.skewY === 0 &&
        (rectB.rotate === 0 || rectB.rotate === 360) &&
        rectB.skewX === 0 && rectB.skewY === 0
    ) {
        return (
            rectA.left < rectB.left + rectB.width &&
            rectA.left + rectA.width > rectB.left &&
            rectA.top < rectB.top + rectB.height &&
            rectA.height + rectA.top > rectB.top
        );
    }
    
    // æœ‰æ—‹è½¬æ—¶ä½¿ç”¨ SAT
    const polygonsCollide = (polygon1, polygon2) => {
        // è·å–æ‰€æœ‰å€™é€‰åˆ†ç¦»è½´
        const axes = this.getAxes(polygon1).concat(this.getAxes(polygon2));
        
        for (const axis of axes) {
            // è®¡ç®—ä¸¤ä¸ªå¤šè¾¹å½¢åœ¨å½“å‰è½´ä¸Šçš„æŠ•å½±
            const projection1 = this.project(axis, polygon1);
            const projection2 = this.project(axis, polygon2);
            
            // å¦‚æœæŠ•å½±ä¸é‡å ï¼Œæ‰¾åˆ°åˆ†ç¦»è½´ï¼Œä¸ç›¸äº¤
            if (!projection1.overlaps(projection2)) {
                return false;
            }
        }
        
        // æ‰€æœ‰è½´ä¸ŠæŠ•å½±éƒ½é‡å ï¼Œç›¸äº¤
        return true;
    };
    
    return polygonsCollide(pointsA, pointsB);
},

// è·å–æŠ•å½±è½´ï¼ˆè¾¹çš„æ³•çº¿ï¼‰
getAxes(points: Point[]) {
    const v1 = new Vector();
    const v2 = new Vector();
    const axes: Vector[] = [];
    
    for (let i = 0, len = points.length - 1; i < len; i++) {
        v1.x = points[i].x;
        v1.y = points[i].y;
        v2.x = points[i + 1].x;
        v2.y = points[i + 1].y;
        
        // è¾¹å‘é‡çš„æ³•çº¿
        axes.push(v1.edge(v2).normal());
    }
    
    // æœ€åä¸€æ¡è¾¹ï¼ˆæœ€åä¸€ç‚¹åˆ°ç¬¬ä¸€ç‚¹ï¼‰
    v1.x = points.at(-1)!.x;
    v1.y = points.at(-1)!.y;
    v2.x = points[0].x;
    v2.y = points[0].y;
    axes.push(v1.edge(v2).normal());
    
    return axes;
},

// è®¡ç®—å¤šè¾¹å½¢åœ¨è½´ä¸Šçš„æŠ•å½±
project(axis: Vector, points: Point[]) {
    const scalars: number[] = [];
    const v = new Vector();
    
    points.forEach((point) => {
        v.x = point.x;
        v.y = point.y;
        // ç‚¹ç§¯å¾—åˆ°æŠ•å½±æ ‡é‡
        scalars.push(v.dotProduct(axis));
    });
    
    return new Projection(Math.min(...scalars), Math.max(...scalars));
}
```

### 7.4.4 æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š

```
SAT æ€§èƒ½ä¼˜åŒ–å±‚çº§ï¼š

Level 1: AABB é¢„æ£€æµ‹ï¼ˆæœ€å¿«ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if (!aabb1.intersects(aabb2)) return false â”‚
â”‚                                             â”‚
â”‚ å¤æ‚åº¦: O(1)                                â”‚
â”‚ ä½œç”¨: å¿«é€Ÿå‰”é™¤æ˜æ˜¾ä¸ç›¸äº¤çš„æƒ…å†µ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ AABB ç›¸äº¤
            â–¼
Level 2: æ— æ—‹è½¬ä¼˜åŒ–ï¼ˆå¿«ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if (æ— æ—‹è½¬ && æ— æ–œåˆ‡) {                      â”‚
â”‚     return AABB ç›¸äº¤æ£€æµ‹;                    â”‚
â”‚ }                                           â”‚
â”‚                                             â”‚
â”‚ å¤æ‚åº¦: O(1)                                â”‚
â”‚ ä½œç”¨: å¯¹è§„æ•´çŸ©å½¢é¿å… SAT è®¡ç®—                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ æœ‰æ—‹è½¬æˆ–æ–œåˆ‡
            â–¼
Level 3: SAT å®Œæ•´æ£€æµ‹ï¼ˆæ…¢ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ for (axis of axes) {                        â”‚
â”‚     proj1 = project(axis, poly1);           â”‚
â”‚     proj2 = project(axis, poly2);           â”‚
â”‚     if (!overlaps) return false;            â”‚
â”‚ }                                           â”‚
â”‚                                             â”‚
â”‚ å¤æ‚åº¦: O(n) n = è¾¹æ•°                        â”‚
â”‚ ä¸¤ä¸ªçŸ©å½¢ = 8 æ¬¡æŠ•å½±è®¡ç®—                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®é™…åº”ç”¨ä¸­çš„ä¼˜åŒ–**ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/vms/base/base-element-vm.ts

hits(rect: Rectangle): boolean {
    const bounds = this.view.getBounds();
    
    // ä¼˜åŒ– 1: AABB é¢„æ£€æµ‹
    if (!bounds.intersects(rect)) {
        return false;
    }
    
    // ä¼˜åŒ– 2: æœ‰ mask æ—¶æ‰åšç²¾ç¡®æ£€æµ‹
    if (this.view.mask) {
        // ç²¾ç¡®æ£€æµ‹...
    }
    
    // ä¼˜åŒ– 3: æœ‰ hitArea æ—¶æ‰åš SAT
    if (this.view.hitArea && this.view.hitArea instanceof Rectangle) {
        return doesHitAreaIntersectRect(
            this.view.hitArea, 
            rect, 
            this.view.worldTransform
        );
    }
    
    return false;
}
```

---

## 7.5 é®ç½©å±‚å¤„ç†

### 7.5.1 Cover Mask æœºåˆ¶

`EventBoundary` æ”¯æŒæ·»åŠ "è¦†ç›–é®ç½©"ï¼Œé®ç½©åŒºåŸŸä¼šé˜»æ–­ç‚¹å‡»äº‹ä»¶ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

export class EventBoundary implements IEventBoundary {
    private masks: Set<MaskTarget> = new Set();
    
    // æ·»åŠ è¦†ç›–é®ç½©
    addCoverMask(mask: MaskTarget): void {
        this.masks.add(mask);
    }
    
    // ç§»é™¤è¦†ç›–é®ç½©
    removeCoverMask(mask: MaskTarget): void {
        this.masks.delete(mask);
    }
    
    // æ£€æµ‹ç‚¹/çŸ©å½¢æ˜¯å¦å‘½ä¸­é®ç½©
    private _hitMask<T extends IPointData | Rectangle>(point: T): boolean {
        const isRect = point instanceof Rectangle;
        
        for (const mask of this.masks) {
            if (isRect) {
                // çŸ©å½¢æ£€æµ‹
                if (mask instanceof Graphics &&
                    mask.getBounds(true).intersects(point) &&
                    doesGraphicsIntersectRect(mask, point)) {
                    return true;
                }
                
                if (mask instanceof Sprite &&
                    mask.getBounds(true).intersects(point) &&
                    doesSpriteIntersectRect(mask, point)) {
                    return true;
                }
            } else {
                // ç‚¹æ£€æµ‹
                if (mask.containsPoint(point)) {
                    return true;
                }
            }
        }
        
        return false;
    }
}
```

**Cover Mask åº”ç”¨åœºæ™¯**ï¼š

```
åœºæ™¯ï¼šæ¨¡æ€å¯¹è¯æ¡†é®ç½©

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”»å¸ƒ                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Elem A â”‚  â”‚ Elem B â”‚  â”‚ Elem C â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Cover Mask (åŠé€æ˜é®ç½©)          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚     Modal Dialog        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  [OK]    [Cancel]       â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·ç‚¹å‡» Elem A åŒºåŸŸï¼š
1. _hitMask() æ£€æµ‹åˆ°å‘½ä¸­ Cover Mask
2. è¿”å› nullï¼Œäº‹ä»¶è¢«é®ç½©é˜»æ–­
3. Elem A ä¸ä¼šè¢«é€‰ä¸­
```

### 7.5.2 å…ƒç´  Mask æ£€æµ‹

å…ƒç´ è‡ªèº«çš„ `mask` å±æ€§ä¼šå½±å“ç‚¹å‡»å’Œç›¸äº¤æ£€æµ‹ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/vms/base/base-element-vm.ts

contains(point: IPointData): boolean {
    // æ£€æµ‹å…ƒç´ çš„ mask
    if (this.view.mask) {
        const maskObject = (this.view.mask as MaskData)._isMaskData
            ? (this.view.mask as MaskData).maskObject
            : (this.view.mask as Graphics);
        
        if (maskObject instanceof Graphics) {
            // Graphics mask ä½¿ç”¨ containsPoint
            return !!maskObject.containsPoint(point);
        }
    }
    // ...
}
```

**Mask ç±»å‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Mask ç±»å‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Graphics Mask                                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚     â”‚  â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®   â”‚ â† Graphics å®šä¹‰çš„å½¢çŠ¶       â”‚
â”‚     â”‚  â”‚   å¯è§åŒºåŸŸ        â”‚   â”‚                             â”‚
â”‚     â”‚  â”‚                  â”‚   â”‚                             â”‚
â”‚     â”‚  â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯   â”‚                             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚     æ£€æµ‹æ–¹æ³•: containsPoint()                                â”‚
â”‚                                                              â”‚
â”‚  2. Sprite Mask                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚     â”‚  ğŸ–¼ï¸ å›¾ç‰‡çº¹ç†             â”‚ â† åŸºäº alpha é€šé“           â”‚
â”‚     â”‚     â–“â–“â–“â–“â–“â–“â–“â–“            â”‚   alpha > 0 çš„åŒºåŸŸå¯è§      â”‚
â”‚     â”‚     â–“â–“â–“â–“â–“â–“â–“â–“            â”‚                             â”‚
â”‚     â”‚     â–“â–“â–“â–“â–“â–“â–“â–“            â”‚                             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚     æ£€æµ‹æ–¹æ³•: åƒç´ çº§æ£€æµ‹                                      â”‚
â”‚                                                              â”‚
â”‚  3. MaskData                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚     â”‚  åŒ…è£…å¯¹è±¡               â”‚                             â”‚
â”‚     â”‚  - _isMaskData: true    â”‚                             â”‚
â”‚     â”‚  - maskObject: å®é™… mask â”‚                             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.5.3 åƒç´ çº§ç¢°æ’æ£€æµ‹

å¯¹äº Sprite ç±»å‹çš„å…ƒç´ ï¼Œæ”¯æŒåŸºäºåƒç´  alpha å€¼çš„ç²¾ç¡®ç¢°æ’æ£€æµ‹ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/common/hit-test.ts

const MAX_BUFFER_SIZE = 512;

export function doesSpritePixelsHitRect(sprite: Sprite, rect: Rectangle): boolean {
    const { baseTexture, frame } = sprite.texture;
    const { resolution } = baseTexture;
    const source = baseTexture.getDrawableSource();
    
    // èµ„æºæ— æ•ˆåˆ™ä¸ç¢°æ’
    if (!source || !baseTexture.valid) {
        return false;
    }
    
    const center = tempPoint.set(
        rect.x + rect.width / 2,
        rect.y + rect.height / 2
    );
    
    let buffer: Uint8ClampedArray;
    
    // Canvas èµ„æºï¼šç›´æ¥è¯»å–åƒç´ 
    if ('getContext' in source) {
        const ctx = source.getContext('2d', { willReadFrequently: true })!;
        const localPoint = toLocal(sprite, center, tempPoint);
        const localRect = tempRect.copyFrom(rect);
        
        localRect.x = localPoint.x - rect.width / 2;
        localRect.y = localPoint.y - rect.height / 2;
        
        const imageData = ctx.getImageData(
            Math.round((frame.x + localRect.x) * resolution),
            Math.round((frame.y + localRect.y) * resolution),
            Math.round(localRect.width * resolution),
            Math.round(localRect.height * resolution),
        );
        
        buffer = imageData.data;
    } else {
        // å›¾ç‰‡èµ„æºï¼šç¼“å­˜åƒç´ æ•°æ®åˆ° baseTexture
        if (!(baseTexture as BufferedBaseTexture)._imageBufferData) {
            // é™åˆ¶ç¼“å­˜å¤§å°
            const ratio = Math.min(
                MAX_BUFFER_SIZE / baseTexture.realWidth,
                MAX_BUFFER_SIZE / baseTexture.realHeight,
                1,
            );
            
            const canvas = settings.ADAPTER.createCanvas(
                baseTexture.realWidth * ratio,
                baseTexture.realHeight * ratio,
            );
            const context = canvas.getContext('2d')!;
            context.drawImage(source, 0, 0, canvas.width, canvas.height);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            // é‡Šæ”¾ä¸´æ—¶ canvas
            canvas.width = 1;
            canvas.height = 1;
            
            (baseTexture as BufferedBaseTexture)._imageBufferData = {
                data: imageData,
                ratio,
            };
        }
        
        // ä»ç¼“å­˜ä¸­è£å‰ªåŒºåŸŸ
        const { data, ratio = 1 } = (baseTexture as BufferedBaseTexture)._imageBufferData!;
        // ... åæ ‡è½¬æ¢å’Œè£å‰ª
        buffer = clip(data.data, data.width, data.height, ...);
    }
    
    // æ£€æµ‹ alpha é€šé“
    const size = 4; // RGBA
    for (let i = 0; i < buffer.length; i += size) {
        const alpha = buffer[i + 3];
        
        // ä»»ä½•åƒç´ çš„ alpha ä¸ä¸º 0 åˆ™ç¢°æ’æˆåŠŸ
        if (alpha !== 0) {
            return true;
        }
    }
    
    return false;
}
```

**åƒç´ æ£€æµ‹æµç¨‹å›¾**ï¼š

```
åƒç´ çº§ç¢°æ’æ£€æµ‹æµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Sprite å›¾ç‰‡                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                       â”‚  â”‚
â”‚  â”‚  â–ˆâ–ˆ            â–ˆâ–ˆ                                     â”‚  â”‚
â”‚  â”‚ â–ˆâ–ˆ   â— ç¢°æ’ç‚¹   â–ˆâ–ˆ                                    â”‚  â”‚
â”‚  â”‚ â–ˆâ–ˆ              â–ˆâ–ˆ                                    â”‚  â”‚
â”‚  â”‚  â–ˆâ–ˆ            â–ˆâ–ˆ                                     â”‚  â”‚
â”‚  â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                       â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤ï¼š
1. å°†ç¢°æ’åŒºåŸŸä»ä¸–ç•Œåæ ‡è½¬æ¢åˆ° Sprite æœ¬åœ°åæ ‡
2. è¯»å–è¯¥åŒºåŸŸçš„åƒç´ æ•°æ®ï¼ˆRGBAï¼‰
3. éå†æ‰€æœ‰åƒç´ çš„ alpha å€¼
4. å¦‚æœä»»ä½• alpha > 0ï¼Œåˆ™ç¢°æ’æˆåŠŸ

      é€æ˜åŒºåŸŸ                ä¸é€æ˜åŒºåŸŸ
   alpha = 0              alpha > 0
   ä¸ç¢°æ’ âœ—               ç¢°æ’ âœ“
```

**æ€§èƒ½ä¼˜åŒ–ï¼šåƒç´ ç¼“å­˜**ï¼š

```typescript
// ç¼“å­˜æ¥å£
export interface BufferedBaseTexture extends BaseTexture {
    _imageBufferData?: {
        data: ImageData;
        ratio: number;  // ç¼©æ”¾æ¯”ä¾‹ï¼ˆé™åˆ¶æœ€å¤§å°ºå¯¸ï¼‰
    };
}

// ç¼“å­˜ç­–ç•¥
// 1. é¦–æ¬¡æ£€æµ‹æ—¶åˆ›å»ºç¼“å­˜
// 2. é™åˆ¶æœ€å¤§ç¼“å­˜å°ºå¯¸ä¸º 512x512
// 3. ç¼“å­˜å­˜å‚¨åœ¨ baseTexture ä¸Šï¼Œéšçº¹ç†ç”Ÿå‘½å‘¨æœŸ
```

---

## 7.6 Bypass ç­–ç•¥

### 7.6.1 ç­–ç•¥ç±»å‹

`Bypass` æšä¸¾å®šä¹‰äº†å››ç§å…ƒç´ æ£€æµ‹è¡Œä¸ºï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/event-boundary.ts

export enum Bypass {
    None = 0,  // æ­£å¸¸æ£€æµ‹
    Pass = 1,  // ç©¿é€å½“å‰å…ƒç´ 
    Skip = 2,  // è·³è¿‡å…ƒç´ åŠå­å…ƒç´ 
    Hits = 3,  // ç›´æ¥å‘½ä¸­ï¼Œä¸æ£€æµ‹å­å…ƒç´ 
}
```

**ç­–ç•¥è¡Œä¸ºå¯¹æ¯”**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Bypass ç­–ç•¥è¡Œä¸º                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç­–ç•¥   â”‚  æ£€æµ‹è‡ªèº«    â”‚  æ£€æµ‹å­å…ƒç´    â”‚  è¿”å›è¡Œä¸º                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  None   â”‚     æ˜¯       â”‚     æ˜¯       â”‚ å­å…ƒç´ å‘½ä¸­è¿”å›å­å…ƒç´ ï¼Œ       â”‚
â”‚         â”‚              â”‚              â”‚ å¦åˆ™è¿”å›è‡ªèº«                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Pass   â”‚     æ˜¯       â”‚     æ˜¯       â”‚ å­å…ƒç´ å‘½ä¸­è¿”å›å­å…ƒç´ ï¼Œ       â”‚
â”‚         â”‚ (ä»…ä½œèŒƒå›´è¿‡æ»¤)â”‚              â”‚ å¦åˆ™è¿”å› nullï¼ˆç©¿é€ï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Skip   â”‚     å¦       â”‚     å¦       â”‚ ç›´æ¥è¿”å› null               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Hits   â”‚     æ˜¯       â”‚     å¦       â”‚ å‘½ä¸­è‡ªèº«ç«‹å³è¿”å›             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.6.2 åº”ç”¨åœºæ™¯

**åœºæ™¯ 1ï¼šNone - æ­£å¸¸æ£€æµ‹ï¼ˆé»˜è®¤ï¼‰**

```
Group å…ƒç´ çš„é»˜è®¤è¡Œä¸ºï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Group (Bypass.None)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Child A â”‚    â”‚ Child B â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡» Child A åŒºåŸŸï¼š
1. æ£€æµ‹ Group â†’ å‘½ä¸­
2. é€’å½’æ£€æµ‹å­å…ƒç´ 
3. æ£€æµ‹ Child A â†’ å‘½ä¸­
4. è¿”å› Child A

ç‚¹å‡» Group ç©ºç™½åŒºåŸŸï¼š
1. æ£€æµ‹ Group â†’ å‘½ä¸­
2. é€’å½’æ£€æµ‹å­å…ƒç´  â†’ æ— å‘½ä¸­
3. è¿”å› Group
```

**åœºæ™¯ 2ï¼šPass - é€æ˜å®¹å™¨**

```
Layout å…ƒç´ ï¼ˆç”»æ¿ï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layout (Bypass.Pass)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Child A â”‚    â”‚ Child B â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡» Child A åŒºåŸŸï¼š
1. æ£€æµ‹ Layout â†’ å‘½ä¸­ï¼ˆèŒƒå›´å†…ï¼‰
2. é€’å½’æ£€æµ‹å­å…ƒç´ 
3. æ£€æµ‹ Child A â†’ å‘½ä¸­
4. è¿”å› Child A

ç‚¹å‡» Layout ç©ºç™½åŒºåŸŸï¼š
1. æ£€æµ‹ Layout â†’ å‘½ä¸­ï¼ˆèŒƒå›´å†…ï¼‰
2. é€’å½’æ£€æµ‹å­å…ƒç´  â†’ æ— å‘½ä¸­
3. Pass ç­–ç•¥ â†’ è¿”å› nullï¼ˆç©¿é€ï¼‰
4. å¯ç»§ç»­æ£€æµ‹ä¸‹å±‚å…ƒç´ 
```

**åœºæ™¯ 3ï¼šSkip - è·³è¿‡é”å®šå…ƒç´ **

```
é”å®šå…ƒç´ ä¸å‚ä¸ç‚¹å‡»æ£€æµ‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Element A (Bypass.Skip)      â”‚ â† å·²é”å®š
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Child   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Element B (Bypass.None)      â”‚ â† ä¸‹å±‚å…ƒç´ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡» Element A åŒºåŸŸï¼š
1. æ£€æµ‹ Element A â†’ Skip
2. è·³è¿‡ï¼Œä¸æ£€æµ‹å­å…ƒç´ 
3. ç»§ç»­æ£€æµ‹ Element B
```

**åœºæ™¯ 4ï¼šHits - å¿«é€Ÿå‘½ä¸­**

```
é€‰ä¸­çŠ¶æ€çš„å…ƒç´ å¿«é€Ÿå“åº”ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Element (Bypass.Hits)        â”‚ â† å·²é€‰ä¸­
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Child A â”‚    â”‚ Child B â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡»ä»»æ„ä½ç½®ï¼ˆåœ¨ Element èŒƒå›´å†…ï¼‰ï¼š
1. æ£€æµ‹ Element â†’ å‘½ä¸­
2. Hits ç­–ç•¥ â†’ ç«‹å³è¿”å› Element
3. ä¸å†æ£€æµ‹å­å…ƒç´ 
```

### 7.6.3 å®ç°æœºåˆ¶

`TestFn` ç±»å‹å®šä¹‰ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/types/event-boundary.ts

export type IBypass = 0 | 1 | 2 | 3;

export type TestFn<T = IBaseElementVm> = (element: T) => IBypass;
```

**åœ¨ Surface ä¸­çš„ä½¿ç”¨**ï¼š

```typescript
// æ¥æºï¼šinfinite-renderer/src/surfaces/surface.ts

hitTestElement(
    rect: Rectangle,
    test?: (element: BaseElementModel) => Bypass,
): BaseElementModel | null {
    const element = this.eventBoundary.hitTest(
        rect,
        // å°† Model å±‚çš„ test å‡½æ•°è½¬æ¢ä¸º VM å±‚
        test ? (element) => test(element.getModel()) : (element) => Bypass.None,
    );
    return element?.getModel() || null;
}
```

**å…¸å‹ TestFn å®ç°**ï¼š

```typescript
// ç¤ºä¾‹ï¼šæ¡†é€‰æ—¶çš„ test å‡½æ•°

function createSelectionTest(
    lockedElements: Set<string>,
    selectedElements: Set<string>
): TestFn {
    return (vm: IBaseElementVm): IBypass => {
        const model = vm.getModel();
        
        // é”å®šå…ƒç´ è·³è¿‡
        if (lockedElements.has(model.uuid)) {
            return Bypass.Skip;
        }
        
        // Layout å…ƒç´ ç©¿é€
        if (model.type === 'layout') {
            return Bypass.Pass;
        }
        
        // å·²é€‰ä¸­å…ƒç´ å¿«é€Ÿå‘½ä¸­
        if (selectedElements.has(model.uuid)) {
            return Bypass.Hits;
        }
        
        // é»˜è®¤æ­£å¸¸æ£€æµ‹
        return Bypass.None;
    };
}
```

---

## 7.7 æœ¬ç« å°ç»“

### æ ¸å¿ƒæ¦‚å¿µå›é¡¾

```
äº‹ä»¶ç³»ç»Ÿæ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EventBoundary                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   hitTest   â”‚  â”‚  intersect  â”‚  â”‚    masks    â”‚          â”‚
â”‚  â”‚  ç‚¹å‡»æ£€æµ‹    â”‚  â”‚  åŒºåŸŸæ£€æµ‹    â”‚  â”‚  é®ç½©ç®¡ç†    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                â”‚                â”‚                  â”‚
â”‚         â–¼                â–¼                â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                é€’å½’éå†å¼•æ“                        â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚       â”‚
â”‚  â”‚  â”‚           Bypass ç­–ç•¥æ§åˆ¶                 â”‚    â”‚       â”‚
â”‚  â”‚  â”‚  None / Pass / Skip / Hits               â”‚    â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚               ç¢°æ’æ£€æµ‹ç®—æ³•å±‚                       â”‚       â”‚
â”‚  â”‚                                                   â”‚       â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚       â”‚
â”‚  â”‚   â”‚  AABB   â”‚  â”‚   OBB   â”‚  â”‚  ç²¾ç¡®æ£€æµ‹    â”‚      â”‚       â”‚
â”‚  â”‚   â”‚ åŒ…å›´ç›’  â”‚  â”‚ æœ‰å‘ç›’  â”‚  â”‚ mask/hitArea â”‚      â”‚       â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚       â”‚
â”‚  â”‚                                                   â”‚       â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚       â”‚
â”‚  â”‚   â”‚         SAT åˆ†ç¦»è½´ç®—æ³•               â”‚        â”‚       â”‚
â”‚  â”‚   â”‚   ç”¨äºæ—‹è½¬å¤šè¾¹å½¢çš„ç›¸äº¤åˆ¤å®š            â”‚        â”‚       â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚       â”‚
â”‚  â”‚                                                   â”‚       â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚       â”‚
â”‚  â”‚   â”‚         åƒç´ çº§ç¢°æ’æ£€æµ‹               â”‚        â”‚       â”‚
â”‚  â”‚   â”‚   åŸºäº alpha é€šé“çš„ç²¾ç¡®æ£€æµ‹          â”‚        â”‚       â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç è·¯å¾„

| åŠŸèƒ½æ¨¡å— | æ–‡ä»¶è·¯å¾„ |
|---------|---------|
| EventBoundary | `infinite-renderer/src/surfaces/event-boundary.ts` |
| ç¢°æ’æ£€æµ‹å·¥å…· | `infinite-renderer/src/common/hit-test.ts` |
| å…ƒç´ æ£€æµ‹æ–¹æ³• | `infinite-renderer/src/vms/base/base-element-vm.ts` |
| SAT ç®—æ³• | `utils/src/rect.ts` |
| ç±»å‹å®šä¹‰ | `infinite-renderer/src/types/event-boundary.ts` |

### æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

1. **åˆ†å±‚æ£€æµ‹**ï¼šAABB â†’ OBB â†’ ç²¾ç¡®æ£€æµ‹ï¼Œé€çº§ç²¾ç»†åŒ–
2. **æ—©æœŸé€€å‡º**ï¼šAABB ä¸ç›¸äº¤æ—¶ç«‹å³è¿”å›
3. **åƒç´ ç¼“å­˜**ï¼šSprite åƒç´ æ•°æ®ç¼“å­˜åˆ° baseTexture
4. **éå†é¡ºåº**ï¼šä»åå‘å‰éå†ï¼Œä¸Šå±‚å…ƒç´ ä¼˜å…ˆå‘½ä¸­

### ä¸‹ä¸€ç« é¢„å‘Š

ç¬¬8ç« å°†è®¨è®º**æ’ä»¶ç³»ç»Ÿ**ï¼ŒåŒ…æ‹¬ï¼š
- æ’ä»¶æ³¨å†Œä¸ç”Ÿå‘½å‘¨æœŸ
- æ ¸å¿ƒæ’ä»¶å®ç°
- äº‹ä»¶åˆ†å‘æœºåˆ¶
- è‡ªå®šä¹‰æ’ä»¶å¼€å‘
