# ç¬¬3ç« ï¼šåæ ‡ç³»ç»Ÿä¸çŸ©é˜µå˜æ¢

> **æ•™å­¦ç›®æ ‡ï¼š** æ·±å…¥ç†è§£æ— é™ç”»å¸ƒçš„åæ ‡ç³»ç»Ÿä¸çŸ©é˜µå˜æ¢åŸç†ï¼Œä»æ•°å­¦æœ¬è´¨åˆ°ä»£ç å®ç°ï¼Œä»å•ç‚¹å˜æ¢åˆ°å¤æ‚åœºæ™¯åº”ç”¨çš„å®Œæ•´æŠ€æœ¯é“¾è·¯ã€‚

## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦ç†è§£åæ ‡ç³»ç»Ÿ](#ä¸€ä¸ºä»€ä¹ˆéœ€è¦ç†è§£åæ ‡ç³»ç»Ÿ)
2. [ä¸‰ä¸ªåæ ‡ç³»çš„æ·±åº¦è§£æ](#äºŒä¸‰ä¸ªåæ ‡ç³»çš„æ·±åº¦è§£æ)
3. [åæ ‡è½¬æ¢çš„æ•°å­¦æœ¬è´¨](#ä¸‰åæ ‡è½¬æ¢çš„æ•°å­¦æœ¬è´¨)
4. [2Dä»¿å°„å˜æ¢çŸ©é˜µ](#å››2dä»¿å°„å˜æ¢çŸ©é˜µ)
5. [çŸ©é˜µè¿ç®—çš„ä»£ç å®ç°](#äº”çŸ©é˜µè¿ç®—çš„ä»£ç å®ç°)
6. [å¤åˆå˜æ¢ä¸å®é™…åº”ç”¨](#å…­å¤åˆå˜æ¢ä¸å®é™…åº”ç”¨)
7. [çŸ©é˜µåˆ†è§£åŸç†](#ä¸ƒçŸ©é˜µåˆ†è§£åŸç†)
8. [åŒ…å›´ç›’ä¸ç¢°æ’æ£€æµ‹](#å…«åŒ…å›´ç›’ä¸ç¢°æ’æ£€æµ‹)
9. [å‘é‡è¿ç®—ä¸è§’åº¦è®¡ç®—](#ä¹å‘é‡è¿ç®—ä¸è§’åº¦è®¡ç®—)
10. [å®æˆ˜æ¡ˆä¾‹åˆ†æ](#åå®æˆ˜æ¡ˆä¾‹åˆ†æ)

---

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ç†è§£åæ ‡ç³»ç»Ÿï¼Ÿ

### 1.1 ä¸€ä¸ªç›´è§‚çš„é—®é¢˜

æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šç”¨æˆ·ç”¨é¼ æ ‡ç‚¹å‡»äº†å±å¹•ä¸Šçš„æŸä¸ªä½ç½®ï¼Œä½ éœ€è¦åˆ¤æ–­ä»–ç‚¹å‡»äº†å“ªä¸ªå›¾å½¢å…ƒç´ ã€‚

**å¬èµ·æ¥ç®€å•ï¼Ÿä½†è¯·è€ƒè™‘ï¼š**

- ç”»å¸ƒè¢«ç¼©æ”¾åˆ°äº† 150%
- ç”¨æˆ·å¹³ç§»äº†ç”»å¸ƒï¼Œå‘å³ç§»åŠ¨äº† 200 åƒç´ 
- è¢«ç‚¹å‡»çš„å›¾å½¢æœ¬èº«è¿˜æ—‹è½¬äº† 45 åº¦
- å›¾å½¢è¿˜åµŒå¥—åœ¨ä¸€ä¸ªç»„å†…ï¼Œç»„ä¹Ÿæœ‰è‡ªå·±çš„å˜æ¢

é¼ æ ‡äº‹ä»¶ç»™ä½ çš„æ˜¯ `event.clientX = 523, event.clientY = 312`ã€‚

**é—®é¢˜ï¼šè¿™ä¸ªç‚¹å¯¹åº”ç”»å¸ƒä¸Šçš„å“ªä¸ªåæ ‡ï¼Ÿè¿™ä¸ªåæ ‡è½åœ¨å“ªä¸ªå›¾å½¢å†…ï¼Ÿ**

è¿™å°±æ˜¯åæ ‡ç³»ç»Ÿè¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚

### 1.2 æ— é™ç”»å¸ƒçš„"æ— é™"æ¥è‡ªå“ªé‡Œï¼Ÿ

ä¼ ç»Ÿç”»å¸ƒæœ‰å›ºå®šå°ºå¯¸ï¼š

```javascript
// ä¼ ç»ŸCanvas
<canvas width="1920" height="1080" />
```

ç”»å¸ƒå°±è¿™ä¹ˆå¤§ï¼Œç”»å‡ºå»å°±çœ‹ä¸è§äº†ã€‚

**æ— é™ç”»å¸ƒçš„ç§˜å¯†ï¼š** ç”»å¸ƒæœ¬èº«è¿˜æ˜¯æœ‰é™çš„ï¼ˆå±å¹•å°±é‚£ä¹ˆå¤§ï¼‰ï¼Œä½†é€šè¿‡åæ ‡å˜æ¢ï¼Œæˆ‘ä»¬å¯ä»¥"è§‚å¯Ÿ"æ— é™å¤§çš„ç©ºé—´ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚                    æ— é™å¤§çš„ä¸–ç•Œç©ºé—´                          â”‚
â”‚                         â†‘                                   â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚        â”‚ å…ƒç´ A  â”‚       â”‚       â”‚ å…ƒç´ B  â”‚                  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                         â”‚                                   â”‚
â”‚    â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’              â”‚
â”‚                         â”‚                                   â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â†“       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚        â”‚ å…ƒç´ C  â”‚               â”‚ å…ƒç´ D  â”‚                  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”‚    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                                        â”‚
â”‚    â•‘  è§†å£çª—å£    â•‘ â† ç”¨æˆ·å®é™…çœ‹åˆ°çš„åŒºåŸŸ                    â”‚
â”‚    â•‘  (æœ‰é™å¤§å°)  â•‘                                         â”‚
â”‚    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœ¬è´¨ï¼š** æ— é™ç”»å¸ƒ = æœ‰é™è§†å£ + åæ ‡å˜æ¢ã€‚

### 1.3 æœ¬ç« è¦è§£å†³çš„é—®é¢˜

è¯»å®Œæœ¬ç« ï¼Œä½ å°†èƒ½å¤Ÿå›ç­”ï¼š

1. ç”¨æˆ·ç‚¹å‡»å±å¹• (523, 312)ï¼Œå¯¹åº”ä¸–ç•Œç©ºé—´çš„å“ªä¸ªåæ ‡ï¼Ÿ
2. ä¸–ç•Œç©ºé—´çš„å…ƒç´  (1000, 2000)ï¼Œåœ¨å±å¹•ä¸Šçš„å“ªä¸ªä½ç½®ï¼Ÿ
3. ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾ï¼Œéœ€è¦æ€ä¹ˆè®¡ç®—æ–°ä½ç½®ï¼Ÿ
4. å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç‚¹æ˜¯å¦åœ¨æ—‹è½¬åçš„çŸ©å½¢å†…ï¼Ÿ
5. å¦‚ä½•ä»å˜æ¢çŸ©é˜µä¸­æå–å‡ºæ—‹è½¬è§’åº¦å’Œç¼©æ”¾æ¯”ä¾‹ï¼Ÿ

---

## äºŒã€ä¸‰ä¸ªåæ ‡ç³»çš„æ·±åº¦è§£æ

### 2.1 å±å¹•åæ ‡ç³»ï¼ˆScreen Coordinatesï¼‰

**å®šä¹‰ï¼š** ä»¥æµè§ˆå™¨è§†å£å·¦ä¸Šè§’ä¸ºåŸç‚¹çš„åæ ‡ç³»ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æµè§ˆå™¨çª—å£                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ åœ°å€æ ã€å·¥å…·æ ç­‰                                     â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ (0, 0)                                              â”‚ â”‚
â”‚ â”‚ â†“                                                   â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚ â”‚ â”‚                                              â”‚    â”‚ â”‚
â”‚ â”‚ â”‚    é¡µé¢å†…å®¹                                  â”‚    â”‚ â”‚
â”‚ â”‚ â”‚                                              â”‚    â”‚ â”‚
â”‚ â”‚ â”‚         â— (523, 312)  â† é¼ æ ‡äº‹ä»¶åæ ‡         â”‚    â”‚ â”‚
â”‚ â”‚ â”‚                                              â”‚    â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è·å–æ–¹å¼ï¼š**

```typescript
element.addEventListener('click', (event) => {
    const screenX = event.clientX;  // ç›¸å¯¹äºè§†å£
    const screenY = event.clientY;
    
    // æ³¨æ„ï¼šä¸æ˜¯ event.pageX/pageYï¼ˆåŒ…å«æ»šåŠ¨åç§»ï¼‰
    // ä¹Ÿä¸æ˜¯ event.screenX/screenYï¼ˆç›¸å¯¹äºæ˜¾ç¤ºå™¨ï¼‰
});
```

**å…³é”®ç‚¹ï¼š**

- `clientX/clientY`ï¼šç›¸å¯¹äºæµè§ˆå™¨è§†å£å·¦ä¸Šè§’
- `pageX/pageY`ï¼šç›¸å¯¹äºæ–‡æ¡£å·¦ä¸Šè§’ï¼ˆåŒ…å«é¡µé¢æ»šåŠ¨ï¼‰
- `screenX/screenY`ï¼šç›¸å¯¹äºæ˜¾ç¤ºå™¨å·¦ä¸Šè§’ï¼ˆæå°‘ä½¿ç”¨ï¼‰
- `offsetX/offsetY`ï¼šç›¸å¯¹äºäº‹ä»¶ç›®æ ‡å…ƒç´ ï¼ˆå¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„ï¼‰

### 2.2 è§†å£åæ ‡ç³»ï¼ˆViewport Coordinatesï¼‰

**å®šä¹‰ï¼š** ä»¥ç”»å¸ƒå®¹å™¨å·¦ä¸Šè§’ä¸ºåŸç‚¹çš„åæ ‡ç³»ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½‘é¡µå†…å®¹                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å·¥å…·æ é¢æ¿           â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚ (ä¸æ˜¯ç”»å¸ƒ)           â”‚  â”‚  (0, 0)                  â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚    â†“ è§†å£åæ ‡åŸç‚¹        â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚  â”‚                     â”‚ â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚  â”‚   ç”»å¸ƒå®¹å™¨          â”‚ â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚  â”‚                     â”‚ â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚  â”‚  â— (viewX, viewY)   â”‚ â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚  â”‚                     â”‚ â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»å±å¹•åæ ‡è½¬æ¢ï¼š**

```typescript
// è·å–ç”»å¸ƒå®¹å™¨çš„ä½ç½®
const containerRect = canvasContainer.getBoundingClientRect();

// å±å¹•åæ ‡ â†’ è§†å£åæ ‡
const viewportX = event.clientX - containerRect.left;
const viewportY = event.clientY - containerRect.top;
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€æ­¥ï¼Ÿ**

ç”»å¸ƒå®¹å™¨ä¸ä¸€å®šåœ¨é¡µé¢å·¦ä¸Šè§’ã€‚å¯èƒ½æœ‰ä¾§è¾¹æ ã€å·¥å…·æ ç­‰å…¶ä»–å…ƒç´ ã€‚è§†å£åæ ‡è®©æˆ‘ä»¬ä¸“æ³¨äºç”»å¸ƒåŒºåŸŸå†…çš„ç›¸å¯¹ä½ç½®ã€‚

**ä»£ç ä½ç½®ï¼š**

```typescript
// infinite-plugins/src/plugins/viewport-plugin/hooks/use-gesture.ts

function handleZoom(event: WheelEvent) {
    const { left, top } = editor.containerRect;  // å®¹å™¨ä½ç½®
    const x = event.clientX - left;              // è½¬ä¸ºè§†å£åæ ‡
    const y = event.clientY - top;
    // ...
}
```

### 2.3 ä¸–ç•Œåæ ‡ç³»ï¼ˆWorld Coordinatesï¼‰

**å®šä¹‰ï¼š** ç”»å¸ƒå†…å®¹çš„"çœŸå®"åæ ‡ç³»ï¼Œä¸è§†å£å˜æ¢æ— å…³ã€‚

**è¿™æ˜¯æœ€å…³é”®çš„åæ ‡ç³»ã€‚** æ‰€æœ‰å…ƒç´ çš„ä½ç½®ã€å°ºå¯¸éƒ½åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­å®šä¹‰ã€‚

```
ä¸–ç•Œåæ ‡ç³»ï¼ˆæ— é™å¤§ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚    â”‚ å…ƒç´ A  â”‚ â† left: 100, top: 50
           â”‚    â”‚        â”‚    ï¼ˆä¸–ç•Œåæ ‡ï¼‰
           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
           â”‚
           â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚         â”‚ å…ƒç´ B   â”‚ â† left: 500, top: 300
           â”‚         â”‚         â”‚    ï¼ˆä¸–ç•Œåæ ‡ï¼‰
           â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
```

**å…³é”®ç‰¹æ€§ï¼š**

1. **ä¸å˜æ€§ï¼š** æ— è®ºç”¨æˆ·å¦‚ä½•ç¼©æ”¾ã€å¹³ç§»ç”»å¸ƒï¼Œå…ƒç´ åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ä½ç½®ä¸å˜
2. **é€»è¾‘æ€§ï¼š** å…ƒç´ çš„ `left`, `top`, `width`, `height` éƒ½æ˜¯ä¸–ç•Œåæ ‡
3. **æ— é™æ€§ï¼š** æ²¡æœ‰è¾¹ç•Œé™åˆ¶ï¼Œå¯ä»¥æ”¾ç½®åœ¨ä»»æ„ä½ç½®

### 2.4 ä¸‰ä¸ªåæ ‡ç³»çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚   å±å¹•åæ ‡ç³»                                                â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•                                               â”‚
â”‚   (event.clientX, event.clientY)                           â”‚
â”‚                                                             â”‚
â”‚         â”‚                                                   â”‚
â”‚         â”‚  Step 1: å‡å»å®¹å™¨åç§»                            â”‚
â”‚         â”‚  x = clientX - containerRect.left                â”‚
â”‚         â”‚  y = clientY - containerRect.top                 â”‚
â”‚         â†“                                                   â”‚
â”‚                                                             â”‚
â”‚   è§†å£åæ ‡ç³»                                                â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•                                               â”‚
â”‚   (viewportX, viewportY)                                   â”‚
â”‚                                                             â”‚
â”‚         â”‚                                                   â”‚
â”‚         â”‚  Step 2: åº”ç”¨è§†å£é€†å˜æ¢                          â”‚
â”‚         â”‚  worldX = (viewportX - viewport.x) / zoom        â”‚
â”‚         â”‚  worldY = (viewportY - viewport.y) / zoom        â”‚
â”‚         â†“                                                   â”‚
â”‚                                                             â”‚
â”‚   ä¸–ç•Œåæ ‡ç³»                                                â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•                                               â”‚
â”‚   (worldX, worldY)                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åå‘è½¬æ¢ï¼š**

```
ä¸–ç•Œåæ ‡ â†’ è§†å£åæ ‡ï¼š
viewportX = worldX * zoom + viewport.x
viewportY = worldY * zoom + viewport.y

è§†å£åæ ‡ â†’ å±å¹•åæ ‡ï¼š
screenX = viewportX + containerRect.left
screenY = viewportY + containerRect.top
```

---

## ä¸‰ã€åæ ‡è½¬æ¢çš„æ•°å­¦æœ¬è´¨

### 3.1 è§†å£çŠ¶æ€çš„ä¸‰ä¸ªå‚æ•°

è§†å£ç”±ä¸‰ä¸ªå‚æ•°å®šä¹‰ï¼š

```typescript
interface ViewportState {
    x: number;      // è§†å£åŸç‚¹åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ X åç§»
    y: number;      // è§†å£åŸç‚¹åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ Y åç§»
    zoom: number;   // ç¼©æ”¾æ¯”ä¾‹ï¼ˆ1 = 100%ï¼Œ0.5 = 50%ï¼Œ2 = 200%ï¼‰
}
```

**ç†è§£è¿™ä¸‰ä¸ªå‚æ•°ï¼š**

```
å‡è®¾ viewport = { x: 100, y: 50, zoom: 2 }

å«ä¹‰ï¼š
- zoom = 2ï¼šä¸–ç•Œåæ ‡æ”¾å¤§ 2 å€æ˜¾ç¤º
- x = 100ï¼šä¸–ç•ŒåŸç‚¹åœ¨è§†å£ä¸­æ˜¾ç¤ºåœ¨ x=100 çš„ä½ç½®
- y = 50ï¼šä¸–ç•ŒåŸç‚¹åœ¨è§†å£ä¸­æ˜¾ç¤ºåœ¨ y=50 çš„ä½ç½®

è§†è§‰æ•ˆæœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§†å£                                  â”‚
â”‚  (0,0)                                â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’    â”‚
â”‚     â”‚                                 â”‚
â”‚     â”‚  â† 100px â†’                      â”‚
â”‚     â”‚           â†“ 50px                â”‚
â”‚     â”‚           â—(100,50)             â”‚
â”‚     â”‚           â†‘                     â”‚
â”‚     â”‚           ä¸–ç•Œåæ ‡åŸç‚¹åœ¨è¿™é‡Œæ˜¾ç¤º  â”‚
â”‚     â†“                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ­£å‘å˜æ¢ï¼šä¸–ç•Œåæ ‡ â†’ è§†å£åæ ‡

**å…¬å¼æ¨å¯¼ï¼š**

```
è®¾ï¼šä¸–ç•Œåæ ‡ (wx, wy)ï¼Œè§†å£çŠ¶æ€ (vx, vy, zoom)
æ±‚ï¼šè§†å£åæ ‡ (sx, sy)

æ­¥éª¤1ï¼šç¼©æ”¾
    ä¸–ç•Œåæ ‡å…ˆä¹˜ä»¥ç¼©æ”¾æ¯”ä¾‹
    wx' = wx * zoom
    wy' = wy * zoom

æ­¥éª¤2ï¼šå¹³ç§»
    åŠ ä¸Šè§†å£åç§»
    sx = wx' + vx = wx * zoom + vx
    sy = wy' + vy = wy * zoom + vy

æœ€ç»ˆå…¬å¼ï¼š
    sx = wx * zoom + vx
    sy = wy * zoom + vy
```

**ä»£ç å®ç°ï¼š**

```typescript
// infinite-renderer/src/viewport/viewport.ts

getGlobalPoint(pos: IPointData, newPos?: Point, skipUpdate?: boolean): Point {
    // å†…éƒ¨è°ƒç”¨ page.getGlobalPoint
    // æœ¬è´¨æ˜¯ï¼šworldPoint * worldTransform
    return this.page.getGlobalPoint(pos, newPos, skipUpdate);
}
```

PixiJS å†…éƒ¨çš„ `worldTransform` çŸ©é˜µå·²ç»åŒ…å«äº†è§†å£çš„ä½ç½®å’Œç¼©æ”¾ä¿¡æ¯ã€‚

### 3.3 é€†å‘å˜æ¢ï¼šè§†å£åæ ‡ â†’ ä¸–ç•Œåæ ‡

**å…¬å¼æ¨å¯¼ï¼š**

```
è®¾ï¼šè§†å£åæ ‡ (sx, sy)ï¼Œè§†å£çŠ¶æ€ (vx, vy, zoom)
æ±‚ï¼šä¸–ç•Œåæ ‡ (wx, wy)

ä»æ­£å‘å…¬å¼ï¼š
    sx = wx * zoom + vx
    sy = wy * zoom + vy

è§£å‡º wx, wyï¼š
    wx = (sx - vx) / zoom
    wy = (sy - vy) / zoom
```

**ä»£ç å®ç°ï¼š**

```typescript
// infinite-renderer/src/viewport/viewport.ts

getLocalPoint(pos: IPointData, newPos?: Point, skipUpdate?: boolean): Point {
    // å†…éƒ¨è°ƒç”¨ page.getLocalPoint
    // æœ¬è´¨æ˜¯ï¼šscreenPoint * inverse(worldTransform)
    return this.page.getLocalPoint(pos, newPos, skipUpdate);
}
```

### 3.4 ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­

```typescript
// åœºæ™¯è®¾ç½®
const viewport = { x: 200, y: 100, zoom: 1.5 };
const containerRect = { left: 50, top: 30 };

// ç”¨æˆ·ç‚¹å‡»äº†å±å¹• (400, 250)
const event = { clientX: 400, clientY: 250 };

// Step 1: å±å¹•åæ ‡ â†’ è§†å£åæ ‡
const viewportX = event.clientX - containerRect.left;  // 400 - 50 = 350
const viewportY = event.clientY - containerRect.top;   // 250 - 30 = 220

// Step 2: è§†å£åæ ‡ â†’ ä¸–ç•Œåæ ‡
const worldX = (viewportX - viewport.x) / viewport.zoom;  // (350 - 200) / 1.5 = 100
const worldY = (viewportY - viewport.y) / viewport.zoom;  // (220 - 100) / 1.5 = 80

// ç»“è®ºï¼šç”¨æˆ·ç‚¹å‡»äº†ä¸–ç•Œåæ ‡ (100, 80)

// éªŒè¯ï¼šåå‘è®¡ç®—
// ä¸–ç•Œåæ ‡ (100, 80) â†’ è§†å£åæ ‡
const checkViewX = 100 * 1.5 + 200;  // 150 + 200 = 350 âœ“
const checkViewY = 80 * 1.5 + 100;   // 120 + 100 = 220 âœ“
```

---

## å››ã€2Dä»¿å°„å˜æ¢çŸ©é˜µ

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦çŸ©é˜µï¼Ÿ

**é—®é¢˜ï¼š** å•ç‹¬å­˜å‚¨ x, y, zoom åªèƒ½è¡¨ç¤ºç®€å•çš„å¹³ç§»å’Œç¼©æ”¾ã€‚å¦‚æœè¿˜æœ‰æ—‹è½¬å‘¢ï¼Ÿ

```typescript
// ç®€å•æ–¹æ¡ˆï¼ˆä¸æ”¯æŒæ—‹è½¬ï¼‰
interface SimpleTransform {
    x: number;
    y: number;
    zoom: number;
}

// å¦‚ä½•è¡¨ç¤ºæ—‹è½¬ï¼Ÿ
// å¦‚ä½•è¡¨ç¤ºå€¾æ–œï¼Ÿ
// å¦‚ä½•ç»„åˆå¤šä¸ªå˜æ¢ï¼Ÿ
```

**ç­”æ¡ˆï¼š** ä½¿ç”¨å˜æ¢çŸ©é˜µï¼Œå¯ä»¥ç»Ÿä¸€è¡¨ç¤ºæ‰€æœ‰ 2D ä»¿å°„å˜æ¢ã€‚

### 4.2 2D ä»¿å°„å˜æ¢çŸ©é˜µçš„ç»“æ„

```
â”Œ         â”
â”‚ a  c tx â”‚
â”‚ b  d ty â”‚
â”‚ 0  0  1 â”‚
â””         â”˜
```

**6 ä¸ªæœ‰æ•ˆå‚æ•°çš„å«ä¹‰ï¼š**

| å‚æ•° | å‡ ä½•å«ä¹‰ | å•ä½çŸ©é˜µå€¼ | å˜æ¢å…¬å¼ |
|------|---------|-----------|---------|
| `a` | X è½´ç¼©æ”¾ + X æ–¹å‘çš„æ°´å¹³å‰ªåˆ‡ | 1 | newX ä¸­ x çš„ç³»æ•° |
| `b` | Y è½´ç¼©æ”¾ + Y æ–¹å‘çš„å‚ç›´å‰ªåˆ‡ | 0 | newY ä¸­ x çš„ç³»æ•° |
| `c` | X è½´å€¾æ–œ | 0 | newX ä¸­ y çš„ç³»æ•° |
| `d` | Y è½´ç¼©æ”¾ | 1 | newY ä¸­ y çš„ç³»æ•° |
| `tx` | X è½´å¹³ç§» | 0 | newX çš„å¸¸æ•°é¡¹ |
| `ty` | Y è½´å¹³ç§» | 0 | newY çš„å¸¸æ•°é¡¹ |

### 4.3 ç‚¹çš„å˜æ¢è®¡ç®—

å°†ç‚¹ `(x, y)` é€šè¿‡çŸ©é˜µå˜æ¢ä¸º `(x', y')`ï¼š

```
â”Œ   â”   â”Œ         â”   â”Œ   â”
â”‚ x'â”‚   â”‚ a  c tx â”‚   â”‚ x â”‚
â”‚ y'â”‚ = â”‚ b  d ty â”‚ Ã— â”‚ y â”‚
â”‚ 1 â”‚   â”‚ 0  0  1 â”‚   â”‚ 1 â”‚
â””   â”˜   â””         â”˜   â””   â”˜

å±•å¼€è®¡ç®—ï¼š
x' = a*x + c*y + tx
y' = b*x + d*y + ty
```

**ä»£ç å®ç°ï¼š**

```typescript
// editor/utils/src/matrix.ts

class Matrix {
    a: number;
    b: number;
    c: number;
    d: number;
    tx: number;
    ty: number;

    /**
     * å°†ç‚¹ (x, y) åº”ç”¨çŸ©é˜µå˜æ¢
     */
    apply(pos: IPointData, newPos: Point = new Point()): Point {
        const x = pos.x;
        const y = pos.y;

        newPos.x = this.a * x + this.c * y + this.tx;
        newPos.y = this.b * x + this.d * y + this.ty;

        return newPos;
    }
}
```

### 4.4 æ‰¹é‡ç‚¹å˜æ¢

```typescript
// infinite-renderer/src/utils/math.ts

/**
 * å°†ä¸€ç»„ç‚¹æ‰¹é‡åº”ç”¨çŸ©é˜µå˜æ¢
 * points æ ¼å¼ï¼š[x0, y0, x1, y1, x2, y2, ...]
 */
export function transform(
    matrix: Matrix, 
    points: number[], 
    newPoints: number[] = []
): number[] {
    newPoints.length = points.length;
    
    for (let i = 0; i < points.length; i += 2) {
        const x = points[i];
        const y = points[i + 1];
        
        // åº”ç”¨çŸ©é˜µå˜æ¢
        const newX = matrix.a * x + matrix.c * y + matrix.tx;
        const newY = matrix.b * x + matrix.d * y + matrix.ty;
        
        newPoints[i] = newX;
        newPoints[i + 1] = newY;
    }
    
    return newPoints;
}
```

**ä¸ºä»€ä¹ˆç”¨æ‰å¹³æ•°ç»„ï¼Ÿ**

- å†…å­˜è¿ç»­ï¼Œç¼“å­˜å‹å¥½
- å‡å°‘å¯¹è±¡åˆ›å»ºå¼€é”€
- ä¾¿äºä¸ WebGL äº¤äº’

### 4.5 åŸºæœ¬å˜æ¢çš„çŸ©é˜µè¡¨ç¤º

#### å•ä½çŸ©é˜µï¼ˆIdentityï¼‰

```
â”Œ       â”
â”‚ 1 0 0 â”‚
â”‚ 0 1 0 â”‚      ä¸åšä»»ä½•å˜æ¢
â”‚ 0 0 1 â”‚      (x', y') = (x, y)
â””       â”˜
```

```typescript
static readonly IDENTITY = new Matrix(1, 0, 0, 1, 0, 0);

identity(): Matrix {
    this.a = 1;
    this.b = 0;
    this.c = 0;
    this.d = 1;
    this.tx = 0;
    this.ty = 0;
    return this;
}
```

#### å¹³ç§»ï¼ˆTranslationï¼‰

```
â”Œ         â”
â”‚ 1  0  txâ”‚
â”‚ 0  1  tyâ”‚      x' = x + tx
â”‚ 0  0  1 â”‚      y' = y + ty
â””         â”˜
```

```typescript
translate(x: number, y: number): Matrix {
    this.tx += x;
    this.ty += y;
    return this;
}
```

#### ç¼©æ”¾ï¼ˆScaleï¼‰

```
â”Œ          â”
â”‚ sx  0  0 â”‚
â”‚ 0  sy  0 â”‚      x' = x * sx
â”‚ 0   0  1 â”‚      y' = y * sy
â””          â”˜
```

```typescript
scale(x: number, y: number = x): Matrix {
    this.a *= x;
    this.b *= y;
    this.c *= x;
    this.d *= y;
    this.tx *= x;
    this.ty *= y;
    return this;
}
```

**æ³¨æ„ï¼š** ç¼©æ”¾ä¼šå½±å“ tx, tyï¼å› ä¸ºç¼©æ”¾æ˜¯åœ¨å½“å‰çŸ©é˜µåŸºç¡€ä¸Šè¿½åŠ çš„ã€‚

#### æ—‹è½¬ï¼ˆRotationï¼‰

```
â”Œ                    â”
â”‚ cos(Î¸)  -sin(Î¸)  0 â”‚
â”‚ sin(Î¸)   cos(Î¸)  0 â”‚      x' = x*cos(Î¸) - y*sin(Î¸)
â”‚   0        0     1 â”‚      y' = x*sin(Î¸) + y*cos(Î¸)
â””                    â”˜
```

```typescript
rotate(angle: number): Matrix {
    const cos = Math.cos(angle);
    const sin = Math.sin(angle);
    
    const a1 = this.a;
    const c1 = this.c;
    const tx1 = this.tx;
    
    this.a = a1 * cos - this.b * sin;
    this.b = a1 * sin + this.b * cos;
    this.c = c1 * cos - this.d * sin;
    this.d = c1 * sin + this.d * cos;
    this.tx = tx1 * cos - this.ty * sin;
    this.ty = tx1 * sin + this.ty * cos;
    
    return this;
}
```

---

## äº”ã€çŸ©é˜µè¿ç®—çš„ä»£ç å®ç°

### 5.1 Matrix ç±»å®Œæ•´å®ç°

```typescript
// editor/utils/src/matrix.ts

export class Matrix {
    public a: number;
    public b: number;
    public c: number;
    public d: number;
    public tx: number;
    public ty: number;

    static readonly IDENTITY = new Matrix();

    constructor(a = 1, b = 0, c = 0, d = 1, tx = 0, ty = 0) {
        this.a = a;
        this.b = b;
        this.c = c;
        this.d = d;
        this.tx = tx;
        this.ty = ty;
    }

    /**
     * è®¾ç½®çŸ©é˜µå‚æ•°
     */
    set(a: number, b: number, c: number, d: number, tx: number, ty: number): Matrix {
        this.a = a;
        this.b = b;
        this.c = c;
        this.d = d;
        this.tx = tx;
        this.ty = ty;
        return this;
    }

    /**
     * é‡ç½®ä¸ºå•ä½çŸ©é˜µ
     */
    identity(): Matrix {
        return this.set(1, 0, 0, 1, 0, 0);
    }

    /**
     * å…‹éš†çŸ©é˜µ
     */
    clone(): Matrix {
        return new Matrix(this.a, this.b, this.c, this.d, this.tx, this.ty);
    }

    /**
     * ä»å¦ä¸€ä¸ªçŸ©é˜µå¤åˆ¶
     */
    copyFrom(matrix: Matrix): Matrix {
        return this.set(matrix.a, matrix.b, matrix.c, matrix.d, matrix.tx, matrix.ty);
    }
}
```

### 5.2 çŸ©é˜µä¹˜æ³•ï¼šè¿½åŠ å˜æ¢

**æ•°å­¦åŸç†ï¼š**

ä¸¤ä¸ªå˜æ¢çš„ç»„åˆ = ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜

```
M_total = M_second Ã— M_first

â”Œ          â”   â”Œ          â”   â”Œ          â”
â”‚ a2 c2 tx2â”‚   â”‚ a1 c1 tx1â”‚   â”‚ a  c  tx â”‚
â”‚ b2 d2 ty2â”‚ Ã— â”‚ b1 d1 ty1â”‚ = â”‚ b  d  ty â”‚
â”‚ 0  0   1 â”‚   â”‚ 0  0   1 â”‚   â”‚ 0  0  1  â”‚
â””          â”˜   â””          â”˜   â””          â”˜

ç»“æœï¼š
a  = a2*a1 + c2*b1
b  = b2*a1 + d2*b1
c  = a2*c1 + c2*d1
d  = b2*c1 + d2*d1
tx = a2*tx1 + c2*ty1 + tx2
ty = b2*tx1 + d2*ty1 + ty2
```

**ä»£ç å®ç°ï¼š**

```typescript
// editor/utils/src/matrix.ts

/**
 * åœ¨å½“å‰çŸ©é˜µä¹‹åè¿½åŠ å˜æ¢
 * this = this Ã— matrix
 */
append(matrix: Matrix): Matrix {
    const a1 = this.a;
    const b1 = this.b;
    const c1 = this.c;
    const d1 = this.d;
    const tx1 = this.tx;
    const ty1 = this.ty;

    const { a: a2, b: b2, c: c2, d: d2, tx: tx2, ty: ty2 } = matrix;

    this.a = a1 * a2 + c1 * b2;
    this.b = b1 * a2 + d1 * b2;
    this.c = a1 * c2 + c1 * d2;
    this.d = b1 * c2 + d1 * d2;
    this.tx = a1 * tx2 + c1 * ty2 + tx1;
    this.ty = b1 * tx2 + d1 * ty2 + ty1;

    return this;
}

/**
 * åœ¨å½“å‰çŸ©é˜µä¹‹å‰æ·»åŠ å˜æ¢
 * this = matrix Ã— this
 */
prepend(matrix: Matrix): Matrix {
    const { a: a2, b: b2, c: c2, d: d2, tx: tx2, ty: ty2 } = matrix;

    const a1 = this.a;
    const b1 = this.b;
    const c1 = this.c;
    const d1 = this.d;
    const tx1 = this.tx;
    const ty1 = this.ty;

    this.a = a2 * a1 + c2 * b1;
    this.b = b2 * a1 + d2 * b1;
    this.c = a2 * c1 + c2 * d1;
    this.d = b2 * c1 + d2 * d1;
    this.tx = a2 * tx1 + c2 * ty1 + tx2;
    this.ty = b2 * tx1 + d2 * ty1 + ty2;

    return this;
}
```

**append vs prepend çš„åŒºåˆ«ï¼š**

```
å‡è®¾æœ‰å˜æ¢ A å’Œ Bï¼š
- A.append(B)ï¼šå…ˆ A å Bï¼Œç»“æœ = A Ã— B
- A.prepend(B)ï¼šå…ˆ B å Aï¼Œç»“æœ = B Ã— A

çŸ©é˜µä¹˜æ³•ä¸æ»¡è¶³äº¤æ¢å¾‹ï¼šA Ã— B â‰  B Ã— A
```

### 5.3 çŸ©é˜µæ±‚é€†

**ç”¨é€”ï¼š** é€†å‘å˜æ¢ã€‚å¦‚æœ M å°†ç‚¹ P å˜æ¢åˆ° P'ï¼Œé‚£ä¹ˆ Mâ»Â¹ å°† P' å˜æ¢å› Pã€‚

```typescript
// editor/utils/src/matrix.ts

/**
 * è®¡ç®—é€†çŸ©é˜µ
 */
invert(): Matrix {
    const a1 = this.a;
    const b1 = this.b;
    const c1 = this.c;
    const d1 = this.d;
    const tx1 = this.tx;
    const ty1 = this.ty;

    // è®¡ç®—è¡Œåˆ—å¼
    const determinant = a1 * d1 - b1 * c1;

    if (determinant === 0) {
        // çŸ©é˜µä¸å¯é€†ï¼Œé‡ç½®ä¸ºå•ä½çŸ©é˜µ
        return this.identity();
    }

    const invDet = 1 / determinant;

    this.a = d1 * invDet;
    this.b = -b1 * invDet;
    this.c = -c1 * invDet;
    this.d = a1 * invDet;
    this.tx = (c1 * ty1 - d1 * tx1) * invDet;
    this.ty = (b1 * tx1 - a1 * ty1) * invDet;

    return this;
}

/**
 * åº”ç”¨é€†å˜æ¢
 */
applyInverse(pos: IPointData, newPos: Point = new Point()): Point {
    const a = this.a;
    const b = this.b;
    const c = this.c;
    const d = this.d;
    const tx = this.tx;
    const ty = this.ty;

    const x = pos.x;
    const y = pos.y;

    const determinant = a * d - b * c;
    
    if (determinant === 0) {
        newPos.x = 0;
        newPos.y = 0;
        return newPos;
    }

    const invDet = 1 / determinant;

    newPos.x = (d * (x - tx) - c * (y - ty)) * invDet;
    newPos.y = (a * (y - ty) - b * (x - tx)) * invDet;

    return newPos;
}
```

---

## å…­ã€å¤åˆå˜æ¢ä¸å®é™…åº”ç”¨

### 6.1 ä»¥æŸç‚¹ä¸ºä¸­å¿ƒç¼©æ”¾

**é—®é¢˜ï¼š** ç”¨æˆ·ç”¨æ»šè½®ç¼©æ”¾æ—¶ï¼ŒæœŸæœ›ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾ã€‚

**é”™è¯¯çš„åšæ³•ï¼š**

```typescript
// é”™è¯¯ï¼šç›´æ¥æ”¹å˜ zoom
viewport.zoom = newZoom;
// ç»“æœï¼šç”»å¸ƒä»¥å·¦ä¸Šè§’ä¸ºä¸­å¿ƒç¼©æ”¾ï¼Œé¼ æ ‡ä¸‹çš„å†…å®¹ä¼š"è·‘æ‰"
```

**æ­£ç¡®çš„åšæ³•ï¼š**

```
æ­¥éª¤åˆ†è§£ï¼š
1. å°†é¼ æ ‡ä½ç½®ç§»åˆ°åæ ‡åŸç‚¹
2. æ‰§è¡Œç¼©æ”¾
3. å°†åŸç‚¹ç§»å›é¼ æ ‡ä½ç½®
```

**æ•°å­¦æ¨å¯¼ï¼š**

```
è®¾ï¼š
- é¼ æ ‡ä½ç½®ä¸º (mx, my)
- å½“å‰ç¼©æ”¾ä¸º z_oldï¼Œç›®æ ‡ç¼©æ”¾ä¸º z_new
- å½“å‰è§†å£ä½ç½®ä¸º (vx_old, vy_old)

ç›®æ ‡ï¼šè®¡ç®—æ–°çš„è§†å£ä½ç½® (vx_new, vy_new)

çº¦æŸï¼šé¼ æ ‡ä½ç½®åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­ä¿æŒä¸å˜

é¼ æ ‡åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ä½ç½®ï¼ˆå˜æ¢å‰ï¼‰ï¼š
    wx = (mx - vx_old) / z_old
    wy = (my - vy_old) / z_old

å˜æ¢åï¼ŒåŒä¸€ä¸ªä¸–ç•Œåæ ‡åº”è¯¥è¿˜åœ¨é¼ æ ‡ä½ç½®ï¼š
    mx = wx * z_new + vx_new
    my = wy * z_new + vy_new

è§£å‡º vx_new, vy_newï¼š
    vx_new = mx - wx * z_new
           = mx - ((mx - vx_old) / z_old) * z_new
           = mx - (mx - vx_old) * (z_new / z_old)
           = mx * (1 - z_new/z_old) + vx_old * (z_new/z_old)

ç®€åŒ–å½¢å¼ï¼ˆä½¿ç”¨çŸ©é˜µï¼‰ï¼š
    M = T(mx, my) Ã— S(z_new/z_old) Ã— T(-mx, -my)
    newPosition = M.apply(oldPosition)
```

**ä»£ç å®ç°ï¼š**

```typescript
// infinite-plugins/src/plugins/viewport-plugin/hooks/use-gesture.ts

function handleZoom(event: WheelEvent) {
    // è·å–é¼ æ ‡åœ¨è§†å£ä¸­çš„ä½ç½®
    const { left, top } = editor.containerRect;
    const x = event.clientX - left;
    const y = event.clientY - top;

    // è®¡ç®—æ–°çš„ç¼©æ”¾å€¼
    const { viewport } = editor;
    const deltaY = clamp(event.deltaY, -80, 80);
    const delta = (100 - deltaY * 0.6) / 100;
    const { minZoom, maxZoom } = editor.viewport.limit;
    const zoom = clamp(delta * viewport.zoom, minZoom, maxZoom);

    // æ„å»ºå˜æ¢çŸ©é˜µ
    // 1. ç§»åŠ¨åˆ°é¼ æ ‡ä½ç½®
    // 2. ç¼©æ”¾ï¼ˆå…ˆé™¤ä»¥æ—§ç¼©æ”¾ï¼Œå†ä¹˜ä»¥æ–°ç¼©æ”¾ï¼‰
    // 3. ç§»åŠ¨å›æ¥
    const matrix = Matrix.IDENTITY
        .translate(-x, -y)                              // ç§»åˆ°åŸç‚¹
        .scale(1 / viewport.zoom, 1 / viewport.zoom)   // ç§»é™¤æ—§ç¼©æ”¾
        .scale(zoom, zoom)                              // åº”ç”¨æ–°ç¼©æ”¾
        .translate(x, y);                               // ç§»å›

    // è®¡ç®—æ–°çš„è§†å£ä½ç½®
    const point = matrix.apply({
        x: editor.viewport.x,
        y: editor.viewport.y,
    });

    // åº”ç”¨å˜æ¢
    editor.viewport.setZoom(zoom);
    editor.viewport.setPosition(point.x, point.y);
}
```

### 6.2 æ»šåŠ¨å¹³ç§»

**ç›¸æ¯”ç¼©æ”¾ï¼Œå¹³ç§»ç®€å•å¾—å¤šï¼š**

```typescript
// infinite-plugins/src/plugins/viewport-plugin/hooks/use-gesture.ts

function handleScroll(event: WheelEvent) {
    // ç›´æ¥ä¿®æ”¹è§†å£ä½ç½®
    editor.viewport.translate(-event.deltaX, -event.deltaY);
}

// viewport.ts
translate(x: number, y: number): void {
    this.setPosition(this.position.x + x, this.position.y + y);
}
```

### 6.3 ç¼©æ”¾åˆ°ç‰¹å®šå…ƒç´ 

**åœºæ™¯ï¼š** åŒå‡»æŸä¸ªå…ƒç´ ï¼Œè®©å®ƒå±…ä¸­å¹¶é€‚é…å±å¹•æ˜¾ç¤ºã€‚

```typescript
// infinite-plugins/src/plugins/viewport-plugin/commands/zoom.ts

function zoomToElement(elementId: string, options: ZoomOptions = {}) {
    const { viewport } = editor;
    const { paddingRatio = 0.1, maxZoom: optMaxZoom, cubeBezier } = options;

    // è·å–å…ƒç´ è¾¹ç•Œï¼ˆä¸–ç•Œåæ ‡ï¼‰
    const bounds = editor.getElementBounds(elementId);
    if (!bounds) return;

    const { minZoom, maxZoom: limitMaxZoom } = viewport.limit;
    const maxZoom = optMaxZoom ?? limitMaxZoom;
    const [top, right, bottom, left] = viewport.padding;

    // è®¡ç®—å¯ç”¨è§†å£å°ºå¯¸ï¼ˆå‡å» paddingï¼‰
    const availableWidth = viewport.clientWidth - left - right;
    const availableHeight = viewport.clientHeight - top - bottom;

    // è®¡ç®—é€‚åˆçš„ç¼©æ”¾æ¯”ä¾‹
    const zoomX = availableWidth / bounds.width * (1 - paddingRatio);
    const zoomY = availableHeight / bounds.height * (1 - paddingRatio);
    const zoom = clamp(Math.min(zoomX, zoomY), minZoom, maxZoom);

    // è®¡ç®—å±…ä¸­ä½ç½®
    const centerX = bounds.x + bounds.width / 2;
    const centerY = bounds.y + bounds.height / 2;

    const x = -centerX * zoom + (availableWidth / 2) + left;
    const y = -centerY * zoom + (availableHeight / 2) + top;

    // å¸¦åŠ¨ç”»çš„è¿‡æ¸¡
    animate({
        x,
        y,
        zoom,
        cubeBezier,
    });
}
```

### 6.4 ç¼©æ”¾åˆ°å¤šä¸ªå…ƒç´ 

```typescript
// infinite-plugins/src/plugins/viewport-plugin/commands/zoom.ts

function zoomToFit(elementIds?: string[], options: ZoomOptions = {}) {
    const { viewport } = editor;
    
    // å¦‚æœæ²¡æœ‰æŒ‡å®šå…ƒç´ ï¼Œä½¿ç”¨æ‰€æœ‰å…ƒç´ 
    const ids = elementIds ?? editor.getAllElementIds();
    
    if (ids.length === 0) return;

    // è®¡ç®—æ‰€æœ‰å…ƒç´ çš„è”åˆè¾¹ç•Œ
    let minX = Infinity, minY = Infinity;
    let maxX = -Infinity, maxY = -Infinity;
    
    for (const id of ids) {
        const bounds = editor.getElementBounds(id);
        if (!bounds) continue;
        
        minX = Math.min(minX, bounds.x);
        minY = Math.min(minY, bounds.y);
        maxX = Math.max(maxX, bounds.x + bounds.width);
        maxY = Math.max(maxY, bounds.y + bounds.height);
    }

    const unionBounds = {
        x: minX,
        y: minY,
        width: maxX - minX,
        height: maxY - minY,
    };

    // ä½¿ç”¨ zoomToElement çš„é€»è¾‘
    zoomToRect(unionBounds, options);
}
```

---

## ä¸ƒã€çŸ©é˜µåˆ†è§£åŸç†

### 7.1 ä¸ºä»€ä¹ˆéœ€è¦çŸ©é˜µåˆ†è§£ï¼Ÿ

**é—®é¢˜ï¼š** æ•°æ®æ¨¡å‹ç”¨çŸ©é˜µå­˜å‚¨å˜æ¢ï¼ˆç´§å‡‘ï¼‰ï¼Œä½† UI éœ€è¦æ˜¾ç¤ºä½ç½®ã€ç¼©æ”¾ã€æ—‹è½¬ï¼ˆç›´è§‚ï¼‰ã€‚

```typescript
// æ•°æ®æ¨¡å‹ï¼ˆç´§å‡‘ï¼‰
interface ElementModel {
    localTransform: { a, b, c, d, tx, ty };
    width: number;
    height: number;
}

// UI æ˜¾ç¤ºï¼ˆç›´è§‚ï¼‰
// "ä½ç½®: (100, 50), ç¼©æ”¾: 150%, æ—‹è½¬: 45Â°"
```

**çŸ©é˜µåˆ†è§£ï¼š** ä» 6 ä¸ªçŸ©é˜µå‚æ•°ä¸­æå–å‡º position, scale, rotation, skewã€‚

### 7.2 åˆ†è§£ç®—æ³•

```typescript
// infinite-renderer/src/common/transform.ts

/**
 * ä»å±€éƒ¨å˜æ¢çŸ©é˜µä¸­åˆ†è§£å‡º Transform å±æ€§
 * 
 * @param localTransform å˜æ¢çŸ©é˜µ
 * @param width å…ƒç´ å®½åº¦ï¼ˆç”¨äºè®¡ç®—é”šç‚¹ï¼‰
 * @param height å…ƒç´ é«˜åº¦
 * @param transform è¾“å‡ºå¯¹è±¡
 */
export function decomposeLocalTransform(
    localTransform: MatrixInit,
    width: number,
    height: number,
    transform = new Transform(),
): Transform {
    const { a, b, c, d, tx, ty } = localTransform;

    // 1. è®¡ç®—ä¸­å¿ƒç‚¹ï¼ˆå˜æ¢é”šç‚¹ï¼Œé»˜è®¤åœ¨å…ƒç´ ä¸­å¿ƒï¼‰
    const pivot = { x: 0.5 * width, y: 0.5 * height };

    // 2. ä»çŸ©é˜µæå–å€¾æ–œè§’åº¦
    //    skewX = -atan2(-c, d)  // ä» c, d è®¡ç®—
    //    skewY = atan2(b, a)    // ä» a, b è®¡ç®—
    let skewX = -Math.atan2(-c, d);
    let skewY = Math.atan2(b, a);

    // 3. åˆ¤æ–­æ˜¯çº¯æ—‹è½¬è¿˜æ˜¯å€¾æ–œ
    //    å¦‚æœ skewX + skewY â‰ˆ 0 æˆ– â‰ˆ 2Ï€ï¼Œåˆ™æ˜¯çº¯æ—‹è½¬
    const delta = Math.abs(skewX + skewY);
    const PI_2 = Math.PI * 2;
    let rotation = 0;

    if (delta < 0.00001 || Math.abs(PI_2 - delta) < 0.00001) {
        // çº¯æ—‹è½¬æƒ…å†µ
        rotation = skewY;
        skewX = skewY = 0;
    } else {
        // æœ‰å€¾æ–œçš„æƒ…å†µ
        rotation = 0;
    }

    // 4. ä»çŸ©é˜µæå–ç¼©æ”¾
    //    scaleX = âˆš(aÂ² + bÂ²)
    //    scaleY = âˆš(cÂ² + dÂ²)
    const scaleX = Math.hypot(a, b);
    const scaleY = Math.hypot(c, d);

    // 5. è®¡ç®—ä½ç½®ï¼ˆè€ƒè™‘é”šç‚¹åç§»ï¼‰
    //    ç”±äºå…ƒç´ ä»¥ä¸­å¿ƒä¸ºé”šç‚¹æ—‹è½¬/ç¼©æ”¾ï¼Œéœ€è¦åæ¨å·¦ä¸Šè§’ä½ç½®
    const x = tx + pivot.x - (pivot.x * a + pivot.y * c);
    const y = ty + pivot.y - (pivot.x * b + pivot.y * d);

    // 6. è®¾ç½®ç»“æœ
    transform.position.set(x, y);
    transform.scale.set(scaleX, scaleY);
    transform.skew.set(skewX, skewY);
    transform.rotation = rotation;

    return transform;
}
```

### 7.3 æ•°å­¦æ¨å¯¼

**ä¸ºä»€ä¹ˆ `scaleX = âˆš(aÂ² + bÂ²)`ï¼Ÿ**

```
è€ƒè™‘ä¸€ä¸ªç¼©æ”¾+æ—‹è½¬çš„çŸ©é˜µï¼š
â”Œ                          â”
â”‚ sx*cos(Î¸)  -sy*sin(Î¸)  0 â”‚
â”‚ sx*sin(Î¸)   sy*cos(Î¸)  0 â”‚
â”‚     0           0      1 â”‚
â””                          â”˜

å…¶ä¸­ï¼š
a = sx*cos(Î¸)
b = sx*sin(Î¸)

æ‰€ä»¥ï¼š
âˆš(aÂ² + bÂ²) = âˆš(sxÂ²cosÂ²Î¸ + sxÂ²sinÂ²Î¸)
           = âˆš(sxÂ²(cosÂ²Î¸ + sinÂ²Î¸))
           = âˆš(sxÂ²)
           = sx
```

**ä¸ºä»€ä¹ˆ `rotation = atan2(b, a)`ï¼Ÿ**

```
ç»§ç»­ä¸Šé¢çš„ä¾‹å­ï¼š
a = sx*cos(Î¸)
b = sx*sin(Î¸)

atan2(b, a) = atan2(sx*sin(Î¸), sx*cos(Î¸))
            = atan2(sin(Î¸), cos(Î¸))  // sx çº¦æ‰
            = Î¸
```

### 7.4 åœ¨æ¸²æŸ“ä¸­çš„åº”ç”¨

```typescript
// infinite-renderer/src/vms/base/base-element-vm.ts

updateTransform(model: P = this._model): void {
    // æ›´æ–°å¯è§æ€§
    this.view.visible = !model.hidden && !model.$hidden;
    
    // ä»æ¨¡å‹çš„çŸ©é˜µåˆ†è§£å‡ºå˜æ¢å‚æ•°ï¼Œå¹¶åº”ç”¨åˆ°è§†å›¾
    decomposeTransform(model, this.transform, this.view.transform);
    
    // æ›´æ–°é€æ˜åº¦
    this.updateOpacity(model);
}

// è¿™é‡Œ decomposeTransform ä¼šï¼š
// 1. ä» model.localTransform åˆ†è§£å‡º position, scale, rotation
// 2. è®¾ç½®åˆ° this.view.transformï¼ˆPixiJS çš„ Transformï¼‰
// 3. PixiJS ä¼šæ®æ­¤è®¡ç®— worldTransform ç”¨äºæ¸²æŸ“
```

---

## å…«ã€åŒ…å›´ç›’ä¸ç¢°æ’æ£€æµ‹

### 8.1 ä»€ä¹ˆæ˜¯åŒ…å›´ç›’ï¼Ÿ

**åŒ…å›´ç›’ï¼ˆBounding Boxï¼‰ï¼š** èƒ½å¤Ÿå®Œå…¨åŒ…å›´å›¾å½¢çš„æœ€å°çŸ©å½¢ã€‚

ç”¨é€”ï¼š
- å¿«é€Ÿç¢°æ’æ£€æµ‹ï¼ˆç²—ç­›ï¼‰
- é€‰åŒºåˆ¤æ–­
- è§†å£è£å‰ªï¼ˆåªæ¸²æŸ“å¯è§å…ƒç´ ï¼‰

### 8.2 AABBï¼šè½´å¯¹é½åŒ…å›´ç›’

**å®šä¹‰ï¼š** è¾¹ä¸åæ ‡è½´å¹³è¡Œçš„åŒ…å›´ç›’ã€‚

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                             â”‚
        â”‚    â•±â•²                       â”‚
        â”‚   â•±  â•²  â† æ—‹è½¬çš„å…ƒç´         â”‚
        â”‚  â•±    â•²                     â”‚
        â”‚ â•±      â•²                    â”‚
        â”‚â•²        â•±                   â”‚
        â”‚ â•²      â•±                    â”‚
        â”‚  â•²    â•±                     â”‚
        â”‚   â•²  â•±                      â”‚
        â”‚    â•²â•±                       â”‚
        â”‚                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘ AABBï¼šè¾¹ä¸ X/Y è½´å¹³è¡Œ
```

**ä¼˜ç‚¹ï¼š**
- è®¡ç®—ç®€å•ï¼ˆåªéœ€æ‰¾ minX, maxX, minY, maxYï¼‰
- ç¢°æ’æ£€æµ‹å¿«é€Ÿ

**ç¼ºç‚¹ï¼š**
- å…ƒç´ æ—‹è½¬åï¼ŒAABB ä¼šå˜å¤§
- ç²¾åº¦ä½ï¼Œå¯èƒ½æœ‰å¤§é‡ç©ºç™½åŒºåŸŸ

**è®¡ç®—å®ç°ï¼š**

```typescript
// infinite-renderer/src/vms/base/base-element-vm.ts

getBounds(skipUpdate?: boolean, newRect = new Rectangle()): Rectangle {
    // ä½¿ç”¨ PixiJS çš„å†…ç½®æ–¹æ³•è®¡ç®— AABB
    return this.view.getBounds(skipUpdate, newRect);
}

// PixiJS å†…éƒ¨é€»è¾‘ï¼š
// 1. è·å–å…ƒç´ çš„å››ä¸ªé¡¶ç‚¹ï¼ˆä¸–ç•Œåæ ‡ï¼‰
// 2. æ‰¾åˆ° minX, maxX, minY, maxY
// 3. è¿”å› Rectangle(minX, minY, maxX-minX, maxY-minY)
```

### 8.3 OBBï¼šæœ‰å‘åŒ…å›´ç›’

**å®šä¹‰ï¼š** è¾¹ä¸å…ƒç´ å¯¹é½çš„åŒ…å›´ç›’ã€‚

```
            â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
           â•±               â•²
          â•±                 â•²
         â•±    â•±â•²             â•²
        â•±    â•±  â•²  å…ƒç´        â•²
       â•±    â•±    â•²             â•²
      â•±    â•±      â•²             â•²
      â•²   â•²        â•±            â•±
       â•²   â•²      â•±            â•±
        â•²   â•²    â•±            â•±
         â•²   â•²  â•±            â•±
          â•²   â•²â•±            â•±
           â•²               â•±
            â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±
            â†‘ OBBï¼šè¾¹ä¸å…ƒç´ è¾¹å¹³è¡Œ
```

**ä¼˜ç‚¹ï¼š**
- æ›´ç´§å‡‘ï¼Œæ²¡æœ‰å¤šä½™ç©ºç™½
- æ›´ç²¾ç¡®çš„ç¢°æ’æ£€æµ‹

**ç¼ºç‚¹ï¼š**
- è®¡ç®—å¤æ‚
- ç¢°æ’æ£€æµ‹éœ€è¦æ›´å¤šè¿ç®—

### 8.4 OBB çš„è¡¨ç¤ºä¸è®¡ç®—

**OBB è¡¨ç¤ºä¸ºï¼š** ä½ç½® + å°ºå¯¸ + æ—‹è½¬è§’åº¦

```typescript
interface OrientedRectangle {
    x: number;        // å·¦ä¸Šè§’ Xï¼ˆæ—‹è½¬å‰çš„å‚è€ƒç‚¹ï¼‰
    y: number;        // å·¦ä¸Šè§’ Y
    width: number;    // å®½åº¦
    height: number;   // é«˜åº¦
    rotation: number; // æ—‹è½¬è§’åº¦ï¼ˆå¼§åº¦ï¼‰
}
```

**ä»å››ä¸ªé¡¶ç‚¹è®¡ç®— OBBï¼š**

```typescript
// infinite-renderer/src/common/transform.ts

export function decomposeOrientedBounds(
    points: number[],  // [x0,y0, x1,y1, x2,y2, x3,y3] å››ä¸ªé¡¶ç‚¹
    orientedRect = OrientedRectangle.EMPTY,
): OrientedRectangle {
    // æå–å››ä¸ªé¡¶ç‚¹
    const x0 = points[0], y0 = points[1];  // ç¬¬ä¸€ä¸ªé¡¶ç‚¹
    const x1 = points[2], y1 = points[3];  // ç¬¬äºŒä¸ªé¡¶ç‚¹
    const x3 = points[4], y3 = points[5];  // å¯¹è§’é¡¶ç‚¹

    // 1. è®¡ç®—ç¬¬ä¸€æ¡è¾¹ä¸ X è½´çš„å¤¹è§’
    //    è¿™å°±æ˜¯ OBB çš„æ—‹è½¬è§’åº¦
    const theta = angle(1, 0, x1 - x0, y1 - y0);

    // 2. æ„å»ºåå‘æ—‹è½¬çŸ©é˜µ
    //    å°†å¤šè¾¹å½¢"æ‘†æ­£"ï¼Œä½¿è¾¹ä¸åæ ‡è½´å¹³è¡Œ
    const matrix = tempMatrix1
        .identity()
        .translate(-x0, -y0)   // ç§»åˆ°åŸç‚¹
        .rotate(-theta)         // åå‘æ—‹è½¬
        .translate(x0, y0);     // ç§»å›

    // 3. å°†å¯¹è§’é¡¶ç‚¹åº”ç”¨åå‘æ—‹è½¬
    const point = matrix.apply(tempPoint1.set(x3, y3), tempPoint2);

    // 4. è®¡ç®—"æ‘†æ­£"åçš„å®½é«˜
    const width = point.x - x0;
    const height = point.y - y0;

    // 5. è¿”å› OBB
    orientedRect.x = x0;
    orientedRect.y = y0;
    orientedRect.width = width;
    orientedRect.height = height;
    orientedRect.rotation = theta;

    return orientedRect;
}
```

### 8.5 AABB ç¢°æ’æ£€æµ‹

**ä¸¤ä¸ª AABB æ˜¯å¦ç›¸äº¤ï¼Ÿ**

```typescript
function aabbIntersects(a: Rectangle, b: Rectangle): boolean {
    // ä¸¤ä¸ªçŸ©å½¢åœ¨ X è½´å’Œ Y è½´ä¸Šéƒ½æœ‰é‡å æ‰ç›¸äº¤
    return a.x < b.x + b.width
        && a.x + a.width > b.x
        && a.y < b.y + b.height
        && a.y + a.height > b.y;
}
```

**ç‚¹æ˜¯å¦åœ¨ AABB å†…ï¼Ÿ**

```typescript
function aabbContains(rect: Rectangle, point: IPointData): boolean {
    return point.x >= rect.x
        && point.x <= rect.x + rect.width
        && point.y >= rect.y
        && point.y <= rect.y + rect.height;
}
```

### 8.6 OBB ç¢°æ’æ£€æµ‹ï¼šåˆ†ç¦»è½´å®šç†ï¼ˆSATï¼‰

**åˆ†ç¦»è½´å®šç†ï¼š** å¦‚æœä¸¤ä¸ªå‡¸å¤šè¾¹å½¢ä¸ç›¸äº¤ï¼Œåˆ™ä¸€å®šå­˜åœ¨ä¸€æ¡"åˆ†ç¦»è½´"ï¼Œå°†ä¸¤ä¸ªå¤šè¾¹å½¢åˆ†å¼€ã€‚

**ç®—æ³•æ­¥éª¤ï¼š**

1. å¯¹æ¯ä¸ªå¤šè¾¹å½¢çš„æ¯æ¡è¾¹ï¼Œå–å…¶æ³•å‘é‡ä½œä¸ºæŠ•å½±è½´
2. å°†ä¸¤ä¸ªå¤šè¾¹å½¢æŠ•å½±åˆ°è¯¥è½´ä¸Š
3. å¦‚æœæŠ•å½±æœ‰é—´éš”ï¼ˆä¸é‡å ï¼‰ï¼Œåˆ™å¤šè¾¹å½¢ä¸ç›¸äº¤
4. å¦‚æœæ‰€æœ‰è½´çš„æŠ•å½±éƒ½é‡å ï¼Œåˆ™å¤šè¾¹å½¢ç›¸äº¤

```typescript
// infinite-renderer/src/common/hit-test.ts

export function doesHitAreaIntersectRect(
    hitArea: Rectangle,
    rect: Rectangle,
    matrix: Matrix = IDENTITY,
): boolean {
    // 1. è·å– hitArea ç»è¿‡å˜æ¢åçš„å››ä¸ªé¡¶ç‚¹
    const vertices = getTransformedVertices(hitArea, matrix);
    
    // 2. è·å– rect çš„å››ä¸ªé¡¶ç‚¹
    const rectVertices = getRectVertices(rect);
    
    // 3. æ”¶é›†æ‰€æœ‰éœ€è¦æµ‹è¯•çš„åˆ†ç¦»è½´
    //    åŒ…æ‹¬ä¸¤ä¸ªå¤šè¾¹å½¢å„è¾¹çš„æ³•å‘é‡
    const axes = collectAxes(vertices, rectVertices);
    
    // 4. å¯¹æ¯ä¸ªè½´è¿›è¡ŒæŠ•å½±æµ‹è¯•
    for (const axis of axes) {
        const projA = projectPolygon(vertices, axis);
        const projB = projectPolygon(rectVertices, axis);
        
        // å¦‚æœæŠ•å½±ä¸é‡å ï¼Œæ‰¾åˆ°åˆ†ç¦»è½´ï¼Œä¸ç›¸äº¤
        if (!overlaps(projA, projB)) {
            return false;
        }
    }
    
    // æ‰€æœ‰è½´éƒ½é‡å ï¼Œç›¸äº¤
    return true;
}
```

---

## ä¹ã€å‘é‡è¿ç®—ä¸è§’åº¦è®¡ç®—

### 9.1 å‘é‡åŸºç¡€

**å‘é‡ï¼š** æœ‰æ–¹å‘å’Œå¤§å°çš„é‡ï¼Œç”¨ (x, y) è¡¨ç¤ºã€‚

```
å‘é‡ v = (3, 4)

    â†‘ y
    â”‚
    â”‚    â†— v = (3, 4)
    â”‚   â•±
    â”‚  â•± |v| = 5
    â”‚ â•±
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ x
```

**å‘é‡é•¿åº¦ï¼ˆæ¨¡ï¼‰ï¼š**

```
|v| = âˆš(xÂ² + yÂ²)

ç¤ºä¾‹ï¼š|(3, 4)| = âˆš(9 + 16) = âˆš25 = 5
```

```typescript
const length = Math.hypot(x, y);  // ç­‰ä»·äº Math.sqrt(x*x + y*y)
```

### 9.2 ç‚¹ç§¯ï¼ˆDot Productï¼‰

**å®šä¹‰ï¼š**

```
a Â· b = ax*bx + ay*by
      = |a| * |b| * cos(Î¸)

å…¶ä¸­ Î¸ æ˜¯ä¸¤å‘é‡çš„å¤¹è§’
```

**å‡ ä½•æ„ä¹‰ï¼š** ä¸€ä¸ªå‘é‡åœ¨å¦ä¸€ä¸ªå‘é‡æ–¹å‘ä¸Šçš„æŠ•å½±é•¿åº¦ Ã— å¦ä¸€ä¸ªå‘é‡çš„é•¿åº¦ã€‚

**ç”¨é€”ï¼š** è®¡ç®—ä¸¤å‘é‡å¤¹è§’çš„å¤§å°ï¼ˆä¸å«æ–¹å‘ï¼‰ã€‚

```typescript
const dot = ax * bx + ay * by;
const cosTheta = dot / (Math.hypot(ax, ay) * Math.hypot(bx, by));
const theta = Math.acos(cosTheta);
```

### 9.3 å‰ç§¯ï¼ˆCross Productï¼‰

**2D å‰ç§¯ï¼ˆä¼ªå‰ç§¯ï¼‰ï¼š**

```
a Ã— b = ax*by - ay*bx

ç»“æœæ˜¯ä¸€ä¸ªæ ‡é‡ï¼ˆåœ¨ 3D ä¸­æ˜¯ z åˆ†é‡ï¼‰
```

**å‡ ä½•æ„ä¹‰ï¼š** ä¸¤å‘é‡æ„æˆçš„å¹³è¡Œå››è¾¹å½¢çš„æœ‰ç¬¦å·é¢ç§¯ã€‚

- ç»“æœ > 0ï¼šb åœ¨ a çš„é€†æ—¶é’ˆæ–¹å‘
- ç»“æœ < 0ï¼šb åœ¨ a çš„é¡ºæ—¶é’ˆæ–¹å‘
- ç»“æœ = 0ï¼ša å’Œ b å¹³è¡Œ

**ç”¨é€”ï¼š** åˆ¤æ–­è§’åº¦çš„æ–¹å‘ï¼ˆé¡ºæ—¶é’ˆ/é€†æ—¶é’ˆï¼‰ã€‚

### 9.4 å®Œæ•´çš„å¤¹è§’è®¡ç®—

```typescript
// infinite-renderer/src/utils/math.ts

/**
 * è®¡ç®—ä»å‘é‡ a åˆ°å‘é‡ b çš„æœ‰ç¬¦å·å¤¹è§’
 * 
 * @param ax å‘é‡ a çš„ x åˆ†é‡
 * @param ay å‘é‡ a çš„ y åˆ†é‡
 * @param bx å‘é‡ b çš„ x åˆ†é‡
 * @param by å‘é‡ b çš„ y åˆ†é‡
 * @returns å¤¹è§’ï¼ˆå¼§åº¦ï¼‰ï¼Œæ­£å€¼ä¸ºé€†æ—¶é’ˆï¼Œè´Ÿå€¼ä¸ºé¡ºæ—¶é’ˆ
 */
export function angle(ax: number, ay: number, bx: number, by: number): number {
    // 1. è®¡ç®—ä¸¤å‘é‡çš„æ¨¡
    const am = Math.hypot(ax, ay);
    const bm = Math.hypot(bx, by);

    // 2. ä½¿ç”¨ç‚¹ç§¯å…¬å¼è®¡ç®—å¤¹è§’ä½™å¼¦
    //    cos(Î¸) = (a Â· b) / (|a| Ã— |b|)
    const dot = ax * bx + ay * by;
    const cosTheta = dot / (am * bm);
    
    // 3. ä½¿ç”¨ acos è·å–å¤¹è§’å¤§å°ï¼ˆ0 åˆ° Ï€ï¼‰
    const theta = Math.acos(clamp(cosTheta, -1, 1));  // clamp é˜²æ­¢æµ®ç‚¹è¯¯å·®

    // 4. ä½¿ç”¨å‰ç§¯åˆ¤æ–­æ–¹å‘
    //    z = ax*by - ay*bx
    const z = ax * by - ay * bx;
    const sign = z >= 0 ? 1 : -1;

    // 5. è¿”å›æœ‰ç¬¦å·è§’åº¦
    return theta * sign;
}
```

**åº”ç”¨åœºæ™¯ï¼š**

```typescript
// è®¡ç®—æ—‹è½¬æ‰‹æŸ„çš„æ—‹è½¬è§’åº¦
function getRotationAngle(center: Point, start: Point, current: Point): number {
    // èµ·å§‹å‘é‡
    const startVec = { x: start.x - center.x, y: start.y - center.y };
    // å½“å‰å‘é‡
    const currVec = { x: current.x - center.x, y: current.y - center.y };
    
    // è®¡ç®—ä¸¤å‘é‡çš„å¤¹è§’
    return angle(startVec.x, startVec.y, currVec.x, currVec.y);
}
```

### 9.5 åˆ¤æ–­ç‚¹åœ¨çº¿æ®µçš„å“ªä¸€ä¾§

```typescript
// infinite-renderer/src/utils/math.ts

/**
 * è®¡ç®—ç‚¹ç›¸å¯¹äºæœ‰å‘çº¿æ®µçš„æ–¹å‘
 * 
 * @returns æ­£å€¼ï¼šç‚¹åœ¨çº¿æ®µå·¦ä¾§
 *          è´Ÿå€¼ï¼šç‚¹åœ¨çº¿æ®µå³ä¾§
 *          é›¶ï¼šç‚¹åœ¨çº¿æ®µä¸Š
 */
export function orientation(
    ax: number, ay: number,  // çº¿æ®µèµ·ç‚¹
    bx: number, by: number,  // çº¿æ®µç»ˆç‚¹
    cx: number, cy: number,  // å¾…åˆ¤æ–­çš„ç‚¹
): number {
    // å‘é‡ AB
    const abx = bx - ax;
    const aby = by - ay;
    
    // å‘é‡ AC
    const acx = cx - ax;
    const acy = cy - ay;
    
    // AB Ã— ACï¼ˆå‰ç§¯ï¼‰
    return abx * acy - aby * acx;
}
```

**ç”¨é€”ï¼š** åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…éƒ¨ã€‚

---

## åã€å®æˆ˜æ¡ˆä¾‹åˆ†æ

### 10.1 æ¡ˆä¾‹ä¸€ï¼šé¼ æ ‡ç‚¹å‡»é€‰ä¸­å…ƒç´ 

**å®Œæ•´æµç¨‹ï¼š**

```typescript
// 1. ç›‘å¬ç‚¹å‡»äº‹ä»¶
canvas.addEventListener('click', (event) => {
    // 2. å±å¹•åæ ‡ â†’ è§†å£åæ ‡
    const viewportX = event.clientX - containerRect.left;
    const viewportY = event.clientY - containerRect.top;
    
    // 3. è§†å£åæ ‡ â†’ ä¸–ç•Œåæ ‡
    const worldPoint = viewport.getLocalPoint({ x: viewportX, y: viewportY });
    
    // 4. ç¢°æ’æ£€æµ‹
    const hitElement = surface.hitTest(worldPoint);
    
    // 5. æ›´æ–°é€‰ä¸­çŠ¶æ€
    if (hitElement) {
        editor.select(hitElement.id);
    } else {
        editor.clearSelection();
    }
});
```

### 10.2 æ¡ˆä¾‹äºŒï¼šæ¡†é€‰å¤šä¸ªå…ƒç´ 

```typescript
// 1. è®°å½•æ¡†é€‰èµ·ç‚¹ï¼ˆä¸–ç•Œåæ ‡ï¼‰
let startPoint: Point;
canvas.addEventListener('mousedown', (event) => {
    const viewportPoint = { x: event.clientX - containerRect.left, y: event.clientY - containerRect.top };
    startPoint = viewport.getLocalPoint(viewportPoint);
});

// 2. ç»˜åˆ¶é€‰åŒºçŸ©å½¢
canvas.addEventListener('mousemove', (event) => {
    if (!startPoint) return;
    
    const viewportPoint = { x: event.clientX - containerRect.left, y: event.clientY - containerRect.top };
    const currentPoint = viewport.getLocalPoint(viewportPoint);
    
    // è®¡ç®—é€‰åŒºçŸ©å½¢
    const selectionRect = new Rectangle(
        Math.min(startPoint.x, currentPoint.x),
        Math.min(startPoint.y, currentPoint.y),
        Math.abs(currentPoint.x - startPoint.x),
        Math.abs(currentPoint.y - startPoint.y)
    );
    
    // ç»˜åˆ¶é€‰åŒºæ¡†ï¼ˆè§†å£åæ ‡ï¼‰
    drawSelectionRect(selectionRect);
});

// 3. å®Œæˆæ¡†é€‰
canvas.addEventListener('mouseup', () => {
    // ä½¿ç”¨ intersect æ‰¾åˆ°ä¸é€‰åŒºç›¸äº¤çš„æ‰€æœ‰å…ƒç´ 
    const elements = surface.intersect(selectionRect);
    editor.selectMultiple(elements.map(e => e.id));
});
```

### 10.3 æ¡ˆä¾‹ä¸‰ï¼šæ‹–æ‹½ç§»åŠ¨å…ƒç´ 

```typescript
let dragStart: Point;
let elementStartPos: Point;

element.addEventListener('mousedown', (event) => {
    // è®°å½•æ‹–æ‹½èµ·ç‚¹ï¼ˆè§†å£åæ ‡ï¼‰å’Œå…ƒç´ åˆå§‹ä½ç½®
    dragStart = { x: event.clientX, y: event.clientY };
    elementStartPos = { x: element.model.left, y: element.model.top };
});

document.addEventListener('mousemove', (event) => {
    if (!dragStart) return;
    
    // è®¡ç®—å±å¹•åæ ‡çš„åç§»é‡
    const deltaScreen = {
        x: event.clientX - dragStart.x,
        y: event.clientY - dragStart.y,
    };
    
    // è½¬æ¢ä¸ºä¸–ç•Œåæ ‡çš„åç§»é‡ï¼ˆéœ€è¦é™¤ä»¥ç¼©æ”¾ï¼‰
    const deltaWorld = {
        x: deltaScreen.x / viewport.zoom,
        y: deltaScreen.y / viewport.zoom,
    };
    
    // æ›´æ–°å…ƒç´ ä½ç½®
    element.model.left = elementStartPos.x + deltaWorld.x;
    element.model.top = elementStartPos.y + deltaWorld.y;
});
```

### 10.4 æ¡ˆä¾‹å››ï¼šæ—‹è½¬å…ƒç´ 

```typescript
// 1. è·å–å…ƒç´ ä¸­å¿ƒç‚¹ï¼ˆä¸–ç•Œåæ ‡ï¼‰
const center = {
    x: element.model.left + element.model.width / 2,
    y: element.model.top + element.model.height / 2,
};

// 2. è®°å½•èµ·å§‹è§’åº¦
let startAngle: number;
rotateHandle.addEventListener('mousedown', (event) => {
    const worldPoint = viewport.getLocalPoint({
        x: event.clientX - containerRect.left,
        y: event.clientY - containerRect.top,
    });
    
    // ä»ä¸­å¿ƒåˆ°ç‚¹å‡»ä½ç½®çš„å‘é‡
    startAngle = Math.atan2(worldPoint.y - center.y, worldPoint.x - center.x);
});

// 3. è®¡ç®—æ—‹è½¬è§’åº¦
document.addEventListener('mousemove', (event) => {
    if (startAngle === undefined) return;
    
    const worldPoint = viewport.getLocalPoint({
        x: event.clientX - containerRect.left,
        y: event.clientY - containerRect.top,
    });
    
    // å½“å‰è§’åº¦
    const currentAngle = Math.atan2(worldPoint.y - center.y, worldPoint.x - center.x);
    
    // è§’åº¦å·®
    const deltaAngle = currentAngle - startAngle;
    
    // æ›´æ–°å…ƒç´ æ—‹è½¬
    element.model.rotation += deltaAngle;
    
    // æ›´æ–°èµ·å§‹è§’åº¦ï¼ˆå¢é‡æ—‹è½¬ï¼‰
    startAngle = currentAngle;
});
```

---

## æœ¬ç« å°ç»“

### æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| ä¸‰ä¸ªåæ ‡ç³» | å±å¹• â†’ è§†å£ â†’ ä¸–ç•Œï¼Œå±‚å±‚è½¬æ¢ |
| è§†å£çŠ¶æ€ | x, y, zoom ä¸‰ä¸ªå‚æ•°å®šä¹‰è§†å›¾ |
| ä»¿å°„çŸ©é˜µ | 6 å‚æ•°è¡¨ç¤ºå¹³ç§»ã€ç¼©æ”¾ã€æ—‹è½¬ã€å€¾æ–œ |
| çŸ©é˜µä¹˜æ³• | append/prepend ç»„åˆå¤šä¸ªå˜æ¢ |
| çŸ©é˜µåˆ†è§£ | ä»çŸ©é˜µæå– position/scale/rotation |
| AABB | è½´å¯¹é½åŒ…å›´ç›’ï¼Œç®€å•ä½†ä¸ç²¾ç¡® |
| OBB | æœ‰å‘åŒ…å›´ç›’ï¼Œç²¾ç¡®ä½†å¤æ‚ |
| å‘é‡ç‚¹ç§¯ | è®¡ç®—å¤¹è§’å¤§å° |
| å‘é‡å‰ç§¯ | åˆ¤æ–­å¤¹è§’æ–¹å‘ |

### å…³é”®å…¬å¼

```
è§†å£åæ ‡ â†’ ä¸–ç•Œåæ ‡ï¼š
    worldX = (viewportX - viewport.x) / zoom
    worldY = (viewportY - viewport.y) / zoom

ä¸–ç•Œåæ ‡ â†’ è§†å£åæ ‡ï¼š
    viewportX = worldX * zoom + viewport.x
    viewportY = worldY * zoom + viewport.y

ä»¥ç‚¹ P ä¸ºä¸­å¿ƒç¼©æ”¾ï¼š
    M = T(P) Ã— S(scale) Ã— T(-P)

å‘é‡å¤¹è§’ï¼š
    cos(Î¸) = (aÂ·b) / (|a|Ã—|b|)
    æ–¹å‘ = sign(aÃ—b)
```

### å…³é”®ä»£ç æ–‡ä»¶

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `editor/utils/src/matrix.ts` | Matrix ç±»å®ç° |
| `infinite-renderer/src/utils/math.ts` | æ•°å­¦å·¥å…·å‡½æ•° |
| `infinite-renderer/src/common/transform.ts` | çŸ©é˜µåˆ†è§£ã€OBB è®¡ç®— |
| `infinite-renderer/src/viewport/viewport.ts` | åæ ‡è½¬æ¢ API |
| `infinite-plugins/src/plugins/viewport-plugin/hooks/use-gesture.ts` | æ‰‹åŠ¿å¤„ç† |
| `infinite-plugins/src/plugins/viewport-plugin/commands/zoom.ts` | ç¼©æ”¾å‘½ä»¤ |

---

> **ä¸‹ä¸€ç« **ï¼š[ç¬¬4ç« ï¼šViewport è§†å£ç®¡ç†](./04-Viewportè§†å£ç®¡ç†.md) â€”â€” ç†è§£æ¸²æŸ“æ¶æ„çš„é¡¶å±‚è®¾è®¡
