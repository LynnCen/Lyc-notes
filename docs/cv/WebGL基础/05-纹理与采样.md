# ç¬¬5ç« ï¼šçº¹ç†ä¸é‡‡æ ·

## 5.1 ç« èŠ‚æ¦‚è¿°

å•çº¯çš„é¢œè‰²å’Œå‡ ä½•å½¢çŠ¶èƒ½è¡¨è¾¾çš„å†…å®¹éå¸¸æœ‰é™ã€‚æƒ³è¦è®© 3D æ¨¡å‹çœ‹èµ·æ¥çœŸå®â€”â€”æœ¨çº¹ã€ç –å¢™ã€çš®è‚¤ç»†èŠ‚â€”â€”éƒ½éœ€è¦ä½¿ç”¨**çº¹ç†ï¼ˆTextureï¼‰**ã€‚çº¹ç†æœ¬è´¨ä¸Šæ˜¯"è´´"åœ¨å‡ ä½•è¡¨é¢ä¸Šçš„å›¾åƒã€‚

æœ¬ç« å°†æ·±å…¥è®²è§£ï¼š

- **çº¹ç†åŸºç¡€**ï¼šåˆ›å»ºã€ç»‘å®šã€ä¸Šä¼ å›¾åƒ
- **çº¹ç†å‚æ•°**ï¼šç¯ç»‘æ¨¡å¼ã€è¿‡æ»¤æ¨¡å¼
- **Mipmap**ï¼šå¤šçº§æ¸è¿œçº¹ç†
- **çº¹ç†å•å…ƒ**ï¼šä½¿ç”¨å¤šä¸ªçº¹ç†
- **ç‰¹æ®Šçº¹ç†ç±»å‹**ï¼šç«‹æ–¹ä½“è´´å›¾ã€æµ®ç‚¹çº¹ç†ã€æ•°æ®çº¹ç†

---

## 5.2 çº¹ç†åŸºç¡€æ¦‚å¿µ

### 5.2.1 ä»€ä¹ˆæ˜¯çº¹ç†ï¼Ÿ

**çº¹ç†ï¼ˆTextureï¼‰** æ˜¯å­˜å‚¨åœ¨ GPU æ˜¾å­˜ä¸­çš„å›¾åƒæ•°æ®ã€‚åœ¨ç€è‰²å™¨ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡**çº¹ç†åæ ‡**æ¥é‡‡æ ·çº¹ç†çš„é¢œè‰²ã€‚

```
çº¹ç†æ˜ å°„è¿‡ç¨‹

3D æ¨¡å‹é¡¶ç‚¹å¸¦æœ‰çº¹ç†åæ ‡ (UV)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     3D ä¸‰è§’å½¢              â”‚
â”‚         â•±â•²                â”‚
â”‚        â•±  â•²               â”‚
â”‚       â•± UV â•²              â”‚
â”‚      â•±      â•²             â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ ä½¿ç”¨ UV åæ ‡æŸ¥æ‰¾çº¹ç†
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     çº¹ç†å›¾åƒ              â”‚
â”‚                           â”‚
â”‚   (0,1)â”€â”€â”€â”€â”€â”€â”€â”€(1,1)      â”‚
â”‚     â”‚  ğŸ–¼ï¸      â”‚          â”‚
â”‚     â”‚ å›¾åƒæ•°æ®  â”‚          â”‚
â”‚     â”‚          â”‚          â”‚
â”‚   (0,0)â”€â”€â”€â”€â”€â”€â”€â”€(1,0)      â”‚
â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ è¿”å›é‡‡æ ·çš„é¢œè‰²
        â–¼
    ç‰‡æ®µé¢œè‰²
```

### 5.2.2 çº¹ç†åæ ‡ç³»ï¼ˆUVï¼‰

```
çº¹ç†åæ ‡ç³»ï¼ˆä¹Ÿå« UV åæ ‡æˆ– ST åæ ‡ï¼‰

(0, 1)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(1, 1)
   â”‚                  â”‚
   â”‚    çº¹ç†å›¾åƒ      â”‚
   â”‚       V          â”‚
   â”‚       â†‘          â”‚
   â”‚       â”‚          â”‚
   â”‚       â””â”€â”€â†’ U     â”‚
   â”‚                  â”‚
(0, 0)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(1, 0)

ç‰¹ç‚¹ï¼š
- èŒƒå›´ï¼š[0, 1]
- åŸç‚¹åœ¨å·¦ä¸‹è§’
- U å‘å³ï¼ŒV å‘ä¸Š
- ä¸å›¾åƒå­˜å‚¨æ ¼å¼å¯èƒ½ç›¸åï¼ˆå¾ˆå¤šå›¾åƒæ ¼å¼ Y è½´å‘ä¸‹ï¼‰

çº¹ç†åæ ‡å¯ä»¥è¶…å‡º [0, 1]ï¼š
- UV < 0 æˆ– UV > 1 æ—¶çš„è¡Œä¸ºç”±ç¯ç»‘æ¨¡å¼å†³å®š
```

### 5.2.3 çº¹ç†ç±»å‹

| çº¹ç†ç±»å‹ | WebGL å¸¸é‡ | è¯´æ˜ |
|---------|-----------|------|
| 2D çº¹ç† | `TEXTURE_2D` | æœ€å¸¸ç”¨ï¼Œæ™®é€šå›¾åƒ |
| ç«‹æ–¹ä½“çº¹ç† | `TEXTURE_CUBE_MAP` | 6 ä¸ªé¢ï¼Œç”¨äºç¯å¢ƒè´´å›¾ |
| 3D çº¹ç† | `TEXTURE_3D` | ä½“ç§¯çº¹ç†ï¼ˆWebGL 2.0ï¼‰ |
| 2D çº¹ç†æ•°ç»„ | `TEXTURE_2D_ARRAY` | å¤šå±‚ 2D çº¹ç†ï¼ˆWebGL 2.0ï¼‰ |

---

## 5.3 åˆ›å»ºå’Œä½¿ç”¨çº¹ç†

### 5.3.1 çº¹ç†åˆ›å»ºæµç¨‹

```
çº¹ç†åˆ›å»ºå®Œæ•´æµç¨‹

1. åˆ›å»ºçº¹ç†å¯¹è±¡
   gl.createTexture()
        â”‚
        â–¼
2. ç»‘å®šçº¹ç†
   gl.bindTexture(gl.TEXTURE_2D, texture)
        â”‚
        â–¼
3. è®¾ç½®çº¹ç†å‚æ•°
   gl.texParameteri(...)
        â”‚
        â–¼
4. ä¸Šä¼ å›¾åƒæ•°æ®
   gl.texImage2D(...)
        â”‚
        â–¼
5. ç”Ÿæˆ Mipmapï¼ˆå¯é€‰ï¼‰
   gl.generateMipmap(...)
        â”‚
        â–¼
6. åœ¨æ¸²æŸ“æ—¶ç»‘å®šåˆ°çº¹ç†å•å…ƒ
   gl.activeTexture(gl.TEXTURE0)
   gl.bindTexture(gl.TEXTURE_2D, texture)
   gl.uniform1i(samplerLocation, 0)
```

### 5.3.2 åŠ è½½å›¾åƒçº¹ç†

```javascript
/**
 * åŠ è½½å›¾åƒå¹¶åˆ›å»ºçº¹ç†
 */
function loadTexture(gl, url) {
    // åˆ›å»ºçº¹ç†å¯¹è±¡
    const texture = gl.createTexture();
    
    // å…ˆä½¿ç”¨ 1x1 åƒç´ çš„å ä½çº¹ç†
    gl.bindTexture(gl.TEXTURE_2D, texture);
    gl.texImage2D(
        gl.TEXTURE_2D,
        0,                    // mipmap çº§åˆ«
        gl.RGBA,              // å†…éƒ¨æ ¼å¼
        1, 1,                 // å®½é«˜
        0,                    // è¾¹æ¡†ï¼ˆå¿…é¡»ä¸º 0ï¼‰
        gl.RGBA,              // æºæ•°æ®æ ¼å¼
        gl.UNSIGNED_BYTE,     // æ•°æ®ç±»å‹
        new Uint8Array([255, 0, 255, 255])  // ç²‰è‰²å ä½
    );
    
    // å¼‚æ­¥åŠ è½½å›¾åƒ
    const image = new Image();
    image.crossOrigin = 'anonymous';  // å¤„ç†è·¨åŸŸ
    
    image.onload = () => {
        gl.bindTexture(gl.TEXTURE_2D, texture);
        
        // ä¸Šä¼ å›¾åƒæ•°æ®
        gl.texImage2D(
            gl.TEXTURE_2D,
            0,
            gl.RGBA,
            gl.RGBA,
            gl.UNSIGNED_BYTE,
            image
        );
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ 2 çš„å¹‚
        if (isPowerOf2(image.width) && isPowerOf2(image.height)) {
            // ç”Ÿæˆ Mipmap
            gl.generateMipmap(gl.TEXTURE_2D);
            
            // è®¾ç½®è¿‡æ»¤æ¨¡å¼
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        } else {
            // é 2 çš„å¹‚çº¹ç†ï¼ŒWebGL 1.0 æœ‰é™åˆ¶
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        }
        
        console.log(`çº¹ç†åŠ è½½å®Œæˆ: ${image.width}x${image.height}`);
    };
    
    image.onerror = () => {
        console.error('çº¹ç†åŠ è½½å¤±è´¥:', url);
    };
    
    image.src = url;
    
    return texture;
}

function isPowerOf2(value) {
    return (value & (value - 1)) === 0;
}
```

### 5.3.3 åœ¨ç€è‰²å™¨ä¸­ä½¿ç”¨çº¹ç†

```glsl
// é¡¶ç‚¹ç€è‰²å™¨
attribute vec3 a_position;
attribute vec2 a_texCoord;

varying vec2 v_texCoord;

void main() {
    gl_Position = vec4(a_position, 1.0);
    v_texCoord = a_texCoord;
}

// ç‰‡æ®µç€è‰²å™¨
precision mediump float;

varying vec2 v_texCoord;
uniform sampler2D u_texture;

void main() {
    // texture2D å‡½æ•°é‡‡æ ·çº¹ç†
    vec4 texColor = texture2D(u_texture, v_texCoord);
    gl_FragColor = texColor;
}
```

```javascript
// JavaScript ç«¯è®¾ç½®çº¹ç†

// æ¿€æ´»çº¹ç†å•å…ƒ 0
gl.activeTexture(gl.TEXTURE0);

// ç»‘å®šçº¹ç†
gl.bindTexture(gl.TEXTURE_2D, texture);

// å‘Šè¯‰ç€è‰²å™¨ä½¿ç”¨çº¹ç†å•å…ƒ 0
const samplerLocation = gl.getUniformLocation(program, 'u_texture');
gl.uniform1i(samplerLocation, 0);
```

---

## 5.4 çº¹ç†å‚æ•°è¯¦è§£

### 5.4.1 ç¯ç»•æ¨¡å¼ï¼ˆWrap Modeï¼‰

ç¯ç»•æ¨¡å¼å†³å®šå½“çº¹ç†åæ ‡è¶…å‡º [0, 1] èŒƒå›´æ—¶çš„è¡Œä¸ºï¼š

```
ç¯ç»•æ¨¡å¼ç¤ºæ„

åŸå§‹çº¹ç†ï¼ˆUV èŒƒå›´ [0,1]ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    A    â”‚
â”‚    â†“    â”‚
â”‚ B â†’ â— â† â”‚
â”‚    â†‘    â”‚
â”‚    C    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


gl.REPEATï¼ˆé‡å¤ï¼‰:
UV è¶…å‡ºèŒƒå›´æ—¶ï¼Œçº¹ç†ä¼šé‡å¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    A    â”‚    A    â”‚    A    â”‚
â”‚    â†“    â”‚    â†“    â”‚    â†“    â”‚
â”‚ B â†’ â— â† â”‚ B â†’ â— â† â”‚ B â†’ â— â† â”‚
â”‚    â†‘    â”‚    â†‘    â”‚    â†‘    â”‚
â”‚    C    â”‚    C    â”‚    C    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    A    â”‚    A    â”‚    A    â”‚
â”‚ ...     â”‚         â”‚ ...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


gl.MIRRORED_REPEATï¼ˆé•œåƒé‡å¤ï¼‰:
UV è¶…å‡ºèŒƒå›´æ—¶ï¼Œçº¹ç†é•œåƒé‡å¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    C    â”‚    A    â”‚    C    â”‚
â”‚    â†‘    â”‚    â†“    â”‚    â†‘    â”‚
â”‚ â† â— â†’ B â”‚ B â†’ â— â† â”‚ â† â— â†’ B â”‚
â”‚    â†“    â”‚    â†‘    â”‚    â†“    â”‚
â”‚    A    â”‚    C    â”‚    A    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


gl.CLAMP_TO_EDGEï¼ˆè¾¹ç¼˜é’³åˆ¶ï¼‰:
UV è¶…å‡ºèŒƒå›´æ—¶ï¼Œä½¿ç”¨è¾¹ç¼˜é¢œè‰²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ A A A A â”‚ A A A A â”‚ A A A A â”‚
â”‚ B B B B â”‚ B â†’ â— â† â”‚ â–¡ â–¡ â–¡ â–¡ â”‚
â”‚ B B B B â”‚ B â†’ â— â† â”‚ â–¡ â–¡ â–¡ â–¡ â”‚
â”‚ C C C C â”‚ C C C C â”‚ C C C C â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å·¦è¾¹ç”¨ B å¡«å……ï¼Œå³è¾¹ç”¨ â–¡ï¼ˆå³è¾¹ç¼˜é¢œè‰²ï¼‰å¡«å……
```

```javascript
// è®¾ç½®ç¯ç»•æ¨¡å¼
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);      // S æ–¹å‘ï¼ˆUï¼‰
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);      // T æ–¹å‘ï¼ˆVï¼‰

// WebGL 2.0 è¿˜æœ‰ R æ–¹å‘ï¼ˆç”¨äº 3D çº¹ç†ï¼‰
gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_WRAP_R, gl.REPEAT);

// å¸¸ç”¨ç»„åˆ
// æ— ç¼å¹³é“ºçº¹ç†ï¼ˆåœ°æ¿ã€å¢™å£ï¼‰
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);

// è¾¹ç¼˜ä¸é‡å¤ï¼ˆUI å…ƒç´ ï¼‰
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
```

### 5.4.2 è¿‡æ»¤æ¨¡å¼ï¼ˆFilter Modeï¼‰

è¿‡æ»¤æ¨¡å¼å†³å®šçº¹ç†åœ¨æ”¾å¤§/ç¼©å°æ—¶çš„é‡‡æ ·æ–¹å¼ï¼š

```
çº¹ç†è¿‡æ»¤ç¤ºæ„

æ”¾å¤§ï¼ˆTEXTURE_MAG_FILTERï¼‰:
å½“ä¸€ä¸ªçº¹ç†åƒç´ ï¼ˆtexelï¼‰è¦†ç›–å¤šä¸ªå±å¹•åƒç´ æ—¶

åŸå§‹çº¹ç†ï¼ˆ4x4ï¼‰           æ”¾å¤§åï¼ˆ8x8ï¼‰

â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”                â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”
â”‚Râ”‚Gâ”‚Râ”‚Gâ”‚                â”‚?â”‚?â”‚?â”‚?â”‚?â”‚?â”‚?â”‚?â”‚
â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤     æ”¾å¤§ â†’    â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¤
â”‚Bâ”‚Yâ”‚Bâ”‚Yâ”‚                â”‚?â”‚?â”‚?â”‚?â”‚?â”‚?â”‚?â”‚?â”‚
â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤                â”‚ ...            â”‚
â”‚Râ”‚Gâ”‚Râ”‚Gâ”‚
â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¤
â”‚Bâ”‚Yâ”‚Bâ”‚Yâ”‚
â””â”€â”´â”€â”´â”€â”´â”€â”˜

gl.NEARESTï¼ˆæœ€è¿‘é‚»ï¼‰:     gl.LINEARï¼ˆçº¿æ€§ï¼‰:
é€‰æ‹©æœ€è¿‘çš„texel          æ··åˆå‘¨å›´texels
â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”         â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”
â”‚Râ”‚Râ”‚Gâ”‚Gâ”‚Râ”‚Râ”‚Gâ”‚Gâ”‚         â”‚Râ”‚~â”‚Gâ”‚~â”‚~â”‚Râ”‚~â”‚Gâ”‚
â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¤         â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¤
â”‚Râ”‚Râ”‚Gâ”‚Gâ”‚Râ”‚Râ”‚Gâ”‚Gâ”‚         â”‚~â”‚~â”‚~â”‚~â”‚~â”‚~â”‚~â”‚~â”‚
â”‚ ...            â”‚         â”‚ ...            â”‚

å—çŠ¶ã€é”åˆ©è¾¹ç¼˜              å¹³æ»‘ã€æ¨¡ç³Š


ç¼©å°ï¼ˆTEXTURE_MIN_FILTERï¼‰:
å½“å¤šä¸ªtexelè¦†ç›–ä¸€ä¸ªå±å¹•åƒç´ æ—¶

åŸå§‹çº¹ç†ï¼ˆ8x8ï¼‰           ç¼©å°åï¼ˆ2x2ï¼‰

â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”         â”Œâ”€â”€â”€â”¬â”€â”€â”€â”
â”‚Râ”‚Gâ”‚Râ”‚Gâ”‚Bâ”‚Yâ”‚Bâ”‚Yâ”‚  ç¼©å°â†’  â”‚ ? â”‚ ? â”‚
â”œâ”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”¤         â”œâ”€â”€â”€â”¼â”€â”€â”€â”¤
â”‚Bâ”‚Yâ”‚Bâ”‚Yâ”‚Râ”‚Gâ”‚Râ”‚Gâ”‚         â”‚ ? â”‚ ? â”‚
â”‚ ...            â”‚         â””â”€â”€â”€â”´â”€â”€â”€â”˜

éœ€è¦å†³å®šå¦‚ä½•ä»å¤šä¸ªtexelä¸­é€‰æ‹©é¢œè‰²
```

```javascript
// æ”¾å¤§è¿‡æ»¤ï¼ˆé€šå¸¸åªæœ‰ä¸¤ä¸ªé€‰é¡¹ï¼‰
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);  // æœ€è¿‘é‚»
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);   // çº¿æ€§

// ç¼©å°è¿‡æ»¤ï¼ˆæœ‰æ›´å¤šé€‰é¡¹ï¼Œæ¶‰åŠ Mipmapï¼‰
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST_MIPMAP_NEAREST);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST_MIPMAP_LINEAR);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);

// Mipmap è¿‡æ»¤æ¨¡å¼å‘½åè§„åˆ™ï¼š
// [texelè¿‡æ»¤]_MIPMAP_[mipmapçº§åˆ«è¿‡æ»¤]
// 
// NEAREST_MIPMAP_NEAREST: 
//   åœ¨æœ€è¿‘çš„mipmapçº§åˆ«ä¸­ç”¨æœ€è¿‘é‚»é‡‡æ ·
// 
// LINEAR_MIPMAP_LINEAR:
//   åœ¨ä¸¤ä¸ªæœ€è¿‘çš„mipmapçº§åˆ«ä¸­åˆ†åˆ«ç”¨çº¿æ€§é‡‡æ ·ï¼Œç„¶åæ··åˆ
//   è¿™æ˜¯æœ€é«˜è´¨é‡çš„è¿‡æ»¤ï¼Œä¹Ÿå«"ä¸‰çº¿æ€§è¿‡æ»¤"
```

---

## 5.5 Mipmap è¯¦è§£

### 5.5.1 ä»€ä¹ˆæ˜¯ Mipmapï¼Ÿ

**Mipmap** æ˜¯é¢„å…ˆè®¡ç®—å¥½çš„ä¸€ç³»åˆ—é€çº§ç¼©å°çš„çº¹ç†ç‰ˆæœ¬ï¼Œç”¨äºæé«˜æ¸²æŸ“è´¨é‡å’Œæ€§èƒ½ã€‚

```
Mipmap é‡‘å­—å¡”

çº§åˆ« 0ï¼ˆåŸå§‹å°ºå¯¸ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           â”‚
â”‚         256Ã—256           â”‚
â”‚                           â”‚
â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çº§åˆ« 1:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   128Ã—128   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çº§åˆ« 2:
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚64Ã—64 â”‚
â””â”€â”€â”€â”€â”€â”€â”˜

çº§åˆ« 3:
â”Œâ”€â”€â”
â”‚32â”‚
â””â”€â”€â”˜

çº§åˆ« 4-8: 16, 8, 4, 2, 1

æ€»å†…å­˜ = 256Â² + 128Â² + 64Â² + ... â‰ˆ åŸå§‹çš„ 4/3ï¼ˆçº¦å¢åŠ  33%ï¼‰
```

### 5.5.2 ä¸ºä»€ä¹ˆéœ€è¦ Mipmapï¼Ÿ

```
æ²¡æœ‰ Mipmap çš„é—®é¢˜

è¿œå¤„çš„çº¹ç†ï¼ˆçº¹ç†åƒç´  >> å±å¹•åƒç´ ï¼‰:
                                    
åŸå§‹çº¹ç†      è¿œå¤„æ˜¾ç¤º        é—®é¢˜
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”                 é—ªçƒ/æ‘©å°”çº¹
  â”‚ â–‘â–’â–“â–ˆâ–’ â”‚    â†’  â–‘â–’â–ˆ      å› ä¸ºé‡‡æ ·ä¸è¶³
  â”‚ â–“â–ˆâ–ˆâ–‘â–’ â”‚       â–“â–‘       æ— æ³•æ­£ç¡®è¡¨ç¤º
  â”‚ â–‘â–’â–“â–’â–‘ â”‚                ç»†èŠ‚
  â””â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨ Mipmap:
  
é€‰æ‹©åˆé€‚çš„mipmapçº§åˆ«  â†’  â–’  å¹³æ»‘ã€ç¨³å®š
é¢„å…ˆå¹³å‡äº†ç»†èŠ‚              æ— é—ªçƒ
```

### 5.5.3 ä½¿ç”¨ Mipmap

```javascript
// ç”Ÿæˆ Mipmap
gl.bindTexture(gl.TEXTURE_2D, texture);
gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
gl.generateMipmap(gl.TEXTURE_2D);  // è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰çº§åˆ«

// ä½¿ç”¨ Mipmap è¿‡æ»¤
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);


// æ‰‹åŠ¨ä¸Šä¼ å„çº§ Mipmapï¼ˆç”¨äºè‡ªå®šä¹‰ mipmapï¼‰
function uploadCustomMipmaps(gl, images) {
    for (let level = 0; level < images.length; level++) {
        gl.texImage2D(
            gl.TEXTURE_2D,
            level,               // mipmap çº§åˆ«
            gl.RGBA,
            gl.RGBA,
            gl.UNSIGNED_BYTE,
            images[level]
        );
    }
}


// WebGL 2.0: è®¾ç½® mipmap çº§åˆ«èŒƒå›´
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_BASE_LEVEL, 0);   // æœ€ç²¾ç»†çº§åˆ«
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAX_LEVEL, 4);    // æœ€ç²—ç³™çº§åˆ«
```

---

## 5.6 çº¹ç†å•å…ƒ

### 5.6.1 ä»€ä¹ˆæ˜¯çº¹ç†å•å…ƒï¼Ÿ

GPU æœ‰å¤šä¸ª**çº¹ç†å•å…ƒï¼ˆTexture Unitï¼‰**ï¼Œæ¯ä¸ªå•å…ƒå¯ä»¥ç»‘å®šä¸€ä¸ªçº¹ç†ã€‚è¿™å…è®¸ç€è‰²å™¨åŒæ—¶è®¿é—®å¤šä¸ªçº¹ç†ã€‚

```
çº¹ç†å•å…ƒç¤ºæ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GPU                             â”‚
â”‚                                                      â”‚
â”‚  çº¹ç†å•å…ƒ 0        çº¹ç†å•å…ƒ 1        çº¹ç†å•å…ƒ 2      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ æ¼«åå°„  â”‚      â”‚ æ³•çº¿    â”‚      â”‚ é«˜å…‰    â”‚     â”‚
â”‚  â”‚ è´´å›¾    â”‚      â”‚ è´´å›¾    â”‚      â”‚ è´´å›¾    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚       â”‚               â”‚                â”‚            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                       â–¼                             â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚               â”‚ ç‰‡æ®µç€è‰²å™¨  â”‚                       â”‚
â”‚               â”‚             â”‚                       â”‚
â”‚               â”‚ sampler2D   â”‚                       â”‚
â”‚               â”‚ u_diffuse   â”‚  â†’ ä»å•å…ƒ 0 é‡‡æ ·      â”‚
â”‚               â”‚ u_normal    â”‚  â†’ ä»å•å…ƒ 1 é‡‡æ ·      â”‚
â”‚               â”‚ u_specular  â”‚  â†’ ä»å•å…ƒ 2 é‡‡æ ·      â”‚
â”‚               â”‚             â”‚                       â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.6.2 ä½¿ç”¨å¤šä¸ªçº¹ç†

```javascript
/**
 * è®¾ç½®å¤šä¸ªçº¹ç†
 */
function setupMultipleTextures(gl, program, textures) {
    // è·å– sampler uniform ä½ç½®
    const diffuseLoc = gl.getUniformLocation(program, 'u_diffuseMap');
    const normalLoc = gl.getUniformLocation(program, 'u_normalMap');
    const specularLoc = gl.getUniformLocation(program, 'u_specularMap');
    
    // ç»‘å®šçº¹ç†åˆ°ä¸åŒçš„çº¹ç†å•å…ƒ
    // çº¹ç†å•å…ƒ 0: æ¼«åå°„è´´å›¾
    gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D, textures.diffuse);
    gl.uniform1i(diffuseLoc, 0);  // å‘Šè¯‰ sampler ä½¿ç”¨å•å…ƒ 0
    
    // çº¹ç†å•å…ƒ 1: æ³•çº¿è´´å›¾
    gl.activeTexture(gl.TEXTURE1);
    gl.bindTexture(gl.TEXTURE_2D, textures.normal);
    gl.uniform1i(normalLoc, 1);  // å‘Šè¯‰ sampler ä½¿ç”¨å•å…ƒ 1
    
    // çº¹ç†å•å…ƒ 2: é«˜å…‰è´´å›¾
    gl.activeTexture(gl.TEXTURE2);
    gl.bindTexture(gl.TEXTURE_2D, textures.specular);
    gl.uniform1i(specularLoc, 2);  // å‘Šè¯‰ sampler ä½¿ç”¨å•å…ƒ 2
}

// å¯ç”¨çš„çº¹ç†å•å…ƒæ•°é‡
const maxTextureUnits = gl.getParameter(gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS);
console.log('æœ€å¤§çº¹ç†å•å…ƒæ•°:', maxTextureUnits);  // é€šå¸¸è‡³å°‘ 8 ä¸ªï¼Œç°ä»£ GPU 32+
```

```glsl
// ç‰‡æ®µç€è‰²å™¨ï¼šä½¿ç”¨å¤šä¸ªçº¹ç†
precision mediump float;

varying vec2 v_texCoord;
varying vec3 v_normal;
varying vec3 v_viewDir;
varying vec3 v_lightDir;

uniform sampler2D u_diffuseMap;
uniform sampler2D u_normalMap;
uniform sampler2D u_specularMap;

void main() {
    // é‡‡æ ·å„ä¸ªçº¹ç†
    vec4 diffuseColor = texture2D(u_diffuseMap, v_texCoord);
    vec3 normalMap = texture2D(u_normalMap, v_texCoord).rgb * 2.0 - 1.0;
    float specularIntensity = texture2D(u_specularMap, v_texCoord).r;
    
    // ä½¿ç”¨é‡‡æ ·çš„æ•°æ®è¿›è¡Œå…‰ç…§è®¡ç®—
    vec3 N = normalize(v_normal + normalMap);
    vec3 L = normalize(v_lightDir);
    vec3 V = normalize(v_viewDir);
    vec3 R = reflect(-L, N);
    
    float diff = max(dot(N, L), 0.0);
    float spec = pow(max(dot(R, V), 0.0), 32.0) * specularIntensity;
    
    vec3 finalColor = diffuseColor.rgb * diff + vec3(spec);
    gl_FragColor = vec4(finalColor, diffuseColor.a);
}
```

---

## 5.7 çº¹ç†æ ¼å¼

### 5.7.1 å¸¸ç”¨çº¹ç†æ ¼å¼

```javascript
// ============ å†…éƒ¨æ ¼å¼ï¼ˆGPU å­˜å‚¨æ ¼å¼ï¼‰============

// åŸºæœ¬æ ¼å¼
gl.RGBA        // çº¢ç»¿è“é€æ˜ï¼Œå„ 8 ä½
gl.RGB         // çº¢ç»¿è“ï¼Œå„ 8 ä½
gl.LUMINANCE   // ç°åº¦ï¼ˆå•é€šé“ï¼‰
gl.ALPHA       // åªæœ‰é€æ˜é€šé“

// WebGL 2.0 æ‰©å±•æ ¼å¼
gl.RGBA8       // 8 ä½ RGBA
gl.RGBA16F     // 16 ä½æµ®ç‚¹ RGBA
gl.RGBA32F     // 32 ä½æµ®ç‚¹ RGBA
gl.R8          // 8 ä½å•é€šé“
gl.RG8         // 8 ä½åŒé€šé“
gl.R16F        // 16 ä½æµ®ç‚¹å•é€šé“
gl.DEPTH_COMPONENT24  // 24 ä½æ·±åº¦


// ============ æ•°æ®ç±»å‹ ============

gl.UNSIGNED_BYTE         // 0-255
gl.UNSIGNED_SHORT_5_6_5  // 16 ä½ RGB (5-6-5)
gl.UNSIGNED_SHORT_4_4_4_4 // 16 ä½ RGBA (4-4-4-4)
gl.UNSIGNED_SHORT_5_5_5_1 // 16 ä½ RGBA (5-5-5-1)
gl.FLOAT                 // 32 ä½æµ®ç‚¹ï¼ˆéœ€è¦æ‰©å±•æˆ– WebGL 2.0ï¼‰
gl.HALF_FLOAT            // 16 ä½æµ®ç‚¹ï¼ˆéœ€è¦æ‰©å±•æˆ– WebGL 2.0ï¼‰
```

### 5.7.2 ä»ä¸åŒæºåˆ›å»ºçº¹ç†

```javascript
// ============ ä» HTML å…ƒç´ åˆ›å»º ============

// ä» <img> å…ƒç´ 
gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, imageElement);

// ä» <canvas> å…ƒç´ 
gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, canvasElement);

// ä» <video> å…ƒç´ ï¼ˆæ¯å¸§æ›´æ–°ï¼‰
gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, videoElement);


// ============ ä» TypedArray åˆ›å»º ============

// ä» Uint8Arrayï¼ˆåŸå§‹åƒç´ æ•°æ®ï¼‰
const width = 256;
const height = 256;
const pixels = new Uint8Array(width * height * 4);  // RGBA

// å¡«å……æ•°æ®...
for (let i = 0; i < width * height; i++) {
    pixels[i * 4 + 0] = (i % 256);     // R
    pixels[i * 4 + 1] = (i / 256) | 0; // G
    pixels[i * 4 + 2] = 128;           // B
    pixels[i * 4 + 3] = 255;           // A
}

gl.texImage2D(
    gl.TEXTURE_2D,
    0,
    gl.RGBA,
    width, height,
    0,
    gl.RGBA,
    gl.UNSIGNED_BYTE,
    pixels
);


// ============ ä»æµ®ç‚¹æ•°æ®åˆ›å»ºï¼ˆWebGL 2.0ï¼‰============

const floatData = new Float32Array(width * height * 4);
// å¡«å……æµ®ç‚¹æ•°æ®...

gl.texImage2D(
    gl.TEXTURE_2D,
    0,
    gl.RGBA32F,      // å†…éƒ¨æ ¼å¼
    width, height,
    0,
    gl.RGBA,         // æºæ ¼å¼
    gl.FLOAT,        // æ•°æ®ç±»å‹
    floatData
);
```

---

## 5.8 ç«‹æ–¹ä½“è´´å›¾ï¼ˆCubemapï¼‰

### 5.8.1 ä»€ä¹ˆæ˜¯ç«‹æ–¹ä½“è´´å›¾ï¼Ÿ

ç«‹æ–¹ä½“è´´å›¾æ˜¯ç”± 6 ä¸ªé¢ç»„æˆçš„çº¹ç†ï¼Œç”¨äºç¯å¢ƒæ˜ å°„ã€å¤©ç©ºç›’ç­‰ï¼š

```
ç«‹æ–¹ä½“è´´å›¾ç»“æ„

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”
        â”‚  +Y   â”‚  (ä¸Š)
        â”‚ TOP   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚  -X   â”‚  +Z   â”‚  +X   â”‚  -Z   â”‚
â”‚ LEFT  â”‚ FRONT â”‚ RIGHT â”‚ BACK  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚  -Y   â”‚
        â”‚BOTTOM â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”˜

6 ä¸ªé¢å¯¹åº”çš„å¸¸é‡ï¼š
gl.TEXTURE_CUBE_MAP_POSITIVE_X  (+X, å³)
gl.TEXTURE_CUBE_MAP_NEGATIVE_X  (-X, å·¦)
gl.TEXTURE_CUBE_MAP_POSITIVE_Y  (+Y, ä¸Š)
gl.TEXTURE_CUBE_MAP_NEGATIVE_Y  (-Y, ä¸‹)
gl.TEXTURE_CUBE_MAP_POSITIVE_Z  (+Z, å‰)
gl.TEXTURE_CUBE_MAP_NEGATIVE_Z  (-Z, å)
```

### 5.8.2 åˆ›å»ºç«‹æ–¹ä½“è´´å›¾

```javascript
/**
 * åˆ›å»ºç«‹æ–¹ä½“è´´å›¾
 */
function createCubemap(gl, faceImages) {
    const cubemap = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_CUBE_MAP, cubemap);
    
    const faces = [
        { target: gl.TEXTURE_CUBE_MAP_POSITIVE_X, image: faceImages.right },
        { target: gl.TEXTURE_CUBE_MAP_NEGATIVE_X, image: faceImages.left },
        { target: gl.TEXTURE_CUBE_MAP_POSITIVE_Y, image: faceImages.top },
        { target: gl.TEXTURE_CUBE_MAP_NEGATIVE_Y, image: faceImages.bottom },
        { target: gl.TEXTURE_CUBE_MAP_POSITIVE_Z, image: faceImages.front },
        { target: gl.TEXTURE_CUBE_MAP_NEGATIVE_Z, image: faceImages.back }
    ];
    
    faces.forEach(face => {
        gl.texImage2D(
            face.target,
            0,
            gl.RGBA,
            gl.RGBA,
            gl.UNSIGNED_BYTE,
            face.image
        );
    });
    
    // è®¾ç½®å‚æ•°
    gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
    
    return cubemap;
}

// åŠ è½½ç«‹æ–¹ä½“è´´å›¾
async function loadCubemap(gl, basePath) {
    const faceNames = ['right', 'left', 'top', 'bottom', 'front', 'back'];
    const images = {};
    
    await Promise.all(faceNames.map(async (name) => {
        const image = new Image();
        image.crossOrigin = 'anonymous';
        
        await new Promise((resolve, reject) => {
            image.onload = resolve;
            image.onerror = reject;
            image.src = `${basePath}/${name}.jpg`;
        });
        
        images[name] = image;
    }));
    
    return createCubemap(gl, images);
}
```

### 5.8.3 ä½¿ç”¨ç«‹æ–¹ä½“è´´å›¾

```glsl
// å¤©ç©ºç›’é¡¶ç‚¹ç€è‰²å™¨
attribute vec3 a_position;

uniform mat4 u_viewProjectionMatrix;

varying vec3 v_texCoord;

void main() {
    v_texCoord = a_position;  // ä½ç½®å°±æ˜¯é‡‡æ ·æ–¹å‘
    vec4 pos = u_viewProjectionMatrix * vec4(a_position, 1.0);
    gl_Position = pos.xyww;  // z = wï¼Œå§‹ç»ˆåœ¨æœ€è¿œå¤„
}

// å¤©ç©ºç›’ç‰‡æ®µç€è‰²å™¨
precision mediump float;

varying vec3 v_texCoord;
uniform samplerCube u_skybox;

void main() {
    gl_FragColor = textureCube(u_skybox, v_texCoord);
}


// ç¯å¢ƒåå°„ç€è‰²å™¨
precision mediump float;

varying vec3 v_worldPos;
varying vec3 v_normal;

uniform vec3 u_cameraPos;
uniform samplerCube u_environment;

void main() {
    vec3 I = normalize(v_worldPos - u_cameraPos);  // å…¥å°„æ–¹å‘
    vec3 R = reflect(I, normalize(v_normal));       // åå°„æ–¹å‘
    
    vec4 envColor = textureCube(u_environment, R);
    gl_FragColor = envColor;
}
```

---

## 5.9 çº¹ç†å·¥å…·ç±»å°è£…

```javascript
/**
 * çº¹ç†ç®¡ç†å™¨
 */
class TextureManager {
    constructor(gl) {
        this.gl = gl;
        this.textures = new Map();
        this.defaultTexture = this.createDefaultTexture();
    }
    
    createDefaultTexture() {
        const gl = this.gl;
        const texture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, texture);
        
        // ç²‰è‰²æ£‹ç›˜æ ¼ï¼ˆæ˜“äºè¯†åˆ«çº¹ç†é—®é¢˜ï¼‰
        const pixels = new Uint8Array([
            255, 0, 255, 255,   0, 0, 0, 255,
            0, 0, 0, 255,       255, 0, 255, 255
        ]);
        
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 2, 2, 0, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);
        
        return texture;
    }
    
    async load(url, options = {}) {
        if (this.textures.has(url)) {
            return this.textures.get(url);
        }
        
        const gl = this.gl;
        const texture = gl.createTexture();
        
        // å…ˆä½¿ç”¨é»˜è®¤çº¹ç†
        this.textures.set(url, this.defaultTexture);
        
        try {
            const image = await this.loadImage(url);
            
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
            
            // è®¾ç½®å‚æ•°
            const isPOT = this.isPowerOf2(image.width) && this.isPowerOf2(image.height);
            
            if (isPOT) {
                gl.generateMipmap(gl.TEXTURE_2D);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, 
                    options.minFilter || gl.LINEAR_MIPMAP_LINEAR);
            } else {
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, 
                    options.minFilter || gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            }
            
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, 
                options.magFilter || gl.LINEAR);
            
            if (options.wrapS) {
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, options.wrapS);
            }
            if (options.wrapT) {
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, options.wrapT);
            }
            
            this.textures.set(url, texture);
            return texture;
            
        } catch (error) {
            console.error(`åŠ è½½çº¹ç†å¤±è´¥: ${url}`, error);
            return this.defaultTexture;
        }
    }
    
    loadImage(url) {
        return new Promise((resolve, reject) => {
            const image = new Image();
            image.crossOrigin = 'anonymous';
            image.onload = () => resolve(image);
            image.onerror = reject;
            image.src = url;
        });
    }
    
    isPowerOf2(value) {
        return (value & (value - 1)) === 0;
    }
    
    bind(url, unit = 0) {
        const gl = this.gl;
        const texture = this.textures.get(url) || this.defaultTexture;
        
        gl.activeTexture(gl.TEXTURE0 + unit);
        gl.bindTexture(gl.TEXTURE_2D, texture);
        
        return unit;
    }
    
    dispose(url) {
        if (this.textures.has(url)) {
            this.gl.deleteTexture(this.textures.get(url));
            this.textures.delete(url);
        }
    }
    
    disposeAll() {
        for (const texture of this.textures.values()) {
            this.gl.deleteTexture(texture);
        }
        this.textures.clear();
    }
}

// ä½¿ç”¨
const textureManager = new TextureManager(gl);

// åŠ è½½çº¹ç†
await textureManager.load('/textures/diffuse.jpg');
await textureManager.load('/textures/normal.jpg');

// æ¸²æŸ“æ—¶ç»‘å®š
const diffuseUnit = textureManager.bind('/textures/diffuse.jpg', 0);
const normalUnit = textureManager.bind('/textures/normal.jpg', 1);

gl.uniform1i(diffuseLocation, diffuseUnit);
gl.uniform1i(normalLocation, normalUnit);
```

---

## 5.10 æœ¬ç« å°ç»“

### æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| **çº¹ç†** | GPU æ˜¾å­˜ä¸­çš„å›¾åƒæ•°æ® |
| **çº¹ç†åæ ‡(UV)** | æŒ‡å®šé‡‡æ ·ä½ç½®ï¼ŒèŒƒå›´é€šå¸¸ [0,1] |
| **ç¯ç»•æ¨¡å¼** | UV è¶…å‡ºèŒƒå›´æ—¶çš„è¡Œä¸º |
| **è¿‡æ»¤æ¨¡å¼** | çº¹ç†æ”¾å¤§/ç¼©å°æ—¶çš„é‡‡æ ·æ–¹å¼ |
| **Mipmap** | é¢„è®¡ç®—çš„å¤šçº§ç¼©å°çº¹ç† |
| **çº¹ç†å•å…ƒ** | å…è®¸åŒæ—¶ä½¿ç”¨å¤šä¸ªçº¹ç† |
| **ç«‹æ–¹ä½“è´´å›¾** | 6 é¢çº¹ç†ï¼Œç”¨äºç¯å¢ƒæ˜ å°„ |

### å…³é”® API

| API | ä½œç”¨ |
|-----|------|
| `createTexture()` | åˆ›å»ºçº¹ç†å¯¹è±¡ |
| `bindTexture()` | ç»‘å®šçº¹ç† |
| `texImage2D()` | ä¸Šä¼ å›¾åƒæ•°æ® |
| `texParameteri()` | è®¾ç½®çº¹ç†å‚æ•° |
| `generateMipmap()` | ç”Ÿæˆ Mipmap |
| `activeTexture()` | æ¿€æ´»çº¹ç†å•å…ƒ |
| `texture2D()` | ç€è‰²å™¨ä¸­é‡‡æ ·çº¹ç† |

---

## 5.11 ç»ƒä¹ é¢˜

### åŸºç¡€ç»ƒä¹ 

1. åŠ è½½ä¸€å¼ å›¾ç‰‡ä½œä¸ºçº¹ç†ï¼Œè´´åˆ°çŸ©å½¢ä¸Š

2. å°è¯•ä¸åŒçš„ç¯ç»•æ¨¡å¼å’Œè¿‡æ»¤æ¨¡å¼ï¼Œè§‚å¯Ÿæ•ˆæœ

3. åœ¨ä¸€ä¸ªç‰©ä½“ä¸Šä½¿ç”¨å¤šä¸ªçº¹ç†ï¼ˆæ¼«åå°„ + æ³•çº¿ï¼‰

### è¿›é˜¶ç»ƒä¹ 

4. å®ç°è§†é¢‘çº¹ç†ï¼ˆæ¯å¸§æ›´æ–°ï¼‰

5. åˆ›å»ºç¨‹åºåŒ–çº¹ç†ï¼ˆæ£‹ç›˜æ ¼ã€å™ªå£°ç­‰ï¼‰

### æŒ‘æˆ˜ç»ƒä¹ 

6. å®ç°å¤©ç©ºç›’å’Œç¯å¢ƒåå°„æ•ˆæœ

---

**ä¸‹ä¸€ç« é¢„å‘Š**ï¼šåœ¨ç¬¬6ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ çŸ©é˜µå˜æ¢å’Œç›¸æœºç³»ç»Ÿï¼Œå®ç°å®Œæ•´çš„ 3D åœºæ™¯ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**å­—æ•°ç»Ÿè®¡**ï¼šçº¦ 12,000 å­—  
**ä»£ç ç¤ºä¾‹**ï¼š35+ ä¸ª
