# 第 4 章 文件管理

## 文件系统基础

### 文件的基本概念


1. **文件的定义**

- 数据项（理解为属性）
- 记录（理解为对象）
- 文件。有结构（含有若干记录对象） 无结构（字符流）


2. **文件的属性**

- 名称。文件名称唯 一，以容易读取的形式保存。
- 类型。被 支持不同 类型的 文件系统所使用 。
- 创建者。文件创建者的ID。
- 所有者。文件当前所有者的ID。
- 位置。指向设备和设备上文件的指针。
- 大小。文件当前大小(用字节、字或块表示)，也可包含文件允许的最大值。
- 保护。对文件进行保护的访问控制信息。
- 创建时间、最后 一次修改时间和最后一次存取时间。文件创建、上次修改和上次访问的 相关信息，用于保护和跟踪文件的使用。

3. **文件的分类**

1）按用途分类

   1）系统文件
   （2）用户文件
   （3）库文件

   2）按文件中数据的形式分类

   （1）源文件 由 ASCII 码或汉子构成
   （2）目标文件 把源程序编译后 且未经过链接的目标代码所构成文件
   （3）可执行文件
   
   3）按存取控制属性分类

   （1）只执行文件
   （2）只读文件
   （3）读写文件

   3）按组织形式和处理方式分类

   （1）普通文件
   （2）目录文件
   （3）特殊文件


### 文件控制块和索引节点

与进程管理一样，为便 于文件管理，引入了文件控制块的数据 结构

1. **文件控制块**
  
文件控制块(File Control Block，FCB)是用来存放控制文件需要的各种信息的数据结构，以实现按名存取。
文件与FCB一一对应，FCB的有序集合称为*文件目录*，一个FCB就是一个文件*目录项*。通常，一个文件目录也被视为一个文件，称为目录文件。每当创建一个新文件，系统就要为其建立一个FCB，用来记录文件的各种属性

| 文件名 |
| ----- |
| 类型 |
| 文件权限（读写） |
| 文件大小|
| 文件数据块指针 |

FCB 主要包含以下信息:

- 基本信息，如文件名、文件的物理位置、文件的逻辑结构、文件的物理结构等。
- 存取控制信息，包括文件主的存取权限、核准用户的存取权限以及一般用户的存取权限。
- 使用信息，如文件建立时间、上次修改时间等。

2. **索引节点**

在检索目录的过程中，只用到了文件名，仅当找到一个目录项(其中的文件名与要查找的文件名匹配时），才需从该目录项中读出该文件的物理地址。也就是说，在检索目录时，文件的其他描述信息不会用到，也不需要调入内存。

因此，采用文件名和文件描述信息分离的方法，使文件描述信息单独形成一个称为*索引节点*的数据结构，简称*i节点(inode)*。在文件目录中的每个目录项仅由文件名和相应的索引节点号(或索引节点指针)构成。

（1）磁盘索引节点

是指存放在磁盘上的索引节点。每个文件有一个唯一的磁盘索引节点，主要包括以下内容:

- *文件主标识符*，拥有该文件的个人或小组的标识符。
- *文件类型*，包括普通文件、目录文件或特别文件。
- *文件存取权限*，各类用户对该文件的存取权限。
- *文件物理地址*，每个索引节点中含有13个地址项，即iaddr(O)~iaddr(12)，它们以直接或
间接方式给出数据文件所在盘块的编号(见4.1.6节)。
- *文件长度，*指以字节单位的文件长度。
- *文件链接计数*，在本文件系统中所有指向该文件的文件名的指针计数。
- *文件存取时间*，本文件最近被进程存取、修改的时间及索引节点最近被修改的时间

（2）内存索引节点

是指存放在内存中的索引节点。当文件被打开时，要将磁盘索引节点复制到内存的索引节点 中，便于以后使用。在内存索引节点中增加了以下内容:

- 索引节点号，用于标识内存索引节点。
- 状态，指示i节点是否上锁或被修改。
- 访问计数，每当有一进程要访问此i节点时，计数加1:访问结束减1。
- 逻辑设备号，文件所属文件系统的逻辑设备号。
- 链接指针，设置分别指向空闲链表和散列队列的指针。


### 文件的基本操作

1. **文件的基本操作**
   
- 创建文件。创建文件有两个必要步骤:一是新文件分配外存空间;二是在目录中为之创建一个目录项，目录项记录了新文件名、文件在外存中的地址等信息。

- 删除文件。为了删除文件，根据文件名查找目录，删除指定文件对应的目录项和文件控制块，然后回收该文件所占用的存储空间(包括磁盘空间和内存缓冲区)。
  
- 读文件。为了读文件，根据文件名查找目录，找到指定文件的目录项后，从中得到被读文件在外存中的地址;在目录项中，还有一个指针用于对文件进行读操作。

- 写文件。为了写文件，根据文件名查找目录，找到指定文件的目录项后，再利用目录项中的写指针对文件进行写操作。每当发生写操作时，便更新写指针


2. **文件的打开与关闭**

> 文件的打开过程（2014）

当用户对一个文件实施多次读/写等操作时，每次都要从检索目录开始。为了避免多次重复地检索目录，大多数操作系统要求，当用户首次对某文件发出操作请求时，须先利用系统调用open将该文件打开。系统维护一个包含所有打开文件信息的表，称为*打开文件表*。所谓“打开”，是指系统检索到指定文件的目录项后，将该目录项从外存复制到内存中的打开文件表的一个表目中，并将该表目的*索引号(也称文件描述符)*返回给用户。当用户再次对该文件发出操作请求时，可通过文件描述符在打开文件表中查找到文件信息，从而节省了大量的检索开销。当文件不再使用时，可利用系统调用close关闭它，则系统将会从打开文件表中删除这一表目。

> 多进程同时打开文件的分析 (2017、2020)
> 文件关闭的过程 (2023)

在多个进程可以同时打开文件的操作系统中，通常采用两级表:整个系统表每个进程表。*整个系统的打开文件*表包含与进程无关的信息，如文件在磁盘上的位置、访问日期和文件大小。*每个进程的打开文件表*保存的是进程对文件的使用信息，如文件的当前读写措针、文件访问权限，并包含指向系统表中适当条目的指针。

一旦有进程打开了一个文件，系统表就包含该文件的条目。当另一个进程执行调用open时，只不过是在其打开文件表中增加一个条目，并指向系统表的相应条目。通常，系统打开文件表为每个文件关联一个*打开计数器(OpenCount)*，以记录多少进程打开了该文件。当文件不再使用时，利用系统调用close关闭它，会删除单个进程的打开文件表中的相应条目，系统表中的相应打开计数器也会递减。当打开计数器为0时，表示该文件不再被使用，并且可从系统表中删除相应条目

> 文件名和文件描述符的应用场景 (2012、2017、2024)

文件名不必是打开文件表的一部分，因为一旦完成对FCB在磁盘上的定位，系统就不再使用文件名。对于访问打开文件表的索引号，UNIX称之为文件描述符，而Windows称之为文件句柄。因此，只要文件未被关闭，所有文件操作都是通过文件描述符(不是文件名)来进行。

**note:** 只要完成了文件打开open()系统调用，后面再使用read()、Write()、Lseek()、close()等文件 操作的系统调用，就不再使用文件名，而使用文件描述符。该考点已反复考过多次。

每个打开文件都具有如下关联信息:

- *文件指针*。系统跟踪上次的读写位置作为当前文件位置的指针，这种指针对打开文件的某个进程来说是唯一的，因此必须与磁盘文件属性分开保存。

- *文件打开计数*。计数器跟踪当前文件打开和关闭的数量。因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件。

- *文件磁盘位置*。大多数文件操作要求系统修改文件数据。查找磁盘上的文件所需的信息保存在内存中，以便系统不必为每个操作都从磁盘上读取该信息。

- *访问权限*。每个进程打开文件都需要有一个访问模式(创建、只读、读写、添加等)。该信息保存在进程的打开文件表中，以便操作系统能够允许或拒绝后续的1/O请求。



将目录项中的信息复制到内存中的打开文件表中，并将打开文件表的索引号返回给用户
打开文件之后，对文件的操作不再需要每次查询目录，可以根据内存中的打开文件表进行操作
每个进程都有自己的打开文件表，系统中也有一张总的打开文件表
进程打开文件表中的属性：读写指针、访问权限（只读 只写）
系统打开文件表中的特有属性：打开计数器（有多少个进程打开了该文件）

关闭文件（close 系统调用）
将进程打开文件表中的相应表项删除
系统打开文件表的打开计数器-1 若打开计数器为 0，则删除系统表的表项

读文件
根据读指针、读入数据量、内存位置将文件数据从外存读入内存
写文件：根据写指针，写出数据，内存位置将文件数据从内存写出外存

   

#### 文件系统的层次结构

![46](./img/文件系统模型.png)

#### 文件操作

1. 最基本的文件操作
   （1）创建文件
   （2）删除文件
   （3）读文件
   （4）写文件
   （5）设置文件的读/写位置
2. 文件的“打开”和“关闭”操作
   每次用户对文件的读写，都要从检索目录开始，为了避免重复检索，引入“open”文件系统调用，将指定文件的属性从外存拷贝到内存打开文件表的一个表目中，可通过“关闭”系统调用来关闭此文件
3. 其它文件操作

## 文件的逻辑结构

#### 文件逻辑结构的类型

1. 按文件是否有结构分类
   1）有结构文件
   由一个个的记录项组成，也称为记录文件
   （1）定长记录
   （2）变长记录
   2）无结构文件
   在系统中运行的大量的源程序、可执行文件、库函数等，都是无结构的文件形式，即流式文件。其文件的长度是以字节为单位的。对它的访问，则是利用读、写指针指出下一个要访问的字符
2. 按文件的组织方式分类
   把有结构的文件分为三类：
   （1）顺序文件
   （2）索引文件
   （3）索引顺序文件

#### 顺序文件

1. 顺序文件的排列方式
   （1）串结构。按存入**时间**的先后进行排序，各记录之间的顺序与关键字无关
   （2）顺序结构 由关键字指定顺序排列
2. 顺序文件的优缺点
   优点：在进行批量存取，顺序文件的效率最高
   缺点：查找单个记录性能很差，增加或删除困难

   定长记录的顺序文件，若物理上采用顺序存储，则可实现随机存取。

#### 记录寻址

1. 隐式寻址方式
2. 显式寻址方式
   （1）通过文件中记录的位置
   （2）利用关键字

#### 索引文件

1. 按关键字建立索引
2. 具有多个索引表的索引文件
   索引表本身就是定长记录的顺序文件，一个索引表项就是一条定长记录，支持随机存取

#### 索引顺序文件

1. 索引顺序文件的特征
   索引文件和顺序文件的结合
2. 一级索引顺序文件
3. 两级索引顺序文件

#### 直接文件和哈希文件

1. 直接文件
   根据给定的关键字直接获得指定记录的物理地址，（关键字本身决定了记录的物理地址），这种由关键字到记录物理地址的转换称为键值转换
2. 哈希文件
   利用 hash 函数可将关键字转换为相应记录的地址

## 文件目录

#### 文件控制块和索引结点

1. 文件控制块 FCB
   实现文件名和文件之间的映射，以实现按名存取
   1）基本信息
   文件名 文件物理地址 文件逻辑结构（流还是记录） 文件的物理结构（顺序文件、链接式文件 索引文件）
   2）存取控制信息类
   包括文件的存取权限、核准用户的存取权限一级一般用户的存取权限
   3）使用信息类
   建立时间、修改时间、当前使用信息、打开该文件的进程数、是否被其它进程锁住，在内存中是否被修改
2. 索引结点
   1）索引结点的引入
   文件名和文件信息拆开
   检索过程中只使用到了文件名
   2）磁盘索引结点
   存放在磁盘上的索引结点。包括以下：
   文件标识符、文件类型、文件存取权限、文件物理地址、文件长度、文件连接计数、文件存取时间
   3）内存索引结点
   存放在内存中的索引结点。当文件被打开时，要将磁盘索引结点拷贝到内存的索引结点中
   索引结点编号 状态（是否上锁）访问计数 文件所属文件系统的逻辑设备号 链接指针

#### 简单的文件目录

1. 单级文件目录
   不允文件重名
2. 两级文件目录
   主文件目录 和 用户文件目录
   允许不同用户的文件重名
   不允许对文件进行分类
   ![47](./img/文件目录.png)

#### 树形结构目录（多级目录结构）

1. 树形目录
   ![48](./img/多级目录结构.png)
   方框代表目录文件，圆圈代表文件
2. 路径名和当前目录
   1）路径名
   /B/F/J
   2）当前目录
   为每个进程设置一个“当前目录”，又称为“工作目录”。进程对各文件的访问都相对于“当前目录”而进行。
   从当前目录开始的路径名称为相对路径名
   从树根开始的路径名称为绝对路径名
3. 目录操作
   （1）创建目录
   （2）删除目录
   （3）改变目录
   （4）移动目录
   （5）链接操作
   （6）查找

#### 目录查询技术

当用户要访问一个已存文件时，系统首先利用用户提供的文件名对目录进行查询。找过该文件的文件控制块或对应索引结点。然后根据 FCB 或索引结点中的记录的文件物理地址（盘块号），换算出文件在磁盘上的物理位置。最后根据磁盘驱动程序将所需文件读入内存。

1. 线性检索法（顺序检索法）
   ![49](./img/线性目录检索.png)
2. hash 方法
   建立 hash 索引文件目录，系统利用用户提供的文件名，并将它变换为文件目录的索引值，再利用该索引值到目录中去查找
   如果使用了通配符“ \* ？ ”便无法通过 hash 检索。

## 文件共享

指系统应允许多个用户共享同一份文件 ，只需保存一份文件的副本。

#### 基于有向无循环图实现文件共享

1. 有向无循环图 DAG
   树形结构目录不适合文件共享。
   ![50](./img/有向无循环图目录层次.png)
2. 利用索引结点（硬链接）
   索引结点：文件目录瘦身策略，由于检索文件时只需要用到文件名，因此可以将除文件名之外的信息放到索引结点中，这样子目录项就只包含文件名、索引结点指针
   索引结点中设置一个链接计数变量，用于表示本索引结点上的用户目录项数
   利用索引结点，将文件的物理地址及其它的文件属性等信息，不再放在目录项中，而是放在索引结点中。在文件目录中只设置文件名及其指向相应索引结点的指针。在索引结点中还应有一个链接计数，表示链接到本索引结点上的用户目录项的数目。

#### 利用符号链接实现文件共享（软连接）

如 win 的快捷方式

1. 利用符号链接的基本思想
   基本思想：允许一个文件或子目录有多个父目录，但起哄仅有一个作为主父目录，其它几个父目录都是通过符号链接方式与之相链接的
2. 如何利用符号链实现共享
3. 利用符号链实现共享的优点
   只有文件主才拥有指向其索引结点的指针，而共享该文件的其它用户只有该文件的路径名，并不拥有指向其索引结点的指针。
4. 利用符号链的共享方式存在的问题
   根据文件名去访问，可能要多次地读磁盘

**文件共享总结**
硬链接：
各个用户的目录项指向同一个索引结点
索引结点需要有链接计数 count
某用户想删除文件时，只是删除该用户的目录项，且 count--
只有 count==0 时 才能真正删除文件数据和索引结点，否则会导致指针悬空

软连接（符号链接）：
在以 link 型文件中记录共享文件的存放路径（windows 快捷方式）
OS 根据路径一层层查找目录、最终找到该共享文件
即使软链接指向的共享文件已被删除、link 文件依然存在，只是通过 link 文件中的文件路径区查找共享文件会失效（找不到对应目录项）
由于用软连接的方式访问共享文件时要查询多级目录，会有多次磁盘 I/O

## 文件保护

#### 保护域

进程只能在保护域内执行操作，而且只允许进程访问它们具有“访问权”的对象。

1. 访问权
   把一个进程能对某对象执行操作的权利，称为访问权，每个访问权可以用一个有序对（对象名，权集）来表示。
2. 保护域
   为了对系统中的资源进行保护而引入了保护域的概念，简称为“域”。域是进程对一组对象访问权的集合，进程只能在指定域内执行操作，这样域也就规定了进程所能访问的对象和能执行的操作。
3. 进程和域间的静态联系
   进程和域之间 一一对应
4. 进程和域间的动态练习方式
   一对多关系

#### 访问矩阵

1. 基本的访问矩阵
   用矩阵来描述系统的访问控制，把该矩阵称为访问矩阵
   ![51](./img/访问矩阵.png)
2. 具有域切换权的访问矩阵
   为了实现进程和域之间的动态练习，应能将进程从一个保护域切换到另一个保护域
   ![52](./img/具有切换权的访问控制矩阵.png)

#### 访问矩阵的修改

1. 拷贝权
2. 所有权
3. 控制权

#### 访问矩阵的实现

1. 访问控制表
2. 访问权限表

**王道补充**
口令保护：
为文件设置一个“口令”，用户想要访问文件时需要提供口令，由系统验证口令是否正确
实现开销小，但“口令”一半存放在 FCB 或索引结点中（也就是存放在系统中）因此不太安全

加密保护：
用一个“密码”对文件加密，用户想要访问文件时，需要提供相同的“密码”才能正确的解密。
安全性高，但加密/解密需要耗费一定的时间（异或加密）

访问控制：
用一个访问控制表（ACL）记录哥哥用户（或各组用户）对文件的访问权限
对文件的访问类型可以分为：读/写/执行/删除等
实现灵活，可以实现复杂的文件保护功能
