# 前端架构与体验优化技术详解

---

## 一、Monorepo（单一代码仓库）

### 定义
将多个相关项目放在同一个Git仓库中管理的代码组织方式。

### 解决的问题
- 多站点代码重复
- 依赖版本不一致
- 跨项目协作困难

### 关键技术

#### pnpm Workspaces
包管理工具提供的多包管理功能，允许在同一仓库中管理多个子项目。
- 统一管理依赖
- 共享node_modules
- 本地包互相引用无需发布到npm

#### Turborepo
高性能的Monorepo构建系统，提供智能缓存和任务编排能力。
- 通过任务依赖图并行构建
- 缓存未变更的构建产物
- 将整体构建时间从数十分钟缩短到几分钟

### 项目应用示例
```
monorepo/
├── packages/
│   ├── shared-ui/        # 共享UI组件
│   ├── shared-utils/     # 共享工具函数
│   └── shared-sdk/       # 共享SDK
├── apps/
│   ├── main-site/        # 国内主站
│   ├── ai-community/     # AI创新社区
│   └── insmind/          # 海外站点
├── pnpm-workspace.yaml
└── turbo.json
```

---

## 二、SSR/同构（Server-Side Rendering/Isomorphic）

### 定义
在服务器端预渲染页面HTML，同时保持客户端交互能力的技术。同构指同一套代码可在服务端和客户端运行。

### 解决的问题
- SPA应用首屏白屏时间长
- SEO不友好
- 首次交互延迟高

### 技术原理
```
用户请求
    ↓
服务器接收请求
    ↓
服务器执行React/Vue代码
    ↓
生成HTML字符串
    ↓
返回完整HTML给浏览器
    ↓
浏览器渲染HTML（用户可见）
    ↓
下载JS bundle
    ↓
Hydration（注水：绑定事件）
    ↓
页面可交互
```

### 关键指标
| 指标 | 说明 | 目标值 |
|------|------|--------|
| TTFB | 首字节时间 | ≤200ms |
| FCP | 首次内容绘制 | ≤1s |
| TTI | 可交互时间 | ≤3s |

### 适用场景
- 首屏敏感页面（模板检索、商品详情）
- SEO要求高的页面
- 首次访问用户多的页面

---

## 三、代码分割与懒加载

### 路由级代码分割（Route-based Code Splitting）

#### 定义
按照路由将应用代码拆分成多个chunk，按需加载的优化技术。

#### 解决的问题
单个bundle过大导致首次加载慢。

#### 实现方式
```javascript
// React示例
const EditorPage = React.lazy(() => import('./pages/Editor'));
const ExportPage = React.lazy(() => import('./pages/Export'));
const AIToolPage = React.lazy(() => import('./pages/AITool'));

// 路由配置
<Routes>
  <Route path="/editor" element={
    <Suspense fallback={<Loading />}>
      <EditorPage />
    </Suspense>
  } />
</Routes>
```

#### 效果
首屏JS体积从2MB降至300KB。

### 组件级懒加载
```javascript
// 重组件懒加载
const HeavyChart = React.lazy(() => import('./HeavyChart'));

// 在可视区域才加载
const LazyImage = ({ src }) => {
  const [isVisible, ref] = useIntersectionObserver();
  return (
    <div ref={ref}>
      {isVisible && <img src={src} />}
    </div>
  );
};
```

---

## 四、样式管理

### 原子化样式（Atomic CSS）

#### 定义
使用单一用途的CSS类（如`m-4`、`text-center`）来构建界面的样式方法。

#### 解决的问题
- CSS冗余
- 命名冲突
- 样式覆盖混乱

#### 代表工具
- Tailwind CSS
- UnoCSS
- Windi CSS

#### 效果
通过PurgeCSS清除未使用样式，CSS体积减少80%。

### 设计令牌（Design Tokens）

#### 定义
将设计系统中的颜色、间距、字体等设计决策抽象为变量，统一管理和复用。

#### 解决的问题
- 多站点品牌风格不一致
- 样式硬编码难以维护

#### 示例
```css
:root {
  /* 颜色令牌 */
  --color-primary: #1890ff;
  --color-secondary: #52c41a;
  --color-danger: #ff4d4f;
  
  /* 间距令牌 */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  
  /* 字体令牌 */
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-lg: 16px;
}
```

---

## 五、多级缓存

### 定义
在不同层级（浏览器、CDN、网关、应用、数据库）设置缓存，减少请求链路和响应时间。

### 缓存层级

```
用户浏览器
    ↓ [浏览器缓存：LocalStorage/SessionStorage/IndexedDB]
CDN边缘节点
    ↓ [CDN缓存：热门资源缓存1小时]
API网关
    ↓ [网关缓存：API响应缓存]
应用服务器
    ↓ [应用缓存：Redis缓存15分钟]
数据库
```

### 缓存策略

| 层级 | 缓存内容 | TTL |
|------|---------|-----|
| 浏览器 | 静态资源、用户偏好 | 长期/会话 |
| CDN | 热门模板、静态资源 | 1小时 |
| Redis | 用户项目、热点数据 | 15分钟 |
| 数据库 | 冷数据 | - |

### 缓存失效策略
- TTL过期：设置固定过期时间
- 事件失效：数据变更时主动清除
- 双写：写数据库同时写缓存

---

## 六、性能监控

### Web Vitals核心指标

| 指标 | 全称 | 说明 | 目标值 |
|------|------|------|--------|
| LCP | Largest Contentful Paint | 最大内容绘制 | ≤2.5s |
| FID | First Input Delay | 首次输入延迟 | ≤100ms |
| CLS | Cumulative Layout Shift | 累积布局偏移 | ≤0.1 |
| TTFB | Time to First Byte | 首字节时间 | ≤200ms |
| FCP | First Contentful Paint | 首次内容绘制 | ≤1.8s |

### 监控工具
- **Sentry**：错误监控与性能追踪
- **RUM（Real User Monitoring）**：真实用户体验监控
- **Lighthouse**：性能审计

### 监控代码示例
```javascript
// Web Vitals 采集
import { getLCP, getFID, getCLS } from 'web-vitals';

getLCP(metric => sendToAnalytics('LCP', metric));
getFID(metric => sendToAnalytics('FID', metric));
getCLS(metric => sendToAnalytics('CLS', metric));
```

---

## 七、资源优化

### 图片优化
- **懒加载**：进入可视区域才加载
- **预取（Prefetch）**：空闲时预加载下一页资源
- **预加载（Preload）**：提前加载关键资源
- **响应式图片**：根据设备提供不同尺寸

### 网络优化
- **Gzip/Brotli压缩**：减少传输体积
- **HTTP/2 复用**：多路复用减少连接数
- **HTTP/3 (QUIC)**：更快的连接建立

### 资源分域
```
主域名：www.example.com
静态资源：static.example.com
图片资源：img.example.com
API服务：api.example.com
```

---

## 八、前端工程化工具链

### 组件开发
- **Storybook**：组件沙箱与文档
- **Chromatic**：视觉回归测试

### 测试工具
- **Jest**：单元测试
- **Playwright/Cypress**：端到端测试

### 构建工具
- **Vite**：快速开发服务器
- **Webpack/Rollup**：生产构建
- **SWC/esbuild**：高速编译器
