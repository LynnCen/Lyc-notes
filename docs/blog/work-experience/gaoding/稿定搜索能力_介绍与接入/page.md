# 稿定搜索能力介绍与接入

## 文档概述

本文档全面介绍稿定平台各场景下的搜索能力框架、技术实现方案以及接入现状。通过本文档，您可以：

- 了解搜索系统的完整技术架构和用户旅程
- 理解搜索流程的各个阶段及其核心能力
- 掌握不同业务场景下的搜索策略配置
- 快速接入和配置搜索能力

**适用场景**：
- 模板搜索（Web & App）
- 编辑器内工具素材搜索
- 编辑器外版权素材搜索
- DAM 搜索（文件夹搜索、作品搜索）
- ART 模板及作品搜索

---

## 1. 搜索能力整体架构

### 1.1 搜索用户旅程图

搜索是一个完整的用户交互过程，从搜索前的引导，到搜索中的辅助，再到搜索后的结果呈现，每个环节都至关重要。

![搜索用户旅程图](attachments/Frame%2025.png)

> **说明**：上图展示了用户从产生搜索需求到获得满意结果的完整旅程，包括搜索前、搜索中、搜索后三个阶段的关键交互点。

### 1.2 搜索能力框架图

![搜索能力框架图](attachments/搜索能力框架图.png)

> **说明**：上图展示了搜索系统的整体能力框架，包括搜索理解、召回、排序等核心模块。

### 1.3 搜索系统核心流程

搜索系统采用经典的**理解-召回-排序**三层架构：

1. **搜索理解**：对用户输入的 Query 进行分词、同义词扩展、意图识别等处理
2. **召回（L1）**：从海量内容中快速筛选出与 Query 相关的候选内容
3. **排序（L3/L4）**：对召回结果进行精细化排序，预测用户最想要的内容

---

## 2. 模板搜索

模板搜索是稿定平台最核心的搜索场景，支持 Web 端和 App 端，涵盖搜索结果页、场景页搜索结果页等多个入口。

### 2.1 综合排序

综合排序是模板搜索的默认排序方式，通过多阶段处理，为用户提供最相关、最优质的搜索结果。

#### 2.1.1 搜索链路流程图

![搜索链路流程图](attachments/搜索链路流程图.png)

> **说明**：上图展示了从用户输入搜索词到返回最终结果的完整搜索链路，包括搜索理解、多路召回、融合排序等关键步骤。

#### 2.1.2 搜索前：引导与发现

在用户输入搜索词之前，系统通过多种方式引导用户，降低搜索门槛，提升搜索体验。

| 能力模块 | 功能说明 | 现状 | 示例 |
|---------|----------|------|------|
| **搜索底纹词** | 在搜索框内显示提示词，引导用户输入 | 已上线 | - |
| **历史搜索词** | 展示用户历史搜索记录，快速复用 | 已上线 | - |
| **搜索热词** | 基于搜索热度推荐热门搜索词 | 2023 年底下线，现已重新上线 | ![搜索热词示例](attachments/image2025-6-12_19-10-17.png) |
| **搜索发现** | 基于用户画像推荐可能感兴趣的搜索词 | 2023 年底下线 | - |
| **搜索框激活推荐** | 搜索框激活时显示推荐内容 | 已下线 | - |

**搜索热词策略**：
- 统计规则：基于搜索日志统计近 12 小时的搜索 UV（去重），英文统一大写，取 Top10
- 去重规则：同义词过滤（互相包含的词、字符串重叠占比高的词）
- 降权规则：若本次统计的搜索热词 TOP10 与上次统计有重复，对该搜索热词降权
- 更新周期：每小时更新一次

#### 2.1.3 搜索中：辅助与联想

在用户输入搜索词的过程中，系统实时提供联想词，帮助用户快速完成输入，减少输入成本。

| 能力模块 | 功能说明 | 现状 | 示例 |
|---------|----------|------|------|
| **下拉联想词** | 根据用户输入实时推荐相关搜索词 | 已上线 | ![下拉联想词示例](attachments/image2025-6-12_19-11-6.png) |
| **专题搜索** | 识别专题类搜索词，提供专题搜索结果 | 已上线 | - |
| **搜索词直达** | 特定搜索词直接跳转到指定页面 | 已上线 | - |

**下拉联想词策略**：
- 数据来源：基于用户搜索历史记录
- 排序规则：根据最近搜索次数排序
- 处理方式：目前由稿定后端处理，后续将交接给搜索侧处理

#### 2.1.4 搜索后：结果呈现与推荐

搜索完成后，系统不仅返回搜索结果，还提供相关推荐，帮助用户发现更多相关内容。

| 能力模块 | 功能说明 | 现状 |
|---------|----------|------|
| **顶部标签推荐** | 在搜索结果页顶部显示相关标签，支持快速筛选 | 已上线 |
| **Query 相关搜索词推荐** | 在搜索框下方推荐与当前搜索词相关的其他搜索词 | 瀑布流推荐 |
| **模板-相关搜索词推荐** | 基于模板内容推荐相关搜索词 | App 迭代中已移除该功能 |

#### 2.1.5 搜索理解：Query 处理与优化

搜索理解是搜索系统的核心环节，负责将用户的自然语言查询转换为系统可理解的结构化信息。

##### 2.1.5.1 敏感词过滤

在搜索理解的最前端，对用户输入的搜索词进行敏感词过滤，确保内容合规性。

**过滤策略**：
- 过滤涉及政治敏感、色情、暴力等不当内容
- 过滤后返回安全提示或推荐替代搜索词

##### 2.1.5.2 分词处理

将用户输入的搜索词切分成多个有意义的词（term），是搜索理解的基础。

**分词策略**：
- 基于 Jieba 词库或轻舟后台的分词库
- **精确模式**：试图将句子最精确地切开，适合文本分析（当前搜索词分词使用）
- **全模式**：把句子中所有可以成词的词语都扫描出来，速度非常快（当前构建搜索索引使用）

**分词词库干预**：
- 当分词分不准导致召回出问题时，可通过分词词库进行人工干预

##### 2.1.5.3 词扩展：同义词、下位词、近义词

对分词后的词进行扩展，解决用户搜索词与内容标题/标签同含义但不同表达导致内容召回不出来的问题。

![文本召回链路](attachments/文本召回链路.png)

**扩展策略**：
- **同义词扩展**：通过同义词表映射对 query 进行改写
- **下位词扩展**：扩展更具体的词，如"动物"扩展为"猫"、"狗"等
- **近义词扩展**：扩展语义相近的词
- **相关词扩展**：扩展语义相关的词

**相关优化**：
- [20250218-稿定双端文本召回词拓展范围优化]

##### 2.1.5.4 意图识别

识别用户的搜索意图，为个性化召回和排序提供支持。

**意图识别能力**：
- **个性化向量生成**：基于用户意图生成个性化向量
- **显示意图概率**：提供意图识别的置信度

**相关文档**：
- [统一意图识别召回一期-搜索向量召回](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=369876347)

##### 2.1.5.5 标签权重

对不同类型标签设置不同权重，提升搜索相关性。

![标签权重示例](attachments/image2024-7-19_17-57-17.png)

**相关文档**：
- [20220111-标签权重优化](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=196114367)

##### 2.1.5.6 主文案提取

从模板的全文案中提取主文案，提升文本匹配的准确性。

**主文案提取策略**：
- 基于大内容全文案的文本和字号，解析字号 Top2 的文本生成主文案
- 按天生成，新模板无主文案则用已有全文案

**相关文档**：
- [220317-全文案召回优化成主文案召回-[已上线]]

#### 2.1.6 召回阶段（L1）：多路召回策略

召回阶段负责从海量内容中快速筛选出与搜索词相关的候选内容。我们采用**多路召回**策略，通过不同的召回方式覆盖用户的各种需求场景。

##### 2.1.6.1 业务池召回

业务池召回是基于业务规则的内容池召回，包括热点池和新品池。

**热点池召回**：

热点池用于召回当前热点节日相关的内容，同时过滤过气热点内容。

![文本召回-新逻辑](attachments/文本召回-新逻辑.png)

**热点属性内容标签定义**：

a. **过气标签定义**：该内容标签是一个节日标签（有配置节日信息），在统计时非热点节日

b. **热点标签定义**：该内容标签是一个节日标签（有配置节日信息），在统计时为热点节日

c. **过气标签组定义**：取第一个节日标签，取出配置的热点生效时间与该标签有交集的标签，两两组合。筛选出组合后标签一个为当前热点标签，一个当前为过气标签的组合作为过气标签组

例如：标签"春节"，时间有交集的标签包括"初一"、"初二"，则生成标签组合【春节、初一】、【春节、初二】。其中初一过气，春节、初二都没过气。则过气标签组为【春节、初一】

d. **过气内容判断**：取内容当前的标签情况进行判断，符合以下任一条件，则认为该内容为过气内容，打上过气标签：
- 若内容身上无热点标签，有过气标签，则判断为过气内容
- 若内容身上有热点标签，有过气标签，有过气标签组，则判断为过气内容
- 若内容身上无热点标签，无过气标签，则判断为常规

**总结**：
- 统计日时，若内容身上无热点标签，有过气标签，无过气标签组，则判断为过气内容
- 统计日时，若内容身上有热点标签，有过气标签，有过气标签组，则判断为过气内容
- 统计日时，若内容身上有热点标签，无过气标签，则判断为热点内容
- 统计日时，若内容身上无热点标签，无过气标签，则判断为常规内容

**相关优化**：
- [「已上线」20230207-热点内容标签]
- [20250305-稿定双端针对有节日意图的搜索词不召回热点池内容]
- [20250218-稿定双端业务池召回提高相关阈值]

**新品池召回**：

新品池用于召回最近上架的新内容，确保用户能够发现最新内容。

**新品池定义**：
- 内容池 = （（当前生命周期为引入期 或 最近上架时间为近 14 天）且非过气热点 且发布状态为已发布） 或 最近上架时间为近 1 天（筛选器内的条件配置，为实时条件）

**相关优化**：
- [20250218-稿定双端业务池召回提高相关阈值]

##### 2.1.6.2 文本召回

文本召回是基于文本匹配的召回方式，通过分词、词扩展后进行完全匹配查询。

![文本召回链路](attachments/文本召回链路.png)

**文本召回流程**：

1. **Query 分词**：将搜索词切分成多个 term
2. **词扩展**：对分词结果进行同义词、下位词、近义词扩展
3. **完全匹配查询**：使用扩展后的词进行完全匹配查询
4. **BM25 排序**：根据 BM25 算法计算相关性分数

**查询逻辑示例**：

假设 Query 分词结果：A B C N

其中：
- B 下位词 = B1
- C 同义词 = C1
- C 近义词 = C2
- C 相关拓展词 = C3
- N 同义词 = N1
- N 上位词 = N2

查询逻辑：

```sql
A AND (B OR B1) AND (C OR C1 OR C2) AND (N OR N1)
```

**注意**：
- C2（近义词）不计算 BM25 分值，目的是让这几个相关性稍微差点的词组合排序在靠后
- 对搜索词分词后若为单独符号的，对符号不进行召回

**特殊处理规则**：

| 判断类型 | 本次策略 |
|---------|----------|
| 纯数字且长度 ≤ 5 | 有个性化推荐，文本召回只走正常文本匹配 |
| 纯数字且长度 > 5 且 < 10 | 没有个性化推荐，文本召回走 ID 匹配或正常文本匹配 |
| 其他情况 | 有个性化推荐，走文本匹配 |

**相关技术文档**：
- [200813 - ES 相关性之 BM25]
- [200811 - 稿定 WEB LR 预估分数权重](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=95402604)
- [201030 - 稿定 APP LR 分数预估](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=105286028)

##### 2.1.6.3 向量召回（个性化召回）

向量召回是基于深度学习的语义召回方式，能够理解用户搜索意图和内容语义，提供更精准的召回结果。

**向量召回特点**：
- 基于用户意图生成个性化向量
- 通过向量相似度计算内容相关性
- 能够召回语义相关但文本不匹配的内容

**相关文档**：
- [统一意图识别召回一期-搜索向量召回](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=369876347)

#### 2.1.7 排序阶段（L3/L4）：精细化排序

排序阶段对召回结果进行精细化排序，预测用户最想要的内容。

##### 2.1.7.1 多目标模型（L3）

多目标模型综合考虑点击、下载、付费等多个目标，预测用户对内容的偏好。

**相关文档**：
- [20241211 稿定双端-排序模型增加考虑未登录用户和投放信息优化（需 ab）]

##### 2.1.7.2 业务规则应用（L4）

在模型排序的基础上，应用业务规则进一步优化排序结果。

**VIP 置顶**：
- 针对注册超过 30 天的非会员用户，置顶 VIP 模板
- 生效人群：首次访问超过 30 天且非会员用户，判断规则使用分群 ID

**非节日意图搜索词打压**：
- 只对非节日意图的搜索词，打压部分有时效性标签组的内容
- 相关优化：
  - [20230220-稿定 web 搜索增加过气热点打压]
  - [20220926-搜索 app 热点过气打压]

**同套系内容当页打压**：
- 在同一页搜索结果中，对同套系内容进行打压，避免内容过于相似

#### 2.1.8 搜索结果页下方推荐模块

当搜索结果数量不足时，系统会在搜索结果页下方提供推荐模块，帮助用户发现更多相关内容。

#### 模块出现规则

该模块出现规则变更为：根据上面搜索结果链路后最终返回结果数小于 120 的情况下会出现该模块。

#### 推荐数据规则

- **个性化召回**：根据原搜索词进行个性化召回（实时计算），召回低于相关性阈值的结果。根据向量相似度从高到低排序，与顶部的搜索结果返回的结果去重后，最终返回 Top100 个作为推荐结果。
- **筛选器联动**：若用户在搜索结果页顶部有筛选行为，进行推荐时也需要同时带上筛选器 ID 作为范围条件限制。

---

### 2.2 各坑位搜索链路接入现状

除了综合排序外，模板搜索还支持其他排序方式，满足用户不同的搜索需求。

#### 2.2.1 最新上传排序

**应用场景**：模板搜索（包含 web & app：搜索结果页、场景页搜索结果页）

**召回策略**：
- **个性化召回**：同"模板-综合排序-个性化召回"逻辑，即在搜索词下根据个性化召回，在满足阈值的前提下取召回的 Top100
- **文本召回**：同"模板-综合排序-文本召回完全匹配"匹配逻辑，即词拓展 + 且召回，根据"最新排序时间"取 Top700

**排序逻辑**：将（个性化召回 + 文本召回）一起，根据"最新排序时间"进行排序，最新的排在前面

#### 2.2.2 最多下载排序

**应用场景**：模板搜索（包含 web & app：搜索结果页、场景页搜索结果页）

**召回策略**：
- **个性化召回**：同"模板-综合排序-个性化召回"逻辑，即在搜索词下根据个性化召回，在满足阈值的前提下取召回的 Top100
- **文本召回**：同"模板-综合排序-文本召回完全匹配"逻辑，即词拓展 + 且召回，根据 LR 分取 Top700

**排序逻辑**：将（个性化召回 + 文本召回）一起，根据"下载次数"进行排序

---

## 3. 编辑器内工具素材搜索

编辑器内工具素材搜索是指在编辑器中使用素材搜索功能，帮助用户快速找到合适的素材。

![工具素材搜索](attachments/工具素材搜索.png)

**核心特点**：
- 文本召回可匹配的内容和稿定模板一致，非核心 term
- 已接入花瓣素材算法模型

**相关文档**：
- [20241105 稿定双端编辑器内素材搜索接入花瓣素材算法模型（需 ab）]

---

## 4. 编辑器外版权素材搜索

编辑器外版权素材搜索是指用户在编辑器外部搜索版权素材，这些素材来自花瓣平台。

### 4.1 搜索架构

编辑器外版权素材搜索采用花瓣融合二期的架构，复用花瓣的搜索能力。

| 层 | 说明 |
|---|------|
| **召回** | 文本且召回（LR）：取核心 term，取花瓣的 LR 模型和数据进行召回 |
| **排序** | 取花瓣某个版本的模型（还未有多目标），特征都取花瓣侧特征，大概率只有内容侧特征可使用 |
| **干预** | 支持流量池、排序结果干预等 |

**相关文档**：
- [花瓣融合二期](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=378306920)

---

## 5. DAM 搜索

DAM（Digital Asset Management）搜索是指对用户自己的数字资产进行搜索，包括文件夹搜索和作品搜索。

### 5.1 文件夹搜索

**匹配范围**：文件夹名称

**召回逻辑**：在用户有的权限范围内，通过搜索词进行文本召回的模糊搜索（`LIKE '%xxx%'`）

**排序逻辑**：根据当前支持的业务规则进行排序（包括添加时间、修改时间、文件大小、文件名称）

### 5.2 作品搜索

**匹配范围**：
- 作品标题（4 分）
- 用户打的标签（不算分）
- AI 标签（不算分，用旧的 AI 视觉模型打标）
- 作品的文字（不区分是否主文案，需要编辑器能识别的文字，比如图片上的文字就不支持）

**召回逻辑**：在用户有的权限范围内
1. 搜索词进行分词，通过词库扩展对应的同义词、近义词
2. 进行或召回匹配召回

**排序逻辑**：根据当前支持的业务规则进行排序（包括添加时间、修改时间、文件大小、文件名称）

---

## 6. ART 模板及作品搜索

ART 是稿定平台的 AI 创作社区，支持 AI 模板和 AI 作品的搜索。

### 6.1 AI 模板搜索能力支持

#### 6.1.1 综合排序

**搜索词匹配范围**：包含 AI 模板的标题、标签、分类、话题

**召回及排序逻辑**：
- 分词逻辑 & 词拓展逻辑同稿定模板搜索，完全匹配召回
- 排序分计算：参考稿定的文本召回逻辑（[200811 - 稿定 WEB LR 预估分数权重](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=95402604)），暂定排序分 = 1 × BM25 值 + 4 × 热度分

#### 6.1.2 最新上传

**搜索词匹配范围 & 分词逻辑 & 词拓展逻辑 & 完全匹配召回逻辑**：同综合排序

**排序逻辑**：根据 AI 模板的最新排序时间从近到远排

### 6.2 AI 作品搜索能力支持

#### 6.2.1 综合排序

**搜索词匹配范围**：包含 AI 作品的标签、分类、作品标题（即作品的 prompt）

**召回及排序逻辑**：基本同 AI 模板搜索综合排序能力，有以下两处逻辑不同：
- 对应热度分使用的是 AI 作品的热度分
- 文本匹配时若匹配到的是作品标题，则该类型字段不计算 BM25 分

#### 6.2.2 最新上传

**搜索词匹配范围 & 分词逻辑 & 词拓展逻辑 & 完全匹配召回逻辑**：同综合排序

**排序逻辑**：根据作品的最新排序时间从近到远排

---

## 7. 搜索系统接入指南

### 7.1 接入流程

接入搜索能力需要按照以下步骤进行：

1. **确定业务场景**：明确需要接入搜索能力的业务场景（模板搜索、素材搜索、DAM 搜索等）
2. **选择搜索策略**：根据业务场景选择合适的搜索理解、召回、排序策略
3. **配置参数**：在轻舟后台配置相应的搜索参数
4. **测试验证**：进行功能测试和效果验证
5. **上线监控**：上线后持续监控搜索效果，根据数据反馈优化策略

### 7.2 配置后台

- **轻舟后台**：搜索策略配置、分词词库管理、同义词库管理、人群标签配置
- **排序结果干预后台**：人工干预排序结果、配置业务规则

### 7.3 注意事项

- 不同业务场景需要根据实际情况调整搜索策略
- 定期监控搜索效果，根据数据反馈持续优化
- 注意平衡搜索准确性和召回率
- 关注用户体验，避免过度干预
- 敏感词过滤是必须的，确保内容合规性

### 7.4 常见问题

**Q1：为什么搜索结果不准确？**

A：可能的原因包括：
- 分词不准确，可以通过分词词库干预解决
- 同义词扩展不足，可以通过同义词库补充
- 召回策略选择不当，需要根据业务场景调整

**Q2：如何提升搜索相关性？**

A：可以从以下几个方面优化：
- 优化分词和词扩展策略
- 调整标签权重
- 优化排序模型参数
- 应用业务规则进行重排

**Q3：如何处理新内容搜索不到的问题？**

A：新内容搜索不到可能是因为：
- 索引更新延迟，需要等待索引更新
- 内容未通过审核，需要检查内容状态
- 分词词库未包含新词，需要更新分词词库

---

## 8. 附录

### 8.1 相关技术文档链接

#### 搜索理解相关
- [统一意图识别召回一期-搜索向量召回](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=369876347)
- [20220111-标签权重优化](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=196114367)
- [220317-全文案召回优化成主文案召回-[已上线]]
- [20250218-稿定双端文本召回词拓展范围优化]

#### 召回相关
- [200813 - ES 相关性之 BM25]
- [200811 - 稿定 WEB LR 预估分数权重](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=95402604)
- [201030 - 稿定 APP LR 分数预估](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=105286028)
- [「已上线」20230207-热点内容标签]
- [20250305-稿定双端针对有节日意图的搜索词不召回热点池内容]
- [20250218-稿定双端业务池召回提高相关阈值]

#### 排序相关
- [20241211 稿定双端-排序模型增加考虑未登录用户和投放信息优化（需 ab）]
- [20230220-稿定 web 搜索增加过气热点打压]
- [20220926-搜索 app 热点过气打压]

#### 业务场景相关
- [20241105 稿定双端编辑器内素材搜索接入花瓣素材算法模型（需 ab）]
- [花瓣融合二期](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=378306920)
- [202405 稿定 web 搜索联想词上下游串联推荐]

### 8.2 术语表

| 术语 | 说明 |
|------|------|
| **Query** | 用户输入的搜索词 |
| **Term** | 分词后的词单元 |
| **召回（Recall）** | 从海量内容中筛选出与 Query 相关的候选内容 |
| **排序（Ranking）** | 对召回结果进行排序，预测用户最想要的内容 |
| **BM25** | 一种经典的文本相关性评分算法 |
| **LR** | Logistic Regression，逻辑回归模型，用于相关性评分 |
| **向量召回** | 基于深度学习的语义召回方式 |
| **文本召回** | 基于文本匹配的召回方式 |
| **业务池** | 基于业务规则的内容池，如热点池、新品池 |
| **过气热点** | 已过时的热点内容标签 |
| **主文案** | 模板中字号最大的文本内容 |

### 8.3 搜索链路关键节点说明

#### L1 召回层
- **热点池召回**：召回当前热点节日相关的内容
- **新品池召回**：召回最近上架的新内容
- **文本召回**：基于文本匹配的召回
- **向量召回**：基于语义理解的召回

#### L3 排序层
- **多目标模型**：综合考虑点击、下载、付费等多个目标

#### L4 重排层
- **VIP 置顶**：针对特定用户群体置顶 VIP 内容
- **过气热点打压**：对过时热点内容进行降权
- **同套系内容打压**：避免同一页内容过于相似

### 8.4 文档更新记录

| 版本 | 操作 | 修订内容 | 修订日期 | 修订人 |
|------|------|----------|---------|--------|
| 2.0 | 重构 | 重新梳理文档结构，完善内容，引入图片 | 2025-01-14 | - |
| 1.0 | 新增 | 稿定搜索能力介绍初版 | 2025-06-12 | - |

---

**文档维护**：搜索算法团队  
**最后更新**：2025-01-14  
**文档版本**：2.0
