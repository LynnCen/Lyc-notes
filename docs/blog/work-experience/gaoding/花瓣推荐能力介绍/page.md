# 花瓣推荐能力介绍

## 1. 推荐能力框架图

![推荐能力框架图](./attachments/花瓣推荐策略框架.png)

## 2. 推荐能力详细介绍

### 2.1 发现页

![发现页推荐流程图](./attachments/发现页推荐流程图.png)

#### 内容基础

- **阶段划分**：冷启、稳态、淘汰阶段
- **相关优化**：
  - 20250721 发现页增加阶梯式分发策略一期（需ab）
  - 20250928 发现页增加阶梯式分发策略二期-优化当前晋级淘汰规则及优先保障近期新内容分发的比例（需ab）
- **赛马三期**：[详细文档](https://alidocs.dingtalk.com/i/nodes/P7QG4Yx2Jp7xZ4GZh1ZZdGB7V9dEq3XD)

#### 过滤

**全局过滤逻辑**：
- 状态为淘汰
- 敏感标签（美女等）
- AIGC内容
- 长图内容
- 过气内容
- 下架内容

**个性化过滤逻辑**：
- 用户采集过、下载过内容
- 近3天曝光内容
- 近7天曝光过次数大于2次的
- 负反馈过滤及其相似等的过滤

**特殊规则**：
- 请求结果数在1000以后，每个召回路过滤前置推荐给用户的1000结果里的内容，再次重走链路
- AI社区内容：实时过滤累计屏蔽&举报大于等于2的内容
- 过滤用户屏蔽举报向量的相似内容
- 20250822 发现页top1000以后的内容增加个性化逻辑（需ab）

#### 召回

**召回策略**：

| 召回类型 | 说明 | 相关优化 |
|---------|------|---------|
| 冷启-实时多目标 | 近7天，7-2个月，2个月后 | 20250623 发现页召回离线dssm替换为实时多目标召回（需ab） |
| 稳态-实时多目标 | - | - |
| 稳态-实时多目标common | - | - |
| 近期i2i | [详细文档](https://alidocs.dingtalk.com/i/nodes/YQBnd5ExVEwjpePpCbdLXevg8yeZqMmz?corpId=) | - |
| 关注链召回 | - | 20250701 发现页关注链召回优化&前端交互优化&默认跳转逻辑优化（需ab） |
| 热度召回/补余 | - | - |
| 业务池召回 | 随机召回 | - |
| 扶持分重排 | - | 20250521 发现页i2i召回优化及增加扶持分应用（需ab）<br>20250721 发现页增加阶梯式分发策略一期（需ab） |

#### 精排

- **多目标**：点击、采集、下载
- **模型**：花瓣发现页(推荐)多目标精排模型v4
- **相关优化**：20251009 发现页排序模型优化——增加用户长周期序列行为（需ab）

#### 重排

**L4分**：
- 包含点击、采集、下载、扶持分，进行计算
- 相关优化：20250521 发现页i2i召回优化及增加扶持分应用（需ab）

**混排比例**：
- 素材关注链召回的混排比例固定为5%
- 素材冷启阶段-实时多目标5%
- 灵感冷启阶段近7天-实时多目标5%
- 冷启阶段7-2个月-实时多目标5%
- 冷启阶段2个月前-实时多目标5%
- 素材其他召回路（除去前面说的两路）召回的为15%
- 其他灵感算法池兜底

**针对每桶的限制**：
1. 近1个小时行为i2i保障在每一桶内的前五个内容里至少有一个
2. 非冷启用户，灵感关注链保障在每一桶内至少有一个内容
   - [详细文档](https://alidocs.dingtalk.com/i/nodes/7NkDwLng8ZMaB7ZBCeNRnbLNJKMEvZBY)

**同源限制**：
- 每40个相邻内容（滑动窗口）中同一个用户不得超过了3个，若超过则顺延往后排。该策略只对灵感生效，素材内容暂不做该逻辑限制。
- 每40个相邻内容（滑动窗口）中关注链内容来自同一个画板/来源不得超过了3个，若超过则顺延往后排。该策略只对灵感生效，素材内容暂不做该逻辑限制。
- 相关优化：20250701 发现页关注链召回优化&前端交互优化&默认跳转逻辑优化（需ab）

#### 刷新规则

**刷新后取结果规则**：
- 每次刷新取下一页结果
- 第二天重置重新从第一页开始请求

**当天刷新规则**：
- 当用户有实时i2i变更或刷到1000以后或距离上次请求超过10分钟，重新请求接口
- 过滤之前推荐的内容（按后端请求过给前端展示的，不是按真实曝光的），再推出1000个

> **待完善**：[WIP]发现页无限推荐详细设计

---

### 2.2 基于画板的灵感推荐

#### 推荐范围

需推荐灵感的画板范围：**包含所有画板**

#### 推荐逻辑

##### 1. 推荐池范围

仅推荐灵感即可

##### 2. 召回

**召回流程**：

1. 取画板内对应采集的file_id，取按采集时间最近的100个采集对应file_id的灵感i2v结果的top80进行返回（取web端当前的结果即可）
2. 过滤画板中采集的近500个采集
3. 按照原画板内取的这100个采集内容的采集时间由近到远，取对应每个采集内容的相似内容按照1:1:1的逻辑穿插排序，边排序边去重
4. 统计用户近3天（不含当天）在发现页和画板灵感推荐模块的该画板推荐曝光过的内容，穿插排序好的内容对这部分曝光过内容的沉底，再按照顺序截断取top2000
5. **补余逻辑**（若取的数量不足2000）：
   - 通过搜索接口（1.5改的逻辑），在画板的分类的范围内用画板名称进行搜索，根据搜索结果返回的顺序补足至2000
   - 若还是不足2000，则去掉画板分类限制进行搜索，根据搜索结果返回的顺序补足至2000（此时不限制是否是灵感）
   - 同样需要进行多取，需过滤掉在该模块曝光过内容

##### 3. 排序

调取发现页ctr接口，根据ctr进行排序

##### 4. 重排

**分档策略**（按优先级排序：一档 > 二档 > 三档 > 四档 > 五档）：

| 档位 | 说明 | 策略 |
|------|------|------|
| **第一档**（最近采的1个像的） | 取近3天（含今天）内用户在该画板最新采集的1个内容，取这个内容在召回最终结果（2000）里根据i2i召回的相似内容，过滤近3天在这个模块被曝光过的内容，按精排排序取靠前的5个结果作为一档结果 | 档内根据精排分排 |
| **第二档**（最近采的像的） | 取近3天（含今天）内用户在该画板采集的内容（也含第一档取的采集），取这些内容在召回最终结果里根据i2i召回的相似内容，过滤近3天在这个模块被曝光过的相似内容，过滤第一档取过的内容，限制每个内容根据精排分最多取top10个相似结果 | 这些相似结果再一起根据精排得分进行排序，截断40个作为二档结果 |
| **第三档**（采集的像的） | 取所有采集内容在召回最终结果里根据i2i召回的相似内容，过滤近3天在这个模块被曝光过的相似内容，过滤第一、二档取过的内容 | 根据精排得分进行混排，作为三档结果 |
| **第四档**（采集的像的且曝光过的） | 取召回2000内容里当前模块近3天曝光过的相似内容 | 档内根据精排排——解决极端情况下只有第四档和第五档，第四档需要优于第五档 |
| **第五档**（补余） | 补余的内容 | 档内根据精排分排 |

---

### 2.3 关联推荐（为你推荐）、相似素材推荐

#### 2.3.1 相似素材推荐

![相似素材推荐流程图](./attachments/相似商用素材.png)

##### 过滤

- 过滤拍信内容
- 过滤源内容
- 部分场景下业务方会带筛选器进行请求（部分类型用户不支持部分类型的内容，比如大企业用户等）
- 实时过滤由于审核&屏蔽状态被淘汰内容
- **相关优化**：
  - 20250514 花瓣相似商用素材过滤拍信内容
  - 相似商用素材-支持针对特殊用户限制召回范围

##### 召回

**召回策略**：

| 召回类型 | 说明 | 相关优化 |
|---------|------|---------|
| **素材-i2v** | - | - |
| **素材-实时多目标召回** | 取（源内容id+用户id）进行实时多模态向量生成，根据生成的向量，与算法提供的素材向量推荐池进行匹配，实时计算相似度<br>传入该用户当天的近5个搜索词及近16个点击或采集对应的fileid | 基于实时特征的多目标召回（需ab） |
| **素材-图搜召回** | 候选集：按照热度分，素材候选集扩充到2亿，灵感候选集扩充到2亿（不受热度分阈值限制）。后续每天增量更新（增量更新规则：取近x天创建的内容且可被搜索/上架状态，按热度分排取topx）<br>召回时有召回阈值 | 20250414 花瓣相似采集&相似素材推荐图搜路召回模型升级（需ab）<br>20240426 相似商用素材-花瓣素材ai图像相似缓存结果增加更新规则（切换新图搜后暂停了） |
| **素材-同在画板** | 具体策略 | - |

##### 精排（和为你推荐共用模型）

- **多目标**：包含点击（和采集）和下载
- **特殊场景**：若无fileid（图搜场景点击进入相似素材tab），或带有fileid但是同时带有内容范围筛选器（比如大企业用户场景），则仅进行图搜召回，不过ctr模型，根据相似度的分值进行排序
- **支持特征**：
  - 支持搜索、点击采集的实时特征
  - 支持当前搜索词、近一个跳转内容的实时上下文特征
- **相关优化**：
  - 20240305-花瓣-相似商用素材排序模型优化&排序分优化（需ab）
  - 20240109-花瓣-商用素材特殊用户ai图搜召回链路优化及对部分特殊用户相似商用素材推荐不过ctr模型
  - 20250826 花瓣采集详情页-为你推荐&相似商用素材增加排序优化及缓存优化（需ab）
  - 花瓣详情页为你推荐&相似素材模块排序增加实时上下文特征（需ab）

##### 重排

- **会员老客对视觉中国降权**
  - 相关优化：20241028 花瓣-相似商用素材模块针对会员老客对视觉中国素材进行降权（需ab）

##### 特殊处理

- 当前视频和gif图业务前端未展示相似素材模块

---

#### 2.3.2 为你推荐

![为你推荐流程图](./attachments/为你推荐.png)

##### 过滤

实时过滤由于审核&屏蔽状态被淘汰内容

##### 召回

**召回策略**：

| 召回类型 | 说明 |
|---------|------|
| **灵感-图搜召回** | 同上素材-图搜 |
| **灵感-i2v** | - |
| **灵感-同在画板** | 同上素材-同在画板 |
| **灵感-多目标召回** | 同上素材-多目标召回 |
| **素材召回** | 取相似素材最终排序中的21-200的结果 |
| **灵感拓展召回**（140后请求） | 灵感i2v召回：取灵感的i2v召回800个结果，去除精准内容召回的内容，剩余所有i2v内容，作为拓展召回的结果<br>灵感-同在画板召回：去除需要高于源内容平均同在画板数1.5倍的要求，取灵感的同在画板召回top300，去除掉在精准召回时已经召回的内容，作为拓展结果<br>相关优化：20250820 花瓣采集详情页-为你推荐模块中尾部插入拓展类内容及为你推荐和相似素材增加同在画板召回（需ab） |

##### 精排

同相似素材用一样的模型

##### 重排

- **位置1-140**：仅展示灵感&素材的精准内容
- **位置141开始**：取剩余的精准内容和拓展内容，根据以下比例进行混排，档内根据精排分进行排序，最终截断800个内容
  - 精准内容-素材算法池：20%
  - 拓展内容-灵感算法池：10%
  - 精准内容灵感算法池：70%
- **相关优化**：20250820 花瓣采集详情页-为你推荐模块中尾部插入拓展类内容及为你推荐和相似素材增加同在画板召回（需ab）

---

### 2.4 主题页推荐（即有筛选器id限制，且无搜索词的搜索个推逻辑）

筛选器范围限制 + 热度召回 + CTR排序（走无搜索词的搜索接口逻辑）

---

### 2.5 图搜\相似采集\搜相似

![图搜\相似采集\搜相似流程图](./attachments/相似采集.png)

**图搜候选集**：
- 按照热度分，素材候选集扩充到2亿，灵感候选集扩充到2亿（不受热度分阈值限制）
- 后续每天增量更新（增量更新规则：取近x天创建的内容且可被搜索/上架状态，按热度分排取topx）
