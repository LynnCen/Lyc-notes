# 花瓣搜索能力介绍与接入

## 文档概述

本文档全面介绍花瓣平台各场景下的搜索能力框架、技术实现方案以及接入现状。通过本文档，您可以：

- 了解花瓣搜索系统的完整技术架构和用户旅程
- 理解搜索流程的各个阶段及其核心能力
- 掌握不同业务场景下的搜索策略配置
- 快速接入和配置搜索能力

**适用场景**：

- 采集搜索（灵感搜索）
- 素材搜索
- 模板搜索（复用稿定搜索接口）

**文档背景**：

搜索是花瓣网核心功能之一，近 6 成花瓣网访客会使用搜索功能，且搜索结果页访客量为花瓣网第二大访客量的页面。搜索，简单来说就是用户的搜索词（Query）与系统中的海量内容完成匹配的过程。这个过程的实现可以归纳为**搜索理解-检索召回-排序**三阶段：

1. **搜索理解与处理**：一般而言用户输入的 Query 容易存在歧义、表达不准确等问题，因此需要对用户搜索的 Query 从词法、句法、语义三个层面进行结构化解析
2. **检索召回**：对系统中存储的数据内容的理解，即把用户 query 相关的内容从数据库中筛选出来
3. **排序**：对召回的结果排序，预测用户最想要的是什么，排出最优结果并予以呈现

花瓣的搜索算法架构围绕该过程进行建设。

---

## 1. 搜索能力整体架构

### 1.1 搜索能力框架图

![搜索能力框架图](attachments/花瓣搜索策略框架.png)

> **说明**：上图展示了花瓣搜索系统的整体能力框架，包括搜索前、搜索中、搜索后三个阶段的能力模块，以及搜索理解、召回、排序等核心模块。

### 1.2 搜索链路整体流程图

![搜索链路整体流程图](attachments/搜索链路整体流程图.png)

> **说明**：上图展示了从用户输入搜索词到返回最终结果的完整搜索链路，包括搜索理解、多路召回、融合排序等关键步骤。

### 1.3 搜索系统核心流程

花瓣搜索系统采用经典的**理解-召回-排序**三层架构：

1. **搜索理解**：对用户输入的 Query 进行分词、同义词扩展、意图识别等处理
2. **召回（L1）**：从海量内容中快速筛选出与 Query 相关的候选内容
3. **排序（L3/L4）**：对召回结果进行精细化排序，预测用户最想要的内容

---

## 2. 采集搜索 & 素材搜索

采集搜索和素材搜索是花瓣平台最核心的搜索场景，支持用户搜索灵感（采集）和素材内容。

### 2.1 搜索前：引导与发现

在用户输入搜索词之前，系统通过多种方式引导用户，降低搜索门槛，提升搜索体验。

#### 2.1.1 搜索热词

搜索热词基于搜索词热度进行推荐，以达到降低用户决策提升点击率的目的。

![搜索热词示例](attachments/image2023-3-8_13-13-33.png)

**策略规则**：

- **统计规则**：算法侧通过搜索日志统计近 12 小时的搜索 UV（去重），英文统一大写，取 Top10
- **去重规则**：同义词过滤
  - 互相包含的词
  - 字符串重叠占比高的词
- **降权规则**：若本次统计的搜索热词 TOP10 与上次统计的搜索热词有重复，对该搜索热词降权
- **统计周期**：12 小时
- **更新时长**：每小时更新一次

#### 2.1.2 历史搜索词

历史搜索词展示用户历史搜索过的搜索词，帮助用户快速复用之前的搜索。

![历史搜索词示例](attachments/image2023-3-8_12-34-20.png)

**实现方式**：

- 花瓣前端处理：取用户的历史搜索词
- 界面默认展示一行的历史记录

#### 2.1.3 搜索底纹词

搜索底纹词在搜索框内显示提示词，引导用户输入。

**现状**：暂无

### 2.2 搜索中：辅助与联想

在用户输入搜索词的过程中，系统实时提供联想词，帮助用户快速完成输入，减少输入成本。

#### 2.2.1 搜索联想词

搜索联想词对用户输入 query 进行联想扩展，以减少用户搜索输入成本及输错可能。

![搜索联想词示例](attachments/image2023-3-8_11-12-55.png)

**实现方式**：

- 通过记录用户搜索的词，然后再搜索这个搜索记录
- **排序**：根据最近搜索次数排序
- **处理方式**：目前由花瓣后端处理，后续交接搜索侧处理需要维护搜索联想词的表，目前还未交接

### 2.3 搜索后：结果呈现与推荐

搜索完成后，系统不仅返回搜索结果，还提供相关推荐，帮助用户发现更多相关内容。

#### 2.3.1 搜索推荐词

搜索推荐词用于用户在搜索之后无法匹配到系统内容导致没有结果时，引导用户使用更精准的搜索词快速找到内容。

![搜索推荐词示例](attachments/image2023-3-8_12-33-40.png)

**策略规则**：

- **过滤规则**：
  - 近 90 天内搜索 UV 大于 5 且搜索结果点击大于 1 的推荐词
  - 过滤搜索敏感词
- **统计规则**：对搜索词分词，统计分词后词语共现的频率（经常出现在一起，则可以将它们组合成一个词语整体的可能性也更大）
- **排序规则**：按搜索次数倒排

### 2.4 搜索理解：Query 处理与优化

搜索理解是搜索系统的核心环节，负责将用户的自然语言查询转换为系统可理解的结构化信息。

#### 2.4.1 分词处理

将用户输入的搜索词切分成多个有意义的词（term），是搜索理解的基础。

![分词示例](attachments/image2023-3-8_14-0-52.png)

**分词策略**：

- 基于 Jieba 词库或轻舟后台的分词库形成的分词
- **精确模式**：试图将句子最精确地切开，适合文本分析（当前搜索词分词用的是精确分词模式）
- **全模式**：把句子中所有可以成词的词语都扫描出来，速度非常快，但是不能解决歧义（当前构建搜索索引用的是全分词模式）

**分词词库干预**：

- 由于分词分不准导致召回出问题时，可通过分词词库干预

**示例**：

如："手机海报"切分成"手机 海报"两个 term

#### 2.4.2 同义词扩展

对同近义表达的 query 进行语义归一的作用，解决用户搜索词与内容标题/标签同含义且不同表达导致内容召回不出来的问题。

![同义词示例](attachments/image2023-3-8_14-1-33.png)

**实现方式**：

- 通过同义词表映射对 query 进行改写
- 基于 Jieba 分词后的词，匹配轻舟后台的同义词库

### 2.5 召回阶段（L1）：多路召回策略

召回阶段负责从海量内容中快速筛选出与搜索词相关的候选内容。花瓣搜索采用**多路召回**策略，通过不同的召回方式覆盖用户的各种需求场景。

#### 2.5.1 文本召回

文本召回是基于文本匹配的召回方式，通过分词/同义词/近义词/下位词搜索理解后的文本匹配召回，并通过 LR 分数进行排序。

![文本召回排序LR分数特征及权重](attachments/image2023-3-9_14-15-18.png)

**核心特点**：

- 词库和稿定同一个词库
- 对拍信内容在召回时进行打压
- 通过 LR（逻辑回归）模型计算相关性分数

**相关优化**：

- [20241030 花瓣搜索文本召回词拓展切换为新数据源及逻辑优化（需 ab）]

#### 2.5.2 文本召回 + 业务池（引入期）

业务池召回是基于业务规则的内容池召回，用于扶持特定内容。

**实现方式**：

- 通过轻舟-流量比例管理后台进行内容范围 + 召回比例配置
- 业务池优化为根据多目标进行召回（实现方式：业务池先召回后过滤，数量不足再进行文本召回兜底补充）

#### 2.5.3 多目标召回

多目标个性化召回能够理解用户搜索意图和内容语义，提供更精准的召回结果。

**召回策略**：

灵感的多目标召回，仅对满足以下任一情况的时候才召回 240 个：

1. 用户类型为首访新客、未注册老客、会员老客（通过分群实现）
2. 搜索词为近 90 天曝光 UV 大于 20 且 PV 大于 1000，且 UVCTR 小于 xx，素材 UVCTR 小于 xx 的词（算法提供表）

对不满足以上所有场景，且搜索词是近一周的低搜词（低搜词定义为近一周搜索 PV 数排序，在 top5w 以后的词），则也召回灵感多目标向量，但只召回 120 个，融合时仍保留多目标优先于文本，融合后总数 800 个。

不符合以上情况的召回 15 个。

**相关文档**：

- [召回_多目标召回]
- [20250515 花瓣搜索召回路比例调整及业务池支持多目标召回（需 ab）]

#### 2.5.4 扶持分重排逻辑

根据扶持分进行召回重排，用于扶持特定内容。

**重排规则**：

**1. 灵感/素材-多目标召回/文本召回**

- 根据原召回规则，多召回 300 个，召回后根据扶持分进行召回重排
- 召回重排规则为：扶持分分档优先，档内根据原向量召回分/LR 分进行排序，得到最终的召回排序结果。再根据原规则取对应数量进行融合
- **分档为**：扶持程度高为一档、扶持程度中为一档，扶持程度低为一档。扶持程度高 > 中 > 低

**2. 业务池召回-文本召回**

- 对灵感和素材文本召回的内容，多召回 300 个后根据扶持分进行召回重排
- 召回重排规则为：扶持分分档优先（高 > 中 > 低），档内根据（召回分和扶持分）进行加权得到新的分数来进行排序，得到最终的召回排序结果。再根据原规则取对应数量进行融合

**相关文档**：

- [20250115 花瓣搜索采集 tab 素材比例根据策略进行动态调整（需 ab）]

### 2.6 排序阶段（L3/L4）：精细化排序

排序阶段对召回结果进行精细化排序，预测用户最想要的内容。

#### 2.6.1 多目标排序（L3）

多目标排序基于用户点击行为预估被点击、下载、付费的概率，得出用户个性化的预估得分排序结果。

**相关文档**：

- [L3:个性化排序](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=248343892)

#### 2.6.2 重排（L4）

在模型排序的基础上，应用业务规则进一步优化排序结果。

**L4 分计算**：

- 支持多目标，包括点击、采集、下载、付费、扶持分
- 对会员用户有自产内容加权的逻辑

**相关文档**：

- [20240516 花瓣搜索针对会员用户增加自产素材的排序权重]

#### 2.6.3 比例混排

不同场景下素材比例不同，通过比例混排确保推荐结果的多样性。

**比例混排规则**：

| 搜索词类型 | 素材算法池比例 |
|-----------|--------------|
| 算法提供的词中，灵感和素材 PVCTR 差值区间 [0.01,0.02) | 该搜索词若有无非会员点击下载，则比例为 15%；若有非会员点击下载，则比例为 20% |
| 算法提供的词中，灵感和素材 PVCTR 差值区间 [0.02,0.03) | 无非会员下载-15%，有非会员下载-15% |
| 算法提供的词中，灵感和素材 PVCTR 差值区间 [0.03,0.04) | 无非会员下载-5%，有非会员下载-10% |
| 算法提供的词中，灵感和素材 PVCTR 差值区间 [0.04,0.05) | 无非会员下载-5%，有非会员下载-10% |
| 算法提供的词中，灵感和素材 PVCTR 差值区间 [0.05,0.06) | 无非会员下载-5%，有非会员下载-10% |
| 算法提供的词中，灵感和素材 PVCTR 差值区间 [0.06,0.07) | 无非会员下载-5%，有非会员下载-10% |
| 算法提供的词中，灵感和素材 PVCTR 差值区间 [0.07,0.08) | 无非会员下载-5%，有非会员下载-10% |
| 算法提供的词中，灵感和素材 PVCTR 差值区间 >= 0.08 | 无非会员下载-5%，有非会员下载-10% |
| 其他情况 | 30% |

**相关文档**：

- [20250115 花瓣搜索采集 tab 素材比例根据策略进行动态调整（需 ab）]

---

## 3. 模板搜索

花瓣平台的模板搜索复用稿定模板搜索的接口，确保搜索能力的一致性。

### 3.1 搜索能力说明

**实现方式**：

- 取稿定模板搜索的接口（[02 搜索能力_介绍与接入]）
- 模型训练时会增加花瓣侧模板搜索的数据进行训练和数据统计
- 针对模板搜索接口的优化这里也会同时生效

**核心特点**：

- 与稿定模板搜索使用相同的搜索能力框架
- 支持相同的搜索理解、召回、排序策略
- 模型训练数据包含花瓣侧模板搜索数据

---

## 4. 搜索系统接入指南

### 4.1 接入流程

接入搜索能力需要按照以下步骤进行：

1. **确定业务场景**：明确需要接入搜索能力的业务场景（采集搜索、素材搜索、模板搜索等）
2. **选择搜索策略**：根据业务场景选择合适的搜索理解、召回、排序策略
3. **配置参数**：在轻舟后台配置相应的搜索参数
4. **测试验证**：进行功能测试和效果验证
5. **上线监控**：上线后持续监控搜索效果，根据数据反馈优化策略

### 4.2 配置后台

- **轻舟后台**：搜索策略配置、分词词库管理、同义词库管理、人群标签配置、流量比例管理
- **排序结果干预后台**：人工干预排序结果、配置业务规则

### 4.3 注意事项

- 不同业务场景需要根据实际情况调整搜索策略
- 定期监控搜索效果，根据数据反馈持续优化
- 注意平衡搜索准确性和召回率
- 关注用户体验，避免过度干预
- 敏感词过滤是必须的，确保内容合规性
- 模板搜索复用稿定接口，相关优化会同步生效

### 4.4 常见问题

**Q1：为什么搜索结果不准确？**

A：可能的原因包括：

- 分词不准确，可以通过分词词库干预解决
- 同义词扩展不足，可以通过同义词库补充
- 召回策略选择不当，需要根据业务场景调整

**Q2：如何提升搜索相关性？**

A：可以从以下几个方面优化：

- 优化分词和词扩展策略
- 调整多目标召回参数
- 优化排序模型参数
- 应用业务规则进行重排

**Q3：如何处理新内容搜索不到的问题？**

A：新内容搜索不到可能是因为：

- 索引更新延迟，需要等待索引更新
- 内容未通过审核，需要检查内容状态
- 分词词库未包含新词，需要更新分词词库

---

## 5. 附录

### 5.1 相关技术文档链接

#### 搜索理解相关

- [20241030 花瓣搜索文本召回词拓展切换为新数据源及逻辑优化（需 ab）]

#### 召回相关

- [召回_多目标召回]
- [20250515 花瓣搜索召回路比例调整及业务池支持多目标召回（需 ab）]
- [20250115 花瓣搜索采集 tab 素材比例根据策略进行动态调整（需 ab）]

#### 排序相关

- [L3:个性化排序](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=248343892)
- [20240516 花瓣搜索针对会员用户增加自产素材的排序权重]

#### 业务场景相关

- [02 搜索能力_介绍与接入]（稿定模板搜索）

### 5.2 术语表

| 术语 | 说明 |
|------|------|
| **Query** | 用户输入的搜索词 |
| **Term** | 分词后的词单元 |
| **召回（Recall）** | 从海量内容中筛选出与 Query 相关的候选内容 |
| **排序（Ranking）** | 对召回结果进行排序，预测用户最想要的内容 |
| **LR** | Logistic Regression，逻辑回归模型，用于相关性评分 |
| **向量召回** | 基于深度学习的语义召回方式 |
| **文本召回** | 基于文本匹配的召回方式 |
| **业务池** | 基于业务规则的内容池，如引入期内容池 |
| **多目标召回** | 综合考虑多个目标的个性化召回方式 |
| **扶持分** | 用于扶持特定内容的分数 |
| **比例混排** | 按照设定的比例混合不同召回路径的结果 |
| **PVCTR** | Page View Click Through Rate，页面浏览点击率 |
| **UVCTR** | Unique Visitor Click Through Rate，独立访客点击率 |

### 5.3 搜索链路关键节点说明

#### L1 召回层

- **文本召回**：基于文本匹配的召回
- **业务池召回**：基于业务规则的内容池召回
- **多目标召回**：基于深度学习的语义召回
- **扶持分重排**：根据扶持分进行召回重排

#### L3 排序层

- **多目标排序**：综合考虑点击、下载、付费等多个目标

#### L4 重排层

- **L4 分计算**：支持多目标，包括点击、采集、下载、付费、扶持分
- **会员自产内容加权**：对会员用户有自产内容加权的逻辑
- **比例混排**：不同场景下素材比例不同

### 5.4 文档更新记录

| 版本 | 操作 | 修订内容 | 修订日期 | 修订人 |
|------|------|----------|---------|--------|
| 2.0 | 重构 | 重新梳理文档结构，完善内容，引入图片 | 2025-01-14 | - |
| 1.0 | 新增 | 花瓣搜索能力介绍初版 | 2023-03-08 | @未知用户 (haikui) |

---

**文档维护**：搜索算法团队  
**最后更新**：2025-01-14  
**文档版本**：2.0
