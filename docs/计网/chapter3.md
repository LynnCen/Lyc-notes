# 第 3 章 数据链路层

## 数据链路层的功能

有三个基本问题则是共同的，即封装成帧、透明传输和差错检测。

数据链路层使用的信道主要有两种:

1️⃣ 点对点信道，使用一对一的通信方式。PPP协议则是目前使用最广泛的点对点协议。

2️⃣ 广播信道，这种信道上连接的主机很多，使用 一对多的广播通信方式。采用共享广播信 道的有线局域网普遍使用CSMA/CD协议，而无线局域网则使用CSMA/CA协议。

1. 数据链路层所处的地位

链路、数据链路、帧

2. 链路管理

数据链路层连接的建立、维持和释放过程称力链路管理

3. 封装成帧与透明传输

4. 为网络层提供服务

5. 流量控制

6. 差错检测


## 组帧

发送方依据一定的规则将网络层递交的分组封装成帧(也称组帧)。组帧主要解决帧定界、帧同步、透明传输等问题。

### 字符计数法

字符计数法是指在帧首部使用一个计数字段来记录该帧所含的字节数(包括计数字段自身所占用的1个字节)

### 字节填充法

控制字符SOH放在帧的最前面，表示帧的开始，控制字符EOT表示帧的结束。在特殊字符之前填充一个转义字符ESC来加以区

### 零比特填充法

使用一个特定的比特串01111110来标志一帧的开始和结束，每遇到5个连续的“1”，就自动在其后插入一个“0”。

### 违规编码法

在物理层进行比特编码时，常采用违规编码法。例如，曼彻斯特编码方法将数据比特“ 1” 编码成“高-低” 电平对，将数据比特 “0” 编码成“ 低-高” 电平对，而“高-高” 电平对和“低 - 低” 电平对在数据比特中是违规的(即没有采用)，因此可借用这些违规编码序列来定界帧的起 始和终止。  

## 差错控制

### 检错编码

1. **奇偶检验码**

它由n- 1位数据和1位检验位组成，检验位的取值(0或1)将使整个检验码中“1” 的个数为奇数或偶数。

例如，7 位数据1001101 对应的奇检验码 10011011，对应的偶检验码 10011012

2. **循环冗余码**

又由多项式生成位串，原数据补多项式最高次个0 将位串与数据进行逻辑异或运算（同0异1）

![alt text](./img/循环冗余码.png)

> 循环冗余码 (CRC )是具有纠错功能的，只是数 据链路层仅使用 了它的检错功能


### 纠错编码

最常见的纠错编码是*海明码*，其实现原理是在有效信息位中加入几个检验位形成海 明码，并 把海明码的每个二进制位分配到几个奇偶检验组中

## 流量控制与可靠传输机制

### 流量控制与滑动窗口机制

流量控制是指由接收方控制发送方的发送速率，使接收方有足够的缓冲空间来接收每个帧。

数据链路层和传输层均有流量控制的功能 ，它们都用到了滑动窗口协议，但也有所区别，主要体现如下:

1️⃣ 数据链路层控制的是相邻结点之间的流量，而传输层控制的是端到端的流量。 

2️⃣ 数据链路层的控制手段是接收方收不下就不返回确认。传输层的控制手段是接收方通过 确认报文段中的窗又值来调整发送方的发送窗又。

1. **停止-等待流量控制基本原理**

发送方每次只允许发送一个帧，接收方每接收一个帧都要反馈一个应答信号，表示可以接收下一帧，发送方收到应答信号后才能发送下一帧。若发送方没有收到接收方反馈的应答信号，则需要一直等待。

2. **滑动窗口流量控制基本原理**

发送方都维持一组连续的允许发送帧的序号，称为发送窗口。同时接收方也维持一组连续的允许接收帧的序号，称为接收窗口。发送方每收到一个按序确认的确认帧，就将发送窗又向前滑动 一个位置

停止-等待协议:发送窗又Wt=1，接收窗口Wr=1。

后退N帧协议:发送窗又Wt>1，接收窗又Wr=1。

选择重传协议:发送窗又Wt>1，接收窗又Wr>1。

若采用n比特对帧编号，则后两种滑动窗又协议还需满足Wt+Wr≤2^n。

### 可靠传输机制

可靠传输是指发送方发送的数据都能被接收方正确地接收，通常采用**确认**和**超时重传**两种机制来实现。

**确认**是指接收方每收到发送方发来的数据帧，都要向发送方发回一个确认帧，表示已 正确地收到该数据帧。

**超时重传**是指发送方在发送一个数据帧后就启动一个计时器，若在规定时 间内没有收到所发送数据帧的确认帧，则重发该数据帧，直到发送成功为止。

1. **单帧滑动窗口与停止-等待协议**

停止- 等待协议的发送窗又和接收窗又大小均为1。若连续出现相同序号的数据帧，则表明发送方进行了超时重传。

2. **多帧滑动窗口与后退N帧协议(GBN)**

发送方可在未收到确认帧的情况下，将序号在发送窗又内的多个数据帧全部发送出去。发送方发送N个数据帧后，若发现这N个帧的前一个数据帧在计时器超时的时候仍未收到其确认信息，则该帧被判出错或丢失，此时发送方不得不重传该出错帧及随后的N个帧。

GBN协议允许接收方进行**累积确认**，即允许接收方不需要每收到一个正确的数据帧就立即发回一个确认帧，而可在连续收到多个正确的数据帧后，对最后一个数据帧发回确认信息，也就是说，对某个数据帧的确认就代表该数据帧和之前所有的帧均已正确无误地收到。

发送窗口应满足1< Wt ≤ 2^n - 1，接收窗口Wr= 1

3. **多帧滑动窗口与选择重传协议 (SR)**

加大接收窗口，以便先收下失序但正确到达且序号仍落在接收窗又内的那些数据帧，等到所缺序号的数据帧收齐后，再一并送交上层。这就是选择重传协议。接收方不能再采用累积确认，而要对每个正确接收的数据帧逐一进行确认。每个发送缓冲区对应一个计时器，当计时器超时的时候，缓冲区的帧就重传。

窗口大小：Wr+ Wt ≤ 2^n，Wr ≤ 2^n-1，Wr和Wt的大小是相同的

4. **信道利用率**

信道效率是对发送方而言的，是指发送方在一个发送周期 (从发送方开始发送分组到收到第 一个确认分组所需的时间)内，有效发送数据的时 间与整个发送周期之比。

**U = n*Td / Td + RTT + Ta**；（Td为发送时延，RTT为往返时延，Ta为确认帧发送时延）；

信道平均(实际)数据传输速率=信道利用率x信道带宽(最大数据传输速率)

信道平均(实际)数据传输速率=发送周期内发送的数据量/发送周期