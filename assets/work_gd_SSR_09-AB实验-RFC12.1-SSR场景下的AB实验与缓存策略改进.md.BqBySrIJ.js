import{_ as a,c as n,o as i,a7 as p}from"./chunks/framework.BQb8NfN9.js";const l="/Lyc-notes/assets/image2024-6-24_17-2-59.r837lX9Y.png",e="/Lyc-notes/assets/SSR%20AB%20.DbXi_gAe.png",t="/Lyc-notes/assets/image2024-6-26_18-20-59.C0dQEQhi.png",o=JSON.parse('{"title":"RFC 12.1: SSR åœºæ™¯ä¸‹çš„ AB å®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›","description":"","frontmatter":{},"headers":[],"relativePath":"work/gd/SSR/09-ABå®éªŒ-RFC12.1-SSRåœºæ™¯ä¸‹çš„ABå®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›.md","filePath":"work/gd/SSR/09-ABå®éªŒ-RFC12.1-SSRåœºæ™¯ä¸‹çš„ABå®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›.md","lastUpdated":1770089359000}'),r={name:"work/gd/SSR/09-ABå®éªŒ-RFC12.1-SSRåœºæ™¯ä¸‹çš„ABå®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›.md"};function h(k,s,d,c,b,g){return i(),n("div",null,s[0]||(s[0]=[p(`<h1 id="rfc-12-1-ssr-åœºæ™¯ä¸‹çš„-ab-å®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›" tabindex="-1">RFC 12.1: SSR åœºæ™¯ä¸‹çš„ AB å®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿› <a class="header-anchor" href="#rfc-12-1-ssr-åœºæ™¯ä¸‹çš„-ab-å®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›" aria-label="Permalink to &quot;RFC 12.1: SSR åœºæ™¯ä¸‹çš„ AB å®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›&quot;">â€‹</a></h1><blockquote><p><strong>æ–‡æ¡£æ¥æº</strong><br> Confluence: <a href="https://doc.huanleguang.com/pages/viewpage.action?pageId=385689046" target="_blank" rel="noreferrer">https://doc.huanleguang.com/pages/viewpage.action?pageId=385689046</a></p></blockquote><hr><h2 id="æ–‡æ¡£æ¦‚è¿°" tabindex="-1">æ–‡æ¡£æ¦‚è¿° <a class="header-anchor" href="#æ–‡æ¡£æ¦‚è¿°" aria-label="Permalink to &quot;æ–‡æ¡£æ¦‚è¿°&quot;">â€‹</a></h2><p>æœ¬ RFC æå‡ºäº† <strong>SSR åœºæ™¯ä¸‹ AB å®éªŒåŸºç¡€è®¾æ–½çš„æ”¹è¿›æ–¹æ¡ˆ</strong>ï¼Œè§£å†³ AB å®éªŒåœ¨æœåŠ¡ç«¯æ¸²æŸ“ç¯å¢ƒä¸­çš„å…¼å®¹æ€§é—®é¢˜å’Œç¼“å­˜ç­–ç•¥ä¼˜åŒ–ã€‚</p><p><strong>æ ¸å¿ƒç›®æ ‡</strong>ï¼š</p><ul><li>ğŸ¯ AB å®éªŒåœ¨ SSR ä¸­ç”Ÿæ•ˆ</li><li>ğŸ’¾ ä¼˜åŒ–ç¼“å­˜ç­–ç•¥é¿å…ç¢ç‰‡åŒ–</li><li>âš¡ æå‡æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ</li><li>ğŸ”„ å…¼å®¹ CSR å’Œ SSR ä¸¤ç§æ¨¡å¼</li></ul><p><strong>çŠ¶æ€</strong>ï¼š</p><ul><li>âœ… ä¸åŸºå»ºå›¢é˜Ÿè¾¾æˆå…±è¯†</li><li>âœ… ä¸ä¸šåŠ¡ç›¸å…³å›¢é˜Ÿè¾¾æˆå…±è¯†</li><li>âœ… è¾“å‡ºæ’æœŸ</li><li>âœ… è¾“å‡º PR</li><li>âœ… å·²ä¸Šçº¿</li></ul><p><strong>ç›¸å…³é“¾æ¥</strong>ï¼š</p><ul><li><a href="https://pingcode.intra.gaoding.com/pjm/projects/SREJC/backlog/652692bfa5244157b8845984" target="_blank" rel="noreferrer">æ’æœŸè®¡åˆ’</a></li></ul><hr><h2 id="ä¸€ã€æè¿°" tabindex="-1">ä¸€ã€æè¿° <a class="header-anchor" href="#ä¸€ã€æè¿°" aria-label="Permalink to &quot;ä¸€ã€æè¿°&quot;">â€‹</a></h2><h3 id="_1-1-æ–‡æ¡£èŒƒå›´" tabindex="-1">1.1 æ–‡æ¡£èŒƒå›´ <a class="header-anchor" href="#_1-1-æ–‡æ¡£èŒƒå›´" aria-label="Permalink to &quot;1.1 æ–‡æ¡£èŒƒå›´&quot;">â€‹</a></h3><p><strong>æœ¬ RFC æ¶µç›–</strong>ï¼š</p><ul><li>âœ… SSR ä¸‹çš„ AB å®éªŒåŸºç¡€è®¾æ–½</li><li>âœ… ç¼“å­˜ç­–ç•¥æ”¹è¿›</li><li>âœ… AB SDK é€‚é…æ–¹æ¡ˆ</li></ul><p><strong>ä¸åœ¨èŒƒå›´å†…</strong>ï¼š</p><ul><li>âŒ CDN è¾¹ç¼˜ç¼“å­˜ï¼ˆåç»­ RFC å¤„ç†ï¼‰</li><li>âŒ ç°åº¦ç³»ç»Ÿï¼ˆç‹¬ç«‹ç³»ç»Ÿï¼‰</li></ul><h3 id="_1-2-èƒŒæ™¯" tabindex="-1">1.2 èƒŒæ™¯ <a class="header-anchor" href="#_1-2-èƒŒæ™¯" aria-label="Permalink to &quot;1.2 èƒŒæ™¯&quot;">â€‹</a></h3><p><strong>æ¶æ„æ¼”è¿›</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è¿‡å»ï¼šCSR ä¼˜å…ˆæ¶æ„</span></span>
<span class="line"><span>   â”œâ”€ AB SDK åŸºäº CSR è®¾è®¡</span></span>
<span class="line"><span>   â””â”€ å®¢æˆ·ç«¯è·å– AB å®éªŒæ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç°åœ¨ï¼šSSR ä¼˜å…ˆæ¶æ„</span></span>
<span class="line"><span>   â”œâ”€ æä¾›æ›´ä¼˜çš„ç”¨æˆ·ä½“éªŒ</span></span>
<span class="line"><span>   â”œâ”€ SEO å‹å¥½</span></span>
<span class="line"><span>   â””â”€ ä½† AB SDK å‡ºç°éé¢„æœŸè¡Œä¸º âŒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr><h2 id="äºŒã€åŠ¨æœº" tabindex="-1">äºŒã€åŠ¨æœº <a class="header-anchor" href="#äºŒã€åŠ¨æœº" aria-label="Permalink to &quot;äºŒã€åŠ¨æœº&quot;">â€‹</a></h2><h3 id="_2-1-é—®é¢˜èƒŒæ™¯" tabindex="-1">2.1 é—®é¢˜èƒŒæ™¯ <a class="header-anchor" href="#_2-1-é—®é¢˜èƒŒæ™¯" aria-label="Permalink to &quot;2.1 é—®é¢˜èƒŒæ™¯&quot;">â€‹</a></h3><p><strong>æŠ€æœ¯æ ˆå˜åŒ–</strong>ï¼š</p><ul><li>ä» <strong>CSRï¼ˆå®¢æˆ·ç«¯æ¸²æŸ“ï¼‰ä¼˜å…ˆ</strong> â†’ <strong>SSRï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ï¼‰ä¼˜å…ˆ</strong></li><li>AB å®éªŒ SDK åŸºäº CSR æ¨¡å¼è®¾è®¡</li><li>åœ¨ SSR æ¶æ„ä¸‹å‡ºç°é—®é¢˜</li></ul><h3 id="_2-2-ç°è±¡ä¸€-æ¥å£-ab-å®éªŒæ²¡æœ‰ç”Ÿæ•ˆ" tabindex="-1">2.2 ç°è±¡ä¸€ï¼šæ¥å£ AB å®éªŒæ²¡æœ‰ç”Ÿæ•ˆ <a class="header-anchor" href="#_2-2-ç°è±¡ä¸€-æ¥å£-ab-å®éªŒæ²¡æœ‰ç”Ÿæ•ˆ" aria-label="Permalink to &quot;2.2 ç°è±¡ä¸€ï¼šæ¥å£ AB å®éªŒæ²¡æœ‰ç”Ÿæ•ˆ&quot;">â€‹</a></h3><p><strong>Bug æ¡ˆä¾‹</strong>ï¼šTYCPYF-7690</p><p><strong>é—®é¢˜æµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šç”¨æˆ·è®¿é—®é¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>é¡µé¢æ¥è‡ª SSRï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ è·å–çš„æ˜¯æ²¡æœ‰ AB å®éªŒçš„å†…å®¹</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šç”¨æˆ·æ“ä½œé¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>è§¦å‘å¼‚æ­¥ API è¯·æ±‚</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>é¡µé¢å±€éƒ¨é‡æ–°æ¸²æŸ“</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âœ… æ­¤æ—¶æ‰å‘ˆç° AB å®éªŒç»“æœ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šç”¨æˆ·åˆ·æ–°é¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>åˆå›åˆ° SSR æ¸²æŸ“</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ åˆæ˜¯æ²¡æœ‰ AB å®éªŒçš„çŠ¶æ€</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>ç”¨æˆ·ä½“éªŒå½±å“</strong>ï¼š</p><table tabindex="0"><thead><tr><th>æ“ä½œ</th><th>çœ‹åˆ°çš„å†…å®¹</th><th>ç”¨æˆ·æ„Ÿå—</th></tr></thead><tbody><tr><td><strong>é¦–æ¬¡è®¿é—®</strong></td><td>æ²¡æœ‰ AB å®éªŒ</td><td>âš ï¸ ä¸ä¸€è‡´</td></tr><tr><td><strong>é¡µé¢äº¤äº’</strong></td><td>æœ‰ AB å®éªŒ</td><td>âœ… æ­£å¸¸</td></tr><tr><td><strong>åˆ·æ–°é¡µé¢</strong></td><td>æ²¡æœ‰ AB å®éªŒ</td><td>âš ï¸ å†…å®¹å˜äº†ï¼Ÿ</td></tr></tbody></table><h3 id="_2-3-ç°è±¡äºŒ-é¢‘ç¹çš„å†…å®¹æ›¿æ¢" tabindex="-1">2.3 ç°è±¡äºŒï¼šé¢‘ç¹çš„å†…å®¹æ›¿æ¢ <a class="header-anchor" href="#_2-3-ç°è±¡äºŒ-é¢‘ç¹çš„å†…å®¹æ›¿æ¢" aria-label="Permalink to &quot;2.3 ç°è±¡äºŒï¼šé¢‘ç¹çš„å†…å®¹æ›¿æ¢&quot;">â€‹</a></h3><p><strong>æ¡ˆä¾‹</strong>ï¼šé¦–é¡µç¼–è¾‘æ¨èåŒºåŸŸ</p><p><img src="`+l+`" alt="é¢‘ç¹çš„å†…å®¹æ›¿æ¢"></p><p><strong>é—®é¢˜æµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šç”¨æˆ·è¿›å…¥é¦–é¡µ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>é¡µé¢æ¥è‡ª SSR + ç¼“å­˜ï¼ˆ10åˆ†é’Ÿå‰ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ æ˜¾ç¤ºæ²¡æœ‰ AB å®éªŒçš„å†…å®¹</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šç”Ÿå‘½å‘¨æœŸç¼“å­˜è¿‡æœŸ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æµè§ˆå™¨ JS å‘èµ·å¼‚æ­¥è¯·æ±‚</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å‘½ä¸­ AB å®éªŒ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âš ï¸ é¡µé¢åŒºå—å†…å®¹è¢«æ›¿æ¢ï¼ˆé—ªçƒï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šåç»­æ¯æ¬¡è®¿é—®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>éƒ½ä¼šçœ‹åˆ°å†…å®¹æ›¿æ¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ ä½“éªŒæ€ªå¼‚</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>å½±å“</strong>ï¼š</p><ul><li>ğŸ”´ é¡µé¢å†…å®¹é—ªçƒ</li><li>ğŸ”´ ç”¨æˆ·ä½“éªŒå·®</li><li>ğŸ”´ çœ‹èµ·æ¥åƒ Bug</li></ul><hr><h2 id="ä¸‰ã€æè®®å†…å®¹" tabindex="-1">ä¸‰ã€æè®®å†…å®¹ <a class="header-anchor" href="#ä¸‰ã€æè®®å†…å®¹" aria-label="Permalink to &quot;ä¸‰ã€æè®®å†…å®¹&quot;">â€‹</a></h2><h3 id="_3-1-æ ¸å¿ƒæè®®" tabindex="-1">3.1 æ ¸å¿ƒæè®® <a class="header-anchor" href="#_3-1-æ ¸å¿ƒæè®®" aria-label="Permalink to &quot;3.1 æ ¸å¿ƒæè®®&quot;">â€‹</a></h3><blockquote><p><strong>æè®®</strong>ï¼šåœ¨ SSR ä¸­æ¸²æŸ“åŒ…å« AB å®éªŒçš„é¡µé¢</p></blockquote><p><strong>å®ç°å…³é”®</strong>ï¼š</p><ol><li><p><strong>AB å®éªŒ SDK æ”¹è¿›</strong></p><ul><li>è®© SDK èƒ½åœ¨ SSR ç¯å¢ƒä¸‹æ­£ç¡®å·¥ä½œ</li></ul></li><li><p><strong>ç«™ç‚¹ç¼“å­˜ç­–ç•¥æ”¹è¿›</strong></p><ul><li>å°† AB å®éªŒçº³å…¥ Cache Key</li><li>æ ¹æ®ä¸åŒå®éªŒç¼“å­˜ä¸åŒç‰ˆæœ¬</li></ul></li></ol><h3 id="_3-2-æ”¹è¿›æ¦‚è§ˆ" tabindex="-1">3.2 æ”¹è¿›æ¦‚è§ˆ <a class="header-anchor" href="#_3-2-æ”¹è¿›æ¦‚è§ˆ" aria-label="Permalink to &quot;3.2 æ”¹è¿›æ¦‚è§ˆ&quot;">â€‹</a></h3><p><strong>æ”¹è¿›å‰</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SSR æ¸²æŸ“é¡µé¢ï¼ˆæ—  ABï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ç¼“å­˜é¡µé¢ï¼ˆæ—  ABï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å®¢æˆ·ç«¯ JS è·å– AB</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>é‡æ–°æ¸²æŸ“ï¼ˆæœ‰ ABï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ å†…å®¹é—ªçƒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>æ”¹è¿›å</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SSR è·å– AB æ•°æ®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>SSR æ¸²æŸ“é¡µé¢ï¼ˆæœ‰ ABï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ç¼“å­˜é¡µé¢ï¼ˆæŒ‰ AB åˆ†ç»„ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å®¢æˆ·ç«¯æ°´åˆï¼ˆä¸€è‡´ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âœ… æ— é—ªçƒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><hr><h2 id="å››ã€è¯¦ç»†è®¾è®¡" tabindex="-1">å››ã€è¯¦ç»†è®¾è®¡ <a class="header-anchor" href="#å››ã€è¯¦ç»†è®¾è®¡" aria-label="Permalink to &quot;å››ã€è¯¦ç»†è®¾è®¡&quot;">â€‹</a></h2><h3 id="_4-1-ab-å®éªŒ-sdk-æ”¹è¿›" tabindex="-1">4.1 AB å®éªŒ SDK æ”¹è¿› <a class="header-anchor" href="#_4-1-ab-å®éªŒ-sdk-æ”¹è¿›" aria-label="Permalink to &quot;4.1 AB å®éªŒ SDK æ”¹è¿›&quot;">â€‹</a></h3><h4 id="æ”¹è¿›è¦ç‚¹" tabindex="-1">æ”¹è¿›è¦ç‚¹ <a class="header-anchor" href="#æ”¹è¿›è¦ç‚¹" aria-label="Permalink to &quot;æ”¹è¿›è¦ç‚¹&quot;">â€‹</a></h4><p><strong>1. å¢åŠ æœåŠ¡ç«¯å…¥å£</strong></p><p><strong>åŒ…ç»“æ„è°ƒæ•´</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>@company/ab-sdk/</span></span>
<span class="line"><span>â”œâ”€â”€ src/</span></span>
<span class="line"><span>â”‚   â”œâ”€â”€ client.ts    # å®¢æˆ·ç«¯å®ç°</span></span>
<span class="line"><span>â”‚   â”œâ”€â”€ server.ts    # æœåŠ¡ç«¯å®ç°</span></span>
<span class="line"><span>â”‚   â””â”€â”€ shared.ts    # å…±äº«ä»£ç </span></span>
<span class="line"><span>â””â”€â”€ package.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>package.json é…ç½®</strong>ï¼š</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;@company/ab-sdk&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;exports&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;worker&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./dist/server.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;browser&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./dist/client.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./dist/server.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>2. ä½¿ç”¨è¯·æ±‚ä¸Šä¸‹æ–‡</strong></p><p><strong>æœåŠ¡ç«¯å®ç°</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// server.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { context } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@web-widget/helpers/context&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">experimentName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è·å–è¯·æ±‚ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ä» Cookie è·å– AB ç»„</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> request.cookies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)?.value;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (abTestId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä½¿ç”¨ç¼“å­˜çš„ AB ç»„</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> parseABFromCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abTestId, experimentName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // é¦–æ¬¡è®¿é—®ï¼Œè¯·æ±‚ AB æœåŠ¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchABService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request.headers);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abData[experimentName];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>å®¢æˆ·ç«¯å®ç°</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// client.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">experimentName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ä»å…¨å±€å¯¹è±¡è·å–ï¼ˆSSR æ³¨å…¥ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (window.__AB_EXPERIMENTS__) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.__AB_EXPERIMENTS__[experimentName];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // é™çº§ï¼šå®¢æˆ·ç«¯è¯·æ±‚</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/ab-experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abData[experimentName];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>ä¸šåŠ¡ä»£ç ä½¿ç”¨</strong>ï¼ˆæ— éœ€æ”¹åŠ¨ï¼‰ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸šåŠ¡ç»„ä»¶</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { getABExperiment } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@company/ab-sdk&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // âœ… æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½èƒ½å·¥ä½œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> experiment</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;homepage_layout&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      showNewLayout: experiment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;variant_b&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>å…³é”®ä¼˜åŠ¿</strong>ï¼š</p><table tabindex="0"><thead><tr><th>ç‰¹æ€§</th><th>è¯´æ˜</th><th>ä»·å€¼</th></tr></thead><tbody><tr><td><strong>æ— éœ€æ”¹åŠ¨ä¸šåŠ¡ä»£ç </strong></td><td>SDK å†…éƒ¨é€‚é…</td><td>âœ… é™ä½è¿ç§»æˆæœ¬</td></tr><tr><td><strong>ä½¿ç”¨ context()</strong></td><td>æ— éœ€ä¼ é€’ request</td><td>âœ… ç®€åŒ–ä»£ç </td></tr><tr><td><strong>æ¡ä»¶å¯¼å‡º</strong></td><td>è‡ªåŠ¨é€‰æ‹©æ­£ç¡®å®ç°</td><td>âœ… é€æ˜åˆ‡æ¢</td></tr></tbody></table><h3 id="_4-2-ç«™ç‚¹ç¼“å­˜ç­–ç•¥æ”¹è¿›" tabindex="-1">4.2 ç«™ç‚¹ç¼“å­˜ç­–ç•¥æ”¹è¿› <a class="header-anchor" href="#_4-2-ç«™ç‚¹ç¼“å­˜ç­–ç•¥æ”¹è¿›" aria-label="Permalink to &quot;4.2 ç«™ç‚¹ç¼“å­˜ç­–ç•¥æ”¹è¿›&quot;">â€‹</a></h3><h4 id="èƒŒæ™¯" tabindex="-1">èƒŒæ™¯ <a class="header-anchor" href="#èƒŒæ™¯" aria-label="Permalink to &quot;èƒŒæ™¯&quot;">â€‹</a></h4><p><strong>ç°æœ‰ç¼“å­˜è§„æ¨¡</strong>ï¼š</p><ul><li>é¡µé¢çº§åˆ«ç¼“å­˜</li><li>ç™¾ä¸‡çº§åˆ« URL</li><li>ç™»å½•å‰ååˆ†åˆ«ç¼“å­˜</li></ul><p><strong>ç¼“å­˜ç­–ç•¥</strong>ï¼š</p><table tabindex="0"><thead><tr><th>åœºæ™¯</th><th>ç¼“å­˜ç­–ç•¥</th><th>AB å®éªŒå½±å“</th></tr></thead><tbody><tr><td><strong>ç™»å½•å</strong></td><td>æŒ‰ç”¨æˆ·ç¼“å­˜</td><td>âš ï¸ åŒ…å«ä¸ªæ€§åŒ–æ¨è</td></tr><tr><td><strong>ç™»å½•å‰</strong></td><td>æŒ‰ URL ç¼“å­˜</td><td>ğŸ¯ éœ€è¦è§£å†³ AB é—®é¢˜</td></tr></tbody></table><p><strong>èšç„¦</strong>ï¼šç™»å½•å‰çš„ç¼“å­˜ç­–ç•¥</p><h4 id="æ–¹æ¡ˆè®¾è®¡" tabindex="-1">æ–¹æ¡ˆè®¾è®¡ <a class="header-anchor" href="#æ–¹æ¡ˆè®¾è®¡" aria-label="Permalink to &quot;æ–¹æ¡ˆè®¾è®¡&quot;">â€‹</a></h4><p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼šå°† AB å®éªŒçº³å…¥ Cache Key</p><p><strong>Cache Key ç»„æˆ</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ”¹è¿›å‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cacheKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ”¹è¿›å</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cacheKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abTestGroupId);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>abTestGroupId è®¡ç®—</strong>ï¼š</p><p><strong>å…¬å¼</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç¼“å­˜ç‰ˆæœ¬æ•° = 2^n (n = å®éªŒæ•°é‡)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>ç¤ºä¾‹ 1ï¼šå•ä¸ªå®éªŒ</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å®éªŒï¼š/api/foo</span></span>
<span class="line"><span>   â”œâ”€ variant_a</span></span>
<span class="line"><span>   â””â”€ variant_b</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç¼“å­˜ç‰ˆæœ¬ï¼š</span></span>
<span class="line"><span>   1. hash(&#39;/api/foo:a&#39;)</span></span>
<span class="line"><span>   2. hash(&#39;/api/foo:b&#39;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ€»æ•°ï¼š2 ä¸ª</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>ç¤ºä¾‹ 2ï¼šä¸¤ä¸ªå®éªŒ</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å®éªŒ 1ï¼š/api/foo</span></span>
<span class="line"><span>   â”œâ”€ variant_a</span></span>
<span class="line"><span>   â””â”€ variant_b</span></span>
<span class="line"><span></span></span>
<span class="line"><span>å®éªŒ 2ï¼š/api/bar</span></span>
<span class="line"><span>   â”œâ”€ variant_a</span></span>
<span class="line"><span>   â””â”€ variant_b</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç¼“å­˜ç‰ˆæœ¬ï¼š</span></span>
<span class="line"><span>   1. hash(&#39;/api/foo:a&#39; + &#39;/api/bar:a&#39;)</span></span>
<span class="line"><span>   2. hash(&#39;/api/foo:a&#39; + &#39;/api/bar:b&#39;)</span></span>
<span class="line"><span>   3. hash(&#39;/api/foo:b&#39; + &#39;/api/bar:a&#39;)</span></span>
<span class="line"><span>   4. hash(&#39;/api/foo:b&#39; + &#39;/api/bar:b&#39;)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ€»æ•°ï¼š4 ä¸ª</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>ä»£ç å®ç°</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®¡ç®— abTestGroupId</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateABTestGroupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">experiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sortedExperiments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(experiments)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¡®ä¿é¡ºåºä¸€è‡´</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">experiments</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sortedExperiments.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;+&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> experiments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;/api/foo&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;variant_a&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;/api/bar&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;variant_b&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestGroupId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateABTestGroupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(experiments);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// â†’ &quot;abc123def456&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cacheKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abTestGroupId);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="æ€§èƒ½ä¼˜åŒ–" tabindex="-1">æ€§èƒ½ä¼˜åŒ– <a class="header-anchor" href="#æ€§èƒ½ä¼˜åŒ–" aria-label="Permalink to &quot;æ€§èƒ½ä¼˜åŒ–&quot;">â€‹</a></h4><p><strong>é—®é¢˜</strong>ï¼š</p><ul><li>æ¯æ¬¡è¯·æ±‚éƒ½è¦è°ƒç”¨ AB æ¥å£</li><li>è®¡ç®— abTestGroupId</li><li>æ€§èƒ½æŸè€—</li></ul><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå°† abTestGroupId ç¼“å­˜åˆ° Cookie</p><p><strong>Cookie è®¾è®¡</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Cookie Name: x-ab-test-id</span></span>
<span class="line"><span>Cookie Value: abc123def456 (abTestGroupId hash)</span></span>
<span class="line"><span>Max-Age: 7 å¤©</span></span>
<span class="line"><span>HttpOnly: true</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>ä¼˜åŒ–æµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šæ£€æŸ¥ Cookie</span></span>
<span class="line"><span>   â”œâ”€ å­˜åœ¨ x-ab-test-id</span></span>
<span class="line"><span>   â”‚    â†“</span></span>
<span class="line"><span>   â”‚  ç›´æ¥ä½¿ç”¨ Cookie å€¼ä½œä¸º Cache Key</span></span>
<span class="line"><span>   â”‚    â†“</span></span>
<span class="line"><span>   â”‚  æ£€æŸ¥ç¼“å­˜</span></span>
<span class="line"><span>   â”‚    â”œâ”€ å‘½ä¸­ â†’ è¿”å›ç¼“å­˜</span></span>
<span class="line"><span>   â”‚    â””â”€ æœªå‘½ä¸­ â†’ SSR æ¸²æŸ“</span></span>
<span class="line"><span>   â”‚</span></span>
<span class="line"><span>   â””â”€ ä¸å­˜åœ¨ x-ab-test-id</span></span>
<span class="line"><span>        â†“</span></span>
<span class="line"><span>      è°ƒç”¨ AB æ¥å£</span></span>
<span class="line"><span>        â†“</span></span>
<span class="line"><span>      è®¡ç®— abTestGroupId</span></span>
<span class="line"><span>        â†“</span></span>
<span class="line"><span>      ç§å…¥ Cookie</span></span>
<span class="line"><span>        â†“</span></span>
<span class="line"><span>      SSR æ¸²æŸ“</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>ä»£ç å®ç°</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// BFF å±‚å¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleSSRRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abTestGroupId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.cookies[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">abTestGroupId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // é¦–æ¬¡è®¿é—®ï¼Œè·å– AB æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchABExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req.headers);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    abTestGroupId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateABTestGroupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç§å…¥ Cookieï¼ˆ7å¤©ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, abTestGroupId, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      maxAge: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 24</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      httpOnly: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      secure: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åŒæ—¶ä¼ é€’ AB æ•°æ®åˆ—è¡¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-list&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ç»„è£… Cache Key</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cacheKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req.url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abTestGroupId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æ£€æŸ¥ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cached</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cacheKey);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (cached) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cached);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // SSR æ¸²æŸ“</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> renderSSR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // å†™å…¥ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cacheKey, html, { maxAge: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">600</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(html);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="_4-3-æ–¹æ¡ˆæµç¨‹å›¾" tabindex="-1">4.3 æ–¹æ¡ˆæµç¨‹å›¾ <a class="header-anchor" href="#_4-3-æ–¹æ¡ˆæµç¨‹å›¾" aria-label="Permalink to &quot;4.3 æ–¹æ¡ˆæµç¨‹å›¾&quot;">â€‹</a></h3><p><strong>æ•´ä½“æµç¨‹</strong>ï¼š</p><p><img src="`+e+`" alt="SSR AB å®éªŒæµç¨‹"></p><p><strong>æµç¨‹è¯´æ˜</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. ç”¨æˆ·è¯·æ±‚ â†’ BFF å±‚</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. BFF æ£€æŸ¥ Cookie ä¸­çš„ x-ab-test-id</span></span>
<span class="line"><span>   â”œâ”€ å­˜åœ¨ â†’ è·³åˆ°æ­¥éª¤ 4</span></span>
<span class="line"><span>   â””â”€ ä¸å­˜åœ¨ â†’ æ­¥éª¤ 3</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. BFF è·å– AB æ•°æ®</span></span>
<span class="line"><span>   â”œâ”€ è°ƒç”¨ AB æœåŠ¡</span></span>
<span class="line"><span>   â”œâ”€ è®¡ç®— abTestGroupId</span></span>
<span class="line"><span>   â”œâ”€ ç§å…¥ Cookie (x-ab-test-id)</span></span>
<span class="line"><span>   â””â”€ è®¾ç½® Header (x-ab-test-list)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. BFF ç»„è£… Cache Key</span></span>
<span class="line"><span>   Cache Key = hash(URL + x-ab-test-id)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>5. BFF æ£€æŸ¥ç¼“å­˜</span></span>
<span class="line"><span>   â”œâ”€ å‘½ä¸­ â†’ è¿”å›ç¼“å­˜</span></span>
<span class="line"><span>   â””â”€ æœªå‘½ä¸­ â†’ æ­¥éª¤ 6</span></span>
<span class="line"><span></span></span>
<span class="line"><span>6. è½¬å‘åˆ° Meta SSR æœåŠ¡</span></span>
<span class="line"><span>   Headers:</span></span>
<span class="line"><span>     - x-ab-test-id: abc123</span></span>
<span class="line"><span>     - x-ab-test-list: {&quot;exp1&quot;: &quot;a&quot;, &quot;exp2&quot;: &quot;b&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>7. Meta SSR æ¸²æŸ“</span></span>
<span class="line"><span>   â”œâ”€ AB SDK ä» Header è¯»å– AB æ•°æ®</span></span>
<span class="line"><span>   â”œâ”€ è¯·æ±‚æ¥å£æ—¶æºå¸¦ AB Tag</span></span>
<span class="line"><span>   â””â”€ æ¸²æŸ“åŒ…å« AB å®éªŒçš„é¡µé¢</span></span>
<span class="line"><span></span></span>
<span class="line"><span>8. è¿”å› HTML</span></span>
<span class="line"><span>   â””â”€ BFF å†™å…¥ç¼“å­˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>9. å“åº”ç»™ç”¨æˆ·</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><strong>å…³é”®Header</strong>ï¼š</p><table tabindex="0"><thead><tr><th>Header</th><th>ä½œç”¨</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>x-ab-test-id</code></td><td>Cache Key çš„ä¸€éƒ¨åˆ†</td><td><code>abc123def456</code></td></tr><tr><td><code>x-ab-test-list</code></td><td>SSR æ¸²æŸ“æ—¶çš„ AB æ•°æ®</td><td><code>{&quot;exp1&quot;:&quot;a&quot;,&quot;exp2&quot;:&quot;b&quot;}</code></td></tr></tbody></table><h3 id="_4-4-å®æ–½ç»†èŠ‚" tabindex="-1">4.4 å®æ–½ç»†èŠ‚ <a class="header-anchor" href="#_4-4-å®æ–½ç»†èŠ‚" aria-label="Permalink to &quot;4.4 å®æ–½ç»†èŠ‚&quot;">â€‹</a></h3><p><strong>BFF å±‚æ”¹é€ </strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// King BFF</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> redis</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;redis&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abCache</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">headers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-user-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;anonymous&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æ£€æŸ¥ Redis ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹è°ƒç”¨ AB æœåŠ¡ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cacheKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">userId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cached</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abCache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cacheKey);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (cached) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cached);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è°ƒç”¨ AB æœåŠ¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://ab-service.com/experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    headers: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;X-User-Id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: userId,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;X-Device-Id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-device-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ç¼“å­˜ 5 åˆ†é’Ÿ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abCache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cacheKey, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abData;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>Meta SSR æœåŠ¡æ”¹é€ </strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Meta SSR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ä» Header è¯»å– AB æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestList</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-list&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (abTestList) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ³¨å…¥åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    req.state.abExperiments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abTestList);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><hr><h2 id="äº”ã€ä»£æ›¿æ–¹æ¡ˆ" tabindex="-1">äº”ã€ä»£æ›¿æ–¹æ¡ˆ <a class="header-anchor" href="#äº”ã€ä»£æ›¿æ–¹æ¡ˆ" aria-label="Permalink to &quot;äº”ã€ä»£æ›¿æ–¹æ¡ˆ&quot;">â€‹</a></h2><h3 id="_5-1-æ–¹æ¡ˆ-a-ç™»å½•å‰ä½¿ç”¨-csr" tabindex="-1">5.1 æ–¹æ¡ˆ Aï¼šç™»å½•å‰ä½¿ç”¨ CSR <a class="header-anchor" href="#_5-1-æ–¹æ¡ˆ-a-ç™»å½•å‰ä½¿ç”¨-csr" aria-label="Permalink to &quot;5.1 æ–¹æ¡ˆ Aï¼šç™»å½•å‰ä½¿ç”¨ CSR&quot;">â€‹</a></h3><p><strong>æè¿°</strong>ï¼šç™»å½•å‰çš„é¡µé¢ä½¿ç”¨ CSRï¼Œæ”¾å¼ƒ SSR</p><p><strong>æµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç™»å½•å‰é¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å®¢æˆ·ç«¯æ¸²æŸ“ï¼ˆCSRï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å®¢æˆ·ç«¯è·å– AB å®éªŒ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âœ… æ— ç¼“å­˜é—®é¢˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>âœ… å®ç°ç®€å•</li><li>âœ… æ— ç¼“å­˜ç¢ç‰‡åŒ–é—®é¢˜</li><li>âœ… AB å®éªŒçµæ´»</li></ul><p><strong>å¼Šç«¯</strong>ï¼š</p><table tabindex="0"><thead><tr><th>å½±å“</th><th>è¯´æ˜</th><th>æ•°æ®</th></tr></thead><tbody><tr><td><strong>SEO</strong></td><td>å®Œå…¨æ”¾å¼ƒ SEO æ”¯æŒ</td><td>ğŸ”´ æœç´¢å¼•æ“æŠ“ä¸åˆ°å†…å®¹</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>LCP æŒ‡æ ‡ä¸¥é‡åŠ£åŒ–</td><td>ğŸ”´ 1.x s â†’ 4 s+</td></tr><tr><td><strong>ä½“éªŒ</strong></td><td>ç™½å±æ—¶é—´é•¿</td><td>ğŸ”´ ç”¨æˆ·ä½“éªŒå·®</td></tr></tbody></table><p><strong>ç»“è®º</strong>ï¼šâŒ ä¸å¯æ¥å—</p><h3 id="_5-2-æ–¹æ¡ˆ-b-ssr-ä½†å…³é—­ç¼“å­˜" tabindex="-1">5.2 æ–¹æ¡ˆ Bï¼šSSR ä½†å…³é—­ç¼“å­˜ <a class="header-anchor" href="#_5-2-æ–¹æ¡ˆ-b-ssr-ä½†å…³é—­ç¼“å­˜" aria-label="Permalink to &quot;5.2 æ–¹æ¡ˆ Bï¼šSSR ä½†å…³é—­ç¼“å­˜&quot;">â€‹</a></h3><p><strong>æè¿°</strong>ï¼šåœ¨ SSR ä¸­æ¸²æŸ“ AB å®éªŒï¼Œä½†å…³é—­ç™»å½•å‰é¡µé¢çš„ç¼“å­˜</p><p><strong>æµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç™»å½•å‰é¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>SSR å®æ—¶æ¸²æŸ“ï¼ˆæ¯æ¬¡éƒ½è¯·æ±‚ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âœ… è·å–æœ€æ–° AB å®éªŒ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âœ… æ— ç¼“å­˜é—®é¢˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>âœ… AB å®éªŒå®æ—¶ç”Ÿæ•ˆ</li><li>âœ… æ— ç¼“å­˜ç¢ç‰‡åŒ–</li></ul><p><strong>å¼Šç«¯</strong>ï¼š</p><table tabindex="0"><thead><tr><th>å½±å“</th><th>è¯´æ˜</th><th>æ•°æ®</th></tr></thead><tbody><tr><td><strong>æ€§èƒ½</strong></td><td>TTFB åŠ£åŒ–</td><td>ğŸ”´ 0.x s â†’ 1.x s</td></tr><tr><td><strong>ç¨³å®šæ€§</strong></td><td>å¤±å»ç¼“å­˜ä¿æŠ¤</td><td>ğŸ”´ æ— é™çº§èƒ½åŠ›</td></tr><tr><td><strong>è´Ÿè½½</strong></td><td>æœåŠ¡å™¨è´Ÿè½½å¢åŠ </td><td>ğŸ”´ æˆæœ¬ä¸Šå‡</td></tr><tr><td><strong>SEO</strong></td><td>æ€§èƒ½æŒ‡æ ‡ä¸‹é™</td><td>ğŸ”´ ä¼˜ç§€ â†’ ä¸åŠæ ¼</td></tr></tbody></table><p><strong>ç»“è®º</strong>ï¼šâŒ ä¸å¯æ¥å—</p><h3 id="_5-3-æ–¹æ¡ˆ-c-ä»…ç™»å½•åå¯ç”¨-ab" tabindex="-1">5.3 æ–¹æ¡ˆ Cï¼šä»…ç™»å½•åå¯ç”¨ AB <a class="header-anchor" href="#_5-3-æ–¹æ¡ˆ-c-ä»…ç™»å½•åå¯ç”¨-ab" aria-label="Permalink to &quot;5.3 æ–¹æ¡ˆ Cï¼šä»…ç™»å½•åå¯ç”¨ AB&quot;">â€‹</a></h3><p><strong>æè¿°</strong>ï¼šåªå¯¹ç™»å½•åçš„é¡µé¢å¯ç”¨ AB å®éªŒ</p><p><strong>æµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç™»å½•å‰é¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>SSR æ¸²æŸ“ï¼ˆæ—  ABï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ç¼“å­˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç™»å½•åé¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>SSR æ¸²æŸ“ï¼ˆæœ‰ ABï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æŒ‰ç”¨æˆ·ç¼“å­˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>âœ… æˆæœ¬ä½</li><li>âœ… æ— ç¼“å­˜ç¢ç‰‡åŒ–é—®é¢˜</li><li>âœ… å®ç°ç®€å•</li></ul><p><strong>å¼Šç«¯</strong>ï¼š</p><ul><li>âš ï¸ ç™»å½•å‰ç”¨æˆ·æ— æ³•å‚ä¸ AB å®éªŒ</li><li>âš ï¸ å®éªŒè¦†ç›–ç‡é™ä½</li></ul><p><strong>ç»“è®º</strong>ï¼šâš ï¸ å–å†³äºä¸šåŠ¡æ˜¯å¦å¯æ¥å—</p><h3 id="_5-4-æ–¹æ¡ˆ-d-å±€éƒ¨-csr" tabindex="-1">5.4 æ–¹æ¡ˆ Dï¼šå±€éƒ¨ CSR <a class="header-anchor" href="#_5-4-æ–¹æ¡ˆ-d-å±€éƒ¨-csr" aria-label="Permalink to &quot;5.4 æ–¹æ¡ˆ Dï¼šå±€éƒ¨ CSR&quot;">â€‹</a></h3><p><strong>æè¿°</strong>ï¼šé¡µé¢æ•´ä½“ SSRï¼Œä½† AB å®éªŒåŒºå—ç”¨ CSR</p><p><strong>æµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>é¡µé¢ç»“æ„ï¼ˆSSRï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>AB å®éªŒåŒºå—ï¼ˆCSRï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å®¢æˆ·ç«¯æ¸²æŸ“è¯¥åŒºå—</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>âœ… å¤§éƒ¨åˆ†å†…å®¹ SSR</li><li>âœ… AB åŒºå—æ— ç¼“å­˜é—®é¢˜</li></ul><p><strong>å¼Šç«¯</strong>ï¼š</p><table tabindex="0"><thead><tr><th>å½±å“</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>SEO</strong></td><td>AB åŒºå—ä¸æ”¯æŒ SEO</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>CSR åŒºå—æ¸²æŸ“æ…¢</td></tr><tr><td><strong>é—ªçƒ</strong></td><td>åŒºå—å»¶è¿ŸåŠ è½½</td></tr></tbody></table><p><strong>ç»“è®º</strong>ï¼šâŒ ä¸æ¨è</p><h3 id="_5-5-æ–¹æ¡ˆå¯¹æ¯”" tabindex="-1">5.5 æ–¹æ¡ˆå¯¹æ¯” <a class="header-anchor" href="#_5-5-æ–¹æ¡ˆå¯¹æ¯”" aria-label="Permalink to &quot;5.5 æ–¹æ¡ˆå¯¹æ¯”&quot;">â€‹</a></h3><table tabindex="0"><thead><tr><th>æ–¹æ¡ˆ</th><th>SEO</th><th>æ€§èƒ½</th><th>å¤æ‚åº¦</th><th>æ¨è</th></tr></thead><tbody><tr><td><strong>æœ¬ RFC æ–¹æ¡ˆ</strong></td><td>âœ…</td><td>âœ…</td><td>ä¸­</td><td>ğŸ¯ æ¨è</td></tr><tr><td><strong>A: CSR</strong></td><td>âŒ</td><td>âŒ</td><td>ä½</td><td>âŒ</td></tr><tr><td><strong>B: æ— ç¼“å­˜</strong></td><td>âœ…</td><td>âŒ</td><td>ä½</td><td>âŒ</td></tr><tr><td><strong>C: ä»…ç™»å½•å</strong></td><td>âœ…</td><td>âœ…</td><td>ä½</td><td>âš ï¸ å¤‡é€‰</td></tr><tr><td><strong>D: å±€éƒ¨ CSR</strong></td><td>âš ï¸</td><td>âš ï¸</td><td>ä¸­</td><td>âŒ</td></tr></tbody></table><hr><h2 id="å…­ã€å¾…è®¨è®ºçš„é—®é¢˜" tabindex="-1">å…­ã€å¾…è®¨è®ºçš„é—®é¢˜ <a class="header-anchor" href="#å…­ã€å¾…è®¨è®ºçš„é—®é¢˜" aria-label="Permalink to &quot;å…­ã€å¾…è®¨è®ºçš„é—®é¢˜&quot;">â€‹</a></h2><h3 id="_6-1-é—®é¢˜-1-ç¼“å­˜æ—¶æ•ˆæ€§" tabindex="-1">6.1 é—®é¢˜ 1ï¼šç¼“å­˜æ—¶æ•ˆæ€§ <a class="header-anchor" href="#_6-1-é—®é¢˜-1-ç¼“å­˜æ—¶æ•ˆæ€§" aria-label="Permalink to &quot;6.1 é—®é¢˜ 1ï¼šç¼“å­˜æ—¶æ•ˆæ€§&quot;">â€‹</a></h3><p><strong>é—®é¢˜</strong>ï¼š</p><blockquote><p>é¡µé¢ä¸ AB å®éªŒé…ç½®æ¥å£å‡å­˜åœ¨ç¼“å­˜ï¼Œè¿™è¿›ä¸€æ­¥é™ä½äº†æ—¶æ•ˆæ€§ï¼Œæ˜¯å¦åº”å½“ç‰¹æ®Šå¤„ç†ï¼Ÿ</p></blockquote><p><strong>åˆ†æ</strong>ï¼š</p><p><strong>ç¼“å­˜é“¾</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>AB é…ç½®æ¥å£ç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰</span></span>
<span class="line"><span>   +</span></span>
<span class="line"><span>é¡µé¢ç¼“å­˜ï¼ˆ10åˆ†é’Ÿï¼‰</span></span>
<span class="line"><span>   =</span></span>
<span class="line"><span>æœ€é•¿ 15 åˆ†é’Ÿçš„å»¶è¿Ÿ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>å¯¹æ¯”å…¶ä»–å†…å®¹</strong>ï¼š</p><table tabindex="0"><thead><tr><th>å†…å®¹ç±»å‹</th><th>ç¼“å­˜æ—¶é—´</th><th>æ—¶æ•ˆæ€§è¦æ±‚</th></tr></thead><tbody><tr><td><strong>AB å®éªŒ</strong></td><td>5-10 åˆ†é’Ÿ</td><td>âš ï¸ ä¸­</td></tr><tr><td><strong>ä¸ªæ€§åŒ–æ¨è</strong></td><td>1-10 åˆ†é’Ÿ</td><td>âš ï¸ ä¸­</td></tr><tr><td><strong>CMS å†…å®¹</strong></td><td>10 åˆ†é’Ÿ</td><td>âš ï¸ ä¸­</td></tr><tr><td><strong>å®æ—¶æ•°æ®</strong></td><td>0 åˆ†é’Ÿ</td><td>ğŸ”´ é«˜</td></tr></tbody></table><p><strong>ç»“è®º</strong>ï¼š</p><blockquote><p><strong>æ— éœ€ç‰¹æ®Šå¤„ç†</strong></p></blockquote><p><strong>ç†ç”±</strong>ï¼š</p><ul><li>âœ… AB å®éªŒå’Œ CMS å†…å®¹çš„æ—¶æ•ˆæ€§è¦æ±‚ç±»ä¼¼</li><li>âœ… æ— æ³•åŒæ—¶æ»¡è¶³ï¼šæ—¶æ•ˆæ€§ + é€Ÿåº¦ + ç¨³å®šæ€§</li><li>âœ… 10 åˆ†é’Ÿæ˜¯å¯è¢«æ¥å—çš„å¹³è¡¡ç‚¹</li></ul><p><strong>ç°æœ‰ç¼“å­˜ç­–ç•¥</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç™»å½•å‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Cache</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Control</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: max</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">age</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">600</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, stale</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-while-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">revalidate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">604800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, stale</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-if-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">error</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">604800</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç™»å½•å</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Cache</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Control</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: max</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">age</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, stale</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-while-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">revalidate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">604800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, stale</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-if-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">error</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">604800</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>ç­–ç•¥è¯´æ˜</strong>ï¼š</p><table tabindex="0"><thead><tr><th>å‚æ•°</th><th>å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>max-age</code></td><td>600s / 60s</td><td>ç¼“å­˜æœ‰æ•ˆæœŸ</td></tr><tr><td><code>stale-while-revalidate</code></td><td>604800s (7å¤©)</td><td>åå°æ›´æ–°æ—¶è¿”å›æ—§ç¼“å­˜</td></tr><tr><td><code>stale-if-error</code></td><td>604800s (7å¤©)</td><td>é”™è¯¯æ—¶è¿”å›æ—§ç¼“å­˜</td></tr></tbody></table><p><strong>å‚è€ƒ</strong>ï¼š[Meta SSR å…³äºç¼“å­˜çš„ä¸€åˆ‡]</p><h3 id="_6-2-é—®é¢˜-2-ç¼“å­˜ç¢ç‰‡åŒ–" tabindex="-1">6.2 é—®é¢˜ 2ï¼šç¼“å­˜ç¢ç‰‡åŒ– <a class="header-anchor" href="#_6-2-é—®é¢˜-2-ç¼“å­˜ç¢ç‰‡åŒ–" aria-label="Permalink to &quot;6.2 é—®é¢˜ 2ï¼šç¼“å­˜ç¢ç‰‡åŒ–&quot;">â€‹</a></h3><p><strong>é—®é¢˜</strong>ï¼š</p><blockquote><p>éšç€æ¥å£å®éªŒæ•°é‡çš„å¢åŠ ï¼Œç¼“å­˜å‘½ä¸­ç‡ä¼šæ€¥å‰§ä¸‹æ»‘ï¼Œæœ€ç»ˆé™ä½äº†ç«™ç‚¹é€Ÿåº¦ï¼Œä½“éªŒä¸‹é™ä¹Ÿä¼šç»™è½¬åŒ–ç‡å¸¦æ¥è´Ÿé¢å½±å“ï¼Œæˆ‘ä»¬åº”å½“å¦‚ä½•å¹³è¡¡ï¼Ÿ</p></blockquote><p><strong>ç°çŠ¶æ•°æ®</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æˆªæ­¢ RFC åˆ›å»ºæ—¶é—´ï¼š</span></span>
<span class="line"><span>- çº¿ä¸Šè¿è¡Œäº† 7 ä¸ªæ¥å£å®éªŒ</span></span>
<span class="line"><span>- å¸¦æ¥ 2^7 = 128 ä¸ªç¼“å­˜ç‰ˆæœ¬ âŒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="`+t+`" alt="å®éªŒè¿è¡Œæ—¶é•¿"></p><p><strong>é—®é¢˜åˆ†æ</strong>ï¼š</p><table tabindex="0"><thead><tr><th>å®éªŒæ•°</th><th>ç¼“å­˜ç‰ˆæœ¬æ•°</th><th>ç¼“å­˜å‘½ä¸­ç‡</th><th>å½±å“</th></tr></thead><tbody><tr><td>1</td><td>2</td><td>50%</td><td>âœ… å¯æ¥å—</td></tr><tr><td>2</td><td>4</td><td>25%</td><td>âœ… å¯æ¥å—</td></tr><tr><td>3</td><td>8</td><td>12.5%</td><td>âš ï¸ å¼€å§‹ä¸‹é™</td></tr><tr><td>5</td><td>32</td><td>3.1%</td><td>ğŸ”´ ä¸¥é‡ä¸‹é™</td></tr><tr><td>7</td><td>128</td><td>0.78%</td><td>ğŸ”´ å‡ ä¹æ— æ•ˆ</td></tr></tbody></table><p><strong>æ›´ä¸¥é‡çš„é—®é¢˜</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è§‚å¯Ÿï¼šæœ‰äº›å®éªŒè¶…è¿‡äº† 1 å¹´çš„æ—¶é—´ âŒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>å½±å“</strong>ï¼š</p><ul><li>ğŸ”´ é•¿æœŸå®éªŒå ç”¨ç¼“å­˜èµ„æº</li><li>ğŸ”´ æ–°å®éªŒçš„ç¼“å­˜è¢«æŒ¤å‹</li><li>ğŸ”´ æ•´ä½“å‘½ä¸­ç‡ä¸‹é™</li></ul><p><strong>è§£å†³æ–¹æ¡ˆè®¨è®º</strong>ï¼š</p><p><strong>æ–¹æ¡ˆ Aï¼šå®éªŒç”Ÿå‘½å‘¨æœŸç®¡ç†</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®éªŒé…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  experimentId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;exp001&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  startDate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-01-01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  endDate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-01-31&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// â† å¼ºåˆ¶ç»“æŸæ—¶é—´</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;running&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®šæœŸæ¸…ç†</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cleanupExpiredExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> now</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> experiments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getActiveExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> exp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> experiments) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (exp.endDate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> archiveExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(exp.id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Archived expired experiment: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">exp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>æ–¹æ¡ˆ Bï¼šå®éªŒæ•°é‡é™åˆ¶</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç¡¬æ€§é™åˆ¶ï¼šåŒæ—¶è¿è¡Œçš„å®éªŒä¸è¶…è¿‡ 3 ä¸ª</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ç¼“å­˜ç‰ˆæœ¬æ•°ï¼š2^3 = 8</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ç¼“å­˜å‘½ä¸­ç‡ï¼š12.5% (å¯æ¥å—)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>æ–¹æ¡ˆ Cï¼šå®éªŒä¼˜å…ˆçº§</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é«˜ä¼˜å…ˆçº§å®éªŒä½¿ç”¨ AB ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½ä¼˜å…ˆçº§å®éªŒä½¿ç”¨å®¢æˆ·ç«¯ AB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  experimentId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;homepage_redesign&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  priority</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;high&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// â† SSR AB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  cacheStrategy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;server&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  experimentId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;button_color&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  priority</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;low&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// â† CSR AB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  cacheStrategy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;client&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>æ¨èç­–ç•¥</strong>ï¼š</p><ol><li><p>âœ… <strong>å®éªŒç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼ˆå¿…é¡»ï¼‰</p><ul><li>å¼ºåˆ¶è®¾ç½®ç»“æŸæ—¶é—´</li><li>å®šæœŸæ¸…ç†è¿‡æœŸå®éªŒ</li></ul></li><li><p>âœ… <strong>å®éªŒæ•°é‡æ§åˆ¶</strong>ï¼ˆå»ºè®®ï¼‰</p><ul><li>åŒæ—¶è¿è¡Œ â‰¤ 3 ä¸ªå®éªŒ</li><li>éœ€è¦å®¡æ‰¹æµç¨‹</li></ul></li><li><p>âœ… <strong>å®éªŒä¼˜å…ˆçº§</strong>ï¼ˆä¼˜åŒ–ï¼‰</p><ul><li>æ ¸å¿ƒå®éªŒç”¨ SSR AB</li><li>æ¬¡è¦å®éªŒç”¨ CSR AB</li></ul></li></ol><h3 id="_6-3-é—®é¢˜-3-æœç´¢å¼•æ“çˆ¬è™«" tabindex="-1">6.3 é—®é¢˜ 3ï¼šæœç´¢å¼•æ“çˆ¬è™« <a class="header-anchor" href="#_6-3-é—®é¢˜-3-æœç´¢å¼•æ“çˆ¬è™«" aria-label="Permalink to &quot;6.3 é—®é¢˜ 3ï¼šæœç´¢å¼•æ“çˆ¬è™«&quot;">â€‹</a></h3><p><strong>é—®é¢˜</strong>ï¼š</p><blockquote><p>æœç´¢å¼•æ“çˆ¬è™«æ˜¯å¦ä¹Ÿåº”å½“å‚ä¸ AB å®éªŒï¼Ÿ</p></blockquote><p><strong>åˆ†æ</strong>ï¼š</p><p><strong>é€‰é¡¹ Aï¼šçˆ¬è™«ä¸å‚ä¸ AB</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ£€æµ‹çˆ¬è™«</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isCrawler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">userAgent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">googlebot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">bingbot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">baiduspider</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userAgent);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// çˆ¬è™«è·³è¿‡ AB</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isCrawler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user-agent&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è¿”å›é»˜è®¤ç‰ˆæœ¬ï¼ˆæ—  ABï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> renderDefault</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>é£é™©</strong>ï¼š</p><ul><li>ğŸ”´ å¯èƒ½è¢«åˆ¤å®šä¸º&quot;ä½œå¼Š&quot;ï¼ˆCloakingï¼‰</li><li>ğŸ”´ SEO æ’åå—å½±å“</li></ul><p><strong>é€‰é¡¹ Bï¼šçˆ¬è™«å‚ä¸ AB</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// çˆ¬è™«ä¹Ÿåˆ†é… AB ç»„</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.cookies[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                 calculateABForCrawler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user-agent&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>å¥½å¤„</strong>ï¼š</p><ul><li>âœ… ä¸ä¼šè¢«åˆ¤å®šä½œå¼Š</li><li>âœ… SEO å®‰å…¨</li></ul><p><strong>é—®é¢˜</strong>ï¼š</p><ul><li>âš ï¸ ä¸åŒçˆ¬è™«å¯èƒ½çœ‹åˆ°ä¸åŒç‰ˆæœ¬</li><li>âš ï¸ åŒä¸€çˆ¬è™«å¤šæ¬¡è®¿é—®å¯èƒ½çœ‹åˆ°ä¸åŒç‰ˆæœ¬</li></ul><p><strong>ç»“è®º</strong>ï¼š</p><blockquote><p><strong>çˆ¬è™«åº”å½“å‚ä¸ AB å®éªŒ</strong></p></blockquote><p><strong>ç¡®è®¤æ¥æº</strong>ï¼šå·²ä¸ @æœªçŸ¥ç”¨æˆ· (junyuxian) ç¡®è®¤</p><p><strong>å®æ–½ç­–ç•¥</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸ºçˆ¬è™«å›ºå®šåˆ†é… AB ç»„</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABGroupForCrawler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">userAgent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // åŒä¸€çˆ¬è™«å§‹ç»ˆåˆ†é…åˆ°ç›¸åŒç»„</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> crawlerType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> detectCrawlerType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userAgent);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(crawlerType) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;variant_a&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;variant_b&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr><h2 id="ä¸ƒã€æœªæ¥çš„å¯èƒ½æ€§" tabindex="-1">ä¸ƒã€æœªæ¥çš„å¯èƒ½æ€§ <a class="header-anchor" href="#ä¸ƒã€æœªæ¥çš„å¯èƒ½æ€§" aria-label="Permalink to &quot;ä¸ƒã€æœªæ¥çš„å¯èƒ½æ€§&quot;">â€‹</a></h2><h3 id="_7-1-å®¢æˆ·ç«¯ç¼“å­˜éªŒè¯" tabindex="-1">7.1 å®¢æˆ·ç«¯ç¼“å­˜éªŒè¯ <a class="header-anchor" href="#_7-1-å®¢æˆ·ç«¯ç¼“å­˜éªŒè¯" aria-label="Permalink to &quot;7.1 å®¢æˆ·ç«¯ç¼“å­˜éªŒè¯&quot;">â€‹</a></h3><p><strong>æè®®</strong>ï¼šåœ¨ã€ŒæœåŠ¡ç«¯ç¼“å­˜ä¼˜å…ˆã€çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ã€Œå®¢æˆ·ç«¯é‡æ–°ç¼“å­˜éªŒè¯ã€</p><p><strong>å·¥ä½œæµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šæœåŠ¡ç«¯è¿”å›ç¼“å­˜é¡µé¢</span></span>
<span class="line"><span>   +</span></span>
<span class="line"><span>   å¸¦æ—¶é—´æˆ³</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šæµè§ˆå™¨æ˜¾ç¤ºé¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>   JavaScript æ£€æŸ¥æ—¶é—´æˆ³</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šå¦‚æœè¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 5 åˆ†é’Ÿï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>   å¼‚æ­¥è¯·æ±‚æœ€æ–°æ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 4ï¼šå¯¹æ¯”æ•°æ®</span></span>
<span class="line"><span>   â”œâ”€ æ•°æ®æœªå˜åŒ– â†’ æ— æ“ä½œ</span></span>
<span class="line"><span>   â””â”€ æ•°æ®å·²å˜åŒ– â†’ å±€éƒ¨æ›´æ–° UI</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>å®ç°ç¤ºä¾‹</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é¡µé¢ä¸­åµŒå…¥æ—¶é—´æˆ³</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">window.__SSR_TIMESTAMP__ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1704096000000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®¢æˆ·ç«¯éªŒè¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> validateCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> now</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> age</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.__SSR_TIMESTAMP__;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¶…è¿‡ 5 åˆ†é’Ÿ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> latestData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/validate-cache&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (latestData.version </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.__DATA_VERSION__) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // æ•°æ®å·²æ›´æ–°ï¼Œå±€éƒ¨åˆ·æ–°</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      updateUI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(latestData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é¡µé¢åŠ è½½åæ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onMounted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(validateCache);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>âœ… æé«˜æ•°æ®æ—¶æ•ˆæ€§</li><li>âœ… ä¿æŒç¼“å­˜æ€§èƒ½</li><li>âœ… æ¸è¿›å¼å¢å¼º</li></ul><p><strong>æŒ‘æˆ˜</strong>ï¼š</p><ul><li>âš ï¸ å¢åŠ å¤æ‚åº¦</li><li>âš ï¸ å¯èƒ½å¼•èµ·å†…å®¹é—ªçƒ</li><li>âš ï¸ éœ€è¦ä»”ç»†è®¾è®¡</li></ul><hr><h2 id="å…«ã€æ€»ç»“" tabindex="-1">å…«ã€æ€»ç»“ <a class="header-anchor" href="#å…«ã€æ€»ç»“" aria-label="Permalink to &quot;å…«ã€æ€»ç»“&quot;">â€‹</a></h2><h3 id="_8-1-æ ¸å¿ƒä»·å€¼" tabindex="-1">8.1 æ ¸å¿ƒä»·å€¼ <a class="header-anchor" href="#_8-1-æ ¸å¿ƒä»·å€¼" aria-label="Permalink to &quot;8.1 æ ¸å¿ƒä»·å€¼&quot;">â€‹</a></h3><p><strong>æŠ€æœ¯ä»·å€¼</strong>ï¼š</p><ul><li>âœ… AB å®éªŒåœ¨ SSR ä¸­æ­£ç¡®å·¥ä½œ</li><li>âœ… æœåŠ¡ç«¯å®¢æˆ·ç«¯çŠ¶æ€ä¸€è‡´</li><li>âœ… é¿å…å†…å®¹é—ªçƒ</li></ul><p><strong>ä¸šåŠ¡ä»·å€¼</strong>ï¼š</p><ul><li>âœ… æå‡ç”¨æˆ·ä½“éªŒ</li><li>âœ… æ”¯æŒ SEO</li><li>âœ… ä¿æŒç½‘ç«™æ€§èƒ½</li></ul><h3 id="_8-2-å…³é”®è¦ç‚¹" tabindex="-1">8.2 å…³é”®è¦ç‚¹ <a class="header-anchor" href="#_8-2-å…³é”®è¦ç‚¹" aria-label="Permalink to &quot;8.2 å…³é”®è¦ç‚¹&quot;">â€‹</a></h3><p><strong>å¿…é¡»å®æ–½</strong>ï¼š</p><ol><li>âœ… AB SDK é€‚é… SSR</li><li>âœ… AB ç»„çº³å…¥ Cache Key</li><li>âœ… Cookie ç¼“å­˜ AB ç»„</li></ol><p><strong>éœ€è¦ç®¡ç†</strong>ï¼š</p><ol><li>âš ï¸ æ§åˆ¶å®éªŒæ•°é‡ï¼ˆâ‰¤ 3ï¼‰</li><li>âš ï¸ å®éªŒç”Ÿå‘½å‘¨æœŸç®¡ç†</li><li>âš ï¸ ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡</li></ol><h3 id="_8-3-ä¸‹ä¸€æ­¥" tabindex="-1">8.3 ä¸‹ä¸€æ­¥ <a class="header-anchor" href="#_8-3-ä¸‹ä¸€æ­¥" aria-label="Permalink to &quot;8.3 ä¸‹ä¸€æ­¥&quot;">â€‹</a></h3><p><strong>åç»­ RFC</strong>ï¼š</p><ul><li><a href="./10-ABå®éªŒ-RFC12.2-SSRåœºæ™¯ä¸‹çš„ABå®éªŒæ•°æ®è·å–ä¼˜åŒ–">RFC 12.2: AB å®éªŒæ•°æ®è·å–ä¼˜åŒ–</a></li><li><a href="./11-ABå®éªŒ-RFC12.3-æé«˜ABç¼“å­˜å‘½ä¸­ç‡">RFC 12.3: æé«˜ AB ç¼“å­˜å‘½ä¸­ç‡</a></li><li><a href="./12-ABå®éªŒ-RFC12.4-ABæ”¯æŒèŠ±ç“£æœåŠ¡ç«¯">RFC 12.4: AB æ”¯æŒèŠ±ç“£æœåŠ¡ç«¯</a></li></ul><hr><p><strong>æ–‡æ¡£ç»´æŠ¤</strong>ï¼šå‰ç«¯åŸºå»ºå›¢é˜Ÿ<br><strong>RFC ä½œè€…</strong>ï¼šå‰ç«¯æ¶æ„ç»„<br><strong>æ•´ç†æ—¥æœŸ</strong>ï¼š2025-01-25<br><strong>æ–‡æ¡£ç‰ˆæœ¬</strong>ï¼šv1.0</p>`,238)]))}const u=a(r,[["render",h]]);export{o as __pageData,u as default};
