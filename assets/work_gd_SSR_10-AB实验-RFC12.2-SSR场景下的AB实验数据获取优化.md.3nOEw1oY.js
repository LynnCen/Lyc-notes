import{_ as a,c as n,o as i,a7 as p}from"./chunks/framework.BQb8NfN9.js";const c=JSON.parse('{"title":"RFC 12.2: SSR åœºæ™¯ä¸‹çš„ AB å®éªŒæ•°æ®è·å–ä¼˜åŒ–","description":"","frontmatter":{},"headers":[],"relativePath":"work/gd/SSR/10-ABå®éªŒ-RFC12.2-SSRåœºæ™¯ä¸‹çš„ABå®éªŒæ•°æ®è·å–ä¼˜åŒ–.md","filePath":"work/gd/SSR/10-ABå®éªŒ-RFC12.2-SSRåœºæ™¯ä¸‹çš„ABå®éªŒæ•°æ®è·å–ä¼˜åŒ–.md","lastUpdated":1770085732000}'),l={name:"work/gd/SSR/10-ABå®éªŒ-RFC12.2-SSRåœºæ™¯ä¸‹çš„ABå®éªŒæ•°æ®è·å–ä¼˜åŒ–.md"};function e(t,s,h,r,k,d){return i(),n("div",null,s[0]||(s[0]=[p(`<h1 id="rfc-12-2-ssr-åœºæ™¯ä¸‹çš„-ab-å®éªŒæ•°æ®è·å–ä¼˜åŒ–" tabindex="-1">RFC 12.2: SSR åœºæ™¯ä¸‹çš„ AB å®éªŒæ•°æ®è·å–ä¼˜åŒ– <a class="header-anchor" href="#rfc-12-2-ssr-åœºæ™¯ä¸‹çš„-ab-å®éªŒæ•°æ®è·å–ä¼˜åŒ–" aria-label="Permalink to &quot;RFC 12.2: SSR åœºæ™¯ä¸‹çš„ AB å®éªŒæ•°æ®è·å–ä¼˜åŒ–&quot;">â€‹</a></h1><blockquote><p><strong>æ–‡æ¡£æ¥æº</strong><br> Confluence: <a href="https://doc.huanleguang.com/pages/viewpage.action?pageId=427264426" target="_blank" rel="noreferrer">https://doc.huanleguang.com/pages/viewpage.action?pageId=427264426</a></p></blockquote><hr><h2 id="æ–‡æ¡£æ¦‚è¿°" tabindex="-1">æ–‡æ¡£æ¦‚è¿° <a class="header-anchor" href="#æ–‡æ¡£æ¦‚è¿°" aria-label="Permalink to &quot;æ–‡æ¡£æ¦‚è¿°&quot;">â€‹</a></h2><p>æœ¬ RFC é’ˆå¯¹ <strong><a href="./09-ABå®éªŒ-RFC12.1-SSRåœºæ™¯ä¸‹çš„ABå®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›">RFC 12.1</a> æ–¹æ¡ˆåœ¨è½åœ°è¿‡ç¨‹ä¸­æš´éœ²çš„é—®é¢˜</strong>ï¼Œæå‡ºäº†ä¼˜åŒ–æ–¹æ¡ˆã€‚</p><p><strong>æ ¸å¿ƒç›®æ ‡</strong>ï¼š</p><ul><li>ğŸ¯ è§£å†³ HTTP Header è¿‡å¤§é—®é¢˜</li><li>ğŸ”„ ç»Ÿä¸€ SSR å’Œ CSR çš„ AB æ•°æ®</li><li>ğŸ‘¤ æ”¯æŒç”¨æˆ·ç™½åå•å®æ—¶ç”Ÿæ•ˆ</li><li>ğŸ’¾ æé«˜ç¼“å­˜å‘½ä¸­ç‡</li></ul><p><strong>ç›¸å…³æ–‡æ¡£</strong>ï¼š</p><ul><li>å‰ç½®ï¼š<a href="./09-ABå®éªŒ-RFC12.1-SSRåœºæ™¯ä¸‹çš„ABå®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›">RFC 12.1: SSR åœºæ™¯ä¸‹çš„ AB å®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›</a></li><li>åç»­ï¼š<a href="./11-ABå®éªŒ-RFC12.3-æé«˜ABç¼“å­˜å‘½ä¸­ç‡">RFC 12.3: æé«˜ AB ç¼“å­˜å‘½ä¸­ç‡</a></li><li>å…³è”ï¼š<a href="https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=416714342" target="_blank" rel="noreferrer">CDN Worker ABtestæ–¹æ¡ˆ</a></li></ul><hr><h2 id="ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜" tabindex="-1">ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜ <a class="header-anchor" href="#ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜" aria-label="Permalink to &quot;ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜&quot;">â€‹</a></h2><h3 id="_1-1-rfc-12-1-æ–¹æ¡ˆå›é¡¾" tabindex="-1">1.1 RFC 12.1 æ–¹æ¡ˆå›é¡¾ <a class="header-anchor" href="#_1-1-rfc-12-1-æ–¹æ¡ˆå›é¡¾" aria-label="Permalink to &quot;1.1 RFC 12.1 æ–¹æ¡ˆå›é¡¾&quot;">â€‹</a></h3><p><strong>RFC 12.1 çš„æ ¸å¿ƒæ–¹æ¡ˆ</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šWorker è·å– AB æ•°æ®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šé€šè¿‡ HTTP Header é€ä¼ ç»™ SSR</span></span>
<span class="line"><span>   Header: x-ab-test-list: {&quot;exp1&quot;:&quot;a&quot;,&quot;exp2&quot;:&quot;b&quot;,...}</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šSSR ä½¿ç”¨ AB æ•°æ®æ¸²æŸ“é¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ­¥éª¤ 4ï¼šå°† AB ç»„ ID å­˜å…¥ Cookie</span></span>
<span class="line"><span>   Cookie: x-ab-test-id = abc123</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>è®¾è®¡æ€è·¯</strong>ï¼š</p><ul><li>âœ… å°†å®Œæ•´çš„ AB æ•°æ®é€šè¿‡ Header ä¼ é€’</li><li>âœ… SSR ç›´æ¥ä» Header è¯»å–</li><li>âœ… é¿å… SSR é‡å¤è¯·æ±‚ AB æ¥å£</li></ul><h3 id="_1-2-é‡åˆ°çš„é—®é¢˜" tabindex="-1">1.2 é‡åˆ°çš„é—®é¢˜ <a class="header-anchor" href="#_1-2-é‡åˆ°çš„é—®é¢˜" aria-label="Permalink to &quot;1.2 é‡åˆ°çš„é—®é¢˜&quot;">â€‹</a></h3><p>åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒRFC 12.1 æ–¹æ¡ˆæš´éœ²äº† <strong>4 ä¸ªå…³é”®é—®é¢˜</strong>ï¼š</p><h4 id="é—®é¢˜-1-http-header-è¿‡å¤§-ğŸ”´" tabindex="-1">é—®é¢˜ 1ï¼šHTTP Header è¿‡å¤§ ğŸ”´ <a class="header-anchor" href="#é—®é¢˜-1-http-header-è¿‡å¤§-ğŸ”´" aria-label="Permalink to &quot;é—®é¢˜ 1ï¼šHTTP Header è¿‡å¤§ ğŸ”´&quot;">â€‹</a></h4><p><strong>ç°è±¡</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Worker è·å–çš„ AB æ•°æ® â†’ åºåˆ—åŒ–ä¸º JSON â†’ æ”¾å…¥ Header</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>Header: x-ab-test-list: {&quot;exp1&quot;:&quot;a&quot;, &quot;exp2&quot;:&quot;b&quot;, ...}</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å½“å®éªŒæ•°é‡å¢åŠ æ—¶ï¼ŒHeader å¯èƒ½è¶…è¿‡ 8KB</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ è¯·æ±‚å¤±è´¥ï¼ˆHTTP 413 æˆ–è¢«æ‹’ç»ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>æ•°æ®ç¤ºä¾‹</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 10 ä¸ªå®éªŒçš„ AB æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;homepage_layout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;template_list_style&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;editor_toolbar&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_c&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;search_algorithm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;recommendation_engine&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;user_profile_ui&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;payment_flow&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;onboarding_process&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_c&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;notification_center&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;workspace_layout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_b&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JSON åºåˆ—åŒ–åå¯èƒ½è¾¾åˆ°æ•° KB</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>å½±å“</strong>ï¼š</p><ul><li>ğŸ”´ å®éªŒæ•°é‡å—é™</li><li>ğŸ”´ å¯èƒ½å¯¼è‡´æ¥å£å¤±è´¥</li><li>ğŸ”´ å½±å“ç¨³å®šæ€§</li></ul><h4 id="é—®é¢˜-2-ssr-å’Œ-csr-çš„-ab-ä¸ä¸€è‡´-ğŸ”´" tabindex="-1">é—®é¢˜ 2ï¼šSSR å’Œ CSR çš„ AB ä¸ä¸€è‡´ ğŸ”´ <a class="header-anchor" href="#é—®é¢˜-2-ssr-å’Œ-csr-çš„-ab-ä¸ä¸€è‡´-ğŸ”´" aria-label="Permalink to &quot;é—®é¢˜ 2ï¼šSSR å’Œ CSR çš„ AB ä¸ä¸€è‡´ ğŸ”´&quot;">â€‹</a></h4><p><strong>ç°è±¡</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SSR é˜¶æ®µï¼š</span></span>
<span class="line"><span>   â”œâ”€ Worker è·å– AB æ•°æ®</span></span>
<span class="line"><span>   â”œâ”€ é€šè¿‡ Header ä¼ ç»™ SSR</span></span>
<span class="line"><span>   â””â”€ SSR æ¸²æŸ“ï¼ˆAB ç‰ˆæœ¬ Aï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CSR é˜¶æ®µï¼š</span></span>
<span class="line"><span>   â”œâ”€ æµè§ˆå™¨ JS ç‹¬ç«‹è·å– AB æ•°æ®</span></span>
<span class="line"><span>   â”œâ”€ å¯èƒ½è·å–åˆ°ä¸åŒçš„æ•°æ®</span></span>
<span class="line"><span>   â””â”€ CSR æ¸²æŸ“ï¼ˆAB ç‰ˆæœ¬ Bï¼‰âŒ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç»“æœï¼šæ°´åˆå¤±è´¥æˆ–å†…å®¹ä¸ä¸€è‡´</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>æ ¹æœ¬åŸå› </strong>ï¼š</p><table tabindex="0"><thead><tr><th>é˜¶æ®µ</th><th>AB æ•°æ®æ¥æº</th><th>æ—¶é—´</th><th>å¯èƒ½çš„ç»“æœ</th></tr></thead><tbody><tr><td><strong>SSR</strong></td><td>Worker è·å–</td><td>T1</td><td>ç‰ˆæœ¬ A</td></tr><tr><td><strong>CSR</strong></td><td>æµè§ˆå™¨è·å–</td><td>T2</td><td>ç‰ˆæœ¬ Bï¼ˆå¦‚æœå®éªŒé…ç½®å˜äº†ï¼‰</td></tr></tbody></table><p><strong>å½±å“</strong>ï¼š</p><ul><li>ğŸ”´ SSR å’Œ CSR çŠ¶æ€ä¸ä¸€è‡´</li><li>ğŸ”´ å¯èƒ½å¯¼è‡´æ°´åˆå¤±è´¥</li><li>ğŸ”´ ç”¨æˆ·çœ‹åˆ°å†…å®¹é—ªçƒ</li></ul><h4 id="é—®é¢˜-3-ç”¨æˆ·ç™½åå•ä¸èƒ½å®æ—¶ç”Ÿæ•ˆ-âš ï¸" tabindex="-1">é—®é¢˜ 3ï¼šç”¨æˆ·ç™½åå•ä¸èƒ½å®æ—¶ç”Ÿæ•ˆ âš ï¸ <a class="header-anchor" href="#é—®é¢˜-3-ç”¨æˆ·ç™½åå•ä¸èƒ½å®æ—¶ç”Ÿæ•ˆ-âš ï¸" aria-label="Permalink to &quot;é—®é¢˜ 3ï¼šç”¨æˆ·ç™½åå•ä¸èƒ½å®æ—¶ç”Ÿæ•ˆ âš ï¸&quot;">â€‹</a></h4><p><strong>åœºæ™¯</strong>ï¼šæ ¹æ®ç”¨æˆ· ID è®¾ç½®çš„ç™½åå•</p><p><strong>é—®é¢˜æµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šç”¨æˆ·æœªç™»å½•è®¿é—®é¦–é¡µ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>è·å– AB æ•°æ®ï¼ˆæ¸¸å®¢èº«ä»½ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ab-test-id = abc123ï¼ˆç¼“å­˜ 30 åˆ†é’Ÿï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šç”¨æˆ·ç™»å½•</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ç”¨æˆ· ID: 12345ï¼ˆåœ¨ç™½åå•ä¸­ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ä½† Cookie ä¸­çš„ ab-test-id ä»æ˜¯ abc123</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ ç™½åå•ç­–ç•¥ä¸ç”Ÿæ•ˆï¼ˆéœ€ç­‰ 30 åˆ†é’Ÿï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼š30 åˆ†é’Ÿå Cookie è¿‡æœŸ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>é‡æ–°è·å– AB æ•°æ®ï¼ˆå·²ç™»å½•ç”¨æˆ·ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âœ… ç™½åå•ç­–ç•¥ç”Ÿæ•ˆ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>å½±å“</strong>ï¼š</p><ul><li>âš ï¸ ç™½åå•ç”¨æˆ·ä½“éªŒä¸ä½³</li><li>âš ï¸ æµ‹è¯•å’Œè°ƒè¯•å›°éš¾</li><li>âš ï¸ è¿è¥ç­–ç•¥æ»å</li></ul><h4 id="é—®é¢˜-4-ç¼“å­˜å‘½ä¸­ç‡é™ä½-âš ï¸" tabindex="-1">é—®é¢˜ 4ï¼šç¼“å­˜å‘½ä¸­ç‡é™ä½ âš ï¸ <a class="header-anchor" href="#é—®é¢˜-4-ç¼“å­˜å‘½ä¸­ç‡é™ä½-âš ï¸" aria-label="Permalink to &quot;é—®é¢˜ 4ï¼šç¼“å­˜å‘½ä¸­ç‡é™ä½ âš ï¸&quot;">â€‹</a></h4><p><strong>ç°è±¡</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ab-test-id ç¼“å­˜ 30 åˆ†é’Ÿ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>30 åˆ†é’Ÿå Cookie è¿‡æœŸ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ç”¨æˆ·åˆ·æ–°é¡µé¢</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>é‡æ–°è·å– AB æ•°æ®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å¯èƒ½åˆ†é…åˆ°ä¸åŒçš„ AB ç»„</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ab-test-id æ”¹å˜</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ä¹‹å‰çš„é¡µé¢ç¼“å­˜å¤±æ•ˆ âŒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>æ•°æ®å½±å“</strong>ï¼š</p><table tabindex="0"><thead><tr><th>æ—¶é—´</th><th>ab-test-id</th><th>ç¼“å­˜çŠ¶æ€</th></tr></thead><tbody><tr><td>0 åˆ†é’Ÿ</td><td>abc123</td><td>åˆ›å»ºç¼“å­˜</td></tr><tr><td>10 åˆ†é’Ÿ</td><td>abc123</td><td>å‘½ä¸­ç¼“å­˜ âœ…</td></tr><tr><td>20 åˆ†é’Ÿ</td><td>abc123</td><td>å‘½ä¸­ç¼“å­˜ âœ…</td></tr><tr><td>31 åˆ†é’Ÿ</td><td>def456</td><td>æœªå‘½ä¸­ï¼ˆID å˜äº†ï¼‰âŒ</td></tr></tbody></table><p><strong>å½±å“</strong>ï¼š</p><ul><li>âš ï¸ é¡µé¢ç¼“å­˜åˆ©ç”¨ç‡é™ä½</li><li>âš ï¸ TTFB å¢åŠ </li><li>âš ï¸ ç”¨æˆ·ä½“éªŒä¸‹é™</li></ul><hr><h2 id="äºŒã€æè®®å†…å®¹" tabindex="-1">äºŒã€æè®®å†…å®¹ <a class="header-anchor" href="#äºŒã€æè®®å†…å®¹" aria-label="Permalink to &quot;äºŒã€æè®®å†…å®¹&quot;">â€‹</a></h2><h3 id="_2-1-å››ä¸ªä¼˜åŒ–æ–¹å‘" tabindex="-1">2.1 å››ä¸ªä¼˜åŒ–æ–¹å‘ <a class="header-anchor" href="#_2-1-å››ä¸ªä¼˜åŒ–æ–¹å‘" aria-label="Permalink to &quot;2.1 å››ä¸ªä¼˜åŒ–æ–¹å‘&quot;">â€‹</a></h3><p>é’ˆå¯¹ä¸Šè¿° 4 ä¸ªé—®é¢˜ï¼Œæå‡ºä»¥ä¸‹ä¼˜åŒ–æ–¹æ¡ˆï¼š</p><table tabindex="0"><thead><tr><th>é—®é¢˜</th><th>ä¼˜åŒ–æ–¹å‘</th><th>æ ¸å¿ƒæ€è·¯</th></tr></thead><tbody><tr><td><strong>Header è¿‡å¤§</strong></td><td>æ”¹å˜ AB æ•°æ®é€ä¼ æ–¹å¼</td><td>ä½¿ç”¨ Redis å­˜å‚¨ï¼Œåªä¼  ID</td></tr><tr><td><strong>SSR/CSR ä¸ä¸€è‡´</strong></td><td>ç»Ÿä¸€å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ•°æ®</td><td>å®¢æˆ·ç«¯å¤ç”¨æœåŠ¡ç«¯æ•°æ®</td></tr><tr><td><strong>ç™½åå•ä¸å®æ—¶</strong></td><td>ç™»å½•å‰åé‡æ–°æ›´æ–° AB æ ‡è¯†</td><td>ab-test-id åŒ…å«ç™»å½•æ€</td></tr><tr><td><strong>ç¼“å­˜å‘½ä¸­ç‡ä½</strong></td><td>æé«˜ AB ç¼“å­˜å‘½ä¸­ç‡</td><td>è§ <a href="./11-ABå®éªŒ-RFC12.3-æé«˜ABç¼“å­˜å‘½ä¸­ç‡">RFC 12.3</a></td></tr></tbody></table><h3 id="_2-2-æ–¹æ¡ˆæ€»è§ˆ" tabindex="-1">2.2 æ–¹æ¡ˆæ€»è§ˆ <a class="header-anchor" href="#_2-2-æ–¹æ¡ˆæ€»è§ˆ" aria-label="Permalink to &quot;2.2 æ–¹æ¡ˆæ€»è§ˆ&quot;">â€‹</a></h3><p><strong>æ–°çš„æ•´ä½“æ¶æ„</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚   ç”¨æˆ·è¯·æ±‚   â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>       â”‚</span></span>
<span class="line"><span>       â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ CDN Worker  â”‚</span></span>
<span class="line"><span>â”‚             â”‚</span></span>
<span class="line"><span>â”‚ 1. è°ƒç”¨ BFF â”‚â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 2. è·å– AB  â”‚      â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚</span></span>
<span class="line"><span>       â”‚             â–¼</span></span>
<span class="line"><span>       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>       â”‚        â”‚  Redis  â”‚ â† å­˜å‚¨å®Œæ•´ AB æ•°æ®</span></span>
<span class="line"><span>       â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>       â”‚</span></span>
<span class="line"><span>       â”‚ Header: x-ab-test-id = abc123 (åªä¼  ID)</span></span>
<span class="line"><span>       â”‚ Cookie: x-ab-test-id = abc123.userId_hash</span></span>
<span class="line"><span>       â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ Meta SSR    â”‚</span></span>
<span class="line"><span>â”‚             â”‚</span></span>
<span class="line"><span>â”‚ 1. ä» Redis â”‚â”€â”€â”€â”€â”€â”€â†’ è¯»å–å®Œæ•´ AB æ•°æ®</span></span>
<span class="line"><span>â”‚    è·å– AB  â”‚</span></span>
<span class="line"><span>â”‚ 2. æ¸²æŸ“é¡µé¢ â”‚</span></span>
<span class="line"><span>â”‚ 3. æ³¨å…¥æ•°æ® â”‚â”€â”€â”€â”€â”€â”€â†’ window.GD_AB_DATA</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>       â”‚</span></span>
<span class="line"><span>       â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  æµè§ˆå™¨ JS  â”‚</span></span>
<span class="line"><span>â”‚             â”‚</span></span>
<span class="line"><span>â”‚ ä½¿ç”¨ window â”‚</span></span>
<span class="line"><span>â”‚ .GD_AB_DATA â”‚ â† å¤ç”¨æœåŠ¡ç«¯æ•°æ®</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><hr><h2 id="ä¸‰ã€è¯¦ç»†è®¾è®¡" tabindex="-1">ä¸‰ã€è¯¦ç»†è®¾è®¡ <a class="header-anchor" href="#ä¸‰ã€è¯¦ç»†è®¾è®¡" aria-label="Permalink to &quot;ä¸‰ã€è¯¦ç»†è®¾è®¡&quot;">â€‹</a></h2><h3 id="_3-1-ä¼˜åŒ–-1-æ”¹å˜-ab-æ•°æ®é€ä¼ æ–¹å¼" tabindex="-1">3.1 ä¼˜åŒ– 1ï¼šæ”¹å˜ AB æ•°æ®é€ä¼ æ–¹å¼ <a class="header-anchor" href="#_3-1-ä¼˜åŒ–-1-æ”¹å˜-ab-æ•°æ®é€ä¼ æ–¹å¼" aria-label="Permalink to &quot;3.1 ä¼˜åŒ– 1ï¼šæ”¹å˜ AB æ•°æ®é€ä¼ æ–¹å¼&quot;">â€‹</a></h3><h4 id="æ ¸å¿ƒæ€è·¯" tabindex="-1">æ ¸å¿ƒæ€è·¯ <a class="header-anchor" href="#æ ¸å¿ƒæ€è·¯" aria-label="Permalink to &quot;æ ¸å¿ƒæ€è·¯&quot;">â€‹</a></h4><p><strong>æ—§æµç¨‹ï¼ˆRFC 12.1ï¼‰</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Worker â†’ å®Œæ•´ AB æ•°æ® â†’ Header â†’ SSR</span></span>
<span class="line"><span>âŒ Header å¯èƒ½è¿‡å¤§</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>æ–°æµç¨‹</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Worker â†’ å®Œæ•´ AB æ•°æ® â†’ Redis â†’ è¿”å› ID</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>åªä¼  ID â†’ Header â†’ SSR</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>SSR â†’ é€šè¿‡ ID â†’ Redis â†’ è·å–å®Œæ•´æ•°æ®</span></span>
<span class="line"><span>âœ… Header å¾ˆå°</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="å®ç°æµç¨‹" tabindex="-1">å®ç°æµç¨‹ <a class="header-anchor" href="#å®ç°æµç¨‹" aria-label="Permalink to &quot;å®ç°æµç¨‹&quot;">â€‹</a></h4><p><strong>æ­¥éª¤ 1ï¼šWorker å±‚å¤„ç†</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// CDN Worker</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> request.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-user-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æ£€æŸ¥ Cookie ä¸­çš„ ab-test-id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> existingId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (existingId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isValidABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(existingId, userId)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ID æœ‰æ•ˆï¼Œç›´æ¥ä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> forwardWithABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, existingId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è·å–æ–°çš„ AB æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchABData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // å­˜å‚¨åˆ° Redis</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> storeABDataToRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData, userId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è®¾ç½® Cookie</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> forwardWithABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, abTestId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  response.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Set-Cookie&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`x-ab-test-id=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">abTestId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}; Max-Age=1800; Path=/\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å­˜å‚¨ AB æ•°æ®åˆ° Redis</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> storeABDataToRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">abData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">userId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ç”Ÿæˆ ID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> payload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> signature</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> signature </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}.\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">signature</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> payload;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // å­˜å‚¨åˆ° Redisï¼ˆ30 åˆ†é’Ÿè¿‡æœŸï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> redisKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">abTestId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redisKey, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abTestId;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>æ­¥éª¤ 2ï¼šBFF å±‚ä»£ç†</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// King BFF</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/ab-experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-user-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> deviceId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-device-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è°ƒç”¨ AB æœåŠ¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://ab-service.com/experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    headers: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;X-User-Id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: userId,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;X-Device-Id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: deviceId</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>æ­¥éª¤ 3ï¼šSSR ä» Redis è·å–</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Meta SSR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (abTestId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä» Redis è·å–å®Œæ•´ AB æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> redisKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">abTestId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abDataStr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redisKey);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (abDataStr) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      req.state.abExperiments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abDataStr);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="æ•°æ®ç»“æ„å¯¹æ¯”" tabindex="-1">æ•°æ®ç»“æ„å¯¹æ¯” <a class="header-anchor" href="#æ•°æ®ç»“æ„å¯¹æ¯”" aria-label="Permalink to &quot;æ•°æ®ç»“æ„å¯¹æ¯”&quot;">â€‹</a></h4><p><strong>æ—§æ–¹æ¡ˆï¼ˆé€šè¿‡ Headerï¼‰</strong>ï¼š</p><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HTTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> www.example.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">x-ab-test-list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {&quot;exp1&quot;:&quot;a&quot;,&quot;exp2&quot;:&quot;b&quot;,&quot;exp3&quot;:&quot;c&quot;,...}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># â†‘ å¯èƒ½æ•° KB</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> å¯èƒ½è¶…è¿‡ 8KB âŒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>æ–°æ–¹æ¡ˆï¼ˆåªä¼  IDï¼‰</strong>ï¼š</p><div class="language-http vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /page </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HTTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> www.example.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">x-ab-test-id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a3f5d8e9.b2c1a4f6</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># â†‘ åªæœ‰å‡ åå­—èŠ‚</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Content-Length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt; 100 å­—èŠ‚ âœ…</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="ä¼˜åŠ¿" tabindex="-1">ä¼˜åŠ¿ <a class="header-anchor" href="#ä¼˜åŠ¿" aria-label="Permalink to &quot;ä¼˜åŠ¿&quot;">â€‹</a></h4><table tabindex="0"><thead><tr><th>æŒ‡æ ‡</th><th>æ—§æ–¹æ¡ˆ</th><th>æ–°æ–¹æ¡ˆ</th><th>æ”¹è¿›</th></tr></thead><tbody><tr><td><strong>Header å¤§å°</strong></td><td>æ•° KB</td><td>&lt; 100B</td><td>ğŸš€ å¤§å¹…å‡å°‘</td></tr><tr><td><strong>å®éªŒæ•°é‡é™åˆ¶</strong></td><td>å—é™</td><td>æ— é™åˆ¶</td><td>âœ… æ‰©å±•æ€§å¥½</td></tr><tr><td><strong>ç¨³å®šæ€§</strong></td><td>å¯èƒ½å¤±è´¥</td><td>ç¨³å®š</td><td>âœ… å¯é </td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>è¾ƒæ…¢</td><td>å¿«é€Ÿ</td><td>âœ… Redis è¯»å–å¿«</td></tr></tbody></table><h3 id="_3-2-ä¼˜åŒ–-2-å®¢æˆ·ç«¯-ab-æ•°æ®å’ŒæœåŠ¡ç«¯ä¿æŒä¸€è‡´" tabindex="-1">3.2 ä¼˜åŒ– 2ï¼šå®¢æˆ·ç«¯ AB æ•°æ®å’ŒæœåŠ¡ç«¯ä¿æŒä¸€è‡´ <a class="header-anchor" href="#_3-2-ä¼˜åŒ–-2-å®¢æˆ·ç«¯-ab-æ•°æ®å’ŒæœåŠ¡ç«¯ä¿æŒä¸€è‡´" aria-label="Permalink to &quot;3.2 ä¼˜åŒ– 2ï¼šå®¢æˆ·ç«¯ AB æ•°æ®å’ŒæœåŠ¡ç«¯ä¿æŒä¸€è‡´&quot;">â€‹</a></h3><h4 id="æ ¸å¿ƒæ€è·¯-1" tabindex="-1">æ ¸å¿ƒæ€è·¯ <a class="header-anchor" href="#æ ¸å¿ƒæ€è·¯-1" aria-label="Permalink to &quot;æ ¸å¿ƒæ€è·¯&quot;">â€‹</a></h4><p><strong>é—®é¢˜æ ¹æº</strong>ï¼šSSR å’Œ CSR ç‹¬ç«‹è·å– AB æ•°æ®</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå®¢æˆ·ç«¯å¤ç”¨æœåŠ¡ç«¯çš„ AB æ•°æ®</p><h4 id="å®ç°æµç¨‹-1" tabindex="-1">å®ç°æµç¨‹ <a class="header-anchor" href="#å®ç°æµç¨‹-1" aria-label="Permalink to &quot;å®ç°æµç¨‹&quot;">â€‹</a></h4><p><strong>æ­¥éª¤ 1ï¼šSSR æ³¨å…¥ AB æ•°æ®åˆ°é¡µé¢</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Meta SSR æ¸²æŸ“</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> renderPage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abExperiments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.state.abExperiments;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;!DOCTYPE html&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;html&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;head&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &lt;script&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        // å°† AB æ•°æ®æ³¨å…¥åˆ°å…¨å±€å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        window.GD_AB_DATA = \${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">abExperiments</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">};</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &lt;/script&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;/head&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;body&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &lt;!-- é¡µé¢å†…å®¹ --&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;/body&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;/html&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  \`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(html);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>æ­¥éª¤ 2ï¼šå®¢æˆ·ç«¯ä¼˜å…ˆä½¿ç”¨æ³¨å…¥çš„æ•°æ®</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®¢æˆ·ç«¯ AB SDK</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ABClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.abData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä¼˜å…ˆä½¿ç”¨ SSR æ³¨å…¥çš„æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (window.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GD_AB_DATA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.abData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GD_AB_DATA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">syncToLocalStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cachedData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getFromLocalStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (cachedData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isValid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cachedData)) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.abData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cachedData;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // é™çº§ï¼šé‡æ–°è·å–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchABData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getFromLocalStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ab-experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  syncToLocalStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ab-experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      id: abTestId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      data: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.abData,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  isValid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cachedData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥ Cookie ä¸­çš„ ab-test-id æ˜¯å¦ä¸€è‡´</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> currentId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cachedData.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentId;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchABData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/ab-experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.abData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">syncToLocalStorage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.abData?.[name];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`; \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">document</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cookie</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> parts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">split</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`; \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}=\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (parts.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">split</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shift</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å…¨å±€å®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abClient</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ABClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p><strong>æ­¥éª¤ 3ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®¢æˆ·ç«¯æ£€æŸ¥é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> validateABConsistency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> serverABId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GD_AB_DATA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">?.__id__;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cookieABId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> localABId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ä¸‰è€…ä¸ä¸€è‡´ï¼Œé‡æ–°è·å–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (serverABId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cookieABId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cookieABId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> localABId) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;AB data inconsistency detected, refetching...&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchABData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é¡µé¢åŠ è½½åæ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onMounted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(validateABConsistency);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="æ•°æ®æµå›¾" tabindex="-1">æ•°æ®æµå›¾ <a class="header-anchor" href="#æ•°æ®æµå›¾" aria-label="Permalink to &quot;æ•°æ®æµå›¾&quot;">â€‹</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SSR é˜¶æ®µï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ Redis ä¸­çš„  â”‚</span></span>
<span class="line"><span>â”‚   AB æ•°æ®   â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>       â”‚</span></span>
<span class="line"><span>       â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ SSR æ¸²æŸ“    â”‚</span></span>
<span class="line"><span>â”‚ æ³¨å…¥åˆ° HTML â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>       â”‚</span></span>
<span class="line"><span>       â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ &lt;script&gt;         â”‚</span></span>
<span class="line"><span>â”‚ window.GD_AB_DATAâ”‚</span></span>
<span class="line"><span>â”‚ = {...}          â”‚</span></span>
<span class="line"><span>â”‚ &lt;/script&gt;        â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>       â”‚</span></span>
<span class="line"><span>       â–¼</span></span>
<span class="line"><span>CSR é˜¶æ®µï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ æµè§ˆå™¨ JS   â”‚</span></span>
<span class="line"><span>â”‚ è¯»å– window â”‚</span></span>
<span class="line"><span>â”‚ .GD_AB_DATA â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>       â”‚</span></span>
<span class="line"><span>       â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ å­˜å…¥        â”‚</span></span>
<span class="line"><span>â”‚ localStorageâ”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>       â”‚</span></span>
<span class="line"><span>       â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ åç»­ä½¿ç”¨    â”‚</span></span>
<span class="line"><span>â”‚ ç¼“å­˜æ•°æ®    â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h4 id="ä¼˜åŠ¿-1" tabindex="-1">ä¼˜åŠ¿ <a class="header-anchor" href="#ä¼˜åŠ¿-1" aria-label="Permalink to &quot;ä¼˜åŠ¿&quot;">â€‹</a></h4><table tabindex="0"><thead><tr><th>æŒ‡æ ‡</th><th>æ—§æ–¹æ¡ˆ</th><th>æ–°æ–¹æ¡ˆ</th><th>æ”¹è¿›</th></tr></thead><tbody><tr><td><strong>æ•°æ®ä¸€è‡´æ€§</strong></td><td>âŒ å¯èƒ½ä¸ä¸€è‡´</td><td>âœ… å®Œå…¨ä¸€è‡´</td><td>ğŸ¯ æ ¸å¿ƒæ”¹è¿›</td></tr><tr><td><strong>ç½‘ç»œè¯·æ±‚</strong></td><td>2 æ¬¡ï¼ˆSSR + CSRï¼‰</td><td>1 æ¬¡ï¼ˆåª SSRï¼‰</td><td>ğŸš€ å‡å°‘è¯·æ±‚</td></tr><tr><td><strong>æ°´åˆé£é™©</strong></td><td>ğŸ”´ é«˜</td><td>âœ… æ— é£é™©</td><td>âœ… ç¨³å®šæ€§é«˜</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>è¾ƒæ…¢</td><td>å¿«é€Ÿ</td><td>âœ… å‡å°‘ç­‰å¾…</td></tr></tbody></table><h3 id="_3-3-ä¼˜åŒ–-3-ç™»å½•å‰åé‡æ–°æ›´æ–°-ab-æ ‡è¯†" tabindex="-1">3.3 ä¼˜åŒ– 3ï¼šç™»å½•å‰åé‡æ–°æ›´æ–° AB æ ‡è¯† <a class="header-anchor" href="#_3-3-ä¼˜åŒ–-3-ç™»å½•å‰åé‡æ–°æ›´æ–°-ab-æ ‡è¯†" aria-label="Permalink to &quot;3.3 ä¼˜åŒ– 3ï¼šç™»å½•å‰åé‡æ–°æ›´æ–° AB æ ‡è¯†&quot;">â€‹</a></h3><h4 id="æ ¸å¿ƒæ€è·¯-2" tabindex="-1">æ ¸å¿ƒæ€è·¯ <a class="header-anchor" href="#æ ¸å¿ƒæ€è·¯-2" aria-label="Permalink to &quot;æ ¸å¿ƒæ€è·¯&quot;">â€‹</a></h4><p><strong>é—®é¢˜</strong>ï¼šab-test-id ç¼“å­˜ 30 åˆ†é’Ÿï¼Œç™»å½•å‰åä¸æ›´æ–°</p><p><strong>è§£å†³</strong>ï¼šab-test-id åŒ…å«ç™»å½•æ€ä¿¡æ¯ï¼Œç™»å½•æ—¶æ£€æŸ¥å¹¶æ›´æ–°</p><h4 id="ab-test-id-ç»“æ„è®¾è®¡" tabindex="-1">ab-test-id ç»“æ„è®¾è®¡ <a class="header-anchor" href="#ab-test-id-ç»“æ„è®¾è®¡" aria-label="Permalink to &quot;ab-test-id ç»“æ„è®¾è®¡&quot;">â€‹</a></h4><p><strong>æ–°çš„ ab-test-id æ ¼å¼</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ab-test-id = \${Payload}.\${Signature}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>ç±»ä¼¼ JWT çš„è®¾è®¡</strong>ï¼š</p><table tabindex="0"><thead><tr><th>éƒ¨åˆ†</th><th>å«ä¹‰</th><th>è®¡ç®—æ–¹å¼</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><strong>Payload</strong></td><td>AB ç­–ç•¥çš„ Hash</td><td>MD5(AB æ•°æ®)</td><td><code>a3f5d8e9</code></td></tr><tr><td><strong>Signature</strong></td><td>ç™»å½•æ€æ ‡è¯†</td><td>Hash(userId)</td><td><code>b2c1a4f6</code></td></tr></tbody></table><p><strong>ç¤ºä¾‹</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æœªç™»å½•ç”¨æˆ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ab</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">test</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;a3f5d8e9&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Payload: a3f5d8e9 (AB æ•°æ® Hash)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Signature: (ç©º)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å·²ç™»å½•ç”¨æˆ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ab</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">test</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;a3f5d8e9.b2c1a4f6&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Payload: a3f5d8e9 (AB æ•°æ® Hash)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Signature: b2c1a4f6 (userId Hash)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="å®ç°æµç¨‹-2" tabindex="-1">å®ç°æµç¨‹ <a class="header-anchor" href="#å®ç°æµç¨‹-2" aria-label="Permalink to &quot;å®ç°æµç¨‹&quot;">â€‹</a></h4><p><strong>æ­¥éª¤ 1ï¼šç”ŸæˆåŒ…å«ç™»å½•æ€çš„ ab-test-id</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç”Ÿæˆ ab-test-id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">abData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">userId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Payload: AB æ•°æ®çš„ Hash</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> payload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> md5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">userId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æœªç™»å½•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> payload;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Signature: ç”¨æˆ· ID çš„ Hash</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> signature</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> md5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}.\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">signature</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { exp1: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;a&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, exp2: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;b&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;12345&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData, userId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// â†’ &quot;a3f5d8e9.b2c1a4f6&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>æ­¥éª¤ 2ï¼šç™»å½•æ—¶æ£€æŸ¥ ab-test-id</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Worker å±‚æ£€æŸ¥</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> request.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-user-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> existingId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (existingId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è§£æ ab-test-id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">signature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> existingId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">split</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥ç™»å½•æ€æ˜¯å¦ä¸€è‡´</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> expectedSignature</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> md5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (signature </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> expectedSignature) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // ç™»å½•æ€ä¸ä¸€è‡´ï¼Œé‡æ–°è·å– AB æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Login state changed, refreshing AB data&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> refreshABData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request, userId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ç»§ç»­æ­£å¸¸æµç¨‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> forwardRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>æ­¥éª¤ 3ï¼šç™»å½•å‰åçš„æµç¨‹</strong></p><p><strong>åœºæ™¯ Aï¼šæœªç™»å½• â†’ ç™»å½•</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šç”¨æˆ·æœªç™»å½•è®¿é—®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ab-test-id = &quot;a3f5d8e9&quot; (æ—  Signature)</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>è¿›å…¥ AB ç»„ï¼šæ¸¸å®¢ç­–ç•¥</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šç”¨æˆ·ç™»å½•</span></span>
<span class="line"><span>   userId = &quot;12345&quot;</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>Worker æ£€æŸ¥ï¼š</span></span>
<span class="line"><span>   å½“å‰ ab-test-id = &quot;a3f5d8e9&quot;</span></span>
<span class="line"><span>   æœŸæœ› ab-test-id = &quot;a3f5d8e9.b2c1a4f6&quot;</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ ä¸åŒ¹é…ï¼é‡æ–°è·å– AB æ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šé‡æ–°è·å–ï¼ˆå¸¦ç”¨æˆ·ä¿¡æ¯ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>è¿›å…¥ç™½åå• AB ç»„</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ab-test-id = &quot;c7a9f2d1.b2c1a4f6&quot; (æ–°çš„ Payload + Signature)</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âœ… ç™½åå•ç­–ç•¥ç«‹å³ç”Ÿæ•ˆ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>åœºæ™¯ Bï¼šç™»å½• â†’ é€€å‡º</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šå·²ç™»å½•ç”¨æˆ·è®¿é—®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ab-test-id = &quot;a3f5d8e9.b2c1a4f6&quot;</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>è¿›å…¥ AB ç»„ï¼šç”¨æˆ·ç­–ç•¥</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šç”¨æˆ·é€€å‡ºç™»å½•</span></span>
<span class="line"><span>   userId = null</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>Worker æ£€æŸ¥ï¼š</span></span>
<span class="line"><span>   å½“å‰ ab-test-id = &quot;a3f5d8e9.b2c1a4f6&quot;</span></span>
<span class="line"><span>   æœŸæœ› ab-test-id = &quot;xxxxxxxx&quot; (æ–°çš„ï¼Œæ—  Signature)</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ ä¸åŒ¹é…ï¼é‡æ–°è·å– AB æ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šé‡æ–°è·å–ï¼ˆæ¸¸å®¢èº«ä»½ï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ab-test-id = &quot;f8e3c5a2&quot;</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âœ… åˆ‡æ¢åˆ°æ¸¸å®¢ç­–ç•¥</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="ç¼“å­˜-key-ç­–ç•¥" tabindex="-1">ç¼“å­˜ Key ç­–ç•¥ <a class="header-anchor" href="#ç¼“å­˜-key-ç­–ç•¥" aria-label="Permalink to &quot;ç¼“å­˜ Key ç­–ç•¥&quot;">â€‹</a></h4><p><strong>Payload ç”¨äºç¼“å­˜</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æå– Payload ä½œä¸ºç¼“å­˜ Key</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">abTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // åªä½¿ç”¨ Payload éƒ¨åˆ†</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> payload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abTestId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">split</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> payload);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¤ºä¾‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/homepage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;a3f5d8e9.b2c1a4f6&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç”¨æˆ· A</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;a3f5d8e9.d7f2e1c8&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç”¨æˆ· B</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url, abTestId1); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// â†’ hash(&#39;/homepage&#39; + &#39;a3f5d8e9&#39;)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url, abTestId2); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// â†’ hash(&#39;/homepage&#39; + &#39;a3f5d8e9&#39;)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… ç›¸åŒçš„ AB ç»„ï¼Œå…±äº«ç¼“å­˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>Signature ç”¨äºéªŒè¯</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// éªŒè¯ç™»å½•æ€</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> validateLoginState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">abTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">currentUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> parts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abTestId.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">split</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (parts.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ—  Signatureï¼Œåº”è¯¥æ˜¯æœªç™»å½•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">currentUserId;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æœ‰ Signatureï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> signature</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parts[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> expectedSignature</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> md5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(currentUserId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> signature </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> expectedSignature;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="ä¼˜åŠ¿-2" tabindex="-1">ä¼˜åŠ¿ <a class="header-anchor" href="#ä¼˜åŠ¿-2" aria-label="Permalink to &quot;ä¼˜åŠ¿&quot;">â€‹</a></h4><table tabindex="0"><thead><tr><th>åœºæ™¯</th><th>æ—§æ–¹æ¡ˆ</th><th>æ–°æ–¹æ¡ˆ</th><th>æ”¹è¿›</th></tr></thead><tbody><tr><td><strong>ç™»å½•åç™½åå•</strong></td><td>éœ€ç­‰ 30 åˆ†é’Ÿ</td><td>âœ… ç«‹å³ç”Ÿæ•ˆ</td><td>ğŸ¯ æ ¸å¿ƒæ”¹è¿›</td></tr><tr><td><strong>æµ‹è¯•è°ƒè¯•</strong></td><td>å›°éš¾</td><td>âœ… æ–¹ä¾¿</td><td>âœ… æå‡æ•ˆç‡</td></tr><tr><td><strong>è¿è¥ç­–ç•¥</strong></td><td>æ»å</td><td>âœ… å®æ—¶</td><td>âœ… ä¸šåŠ¡å‹å¥½</td></tr><tr><td><strong>å®‰å…¨æ€§</strong></td><td>ä¸€èˆ¬</td><td>âœ… æ›´å¥½</td><td>âœ… é˜²ä¼ªé€ </td></tr></tbody></table><h3 id="_3-4-ä¼˜åŒ–-4-æé«˜-ab-ç¼“å­˜å‘½ä¸­ç‡" tabindex="-1">3.4 ä¼˜åŒ– 4ï¼šæé«˜ AB ç¼“å­˜å‘½ä¸­ç‡ <a class="header-anchor" href="#_3-4-ä¼˜åŒ–-4-æé«˜-ab-ç¼“å­˜å‘½ä¸­ç‡" aria-label="Permalink to &quot;3.4 ä¼˜åŒ– 4ï¼šæé«˜ AB ç¼“å­˜å‘½ä¸­ç‡&quot;">â€‹</a></h3><p><strong>è¯´æ˜</strong>ï¼šæ­¤ä¼˜åŒ–è¯¦è§ <a href="./11-ABå®éªŒ-RFC12.3-æé«˜ABç¼“å­˜å‘½ä¸­ç‡">RFC 12.3: æé«˜ AB ç¼“å­˜å‘½ä¸­ç‡</a></p><p><strong>æ ¸å¿ƒè¦ç‚¹</strong>ï¼š</p><ol><li><strong>é—®é¢˜</strong>ï¼šæ¯ä¸ªå®éªŒéƒ½å½±å“ç¼“å­˜ Keyï¼Œå®éªŒè¶Šå¤šç¼“å­˜ç¢ç‰‡åŒ–è¶Šä¸¥é‡</li><li><strong>æ–¹æ¡ˆ</strong>ï¼šåªå°†&quot;å…¬å…±å®éªŒ&quot;çº³å…¥ç¼“å­˜ Key</li><li><strong>æ•ˆæœ</strong>ï¼šå¤§å¹…æå‡ç¼“å­˜å‘½ä¸­ç‡</li></ol><hr><h2 id="å››ã€æ•´ä½“æ–¹æ¡ˆæµç¨‹å›¾" tabindex="-1">å››ã€æ•´ä½“æ–¹æ¡ˆæµç¨‹å›¾ <a class="header-anchor" href="#å››ã€æ•´ä½“æ–¹æ¡ˆæµç¨‹å›¾" aria-label="Permalink to &quot;å››ã€æ•´ä½“æ–¹æ¡ˆæµç¨‹å›¾&quot;">â€‹</a></h2><h3 id="_4-1-å®Œæ•´æµç¨‹" tabindex="-1">4.1 å®Œæ•´æµç¨‹ <a class="header-anchor" href="#_4-1-å®Œæ•´æµç¨‹" aria-label="Permalink to &quot;4.1 å®Œæ•´æµç¨‹&quot;">â€‹</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚                     ç”¨æˆ·è¯·æ±‚                              â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                         â”‚</span></span>
<span class="line"><span>                         â–¼</span></span>
<span class="line"><span>        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>        â”‚        CDN Worker              â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  1. æ£€æŸ¥ Cookie: x-ab-test-id â”‚</span></span>
<span class="line"><span>        â”‚     â”œâ”€ å­˜åœ¨ä¸”æœ‰æ•ˆ â†’ ç›´æ¥ä½¿ç”¨   â”‚</span></span>
<span class="line"><span>        â”‚     â””â”€ ä¸å­˜åœ¨æˆ–æ— æ•ˆ â†’ æ­¥éª¤ 2   â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  2. è·å– AB æ•°æ®              â”‚</span></span>
<span class="line"><span>        â”‚     è°ƒç”¨ BFF: /api/ab         â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  3. ç”Ÿæˆ ab-test-id            â”‚</span></span>
<span class="line"><span>        â”‚     Payload.Signature          â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  4. å­˜å…¥ Redis                â”‚</span></span>
<span class="line"><span>        â”‚     Key: ab:\${abTestId}       â”‚</span></span>
<span class="line"><span>        â”‚     Value: AB æ•°æ® JSON        â”‚</span></span>
<span class="line"><span>        â”‚     TTL: 1800s (30åˆ†é’Ÿ)        â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  5. è®¾ç½® Response              â”‚</span></span>
<span class="line"><span>        â”‚     Header: x-ab-test-id      â”‚</span></span>
<span class="line"><span>        â”‚     Cookie: x-ab-test-id      â”‚</span></span>
<span class="line"><span>        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                     â”‚</span></span>
<span class="line"><span>                     â–¼</span></span>
<span class="line"><span>        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>        â”‚          BFF å±‚                â”‚</span></span>
<span class="line"><span>        â”‚  (Cache Key è®¡ç®—)              â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  cacheKey = hash(              â”‚</span></span>
<span class="line"><span>        â”‚    url +                       â”‚</span></span>
<span class="line"><span>        â”‚    ab-test-id.split(&#39;.&#39;)[0]    â”‚ â† åªç”¨ Payload</span></span>
<span class="line"><span>        â”‚  )                             â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  æ£€æŸ¥ç¼“å­˜:                      â”‚</span></span>
<span class="line"><span>        â”‚  â”œâ”€ å‘½ä¸­ â†’ è¿”å›ç¼“å­˜            â”‚</span></span>
<span class="line"><span>        â”‚  â””â”€ æœªå‘½ä¸­ â†’ è½¬å‘åˆ° SSR        â”‚</span></span>
<span class="line"><span>        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                     â”‚</span></span>
<span class="line"><span>                     â–¼</span></span>
<span class="line"><span>        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>        â”‚        Meta SSR                â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  1. ä» Redis è¯»å– AB æ•°æ®      â”‚</span></span>
<span class="line"><span>        â”‚     Key: ab:\${abTestId}       â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  2. æ¸²æŸ“é¡µé¢                   â”‚</span></span>
<span class="line"><span>        â”‚     ä½¿ç”¨ AB æ•°æ®               â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  3. æ³¨å…¥ AB æ•°æ®åˆ° HTML        â”‚</span></span>
<span class="line"><span>        â”‚     window.GD_AB_DATA = {...} â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  4. è¿”å› HTML                  â”‚</span></span>
<span class="line"><span>        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                     â”‚</span></span>
<span class="line"><span>                     â–¼</span></span>
<span class="line"><span>        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>        â”‚        æµè§ˆå™¨                   â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  1. æ¥æ”¶ HTML                  â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  2. æ‰§è¡Œ JS                    â”‚</span></span>
<span class="line"><span>        â”‚     è¯»å– window.GD_AB_DATA     â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  3. å­˜å…¥ localStorage          â”‚</span></span>
<span class="line"><span>        â”‚     ab-test-id + AB æ•°æ®       â”‚</span></span>
<span class="line"><span>        â”‚                                â”‚</span></span>
<span class="line"><span>        â”‚  4. åç»­è¯·æ±‚                   â”‚</span></span>
<span class="line"><span>        â”‚     æºå¸¦ AB æ ‡è¯†               â”‚</span></span>
<span class="line"><span>        â”‚     ä½¿ç”¨ç¼“å­˜çš„ AB æ•°æ®          â”‚</span></span>
<span class="line"><span>        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><h3 id="_4-2-å…³é”®æ•°æ®ç»“æ„" tabindex="-1">4.2 å…³é”®æ•°æ®ç»“æ„ <a class="header-anchor" href="#_4-2-å…³é”®æ•°æ®ç»“æ„" aria-label="Permalink to &quot;4.2 å…³é”®æ•°æ®ç»“æ„&quot;">â€‹</a></h3><p><strong>Redis å­˜å‚¨</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Key: ab:a3f5d8e9.b2c1a4f6</span></span>
<span class="line"><span>Value: {</span></span>
<span class="line"><span>  &quot;homepage_layout&quot;: &quot;variant_b&quot;,</span></span>
<span class="line"><span>  &quot;template_list&quot;: &quot;variant_a&quot;,</span></span>
<span class="line"><span>  &quot;editor_toolbar&quot;: &quot;variant_c&quot;,</span></span>
<span class="line"><span>  ...</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>TTL: 1800 (30 åˆ†é’Ÿ)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>Cookie</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>x-ab-test-id=a3f5d8e9.b2c1a4f6; Max-Age=1800; Path=/; HttpOnly; Secure</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>localStorage</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;ab-experiments&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a3f5d8e9.b2c1a4f6&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;homepage_layout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1704096000000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>HTML æ³¨å…¥</strong>ï¼š</p><div class="language-html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  window.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GD_AB_DATA</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;__id__&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a3f5d8e9.b2c1a4f6&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;homepage_layout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;template_list&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr><h2 id="äº”ã€å¯¹æ¯”ä¸æ”¶ç›Š" tabindex="-1">äº”ã€å¯¹æ¯”ä¸æ”¶ç›Š <a class="header-anchor" href="#äº”ã€å¯¹æ¯”ä¸æ”¶ç›Š" aria-label="Permalink to &quot;äº”ã€å¯¹æ¯”ä¸æ”¶ç›Š&quot;">â€‹</a></h2><h3 id="_5-1-æ–¹æ¡ˆå¯¹æ¯”" tabindex="-1">5.1 æ–¹æ¡ˆå¯¹æ¯” <a class="header-anchor" href="#_5-1-æ–¹æ¡ˆå¯¹æ¯”" aria-label="Permalink to &quot;5.1 æ–¹æ¡ˆå¯¹æ¯”&quot;">â€‹</a></h3><table tabindex="0"><thead><tr><th>ç‰¹æ€§</th><th>RFC 12.1</th><th>RFC 12.2</th><th>æ”¹è¿›</th></tr></thead><tbody><tr><td><strong>AB æ•°æ®ä¼ è¾“</strong></td><td>Header ä¼ å®Œæ•´æ•°æ®</td><td>Header åªä¼  ID</td><td>ğŸš€ å‡å°‘ 95%+</td></tr><tr><td><strong>Header å¤§å°</strong></td><td>æ•° KB</td><td>&lt; 100B</td><td>âœ… é¿å…è¶…é™</td></tr><tr><td><strong>SSR/CSR ä¸€è‡´æ€§</strong></td><td>å¯èƒ½ä¸ä¸€è‡´</td><td>å®Œå…¨ä¸€è‡´</td><td>ğŸ¯ æ ¸å¿ƒæ”¹è¿›</td></tr><tr><td><strong>ç™½åå•å®æ—¶æ€§</strong></td><td>éœ€ç­‰ 30 åˆ†é’Ÿ</td><td>ç«‹å³ç”Ÿæ•ˆ</td><td>âœ… ç”¨æˆ·å‹å¥½</td></tr><tr><td><strong>ç¼“å­˜å‘½ä¸­ç‡</strong></td><td>å—æ‰€æœ‰å®éªŒå½±å“</td><td>ä¼˜åŒ–åæå‡</td><td>âœ… æ€§èƒ½æå‡</td></tr><tr><td><strong>å¤æ‚åº¦</strong></td><td>ä½</td><td>ä¸­</td><td>âš ï¸ å¢åŠ  Redis</td></tr></tbody></table><h3 id="_5-2-æ€§èƒ½æ”¶ç›Š" tabindex="-1">5.2 æ€§èƒ½æ”¶ç›Š <a class="header-anchor" href="#_5-2-æ€§èƒ½æ”¶ç›Š" aria-label="Permalink to &quot;5.2 æ€§èƒ½æ”¶ç›Š&quot;">â€‹</a></h3><p><strong>ç½‘ç»œæ€§èƒ½</strong>ï¼š</p><table tabindex="0"><thead><tr><th>æŒ‡æ ‡</th><th>RFC 12.1</th><th>RFC 12.2</th><th>æ”¹è¿›</th></tr></thead><tbody><tr><td><strong>Header å¤§å°</strong></td><td>2-8 KB</td><td>&lt; 100B</td><td>â¬‡ï¸ 95%+</td></tr><tr><td><strong>è¯·æ±‚æ¬¡æ•°</strong></td><td>2 æ¬¡</td><td>1 æ¬¡ï¼ˆå¤ç”¨ï¼‰</td><td>â¬‡ï¸ 50%</td></tr><tr><td><strong>é¦–æ¬¡ TTFB</strong></td><td>ç›¸åŒ</td><td>ç›¸åŒ</td><td>-</td></tr></tbody></table><p><strong>ç¼“å­˜æ”¶ç›Š</strong>ï¼š</p><table tabindex="0"><thead><tr><th>åœºæ™¯</th><th>æ—§ç¼“å­˜å‘½ä¸­ç‡</th><th>æ–°ç¼“å­˜å‘½ä¸­ç‡</th><th>æ”¹è¿›</th></tr></thead><tbody><tr><td><strong>æœªç™»å½•</strong></td><td>60%</td><td>60%</td><td>æ— å˜åŒ–</td></tr><tr><td><strong>å·²ç™»å½•</strong></td><td>10-15%</td><td>40-50%</td><td>â¬†ï¸ 3-4x</td></tr><tr><td><strong>æ•´ä½“</strong></td><td>35%</td><td>55%</td><td>â¬†ï¸ 1.5x</td></tr></tbody></table><p><strong>ç”¨æˆ·ä½“éªŒ</strong>ï¼š</p><table tabindex="0"><thead><tr><th>æŒ‡æ ‡</th><th>RFC 12.1</th><th>RFC 12.2</th><th>æ”¹è¿›</th></tr></thead><tbody><tr><td><strong>å†…å®¹é—ªçƒ</strong></td><td>å¯èƒ½å‘ç”Ÿ</td><td>âœ… é¿å…</td><td>ğŸ¯ å…³é”®</td></tr><tr><td><strong>ç™½åå•ç”Ÿæ•ˆ</strong></td><td>å»¶è¿Ÿ 30 åˆ†é’Ÿ</td><td>âœ… å®æ—¶</td><td>ğŸ¯ å…³é”®</td></tr><tr><td><strong>ç¨³å®šæ€§</strong></td><td>å¯èƒ½å¤±è´¥</td><td>âœ… ç¨³å®š</td><td>âœ… å¯é </td></tr></tbody></table><hr><h2 id="å…­ã€å®æ–½è€ƒè™‘" tabindex="-1">å…­ã€å®æ–½è€ƒè™‘ <a class="header-anchor" href="#å…­ã€å®æ–½è€ƒè™‘" aria-label="Permalink to &quot;å…­ã€å®æ–½è€ƒè™‘&quot;">â€‹</a></h2><h3 id="_6-1-ä¾èµ–å’Œå‰ç½®æ¡ä»¶" tabindex="-1">6.1 ä¾èµ–å’Œå‰ç½®æ¡ä»¶ <a class="header-anchor" href="#_6-1-ä¾èµ–å’Œå‰ç½®æ¡ä»¶" aria-label="Permalink to &quot;6.1 ä¾èµ–å’Œå‰ç½®æ¡ä»¶&quot;">â€‹</a></h3><p><strong>åŸºç¡€è®¾æ–½</strong>ï¼š</p><ol><li><p>âœ… <strong>Redis é›†ç¾¤</strong></p><ul><li>é«˜å¯ç”¨ï¼ˆä¸»ä» + å“¨å…µï¼‰</li><li>è¶³å¤Ÿå®¹é‡ï¼ˆä¼°ç®—ï¼š10 ä¸‡ç”¨æˆ· Ã— 2KB = 200MBï¼‰</li><li>ç›‘æ§å’Œå‘Šè­¦</li></ul></li><li><p>âœ… <strong>BFF å±‚æ”¯æŒ</strong></p><ul><li>AB æ¥å£ä»£ç†</li><li>Redis è¿æ¥æ± </li><li>é”™è¯¯å¤„ç†</li></ul></li><li><p>âœ… <strong>CDN Worker å‡çº§</strong></p><ul><li>æ”¯æŒ Redis æ“ä½œ</li><li>Cookie æ“ä½œå¢å¼º</li></ul></li></ol><h3 id="_6-2-å…¼å®¹æ€§å’Œé™çº§" tabindex="-1">6.2 å…¼å®¹æ€§å’Œé™çº§ <a class="header-anchor" href="#_6-2-å…¼å®¹æ€§å’Œé™çº§" aria-label="Permalink to &quot;6.2 å…¼å®¹æ€§å’Œé™çº§&quot;">â€‹</a></h3><p><strong>é™çº§ç­–ç•¥</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Worker å±‚é™çº§</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleRequestWithFallback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å°è¯•æ–°æ–¹æ¡ˆï¼ˆRedisï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleRequestV2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;V2 failed, fallback to V1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // é™çº§åˆ°æ—§æ–¹æ¡ˆï¼ˆHeader ä¼ è¾“ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleRequestV1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SSR å±‚é™çº§</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (abTestId) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // å°è¯•ä» Redis è·å–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">abTestId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (abData) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        req.state.abExperiments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Redis failed, check header&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // é™çº§ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ Header ä¼ è¾“çš„æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> headerData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-ab-test-list&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (headerData) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      req.state.abExperiments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(headerData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="_6-3-ç›‘æ§æŒ‡æ ‡" tabindex="-1">6.3 ç›‘æ§æŒ‡æ ‡ <a class="header-anchor" href="#_6-3-ç›‘æ§æŒ‡æ ‡" aria-label="Permalink to &quot;6.3 ç›‘æ§æŒ‡æ ‡&quot;">â€‹</a></h3><p><strong>å…³é”®æŒ‡æ ‡</strong>ï¼š</p><table tabindex="0"><thead><tr><th>æŒ‡æ ‡</th><th>è¯´æ˜</th><th>å‘Šè­¦é˜ˆå€¼</th></tr></thead><tbody><tr><td><strong>Redis å‘½ä¸­ç‡</strong></td><td>è·å– AB æ•°æ®çš„æˆåŠŸç‡</td><td>&lt; 95%</td></tr><tr><td><strong>Header å¤§å°</strong></td><td>x-ab-test-id å¤§å°</td><td>&gt; 200B</td></tr><tr><td><strong>SSR/CSR ä¸€è‡´æ€§</strong></td><td>ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥æ¬¡æ•°</td><td>&gt; 1%</td></tr><tr><td><strong>ç™½åå•ç”Ÿæ•ˆå»¶è¿Ÿ</strong></td><td>ç™»å½•åˆ°ç”Ÿæ•ˆçš„æ—¶é—´</td><td>&gt; 5s</td></tr><tr><td><strong>ç¼“å­˜å‘½ä¸­ç‡</strong></td><td>é¡µé¢ç¼“å­˜å‘½ä¸­ç‡</td><td>&lt; 50%</td></tr></tbody></table><p><strong>ç›‘æ§é¢æ¿</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>AB å®éªŒç›‘æ§</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. æ•°æ®è·å–</span></span>
<span class="line"><span>   â”œâ”€ Redis å‘½ä¸­ç‡: 98.5%</span></span>
<span class="line"><span>   â”œâ”€ Redis å“åº”æ—¶é—´: 2ms (P99)</span></span>
<span class="line"><span>   â””â”€ é™çº§æ¬¡æ•°: 0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. æ•°æ®ä¸€è‡´æ€§</span></span>
<span class="line"><span>   â”œâ”€ SSR/CSR ä¸€è‡´: 99.9%</span></span>
<span class="line"><span>   â”œâ”€ ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: 0.1%</span></span>
<span class="line"><span>   â””â”€ é‡æ–°è·å–æ¬¡æ•°: 100/å°æ—¶</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. ç¼“å­˜æ•ˆæœ</span></span>
<span class="line"><span>   â”œâ”€ æœªç™»å½•ç¼“å­˜å‘½ä¸­ç‡: 62%</span></span>
<span class="line"><span>   â”œâ”€ å·²ç™»å½•ç¼“å­˜å‘½ä¸­ç‡: 45%</span></span>
<span class="line"><span>   â””â”€ æ•´ä½“ç¼“å­˜å‘½ä¸­ç‡: 58%</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. ç™½åå•</span></span>
<span class="line"><span>   â”œâ”€ ç”Ÿæ•ˆå»¶è¿Ÿ: 0.5s (P95)</span></span>
<span class="line"><span>   â””â”€ ç”Ÿæ•ˆæˆåŠŸç‡: 99.8%</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><hr><h2 id="ä¸ƒã€æ€»ç»“" tabindex="-1">ä¸ƒã€æ€»ç»“ <a class="header-anchor" href="#ä¸ƒã€æ€»ç»“" aria-label="Permalink to &quot;ä¸ƒã€æ€»ç»“&quot;">â€‹</a></h2><h3 id="_7-1-æ ¸å¿ƒæ”¹è¿›" tabindex="-1">7.1 æ ¸å¿ƒæ”¹è¿› <a class="header-anchor" href="#_7-1-æ ¸å¿ƒæ”¹è¿›" aria-label="Permalink to &quot;7.1 æ ¸å¿ƒæ”¹è¿›&quot;">â€‹</a></h3><p><strong>å››å¤§ä¼˜åŒ–</strong>ï¼š</p><ol><li><p>âœ… <strong>Redis å­˜å‚¨ AB æ•°æ®</strong></p><ul><li>Header å¤§å°ä» KB çº§é™åˆ° Byte çº§</li><li>æ”¯æŒæ— é™æ•°é‡çš„å®éªŒ</li></ul></li><li><p>âœ… <strong>å®¢æˆ·ç«¯å¤ç”¨æœåŠ¡ç«¯æ•°æ®</strong></p><ul><li>ç¡®ä¿ SSR å’Œ CSR å®Œå…¨ä¸€è‡´</li><li>å‡å°‘ç½‘ç»œè¯·æ±‚</li></ul></li><li><p>âœ… <strong>ab-test-id åŒ…å«ç™»å½•æ€</strong></p><ul><li>ç™½åå•ç­–ç•¥å®æ—¶ç”Ÿæ•ˆ</li><li>ç™»å½•å‰åè‡ªåŠ¨æ›´æ–°</li></ul></li><li><p>âœ… <strong>ä¼˜åŒ–ç¼“å­˜ç­–ç•¥</strong></p><ul><li>è¯¦è§ RFC 12.3</li><li>å¤§å¹…æå‡å‘½ä¸­ç‡</li></ul></li></ol><h3 id="_7-2-æŠ€æœ¯ä»·å€¼" tabindex="-1">7.2 æŠ€æœ¯ä»·å€¼ <a class="header-anchor" href="#_7-2-æŠ€æœ¯ä»·å€¼" aria-label="Permalink to &quot;7.2 æŠ€æœ¯ä»·å€¼&quot;">â€‹</a></h3><table tabindex="0"><thead><tr><th>ç»´åº¦</th><th>ä»·å€¼</th></tr></thead><tbody><tr><td><strong>æ€§èƒ½</strong></td><td>âœ… å‡å°‘è¯·æ±‚ã€æå‡ç¼“å­˜å‘½ä¸­ç‡</td></tr><tr><td><strong>ç¨³å®šæ€§</strong></td><td>âœ… é¿å… Header è¶…é™ã€é™çº§å®Œå–„</td></tr><tr><td><strong>ç”¨æˆ·ä½“éªŒ</strong></td><td>âœ… æ— é—ªçƒã€ç™½åå•å®æ—¶ç”Ÿæ•ˆ</td></tr><tr><td><strong>å¯æ‰©å±•æ€§</strong></td><td>âœ… æ”¯æŒæ— é™å®éªŒæ•°é‡</td></tr><tr><td><strong>å¯ç»´æŠ¤æ€§</strong></td><td>âœ… æ¶æ„æ¸…æ™°ã€ç›‘æ§å®Œå–„</td></tr></tbody></table><h3 id="_7-3-åç»­å·¥ä½œ" tabindex="-1">7.3 åç»­å·¥ä½œ <a class="header-anchor" href="#_7-3-åç»­å·¥ä½œ" aria-label="Permalink to &quot;7.3 åç»­å·¥ä½œ&quot;">â€‹</a></h3><p><strong>å…³è” RFC</strong>ï¼š</p><ul><li><a href="./11-ABå®éªŒ-RFC12.3-æé«˜ABç¼“å­˜å‘½ä¸­ç‡">RFC 12.3: æé«˜ AB ç¼“å­˜å‘½ä¸­ç‡</a></li><li><a href="./12-ABå®éªŒ-RFC12.4-ABæ”¯æŒèŠ±ç“£æœåŠ¡ç«¯">RFC 12.4: AB æ”¯æŒèŠ±ç“£æœåŠ¡ç«¯</a></li></ul><p><strong>æ½œåœ¨ä¼˜åŒ–</strong>ï¼š</p><ul><li>è¿›ä¸€æ­¥ä¼˜åŒ– Redis è®¿é—®æ€§èƒ½</li><li>è€ƒè™‘ AB æ•°æ®çš„ CDN è¾¹ç¼˜ç¼“å­˜</li><li>å®éªŒæ•°æ®çš„å®æ—¶æ¨é€</li></ul><hr><p><strong>æ–‡æ¡£ç»´æŠ¤</strong>ï¼šå‰ç«¯åŸºå»ºå›¢é˜Ÿ<br><strong>RFC ä½œè€…</strong>ï¼šå‰ç«¯æ¶æ„ç»„<br><strong>æ•´ç†æ—¥æœŸ</strong>ï¼š2025-01-25<br><strong>æ–‡æ¡£ç‰ˆæœ¬</strong>ï¼šv1.0</p>`,173)]))}const b=a(l,[["render",e]]);export{c as __pageData,b as default};
