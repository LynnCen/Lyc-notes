import{_ as a,c as n,o as i,a7 as p}from"./chunks/framework.BQb8NfN9.js";const c=JSON.parse('{"title":"å›¾ç‰‡å‹ç¼©æŠ€æœ¯æ·±åº¦è§£æ","description":"","frontmatter":{},"headers":[],"relativePath":"work/gd/AIå·¥å…·/å›¾ç‰‡å‹ç¼©/å›¾ç‰‡å‹ç¼©.md","filePath":"work/gd/AIå·¥å…·/å›¾ç‰‡å‹ç¼©/å›¾ç‰‡å‹ç¼©.md","lastUpdated":1770085732000}'),l={name:"work/gd/AIå·¥å…·/å›¾ç‰‡å‹ç¼©/å›¾ç‰‡å‹ç¼©.md"};function e(h,s,t,k,r,d){return i(),n("div",null,s[0]||(s[0]=[p(`<h1 id="å›¾ç‰‡å‹ç¼©æŠ€æœ¯æ·±åº¦è§£æ" tabindex="-1">å›¾ç‰‡å‹ç¼©æŠ€æœ¯æ·±åº¦è§£æ <a class="header-anchor" href="#å›¾ç‰‡å‹ç¼©æŠ€æœ¯æ·±åº¦è§£æ" aria-label="Permalink to &quot;å›¾ç‰‡å‹ç¼©æŠ€æœ¯æ·±åº¦è§£æ&quot;">â€‹</a></h1><blockquote><p><strong>æ–‡æ¡£è¯´æ˜ï¼š</strong> æœ¬æ–‡ä»InsMindé¡¹ç›®çš„å®é™…åº”ç”¨å‡ºå‘ï¼Œå±•ç¤ºå›¾ç‰‡å‹ç¼©çš„å®Œæ•´å®ç°æµç¨‹ï¼Œç„¶åæ·±å…¥å›¾åƒåŸºç¡€çŸ¥è¯†å’Œå‹ç¼©ç®—æ³•åŸç†ï¼Œæ¶µç›–JPEGã€PNGã€WebAssemblyç­‰æŠ€æœ¯æ ˆï¼Œæ—¢æœ‰å®æˆ˜ä»£ç ï¼Œä¹Ÿæœ‰ç†è®ºæ·±åº¦ã€‚</p></blockquote><h2 id="ğŸ“š-ç›®å½•" tabindex="-1">ğŸ“š ç›®å½• <a class="header-anchor" href="#ğŸ“š-ç›®å½•" aria-label="Permalink to &quot;ğŸ“š ç›®å½•&quot;">â€‹</a></h2><ol><li><a href="#ä¸€insmindå‹ç¼©å®ç°">InsMindå‹ç¼©å®ç°</a></li><li><a href="#äºŒå›¾åƒåŸºç¡€çŸ¥è¯†">å›¾åƒåŸºç¡€çŸ¥è¯†</a></li><li><a href="#ä¸‰å‹ç¼©åŸç†æ¦‚è¿°">å‹ç¼©åŸç†æ¦‚è¿°</a></li><li><a href="#å››jpegå‹ç¼©æ·±åº¦è§£æ">JPEGå‹ç¼©æ·±åº¦è§£æ</a></li><li><a href="#äº”pngå‹ç¼©æ·±åº¦è§£æ">PNGå‹ç¼©æ·±åº¦è§£æ</a></li><li><a href="#å…­webassemblyæŠ€æœ¯å®ç°">WebAssemblyæŠ€æœ¯å®ç°</a></li><li><a href="#ä¸ƒæ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ">æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ</a></li></ol><hr><h2 id="ä¸€ã€insmindå‹ç¼©å®ç°" tabindex="-1">ä¸€ã€InsMindå‹ç¼©å®ç° <a class="header-anchor" href="#ä¸€ã€insmindå‹ç¼©å®ç°" aria-label="Permalink to &quot;ä¸€ã€InsMindå‹ç¼©å®ç°&quot;">â€‹</a></h2><h3 id="_1-1-åŠŸèƒ½æ¦‚è¿°" tabindex="-1">1.1 åŠŸèƒ½æ¦‚è¿° <a class="header-anchor" href="#_1-1-åŠŸèƒ½æ¦‚è¿°" aria-label="Permalink to &quot;1.1 åŠŸèƒ½æ¦‚è¿°&quot;">â€‹</a></h3><p>InsMindçš„å›¾ç‰‡å‹ç¼©å·¥å…·æ˜¯ä¸€ä¸ª<strong>é›¶é…ç½®ã€é«˜æ€§èƒ½</strong>çš„Webå›¾ç‰‡å‹ç¼©æ–¹æ¡ˆï¼Œç”¨æˆ·ä¸Šä¼ å›¾ç‰‡åè‡ªåŠ¨æ‰§è¡Œå‹ç¼©ï¼Œå®æ—¶æ˜¾ç¤ºåŸå§‹å¤§å°ã€å‹ç¼©åå¤§å°å’Œå‹ç¼©ç‡ã€‚</p><p><strong>æ ¸å¿ƒç‰¹æ€§ï¼š</strong></p><ul><li>âœ… æ”¯æŒPNGå’ŒJPEGä¸¤ç§æ ¼å¼</li><li>âœ… ä½¿ç”¨WebAssemblyå®ç°æ¥è¿‘åŸç”Ÿçš„å‹ç¼©é€Ÿåº¦</li><li>âœ… JPEGé‡‡ç”¨MozJPEGç¼–ç å™¨ï¼ˆæ¯”æ ‡å‡†JPEGå‹ç¼©ç‡é«˜5-10%ï¼‰</li><li>âœ… PNGé‡‡ç”¨ImageQuanté‡åŒ–ç®—æ³•ï¼ˆè‰²å½©ä¼˜åŒ–ï¼‰</li><li>âœ… å®æ—¶é¢„è§ˆå‹ç¼©æ•ˆæœå’Œæ–‡ä»¶å¤§å°å¯¹æ¯”</li><li>âœ… ä¸€é”®ä¸‹è½½å‹ç¼©åçš„å›¾ç‰‡</li></ul><p><strong>å…¸å‹å‹ç¼©æ•ˆæœï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åœºæ™¯1ï¼šç”µå•†äº§å“å›¾ï¼ˆPNGï¼Œ4.2MBï¼‰</span></span>
<span class="line"><span>  â†’ å‹ç¼©åï¼š820KB</span></span>
<span class="line"><span>  â†’ å‹ç¼©ç‡ï¼š80.5%</span></span>
<span class="line"><span>  â†’ è€—æ—¶ï¼š&lt;1ç§’</span></span>
<span class="line"><span></span></span>
<span class="line"><span>åœºæ™¯2ï¼šç”¨æˆ·ç…§ç‰‡ï¼ˆJPEGï¼Œ1920Ã—1080ï¼Œ3.5MBï¼‰</span></span>
<span class="line"><span>  â†’ å‹ç¼©åï¼š450KB</span></span>
<span class="line"><span>  â†’ å‹ç¼©ç‡ï¼š87.1%</span></span>
<span class="line"><span>  â†’ è€—æ—¶ï¼š&lt;0.5ç§’</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><hr><h3 id="_1-2-æ¶æ„è®¾è®¡" tabindex="-1">1.2 æ¶æ„è®¾è®¡ <a class="header-anchor" href="#_1-2-æ¶æ„è®¾è®¡" aria-label="Permalink to &quot;1.2 æ¶æ„è®¾è®¡&quot;">â€‹</a></h3><h4 id="æ•´ä½“æ¶æ„å›¾" tabindex="-1">æ•´ä½“æ¶æ„å›¾ <a class="header-anchor" href="#æ•´ä½“æ¶æ„å›¾" aria-label="Permalink to &quot;æ•´ä½“æ¶æ„å›¾&quot;">â€‹</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚                    ç”¨æˆ·ç•Œé¢å±‚                            â”‚</span></span>
<span class="line"><span>â”‚  compress/index.vue - å‹ç¼©å·¥å…·UIç»„ä»¶                     â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ ä¸Šä¼ åŒºåŸŸ                                            â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ å›¾ç‰‡å¯¹æ¯”é¢„è§ˆï¼ˆåŸå›¾ vs å‹ç¼©åï¼‰                       â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ æ–‡ä»¶å¤§å°å±•ç¤º                                        â”‚</span></span>
<span class="line"><span>â”‚  â””â”€ ä¸‹è½½æŒ‰é’®                                            â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                     â”‚</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚                  ä¸šåŠ¡é€»è¾‘å±‚                              â”‚</span></span>
<span class="line"><span>â”‚  compress/services/index.ts - CompressService            â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ ç»§æ‰¿BaseEditorService                              â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ ç®¡ç†çŠ¶æ€ï¼ˆoriginSize, resultSizeï¼‰                  â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ ç¼–æ’å‹ç¼©æµç¨‹                                        â”‚</span></span>
<span class="line"><span>â”‚  â””â”€ å¤„ç†ä¸‹è½½å’ŒåŸ‹ç‚¹                                      â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                     â”‚</span></span>
<span class="line"><span>        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>        â”‚                        â”‚</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  JPEGå‹ç¼©     â”‚        â”‚   PNGå‹ç¼©        â”‚</span></span>
<span class="line"><span>â”‚              â”‚        â”‚                 â”‚</span></span>
<span class="line"><span>â”‚ @gaoding/    â”‚        â”‚ image-quant/    â”‚</span></span>
<span class="line"><span>â”‚ squoosh-     â”‚        â”‚ encode.ts       â”‚</span></span>
<span class="line"><span>â”‚ encoder      â”‚        â”‚                 â”‚</span></span>
<span class="line"><span>â”‚              â”‚        â”‚ ImageQuant      â”‚</span></span>
<span class="line"><span>â”‚ MozJPEG      â”‚        â”‚ WASM            â”‚</span></span>
<span class="line"><span>â”‚ WASM         â”‚        â”‚ (Rust)          â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><hr><h3 id="_1-3-æ ¸å¿ƒå®ç°æµç¨‹" tabindex="-1">1.3 æ ¸å¿ƒå®ç°æµç¨‹ <a class="header-anchor" href="#_1-3-æ ¸å¿ƒå®ç°æµç¨‹" aria-label="Permalink to &quot;1.3 æ ¸å¿ƒå®ç°æµç¨‹&quot;">â€‹</a></h3><h4 id="å®Œæ•´å‹ç¼©æµç¨‹" tabindex="-1">å®Œæ•´å‹ç¼©æµç¨‹ <a class="header-anchor" href="#å®Œæ•´å‹ç¼©æµç¨‹" aria-label="Permalink to &quot;å®Œæ•´å‹ç¼©æµç¨‹&quot;">â€‹</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç”¨æˆ·æ“ä½œ                    ç³»ç»Ÿå¤„ç†</span></span>
<span class="line"><span>â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</span></span>
<span class="line"><span>   â”‚</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>2. ä¸Šä¼ åˆ°ç¼–è¾‘å™¨              â†’ CompressService.constructor()</span></span>
<span class="line"><span>   â”‚                          åˆå§‹åŒ–æœåŠ¡ï¼Œé…ç½®ä¸‹è½½æŒ‰é’®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>3. è‡ªåŠ¨è§¦å‘å‹ç¼©              â†’ CompressService.main()</span></span>
<span class="line"><span>   â”‚                          â”œâ”€ è·å–å›¾ç‰‡ä¿¡æ¯</span></span>
<span class="line"><span>   â”‚                          â”œâ”€ ç»˜åˆ¶åˆ°Canvas</span></span>
<span class="line"><span>   â”‚                          â”œâ”€ è·å–ImageData</span></span>
<span class="line"><span>   â”‚                          â”œâ”€ åˆ¤æ–­æ ¼å¼ï¼ˆPNG/JPEGï¼‰</span></span>
<span class="line"><span>   â”‚                          â”œâ”€ è°ƒç”¨å¯¹åº”ç¼–ç å™¨</span></span>
<span class="line"><span>   â”‚                          â”‚   â”œâ”€ JPEG â†’ compressJpg()</span></span>
<span class="line"><span>   â”‚                          â”‚   â””â”€ PNG  â†’ compressPng()</span></span>
<span class="line"><span>   â”‚                          â”œâ”€ ç”ŸæˆBlob</span></span>
<span class="line"><span>   â”‚                          â””â”€ æ›´æ–°UI</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>4. æŸ¥çœ‹å¯¹æ¯”æ•ˆæœ              â†’ æ˜¾ç¤ºåŸå›¾ã€å‹ç¼©å›¾ã€å¤§å°å¯¹æ¯”</span></span>
<span class="line"><span>   â”‚</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>5. ç‚¹å‡»ä¸‹è½½                  â†’ compose() â†’ ç”Ÿæˆæœ€ç»ˆBlob</span></span>
<span class="line"><span>   â”‚</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>6. ä¿å­˜æ–‡ä»¶                  â†’ æµè§ˆå™¨ä¸‹è½½</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><hr><h3 id="_1-4-å…³é”®ä»£ç è§£æ" tabindex="-1">1.4 å…³é”®ä»£ç è§£æ <a class="header-anchor" href="#_1-4-å…³é”®ä»£ç è§£æ" aria-label="Permalink to &quot;1.4 å…³é”®ä»£ç è§£æ&quot;">â€‹</a></h3><h4 id="_1-4-1-compressserviceä¸»æœåŠ¡ç±»" tabindex="-1">1.4.1 CompressServiceä¸»æœåŠ¡ç±» <a class="header-anchor" href="#_1-4-1-compressserviceä¸»æœåŠ¡ç±»" aria-label="Permalink to &quot;1.4.1 CompressServiceä¸»æœåŠ¡ç±»&quot;">â€‹</a></h4><p>è¿™æ˜¯å‹ç¼©åŠŸèƒ½çš„æ ¸å¿ƒæ§åˆ¶å™¨ï¼Œè´Ÿè´£æ•´ä¸ªå‹ç¼©æµç¨‹çš„ç¼–æ’ï¼š</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// compress/services/index.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CompressService</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BaseEditorService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ICompressServiceState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IBaseEditorServiceOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            state: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                originSize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åŸå§‹æ–‡ä»¶å¤§å°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                resultSize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å‹ç¼©åå¤§å°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">options.state,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            config: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                showGenerateBtn: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸æ˜¾ç¤º&quot;ç”Ÿæˆ&quot;æŒ‰é’®ï¼ˆè‡ªåŠ¨å‹ç¼©ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                download: [</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCompressLow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()],  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é…ç½®ä¸‹è½½æŒ‰é’®</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // ç§»åŠ¨ç«¯å’ŒPCç«¯ä¸åŒçš„ç¼–è¾‘æŒ‰é’®é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                edit: [</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isMobile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ACTION_ITEM_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.editMore </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> EDIT_MORE_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.edit],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                editMore: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isMobile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    EDIT_MORE_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.resize,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å°ºå¯¸è°ƒæ•´</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    EDIT_MORE_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.magicEraser,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ™ºèƒ½æ¶ˆé™¤</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ],</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">options.config,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ„é€ å‡½æ•°ä¸­ç«‹å³æ‰§è¡Œå‹ç¼©</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>è®¾è®¡è¦ç‚¹ï¼š</strong></p><ol><li><strong>ç»§æ‰¿BaseEditorService</strong>ï¼šå¤ç”¨ç¼–è¾‘å™¨åŸºç¡€èƒ½åŠ›ï¼ˆçŠ¶æ€ç®¡ç†ã€åŸ‹ç‚¹ã€ä¸‹è½½ç­‰ï¼‰</li><li><strong>çŠ¶æ€ç®¡ç†</strong>ï¼šç”¨<code>originSize</code>å’Œ<code>resultSize</code>è¿½è¸ªæ–‡ä»¶å¤§å°å˜åŒ–</li><li><strong>è‡ªåŠ¨æ‰§è¡Œ</strong>ï¼šæ„é€ å‡½æ•°ç›´æ¥è°ƒç”¨<code>main()</code>ï¼Œæ— éœ€ç”¨æˆ·ç‚¹å‡»&quot;å¼€å§‹å‹ç¼©&quot;</li><li><strong>å“åº”å¼é…ç½®</strong>ï¼šç§»åŠ¨ç«¯å’ŒPCç«¯ä¸åŒçš„æŒ‰é’®å¸ƒå±€</li></ol><hr><h4 id="_1-4-2-å‹ç¼©ä¸»æµç¨‹" tabindex="-1">1.4.2 å‹ç¼©ä¸»æµç¨‹ <a class="header-anchor" href="#_1-4-2-å‹ç¼©ä¸»æµç¨‹" aria-label="Permalink to &quot;1.4.2 å‹ç¼©ä¸»æµç¨‹&quot;">â€‹</a></h4><p><code>main()</code>æ–¹æ³•æ˜¯æ•´ä¸ªå‹ç¼©æµç¨‹çš„æ ¸å¿ƒï¼š</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">async </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.loading </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ˜¾ç¤ºåŠ è½½çŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.tracker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trackToolConflateStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åŸ‹ç‚¹ï¼šå‹ç¼©å¼€å§‹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ===== æ­¥éª¤1ï¼šè·å–åŸå§‹å›¾ç‰‡ä¿¡æ¯ =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.compressOriginImagePromise;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getImageSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.originImage);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.originSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®°å½•åŸå§‹å¤§å°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ===== æ­¥éª¤2ï¼šåˆ›å»ºCanvaså¹¶è·å–åƒç´ æ•°æ® =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createCanvas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            width: image.width,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            height: image.height,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drawImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> imageData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getImageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, image.width, image.height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ===== æ­¥éª¤3ï¼šæ ¹æ®æ ¼å¼é€‰æ‹©ç¼–ç å™¨ =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> encodeFn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.config.originMime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MIME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.png </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compressPng   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PNGç¼–ç å™¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compressJpg;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JPEGç¼–ç å™¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ===== æ­¥éª¤4ï¼šæ‰§è¡Œå‹ç¼©ï¼ˆæ ¸å¿ƒï¼‰ =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encodeFn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, image.width, image.height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ===== æ­¥éª¤5ï¼šç”ŸæˆBlobå’Œé¢„è§ˆURL =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> blob</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Blob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([result], { type: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.config.targetMime });</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.resultSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> blob.size;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®°å½•å‹ç¼©åå¤§å°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> resultImage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createObjectURL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(blob);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ===== æ­¥éª¤6ï¼šæ›´æ–°UIæ˜¾ç¤º =====</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">updateResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(resultImage);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.tracker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trackToolConflateCompleted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åŸ‹ç‚¹ï¼šå‹ç¼©å®Œæˆ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">showErrorMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(error);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> error;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><strong>æµç¨‹è¯¦è§£ï¼š</strong></p><p><strong>æ­¥éª¤1ï¼šè·å–å›¾ç‰‡ä¿¡æ¯</strong></p><ul><li><code>getImageSize()</code>å†…éƒ¨åˆ›å»º<code>Image</code>å¯¹è±¡åŠ è½½å›¾ç‰‡</li><li>è¿”å›åŸå§‹æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰å’Œ<code>HTMLImageElement</code>å¯¹è±¡</li><li>è¿™ä¸ªå¤§å°ç”¨äºåç»­è®¡ç®—å‹ç¼©ç‡</li></ul><p><strong>æ­¥éª¤2ï¼šCanvasè·å–åƒç´ æ•°æ®</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€æ­¥ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1. æµè§ˆå™¨ä¸­çš„å›¾ç‰‡å·²ç»æ˜¯è§£ç åçš„ï¼ˆPNG/JPEGè§£ç ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2. éœ€è¦è·å–åŸå§‹RGBAåƒç´ æ•°æ®æ‰èƒ½é‡æ–°ç¼–ç </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3. Canvasçš„getImageData()è¿”å›ImageDataå¯¹è±¡</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">imageData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    width: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1920</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    height: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1080</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Uint8ClampedArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8294400</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">R</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">G</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">B</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">R</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">G</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">B</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>æ­¥éª¤3ï¼šæ ¼å¼åˆ¤æ–­</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ ¹æ®ä¸Šä¼ æ–‡ä»¶çš„MIMEç±»å‹é€‰æ‹©ç¼–ç å™¨</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// MIME.png = &#39;image/png&#39;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// MIME.jpeg = &#39;image/jpeg&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (originMime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;image/png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    encodeFn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compressPng;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// PNGé‡åŒ–å‹ç¼©</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    encodeFn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compressJpg;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JPEG DCTå‹ç¼©</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>æ­¥éª¤4ï¼šæ‰§è¡Œå‹ç¼©</strong></p><ul><li>è°ƒç”¨WASMç¼–ç å™¨ï¼Œè¿™æ˜¯æ€§èƒ½å…³é”®è·¯å¾„</li><li>è¿”å›å‹ç¼©åçš„<code>ArrayBuffer</code>ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰</li></ul><p><strong>æ­¥éª¤5-6ï¼šç”Ÿæˆå¯é¢„è§ˆçš„URL</strong></p><ul><li>å°†<code>ArrayBuffer</code>åŒ…è£…æˆ<code>Blob</code>å¯¹è±¡</li><li><code>URL.createObjectURL()</code>åˆ›å»ºä¸´æ—¶URL</li><li>è¿™ä¸ªURLå¯ä»¥ç›´æ¥ç”¨äº<code>&lt;img&gt;</code>æ ‡ç­¾æ˜¾ç¤º</li></ul><hr><h4 id="_1-4-3-jpegå‹ç¼©å®ç°" tabindex="-1">1.4.3 JPEGå‹ç¼©å®ç° <a class="header-anchor" href="#_1-4-3-jpegå‹ç¼©å®ç°" aria-label="Permalink to &quot;1.4.3 JPEGå‹ç¼©å®ç°&quot;">â€‹</a></h4><p>JPEGå‹ç¼©è°ƒç”¨çš„æ˜¯MozJPEGç¼–ç å™¨ï¼ˆWebAssemblyï¼‰ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// @gaoding/squoosh-encoder/encoder.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mozjpeg_enc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./mozjpeg_enc.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// WASMæ¨¡å—</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { initEmscriptenModule } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./util.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wasmUrl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./mozjpeg_enc.wasm?url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// WASMäºŒè¿›åˆ¶æ–‡ä»¶</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å•ä¾‹æ¨¡å¼ï¼Œé¿å…é‡å¤åˆå§‹åŒ–</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. æ‡’åŠ è½½åˆå§‹åŒ–WASMæ¨¡å—ï¼ˆä»…ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">emscriptenModule) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        emscriptenModule </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initEmscriptenModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mozjpeg_enc, wasmUrl);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. è°ƒç”¨WASMçš„encodeå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // data.data: Uint8ClampedArray (RGBAåƒç´ æ•°æ®)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // data.width, data.height: å›¾ç‰‡å°ºå¯¸</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // options: å‹ç¼©é…ç½®ï¼ˆè´¨é‡ã€æ¸è¿›å¼ç­‰ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> resultView</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data.data, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data.width, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data.height, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        options</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. å¤åˆ¶ç»“æœï¼ˆä»WASMå†…å­˜åˆ°JSå †ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(resultView);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4. é‡Šæ”¾WASMå†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 5. è¿”å›ArrayBuffer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.buffer;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>å…³é”®æŠ€æœ¯ç‚¹ï¼š</strong></p><ol><li><strong>å•ä¾‹æ¨¡å¼</strong>ï¼š<code>emscriptenModule</code>åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œåç»­è°ƒç”¨å¤ç”¨</li><li><strong>å†…å­˜ç®¡ç†</strong>ï¼šå¿…é¡»æ‰‹åŠ¨è°ƒç”¨<code>free_result()</code>é‡Šæ”¾WASMå†…å­˜</li><li><strong>æ•°æ®å¤åˆ¶</strong>ï¼š<code>new Uint8Array(resultView)</code>å°†æ•°æ®ä»WASMå†…å­˜å¤åˆ¶åˆ°JSå †ï¼Œå› ä¸º<code>free_result()</code>ä¼šé‡Šæ”¾WASMå†…å­˜</li></ol><p><strong>é»˜è®¤å‹ç¼©é…ç½®ï¼š</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> defaultOptions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    quality: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">75</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è´¨é‡75ï¼ˆæ¨èå€¼ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    progressive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ¸è¿›å¼JPEG</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    optimize_coding: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼˜åŒ–Huffmanç¼–ç è¡¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    trellis_multipass: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Trellisä¼˜åŒ–ï¼ˆå…³é”®ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    trellis_opt_zero: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼˜åŒ–é›¶ç³»æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    trellis_opt_table: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼˜åŒ–é‡åŒ–è¡¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    color_space: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// YCbCré¢œè‰²ç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    chroma_subsample: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 4:2:0è‰²åº¦å­é‡‡æ ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    auto_subsample: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è‡ªåŠ¨å­é‡‡æ ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><hr><h4 id="_1-4-4-pngå‹ç¼©å®ç°" tabindex="-1">1.4.4 PNGå‹ç¼©å®ç° <a class="header-anchor" href="#_1-4-4-pngå‹ç¼©å®ç°" aria-label="Permalink to &quot;1.4.4 PNGå‹ç¼©å®ç°&quot;">â€‹</a></h4><p>PNGå‹ç¼©ä½¿ç”¨ImageQuantåº“ï¼ˆRust WASMï¼‰ï¼š</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// compress/services/image-quant/encode.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wasm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./imagequant_wasm_bg.wasm?url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> init, { compressImage } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./imagequant_wasm&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// RGBAåƒç´ æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    height</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. åˆå§‹åŒ–Rust WASMæ¨¡å—</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(wasm);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. è°ƒç”¨Rustç¼–å†™çš„å‹ç¼©å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // min=0, max=75: è´¨é‡èŒƒå›´0-75</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ImageQuantä¼šå°†24ä½çœŸå½©è‰²é‡åŒ–ä¸º8ä½ç´¢å¼•è‰²ï¼ˆ256è‰²ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> optAPNG</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buffer, width, height, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">75</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> optAPNG;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>ImageQuantå·¥ä½œåŸç†ï¼š</strong></p><ol><li><strong>é¢œè‰²é‡åŒ–</strong>ï¼šå°†1600ä¸‡è‰²ï¼ˆ24ä½ï¼‰é‡åŒ–ä¸º256è‰²ï¼ˆ8ä½ï¼‰</li><li><strong>è°ƒè‰²æ¿ä¼˜åŒ–</strong>ï¼šä½¿ç”¨ä¸­ä½åˆ‡åˆ†ç®—æ³•é€‰æ‹©æœ€ä¼˜çš„256ç§é¢œè‰²</li><li><strong>è¯¯å·®æ‰©æ•£</strong>ï¼šFloyd-SteinbergæŠ–åŠ¨ç®—æ³•ä¿æŒè§†è§‰è´¨é‡</li><li><strong>DEFLATEå‹ç¼©</strong>ï¼šå¯¹é‡åŒ–åçš„æ•°æ®è¿›è¡Œæ— æŸå‹ç¼©</li></ol><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// compress/services/image-quant/index.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { encode } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./encode&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressPng</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imgData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å°†ImageData.data (Uint8ClampedArray) è½¬æ¢ä¸º Uint8Array</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Uint8Array.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imgData.data), width, height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr><h3 id="_1-5-æ•°æ®æµè½¬å…¨æ™¯" tabindex="-1">1.5 æ•°æ®æµè½¬å…¨æ™¯ <a class="header-anchor" href="#_1-5-æ•°æ®æµè½¬å…¨æ™¯" aria-label="Permalink to &quot;1.5 æ•°æ®æµè½¬å…¨æ™¯&quot;">â€‹</a></h3><p>è®©æˆ‘ä»¬è¿½è¸ªä¸€å¼ å›¾ç‰‡ä»ä¸Šä¼ åˆ°ä¸‹è½½çš„å®Œæ•´æ•°æ®æµè½¬ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 1. ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶                                          â”‚</span></span>
<span class="line"><span>â”‚    Fileå¯¹è±¡ï¼ˆç£ç›˜æ–‡ä»¶ï¼‰                                  â”‚</span></span>
<span class="line"><span>â”‚    ä¾‹ï¼šphoto.jpg, 3.5MB                                 â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ FileReader.readAsDataURL()</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 2. Base64 Data URL                                      â”‚</span></span>
<span class="line"><span>â”‚    data:image/jpeg;base64,/9j/4AAQSkZJRg...            â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ new Image() â†’ image.src = dataURL</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 3. HTMLImageElementï¼ˆæµè§ˆå™¨è§£ç åçš„å›¾åƒï¼‰                â”‚</span></span>
<span class="line"><span>â”‚    image.width = 1920, image.height = 1080              â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ canvas.drawImage(image)</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 4. Canvas 2D Contextï¼ˆæ¸²æŸ“åœ¨Canvasä¸Šï¼‰                  â”‚</span></span>
<span class="line"><span>â”‚    canvas.width = 1920, canvas.height = 1080            â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ ctx.getImageData()</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 5. ImageDataå¯¹è±¡ï¼ˆåŸå§‹åƒç´ æ•°æ®ï¼‰                         â”‚</span></span>
<span class="line"><span>â”‚    {                                                     â”‚</span></span>
<span class="line"><span>â”‚      width: 1920,                                       â”‚</span></span>
<span class="line"><span>â”‚      height: 1080,                                      â”‚</span></span>
<span class="line"><span>â”‚      data: Uint8ClampedArray(8294400)                   â”‚</span></span>
<span class="line"><span>â”‚        [R1,G1,B1,A1, R2,G2,B2,A2, ...]                  â”‚</span></span>
<span class="line"><span>â”‚    }                                                    â”‚</span></span>
<span class="line"><span>â”‚    æœªå‹ç¼©å¤§å°ï¼š7.91MB                                    â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ compressJpg(imageData)</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 6. WebAssemblyå¤„ç†                                       â”‚</span></span>
<span class="line"><span>â”‚    â”œâ”€ JS â†’ WASMå†…å­˜ï¼ˆæ•°æ®å¤åˆ¶ï¼‰                         â”‚</span></span>
<span class="line"><span>â”‚    â”œâ”€ MozJPEG C++ç¼–ç                                    â”‚</span></span>
<span class="line"><span>â”‚    â”‚   â”œâ”€ RGB â†’ YCbCr                                   â”‚</span></span>
<span class="line"><span>â”‚    â”‚   â”œâ”€ è‰²åº¦å­é‡‡æ · 4:2:0                               â”‚</span></span>
<span class="line"><span>â”‚    â”‚   â”œâ”€ 8Ã—8åˆ†å—                                       â”‚</span></span>
<span class="line"><span>â”‚    â”‚   â”œâ”€ DCTå˜æ¢                                       â”‚</span></span>
<span class="line"><span>â”‚    â”‚   â”œâ”€ é‡åŒ–ï¼ˆä¿¡æ¯ä¸¢å¤±ï¼‰                               â”‚</span></span>
<span class="line"><span>â”‚    â”‚   â”œâ”€ Zå­—å½¢æ‰«æ + RLE                                â”‚</span></span>
<span class="line"><span>â”‚    â”‚   â””â”€ Huffmanç¼–ç                                    â”‚</span></span>
<span class="line"><span>â”‚    â””â”€ WASMå†…å­˜ â†’ JSï¼ˆç»“æœå¤åˆ¶ï¼‰                         â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ è¿”å›ArrayBuffer</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 7. å‹ç¼©åçš„äºŒè¿›åˆ¶æ•°æ®                                    â”‚</span></span>
<span class="line"><span>â”‚    ArrayBuffer(461824)  // 451KB                        â”‚</span></span>
<span class="line"><span>â”‚    [0xFF, 0xD8, 0xFF, 0xE0, ...]  // JPEGæ–‡ä»¶å¤´         â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ new Blob([arrayBuffer], {type: &#39;image/jpeg&#39;})</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 8. Blobå¯¹è±¡ï¼ˆå¯ä¸‹è½½çš„äºŒè¿›åˆ¶å¯¹è±¡ï¼‰                        â”‚</span></span>
<span class="line"><span>â”‚    Blob { size: 461824, type: &#39;image/jpeg&#39; }           â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ URL.createObjectURL(blob)</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 9. Blob URLï¼ˆä¸´æ—¶URLï¼‰                                   â”‚</span></span>
<span class="line"><span>â”‚    blob:http://localhost:3000/abc123-def456             â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ &lt;img src=&quot;blob:...&quot;&gt; / download</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 10. æœ€ç»ˆå±•ç¤º/ä¸‹è½½                                        â”‚</span></span>
<span class="line"><span>â”‚     â”œâ”€ é¢„è§ˆï¼šåœ¨&lt;img&gt;æ ‡ç­¾ä¸­æ˜¾ç¤º                           â”‚</span></span>
<span class="line"><span>â”‚     â””â”€ ä¸‹è½½ï¼šæµè§ˆå™¨ä¿å­˜ä¸ºphoto-compressed.jpg            â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p><strong>å…³é”®è½¬æ¢ç‚¹ï¼š</strong></p><ol><li><strong>File â†’ DataURL</strong>ï¼šç”¨æˆ·é€‰æ‹©æ–‡ä»¶åï¼Œéœ€è¦è¯»å–å†…å®¹</li><li><strong>DataURL â†’ Image</strong>ï¼šæµè§ˆå™¨è‡ªåŠ¨è§£ç ï¼ˆPNG/JPEG â†’ åƒç´ ï¼‰</li><li><strong>Image â†’ Canvas</strong>ï¼šç»˜åˆ¶åˆ°Canvasæ‰èƒ½è®¿é—®åƒç´ æ•°æ®</li><li><strong>Canvas â†’ ImageData</strong>ï¼šè·å–RGBAåŸå§‹åƒç´ æ•°ç»„</li><li><strong>ImageData â†’ ArrayBuffer</strong>ï¼šWASMå‹ç¼©ï¼Œè¾“å‡ºäºŒè¿›åˆ¶</li><li><strong>ArrayBuffer â†’ Blob</strong>ï¼šåŒ…è£…ä¸ºå¯ä¸‹è½½å¯¹è±¡</li><li><strong>Blob â†’ URL</strong>ï¼šåˆ›å»ºä¸´æ—¶é¢„è§ˆURL</li></ol><hr><h3 id="_1-6-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" tabindex="-1">1.6 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ <a class="header-anchor" href="#_1-6-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" aria-label="Permalink to &quot;1.6 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥&quot;">â€‹</a></h3><h4 id="_1-6-1-webassemblyæ€§èƒ½æå‡" tabindex="-1">1.6.1 WebAssemblyæ€§èƒ½æå‡ <a class="header-anchor" href="#_1-6-1-webassemblyæ€§èƒ½æå‡" aria-label="Permalink to &quot;1.6.1 WebAssemblyæ€§èƒ½æå‡&quot;">â€‹</a></h4><p><strong>å¯¹æ¯”æµ‹è¯•ï¼ˆ1920Ã—1080å›¾ç‰‡ï¼‰ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>çº¯JavaScript JPEGç¼–ç ï¼š    ~3200ms</span></span>
<span class="line"><span>MozJPEG WebAssemblyï¼š       ~280ms   â† æå‡11å€ï¼</span></span>
<span class="line"><span></span></span>
<span class="line"><span>çº¯JavaScript PNGé‡åŒ–ï¼š     ~1800ms</span></span>
<span class="line"><span>ImageQuant WASM (Rust)ï¼š    ~150ms   â† æå‡12å€ï¼</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>ä¸ºä»€ä¹ˆWASMè¿™ä¹ˆå¿«ï¼Ÿ</strong></p><ol><li><strong>ç¼–è¯‘å‹è¯­è¨€</strong>ï¼šC++/Rustç¼–è¯‘ä¸ºæœºå™¨ç ï¼ŒJSæ˜¯è§£é‡Šæ‰§è¡Œ</li><li><strong>SIMDæŒ‡ä»¤</strong>ï¼šWASMæ”¯æŒå‘é‡åŒ–è®¡ç®—ï¼ˆåŒæ—¶å¤„ç†å¤šä¸ªåƒç´ ï¼‰</li><li><strong>å†…å­˜è¿ç»­æ€§</strong>ï¼šWASMçº¿æ€§å†…å­˜ï¼ŒCPUç¼“å­˜å‹å¥½</li><li><strong>æ— GCå¼€é”€</strong>ï¼šæ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼Œæ— åƒåœ¾å›æ”¶åœé¡¿</li></ol><hr><h4 id="_1-6-2-æ‡’åŠ è½½wasmæ¨¡å—" tabindex="-1">1.6.2 æ‡’åŠ è½½WASMæ¨¡å— <a class="header-anchor" href="#_1-6-2-æ‡’åŠ è½½wasmæ¨¡å—" aria-label="Permalink to &quot;1.6.2 æ‡’åŠ è½½WASMæ¨¡å—&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// encoder.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å…¨å±€å•ä¾‹</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä»…åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶åˆå§‹åŒ–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">emscriptenModule) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        emscriptenModule </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initEmscriptenModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mozjpeg_enc, wasmUrl);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // åˆå§‹åŒ–è€—æ—¶çº¦50-100ms</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åç»­è°ƒç”¨ç›´æ¥å¤ç”¨</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>æ•ˆæœï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç¬¬ä¸€æ¬¡å‹ç¼©ï¼šWASMåŠ è½½(80ms) + å‹ç¼©(280ms) = 360ms</span></span>
<span class="line"><span>ç¬¬äºŒæ¬¡å‹ç¼©ï¼šå‹ç¼©(280ms) = 280ms  â† èŠ‚çœ80ms</span></span>
<span class="line"><span>ç¬¬ä¸‰æ¬¡å‹ç¼©ï¼šå‹ç¼©(280ms) = 280ms</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr><h4 id="_1-6-3-é”™è¯¯å¤„ç†å’Œé™çº§" tabindex="-1">1.6.3 é”™è¯¯å¤„ç†å’Œé™çº§ <a class="header-anchor" href="#_1-6-3-é”™è¯¯å¤„ç†å’Œé™çº§" aria-label="Permalink to &quot;1.6.3 é”™è¯¯å¤„ç†å’Œé™çº§&quot;">â€‹</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">async </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ­£å¸¸å‹ç¼©æµç¨‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encodeFn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, width, height);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">showErrorMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // é™çº§ç­–ç•¥ï¼šè¿”å›åŸå›¾</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç¡®ä¿ç”¨æˆ·è‡³å°‘èƒ½ä¸‹è½½åŸå›¾</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.resultImage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.originImage;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.resultSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.originSize;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ä¸ŠæŠ¥é”™è¯¯ï¼ˆç”¨äºç›‘æ§ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.tracker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trackError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;compress_failed&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            error: error.message,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            format: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.config.originMime,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><hr><h3 id="_1-7-å®é™…åº”ç”¨åœºæ™¯" tabindex="-1">1.7 å®é™…åº”ç”¨åœºæ™¯ <a class="header-anchor" href="#_1-7-å®é™…åº”ç”¨åœºæ™¯" aria-label="Permalink to &quot;1.7 å®é™…åº”ç”¨åœºæ™¯&quot;">â€‹</a></h3><h4 id="åœºæ™¯1-ç”µå•†äº§å“å›¾ä¼˜åŒ–" tabindex="-1">åœºæ™¯1ï¼šç”µå•†äº§å“å›¾ä¼˜åŒ– <a class="header-anchor" href="#åœºæ™¯1-ç”µå•†äº§å“å›¾ä¼˜åŒ–" aria-label="Permalink to &quot;åœºæ™¯1ï¼šç”µå•†äº§å“å›¾ä¼˜åŒ–&quot;">â€‹</a></h4><p><strong>ç—›ç‚¹ï¼š</strong></p><ul><li>å•†å®¶ä¸Šä¼ çš„äº§å“å›¾é€šå¸¸æ˜¯é«˜åˆ†è¾¨ç‡PNGï¼ˆ4-10MBï¼‰</li><li>é¡µé¢åŠ è½½æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒå’ŒSEO</li></ul><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹PNGï¼ˆ4.2MBï¼Œ3000Ã—3000ï¼‰</span></span>
<span class="line"><span>  â†“ InsMindå‹ç¼©</span></span>
<span class="line"><span>å‹ç¼©åPNGï¼ˆ820KBï¼Œ3000Ã—3000ï¼‰</span></span>
<span class="line"><span>  â†“ æ•ˆæœ</span></span>
<span class="line"><span>  Â· æ–‡ä»¶å‡å°80%</span></span>
<span class="line"><span>  Â· é¡µé¢åŠ è½½ä»8ç§’é™è‡³1.5ç§’</span></span>
<span class="line"><span>  Â· è§†è§‰è´¨é‡å‡ ä¹æ— æŸ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><hr><h4 id="åœºæ™¯2-ç”¨æˆ·å¤´åƒå¤„ç†" tabindex="-1">åœºæ™¯2ï¼šç”¨æˆ·å¤´åƒå¤„ç† <a class="header-anchor" href="#åœºæ™¯2-ç”¨æˆ·å¤´åƒå¤„ç†" aria-label="Permalink to &quot;åœºæ™¯2ï¼šç”¨æˆ·å¤´åƒå¤„ç†&quot;">â€‹</a></h4><p><strong>éœ€æ±‚ï¼š</strong></p><ul><li>ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒå¯èƒ½æ˜¯æ‰‹æœºæ‹æ‘„çš„ç…§ç‰‡ï¼ˆ3-8MBï¼‰</li><li>éœ€è¦å¿«é€Ÿå‹ç¼©å¹¶ç”Ÿæˆç¼©ç•¥å›¾</li></ul><p><strong>å®ç°ï¼š</strong></p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processAvatar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. å‹ç¼©åŸå›¾</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> compressed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compressService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">compress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åŸå›¾ï¼š3.5MB â†’ 450KB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. ç”Ÿæˆç¼©ç•¥å›¾</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> thumbnail</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> resizeImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(compressed, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç¼©ç•¥å›¾ï¼š450KB â†’ 15KB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. ä¸Šä¼ åˆ°CDN</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> urls</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uploadToOSS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([compressed, thumbnail]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        original: urls[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç”¨äºæŸ¥çœ‹å¤§å›¾</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        thumbnail: urls[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç”¨äºåˆ—è¡¨æ˜¾ç¤º</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><hr><h4 id="åœºæ™¯3-æ‰¹é‡å›¾ç‰‡å¤„ç†" tabindex="-1">åœºæ™¯3ï¼šæ‰¹é‡å›¾ç‰‡å¤„ç† <a class="header-anchor" href="#åœºæ™¯3-æ‰¹é‡å›¾ç‰‡å¤„ç†" aria-label="Permalink to &quot;åœºæ™¯3ï¼šæ‰¹é‡å›¾ç‰‡å¤„ç†&quot;">â€‹</a></h4><p><strong>éœ€æ±‚ï¼š</strong></p><ul><li>è®¾è®¡å¸ˆéœ€è¦æ‰¹é‡å‹ç¼©100å¼ å›¾ç‰‡</li><li>è¦æ±‚ä¿æŒæ–‡ä»¶å¤¹ç»“æ„å’Œæ–‡ä»¶å</li></ul><p><strong>å®ç°ï¼š</strong></p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressBatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> results</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> concurrency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¹¶å‘æ•°é™åˆ¶</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> files.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> concurrency) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> batch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> files.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">slice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> concurrency);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> batchResults</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            batch.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compressService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">compress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        results.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">batchResults);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ›´æ–°è¿›åº¦</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        updateProgress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> batch.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> files.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> results;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><hr><h3 id="_1-8-å°ç»“" tabindex="-1">1.8 å°ç»“ <a class="header-anchor" href="#_1-8-å°ç»“" aria-label="Permalink to &quot;1.8 å°ç»“&quot;">â€‹</a></h3><p>InsMindçš„å›¾ç‰‡å‹ç¼©å®ç°å±•ç¤ºäº†ç°ä»£Webåº”ç”¨çš„æœ€ä½³å®è·µï¼š</p><p><strong>æŠ€æœ¯äº®ç‚¹ï¼š</strong></p><ol><li>âœ… <strong>WebAssemblyåŠ é€Ÿ</strong>ï¼šæ€§èƒ½æå‡10å€ä»¥ä¸Š</li><li>âœ… <strong>è‡ªåŠ¨åŒ–æµç¨‹</strong>ï¼šç”¨æˆ·æ— éœ€é…ç½®ï¼Œä¸Šä¼ å³å‹ç¼©</li><li>âœ… <strong>æ ¼å¼è‡ªé€‚åº”</strong>ï¼šè‡ªåŠ¨è¯†åˆ«PNG/JPEGå¹¶é€‰æ‹©æœ€ä¼˜ç¼–ç å™¨</li><li>âœ… <strong>æ¸è¿›å¼ä½“éªŒ</strong>ï¼šå®æ—¶æ˜¾ç¤ºå‹ç¼©è¿›åº¦å’Œå¯¹æ¯”æ•ˆæœ</li><li>âœ… <strong>ç”Ÿäº§çº§è´¨é‡</strong>ï¼šMozJPEGçš„Trellisä¼˜åŒ–ï¼ŒImageQuantçš„é¢œè‰²é‡åŒ–</li></ol><p><strong>æ¶æ„ä¼˜åŠ¿ï¼š</strong></p><ol><li>âœ… <strong>æ¸…æ™°çš„åˆ†å±‚</strong>ï¼šUIå±‚ã€ä¸šåŠ¡å±‚ã€ç¼–ç å±‚èŒè´£åˆ†æ˜</li><li>âœ… <strong>å•ä¸€èŒè´£</strong>ï¼šCompressServiceä¸“æ³¨å‹ç¼©é€»è¾‘ï¼Œä¸å¤„ç†UI</li><li>âœ… <strong>å¯æ‰©å±•æ€§</strong>ï¼šè½»æ¾æ·»åŠ æ–°æ ¼å¼ï¼ˆWebPã€AVIFï¼‰</li><li>âœ… <strong>å¯æµ‹è¯•æ€§</strong>ï¼šæ ¸å¿ƒé€»è¾‘ç‹¬ç«‹ï¼Œæ˜“äºå•å…ƒæµ‹è¯•</li></ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥å›¾åƒåŸºç¡€çŸ¥è¯†ï¼Œç†è§£å‹ç¼©ç®—æ³•çš„æ•°å­¦åŸç†ï¼Œçœ‹çœ‹WASMå†…éƒ¨ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><hr><h2 id="äºŒã€å›¾åƒåŸºç¡€çŸ¥è¯†" tabindex="-1">äºŒã€å›¾åƒåŸºç¡€çŸ¥è¯† <a class="header-anchor" href="#äºŒã€å›¾åƒåŸºç¡€çŸ¥è¯†" aria-label="Permalink to &quot;äºŒã€å›¾åƒåŸºç¡€çŸ¥è¯†&quot;">â€‹</a></h2><h3 id="_2-1-æ•°å­—å›¾åƒçš„æœ¬è´¨" tabindex="-1">2.1 æ•°å­—å›¾åƒçš„æœ¬è´¨ <a class="header-anchor" href="#_2-1-æ•°å­—å›¾åƒçš„æœ¬è´¨" aria-label="Permalink to &quot;2.1 æ•°å­—å›¾åƒçš„æœ¬è´¨&quot;">â€‹</a></h3><p>åœ¨è®¡ç®—æœºä¸­ï¼Œå›¾åƒæ˜¯ç”±**åƒç´ ï¼ˆPixelï¼‰**ç»„æˆçš„äºŒç»´çŸ©é˜µã€‚æ¯ä¸ªåƒç´ å­˜å‚¨äº†é¢œè‰²ä¿¡æ¯ã€‚</p><h4 id="åƒç´ æ•°æ®ç»“æ„" tabindex="-1">åƒç´ æ•°æ®ç»“æ„ <a class="header-anchor" href="#åƒç´ æ•°æ®ç»“æ„" aria-label="Permalink to &quot;åƒç´ æ•°æ®ç»“æ„&quot;">â€‹</a></h4><p>ä¸€ä¸ªå…¸å‹çš„åƒç´ åŒ…å«4ä¸ªé€šé“ï¼ˆRGBAï¼‰ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åƒç´  = [R, G, B, A]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ul><li><strong>R (Red)</strong>ï¼šçº¢è‰²é€šé“ï¼Œ0-255</li><li><strong>G (Green)</strong>ï¼šç»¿è‰²é€šé“ï¼Œ0-255</li><li><strong>B (Blue)</strong>ï¼šè“è‰²é€šé“ï¼Œ0-255</li><li><strong>A (Alpha)</strong>ï¼šé€æ˜åº¦é€šé“ï¼Œ0-255ï¼ˆ0=å®Œå…¨é€æ˜ï¼Œ255=å®Œå…¨ä¸é€æ˜ï¼‰</li></ul><p><strong>ç¤ºä¾‹ï¼š</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸€ä¸ªçº¯çº¢è‰²ä¸é€æ˜åƒç´ </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pixel</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸€ä¸ªåŠé€æ˜è“è‰²åƒç´ </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bluePixel</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="å›¾åƒæ•°æ®å¤§å°è®¡ç®—" tabindex="-1">å›¾åƒæ•°æ®å¤§å°è®¡ç®— <a class="header-anchor" href="#å›¾åƒæ•°æ®å¤§å°è®¡ç®—" aria-label="Permalink to &quot;å›¾åƒæ•°æ®å¤§å°è®¡ç®—&quot;">â€‹</a></h4><p>å¯¹äºä¸€å¼ æœªå‹ç¼©çš„å›¾åƒï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ•°æ®å¤§å° = å®½åº¦ Ã— é«˜åº¦ Ã— æ¯åƒç´ å­—èŠ‚æ•°</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>è®¡ç®—ç¤ºä¾‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1920Ã—1080 çš„ RGBA å›¾åƒï¼š</span></span>
<span class="line"><span>= 1920 Ã— 1080 Ã— 4 å­—èŠ‚</span></span>
<span class="line"><span>= 8,294,400 å­—èŠ‚</span></span>
<span class="line"><span>â‰ˆ 7.91 MB</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å‹ç¼©ï¼ä¸€å¼ å…¨é«˜æ¸…å›¾ç‰‡æœªå‹ç¼©å°±è¦è¿‘8MBã€‚</p><hr><h3 id="_2-2-é¢œè‰²ç©ºé—´" tabindex="-1">2.2 é¢œè‰²ç©ºé—´ <a class="header-anchor" href="#_2-2-é¢œè‰²ç©ºé—´" aria-label="Permalink to &quot;2.2 é¢œè‰²ç©ºé—´&quot;">â€‹</a></h3><h4 id="rgb-é¢œè‰²ç©ºé—´" tabindex="-1">RGB é¢œè‰²ç©ºé—´ <a class="header-anchor" href="#rgb-é¢œè‰²ç©ºé—´" aria-label="Permalink to &quot;RGB é¢œè‰²ç©ºé—´&quot;">â€‹</a></h4><p><strong>å®šä¹‰ï¼š</strong> åŸºäºä¸‰åŸè‰²ï¼ˆçº¢ã€ç»¿ã€è“ï¼‰çš„åŠ è‰²æ¨¡å‹ã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ä»»æ„é¢œè‰² = Î±R + Î²G + Î³B</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>ç‰¹ç‚¹ï¼š</strong></p><ul><li>âœ… ç›´è§‚æ˜“æ‡‚</li><li>âœ… ç¡¬ä»¶å‹å¥½ï¼ˆæ˜¾ç¤ºå™¨ç›´æ¥ä½¿ç”¨ï¼‰</li><li>âŒ ä¸ç¬¦åˆäººçœ¼è§†è§‰ç‰¹æ€§</li><li>âŒ å‹ç¼©æ•ˆç‡ä½</li></ul><h4 id="ycbcr-é¢œè‰²ç©ºé—´" tabindex="-1">YCbCr é¢œè‰²ç©ºé—´ <a class="header-anchor" href="#ycbcr-é¢œè‰²ç©ºé—´" aria-label="Permalink to &quot;YCbCr é¢œè‰²ç©ºé—´&quot;">â€‹</a></h4><p><strong>å®šä¹‰ï¼š</strong> åˆ†ç¦»äº®åº¦ï¼ˆYï¼‰å’Œè‰²åº¦ï¼ˆCbã€Crï¼‰çš„é¢œè‰²æ¨¡å‹ã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Y  = äº®åº¦åˆ†é‡ï¼ˆLuminanceï¼‰</span></span>
<span class="line"><span>Cb = è“è‰²è‰²åº¦åˆ†é‡ï¼ˆChroma Blueï¼‰</span></span>
<span class="line"><span>Cr = çº¢è‰²è‰²åº¦åˆ†é‡ï¼ˆChroma Redï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>è½¬æ¢å…¬å¼ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Y  = 0.299R + 0.587G + 0.114B</span></span>
<span class="line"><span>Cb = -0.169R - 0.331G + 0.500B + 128</span></span>
<span class="line"><span>Cr = 0.500R - 0.419G - 0.081B + 128</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨YCbCrï¼Ÿ</strong></p><p>äººçœ¼å¯¹äº®åº¦å˜åŒ–éå¸¸æ•æ„Ÿï¼Œä½†å¯¹è‰²åº¦å˜åŒ–ä¸æ•æ„Ÿã€‚è¿™ä¸ªç‰¹æ€§è¢«JPEGå‹ç¼©åˆ©ç”¨ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>äººçœ¼æ•æ„Ÿåº¦ï¼š</span></span>
<span class="line"><span>  äº®åº¦(Y)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (é«˜)</span></span>
<span class="line"><span>  è‰²åº¦(Cb) â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ (ä½)</span></span>
<span class="line"><span>  è‰²åº¦(Cr) â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ (ä½)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å› æ­¤å¯ä»¥ï¼š</p><ul><li><strong>Yé€šé“</strong>ï¼šä¿æŒé«˜åˆ†è¾¨ç‡</li><li><strong>Cb/Cré€šé“</strong>ï¼šé™ä½åˆ†è¾¨ç‡ï¼ˆè‰²åº¦å­é‡‡æ ·ï¼‰</li></ul><p><strong>å‹ç¼©æ•ˆæœï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹RGBæ•°æ®ï¼š1920Ã—1080Ã—3 = 6.22MB</span></span>
<span class="line"><span>YCbCr 4:2:0é‡‡æ ·åï¼š</span></span>
<span class="line"><span>  Y:  1920Ã—1080Ã—1 = 2.07MB</span></span>
<span class="line"><span>  Cb: 960Ã—540Ã—1   = 0.52MB</span></span>
<span class="line"><span>  Cr: 960Ã—540Ã—1   = 0.52MB</span></span>
<span class="line"><span>  æ€»è®¡ï¼š3.11MB (èŠ‚çœ50%ï¼)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr><h3 id="_2-3-å›¾åƒæ•°æ®åœ¨canvasä¸­çš„è¡¨ç¤º" tabindex="-1">2.3 å›¾åƒæ•°æ®åœ¨Canvasä¸­çš„è¡¨ç¤º <a class="header-anchor" href="#_2-3-å›¾åƒæ•°æ®åœ¨canvasä¸­çš„è¡¨ç¤º" aria-label="Permalink to &quot;2.3 å›¾åƒæ•°æ®åœ¨Canvasä¸­çš„è¡¨ç¤º&quot;">â€‹</a></h3><p>åœ¨Webå¼€å‘ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡Canvas APIè·å–å›¾åƒæ•°æ®ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è·å–Canvasçš„2Dä¸Šä¸‹æ–‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> canvas</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;canvas&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">canvas.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image.width;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">canvas.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image.height;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> canvas.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2d&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç»˜åˆ¶å›¾åƒ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drawImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è·å–åƒç´ æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> imageData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getImageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, canvas.width, canvas.height);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>ImageDataç»“æ„ï¼š</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1920</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å›¾åƒå®½åº¦</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1080</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å›¾åƒé«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Uint8ClampedArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8294400</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) [</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åƒç´ æŒ‰è¡Œå­˜å‚¨ï¼Œæ¯ä¸ªåƒç´ 4ä¸ªå­—èŠ‚</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    R1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">G1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">B1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">A1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¬¬1ä¸ªåƒç´ </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    R2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">G2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">B2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">A2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¬¬2ä¸ªåƒç´ </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>è®¿é—®ç‰¹å®šåƒç´ ï¼š</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getPixel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">y</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> index</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imageData.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    imageData.data[index],     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// R</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    imageData.data[index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// G</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    imageData.data[index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    imageData.data[index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// A</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><hr><h2 id="ä¸‰ã€å‹ç¼©åŸç†æ¦‚è¿°" tabindex="-1">ä¸‰ã€å‹ç¼©åŸç†æ¦‚è¿° <a class="header-anchor" href="#ä¸‰ã€å‹ç¼©åŸç†æ¦‚è¿°" aria-label="Permalink to &quot;ä¸‰ã€å‹ç¼©åŸç†æ¦‚è¿°&quot;">â€‹</a></h2><h3 id="_3-1-ä¸ºä»€ä¹ˆéœ€è¦å‹ç¼©" tabindex="-1">3.1 ä¸ºä»€ä¹ˆéœ€è¦å‹ç¼©ï¼Ÿ <a class="header-anchor" href="#_3-1-ä¸ºä»€ä¹ˆéœ€è¦å‹ç¼©" aria-label="Permalink to &quot;3.1 ä¸ºä»€ä¹ˆéœ€è¦å‹ç¼©ï¼Ÿ&quot;">â€‹</a></h3><p><strong>å­˜å‚¨æˆæœ¬ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æœªå‹ç¼©å›¾åƒå­˜å‚¨éœ€æ±‚ï¼š</span></span>
<span class="line"><span>- 1000å¼  1920Ã—1080 å›¾ç‰‡ = 7.91GB</span></span>
<span class="line"><span>- å‹ç¼©åˆ°JPEG (è´¨é‡90) = çº¦200MB</span></span>
<span class="line"><span>- å‹ç¼©ç‡ï¼šçº¦97.5%</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>ä¼ è¾“æˆæœ¬ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç½‘ç»œä¼ è¾“æ—¶é—´ï¼ˆ4Gç½‘ç»œï¼Œä¸‹è½½é€Ÿåº¦10Mbpsï¼‰ï¼š</span></span>
<span class="line"><span>- æœªå‹ç¼©8MBå›¾ç‰‡ï¼š6.4ç§’</span></span>
<span class="line"><span>- å‹ç¼©åˆ°200KBå›¾ç‰‡ï¼š0.16ç§’</span></span>
<span class="line"><span>- æå‡40å€ï¼</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><hr><h3 id="_3-2-å‹ç¼©çš„æœ¬è´¨" tabindex="-1">3.2 å‹ç¼©çš„æœ¬è´¨ <a class="header-anchor" href="#_3-2-å‹ç¼©çš„æœ¬è´¨" aria-label="Permalink to &quot;3.2 å‹ç¼©çš„æœ¬è´¨&quot;">â€‹</a></h3><p>å‹ç¼©æ˜¯<strong>ä¿¡æ¯è®º</strong>åœ¨å›¾åƒé¢†åŸŸçš„åº”ç”¨ï¼Œæ ¸å¿ƒæ€æƒ³ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ¶ˆé™¤å†—ä½™ + åˆ©ç”¨äººçœ¼ç‰¹æ€§ = å‹ç¼©</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="å†—ä½™ç±»å‹" tabindex="-1">å†—ä½™ç±»å‹ <a class="header-anchor" href="#å†—ä½™ç±»å‹" aria-label="Permalink to &quot;å†—ä½™ç±»å‹&quot;">â€‹</a></h4><p><strong>1. ç©ºé—´å†—ä½™ï¼ˆSpatial Redundancyï¼‰</strong></p><p>ç›¸é‚»åƒç´ é€šå¸¸ç›¸ä¼¼ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹æ•°æ®ï¼š[100, 101, 102, 103, 104, 105]</span></span>
<span class="line"><span>å·®åˆ†ç¼–ç ï¼š[100, +1,  +1,  +1,  +1,  +1]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>2. æ—¶é—´å†—ä½™ï¼ˆTemporal Redundancyï¼‰</strong></p><p>è§†é¢‘ç›¸é‚»å¸§ç›¸ä¼¼ï¼ˆæœ¬æ–‡ä¸æ¶‰åŠï¼‰ã€‚</p><p><strong>3. å¿ƒç†è§†è§‰å†—ä½™ï¼ˆPsychovisual Redundancyï¼‰</strong></p><p>äººçœ¼å¯¹æŸäº›ä¿¡æ¯ä¸æ•æ„Ÿï¼Œå¯ä»¥ä¸¢å¼ƒï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>é«˜é¢‘ç»†èŠ‚   â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ ä¸æ•æ„Ÿï¼Œå¯ä¸¢å¼ƒ</span></span>
<span class="line"><span>è‰²åº¦ä¿¡æ¯   â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ ä¸æ•æ„Ÿï¼Œå¯é™é‡‡æ ·</span></span>
<span class="line"><span>äº®åº¦ä¿¡æ¯   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ æ•æ„Ÿï¼Œå¿…é¡»ä¿ç•™</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr><h3 id="_3-3-å‹ç¼©åˆ†ç±»" tabindex="-1">3.3 å‹ç¼©åˆ†ç±» <a class="header-anchor" href="#_3-3-å‹ç¼©åˆ†ç±»" aria-label="Permalink to &quot;3.3 å‹ç¼©åˆ†ç±»&quot;">â€‹</a></h3><h4 id="æ— æŸå‹ç¼©-lossless-compression" tabindex="-1">æ— æŸå‹ç¼©ï¼ˆLossless Compressionï¼‰ <a class="header-anchor" href="#æ— æŸå‹ç¼©-lossless-compression" aria-label="Permalink to &quot;æ— æŸå‹ç¼©ï¼ˆLossless Compressionï¼‰&quot;">â€‹</a></h4><p><strong>å®šä¹‰ï¼š</strong> å‹ç¼©åå¯ä»¥å®Œå…¨æ¢å¤åŸå§‹æ•°æ®ã€‚</p><p><strong>å…¸å‹ç®—æ³•ï¼š</strong></p><ul><li><strong>RLEï¼ˆRun-Length Encodingï¼‰</strong>ï¼šæ¸¸ç¨‹ç¼–ç </li><li><strong>Huffmanç¼–ç </strong>ï¼šå˜é•¿ç¼–ç </li><li><strong>LZ77/LZ78</strong>ï¼šå­—å…¸ç¼–ç </li><li><strong>DEFLATE</strong>ï¼šLZ77 + Huffmanï¼ˆPNGä½¿ç”¨ï¼‰</li></ul><p><strong>ç¤ºä¾‹ï¼šRLEç¼–ç </strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹ï¼šAAAAAABBBBCCCC</span></span>
<span class="line"><span>ç¼–ç ï¼š6A 4B 4C</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p><ul><li>PNGæ ¼å¼</li><li>åŒ»å­¦å½±åƒ</li><li>æ–‡æ¡£æ‰«æ</li><li>éœ€è¦ç²¾ç¡®è¿˜åŸçš„å›¾åƒ</li></ul><h4 id="æœ‰æŸå‹ç¼©-lossy-compression" tabindex="-1">æœ‰æŸå‹ç¼©ï¼ˆLossy Compressionï¼‰ <a class="header-anchor" href="#æœ‰æŸå‹ç¼©-lossy-compression" aria-label="Permalink to &quot;æœ‰æŸå‹ç¼©ï¼ˆLossy Compressionï¼‰&quot;">â€‹</a></h4><p><strong>å®šä¹‰ï¼š</strong> ä¸¢å¼ƒéƒ¨åˆ†ä¿¡æ¯ï¼Œæ¢å–æ›´é«˜å‹ç¼©ç‡ï¼Œä½†æ— æ³•å®Œå…¨æ¢å¤åŸå§‹æ•°æ®ã€‚</p><p><strong>å…¸å‹ç®—æ³•ï¼š</strong></p><ul><li><strong>DCTå˜æ¢</strong>ï¼ˆJPEGä½¿ç”¨ï¼‰</li><li><strong>å°æ³¢å˜æ¢</strong>ï¼ˆJPEG2000ä½¿ç”¨ï¼‰</li><li><strong>é‡åŒ–</strong>ï¼šé™ä½æ•°æ®ç²¾åº¦</li></ul><p><strong>ç¤ºä¾‹ï¼šé‡åŒ–</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹é«˜ç²¾åº¦æ•°æ®ï¼š[123.456, 234.789, 345.012]</span></span>
<span class="line"><span>é‡åŒ–åï¼ˆæ•´æ•°ï¼‰ï¼š  [123,     235,     345]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p><ul><li>JPEGæ ¼å¼</li><li>ç…§ç‰‡å‹ç¼©</li><li>Webå›¾ç‰‡</li><li>è§†é¢‘å‹ç¼©</li></ul><h4 id="å‹ç¼©ç‡å¯¹æ¯”" tabindex="-1">å‹ç¼©ç‡å¯¹æ¯” <a class="header-anchor" href="#å‹ç¼©ç‡å¯¹æ¯”" aria-label="Permalink to &quot;å‹ç¼©ç‡å¯¹æ¯”&quot;">â€‹</a></h4><table tabindex="0"><thead><tr><th>æ ¼å¼</th><th>ç±»å‹</th><th>å‹ç¼©ç‡</th><th>è´¨é‡</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>BMP</strong></td><td>æ— å‹ç¼©</td><td>1:1</td><td>å®Œç¾</td><td>åŸå§‹æ•°æ®</td></tr><tr><td><strong>PNG</strong></td><td>æ— æŸ</td><td>3:1 ~ 10:1</td><td>å®Œç¾</td><td>å›¾æ ‡ã€æˆªå›¾</td></tr><tr><td><strong>JPEG</strong></td><td>æœ‰æŸ</td><td>10:1 ~ 50:1</td><td>ä¼˜ç§€</td><td>ç…§ç‰‡ã€Web</td></tr><tr><td><strong>WebP</strong></td><td>æœ‰æŸ/æ— æŸ</td><td>15:1 ~ 60:1</td><td>ä¼˜ç§€</td><td>ç°ä»£Web</td></tr></tbody></table><hr><h2 id="å››ã€jpegå‹ç¼©æ·±åº¦è§£æ" tabindex="-1">å››ã€JPEGå‹ç¼©æ·±åº¦è§£æ <a class="header-anchor" href="#å››ã€jpegå‹ç¼©æ·±åº¦è§£æ" aria-label="Permalink to &quot;å››ã€JPEGå‹ç¼©æ·±åº¦è§£æ&quot;">â€‹</a></h2><h3 id="_4-1-jpegå‹ç¼©æµç¨‹æ¦‚è§ˆ" tabindex="-1">4.1 JPEGå‹ç¼©æµç¨‹æ¦‚è§ˆ <a class="header-anchor" href="#_4-1-jpegå‹ç¼©æµç¨‹æ¦‚è§ˆ" aria-label="Permalink to &quot;4.1 JPEGå‹ç¼©æµç¨‹æ¦‚è§ˆ&quot;">â€‹</a></h3><p>JPEGä½¿ç”¨çš„æ˜¯<strong>æœ‰æŸå‹ç¼©</strong>ï¼Œæ•´ä¸ªæµç¨‹åˆ†ä¸º7ä¸ªæ­¥éª¤ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚                      JPEG å‹ç¼©æµç¨‹                           â”‚</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span>
<span class="line"><span>â”‚                                                              â”‚</span></span>
<span class="line"><span>â”‚  åŸå§‹å›¾åƒ (RGB)                                              â”‚</span></span>
<span class="line"><span>â”‚       â†“                                                      â”‚</span></span>
<span class="line"><span>â”‚  â‘  é¢œè‰²ç©ºé—´è½¬æ¢ (RGB â†’ YCbCr)                               â”‚</span></span>
<span class="line"><span>â”‚       â†“                                                      â”‚</span></span>
<span class="line"><span>â”‚  â‘¡ è‰²åº¦å­é‡‡æ · (Chroma Subsampling)                          â”‚</span></span>
<span class="line"><span>â”‚       â†“                                                      â”‚</span></span>
<span class="line"><span>â”‚  â‘¢ åˆ†å— (8Ã—8å—åˆ’åˆ†)                                         â”‚</span></span>
<span class="line"><span>â”‚       â†“                                                      â”‚</span></span>
<span class="line"><span>â”‚  â‘£ ç¦»æ•£ä½™å¼¦å˜æ¢ (DCT)         â† æ ¸å¿ƒç®—æ³•                   â”‚</span></span>
<span class="line"><span>â”‚       â†“                                                      â”‚</span></span>
<span class="line"><span>â”‚  â‘¤ é‡åŒ– (Quantization)        â† ä¸»è¦ä¿¡æ¯ä¸¢å¤±ä½ç½®            â”‚</span></span>
<span class="line"><span>â”‚       â†“                                                      â”‚</span></span>
<span class="line"><span>â”‚  â‘¥ Zå­—å½¢æ‰«æ + æ¸¸ç¨‹ç¼–ç  (RLE)                               â”‚</span></span>
<span class="line"><span>â”‚       â†“                                                      â”‚</span></span>
<span class="line"><span>â”‚  â‘¦ ç†µç¼–ç  (Huffman/Arithmetic)                              â”‚</span></span>
<span class="line"><span>â”‚       â†“                                                      â”‚</span></span>
<span class="line"><span>â”‚  å‹ç¼©æ•°æ®                                                    â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>è®©æˆ‘ä»¬é€æ­¥æ·±å…¥æ¯ä¸ªç¯èŠ‚ã€‚</p><hr><h3 id="_4-2-æ­¥éª¤1-é¢œè‰²ç©ºé—´è½¬æ¢" tabindex="-1">4.2 æ­¥éª¤â‘  é¢œè‰²ç©ºé—´è½¬æ¢ <a class="header-anchor" href="#_4-2-æ­¥éª¤1-é¢œè‰²ç©ºé—´è½¬æ¢" aria-label="Permalink to &quot;4.2 æ­¥éª¤â‘  é¢œè‰²ç©ºé—´è½¬æ¢&quot;">â€‹</a></h3><p><strong>ç›®çš„ï¼š</strong> å°†RGBè½¬æ¢ä¸ºYCbCrï¼Œåˆ†ç¦»äº®åº¦å’Œè‰²åº¦ã€‚</p><p><strong>ä»£ç å®ç°ï¼š</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// mozjpeg_enc.cpp (ç¬¬119è¡Œ)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo.input_components </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           // RGBA 4ä¸ªåˆ†é‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo.in_color_space </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JCS_EXT_RGBA;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è¾“å…¥é¢œè‰²ç©ºé—´</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¬¬126è¡Œï¼šè®¾ç½®è¾“å‡ºé¢œè‰²ç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jpeg_set_colorspace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, (J_COLOR_SPACE) opts.color_space);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é€šå¸¸è®¾ç½®ä¸º JCS_YCbCr</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>è½¬æ¢çŸ©é˜µï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œ   â”   â”Œ                    â” â”Œ   â”</span></span>
<span class="line"><span>â”‚ Y â”‚   â”‚  0.299  0.587  0.114â”‚ â”‚ R â”‚</span></span>
<span class="line"><span>â”‚Cb â”‚ = â”‚ -0.169 -0.331  0.500â”‚ â”‚ G â”‚ + â”‚  0 â”‚</span></span>
<span class="line"><span>â”‚Cr â”‚   â”‚  0.500 -0.419 -0.081â”‚ â”‚ B â”‚   â”‚128â”‚</span></span>
<span class="line"><span>â””   â”˜   â””                    â”˜ â””   â”˜   â””   â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>æ•ˆæœæ¼”ç¤ºï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹RGBåƒç´ ï¼šR=200, G=100, B=50</span></span>
<span class="line"><span></span></span>
<span class="line"><span>è½¬æ¢åï¼š</span></span>
<span class="line"><span>Y  = 0.299Ã—200 + 0.587Ã—100 + 0.114Ã—50 = 124.3 (äº®åº¦)</span></span>
<span class="line"><span>Cb = -0.169Ã—200 - 0.331Ã—100 + 0.500Ã—50 + 128 = 79.2 (è“è‰²åº¦)</span></span>
<span class="line"><span>Cr = 0.500Ã—200 - 0.419Ã—100 - 0.081Ã—50 + 128 = 182.4 (çº¢è‰²åº¦)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr><h3 id="_4-3-æ­¥éª¤2-è‰²åº¦å­é‡‡æ ·" tabindex="-1">4.3 æ­¥éª¤â‘¡ è‰²åº¦å­é‡‡æ · <a class="header-anchor" href="#_4-3-æ­¥éª¤2-è‰²åº¦å­é‡‡æ ·" aria-label="Permalink to &quot;4.3 æ­¥éª¤â‘¡ è‰²åº¦å­é‡‡æ ·&quot;">â€‹</a></h3><p><strong>åŸç†ï¼š</strong> äººçœ¼å¯¹è‰²åº¦ä¸æ•æ„Ÿï¼Œå¯ä»¥é™ä½Cbã€Crçš„åˆ†è¾¨ç‡ã€‚</p><h4 id="é‡‡æ ·æ¨¡å¼" tabindex="-1">é‡‡æ ·æ¨¡å¼ <a class="header-anchor" href="#é‡‡æ ·æ¨¡å¼" aria-label="Permalink to &quot;é‡‡æ ·æ¨¡å¼&quot;">â€‹</a></h4><p><strong>4:4:4 - æ— å­é‡‡æ ·</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Yåˆ†é‡ï¼š  â–  â–  â–  â–     å®Œæ•´åˆ†è¾¨ç‡</span></span>
<span class="line"><span>Cbåˆ†é‡ï¼š â–  â–  â–  â–     å®Œæ•´åˆ†è¾¨ç‡</span></span>
<span class="line"><span>Cråˆ†é‡ï¼š â–  â–  â–  â–     å®Œæ•´åˆ†è¾¨ç‡</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>4:2:2 - æ°´å¹³2:1å­é‡‡æ ·</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Yåˆ†é‡ï¼š  â–  â–  â–  â–     å®Œæ•´åˆ†è¾¨ç‡</span></span>
<span class="line"><span>Cbåˆ†é‡ï¼š â–  â–‘ â–  â–‘    æ°´å¹³å‡åŠ</span></span>
<span class="line"><span>Cråˆ†é‡ï¼š â–  â–‘ â–  â–‘    æ°´å¹³å‡åŠ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>4:2:0 - æ°´å¹³å’Œå‚ç›´2:1å­é‡‡æ ·ï¼ˆæœ€å¸¸ç”¨ï¼‰</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Yåˆ†é‡ï¼š  â–  â–  â–  â–     å®Œæ•´åˆ†è¾¨ç‡</span></span>
<span class="line"><span>         â–  â–  â–  â– </span></span>
<span class="line"><span>Cbåˆ†é‡ï¼š â–  â–‘ â–  â–‘    æ°´å¹³+å‚ç›´å‡åŠ</span></span>
<span class="line"><span>         â–‘ â–‘ â–‘ â–‘</span></span>
<span class="line"><span>Cråˆ†é‡ï¼š â–  â–‘ â–  â–‘    æ°´å¹³+å‚ç›´å‡åŠ</span></span>
<span class="line"><span>         â–‘ â–‘ â–‘ â–‘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>æ•°æ®é‡å¯¹æ¯”ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>4:4:4: (Y + Cb + Cr) = 1 + 1 + 1 = 3 å­—èŠ‚/åƒç´ </span></span>
<span class="line"><span>4:2:2: Y + Cb/2 + Cr/2 = 1 + 0.5 + 0.5 = 2 å­—èŠ‚/åƒç´  (èŠ‚çœ33%)</span></span>
<span class="line"><span>4:2:0: Y + Cb/4 + Cr/4 = 1 + 0.25 + 0.25 = 1.5 å­—èŠ‚/åƒç´  (èŠ‚çœ50%)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>ä»£ç å®ç°ï¼š</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// mozjpeg_enc.cpp (ç¬¬158-161è¡Œ)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">opts.auto_subsample </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.color_space </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JCS_YCbCr) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.comp_info[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].h_samp_factor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.chroma_subsample;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.comp_info[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].v_samp_factor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.chroma_subsample;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><hr><h3 id="_4-4-æ­¥éª¤3-åˆ†å—å¤„ç†" tabindex="-1">4.4 æ­¥éª¤â‘¢ åˆ†å—å¤„ç† <a class="header-anchor" href="#_4-4-æ­¥éª¤3-åˆ†å—å¤„ç†" aria-label="Permalink to &quot;4.4 æ­¥éª¤â‘¢ åˆ†å—å¤„ç†&quot;">â€‹</a></h3><p><strong>åŸç†ï¼š</strong> å°†å›¾åƒåˆ’åˆ†ä¸º<strong>8Ã—8åƒç´ å—</strong>ï¼Œæ¯ä¸ªå—ç‹¬ç«‹å¤„ç†ã€‚</p><h4 id="ä¸ºä»€ä¹ˆæ˜¯8Ã—8" tabindex="-1">ä¸ºä»€ä¹ˆæ˜¯8Ã—8ï¼Ÿ <a class="header-anchor" href="#ä¸ºä»€ä¹ˆæ˜¯8Ã—8" aria-label="Permalink to &quot;ä¸ºä»€ä¹ˆæ˜¯8Ã—8ï¼Ÿ&quot;">â€‹</a></h4><ol><li><strong>DCTå˜æ¢æ•ˆç‡</strong>ï¼š8ç‚¹DCTæœ‰å¿«é€Ÿç®—æ³•</li><li><strong>å±€éƒ¨ç›¸å…³æ€§</strong>ï¼š8Ã—8èŒƒå›´å†…åƒç´ é€šå¸¸ç›¸ä¼¼</li><li><strong>ç¡¬ä»¶å‹å¥½</strong>ï¼š8Ã—8çŸ©é˜µæ˜“äºå¹¶è¡Œè®¡ç®—</li></ol><p><strong>åˆ†å—ç¤ºæ„ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹å›¾åƒ 1920Ã—1080</span></span>
<span class="line"><span>    â†“</span></span>
<span class="line"><span>åˆ’åˆ†ä¸º 240Ã—135 = 32,400 ä¸ª 8Ã—8 å—</span></span>
<span class="line"><span>    â†“</span></span>
<span class="line"><span>æ¯ä¸ªå—ç‹¬ç«‹è¿›è¡Œ DCT + é‡åŒ–</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>è¾¹ç•Œå¤„ç†ï¼š</strong></p><p>å¦‚æœå›¾åƒå°ºå¯¸ä¸æ˜¯8çš„å€æ•°ï¼Œéœ€è¦å¡«å……ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å®é™…å°ºå¯¸ï¼š1922Ã—1081</span></span>
<span class="line"><span>å¡«å……åï¼š  1928Ã—1088 (å‘ä¸Šå–æ•´åˆ°8çš„å€æ•°)</span></span>
<span class="line"><span>å¡«å……æ–¹å¼ï¼šè¾¹ç¼˜åƒç´ é‡å¤æˆ–é•œåƒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr><h3 id="_4-5-æ­¥éª¤4-ç¦»æ•£ä½™å¼¦å˜æ¢-dct" tabindex="-1">4.5 æ­¥éª¤â‘£ ç¦»æ•£ä½™å¼¦å˜æ¢ï¼ˆDCTï¼‰ <a class="header-anchor" href="#_4-5-æ­¥éª¤4-ç¦»æ•£ä½™å¼¦å˜æ¢-dct" aria-label="Permalink to &quot;4.5 æ­¥éª¤â‘£ ç¦»æ•£ä½™å¼¦å˜æ¢ï¼ˆDCTï¼‰&quot;">â€‹</a></h3><h4 id="dctçš„æœ¬è´¨" tabindex="-1">DCTçš„æœ¬è´¨ <a class="header-anchor" href="#dctçš„æœ¬è´¨" aria-label="Permalink to &quot;DCTçš„æœ¬è´¨&quot;">â€‹</a></h4><p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong> å°†ç©ºåŸŸä¿¡å·è½¬æ¢ä¸ºé¢‘åŸŸä¿¡å·ã€‚</p><p><strong>æ•°å­¦å…¬å¼ï¼š</strong></p><p>å¯¹äº8Ã—8å— <code>f(x,y)</code>ï¼ŒDCTå˜æ¢ä¸º <code>F(u,v)</code>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>F(u,v) = (1/4) C(u)C(v) Î£ Î£ f(x,y) cos[(2x+1)uÏ€/16] cos[(2y+1)vÏ€/16]</span></span>
<span class="line"><span>                        x=0 y=0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>å…¶ä¸­ï¼š</span></span>
<span class="line"><span>  C(u) = 1/âˆš2  (u=0)</span></span>
<span class="line"><span>  C(u) = 1     (uâ‰ 0)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>é€šä¿—ç†è§£ï¼š</strong></p><p>DCTå°†å›¾åƒåˆ†è§£ä¸ºä¸åŒé¢‘ç‡çš„ä½™å¼¦æ³¢çš„å åŠ ã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ä½é¢‘åˆ†é‡ï¼šè¡¨ç¤ºå›¾åƒçš„æ•´ä½“è¶‹åŠ¿ï¼ˆå¹³æ»‘åŒºåŸŸï¼‰</span></span>
<span class="line"><span>é«˜é¢‘åˆ†é‡ï¼šè¡¨ç¤ºå›¾åƒçš„ç»†èŠ‚å˜åŒ–ï¼ˆè¾¹ç¼˜ã€çº¹ç†ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="dctç¤ºä¾‹" tabindex="-1">DCTç¤ºä¾‹ <a class="header-anchor" href="#dctç¤ºä¾‹" aria-label="Permalink to &quot;DCTç¤ºä¾‹&quot;">â€‹</a></h4><p><strong>è¾“å…¥ï¼š8Ã—8ç°åº¦å—</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹åƒç´ å€¼ï¼ˆYåˆ†é‡ï¼‰ï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 150 150 150 150 150 150 150 150 â”‚</span></span>
<span class="line"><span>â”‚ 150 150 150 150 150 150 150 150 â”‚</span></span>
<span class="line"><span>â”‚ 150 150 150 150 150 150 150 150 â”‚</span></span>
<span class="line"><span>â”‚ 100 100 100 100 100 100 100 100 â”‚  â† ä¸ŠåŠäº®ï¼Œä¸‹åŠæš—</span></span>
<span class="line"><span>â”‚ 100 100 100 100 100 100 100 100 â”‚</span></span>
<span class="line"><span>â”‚ 100 100 100 100 100 100 100 100 â”‚</span></span>
<span class="line"><span>â”‚ 100 100 100 100 100 100 100 100 â”‚</span></span>
<span class="line"><span>â”‚ 100 100 100 100 100 100 100 100 â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>DCTå˜æ¢åï¼ˆé¢‘åŸŸç³»æ•°ï¼‰ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 1000  0    0    0  â”‚ 0  0  0  0 â”‚  â† DCç³»æ•°ï¼ˆå·¦ä¸Šè§’ï¼‰</span></span>
<span class="line"><span>â”‚  -200 -50   0    0  â”‚ 0  0  0  0 â”‚  â† ä½é¢‘ï¼ˆå·¦ä¸ŠåŒºåŸŸï¼‰</span></span>
<span class="line"><span>â”‚   0    0    0    0  â”‚ 0  0  0  0 â”‚</span></span>
<span class="line"><span>â”‚   0    0    0    0  â”‚ 0  0  0  0 â”‚</span></span>
<span class="line"><span>â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span></span>
<span class="line"><span>â”‚   0    0    0    0  â”‚ 0  0  0  0 â”‚  â† é«˜é¢‘ï¼ˆå³ä¸‹åŒºåŸŸï¼‰</span></span>
<span class="line"><span>â”‚   0    0    0    0  â”‚ 0  0  0  0 â”‚</span></span>
<span class="line"><span>â”‚   0    0    0    0  â”‚ 0  0  0  0 â”‚</span></span>
<span class="line"><span>â”‚   0    0    0    0  â”‚ 0  0  0  0 â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç‰¹ç‚¹ï¼š</span></span>
<span class="line"><span>1. å·¦ä¸Šè§’DCç³»æ•°æœ€å¤§ï¼ˆ1000ï¼‰ï¼Œè¡¨ç¤ºå¹³å‡äº®åº¦</span></span>
<span class="line"><span>2. èƒ½é‡é›†ä¸­åœ¨å·¦ä¸Šè§’ï¼ˆä½é¢‘åŒºï¼‰</span></span>
<span class="line"><span>3. å³ä¸‹è§’ï¼ˆé«˜é¢‘åŒºï¼‰æ¥è¿‘0</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="dctçš„æ„ä¹‰" tabindex="-1">DCTçš„æ„ä¹‰ <a class="header-anchor" href="#dctçš„æ„ä¹‰" aria-label="Permalink to &quot;DCTçš„æ„ä¹‰&quot;">â€‹</a></h4><p><strong>èƒ½é‡å‹ç¼©æ€§ï¼š</strong></p><p>å¤§éƒ¨åˆ†èƒ½é‡é›†ä¸­åœ¨å°‘æ•°ä½é¢‘ç³»æ•°ä¸Šï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>èƒ½é‡åˆ†å¸ƒï¼š</span></span>
<span class="line"><span>å·¦ä¸Šè§’ 10% çš„ç³»æ•° â†’ åŒ…å« 90% çš„èƒ½é‡</span></span>
<span class="line"><span>å³ä¸‹è§’ 90% çš„ç³»æ•° â†’ åªåŒ…å« 10% çš„èƒ½é‡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>å› æ­¤ï¼Œå¯ä»¥å¤§èƒ†åœ°é‡åŒ–/ä¸¢å¼ƒé«˜é¢‘ç³»æ•°ï¼</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><hr><h3 id="_4-6-æ­¥éª¤5-é‡åŒ–-æ ¸å¿ƒä¿¡æ¯ä¸¢å¤±ç¯èŠ‚" tabindex="-1">4.6 æ­¥éª¤â‘¤ é‡åŒ–ï¼ˆæ ¸å¿ƒä¿¡æ¯ä¸¢å¤±ç¯èŠ‚ï¼‰ <a class="header-anchor" href="#_4-6-æ­¥éª¤5-é‡åŒ–-æ ¸å¿ƒä¿¡æ¯ä¸¢å¤±ç¯èŠ‚" aria-label="Permalink to &quot;4.6 æ­¥éª¤â‘¤ é‡åŒ–ï¼ˆæ ¸å¿ƒä¿¡æ¯ä¸¢å¤±ç¯èŠ‚ï¼‰&quot;">â€‹</a></h3><h4 id="é‡åŒ–çš„æœ¬è´¨" tabindex="-1">é‡åŒ–çš„æœ¬è´¨ <a class="header-anchor" href="#é‡åŒ–çš„æœ¬è´¨" aria-label="Permalink to &quot;é‡åŒ–çš„æœ¬è´¨&quot;">â€‹</a></h4><p><strong>å®šä¹‰ï¼š</strong> ç”¨é‡åŒ–è¡¨é™¤ä»¥DCTç³»æ•°ï¼Œå¹¶å››èˆäº”å…¥ï¼Œé™ä½ç²¾åº¦ã€‚</p><p><strong>å…¬å¼ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>é‡åŒ–åç³»æ•° = round(DCTç³»æ•° / é‡åŒ–è¡¨å¯¹åº”å€¼)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="é‡åŒ–è¡¨" tabindex="-1">é‡åŒ–è¡¨ <a class="header-anchor" href="#é‡åŒ–è¡¨" aria-label="Permalink to &quot;é‡åŒ–è¡¨&quot;">â€‹</a></h4><p>JPEGæ ‡å‡†å®šä¹‰äº†æ ‡å‡†é‡åŒ–è¡¨ï¼Œä½†å¯ä»¥è‡ªå®šä¹‰ï¼š</p><p><strong>äº®åº¦ï¼ˆYï¼‰é‡åŒ–è¡¨ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  16  11  10  16  24   40   51   61    â”‚  â† å·¦ä¸Šè§’å€¼å°ï¼ˆä½é¢‘ä¿ç•™ç²¾åº¦ï¼‰</span></span>
<span class="line"><span>â”‚  12  12  14  19  26   58   60   55    â”‚</span></span>
<span class="line"><span>â”‚  14  13  16  24  40   57   69   56    â”‚</span></span>
<span class="line"><span>â”‚  14  17  22  29  51   87   80   62    â”‚</span></span>
<span class="line"><span>â”‚  18  22  37  56  68  109  103   77    â”‚</span></span>
<span class="line"><span>â”‚  24  35  55  64  81  104  113   92    â”‚</span></span>
<span class="line"><span>â”‚  49  64  78  87 103  121  120  101    â”‚</span></span>
<span class="line"><span>â”‚  72  92  95  98 112  100  103   99    â”‚  â† å³ä¸‹è§’å€¼å¤§ï¼ˆé«˜é¢‘å¯ä¸¢å¼ƒï¼‰</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>è‰²åº¦ï¼ˆCb/Crï¼‰é‡åŒ–è¡¨ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  17  18  24  47  99  99  99  99       â”‚  â† å€¼æ›´å¤§ï¼ˆè‰²åº¦æ›´ä¸é‡è¦ï¼‰</span></span>
<span class="line"><span>â”‚  18  21  26  66  99  99  99  99       â”‚</span></span>
<span class="line"><span>â”‚  24  26  56  99  99  99  99  99       â”‚</span></span>
<span class="line"><span>â”‚  47  66  99  99  99  99  99  99       â”‚</span></span>
<span class="line"><span>â”‚  99  99  99  99  99  99  99  99       â”‚</span></span>
<span class="line"><span>â”‚  99  99  99  99  99  99  99  99       â”‚</span></span>
<span class="line"><span>â”‚  99  99  99  99  99  99  99  99       â”‚</span></span>
<span class="line"><span>â”‚  99  99  99  99  99  99  99  99       â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="é‡åŒ–è¿‡ç¨‹ç¤ºä¾‹" tabindex="-1">é‡åŒ–è¿‡ç¨‹ç¤ºä¾‹ <a class="header-anchor" href="#é‡åŒ–è¿‡ç¨‹ç¤ºä¾‹" aria-label="Permalink to &quot;é‡åŒ–è¿‡ç¨‹ç¤ºä¾‹&quot;">â€‹</a></h4><p><strong>DCTç³»æ•°ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 1000  -200  -100   50  â”‚ 20 10 5 2â”‚</span></span>
<span class="line"><span>â”‚ -150   100    50   30  â”‚ 15  8 4 1â”‚</span></span>
<span class="line"><span>â”‚  -80    60    40   20  â”‚ 10  5 2 0â”‚</span></span>
<span class="line"><span>â”‚   50    40    30   15  â”‚  8  4 1 0â”‚</span></span>
<span class="line"><span>â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span></span>
<span class="line"><span>â”‚   30    20    15   10  â”‚  5  2 0 0â”‚</span></span>
<span class="line"><span>â”‚   20    10     8    5  â”‚  2  1 0 0â”‚</span></span>
<span class="line"><span>â”‚   10     5     4    2  â”‚  1  0 0 0â”‚</span></span>
<span class="line"><span>â”‚    5     2     1    0  â”‚  0  0 0 0â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>åº”ç”¨é‡åŒ–è¡¨ï¼ˆå‡è®¾è´¨é‡ç³»æ•°=50%ï¼‰ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>é‡åŒ–åç³»æ•° = round(DCTç³»æ•° / é‡åŒ–è¡¨)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 1000/16 = 63  -200/11 = -18  ...â”‚</span></span>
<span class="line"><span>â”‚ -150/12 = -13  100/12 = 8    ...â”‚</span></span>
<span class="line"><span>â”‚  ...                             â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç»“æœï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  63  -18  -10   3  â”‚  1  0  0  0â”‚</span></span>
<span class="line"><span>â”‚ -13    8    4   2  â”‚  1  0  0  0â”‚</span></span>
<span class="line"><span>â”‚  -6    5    3   1  â”‚  0  0  0  0â”‚</span></span>
<span class="line"><span>â”‚   4    2    1   1  â”‚  0  0  0  0â”‚</span></span>
<span class="line"><span>â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span></span>
<span class="line"><span>â”‚   1    1    0   0  â”‚  0  0  0  0â”‚</span></span>
<span class="line"><span>â”‚   0    0    0   0  â”‚  0  0  0  0â”‚</span></span>
<span class="line"><span>â”‚   0    0    0   0  â”‚  0  0  0  0â”‚</span></span>
<span class="line"><span>â”‚   0    0    0   0  â”‚  0  0  0  0â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>è§‚å¯Ÿï¼š</span></span>
<span class="line"><span>1. é«˜é¢‘ç³»æ•°ï¼ˆå³ä¸‹è§’ï¼‰å¤§é‡å˜ä¸º0</span></span>
<span class="line"><span>2. ä½é¢‘ç³»æ•°ï¼ˆå·¦ä¸Šè§’ï¼‰ä¿ç•™</span></span>
<span class="line"><span>3. è¿™å°±æ˜¯å‹ç¼©çš„æ ¸å¿ƒï¼</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="è´¨é‡å‚æ•°ä¸é‡åŒ–è¡¨çš„å…³ç³»" tabindex="-1">è´¨é‡å‚æ•°ä¸é‡åŒ–è¡¨çš„å…³ç³» <a class="header-anchor" href="#è´¨é‡å‚æ•°ä¸é‡åŒ–è¡¨çš„å…³ç³»" aria-label="Permalink to &quot;è´¨é‡å‚æ•°ä¸é‡åŒ–è¡¨çš„å…³ç³»&quot;">â€‹</a></h4><p><strong>è´¨é‡å‚æ•°ï¼ˆQualityï¼‰ï¼š0-100</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è´¨é‡è¶Šé«˜ â†’ é‡åŒ–è¡¨æ•°å€¼è¶Šå° â†’ é™¤æ³•åç²¾åº¦æŸå¤±å° â†’ æ–‡ä»¶å¤§ä½†è´¨é‡å¥½</span></span>
<span class="line"><span>è´¨é‡è¶Šä½ â†’ é‡åŒ–è¡¨æ•°å€¼è¶Šå¤§ â†’ é™¤æ³•åç²¾åº¦æŸå¤±å¤§ â†’ æ–‡ä»¶å°ä½†è´¨é‡å·®</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>è®¡ç®—å…¬å¼ï¼ˆMozJPEGï¼‰ï¼š</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è´¨é‡50ä»¥ä¸‹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">scale </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> quality;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è´¨é‡50-100</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">scale </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 200</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> quality;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¼©æ”¾é‡åŒ–è¡¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">quantTable[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (stdTable[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> scale </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>ç¤ºä¾‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ ‡å‡†è¡¨æŸä½ç½®å€¼ï¼š16</span></span>
<span class="line"><span></span></span>
<span class="line"><span>è´¨é‡100ï¼š quantTable = (16 Ã— 0 + 50) / 100 â‰ˆ 1  ï¼ˆæœ€å°ï¼‰</span></span>
<span class="line"><span>è´¨é‡90ï¼š  quantTable = (16 Ã— 20 + 50) / 100 = 4</span></span>
<span class="line"><span>è´¨é‡75ï¼š  quantTable = (16 Ã— 50 + 50) / 100 = 9</span></span>
<span class="line"><span>è´¨é‡50ï¼š  quantTable = (16 Ã— 100 + 50) / 100 = 17</span></span>
<span class="line"><span>è´¨é‡25ï¼š  quantTable = (16 Ã— 300 + 50) / 100 = 49 ï¼ˆå¤§é‡ä¸¢å¤±ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><hr><h3 id="_4-7-æ­¥éª¤6-zå­—å½¢æ‰«æä¸æ¸¸ç¨‹ç¼–ç " tabindex="-1">4.7 æ­¥éª¤â‘¥ Zå­—å½¢æ‰«æä¸æ¸¸ç¨‹ç¼–ç  <a class="header-anchor" href="#_4-7-æ­¥éª¤6-zå­—å½¢æ‰«æä¸æ¸¸ç¨‹ç¼–ç " aria-label="Permalink to &quot;4.7 æ­¥éª¤â‘¥ Zå­—å½¢æ‰«æä¸æ¸¸ç¨‹ç¼–ç &quot;">â€‹</a></h3><h4 id="zå­—å½¢æ‰«æ" tabindex="-1">Zå­—å½¢æ‰«æ <a class="header-anchor" href="#zå­—å½¢æ‰«æ" aria-label="Permalink to &quot;Zå­—å½¢æ‰«æ&quot;">â€‹</a></h4><p><strong>ç›®çš„ï¼š</strong> å°†2DçŸ©é˜µè½¬æ¢ä¸º1Dåºåˆ—ï¼Œåˆ©äºæ¸¸ç¨‹ç¼–ç ã€‚</p><p><strong>æ‰«æé¡ºåºï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>é‡åŒ–åçš„8Ã—8å—ï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 63 -18 -10  3 â”‚  1  0  0  0    â”‚</span></span>
<span class="line"><span>â”‚-13   8   4  2 â”‚  1  0  0  0    â”‚</span></span>
<span class="line"><span>â”‚ -6   5   3  1 â”‚  0  0  0  0    â”‚</span></span>
<span class="line"><span>â”‚  4   2   1  1 â”‚  0  0  0  0    â”‚</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚</span></span>
<span class="line"><span>â”‚  1   1   0  0 â”‚  0  0  0  0    â”‚</span></span>
<span class="line"><span>â”‚  0   0   0  0 â”‚  0  0  0  0    â”‚</span></span>
<span class="line"><span>â”‚  0   0   0  0 â”‚  0  0  0  0    â”‚</span></span>
<span class="line"><span>â”‚  0   0   0  0 â”‚  0  0  0  0    â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Zå­—å½¢æ‰«æè·¯å¾„ï¼ˆä»å·¦ä¸Šåˆ°å³ä¸‹ï¼‰ï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  1â†’ 2   5   6 â”‚ 15 16 28 29    â”‚</span></span>
<span class="line"><span>â”‚  â†“  â†—   â†—  â†™  â”‚ â†—  â†™  â†—  ...   â”‚</span></span>
<span class="line"><span>â”‚  3   4   7  14â”‚ 17 27 ...       â”‚</span></span>
<span class="line"><span>â”‚  â†“   â†™   â†—  â†™ â”‚ ...             â”‚</span></span>
<span class="line"><span>â”‚  8   9  13 ...â”‚                 â”‚</span></span>
<span class="line"><span>â”‚ ...            â”‚                 â”‚</span></span>
<span class="line"><span>â”‚ 55 56 57 58 59 60 61 62 63      â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ‰«æååºåˆ—ï¼š</span></span>
<span class="line"><span>[63, -18, -13, -10, 8, 4, 3, 5, 2, -6, 4, 3, 2, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, ...]</span></span>
<span class="line"><span> â””â”€DCç³»æ•°  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ä½é¢‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€é«˜é¢‘ï¼ˆå¤§é‡0ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>ä¸ºä»€ä¹ˆZå­—å½¢ï¼Ÿ</strong></p><p>å› ä¸ºé‡åŒ–åï¼Œé«˜é¢‘ç³»æ•°ï¼ˆå³ä¸‹è§’ï¼‰å¤§é‡ä¸º0ï¼ŒZå­—å½¢æ‰«æå0ä¼šé›†ä¸­åœ¨åºåˆ—æœ«å°¾ï¼Œä¾¿äºæ¸¸ç¨‹ç¼–ç ã€‚</p><h4 id="æ¸¸ç¨‹ç¼–ç -rle" tabindex="-1">æ¸¸ç¨‹ç¼–ç ï¼ˆRLEï¼‰ <a class="header-anchor" href="#æ¸¸ç¨‹ç¼–ç -rle" aria-label="Permalink to &quot;æ¸¸ç¨‹ç¼–ç ï¼ˆRLEï¼‰&quot;">â€‹</a></h4><p><strong>åŸç†ï¼š</strong> è¿ç»­çš„ç›¸åŒå€¼å¯ä»¥å‹ç¼©ä¸º <code>(å€¼, é‡å¤æ¬¡æ•°)</code> çš„å½¢å¼ã€‚</p><p><strong>ç¤ºä¾‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹åºåˆ—ï¼š[1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 2]</span></span>
<span class="line"><span>æ¸¸ç¨‹ç¼–ç ï¼š[(1, 3), (0, 7), (2, 1)]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>JPEGä¸­çš„RLEï¼š</strong></p><p>JPEGå¯¹ACç³»æ•°ï¼ˆéDCç³»æ•°ï¼‰ä½¿ç”¨ç‰¹æ®Šçš„æ¸¸ç¨‹ç¼–ç ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ ¼å¼ï¼š(è·³è¿‡çš„0çš„ä¸ªæ•°, éé›¶å€¼)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>åºåˆ—ï¼š[1, 1, 1, 0, 0, 0, 0, 2, 0, 0, 3]</span></span>
<span class="line"><span>ç¼–ç ï¼š(0,1), (0,1), (0,1), (4,2), (2,3)</span></span>
<span class="line"><span>      ^      ^      ^       ^       ^</span></span>
<span class="line"><span>      |      |      |       |       |</span></span>
<span class="line"><span>    æ— 0ç›´æ¥  æ— 0    æ— 0   å‰4ä¸ª0   å‰2ä¸ª0</span></span>
<span class="line"><span>    è¾“å‡º1    è¾“å‡º1  è¾“å‡º1  ç„¶å2    ç„¶å3</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>ç‰¹æ®Šç¬¦å·ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>(0, 0) = EOB (End Of Block) è¡¨ç¤ºå—ç»“æŸï¼Œåé¢å…¨æ˜¯0</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>å‹ç¼©æ•ˆæœï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹64ä¸ªç³»æ•°ï¼š[63, -18, -13, ..., 0, 0, 0, ..., 0] (åé¢40ä¸ª0)</span></span>
<span class="line"><span>RLEåï¼š[(0,63), (0,-18), (0,-13), ..., EOB]</span></span>
<span class="line"><span>èŠ‚çœï¼š40ä¸ª0 â†’ 1ä¸ªEOBç¬¦å·</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr><h3 id="_4-8-æ­¥éª¤7-ç†µç¼–ç -huffmanç¼–ç " tabindex="-1">4.8 æ­¥éª¤â‘¦ ç†µç¼–ç ï¼ˆHuffmanç¼–ç ï¼‰ <a class="header-anchor" href="#_4-8-æ­¥éª¤7-ç†µç¼–ç -huffmanç¼–ç " aria-label="Permalink to &quot;4.8 æ­¥éª¤â‘¦ ç†µç¼–ç ï¼ˆHuffmanç¼–ç ï¼‰&quot;">â€‹</a></h3><h4 id="huffmanç¼–ç åŸç†" tabindex="-1">Huffmanç¼–ç åŸç† <a class="header-anchor" href="#huffmanç¼–ç åŸç†" aria-label="Permalink to &quot;Huffmanç¼–ç åŸç†&quot;">â€‹</a></h4><p><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong> é¢‘ç¹å‡ºç°çš„ç¬¦å·ç”¨çŸ­ç è¡¨ç¤ºï¼Œç½•è§ç¬¦å·ç”¨é•¿ç è¡¨ç¤ºã€‚</p><p><strong>æ„å»ºè¿‡ç¨‹ï¼š</strong></p><ol><li><strong>ç»Ÿè®¡é¢‘ç‡</strong></li></ol><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç¬¦å·ï¼š  A    B    C    D    E</span></span>
<span class="line"><span>é¢‘ç‡ï¼š  45%  13%  12%  16%  14%</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li><strong>æ„å»ºHuffmanæ ‘</strong></li></ol><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>              100%</span></span>
<span class="line"><span>             /    \\</span></span>
<span class="line"><span>          A/      \\</span></span>
<span class="line"><span>         45%      55%</span></span>
<span class="line"><span>                 /    \\</span></span>
<span class="line"><span>                /      \\</span></span>
<span class="line"><span>              25%      30%</span></span>
<span class="line"><span>             /  \\      /  \\</span></span>
<span class="line"><span>           C   D     E    B</span></span>
<span class="line"><span>          12% 16%   14%  13%</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="3"><li><strong>ç”Ÿæˆç¼–ç </strong></li></ol><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç¬¦å·  é¢‘ç‡  ç¼–ç </span></span>
<span class="line"><span>A     45%   0       (1ä½ï¼Œæœ€é¢‘ç¹)</span></span>
<span class="line"><span>D     16%   100     (3ä½)</span></span>
<span class="line"><span>E     14%   101     (3ä½)</span></span>
<span class="line"><span>B     13%   110     (3ä½)</span></span>
<span class="line"><span>C     12%   111     (3ä½)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>å‹ç¼©æ•ˆæœï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹ï¼ˆå›ºå®š3ä½ï¼‰ï¼š3ä½/ç¬¦å· Ã— 100ç¬¦å· = 300ä½</span></span>
<span class="line"><span>Huffmanç¼–ç ï¼š   45Ã—1 + 13Ã—3 + 12Ã—3 + 16Ã—3 + 14Ã—3 = 210ä½</span></span>
<span class="line"><span>å‹ç¼©ç‡ï¼š30%</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="jpegä¸­çš„huffmanç¼–ç " tabindex="-1">JPEGä¸­çš„Huffmanç¼–ç  <a class="header-anchor" href="#jpegä¸­çš„huffmanç¼–ç " aria-label="Permalink to &quot;JPEGä¸­çš„Huffmanç¼–ç &quot;">â€‹</a></h4><p><strong>ä¸¤å¥—Huffmanè¡¨ï¼š</strong></p><ol><li><strong>DCç³»æ•°è¡¨</strong>ï¼šç¼–ç æ¯ä¸ª8Ã—8å—çš„DCç³»æ•°ï¼ˆå·¦ä¸Šè§’ï¼‰</li><li><strong>ACç³»æ•°è¡¨</strong>ï¼šç¼–ç å…¶ä½™63ä¸ªACç³»æ•°</li></ol><p><strong>ä»£ç å®ç°ï¼š</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// mozjpeg_enc.cpp (ç¬¬132è¡Œ)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo.optimize_coding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.optimize_coding;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¬¬134-137è¡Œï¼šç®—æœ¯ç¼–ç é€‰é¡¹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (opts.arithmetic) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.arith_code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRUE;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // ä½¿ç”¨ç®—æœ¯ç¼–ç ï¼ˆæ›´é«˜æ•ˆï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.optimize_coding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FALSE;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // å…³é—­Huffmanä¼˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>ä¼˜åŒ–é€‰é¡¹ï¼š</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¬¬141-144è¡Œï¼šTrellisä¼˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jpeg_c_set_bool_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JBOOLEAN_USE_SCANS_IN_TRELLIS, opts.trellis_multipass);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jpeg_c_set_bool_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JBOOLEAN_TRELLIS_EOB_OPT, opts.trellis_opt_zero);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jpeg_c_set_bool_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JBOOLEAN_TRELLIS_Q_OPT, opts.trellis_opt_table);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jpeg_c_set_int_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JINT_TRELLIS_NUM_LOOPS, opts.trellis_loops);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><hr><h3 id="_4-9-mozjpegç‰¹æ®Šä¼˜åŒ–" tabindex="-1">4.9 MozJPEGç‰¹æ®Šä¼˜åŒ– <a class="header-anchor" href="#_4-9-mozjpegç‰¹æ®Šä¼˜åŒ–" aria-label="Permalink to &quot;4.9 MozJPEGç‰¹æ®Šä¼˜åŒ–&quot;">â€‹</a></h3><p>MozJPEGæ˜¯Mozillaå¼€å‘çš„JPEGç¼–ç å™¨ï¼Œæ¯”æ ‡å‡†JPEGæœ‰æ›´å¥½çš„å‹ç¼©æ•ˆæœã€‚</p><h4 id="æ ¸å¿ƒä¼˜åŒ–æŠ€æœ¯" tabindex="-1">æ ¸å¿ƒä¼˜åŒ–æŠ€æœ¯ <a class="header-anchor" href="#æ ¸å¿ƒä¼˜åŒ–æŠ€æœ¯" aria-label="Permalink to &quot;æ ¸å¿ƒä¼˜åŒ–æŠ€æœ¯&quot;">â€‹</a></h4><p><strong>1. Trellisé‡åŒ–</strong></p><p>æ ‡å‡†é‡åŒ–ï¼šç®€å•å››èˆäº”å…¥</p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Q </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> round</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DCT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> quantTable)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Trellisé‡åŒ–ï¼šè€ƒè™‘åç»­ç¼–ç å¼€é”€ï¼Œé€‰æ‹©æœ€ä¼˜é‡åŒ–å€¼</p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸ä»…è€ƒè™‘è¯¯å·®ï¼Œè¿˜è€ƒè™‘ç¼–ç åçš„bitæ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> distortion </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Î» Ã— bits</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>æ•ˆæœï¼š</strong> ç›¸åŒè§†è§‰è´¨é‡ä¸‹ï¼Œæ–‡ä»¶å‡å°5-10%</p><p><strong>2. è‡ªåŠ¨é‡åŒ–è¡¨é€‰æ‹©</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// mozjpeg_enc.cpp (ç¬¬128-130è¡Œ)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (opts.quant_table </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_c_set_int_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JINT_BASE_QUANT_TBL_IDX, opts.quant_table);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>MozJPEGæä¾›å¤šå¥—é‡åŒ–è¡¨ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€é€‚åˆå›¾åƒçš„ä¸€å¥—ã€‚</p><p><strong>3. è‰²åº¦è´¨é‡åˆ†ç¦»</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// mozjpeg_enc.cpp (ç¬¬150-152è¡Œ)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (opts.separate_chroma_quality </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.color_space </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JCS_YCbCr) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    quality_str </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;,&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to_string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.chroma_quality);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>äº®åº¦å’Œè‰²åº¦å¯ä»¥ä½¿ç”¨ä¸åŒè´¨é‡å‚æ•°ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>äº®åº¦è´¨é‡ï¼š90  ï¼ˆä¿æŒç»†èŠ‚ï¼‰</span></span>
<span class="line"><span>è‰²åº¦è´¨é‡ï¼š75  ï¼ˆå¯ä»¥æ›´ä½ï¼ŒèŠ‚çœç©ºé—´ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>4. æ¸è¿›å¼JPEG</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// mozjpeg_enc.cpp (ç¬¬163-168è¡Œ)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">opts.baseline </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.progressive) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_simple_progression</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.num_scans </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.scan_info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>æ¸è¿›å¼ vs åŸºçº¿å¼ï¼š</strong></p><table tabindex="0"><thead><tr><th>ç‰¹æ€§</th><th>åŸºçº¿å¼ï¼ˆBaselineï¼‰</th><th>æ¸è¿›å¼ï¼ˆProgressiveï¼‰</th></tr></thead><tbody><tr><td>ç¼–ç æ–¹å¼</td><td>ä»ä¸Šåˆ°ä¸‹é€è¡Œç¼–ç </td><td>å¤šæ¬¡æ‰«æï¼Œé€æ­¥ç²¾ç»†åŒ–</td></tr><tr><td>æ–‡ä»¶å¤§å°</td><td>ç•¥å¤§</td><td>ç•¥å°ï¼ˆ5-10%ï¼‰</td></tr><tr><td>åŠ è½½ä½“éªŒ</td><td>ä»ä¸Šåˆ°ä¸‹æ˜¾ç¤º</td><td>å…ˆæ¨¡ç³Šåæ¸…æ™°</td></tr><tr><td>è§£ç å¤æ‚åº¦</td><td>ä½</td><td>é«˜</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>ç§»åŠ¨ç«¯ã€å°å›¾</td><td>Webã€å¤§å›¾</td></tr></tbody></table><p><strong>æ¸è¿›å¼ç¼–ç ç¤ºæ„ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ‰«æ1ï¼šä»…DCç³»æ•°ï¼ˆä½åˆ†è¾¨ç‡ï¼‰</span></span>
<span class="line"><span>  â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘   â† æ¨¡ç³Šçš„è½®å»“</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>æ‰«æ2ï¼šä½é¢‘ACç³»æ•°</span></span>
<span class="line"><span>  â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘   â† é€æ¸æ¸…æ™°</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>æ‰«æ3ï¼šä¸­é¢‘ACç³»æ•°</span></span>
<span class="line"><span>  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘   â† æ›´æ¸…æ™°</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>æ‰«æ4ï¼šé«˜é¢‘ACç³»æ•°</span></span>
<span class="line"><span>  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â† å®Œå…¨æ¸…æ™°</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><hr><h3 id="_4-10-jpegå‹ç¼©å®Œæ•´ç¤ºä¾‹" tabindex="-1">4.10 JPEGå‹ç¼©å®Œæ•´ç¤ºä¾‹ <a class="header-anchor" href="#_4-10-jpegå‹ç¼©å®Œæ•´ç¤ºä¾‹" aria-label="Permalink to &quot;4.10 JPEGå‹ç¼©å®Œæ•´ç¤ºä¾‹&quot;">â€‹</a></h3><p>è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå®Œæ•´ç¤ºä¾‹ä¸²è”æ‰€æœ‰æ­¥éª¤ï¼š</p><p><strong>åŸå§‹å›¾åƒï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å°ºå¯¸ï¼š16Ã—16åƒç´ ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰</span></span>
<span class="line"><span>æ ¼å¼ï¼šRGB</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>æ­¥éª¤1ï¼šé¢œè‰²ç©ºé—´è½¬æ¢</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>RGB â†’ YCbCr</span></span>
<span class="line"><span>åƒç´ (200,100,50) â†’ Y=124, Cb=79, Cr=182</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>æ­¥éª¤2ï¼šè‰²åº¦å­é‡‡æ ·ï¼ˆ4:2:0ï¼‰</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Y:  16Ã—16 = 256 åƒç´ </span></span>
<span class="line"><span>Cb: 8Ã—8   = 64  åƒç´ </span></span>
<span class="line"><span>Cr: 8Ã—8   = 64  åƒç´ </span></span>
<span class="line"><span>æ€»è®¡ï¼š384 åƒç´ ï¼ˆåŸRGBä¸º768åƒç´ ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>æ­¥éª¤3ï¼šåˆ†å—</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>16Ã—16å›¾åƒ â†’ 4ä¸ª8Ã—8å—ï¼ˆYåˆ†é‡ï¼‰</span></span>
<span class="line"><span>             1ä¸ª8Ã—8å—ï¼ˆCbåˆ†é‡ï¼‰</span></span>
<span class="line"><span>             1ä¸ª8Ã—8å—ï¼ˆCråˆ†é‡ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>æ­¥éª¤4ï¼šDCTå˜æ¢</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ¯ä¸ª8Ã—8å— â†’ 64ä¸ªé¢‘åŸŸç³»æ•°</span></span>
<span class="line"><span>èƒ½é‡é›†ä¸­åœ¨å·¦ä¸Šè§’</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>æ­¥éª¤5ï¼šé‡åŒ–ï¼ˆè´¨é‡75ï¼‰</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>DCTç³»æ•° / é‡åŒ–è¡¨ â†’ å¤§é‡é«˜é¢‘ç³»æ•°å˜ä¸º0</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>æ­¥éª¤6ï¼šZå­—å½¢æ‰«æ + RLE</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>64ä¸ªç³»æ•° â†’ [DC, AC1, AC2, ..., 0,0,0,0,...]</span></span>
<span class="line"><span>         â†’ [DC, AC1, AC2, ..., EOB]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>æ­¥éª¤7ï¼šHuffmanç¼–ç </strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[(0,DC), (0,AC1), (0,AC2), ...] â†’ äºŒè¿›åˆ¶ç æµ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>æœ€ç»ˆç»“æœï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹å¤§å°ï¼š16Ã—16Ã—3 = 768 å­—èŠ‚</span></span>
<span class="line"><span>å‹ç¼©åï¼šçº¦ 80-100 å­—èŠ‚</span></span>
<span class="line"><span>å‹ç¼©ç‡ï¼šçº¦87-90%</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr><h2 id="äº”ã€pngå‹ç¼©æ·±åº¦è§£æ" tabindex="-1">äº”ã€PNGå‹ç¼©æ·±åº¦è§£æ <a class="header-anchor" href="#äº”ã€pngå‹ç¼©æ·±åº¦è§£æ" aria-label="Permalink to &quot;äº”ã€PNGå‹ç¼©æ·±åº¦è§£æ&quot;">â€‹</a></h2><h3 id="_5-1-pngå‹ç¼©æµç¨‹æ¦‚è§ˆ" tabindex="-1">5.1 PNGå‹ç¼©æµç¨‹æ¦‚è§ˆ <a class="header-anchor" href="#_5-1-pngå‹ç¼©æµç¨‹æ¦‚è§ˆ" aria-label="Permalink to &quot;5.1 PNGå‹ç¼©æµç¨‹æ¦‚è§ˆ&quot;">â€‹</a></h3><p>PNGä½¿ç”¨<strong>æ— æŸå‹ç¼©</strong>ï¼Œä¸»è¦åŸºäºDEFLATEç®—æ³•ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚                   PNG å‹ç¼©æµç¨‹                        â”‚</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span>
<span class="line"><span>â”‚                                                       â”‚</span></span>
<span class="line"><span>â”‚  åŸå§‹å›¾åƒ (RGBA)                                      â”‚</span></span>
<span class="line"><span>â”‚       â†“                                               â”‚</span></span>
<span class="line"><span>â”‚  â‘  æ»¤æ³¢é¢„å¤„ç† (Filtering)        â† å¢å¼ºå¯å‹ç¼©æ€§     â”‚</span></span>
<span class="line"><span>â”‚       â†“                                               â”‚</span></span>
<span class="line"><span>â”‚  â‘¡ DEFLATEå‹ç¼©                   â† LZ77 + Huffman   â”‚</span></span>
<span class="line"><span>â”‚       â”‚                                               â”‚</span></span>
<span class="line"><span>â”‚       â”œâ”€â†’ LZ77 å­—å…¸ç¼–ç            â† æ¶ˆé™¤ç©ºé—´å†—ä½™     â”‚</span></span>
<span class="line"><span>â”‚       â”‚                                               â”‚</span></span>
<span class="line"><span>â”‚       â””â”€â†’ Huffmanç¼–ç              â† ç†µç¼–ç            â”‚</span></span>
<span class="line"><span>â”‚       â†“                                               â”‚</span></span>
<span class="line"><span>â”‚  â‘¢ ç”ŸæˆPNGæ–‡ä»¶                                        â”‚</span></span>
<span class="line"><span>â”‚       â†“                                               â”‚</span></span>
<span class="line"><span>â”‚  å‹ç¼©æ•°æ®                                             â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><hr><h3 id="_5-2-pngæ»¤æ³¢é¢„å¤„ç†" tabindex="-1">5.2 PNGæ»¤æ³¢é¢„å¤„ç† <a class="header-anchor" href="#_5-2-pngæ»¤æ³¢é¢„å¤„ç†" aria-label="Permalink to &quot;5.2 PNGæ»¤æ³¢é¢„å¤„ç†&quot;">â€‹</a></h3><h4 id="ä¸ºä»€ä¹ˆéœ€è¦æ»¤æ³¢" tabindex="-1">ä¸ºä»€ä¹ˆéœ€è¦æ»¤æ³¢ï¼Ÿ <a class="header-anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦æ»¤æ³¢" aria-label="Permalink to &quot;ä¸ºä»€ä¹ˆéœ€è¦æ»¤æ³¢ï¼Ÿ&quot;">â€‹</a></h4><p><strong>é—®é¢˜ï¼š</strong> è‡ªç„¶å›¾åƒçš„åŸå§‹åƒç´ å€¼åˆ†å¸ƒä¸å‡ï¼Œå‹ç¼©æ•ˆç‡ä½ã€‚</p><p><strong>è§£å†³ï¼š</strong> é€šè¿‡æ»¤æ³¢å™¨ï¼Œå°†åƒç´ å€¼è½¬æ¢ä¸º<strong>å·®åˆ†å€¼</strong>ï¼Œä½¿æ•°æ®æ›´æ¥è¿‘0ï¼Œæ›´æ˜“å‹ç¼©ã€‚</p><h4 id="äº”ç§æ»¤æ³¢å™¨" tabindex="-1">äº”ç§æ»¤æ³¢å™¨ <a class="header-anchor" href="#äº”ç§æ»¤æ³¢å™¨" aria-label="Permalink to &quot;äº”ç§æ»¤æ³¢å™¨&quot;">â€‹</a></h4><p>PNGä¸ºæ¯ä¸€è¡Œåƒç´ é€‰æ‹©ä¸€ç§æ»¤æ³¢å™¨ï¼š</p><p><strong>1. None (0) - ä¸æ»¤æ³¢</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è¾“å‡º = åŸå§‹å€¼</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>2. Sub (1) - å‡å»å·¦é‚»åƒç´ </strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è¾“å‡º = å½“å‰åƒç´  - å·¦é‚»åƒç´ </span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç¤ºä¾‹ï¼š</span></span>
<span class="line"><span>åŸå§‹ï¼š[100, 102, 105, 103]</span></span>
<span class="line"><span>æ»¤æ³¢ï¼š[100,  +2,  +3,  -2]  â† å€¼æ›´å°ï¼Œæ›´æ˜“å‹ç¼©</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>3. Up (2) - å‡å»ä¸Šé‚»åƒç´ </strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è¾“å‡º = å½“å‰åƒç´  - ä¸Šé‚»åƒç´ </span></span>
<span class="line"><span></span></span>
<span class="line"><span>é€‚ç”¨åœºæ™¯ï¼šå‚ç›´æ¸å˜å›¾åƒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>4. Average (3) - å‡å»å·¦é‚»å’Œä¸Šé‚»çš„å¹³å‡å€¼</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è¾“å‡º = å½“å‰åƒç´  - floor((å·¦é‚» + ä¸Šé‚») / 2)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>é€‚ç”¨åœºæ™¯ï¼šå¹³æ»‘æ¸å˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>5. Paeth (4) - Paethé¢„æµ‹å™¨</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>é¢„æµ‹å€¼ = Paeth(å·¦é‚», ä¸Šé‚», å·¦ä¸Šé‚»)</span></span>
<span class="line"><span>è¾“å‡º = å½“å‰åƒç´  - é¢„æµ‹å€¼</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Paethç®—æ³•ï¼šé€‰æ‹©å·¦ã€ä¸Šã€å·¦ä¸Šä¸‰ä¸ªé‚»å±…ä¸­æœ€æ¥è¿‘çš„ä¸€ä¸ª</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>æ»¤æ³¢ç¤ºä¾‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹å›¾åƒï¼ˆç°åº¦ï¼‰ï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 100 102 105   â”‚</span></span>
<span class="line"><span>â”‚ 103 105 108   â”‚</span></span>
<span class="line"><span>â”‚ 106 108 111   â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Subæ»¤æ³¢åï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ 100  +2  +3   â”‚  â† ç¬¬ä¸€è¡Œ</span></span>
<span class="line"><span>â”‚ 103  +2  +3   â”‚  â† æ¯è¡Œç‹¬ç«‹æ»¤æ³¢</span></span>
<span class="line"><span>â”‚ 106  +2  +3   â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>è§‚å¯Ÿï¼š</span></span>
<span class="line"><span>- åŸå§‹å€¼ï¼š100-111ï¼ˆèŒƒå›´11ï¼‰</span></span>
<span class="line"><span>- æ»¤æ³¢åï¼š+2, +3ï¼ˆèŒƒå›´5ï¼Œä¸”é‡å¤å¤šï¼‰</span></span>
<span class="line"><span>- é‡å¤å€¼å¤š â†’ Huffmanç¼–ç æ•ˆç‡é«˜ï¼</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="è‡ªé€‚åº”æ»¤æ³¢" tabindex="-1">è‡ªé€‚åº”æ»¤æ³¢ <a class="header-anchor" href="#è‡ªé€‚åº”æ»¤æ³¢" aria-label="Permalink to &quot;è‡ªé€‚åº”æ»¤æ³¢&quot;">â€‹</a></h4><p>PNGä¸ºæ¯ä¸€è¡Œé€‰æ‹©æœ€ä¼˜æ»¤æ³¢å™¨ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼ªä»£ç </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> row </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; row </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> height; row</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bestFilter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> None;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bestScore </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Infinity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> filter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [None, Sub, Up, Average, Paeth]) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> filtered</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> applyFilter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(row, filter);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> score</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> estimateCompressibility</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filtered);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (score </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bestScore) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            bestFilter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> filter;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            bestScore </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> score;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    encodeRow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(row, bestFilter);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><hr><h3 id="_5-3-deflateå‹ç¼©ç®—æ³•" tabindex="-1">5.3 DEFLATEå‹ç¼©ç®—æ³• <a class="header-anchor" href="#_5-3-deflateå‹ç¼©ç®—æ³•" aria-label="Permalink to &quot;5.3 DEFLATEå‹ç¼©ç®—æ³•&quot;">â€‹</a></h3><p>DEFLATEæ˜¯PNGçš„æ ¸å¿ƒå‹ç¼©ç®—æ³•ï¼Œç»“åˆäº†<strong>LZ77</strong>å’Œ<strong>Huffmanç¼–ç </strong>ã€‚</p><h4 id="lz77-å­—å…¸ç¼–ç " tabindex="-1">LZ77 å­—å…¸ç¼–ç  <a class="header-anchor" href="#lz77-å­—å…¸ç¼–ç " aria-label="Permalink to &quot;LZ77 å­—å…¸ç¼–ç &quot;">â€‹</a></h4><p><strong>åŸç†ï¼š</strong> å°†é‡å¤å‡ºç°çš„æ•°æ®åºåˆ—æ›¿æ¢ä¸ºæŒ‡å‘å‰é¢å‡ºç°ä½ç½®çš„å¼•ç”¨ã€‚</p><p><strong>è¡¨ç¤ºï¼š</strong> <code>(è·ç¦», é•¿åº¦)</code> æˆ–ç›´æ¥è¾“å‡ºå­—é¢å€¼</p><p><strong>ç¤ºä¾‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹æ•°æ®ï¼š</span></span>
<span class="line"><span>&quot;ABCABCABCDEF&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>LZ77ç¼–ç ï¼š</span></span>
<span class="line"><span>A B C (3,3) (6,3) D E F</span></span>
<span class="line"><span>^^^^^   ^^^  ^^^</span></span>
<span class="line"><span>å­—é¢å€¼  å¼•ç”¨  å¼•ç”¨</span></span>
<span class="line"><span></span></span>
<span class="line"><span>è§£é‡Šï¼š</span></span>
<span class="line"><span>- A,B,C: é¦–æ¬¡å‡ºç°ï¼Œè¾“å‡ºå­—é¢å€¼</span></span>
<span class="line"><span>- (3,3): å‘å‰3ä¸ªä½ç½®ï¼Œå¤åˆ¶3ä¸ªå­—ç¬¦ â†’ &quot;ABC&quot;</span></span>
<span class="line"><span>- (6,3): å‘å‰6ä¸ªä½ç½®ï¼Œå¤åˆ¶3ä¸ªå­—ç¬¦ â†’ &quot;ABC&quot;</span></span>
<span class="line"><span>- D,E,F: è¾“å‡ºå­—é¢å€¼</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>æ›´å¤æ‚çš„ç¤ºä¾‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹åƒç´ è¡Œï¼ˆæ»¤æ³¢åï¼‰ï¼š</span></span>
<span class="line"><span>[2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>LZ77ç¼–ç ï¼š</span></span>
<span class="line"><span>[2, (1,9), 3, (1,4)]</span></span>
<span class="line"><span> ^   ^^^^   ^   ^^^^</span></span>
<span class="line"><span> |    |     |    |</span></span>
<span class="line"><span>å­—é¢  é‡å¤  å­—é¢  é‡å¤</span></span>
<span class="line"><span>      9æ¬¡        4æ¬¡</span></span>
<span class="line"><span></span></span>
<span class="line"><span>åŸå§‹ï¼š15å­—èŠ‚</span></span>
<span class="line"><span>ç¼–ç ï¼š4ä¸ªç¬¦å· â†’ çº¦8å­—èŠ‚ï¼ˆå…·ä½“å–å†³äºHuffmanç¼–ç ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="æ»‘åŠ¨çª—å£æœºåˆ¶" tabindex="-1">æ»‘åŠ¨çª—å£æœºåˆ¶ <a class="header-anchor" href="#æ»‘åŠ¨çª—å£æœºåˆ¶" aria-label="Permalink to &quot;æ»‘åŠ¨çª—å£æœºåˆ¶&quot;">â€‹</a></h4><p>LZ77ä½¿ç”¨<strong>æ»‘åŠ¨çª—å£</strong>æŸ¥æ‰¾é‡å¤ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>çª—å£å¤§å°ï¼š32KBï¼ˆPNGæ ‡å‡†ï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>å½“å‰ä½ç½®ï¼š    â†“</span></span>
<span class="line"><span>[...å·²ç¼–ç æ•°æ®...][å½“å‰æ•°æ®...æœªç¼–ç ...]</span></span>
<span class="line"><span> â†â”€â”€â”€ 32KB â”€â”€â”€â†’</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æŸ¥æ‰¾ï¼šåœ¨32KBçª—å£å†…æœç´¢ä¸å½“å‰ä½ç½®åŒ¹é…çš„æœ€é•¿åºåˆ—</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>æŸ¥æ‰¾è¿‡ç¨‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å½“å‰ä½ç½®ï¼šABC|ABCD...</span></span>
<span class="line"><span>           ^</span></span>
<span class="line"><span>çª—å£å†…æ‰¾åˆ°&quot;ABC&quot;åœ¨3ä¸ªå­—èŠ‚å‰å‡ºç°</span></span>
<span class="line"><span>æœ€é•¿åŒ¹é…ï¼šABCï¼ˆ3å­—èŠ‚ï¼‰</span></span>
<span class="line"><span>è¾“å‡ºï¼š(3, 3)</span></span>
<span class="line"><span>å‰è¿›3å­—èŠ‚</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="huffmanç¼–ç -ç¬¬äºŒé˜¶æ®µ" tabindex="-1">Huffmanç¼–ç ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰ <a class="header-anchor" href="#huffmanç¼–ç -ç¬¬äºŒé˜¶æ®µ" aria-label="Permalink to &quot;Huffmanç¼–ç ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰&quot;">â€‹</a></h4><p>LZ77è¾“å‡ºçš„ç¬¦å·å†ç»è¿‡Huffmanç¼–ç ï¼š</p><p><strong>ä¸¤å¥—Huffmanè¡¨ï¼š</strong></p><ol><li><strong>å­—é¢å€¼/é•¿åº¦è¡¨</strong>ï¼šç¼–ç å­—é¢å€¼å’ŒåŒ¹é…é•¿åº¦</li><li><strong>è·ç¦»è¡¨</strong>ï¼šç¼–ç å›æº¯è·ç¦»</li></ol><p><strong>ç¼–ç æµç¨‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>LZ77è¾“å‡ºï¼š[A, B, C, (3,3), D]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Huffmanç¼–ç ï¼š</span></span>
<span class="line"><span>- &#39;A&#39; â†’ 1001</span></span>
<span class="line"><span>- &#39;B&#39; â†’ 1010  </span></span>
<span class="line"><span>- &#39;C&#39; â†’ 1011</span></span>
<span class="line"><span>- é•¿åº¦3 â†’ 110</span></span>
<span class="line"><span>- è·ç¦»3 â†’ 01</span></span>
<span class="line"><span>- &#39;D&#39; â†’ 1100</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æœ€ç»ˆç æµï¼š</span></span>
<span class="line"><span>1001 1010 1011 110 01 1100</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><hr><h3 id="_5-4-imagequantå‹ç¼©-insmindå®ç°" tabindex="-1">5.4 ImageQuantå‹ç¼©ï¼ˆInsMindå®ç°ï¼‰ <a class="header-anchor" href="#_5-4-imagequantå‹ç¼©-insmindå®ç°" aria-label="Permalink to &quot;5.4 ImageQuantå‹ç¼©ï¼ˆInsMindå®ç°ï¼‰&quot;">â€‹</a></h3><p>InsMindå¯¹PNGä½¿ç”¨<strong>ImageQuant</strong>åº“ï¼ˆåŸºäºRust WASMï¼‰ï¼š</p><h4 id="æ ¸å¿ƒæŠ€æœ¯-é¢œè‰²é‡åŒ–" tabindex="-1">æ ¸å¿ƒæŠ€æœ¯ï¼šé¢œè‰²é‡åŒ– <a class="header-anchor" href="#æ ¸å¿ƒæŠ€æœ¯-é¢œè‰²é‡åŒ–" aria-label="Permalink to &quot;æ ¸å¿ƒæŠ€æœ¯ï¼šé¢œè‰²é‡åŒ–&quot;">â€‹</a></h4><p><strong>åŸç†ï¼š</strong> å°†24ä½çœŸå½©è‰²ï¼ˆ1600ä¸‡è‰²ï¼‰é‡åŒ–ä¸º8ä½ç´¢å¼•è‰²ï¼ˆ256è‰²ï¼‰ã€‚</p><p><strong>ç®—æ³•ï¼š</strong> åŸºäºä¸­ä½åˆ‡åˆ†ï¼ˆMedian Cutï¼‰å’Œk-meansèšç±»ã€‚</p><p><strong>å®ç°ä»£ç ï¼š</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// compress/services/image-quant/encode.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wasm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./imagequant_wasm_bg.wasm?url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> init, { compressImage } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./imagequant_wasm&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">height</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(wasm);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åˆå§‹åŒ–WASMæ¨¡å—</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // min=0, max=75: è´¨é‡èŒƒå›´0-75</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> optAPNG</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buffer, width, height, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">75</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> optAPNG;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>è°ƒç”¨æµç¨‹ï¼š</strong></p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// compress/services/image-quant/index.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressPng</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imgData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // imgData: ImageDataå¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // imgData.data: Uint8ClampedArray (RGBA)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Uint8Array.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imgData.data), width, height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="imagequantç®—æ³•æ­¥éª¤" tabindex="-1">ImageQuantç®—æ³•æ­¥éª¤ <a class="header-anchor" href="#imagequantç®—æ³•æ­¥éª¤" aria-label="Permalink to &quot;ImageQuantç®—æ³•æ­¥éª¤&quot;">â€‹</a></h4><p><strong>æ­¥éª¤1ï¼šä¸­ä½åˆ‡åˆ†æ„å»ºè°ƒè‰²æ¿</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. åˆå§‹ï¼šæ‰€æœ‰é¢œè‰²åœ¨ä¸€ä¸ªç›’å­</span></span>
<span class="line"><span>2. å¾ªç¯ç›´åˆ°256ä¸ªç›’å­ï¼š</span></span>
<span class="line"><span>   a. é€‰æ‹©é¢œè‰²èŒƒå›´æœ€å¤§çš„ç›’å­</span></span>
<span class="line"><span>   b. æ²¿ä¸­ä½æ•°åˆ‡åˆ†ä¸ºä¸¤ä¸ªç›’å­</span></span>
<span class="line"><span>3. æ¯ä¸ªç›’å­çš„å¹³å‡è‰² = è°ƒè‰²æ¿ä¸­çš„ä¸€ä¸ªé¢œè‰²</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>æ­¥éª¤2ï¼šk-meansä¼˜åŒ–</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è¿­ä»£ä¼˜åŒ–è°ƒè‰²æ¿ï¼š</span></span>
<span class="line"><span>1. å°†æ¯ä¸ªåƒç´ åˆ†é…åˆ°æœ€è¿‘çš„è°ƒè‰²æ¿é¢œè‰²</span></span>
<span class="line"><span>2. é‡æ–°è®¡ç®—æ¯ä¸ªè°ƒè‰²æ¿é¢œè‰²ï¼ˆè¯¥ç»„åƒç´ çš„å¹³å‡å€¼ï¼‰</span></span>
<span class="line"><span>3. é‡å¤ç›´åˆ°æ”¶æ•›</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>æ­¥éª¤3ï¼šè¯¯å·®æ‰©æ•£æŠ–åŠ¨</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Floyd-SteinbergæŠ–åŠ¨ï¼š</span></span>
<span class="line"><span>å½“å‰åƒç´ çš„é‡åŒ–è¯¯å·®æŒ‰ä»¥ä¸‹æ¯”ä¾‹åˆ†é…ç»™é‚»å±…ï¼š</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      å½“å‰  7/16</span></span>
<span class="line"><span>    3/16  5/16  1/16</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ•ˆæœï¼šç”¨æŠ–åŠ¨æ¨¡æ‹Ÿæ›´å¤šé¢œè‰²</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>å‹ç¼©æ•ˆæœï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>åŸå§‹RGBA PNGï¼š</span></span>
<span class="line"><span>  1920Ã—1080Ã—4 = 8.29MB</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>DEFLATEå‹ç¼©åï¼š</span></span>
<span class="line"><span>  çº¦ 2-4MBï¼ˆå–å†³äºå†…å®¹ï¼‰</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>ImageQuanté‡åŒ–åï¼š</span></span>
<span class="line"><span>  1920Ã—1080Ã—1 + 256Ã—4 (è°ƒè‰²æ¿) = 2.08MB</span></span>
<span class="line"><span>  DEFLATEå‹ç¼©ï¼šçº¦500KB-1MB</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>æ€»å‹ç¼©ç‡ï¼š80-90%</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><hr><h2 id="å…­ã€webassemblyæŠ€æœ¯å®ç°" tabindex="-1">å…­ã€WebAssemblyæŠ€æœ¯å®ç° <a class="header-anchor" href="#å…­ã€webassemblyæŠ€æœ¯å®ç°" aria-label="Permalink to &quot;å…­ã€WebAssemblyæŠ€æœ¯å®ç°&quot;">â€‹</a></h2><h3 id="_6-1-webassemblyåŸºç¡€çŸ¥è¯†" tabindex="-1">6.1 WebAssemblyåŸºç¡€çŸ¥è¯† <a class="header-anchor" href="#_6-1-webassemblyåŸºç¡€çŸ¥è¯†" aria-label="Permalink to &quot;6.1 WebAssemblyåŸºç¡€çŸ¥è¯†&quot;">â€‹</a></h3><h4 id="ä»€ä¹ˆæ˜¯webassembly" tabindex="-1">ä»€ä¹ˆæ˜¯WebAssemblyï¼Ÿ <a class="header-anchor" href="#ä»€ä¹ˆæ˜¯webassembly" aria-label="Permalink to &quot;ä»€ä¹ˆæ˜¯WebAssemblyï¼Ÿ&quot;">â€‹</a></h4><p>WebAssemblyï¼ˆç®€ç§°WASMï¼‰æ˜¯ä¸€ç§<strong>ä½çº§çš„ç±»æ±‡ç¼–è¯­è¨€</strong>ï¼Œå®ƒä¸ºWebå¹³å°æä¾›äº†ä¸€ä¸ªæ–°çš„ä»£ç æ ¼å¼ã€‚ä¸ä¼ ç»Ÿçš„JavaScriptä¸åŒï¼ŒWebAssemblyæ˜¯ä¸€ç§ç¼–è¯‘ç›®æ ‡ï¼Œå¯ä»¥ä»Cã€C++ã€Rustç­‰è¯­è¨€ç¼–è¯‘è€Œæ¥ã€‚</p><p><strong>æ ¸å¿ƒç‰¹ç‚¹ï¼š</strong></p><ol><li><strong>äºŒè¿›åˆ¶æ ¼å¼</strong>ï¼šç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼ï¼ŒåŠ è½½å’Œè§£æé€Ÿåº¦å¿«</li><li><strong>æ¥è¿‘åŸç”Ÿæ€§èƒ½</strong>ï¼šåœ¨ç°ä»£æµè§ˆå™¨ä¸­è¿è¡Œé€Ÿåº¦æ¥è¿‘åŸç”Ÿä»£ç ï¼ˆ90-95%ï¼‰</li><li><strong>å®‰å…¨æ²™ç®±</strong>ï¼šåœ¨æµè§ˆå™¨çš„å®‰å…¨æ²™ç®±ä¸­è¿è¡Œï¼Œä¸JavaScriptä¸€æ ·å®‰å…¨</li><li><strong>è¯­è¨€æ— å…³</strong>ï¼šå¯ä»¥ä»å¤šç§è¯­è¨€ç¼–è¯‘è€Œæ¥</li><li><strong>ä¸JavaScriptäº’æ“ä½œ</strong>ï¼šå¯ä»¥ä¸JavaScriptä»£ç æ— ç¼åä½œ</li></ol><p><strong>ä¸ºä»€ä¹ˆéœ€è¦WebAssemblyï¼Ÿ</strong></p><p>JavaScriptè™½ç„¶æ˜¯Webçš„ä¸»è¦è¯­è¨€ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹å­˜åœ¨æ€§èƒ½ç“¶é¢ˆï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>JavaScriptçš„å±€é™ï¼š</span></span>
<span class="line"><span>â”œâ”€ è§£é‡Šæ‰§è¡Œï¼šå³ä½¿æœ‰JITä¼˜åŒ–ï¼Œä»ç„¶æ¯”ç¼–è¯‘è¯­è¨€æ…¢</span></span>
<span class="line"><span>â”œâ”€ åŠ¨æ€ç±»å‹ï¼šç±»å‹æ£€æŸ¥å¸¦æ¥è¿è¡Œæ—¶å¼€é”€</span></span>
<span class="line"><span>â”œâ”€ åƒåœ¾å›æ”¶ï¼šGCåœé¡¿å½±å“æ€§èƒ½</span></span>
<span class="line"><span>â”œâ”€ å•çº¿ç¨‹ï¼šè®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¼šé˜»å¡UI</span></span>
<span class="line"><span>â””â”€ å†…å­˜ç®¡ç†ï¼šæ— æ³•ç²¾ç¡®æ§åˆ¶å†…å­˜å¸ƒå±€</span></span>
<span class="line"><span></span></span>
<span class="line"><span>WebAssemblyçš„ä¼˜åŠ¿ï¼š</span></span>
<span class="line"><span>â”œâ”€ ç¼–è¯‘æ‰§è¡Œï¼šC/C++/Rustç¼–è¯‘ä¸ºWASMå­—èŠ‚ç </span></span>
<span class="line"><span>â”œâ”€ é™æ€ç±»å‹ï¼šç¼–è¯‘æ—¶ç¡®å®šç±»å‹ï¼Œæ— è¿è¡Œæ—¶å¼€é”€</span></span>
<span class="line"><span>â”œâ”€ æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼šç²¾ç¡®æ§åˆ¶ï¼Œæ— GCåœé¡¿</span></span>
<span class="line"><span>â”œâ”€ SIMDæ”¯æŒï¼šå‘é‡åŒ–è®¡ç®—ï¼Œå¹¶è¡Œå¤„ç†æ•°æ®</span></span>
<span class="line"><span>â””â”€ è·¨å¹³å°ï¼šæµè§ˆå™¨ã€Node.jsã€è¾¹ç¼˜è®¡ç®—éƒ½æ”¯æŒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>å®é™…æ€§èƒ½å¯¹æ¯”ï¼ˆJPEGå‹ç¼©ä»»åŠ¡ï¼‰ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æµ‹è¯•æ¡ä»¶ï¼š1920Ã—1080å›¾åƒï¼Œè´¨é‡75</span></span>
<span class="line"><span></span></span>
<span class="line"><span>çº¯JavaScriptå®ç°ï¼š</span></span>
<span class="line"><span>  â”œâ”€ DCTå˜æ¢ï¼š1200ms</span></span>
<span class="line"><span>  â”œâ”€ é‡åŒ–ï¼š800ms</span></span>
<span class="line"><span>  â”œâ”€ Huffmanç¼–ç ï¼š1000ms</span></span>
<span class="line"><span>  â””â”€ æ€»è®¡ï¼š3000ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>WebAssemblyå®ç°ï¼ˆMozJPEGï¼‰ï¼š</span></span>
<span class="line"><span>  â”œâ”€ DCTå˜æ¢ï¼š120ms  â† 10å€æå‡</span></span>
<span class="line"><span>  â”œâ”€ é‡åŒ–ï¼š80ms     â† 10å€æå‡</span></span>
<span class="line"><span>  â”œâ”€ Huffmanç¼–ç ï¼š100ms â† 10å€æå‡</span></span>
<span class="line"><span>  â””â”€ æ€»è®¡ï¼š300ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>åŸç”ŸC++å®ç°ï¼š250msï¼ˆå‚è€ƒåŸºå‡†ï¼‰</span></span>
<span class="line"><span>WASMè¾¾åˆ°åŸç”Ÿçš„83%æ€§èƒ½ï¼</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><hr><h4 id="webassemblyçš„å·¥ä½œåŸç†" tabindex="-1">WebAssemblyçš„å·¥ä½œåŸç† <a class="header-anchor" href="#webassemblyçš„å·¥ä½œåŸç†" aria-label="Permalink to &quot;WebAssemblyçš„å·¥ä½œåŸç†&quot;">â€‹</a></h4><p><strong>ç¼–è¯‘æµç¨‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  ç¬¬1æ­¥ï¼šç¼–å†™æºä»£ç                                â”‚</span></span>
<span class="line"><span>â”‚  C/C++/Rustæºä»£ç                                 â”‚</span></span>
<span class="line"><span>â”‚  ä¾‹ï¼šmozjpeg_enc.cpp                            â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>               â”‚</span></span>
<span class="line"><span>               â†“ ç¼–è¯‘å·¥å…·é“¾ï¼ˆEmscripten/wasm-packï¼‰</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  ç¬¬2æ­¥ï¼šç¼–è¯‘ä¸ºWASM                               â”‚</span></span>
<span class="line"><span>â”‚  .wasmæ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰                         â”‚</span></span>
<span class="line"><span>â”‚  ä¾‹ï¼šmozjpeg_enc.wasm (1.2MB)                   â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>               â”‚</span></span>
<span class="line"><span>               â†“ åŒæ—¶ç”Ÿæˆ</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  ç¬¬3æ­¥ï¼šç”ŸæˆJSèƒ¶æ°´ä»£ç                            â”‚</span></span>
<span class="line"><span>â”‚  .jsæ–‡ä»¶ï¼ˆJavaScriptæ¥å£å±‚ï¼‰                    â”‚</span></span>
<span class="line"><span>â”‚  ä¾‹ï¼šmozjpeg_enc.js (è‡ªåŠ¨ç”Ÿæˆ)                  â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ WASMåŠ è½½é€»è¾‘                                â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ å†…å­˜ç®¡ç†                                    â”‚</span></span>
<span class="line"><span>â”‚  â””â”€ ç±»å‹è½¬æ¢                                    â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>               â”‚</span></span>
<span class="line"><span>               â†“ åœ¨æµè§ˆå™¨/Node.jsä¸­</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  ç¬¬4æ­¥ï¼šè¿è¡Œæ—¶åŠ è½½                               â”‚</span></span>
<span class="line"><span>â”‚  1. ä¸‹è½½.wasmæ–‡ä»¶                                â”‚</span></span>
<span class="line"><span>â”‚  2. WebAssembly.instantiate()ç¼–è¯‘+å®ä¾‹åŒ–        â”‚</span></span>
<span class="line"><span>â”‚  3. JSä»£ç è°ƒç”¨WASMå¯¼å‡ºçš„å‡½æ•°                     â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>å†…å­˜æ¨¡å‹ï¼š</strong></p><p>WebAssemblyä½¿ç”¨<strong>çº¿æ€§å†…å­˜</strong>ï¼ˆLinear Memoryï¼‰æ¨¡å‹ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>WASMçº¿æ€§å†…å­˜ï¼ˆArrayBufferï¼‰</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  0x0000    æ ˆå†…å­˜ï¼ˆStackï¼‰            â”‚  â† å‡½æ•°è°ƒç”¨æ ˆ</span></span>
<span class="line"><span>â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚</span></span>
<span class="line"><span>â”‚  0x1000    å †å†…å­˜ï¼ˆHeapï¼‰             â”‚  â† mallocåˆ†é…</span></span>
<span class="line"><span>â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚</span></span>
<span class="line"><span>â”‚  â”‚  å›¾åƒæ•°æ®ç¼“å†²åŒº                    â”‚  â† æˆ‘ä»¬çš„æ•°æ®åœ¨è¿™</span></span>
<span class="line"><span>â”‚  â”‚  â”œâ”€ imageBuffer (8MB)            â”‚</span></span>
<span class="line"><span>â”‚  â”‚  â””â”€ outputBuffer (500KB)         â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚</span></span>
<span class="line"><span>â”‚  â”‚  ä¸´æ—¶å·¥ä½œåŒº                        â”‚</span></span>
<span class="line"><span>â”‚  â”‚  â”œâ”€ DCTç³»æ•° (256KB)              â”‚</span></span>
<span class="line"><span>â”‚  â”‚  â””â”€ é‡åŒ–è¡¨ (1KB)                  â”‚</span></span>
<span class="line"><span>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚</span></span>
<span class="line"><span>â”‚  0x1000000  å†…å­˜ä¸Šé™ï¼ˆé»˜è®¤16MBï¼‰      â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç‰¹ç‚¹ï¼š</span></span>
<span class="line"><span>1. è¿ç»­çš„ArrayBufferï¼ŒJSå’ŒWASMå…±äº«</span></span>
<span class="line"><span>2. åªèƒ½é€šè¿‡æ•´æ•°ç´¢å¼•è®¿é—®</span></span>
<span class="line"><span>3. å¯ä»¥åŠ¨æ€å¢é•¿ï¼ˆgrowæ“ä½œï¼‰</span></span>
<span class="line"><span>4. å¿…é¡»æ‰‹åŠ¨ç®¡ç†ï¼ˆmalloc/freeï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><hr><h4 id="å¦‚ä½•æ¥å…¥webassembly" tabindex="-1">å¦‚ä½•æ¥å…¥WebAssemblyï¼Ÿ <a class="header-anchor" href="#å¦‚ä½•æ¥å…¥webassembly" aria-label="Permalink to &quot;å¦‚ä½•æ¥å…¥WebAssemblyï¼Ÿ&quot;">â€‹</a></h4><p><strong>æ–¹å¼ä¸€ï¼šä½¿ç”¨Emscriptenï¼ˆC/C++ â†’ WASMï¼‰</strong></p><p>è¿™æ˜¯InsMindé¡¹ç›®é‡‡ç”¨çš„æ–¹æ¡ˆã€‚Emscriptenæ˜¯æœ€æˆç†Ÿçš„C/C++åˆ°WASMçš„å·¥å…·é“¾ã€‚</p><p><strong>æ­¥éª¤1ï¼šå®‰è£…Emscripten</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä¸‹è½½Emscripten SDK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/emscripten-core/emsdk.git</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> emsdk</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å®‰è£…æœ€æ–°ç‰ˆæœ¬</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./emsdk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> latest</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./emsdk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> activate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> latest</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># è®¾ç½®ç¯å¢ƒå˜é‡</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./emsdk_env.sh</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>æ­¥éª¤2ï¼šç¼–å†™C++ä»£ç </strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// example.cpp</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;emscripten/bind.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç®€å•çš„åŠ æ³•å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨Emscriptenç»‘å®šå¯¼å‡ºåˆ°JavaScript</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EMSCRIPTEN_BINDINGS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(my_module) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;add&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">add);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>æ­¥éª¤3ï¼šç¼–è¯‘ä¸ºWASM</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># åŸºç¡€ç¼–è¯‘</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emcc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example.cpp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example.js</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> WASM=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     # ç”ŸæˆWASMï¼ˆä¸æ˜¯asm.jsï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EXPORTED_FUNCTIONS=&#39;[&quot;_add&quot;]&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # å¯¼å‡ºå‡½æ•°</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ä¼˜åŒ–ç¼–è¯‘ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emcc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example.cpp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example.js</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> WASM=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -O3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                           # æœ€é«˜ä¼˜åŒ–çº§åˆ«</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> MODULARIZE=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               # æ¨¡å—åŒ–å¯¼å‡º</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EXPORT_NAME=&#39;MyModule&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # æ¨¡å—åç§°</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    --bind</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                           # å¯ç”¨embindï¼ˆç±»å‹ç»‘å®šï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>æ­¥éª¤4ï¼šåœ¨JavaScriptä¸­ä½¿ç”¨</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åŠ è½½WASMæ¨¡å—</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> createModule </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./example.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Module</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è°ƒç”¨C++å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Module.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 30</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><hr><p><strong>æ–¹å¼äºŒï¼šä½¿ç”¨wasm-packï¼ˆRust â†’ WASMï¼‰</strong></p><p>InsMindçš„PNGå‹ç¼©ä½¿ç”¨äº†è¿™ç§æ–¹å¼ï¼ˆImageQuantæ˜¯Rustç¼–å†™ï¼‰ã€‚</p><p><strong>æ­¥éª¤1ï¼šå®‰è£…Rustå’Œwasm-pack</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å®‰è£…Rust</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;=https&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --tlsv1.2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sSf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://sh.rustup.rs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># å®‰è£…wasm-pack</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://rustwasm.github.io/wasm-pack/installer/init.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sSf</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sh</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>æ­¥éª¤2ï¼šåˆ›å»ºRusté¡¹ç›®</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cargo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --lib</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-wasm-project</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> my-wasm-project</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>æ­¥éª¤3ï¼šç¼–å†™Rustä»£ç </strong></p><div class="language-rust vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/lib.rs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">use</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> wasm_bindgen</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prelude</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[wasm_bindgen]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, b</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[wasm_bindgen]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compress_image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, height</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Vec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å›¾åƒå‹ç¼©é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to_vec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>æ­¥éª¤4ï¼šé…ç½®Cargo.toml</strong></p><div class="language-toml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lib</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">crate-type = [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cdylib&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wasm-bindgen = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0.2&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>æ­¥éª¤5ï¼šç¼–è¯‘</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wasm-pack</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --target</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> web</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>è¿™ä¼šç”Ÿæˆï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>pkg/</span></span>
<span class="line"><span>â”œâ”€â”€ my_wasm_project_bg.wasm  # WASMäºŒè¿›åˆ¶</span></span>
<span class="line"><span>â”œâ”€â”€ my_wasm_project.js       # JSèƒ¶æ°´ä»£ç </span></span>
<span class="line"><span>â””â”€â”€ my_wasm_project.d.ts     # TypeScriptç±»å‹å®šä¹‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>æ­¥éª¤6ï¼šåœ¨JavaScriptä¸­ä½¿ç”¨</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> init, { add, compress_image } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./pkg/my_wasm_project.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åˆå§‹åŒ–WASM</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è°ƒç”¨Rustå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sum</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> compressed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compress_image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, width, height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><hr><h4 id="wasm-vs-javascriptæ€§èƒ½å¯¹æ¯”" tabindex="-1">WASM vs JavaScriptæ€§èƒ½å¯¹æ¯” <a class="header-anchor" href="#wasm-vs-javascriptæ€§èƒ½å¯¹æ¯”" aria-label="Permalink to &quot;WASM vs JavaScriptæ€§èƒ½å¯¹æ¯”&quot;">â€‹</a></h4><p><strong>æµ‹è¯•åœºæ™¯ï¼šå›¾åƒå¤„ç†ä»»åŠ¡</strong></p><table tabindex="0"><thead><tr><th>ä»»åŠ¡</th><th>JavaScript</th><th>WASM</th><th>æå‡å€æ•°</th></tr></thead><tbody><tr><td><strong>DCTå˜æ¢</strong></td><td>1200ms</td><td>120ms</td><td>10x</td></tr><tr><td><strong>çŸ©é˜µä¹˜æ³•</strong></td><td>800ms</td><td>80ms</td><td>10x</td></tr><tr><td><strong>é¢œè‰²ç©ºé—´è½¬æ¢</strong></td><td>300ms</td><td>30ms</td><td>10x</td></tr><tr><td><strong>Huffmanç¼–ç </strong></td><td>500ms</td><td>60ms</td><td>8.3x</td></tr><tr><td><strong>æ•´ä½“JPEGç¼–ç </strong></td><td>3000ms</td><td>280ms</td><td>10.7x</td></tr></tbody></table><p><strong>ä¸ºä»€ä¹ˆWASMè¿™ä¹ˆå¿«ï¼Ÿ</strong></p><ol><li><strong>é¢„ç¼–è¯‘</strong>ï¼šWASMæ˜¯ç¼–è¯‘å¥½çš„å­—èŠ‚ç ï¼Œæµè§ˆå™¨ç›´æ¥ç¼–è¯‘ä¸ºæœºå™¨ç </li><li><strong>é™æ€ç±»å‹</strong>ï¼šæ— éœ€è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥</li><li><strong>SIMD</strong>ï¼šæ”¯æŒ128ä½å‘é‡è¿ç®—ï¼ˆåŒæ—¶å¤„ç†4ä¸ªåƒç´ ï¼‰</li><li><strong>å†…å­˜è¿ç»­</strong>ï¼šæ•°æ®ç´§å¯†æ’åˆ—ï¼ŒCPUç¼“å­˜å‹å¥½</li><li><strong>æ— GC</strong>ï¼šæ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼Œæ— åƒåœ¾å›æ”¶åœé¡¿</li></ol><hr><h3 id="_6-2-insmindçš„wasmæ¥å…¥æ–¹æ¡ˆ" tabindex="-1">6.2 InsMindçš„WASMæ¥å…¥æ–¹æ¡ˆ <a class="header-anchor" href="#_6-2-insmindçš„wasmæ¥å…¥æ–¹æ¡ˆ" aria-label="Permalink to &quot;6.2 InsMindçš„WASMæ¥å…¥æ–¹æ¡ˆ&quot;">â€‹</a></h3><p>InsMindé¡¹ç›®ä½¿ç”¨äº†<strong>åŒWASMå¼•æ“</strong>ç­–ç•¥ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚         InsMindå›¾ç‰‡å‹ç¼©å·¥å…·              â”‚</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span>
<span class="line"><span>â”‚                                          â”‚</span></span>
<span class="line"><span>â”‚  JPEGå‹ç¼©                PNGå‹ç¼©         â”‚</span></span>
<span class="line"><span>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</span></span>
<span class="line"><span>â”‚  â”‚ MozJPEG  â”‚          â”‚ImageQuantâ”‚    â”‚</span></span>
<span class="line"><span>â”‚  â”‚          â”‚          â”‚          â”‚    â”‚</span></span>
<span class="line"><span>â”‚  â”‚ C++æºç   â”‚          â”‚ Rustæºç  â”‚    â”‚</span></span>
<span class="line"><span>â”‚  â”‚    â†“     â”‚          â”‚    â†“     â”‚    â”‚</span></span>
<span class="line"><span>â”‚  â”‚Emscriptenâ”‚          â”‚wasm-pack â”‚    â”‚</span></span>
<span class="line"><span>â”‚  â”‚    â†“     â”‚          â”‚    â†“     â”‚    â”‚</span></span>
<span class="line"><span>â”‚  â”‚  WASM    â”‚          â”‚  WASM    â”‚    â”‚</span></span>
<span class="line"><span>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</span></span>
<span class="line"><span>â”‚                                          â”‚</span></span>
<span class="line"><span>â”‚  æ€§èƒ½ï¼š280ms            æ€§èƒ½ï¼š150ms      â”‚</span></span>
<span class="line"><span>â”‚  æ–‡ä»¶ï¼š1.2MB            æ–‡ä»¶ï¼š800KB      â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸¤ä¸ªåº“ï¼Ÿ</strong></p><p><strong>MozJPEGï¼ˆJPEGå‹ç¼©ï¼‰ï¼š</strong></p><ul><li>Mozillaå¼€å‘ï¼Œä¸šç•Œæ ‡å‡†</li><li>æ¯”libjpegå‹ç¼©ç‡é«˜5-10%</li><li>Trellisé‡åŒ–ç®—æ³•ä¼˜åŒ–</li><li>æ¸è¿›å¼JPEGæ”¯æŒå®Œå–„</li><li>C++å®ç°ï¼ŒEmscriptenç¼–è¯‘</li></ul><p><strong>ImageQuantï¼ˆPNGå‹ç¼©ï¼‰ï¼š</strong></p><ul><li>ä¸“æ³¨é¢œè‰²é‡åŒ–ï¼Œæ•ˆæœæœ€ä½³</li><li>Rustç¼–å†™ï¼Œå†…å­˜å®‰å…¨</li><li>æ”¯æŒFloyd-SteinbergæŠ–åŠ¨</li><li>wasm-bindgenç”Ÿæ€æˆç†Ÿ</li><li>ç¼–è¯‘äº§ç‰©æ›´å°</li></ul><hr><h3 id="_6-3-mozjpeg-wasmæ¶æ„æ·±åº¦è§£æ" tabindex="-1">6.3 MozJPEG WASMæ¶æ„æ·±åº¦è§£æ <a class="header-anchor" href="#_6-3-mozjpeg-wasmæ¶æ„æ·±åº¦è§£æ" aria-label="Permalink to &quot;6.3 MozJPEG WASMæ¶æ„æ·±åº¦è§£æ&quot;">â€‹</a></h3><h4 id="ä¸‰å±‚æ¶æ„è®¾è®¡" tabindex="-1">ä¸‰å±‚æ¶æ„è®¾è®¡ <a class="header-anchor" href="#ä¸‰å±‚æ¶æ„è®¾è®¡" aria-label="Permalink to &quot;ä¸‰å±‚æ¶æ„è®¾è®¡&quot;">â€‹</a></h4><p>InsMindçš„MozJPEGé›†æˆé‡‡ç”¨äº†æ¸…æ™°çš„ä¸‰å±‚æ¶æ„ï¼Œæ¯å±‚èŒè´£æ˜ç¡®ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚           ç¬¬1å±‚ï¼šJavaScriptåº”ç”¨å±‚                â”‚</span></span>
<span class="line"><span>â”‚  encoder.js - å¯¹å¤–APIæ¥å£                        â”‚</span></span>
<span class="line"><span>â”‚                                                  â”‚</span></span>
<span class="line"><span>â”‚  èŒè´£ï¼š                                          â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ å¯¼å‡ºç®€æ´çš„encode()å‡½æ•°                       â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ ç®¡ç†WASMæ¨¡å—å•ä¾‹                             â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ å¤„ç†å¼‚æ­¥åŠ è½½                                 â”‚</span></span>
<span class="line"><span>â”‚  â””â”€ å¼‚å¸¸å¤„ç†å’Œèµ„æºé‡Šæ”¾                           â”‚</span></span>
<span class="line"><span>â”‚                                                  â”‚</span></span>
<span class="line"><span>â”‚  å…³é”®ä»£ç ï¼š25è¡Œ                                  â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ è°ƒç”¨</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚         ç¬¬2å±‚ï¼šEmscriptenèƒ¶æ°´å±‚                  â”‚</span></span>
<span class="line"><span>â”‚  mozjpeg_enc.js - è‡ªåŠ¨ç”Ÿæˆçš„æ¡¥æ¥ä»£ç              â”‚</span></span>
<span class="line"><span>â”‚                                                  â”‚</span></span>
<span class="line"><span>â”‚  èŒè´£ï¼š                                          â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ WASMæ¨¡å—åŠ è½½å’Œåˆå§‹åŒ–                         â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ JavaScript â†” WASMå†…å­˜æ•°æ®ä¼ é€’              â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ å‡½æ•°è°ƒç”¨ä»£ç†                                 â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ ç±»å‹è½¬æ¢ï¼ˆJSå¯¹è±¡ â†” C++ç»“æ„ä½“ï¼‰             â”‚</span></span>
<span class="line"><span>â”‚  â””â”€ å†…å­˜åˆ†é…å’Œé‡Šæ”¾                               â”‚</span></span>
<span class="line"><span>â”‚                                                  â”‚</span></span>
<span class="line"><span>â”‚  å…³é”®ä»£ç ï¼š1372è¡Œï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€æ‰‹å†™ï¼‰           â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>                 â”‚</span></span>
<span class="line"><span>                 â†“ FFIè°ƒç”¨</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚          ç¬¬3å±‚ï¼šWebAssemblyæ ¸å¿ƒå±‚                â”‚</span></span>
<span class="line"><span>â”‚  mozjpeg_enc.wasm - ç¼–è¯‘åçš„äºŒè¿›åˆ¶               â”‚</span></span>
<span class="line"><span>â”‚                                                  â”‚</span></span>
<span class="line"><span>â”‚  æ¥æºï¼š                                          â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ mozjpeg_enc.cppï¼ˆ234è¡Œï¼‰                    â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ libjpegåº“ï¼ˆMozJPEGç‰ˆæœ¬ï¼‰                    â”‚</span></span>
<span class="line"><span>â”‚  â””â”€ ç¼–è¯‘ä¸ºWASMäºŒè¿›åˆ¶ï¼ˆ1.2MBï¼‰                   â”‚</span></span>
<span class="line"><span>â”‚                                                  â”‚</span></span>
<span class="line"><span>â”‚  æ‰§è¡Œï¼šåœ¨WASMè™šæ‹Ÿæœºä¸­è¿è¡Œ                        â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><strong>å„å±‚è¯¦è§£ï¼š</strong></p><p><strong>ç¬¬1å±‚ï¼šåº”ç”¨å±‚ï¼ˆencoder.jsï¼‰</strong></p><p>è¿™ä¸€å±‚éå¸¸ç®€æ´ï¼Œåªæœ‰25è¡Œä»£ç ã€‚å®ƒçš„è®¾è®¡å“²å­¦æ˜¯&quot;ç®€å•æ˜“ç”¨&quot;ï¼š</p><ul><li><strong>å•ä¾‹æ¨¡å¼</strong>ï¼šå…¨å±€ç»´æŠ¤ä¸€ä¸ª<code>emscriptenModule</code>å˜é‡ï¼Œé¿å…é‡å¤åˆå§‹åŒ–WASMï¼ˆåˆå§‹åŒ–è€—æ—¶80-100msï¼‰</li><li><strong>æ‡’åŠ è½½</strong>ï¼šåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨<code>encode()</code>æ—¶æ‰åŠ è½½WASMï¼Œä¸å½±å“é¡µé¢é¦–å±</li><li><strong>Promiseå°è£…</strong>ï¼šå°†å¼‚æ­¥æ“ä½œå°è£…ä¸ºasync/awaitï¼Œä½¿ç”¨ä½“éªŒå‹å¥½</li><li><strong>èµ„æºç®¡ç†</strong>ï¼šç¡®ä¿æ¯æ¬¡è°ƒç”¨åéƒ½é‡Šæ”¾WASMå†…å­˜ï¼ˆ<code>free_result()</code>ï¼‰</li></ul><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å…³é”®ç‚¹1ï¼šå•ä¾‹é¿å…é‡å¤åˆå§‹åŒ–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å…¨å±€å•ä¾‹</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å…³é”®ç‚¹2ï¼šæ‡’åŠ è½½</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">emscriptenModule) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    emscriptenModule </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initEmscriptenModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mozjpeg_enc, wasmUrl);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å…³é”®ç‚¹3ï¼šèµ„æºç®¡ç†</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¿…é¡»é‡Šæ”¾ï¼Œå¦åˆ™å†…å­˜æ³„æ¼</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>ç¬¬2å±‚ï¼šèƒ¶æ°´å±‚ï¼ˆmozjpeg_enc.jsï¼‰</strong></p><p>è¿™ä¸€å±‚æ˜¯Emscriptenè‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä»£ç é‡å¾ˆå¤§ï¼ˆ1372è¡Œï¼‰ï¼Œä½†æˆ‘ä»¬æ— éœ€æ‰‹å†™ã€‚å®ƒçš„æ ¸å¿ƒåŠŸèƒ½ï¼š</p><p><strong>a. WASMæ¨¡å—åŠ è½½</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼ªä»£ç ç¤ºæ„ï¼ˆå®é™…ç”±Emscriptenç”Ÿæˆï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> loadWasm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">wasmUrl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. fetchä¸‹è½½.wasmæ–‡ä»¶</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(wasmUrl);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> wasmBinary</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">arrayBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. ç¼–è¯‘WASM</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> compiled</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WebAssembly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">compile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(wasmBinary);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. å®ä¾‹åŒ–ï¼ˆæä¾›å¯¼å…¥å¯¹è±¡ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> instance</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WebAssembly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">instantiate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(compiled, imports);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> instance;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>b. å†…å­˜ç®¡ç†</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// WASMçº¿æ€§å†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> HEAP8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Int8Array view</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> HEAP16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Int16Array view  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> HEAP32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Int32Array view</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> HEAPU8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uint8Array viewï¼ˆæœ€å¸¸ç”¨ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> HEAPF32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Float32Array view</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> HEAPF64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Float64Array view</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å†…å­˜åˆ†é…</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åœ¨WASMå †ä¸Šåˆ†é…sizeå­—èŠ‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è¿”å›æŒ‡é’ˆï¼ˆæ•´æ•°åç§»é‡ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å†…å­˜é‡Šæ”¾</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // é‡Šæ”¾ptræŒ‡å‘çš„å†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>c. æ•°æ®ä¼ é€’</strong></p><p>JavaScriptæ•°æ®ä¼ é€’ç»™WASMçš„è¿‡ç¨‹ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>JSç«¯                          WASMç«¯</span></span>
<span class="line"><span>â”€â”€â”€â”€                          â”€â”€â”€â”€â”€</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ImageData                     </span></span>
<span class="line"><span>{ data: Uint8ClampedArray }   </span></span>
<span class="line"><span>           â”‚</span></span>
<span class="line"><span>           â”‚ 1. åˆ†é…WASMå†…å­˜</span></span>
<span class="line"><span>           â†“</span></span>
<span class="line"><span>WASM.HEAP[ptr...ptr+size]    uint8_t* buffer</span></span>
<span class="line"><span>           â”‚</span></span>
<span class="line"><span>           â”‚ 2. è°ƒç”¨WASMå‡½æ•°</span></span>
<span class="line"><span>           â†“</span></span>
<span class="line"><span>       encode(ptr, width, height, options)</span></span>
<span class="line"><span>           â”‚</span></span>
<span class="line"><span>           â”‚ 3. WASMå¤„ç†å®Œæˆ</span></span>
<span class="line"><span>           â†“</span></span>
<span class="line"><span>WASM.HEAP[outPtr...outPtr+outSize]</span></span>
<span class="line"><span>           â”‚</span></span>
<span class="line"><span>           â”‚ 4. å¤åˆ¶å›JS</span></span>
<span class="line"><span>           â†“</span></span>
<span class="line"><span>Uint8Array (å‹ç¼©ç»“æœ)</span></span>
<span class="line"><span>           â”‚</span></span>
<span class="line"><span>           â”‚ 5. é‡Šæ”¾WASMå†…å­˜</span></span>
<span class="line"><span>           â†“</span></span>
<span class="line"><span>       free(ptr), free(outPtr)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><strong>d. ç±»å‹è½¬æ¢</strong></p><p>Emscriptençš„embindæœºåˆ¶è‡ªåŠ¨å¤„ç†ç±»å‹è½¬æ¢ï¼š</p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// C++ç«¯å®šä¹‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> quality;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> progressive;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Emscriptenç»‘å®š</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EMSCRIPTEN_BINDINGS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(my_module) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    value_object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MozJpegOptions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;quality&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::quality)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;progressive&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::progressive);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JSç«¯ä½¿ç”¨ï¼ˆç±»å‹è‡ªåŠ¨è½¬æ¢ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    quality: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">75</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JS number â†’ C++ int</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    progressive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JS boolean â†’ C++ bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data, width, height, options);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è‡ªåŠ¨è½¬æ¢</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>ç¬¬3å±‚ï¼šWASMæ ¸å¿ƒå±‚</strong></p><p>è¿™æ˜¯å®é™…æ‰§è¡Œå‹ç¼©ç®—æ³•çš„åœ°æ–¹ã€‚MozJPEGçš„C++ä»£ç ç»è¿‡Emscriptenç¼–è¯‘åï¼Œåœ¨WASMè™šæ‹Ÿæœºä¸­è¿è¡Œã€‚</p><p><strong>æ ¸å¿ƒæµç¨‹ï¼š</strong></p><ol><li><strong>æ¥æ”¶å‚æ•°</strong>ï¼šä»JSä¼ å…¥çš„ImageDataï¼ˆRGBAåƒç´ æ•°ç»„ï¼‰</li><li><strong>åˆå§‹åŒ–libjpeg</strong>ï¼šåˆ›å»ºå‹ç¼©å¯¹è±¡<code>jpeg_compress_struct</code></li><li><strong>é…ç½®é€‰é¡¹</strong>ï¼šè´¨é‡ã€é¢œè‰²ç©ºé—´ã€å­é‡‡æ ·ã€Trellisä¼˜åŒ–ç­‰</li><li><strong>æ‰§è¡Œå‹ç¼©</strong>ï¼š <ul><li>RGB â†’ YCbCré¢œè‰²ç©ºé—´è½¬æ¢</li><li>è‰²åº¦å­é‡‡æ ·ï¼ˆ4:2:0ï¼‰</li><li>8Ã—8åˆ†å—</li><li>DCTå˜æ¢</li><li>é‡åŒ–</li><li>Zå­—å½¢æ‰«æ</li><li>Huffmanç¼–ç </li></ul></li><li><strong>è¾“å‡ºç»“æœ</strong>ï¼šå‹ç¼©åçš„JPEGäºŒè¿›åˆ¶æ•°æ®</li></ol><p>å…³é”®çš„C++ä»£ç ç‰‡æ®µï¼š</p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¾“å‡ºåˆ°å†…å­˜ï¼ˆè€Œä¸æ˜¯æ–‡ä»¶ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jpeg_mem_dest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">output, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">size);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®¾ç½®å›¾åƒå‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo.image_width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_width;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo.image_height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_height;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo.input_components </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // RGBA</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo.in_color_space </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JCS_EXT_RGBA;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åº”ç”¨ä¼˜åŒ–é€‰é¡¹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo.optimize_coding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ä¼˜åŒ–Huffmanè¡¨</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jpeg_c_set_bool_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JBOOLEAN_USE_SCANS_IN_TRELLIS, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é€è¡Œå†™å…¥</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (cinfo.next_scanline </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cinfo.image_height) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    row_pointer[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">image_buffer[cinfo.next_scanline </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> row_stride];</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_write_scanlines</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, row_pointer, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¿”å›ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">typed_memory_view</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size, output));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><hr><h3 id="_6-4-æ•°æ®æµè½¬ä¸å†…å­˜ç®¡ç†" tabindex="-1">6.4 æ•°æ®æµè½¬ä¸å†…å­˜ç®¡ç† <a class="header-anchor" href="#_6-4-æ•°æ®æµè½¬ä¸å†…å­˜ç®¡ç†" aria-label="Permalink to &quot;6.4 æ•°æ®æµè½¬ä¸å†…å­˜ç®¡ç†&quot;">â€‹</a></h3><h4 id="å®Œæ•´çš„æ•°æ®æµè½¬è¿‡ç¨‹" tabindex="-1">å®Œæ•´çš„æ•°æ®æµè½¬è¿‡ç¨‹ <a class="header-anchor" href="#å®Œæ•´çš„æ•°æ®æµè½¬è¿‡ç¨‹" aria-label="Permalink to &quot;å®Œæ•´çš„æ•°æ®æµè½¬è¿‡ç¨‹&quot;">â€‹</a></h4><p>è®©æˆ‘ä»¬è¿½è¸ªä¸€æ¬¡å®Œæ•´çš„å‹ç¼©è¿‡ç¨‹ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦‚ä½•åœ¨JSå’ŒWASMä¹‹é—´æµè½¬çš„ï¼š</p><p><strong>é˜¶æ®µ1ï¼šJSå‡†å¤‡æ•°æ®</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡å·²ç»ç»˜åˆ¶åˆ°Canvas</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> imageData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getImageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, width, height);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// imageData.data: Uint8ClampedArray(8294400)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ¯4ä¸ªå­—èŠ‚ä»£è¡¨ä¸€ä¸ªåƒç´ ï¼š[R,G,B,A, R,G,B,A, ...]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æ­¤æ—¶æ•°æ®åœ¨<strong>JavaScriptå †å†…å­˜</strong>ä¸­ã€‚</p><p><strong>é˜¶æ®µ2ï¼šè°ƒç”¨WASMå‡½æ•°</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> resultView</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    imageData.data,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼ é€’TypedArray</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    width,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    height,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    options</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Emscriptenèƒ¶æ°´ä»£ç è‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li><strong>åœ¨WASMå†…å­˜ä¸­åˆ†é…ç©ºé—´</strong>ï¼š</li></ol><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼ªä»£ç </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ptr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData.data.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åˆ†é…8294400å­—èŠ‚</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li><strong>å¤åˆ¶æ•°æ®åˆ°WASMå†…å­˜</strong>ï¼š</li></ol><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">HEAPU8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData.data, ptr);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¤åˆ¶8MBæ•°æ®</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="3"><li><strong>è°ƒç”¨WASMå‡½æ•°</strong>ï¼š</li></ol><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> resultPtr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr, width, height, optionsPtr);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>æ­¤æ—¶æ•°æ®åœ¨<strong>WASMçº¿æ€§å†…å­˜</strong>ä¸­ï¼ŒC++ä»£ç å¯ä»¥ç›´æ¥è®¿é—®ã€‚</p><p><strong>é˜¶æ®µ3ï¼šWASMå¤„ç†</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// C++ä»£ç åœ¨WASMä¸­æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint8_t*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint8_t*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) image_in.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">c_str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®¿é—®åƒç´ æ•°æ®ï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼Œæå¿«ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> height; y</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width; x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        uint8_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_buffer[index];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        uint8_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> g </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_buffer[index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        uint8_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_buffer[index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        uint8_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_buffer[index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å¤„ç†åƒç´ ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å‹ç¼©å®Œæˆï¼Œè¾“å‡ºåˆ°WASMå†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jpeg_mem_dest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">output, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">size);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// outputç°åœ¨æŒ‡å‘å‹ç¼©åçš„æ•°æ®ï¼ˆåœ¨WASMå†…å­˜ä¸­ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>é˜¶æ®µ4ï¼šè¿”å›ç»“æœåˆ°JS</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// C++è¿”å›typed_memory_view</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">typed_memory_view</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size, output));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>è¿™ä¼šåˆ›å»ºä¸€ä¸ª<strong>è§†å›¾</strong>ï¼ˆviewï¼‰ï¼Œè€Œä¸æ˜¯å¤åˆ¶æ•°æ®ã€‚è§†å›¾æŒ‡å‘WASMå†…å­˜ä¸­çš„æ•°æ®ã€‚</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JSç«¯æ¥æ”¶</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> resultView</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// resultViewæ˜¯æŒ‡å‘WASMå†…å­˜çš„Uint8Arrayè§†å›¾</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¿…é¡»ç«‹å³å¤åˆ¶åˆ°JSå †</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(resultView);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç°åœ¨æ•°æ®åœ¨JSå †å†…å­˜ä¸­äº†</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é‡Šæ”¾WASMå†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é‡Šæ”¾outputæŒ‡é’ˆ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>ä¸ºä»€ä¹ˆå¿…é¡»å¤åˆ¶ï¼Ÿ</strong></p><p>å› ä¸º<code>free_result()</code>ä¼šé‡Šæ”¾WASMå†…å­˜ï¼Œå¦‚æœä¸å¤åˆ¶ï¼Œ<code>resultView</code>ä¼šå˜æˆæ‚¬ç©ºæŒ‡é’ˆï¼Œè®¿é—®ä¼šå¯¼è‡´é”™è¯¯ã€‚</p><p><strong>é˜¶æ®µ5ï¼šç”ŸæˆBlob</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> blob</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Blob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([result], { type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image/jpeg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ•°æ®ç°åœ¨åœ¨Blobå¯¹è±¡ä¸­ï¼ˆæµè§ˆå™¨ç®¡ç†çš„å†…å­˜ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><hr><h4 id="å†…å­˜ä½¿ç”¨åˆ†æ" tabindex="-1">å†…å­˜ä½¿ç”¨åˆ†æ <a class="header-anchor" href="#å†…å­˜ä½¿ç”¨åˆ†æ" aria-label="Permalink to &quot;å†…å­˜ä½¿ç”¨åˆ†æ&quot;">â€‹</a></h4><p>è®©æˆ‘ä»¬åˆ†æä¸€æ¬¡å‹ç¼©è¿‡ç¨‹çš„å†…å­˜ä½¿ç”¨ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ—¶é—´è½´                    JSå †å†…å­˜        WASMå†…å­˜        æ€»è®¡</span></span>
<span class="line"><span>â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€</span></span>
<span class="line"><span></span></span>
<span class="line"><span>t0: åˆå§‹çŠ¶æ€              0MB            1.5MB(åŸºç¡€)      1.5MB</span></span>
<span class="line"><span></span></span>
<span class="line"><span>t1: Canvas ImageData      8MB            1.5MB            9.5MB</span></span>
<span class="line"><span>    åˆ›å»º</span></span>
<span class="line"><span></span></span>
<span class="line"><span>t2: è°ƒç”¨encode()          8MB            9.5MB            17.5MB</span></span>
<span class="line"><span>    å¤åˆ¶åˆ°WASM                           (8MBè¾“å…¥æ•°æ®)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>t3: WASMå¤„ç†ä¸­            8MB            11MB             19MB</span></span>
<span class="line"><span>    (ä¸´æ—¶ç¼“å†²åŒº)                         (è¾“å…¥8+ä¸´æ—¶2+è¾“å‡º1)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>t4: è¿”å›ç»“æœ              8.5MB          11MB             19.5MB</span></span>
<span class="line"><span>    (å¤åˆ¶å›JS)            (åŸ8+ç»“æœ0.5)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>t5: é‡Šæ”¾WASMå†…å­˜          8.5MB          1.5MB            10MB</span></span>
<span class="line"><span>    free_result()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>t6: æ¸…ç†åŸImageData       0.5MB          1.5MB            2MB</span></span>
<span class="line"><span>    GCå›æ”¶                (åªä¿ç•™ç»“æœ)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>å†…å­˜ä¼˜åŒ–è¦ç‚¹ï¼š</strong></p><ol><li><strong>åŠæ—¶é‡Šæ”¾</strong>ï¼šå‹ç¼©å®Œæˆåç«‹å³è°ƒç”¨<code>free_result()</code></li><li><strong>é¿å…é‡å¤åˆå§‹åŒ–</strong>ï¼šä½¿ç”¨å•ä¾‹æ¨¡å¼å¤ç”¨WASMæ¨¡å—</li><li><strong>æ•°æ®å¤ç”¨</strong>ï¼šå¦‚æœéœ€è¦æ‰¹é‡å‹ç¼©ï¼Œè€ƒè™‘å¤ç”¨è¾“å…¥ç¼“å†²åŒº</li></ol><hr><h3 id="_6-5-emscriptenç¼–è¯‘é…ç½®è¯¦è§£" tabindex="-1">6.5 Emscriptenç¼–è¯‘é…ç½®è¯¦è§£ <a class="header-anchor" href="#_6-5-emscriptenç¼–è¯‘é…ç½®è¯¦è§£" aria-label="Permalink to &quot;6.5 Emscriptenç¼–è¯‘é…ç½®è¯¦è§£&quot;">â€‹</a></h3><p>è™½ç„¶MozJPEGå·²ç»é¢„ç¼–è¯‘å¥½äº†ï¼Œä½†äº†è§£ç¼–è¯‘é…ç½®æœ‰åŠ©äºç†è§£æ€§èƒ½ä¼˜åŒ–ã€‚</p><h4 id="å…³é”®ç¼–è¯‘é€‰é¡¹" tabindex="-1">å…³é”®ç¼–è¯‘é€‰é¡¹ <a class="header-anchor" href="#å…³é”®ç¼–è¯‘é€‰é¡¹" aria-label="Permalink to &quot;å…³é”®ç¼–è¯‘é€‰é¡¹&quot;">â€‹</a></h4><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># InsMindçš„MozJPEGç¼–è¯‘å‘½ä»¤ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emcc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mozjpeg_enc.cpp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # === åŸºç¡€é…ç½® ===</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mozjpeg_enc.js</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # è¾“å‡ºæ–‡ä»¶å</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> WASM=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 # ç”ŸæˆWASMï¼ˆè€Œéasm.jsï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> MODULARIZE=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # æ¨¡å—åŒ–å¯¼å‡º</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EXPORT_NAME=&#39;mozjpeg_enc&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # æ¨¡å—åç§°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # === æ€§èƒ½ä¼˜åŒ– ===</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -O3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                       # æœ€é«˜ä¼˜åŒ–çº§åˆ«</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ALLOW_MEMORY_GROWTH=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # å…è®¸å†…å­˜å¢é•¿</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> INITIAL_MEMORY=16MB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # åˆå§‹å†…å­˜16MB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> MAXIMUM_MEMORY=2GB</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # æœ€å¤§å†…å­˜2GB</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # === åŠŸèƒ½é…ç½® ===</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    --bind</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    # å¯ç”¨embindï¼ˆç±»å‹ç»‘å®šï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EXPORTED_FUNCTIONS=&#39;[&quot;_malloc&quot;,&quot;_free&quot;]&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # å¯¼å‡ºå†…å­˜å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # === ä»£ç å¤§å°ä¼˜åŒ– ===</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> FILESYSTEM=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # ä¸åŒ…å«æ–‡ä»¶ç³»ç»Ÿï¼ˆå‡å°ä½“ç§¯ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DISABLE_EXCEPTION_CATCHING=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # ç¦ç”¨å¼‚å¸¸ï¼ˆå‡å°ä½“ç§¯ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # === åº“é“¾æ¥ ===</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -ljpeg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    # é“¾æ¥libjpegåº“</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -I./mozjpeg/include</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\ </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # å¤´æ–‡ä»¶è·¯å¾„</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -L./mozjpeg/lib</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # åº“æ–‡ä»¶è·¯å¾„</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>ä¼˜åŒ–çº§åˆ«å¯¹æ¯”ï¼š</strong></p><table tabindex="0"><thead><tr><th>ä¼˜åŒ–çº§åˆ«</th><th>ç¼–è¯‘æ—¶é—´</th><th>WASMå¤§å°</th><th>è¿è¡Œé€Ÿåº¦</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>-O0</strong></td><td>10ç§’</td><td>2.5MB</td><td>æ…¢(1000ms)</td><td>å¼€å‘è°ƒè¯•</td></tr><tr><td><strong>-O1</strong></td><td>30ç§’</td><td>1.8MB</td><td>ä¸­(500ms)</td><td>å¿«é€Ÿè¿­ä»£</td></tr><tr><td><strong>-O2</strong></td><td>60ç§’</td><td>1.4MB</td><td>å¿«(320ms)</td><td>æµ‹è¯•éªŒè¯</td></tr><tr><td><strong>-O3</strong></td><td>120ç§’</td><td>1.2MB</td><td>å¾ˆå¿«(280ms)</td><td>ç”Ÿäº§ç¯å¢ƒ</td></tr><tr><td><strong>-Oz</strong></td><td>150ç§’</td><td>950KB</td><td>è¾ƒå¿«(350ms)</td><td>ä½“ç§¯ä¼˜å…ˆ</td></tr></tbody></table><p>InsMindé€‰æ‹©<code>-O3</code>ï¼Œå¹³è¡¡äº†æ€§èƒ½å’Œä½“ç§¯ã€‚</p><hr><h3 id="_6-6-å®é™…æ€§èƒ½æµ‹è¯•" tabindex="-1">6.6 å®é™…æ€§èƒ½æµ‹è¯• <a class="header-anchor" href="#_6-6-å®é™…æ€§èƒ½æµ‹è¯•" aria-label="Permalink to &quot;6.6 å®é™…æ€§èƒ½æµ‹è¯•&quot;">â€‹</a></h3><p>è®©æˆ‘ä»¬ç”¨çœŸå®æ•°æ®éªŒè¯WASMçš„æ€§èƒ½æå‡ï¼š</p><p><strong>æµ‹è¯•ç¯å¢ƒï¼š</strong></p><ul><li>è®¾å¤‡ï¼šMacBook Pro 2021 (M1 Pro)</li><li>æµè§ˆå™¨ï¼šChrome 120</li><li>Node.jsï¼šv18.17.0</li></ul><p><strong>æµ‹è¯•åœºæ™¯1ï¼šå•å¼ å›¾ç‰‡å‹ç¼©</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å›¾ç‰‡ï¼š1920Ã—1080 JPEGï¼Œ3.5MB</span></span>
<span class="line"><span>è´¨é‡ï¼š75</span></span>
<span class="line"><span></span></span>
<span class="line"><span>JavaScriptå®ç°ï¼š</span></span>
<span class="line"><span>â”œâ”€ åˆå§‹åŒ–ï¼š50ms</span></span>
<span class="line"><span>â”œâ”€ é¢œè‰²è½¬æ¢ï¼š300ms</span></span>
<span class="line"><span>â”œâ”€ DCTå˜æ¢ï¼š1200ms</span></span>
<span class="line"><span>â”œâ”€ é‡åŒ–ï¼š400ms</span></span>
<span class="line"><span>â”œâ”€ ç†µç¼–ç ï¼š800ms</span></span>
<span class="line"><span>â””â”€ æ€»è®¡ï¼š2750ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>MozJPEG WASMï¼š</span></span>
<span class="line"><span>â”œâ”€ åˆå§‹åŒ–(é¦–æ¬¡)ï¼š80ms</span></span>
<span class="line"><span>â”œâ”€ å‹ç¼©ï¼š280ms</span></span>
<span class="line"><span>â””â”€ æ€»è®¡ï¼š360ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æå‡ï¼š7.6å€</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>æµ‹è¯•åœºæ™¯2ï¼šæ‰¹é‡å‹ç¼©</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>10å¼ å›¾ç‰‡ï¼Œå¹³å‡2MB</span></span>
<span class="line"><span></span></span>
<span class="line"><span>JavaScriptå®ç°ï¼š</span></span>
<span class="line"><span>10 Ã— 2750ms = 27500ms (27.5ç§’)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>WASMå®ç°ï¼ˆå•ä¾‹å¤ç”¨ï¼‰ï¼š</span></span>
<span class="line"><span>åˆå§‹åŒ–ï¼š80ms</span></span>
<span class="line"><span>å‹ç¼©ï¼š10 Ã— 280ms = 2800ms</span></span>
<span class="line"><span>æ€»è®¡ï¼š2880ms (2.9ç§’)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æå‡ï¼š9.5å€</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>æµ‹è¯•åœºæ™¯3ï¼šå†…å­˜å ç”¨</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å³°å€¼å†…å­˜å ç”¨ï¼š</span></span>
<span class="line"><span></span></span>
<span class="line"><span>JavaScriptå®ç°ï¼š</span></span>
<span class="line"><span>â”œâ”€ å›¾ç‰‡æ•°æ®ï¼š8MB</span></span>
<span class="line"><span>â”œâ”€ ä¸­é—´ç¼“å†²åŒºï¼š16MB (å¤šä¸ªä¸´æ—¶å¯¹è±¡)</span></span>
<span class="line"><span>â”œâ”€ GCå¼€é”€ï¼šä¸å¯æ§</span></span>
<span class="line"><span>â””â”€ å³°å€¼ï¼š~25MB</span></span>
<span class="line"><span></span></span>
<span class="line"><span>WASMå®ç°ï¼š</span></span>
<span class="line"><span>â”œâ”€ å›¾ç‰‡æ•°æ®ï¼š8MB</span></span>
<span class="line"><span>â”œâ”€ WASMå†…å­˜ï¼š11MB (è¾“å…¥+è¾“å‡º+ä¸´æ—¶)</span></span>
<span class="line"><span>â”œâ”€ JSå¯¹è±¡ï¼š0.5MB</span></span>
<span class="line"><span>â””â”€ å³°å€¼ï¼š~19.5MB</span></span>
<span class="line"><span></span></span>
<span class="line"><span>èŠ‚çœï¼š22%</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><hr><h3 id="_6-7-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" tabindex="-1">6.7 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ <a class="header-anchor" href="#_6-7-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" aria-label="Permalink to &quot;6.7 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ&quot;">â€‹</a></h3><p><strong>Q1: WASMåŠ è½½å¤±è´¥ï¼Ÿ</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é—®é¢˜ï¼šfetch WASMæ–‡ä»¶å¤±è´¥</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: Failed to fetch mozjpeg_enc.wasm</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è§£å†³ï¼šæ£€æŸ¥WASMæ–‡ä»¶è·¯å¾„</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wasmUrl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./mozjpeg_enc.wasm?url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;WASM URL:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, wasmUrl);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Viteé…ç½®ï¼šç¡®ä¿WASMæ–‡ä»¶è¢«æ­£ç¡®å¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// vite.config.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    assetsInclude: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;**/*.wasm&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>Q2: å†…å­˜ä¸è¶³é”™è¯¯ï¼Ÿ</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é—®é¢˜ï¼šRuntimeError: memory access out of bounds</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åŸå› ï¼šWASMå†…å­˜ä¸è¶³ï¼ˆé»˜è®¤16MBï¼‰</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è§£å†³ï¼šç¼–è¯‘æ—¶å¢å¤§å†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">emcc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">INITIAL_MEMORY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">32</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MB</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ALLOW_MEMORY_GROWTH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>Q3: æ€§èƒ½ä¸å¦‚é¢„æœŸï¼Ÿ</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é—®é¢˜ï¼šWASMæ¯”JSæ…¢ï¼Ÿ</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ£€æŸ¥ç‚¹1ï¼šæ˜¯å¦é‡å¤åˆå§‹åŒ–ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> module;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åº”è¯¥å¤ç”¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    module</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åªåˆå§‹åŒ–ä¸€æ¬¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ£€æŸ¥ç‚¹2ï¼šæ˜¯å¦å¼€å¯ä¼˜åŒ–ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¼–è¯‘æ—¶ä½¿ç”¨ -O3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ£€æŸ¥ç‚¹3ï¼šæ˜¯å¦é¢‘ç¹å¤åˆ¶æ•°æ®ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å°½é‡å¤ç”¨ç¼“å†²åŒºï¼Œå‡å°‘å¤åˆ¶</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>Q4: TypeScriptç±»å‹å®šä¹‰ï¼Ÿ</strong></p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸ºWASMæ¨¡å—æ·»åŠ ç±»å‹å®šä¹‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// mozjpeg_enc.d.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    quality</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    progressive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MozJpegModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8ClampedArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        height</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MozJpegOptions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    free_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><hr><h3 id="_6-8-å°ç»“" tabindex="-1">6.8 å°ç»“ <a class="header-anchor" href="#_6-8-å°ç»“" aria-label="Permalink to &quot;6.8 å°ç»“&quot;">â€‹</a></h3><p>WebAssemblyä¸ºWebå›¾ç‰‡å‹ç¼©å¸¦æ¥äº†é©å‘½æ€§çš„æ€§èƒ½æå‡ï¼š</p><p><strong>æŠ€æœ¯ä»·å€¼ï¼š</strong></p><ul><li>âœ… <strong>10å€æ€§èƒ½æå‡</strong>ï¼šå‹ç¼©æ—¶é—´ä»3ç§’é™è‡³300ms</li><li>âœ… <strong>æ›´å°çš„å†…å­˜å ç”¨</strong>ï¼šç²¾ç¡®çš„å†…å­˜ç®¡ç†ï¼ŒèŠ‚çœ22%</li><li>âœ… <strong>ä»£ç å¤ç”¨</strong>ï¼šå‡ åå¹´çš„C/C++ä»£ç å¯ä»¥ç›´æ¥ç”¨åœ¨Webä¸Š</li><li>âœ… <strong>ç”Ÿäº§ç¯å¢ƒéªŒè¯</strong>ï¼šInsMindæ—¥å‡å¤„ç†æ•°ä¸‡å¼ å›¾ç‰‡ï¼Œç¨³å®šå¯é </li></ul><p><strong>æ¥å…¥å»ºè®®ï¼š</strong></p><ul><li>âœ… <strong>è®¡ç®—å¯†é›†å‹ä»»åŠ¡</strong>ï¼šå›¾åƒå¤„ç†ã€è§†é¢‘ç¼–è§£ç ã€åŠ å¯†è§£å¯†</li><li>âœ… <strong>å·²æœ‰C/C++/Rustä»£ç </strong>ï¼šç›´æ¥ç¼–è¯‘ä¸ºWASMï¼Œæ— éœ€é‡å†™</li><li>âœ… <strong>æ€§èƒ½è¦æ±‚é«˜</strong>ï¼šéœ€è¦æ¥è¿‘åŸç”Ÿæ€§èƒ½çš„åœºæ™¯</li><li>âŒ <strong>ç®€å•é€»è¾‘</strong>ï¼šå¦‚æœJSèƒ½èƒœä»»ï¼Œä¸å¿…ä½¿ç”¨WASMï¼ˆå¢åŠ å¤æ‚åº¦ï¼‰</li><li>âŒ <strong>é¢‘ç¹æ•°æ®äº¤äº’</strong>ï¼šJSâ†”WASMæ•°æ®å¤åˆ¶æœ‰å¼€é”€</li></ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ¢è®¨æ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³å®è·µã€‚</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚                JavaScript å±‚                     â”‚</span></span>
<span class="line"><span>â”‚  encoder.js: é«˜å±‚APIå°è£…                        â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ encode(imageData, options)                  â”‚</span></span>
<span class="line"><span>â”‚  â””â”€ ç®¡ç†WASMæ¨¡å—ç”Ÿå‘½å‘¨æœŸ                        â”‚</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span>
<span class="line"><span>â”‚                Emscripten èƒ¶æ°´å±‚                 â”‚</span></span>
<span class="line"><span>â”‚  mozjpeg_enc.js: è‡ªåŠ¨ç”Ÿæˆçš„JSä»£ç                 â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ WASMæ¨¡å—åŠ è½½                                â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ å†…å­˜ç®¡ç†                                    â”‚</span></span>
<span class="line"><span>â”‚  â””â”€ C++ â†” JS æ•°æ®è½¬æ¢                           â”‚</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span>
<span class="line"><span>â”‚                WebAssembly æ ¸å¿ƒ                  â”‚</span></span>
<span class="line"><span>â”‚  mozjpeg_enc.wasm: ç¼–è¯‘åçš„äºŒè¿›åˆ¶                â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ MozJPEG C++ä»£ç                              â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€ libjpegåº“                                   â”‚</span></span>
<span class="line"><span>â”‚  â””â”€ ä¼˜åŒ–ç®—æ³•ï¼ˆTrellisç­‰ï¼‰                       â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><hr><h3 id="_6-3-æ ¸å¿ƒä»£ç è§£æ" tabindex="-1">6.3 æ ¸å¿ƒä»£ç è§£æ <a class="header-anchor" href="#_6-3-æ ¸å¿ƒä»£ç è§£æ" aria-label="Permalink to &quot;6.3 æ ¸å¿ƒä»£ç è§£æ&quot;">â€‹</a></h3><h4 id="encoder-js-ä¸»å…¥å£" tabindex="-1">encoder.js - ä¸»å…¥å£ <a class="header-anchor" href="#encoder-js-ä¸»å…¥å£" aria-label="Permalink to &quot;encoder.js - ä¸»å…¥å£&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// apps/insmind/libs/squoosh-encoder/encoder.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mozjpeg_enc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./mozjpeg_enc.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { initEmscriptenModule } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./util.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wasmUrl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./mozjpeg_enc.wasm?url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. åˆå§‹åŒ–WASMæ¨¡å—ï¼ˆä»…ä¸€æ¬¡ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">emscriptenModule) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        emscriptenModule </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initEmscriptenModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mozjpeg_enc, wasmUrl);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. è°ƒç”¨WASM encodeå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> resultView</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data.data,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uint8ClampedArray</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data.width,     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®½åº¦</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data.height,    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        options         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å‹ç¼©é€‰é¡¹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. å¤åˆ¶ç»“æœï¼ˆWASMå†…å­˜ â†’ JSå†…å­˜ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(resultView);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4. é‡Šæ”¾WASMå†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 5. è¿”å›ArrayBuffer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.buffer;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><hr><h4 id="util-js-wasmåˆå§‹åŒ–" tabindex="-1">util.js - WASMåˆå§‹åŒ– <a class="header-anchor" href="#util-js-wasmåˆå§‹åŒ–" aria-label="Permalink to &quot;util.js - WASMåˆå§‹åŒ–&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// apps/insmind/libs/squoosh-encoder/util.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initEmscriptenModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">moduleFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">wasmUrl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> moduleFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æŒ‡å®šWASMæ–‡ä»¶ä½ç½®</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        locateFile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (url.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">endsWith</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.wasm&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wasmUrl;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> url;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ‰“å°è¾“å‡ºï¼ˆè°ƒè¯•ç”¨ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // é”™è¯¯è¾“å‡º</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printErr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><hr><h4 id="mozjpeg-enc-cpp-c-æ ¸å¿ƒ" tabindex="-1">mozjpeg_enc.cpp - C++æ ¸å¿ƒ <a class="header-anchor" href="#mozjpeg-enc-cpp-c-æ ¸å¿ƒ" aria-label="Permalink to &quot;mozjpeg_enc.cpp - C++æ ¸å¿ƒ&quot;">â€‹</a></h4><p><strong>å…³é”®ç»“æ„ä½“ï¼š</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// apps/insmind/libs/squoosh-encoder/mozjpeg_enc.cpp (ç¬¬19-36è¡Œ)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> quality;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      // è´¨é‡ 0-100</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baseline;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // åŸºçº¿JPEG</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arithmetic;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // ç®—æœ¯ç¼–ç </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> progressive;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 // æ¸è¿›å¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> optimize_coding;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // ä¼˜åŒ–Huffmanè¡¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> smoothing;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    // å¹³æ»‘åº¦</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> color_space;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // é¢œè‰²ç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> quant_table;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // é‡åŒ–è¡¨ç´¢å¼•</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trellis_multipass;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           // Trelliså¤šæ¬¡æ‰«æ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trellis_opt_zero;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Trellis EOBä¼˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trellis_opt_table;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           // Trellisé‡åŒ–è¡¨ä¼˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> trellis_loops;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // Trellisè¿­ä»£æ¬¡æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> auto_subsample;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              // è‡ªåŠ¨å­é‡‡æ ·</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chroma_subsample;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // è‰²åº¦å­é‡‡æ ·æ¨¡å¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> separate_chroma_quality;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // è‰²åº¦ç‹¬ç«‹è´¨é‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chroma_quality;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               // è‰²åº¦è´¨é‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>encodeå‡½æ•°æ ¸å¿ƒæµç¨‹ï¼š</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// mozjpeg_enc.cpp (ç¬¬57è¡Œå¼€å§‹)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">val</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> image_in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> image_width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> image_height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> opts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint8_t*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint8_t*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) image_in.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">c_str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ===== æ­¥éª¤1ï¼šåˆå§‹åŒ–JPEGå‹ç¼©å¯¹è±¡ =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jpeg_compress_struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cinfo;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jpeg_error_mgr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jerr;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jpeg_std_error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">jerr);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_create_compress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ===== æ­¥éª¤2ï¼šè®¾ç½®è¾“å‡ºç›®æ ‡ï¼ˆå†…å­˜ï¼‰ =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint8_t*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> output;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_mem_dest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">output, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">size);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è¾“å‡ºåˆ°å†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ===== æ­¥éª¤3ï¼šè®¾ç½®å›¾åƒå‚æ•° =====</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.image_width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_width;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.image_height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_height;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.input_components </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              // RGBA</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.in_color_space </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JCS_EXT_RGBA;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // é¢œè‰²ç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_set_defaults</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ===== æ­¥éª¤4ï¼šåº”ç”¨è‡ªå®šä¹‰é€‰é¡¹ =====</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.1 é¢œè‰²ç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_set_colorspace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, (J_COLOR_SPACE) opts.color_space);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.2 é‡åŒ–è¡¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (opts.quant_table </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        jpeg_c_set_int_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JINT_BASE_QUANT_TBL_IDX, opts.quant_table);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.3 ç¼–ç ä¼˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.optimize_coding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.optimize_coding;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.4 ç®—æœ¯ç¼–ç ï¼ˆæ›¿ä»£Huffmanï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (opts.arithmetic) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cinfo.arith_code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRUE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cinfo.optimize_coding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FALSE;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.5 å¹³æ»‘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cinfo.smoothing_factor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.smoothing;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.6 Trellisä¼˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_c_set_bool_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JBOOLEAN_USE_SCANS_IN_TRELLIS, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                          opts.trellis_multipass);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_c_set_bool_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JBOOLEAN_TRELLIS_EOB_OPT, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                          opts.trellis_opt_zero);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_c_set_bool_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JBOOLEAN_TRELLIS_Q_OPT, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                          opts.trellis_opt_table);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_c_set_int_param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, JINT_TRELLIS_NUM_LOOPS, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                         opts.trellis_loops);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.7 è´¨é‡è®¾ç½®</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::string quality_str </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to_string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.quality);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (opts.separate_chroma_quality </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.color_space </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JCS_YCbCr) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        quality_str </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;,&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to_string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(opts.chroma_quality);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    set_quality_ratings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) quality_str.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">c_str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), opts.baseline);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.8 å­é‡‡æ ·</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">opts.auto_subsample </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.color_space </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JCS_YCbCr) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cinfo.comp_info[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].h_samp_factor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.chroma_subsample;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cinfo.comp_info[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].v_samp_factor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.chroma_subsample;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.9 æ¸è¿›å¼</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">opts.baseline </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opts.progressive) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        jpeg_simple_progression</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ===== æ­¥éª¤5ï¼šå¼€å§‹å‹ç¼© =====</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_start_compress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, TRUE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ===== æ­¥éª¤6ï¼šé€è¡Œå†™å…¥ =====</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    JSAMPROW row_pointer[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> row_stride </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // RGBA</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (cinfo.next_scanline </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cinfo.image_height) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        row_pointer[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">image_buffer[cinfo.next_scanline </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> row_stride];</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        jpeg_write_scanlines</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo, row_pointer, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ===== æ­¥éª¤7ï¼šå®Œæˆå‹ç¼© =====</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_finish_compress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ===== æ­¥éª¤8ï¼šè¿”å›ç»“æœ =====</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    last_result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> output;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">typed_memory_view</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size, output));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> free_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    jpeg_destroy_compress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cinfo);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // é‡Šæ”¾èµ„æº</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><hr><h3 id="_6-4-emscriptenç»‘å®š" tabindex="-1">6.4 Emscriptenç»‘å®š <a class="header-anchor" href="#_6-4-emscriptenç»‘å®š" aria-label="Permalink to &quot;6.4 Emscriptenç»‘å®š&quot;">â€‹</a></h3><p><strong>å¯¼å‡ºC++å‡½æ•°ç»™JavaScriptï¼š</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// mozjpeg_enc.cpp (ç¬¬211-234è¡Œ)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EMSCRIPTEN_BINDINGS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(my_module) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç»‘å®šé€‰é¡¹ç»“æ„ä½“</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    value_object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MozJpegOptions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;quality&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::quality)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;baseline&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::baseline)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;arithmetic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::arithmetic)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;progressive&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::progressive)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;optimize_coding&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::optimize_coding)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;smoothing&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::smoothing)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;color_space&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::color_space)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;quant_table&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::quant_table)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;trellis_multipass&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::trellis_multipass)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;trellis_opt_zero&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::trellis_opt_zero)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;trellis_opt_table&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::trellis_opt_table)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;trellis_loops&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::trellis_loops)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;chroma_subsample&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::chroma_subsample)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;auto_subsample&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::auto_subsample)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;separate_chroma_quality&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::separate_chroma_quality)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;chroma_quality&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MozJpegOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::chroma_quality);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç»‘å®šå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">version);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;encode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">encode);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;free_result&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">free_result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>JavaScriptè°ƒç”¨ç¤ºä¾‹ï¼š</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åˆ›å»ºé€‰é¡¹å¯¹è±¡ï¼ˆè‡ªåŠ¨æ˜ å°„åˆ°C++ç»“æ„ä½“ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    quality: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">90</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baseline: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    progressive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    optimize_coding: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    trellis_multipass: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... å…¶ä»–é€‰é¡¹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è°ƒç”¨C++çš„encodeå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData.data, width, height, options);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><hr><h3 id="_6-5-å†…å­˜ç®¡ç†" tabindex="-1">6.5 å†…å­˜ç®¡ç† <a class="header-anchor" href="#_6-5-å†…å­˜ç®¡ç†" aria-label="Permalink to &quot;6.5 å†…å­˜ç®¡ç†&quot;">â€‹</a></h3><h4 id="wasmçº¿æ€§å†…å­˜æ¨¡å‹" tabindex="-1">WASMçº¿æ€§å†…å­˜æ¨¡å‹ <a class="header-anchor" href="#wasmçº¿æ€§å†…å­˜æ¨¡å‹" aria-label="Permalink to &quot;WASMçº¿æ€§å†…å­˜æ¨¡å‹&quot;">â€‹</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>WASMå†…å­˜ï¼šè¿ç»­çš„ArrayBuffer</span></span>
<span class="line"><span></span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  0KB     é™æ€æ•°æ®                         â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚</span></span>
<span class="line"><span>â”‚  100KB   å †å†…å­˜èµ·å§‹                       â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚</span></span>
<span class="line"><span>â”‚  â”‚ mallocåˆ†é…çš„æ•°æ®                       â”‚</span></span>
<span class="line"><span>â”‚  â”‚ â”œâ”€â”€ image_buffer                     â”‚</span></span>
<span class="line"><span>â”‚  â”‚ â”œâ”€â”€ output_buffer                    â”‚</span></span>
<span class="line"><span>â”‚  â”‚ â””â”€â”€ ä¸´æ—¶æ•°æ®                          â”‚</span></span>
<span class="line"><span>â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚</span></span>
<span class="line"><span>â”‚  10MB    æ ˆå†…å­˜                           â”‚</span></span>
<span class="line"><span>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚</span></span>
<span class="line"><span>â”‚  16MB    æœ€å¤§å†…å­˜                         â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="æ•°æ®ä¼ é€’æµç¨‹" tabindex="-1">æ•°æ®ä¼ é€’æµç¨‹ <a class="header-anchor" href="#æ•°æ®ä¼ é€’æµç¨‹" aria-label="Permalink to &quot;æ•°æ®ä¼ é€’æµç¨‹&quot;">â€‹</a></h4><p><strong>JavaScript â†’ WASMï¼š</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1. JSç«¯ï¼šUint8ClampedArray</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> imageData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getImageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, width, height);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// imageData.data: Uint8ClampedArray(8294400)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2. ä¼ é€’ç»™WASMï¼ˆè‡ªåŠ¨å¤åˆ¶ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData.data, width, height, options);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3. WASMç«¯ï¼šC++è‡ªåŠ¨æ¥æ”¶ä¸ºstd::string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">val </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(std::string image_in, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    uint8_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image_buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (uint8_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) image_in.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">c_str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç°åœ¨å¯ä»¥ç›´æ¥è®¿é—®åƒç´ æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>WASM â†’ JavaScriptï¼š</strong></p><div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1. C++ç«¯ï¼šè¿”å›typed_memory_view</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">typed_memory_view</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(size, output));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¿™ä¼šåˆ›å»ºä¸€ä¸ªæŒ‡å‘WASMå†…å­˜çš„è§†å›¾</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2. JSç«¯ï¼šæ¥æ”¶å¹¶å¤åˆ¶</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> resultView </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(...);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(resultView);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // å¤åˆ¶åˆ°JSå †</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¿…é¡»å¤åˆ¶ï¼å› ä¸ºfree_result()ä¼šé‡Šæ”¾WASMå†…å­˜</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3. é‡Šæ”¾WASMå†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="å†…å­˜æ³„æ¼é˜²èŒƒ" tabindex="-1">å†…å­˜æ³„æ¼é˜²èŒƒ <a class="header-anchor" href="#å†…å­˜æ³„æ¼é˜²èŒƒ" aria-label="Permalink to &quot;å†…å­˜æ³„æ¼é˜²èŒƒ&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> resultView;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        resultView </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.data, data.width, data.height, options);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç«‹å³å¤åˆ¶ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(resultView);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.buffer;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½é‡Šæ”¾WASMå†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (resultView) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><hr><h2 id="ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ" tabindex="-1">ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ <a class="header-anchor" href="#ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ" aria-label="Permalink to &quot;ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ&quot;">â€‹</a></h2><h3 id="_7-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" tabindex="-1">7.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ <a class="header-anchor" href="#_7-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" aria-label="Permalink to &quot;7.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥&quot;">â€‹</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚              CompressService                         â”‚</span></span>
<span class="line"><span>â”‚  (BaseEditorServiceå­ç±»)                            â”‚</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span>
<span class="line"><span>â”‚                                                      â”‚</span></span>
<span class="line"><span>â”‚  state: {                                            â”‚</span></span>
<span class="line"><span>â”‚    originImage: string                               â”‚</span></span>
<span class="line"><span>â”‚    resultImage: string                               â”‚</span></span>
<span class="line"><span>â”‚    originSize: number                                â”‚</span></span>
<span class="line"><span>â”‚    resultSize: number                                â”‚</span></span>
<span class="line"><span>â”‚  }                                                   â”‚</span></span>
<span class="line"><span>â”‚                                                      â”‚</span></span>
<span class="line"><span>â”‚  main() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚</span></span>
<span class="line"><span>â”‚                  â†“                                   â”‚</span></span>
<span class="line"><span>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚</span></span>
<span class="line"><span>â”‚  â”‚  1. è·å–ImageData              â”‚                  â”‚</span></span>
<span class="line"><span>â”‚  â”‚  2. åˆ¤æ–­æ ¼å¼ï¼ˆPNG/JPEGï¼‰       â”‚                  â”‚</span></span>
<span class="line"><span>â”‚  â”‚  3. è°ƒç”¨å¯¹åº”ç¼–ç å™¨              â”‚                  â”‚</span></span>
<span class="line"><span>â”‚  â”‚  4. ç”ŸæˆBlob                   â”‚                  â”‚</span></span>
<span class="line"><span>â”‚  â”‚  5. æ›´æ–°çŠ¶æ€                    â”‚                  â”‚</span></span>
<span class="line"><span>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>         â”‚                    â”‚</span></span>
<span class="line"><span>         â†“                    â†“</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  compressJpg     â”‚ â”‚  compressPng    â”‚</span></span>
<span class="line"><span>â”‚  (MozJPEG WASM)  â”‚ â”‚  (ImageQuant)   â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><hr><h3 id="_6-2-æ ¸å¿ƒä»£ç å®ç°" tabindex="-1">6.2 æ ¸å¿ƒä»£ç å®ç° <a class="header-anchor" href="#_6-2-æ ¸å¿ƒä»£ç å®ç°" aria-label="Permalink to &quot;6.2 æ ¸å¿ƒä»£ç å®ç°&quot;">â€‹</a></h3><h4 id="compressserviceä¸»æœåŠ¡" tabindex="-1">CompressServiceä¸»æœåŠ¡ <a class="header-anchor" href="#compressserviceä¸»æœåŠ¡" aria-label="Permalink to &quot;CompressServiceä¸»æœåŠ¡&quot;">â€‹</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// compress/services/index.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CompressService</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BaseEditorService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ICompressServiceState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IBaseEditorServiceOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        super</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            state: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                originSize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                resultSize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">options.state,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            config: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                showGenerateBtn: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                download: [</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCompressLow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                edit: [</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isMobile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ACTION_ITEM_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.editMore </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> EDIT_MORE_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.edit],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                editMore: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isMobile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    EDIT_MORE_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.resize,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    EDIT_MORE_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.magicEraser,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                scroll: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isMobile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">options.config,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.loading </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.tracker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trackToolConflateStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ===== æ­¥éª¤1ï¼šè·å–åŸå§‹å›¾åƒä¿¡æ¯ =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.compressOriginImagePromise;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getImageSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.originImage);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.originSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ===== æ­¥éª¤2ï¼šç»˜åˆ¶åˆ°Canvaså¹¶è·å–ImageData =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createCanvas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                width: image.width,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                height: image.height,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drawImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> imageData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getImageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, image.width, image.height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ===== æ­¥éª¤3ï¼šæ ¹æ®æ ¼å¼é€‰æ‹©ç¼–ç å™¨ =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> encodeFn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.config.originMime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MIME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.png </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compressPng </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> compressJpg;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ===== æ­¥éª¤4ï¼šæ‰§è¡Œå‹ç¼© =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encodeFn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, image.width, image.height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ===== æ­¥éª¤5ï¼šç”ŸæˆBlobå’ŒURL =====</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> blob</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Blob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([result], { type: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.config.targetMime });</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.resultSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> blob.size;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> resultImage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createObjectURL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(blob);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // ===== æ­¥éª¤6ï¼šæ›´æ–°UI =====</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">updateResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(resultImage);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.tracker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trackToolConflateCompleted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">showErrorMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(error);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> error;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åˆæˆæœ€ç»ˆç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    compose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getImageBlob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.resultImage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state.originImage);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åŸ‹ç‚¹ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    getTrackerOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            tool_type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;å›¾åƒç¼–è¾‘&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            tool_name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;å›¾ç‰‡å‹ç¼©&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            source: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.config.trackerLocation </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;-å›¾ç‰‡å‹ç¼©&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            import_format: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.config.originMime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><hr><h4 id="jpegå‹ç¼©å®ç°" tabindex="-1">JPEGå‹ç¼©å®ç° <a class="header-anchor" href="#jpegå‹ç¼©å®ç°" aria-label="Permalink to &quot;JPEGå‹ç¼©å®ç°&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// @gaoding/squoosh-encoder/encoder.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mozjpeg_enc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./mozjpeg_enc.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { initEmscriptenModule } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./util.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wasmUrl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./mozjpeg_enc.wasm?url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * å‹ç¼©JPEGå›¾åƒ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {ImageData}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imageData</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - Canvas ImageDataå¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {number}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - å›¾åƒå®½åº¦</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {number}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> height</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - å›¾åƒé«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {object}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> options</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - å‹ç¼©é€‰é¡¹</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@returns</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {Promise&lt;ArrayBuffer&gt;}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> å‹ç¼©åçš„JPEGæ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressJpg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // é»˜è®¤é€‰é¡¹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> defaultOptions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        quality: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">75</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è´¨é‡75</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        baseline: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// éåŸºçº¿æ¨¡å¼</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        arithmetic: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸ä½¿ç”¨ç®—æœ¯ç¼–ç </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        progressive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ¸è¿›å¼</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        optimize_coding: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼˜åŒ–Huffmanè¡¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        smoothing: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                 </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ— å¹³æ»‘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        color_space: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JCS_YCbCr</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        quant_table: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é‡åŒ–è¡¨3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        trellis_multipass: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Trelliså¤šæ¬¡æ‰«æ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        trellis_opt_zero: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Trellisé›¶ä¼˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        trellis_opt_table: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Trellisè¡¨ä¼˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        trellis_loops: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Trellisè¿­ä»£1æ¬¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        auto_subsample: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è‡ªåŠ¨å­é‡‡æ ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        chroma_subsample: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 4:2:0å­é‡‡æ ·</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        separate_chroma_quality: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸åˆ†ç¦»è‰²åº¦è´¨é‡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        chroma_quality: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">75</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,          </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è‰²åº¦è´¨é‡75</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">options,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åˆå§‹åŒ–WASMæ¨¡å—</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">emscriptenModule) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        emscriptenModule </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initEmscriptenModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mozjpeg_enc, wasmUrl);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> emscriptenModule;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // è°ƒç”¨WASM encode</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> resultView</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            imageData.data,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Uint8ClampedArray</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            width,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            height,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            defaultOptions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å¤åˆ¶ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(resultView);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.buffer;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // é‡Šæ”¾WASMå†…å­˜</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><hr><h4 id="pngå‹ç¼©å®ç°" tabindex="-1">PNGå‹ç¼©å®ç° <a class="header-anchor" href="#pngå‹ç¼©å®ç°" aria-label="Permalink to &quot;PNGå‹ç¼©å®ç°&quot;">â€‹</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// compress/services/image-quant/encode.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wasm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./imagequant_wasm_bg.wasm?url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> init, { compressImage } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./imagequant_wasm&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * PNGå‹ç¼©ï¼ˆImageQuantï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buffer</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - RGBAåƒç´ æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - å®½åº¦</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> height</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@returns</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> Promise&lt;Uint8Array&gt; å‹ç¼©åçš„PNGæ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    buffer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    height</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Uint8Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åˆå§‹åŒ–WASM</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(wasm);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è°ƒç”¨Rust WASMå‹ç¼©</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // min=0, max=75: è´¨é‡èŒƒå›´0-75</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> optAPNG</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buffer, width, height, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">75</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> optAPNG;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// compress/services/image-quant/index.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { encode } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./encode&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * å‹ç¼©PNG</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {ImageData}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imgData</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - Canvas ImageData</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {number}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - å®½åº¦</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {number}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> height</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> - é«˜åº¦</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@returns</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {Promise&lt;Uint8Array&gt;}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> å‹ç¼©ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressPng</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imgData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ImageData.data æ˜¯ Uint8ClampedArray</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è½¬æ¢ä¸º Uint8Array</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Uint8Array.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imgData.data), width, height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><hr><h3 id="_6-3-uiç»„ä»¶å®ç°" tabindex="-1">6.3 UIç»„ä»¶å®ç° <a class="header-anchor" href="#_6-3-uiç»„ä»¶å®ç°" aria-label="Permalink to &quot;6.3 UIç»„ä»¶å®ç°&quot;">â€‹</a></h3><div class="language-vue vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- compress/index.vue --&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">template</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;compress-editor&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    &lt;!-- é¢„è§ˆåŒºåŸŸ --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;preview-area&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;image-compare&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;original&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">img</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> :src</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;service.state.originImage&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> alt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;åŸå›¾&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;info&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;åŸå§‹å¤§å°&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;size&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;{{ formatSize(service.state.originSize) }}&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;compressed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">img</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> :src</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;service.state.resultImage&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> alt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;å‹ç¼©å&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;info&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;å‹ç¼©å&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;size&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;{{ formatSize(service.state.resultSize) }}&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      &lt;!-- å‹ç¼©ç‡æ˜¾ç¤º --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;compression-ratio&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;å‹ç¼©ç‡ï¼š{{ compressionRatio }}%&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;èŠ‚çœï¼š{{ savedSize }}&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    &lt;!-- åŠ è½½çŠ¶æ€ --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> v-if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;service.state.loading&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;loading&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Spin</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;å‹ç¼©ä¸­...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">template</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { computed } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vue&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { CompressService } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./services&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> service</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CompressService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... é…ç½®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> formatSize</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bytes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} B\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (bytes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bytes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toFixed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} KB\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bytes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toFixed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} MB\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å‹ç¼©ç‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> compressionRatio</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> computed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">service.state.originSize) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ratio</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((service.state.originSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> service.state.resultSize) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                 service.state.originSize) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ratio.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toFixed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// èŠ‚çœç©ºé—´</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> savedSize</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> computed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> saved</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> service.state.originSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> service.state.resultSize;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> formatSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(saved);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><hr><h3 id="_6-4-å®Œæ•´å‹ç¼©æµç¨‹ç¤ºä¾‹" tabindex="-1">6.4 å®Œæ•´å‹ç¼©æµç¨‹ç¤ºä¾‹ <a class="header-anchor" href="#_6-4-å®Œæ•´å‹ç¼©æµç¨‹ç¤ºä¾‹" aria-label="Permalink to &quot;6.4 å®Œæ•´å‹ç¼©æµç¨‹ç¤ºä¾‹&quot;">â€‹</a></h3><p><strong>ç”¨æˆ·æ“ä½œæµç¨‹ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>2. CompressServiceåˆå§‹åŒ–</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>3. main()è‡ªåŠ¨æ‰§è¡Œï¼š</span></span>
<span class="line"><span>   â”œâ”€ è·å–å›¾ç‰‡å°ºå¯¸å’ŒåŸå§‹å¤§å°</span></span>
<span class="line"><span>   â”œâ”€ ç»˜åˆ¶åˆ°Canvas</span></span>
<span class="line"><span>   â”œâ”€ è·å–ImageData</span></span>
<span class="line"><span>   â”œâ”€ æ ¹æ®æ ¼å¼è°ƒç”¨compressJpg/compressPng</span></span>
<span class="line"><span>   â”œâ”€ WASMæ‰§è¡Œå‹ç¼©</span></span>
<span class="line"><span>   â”œâ”€ ç”ŸæˆBlob</span></span>
<span class="line"><span>   â””â”€ æ›´æ–°UIæ˜¾ç¤º</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>4. ç”¨æˆ·æŸ¥çœ‹å¯¹æ¯”</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>5. ç”¨æˆ·ä¸‹è½½å‹ç¼©åçš„å›¾ç‰‡</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>æ•°æ®æµè½¬ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>HTMLImageElement</span></span>
<span class="line"><span>    â†“ drawImage()</span></span>
<span class="line"><span>Canvas</span></span>
<span class="line"><span>    â†“ getImageData()</span></span>
<span class="line"><span>ImageData { data: Uint8ClampedArray }</span></span>
<span class="line"><span>    â†“ compressJpg/Png()</span></span>
<span class="line"><span>WASM Module</span></span>
<span class="line"><span>    â†“ encode()</span></span>
<span class="line"><span>Uint8Array (å‹ç¼©æ•°æ®)</span></span>
<span class="line"><span>    â†“ new Blob()</span></span>
<span class="line"><span>Blob</span></span>
<span class="line"><span>    â†“ URL.createObjectURL()</span></span>
<span class="line"><span>Blob URL</span></span>
<span class="line"><span>    â†“ &lt;img src=&quot;...&quot;&gt;</span></span>
<span class="line"><span>æ˜¾ç¤ºåœ¨é¡µé¢</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><hr><h2 id="ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ-1" tabindex="-1">ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ <a class="header-anchor" href="#ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ-1" aria-label="Permalink to &quot;ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ&quot;">â€‹</a></h2><h3 id="_7-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥-1" tabindex="-1">7.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ <a class="header-anchor" href="#_7-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥-1" aria-label="Permalink to &quot;7.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥&quot;">â€‹</a></h3><h4 id="_1-å¼‚æ­¥å¤„ç†" tabindex="-1">1. å¼‚æ­¥å¤„ç† <a class="header-anchor" href="#_1-å¼‚æ­¥å¤„ç†" aria-label="Permalink to &quot;1. å¼‚æ­¥å¤„ç†&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âŒ é”™è¯¯ï¼šåŒæ­¥é˜»å¡ä¸»çº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressSync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> expensiveCompression</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é˜»å¡3ç§’</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… æ­£ç¡®ï¼šå¼‚æ­¥éé˜»å¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressAsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // WASMæœ¬èº«å¾ˆå¿«ï¼Œä½†å¯ä»¥é…åˆWorker</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressJpg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_2-web-workerå¹¶è¡Œ" tabindex="-1">2. Web Workerå¹¶è¡Œ <a class="header-anchor" href="#_2-web-workerå¹¶è¡Œ" aria-label="Permalink to &quot;2. Web Workerå¹¶è¡Œ&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// worker.js</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onmessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åœ¨Workerä¸­å‹ç¼©ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressJpg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, options);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ result }, [result]);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è½¬ç§»æ‰€æœ‰æƒï¼Œé›¶æ‹·è´</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸»çº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> worker</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Worker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;worker.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">worker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">postMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    imageData,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    options </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, [imageData.data.buffer]);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è½¬ç§»ArrayBufferï¼Œé›¶æ‹·è´</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">worker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onmessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> compressed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.data.result;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å¤„ç†ç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_3-æ‰¹é‡å‹ç¼©ä¼˜åŒ–" tabindex="-1">3. æ‰¹é‡å‹ç¼©ä¼˜åŒ– <a class="header-anchor" href="#_3-æ‰¹é‡å‹ç¼©ä¼˜åŒ–" aria-label="Permalink to &quot;3. æ‰¹é‡å‹ç¼©ä¼˜åŒ–&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * æ‰¹é‡å‹ç¼©ï¼ˆæ§åˆ¶å¹¶å‘ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressBatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">images</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">maxConcurrent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> results</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> executing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> image</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> images) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> promise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressJpg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            results.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            executing.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">splice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(executing.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">indexOf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(promise), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        executing.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(promise);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æ§åˆ¶å¹¶å‘æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (executing.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxConcurrent) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">race</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(executing);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(executing);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> results;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="_4-å†…å­˜ä¼˜åŒ–" tabindex="-1">4. å†…å­˜ä¼˜åŒ– <a class="header-anchor" href="#_4-å†…å­˜ä¼˜åŒ–" aria-label="Permalink to &quot;4. å†…å­˜ä¼˜åŒ–&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * å¤§å›¾åˆ†å—å¤„ç†</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressLargeImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">maxSize</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å¦‚æœå›¾ç‰‡å°äºmaxSizeï¼Œç›´æ¥å‹ç¼©</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxSize) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressJpg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å¤§å›¾ï¼šå…ˆç¼©å°åˆ°maxSizeä»¥å†…</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> scale</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(maxSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width, maxSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> height);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> scaledImage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> resizeImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(image, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> scale),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> scale)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressJpg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(scaledImage);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><hr><h3 id="_7-2-è´¨é‡ä¸æ–‡ä»¶å¤§å°æƒè¡¡" tabindex="-1">7.2 è´¨é‡ä¸æ–‡ä»¶å¤§å°æƒè¡¡ <a class="header-anchor" href="#_7-2-è´¨é‡ä¸æ–‡ä»¶å¤§å°æƒè¡¡" aria-label="Permalink to &quot;7.2 è´¨é‡ä¸æ–‡ä»¶å¤§å°æƒè¡¡&quot;">â€‹</a></h3><h4 id="è´¨é‡å‚æ•°é€‰æ‹©" tabindex="-1">è´¨é‡å‚æ•°é€‰æ‹© <a class="header-anchor" href="#è´¨é‡å‚æ•°é€‰æ‹©" aria-label="Permalink to &quot;è´¨é‡å‚æ•°é€‰æ‹©&quot;">â€‹</a></h4><p><strong>JPEGè´¨é‡å»ºè®®ï¼š</strong></p><table tabindex="0"><thead><tr><th>åœºæ™¯</th><th>è´¨é‡</th><th>æ–‡ä»¶å¤§å°</th><th>è§†è§‰æ•ˆæœ</th></tr></thead><tbody><tr><td><strong>ç¼©ç•¥å›¾</strong></td><td>50-60</td><td>å¾ˆå°</td><td>å¯æ¥å—</td></tr><tr><td><strong>Webæ™®é€š</strong></td><td>75-85</td><td>ä¸­ç­‰</td><td>è‰¯å¥½</td></tr><tr><td><strong>é«˜è´¨é‡</strong></td><td>90-95</td><td>è¾ƒå¤§</td><td>ä¼˜ç§€</td></tr><tr><td><strong>æ— æŸçº§åˆ«</strong></td><td>100</td><td>æœ€å¤§</td><td>å®Œç¾</td></tr></tbody></table><p><strong>å®æµ‹æ•°æ®ï¼ˆ1920Ã—1080ç…§ç‰‡ï¼‰ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è´¨é‡100: 2.5MB  (åŸºå‡†)</span></span>
<span class="line"><span>è´¨é‡95:  1.2MB  (èŠ‚çœ52%)</span></span>
<span class="line"><span>è´¨é‡90:  800KB  (èŠ‚çœ68%)</span></span>
<span class="line"><span>è´¨é‡85:  600KB  (èŠ‚çœ76%)</span></span>
<span class="line"><span>è´¨é‡75:  400KB  (èŠ‚çœ84%)</span></span>
<span class="line"><span>è´¨é‡50:  200KB  (èŠ‚çœ92%)</span></span>
<span class="line"><span>è´¨é‡25:  100KB  (èŠ‚çœ96%, æ˜æ˜¾å¤±çœŸ)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>è´¨é‡å¯¹æ¯”å¯è§†åŒ–ï¼š</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>è´¨é‡100 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2.5MB   è§†è§‰: â˜…â˜…â˜…â˜…â˜…</span></span>
<span class="line"><span>è´¨é‡90  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 800KB   è§†è§‰: â˜…â˜…â˜…â˜…â˜…</span></span>
<span class="line"><span>è´¨é‡75  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 400KB   è§†è§‰: â˜…â˜…â˜…â˜…â˜†</span></span>
<span class="line"><span>è´¨é‡50  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 200KB   è§†è§‰: â˜…â˜…â˜…â˜†â˜†</span></span>
<span class="line"><span>è´¨é‡25  â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 100KB   è§†è§‰: â˜…â˜…â˜†â˜†â˜†</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="è‡ªé€‚åº”è´¨é‡ç®—æ³•" tabindex="-1">è‡ªé€‚åº”è´¨é‡ç®—æ³• <a class="header-anchor" href="#è‡ªé€‚åº”è´¨é‡ç®—æ³•" aria-label="Permalink to &quot;è‡ªé€‚åº”è´¨é‡ç®—æ³•&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * æ ¹æ®å›¾åƒå†…å®¹è‡ªåŠ¨é€‰æ‹©è´¨é‡</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getAdaptiveQuality</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imageData;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. è®¡ç®—å›¾åƒå¤æ‚åº¦ï¼ˆè¾¹ç¼˜å¯†åº¦ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> complexity</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateComplexity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data, width, height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. æ ¹æ®å¤æ‚åº¦é€‰æ‹©è´¨é‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (complexity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç®€å•å›¾åƒï¼ˆæ¸å˜ã€çº¯è‰²ï¼‰ï¼šå¯ä»¥ç”¨è¾ƒä½è´¨é‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 70</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (complexity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ä¸­ç­‰å¤æ‚åº¦ï¼šæ ‡å‡†è´¨é‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // å¤æ‚å›¾åƒï¼ˆçº¹ç†ã€ç»†èŠ‚å¤šï¼‰ï¼šéœ€è¦é«˜è´¨é‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 90</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * è®¡ç®—å›¾åƒå¤æ‚åº¦ï¼ˆSobelè¾¹ç¼˜æ£€æµ‹ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateComplexity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> edgeCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> threshold</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; y</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> idx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Sobelç®—å­</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> gx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]             </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> gy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> magnitude</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sqrt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(gx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gy);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (magnitude </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threshold) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                edgeCount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å½’ä¸€åŒ–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> edgeCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> height);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><hr><h3 id="_7-3-æœ€ä½³å®è·µ" tabindex="-1">7.3 æœ€ä½³å®è·µ <a class="header-anchor" href="#_7-3-æœ€ä½³å®è·µ" aria-label="Permalink to &quot;7.3 æœ€ä½³å®è·µ&quot;">â€‹</a></h3><h4 id="_1-æ ¼å¼é€‰æ‹©" tabindex="-1">1. æ ¼å¼é€‰æ‹© <a class="header-anchor" href="#_1-æ ¼å¼é€‰æ‹©" aria-label="Permalink to &quot;1. æ ¼å¼é€‰æ‹©&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * æ™ºèƒ½é€‰æ‹©æ ¼å¼</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> selectOptimalFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imageData;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥æ˜¯å¦æœ‰é€æ˜åƒç´ </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hasTransparency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 255</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            hasTransparency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (hasTransparency) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // æœ‰é€æ˜åº¦ â†’ å¿…é¡»ç”¨PNGæˆ–WebP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;image/png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥æ˜¯å¦æ˜¯ç…§ç‰‡ï¼ˆé¢œè‰²ä¸°å¯Œï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> uniqueColors</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> countUniqueColors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (uniqueColors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç…§ç‰‡çº§åˆ« â†’ JPEG</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;image/jpeg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ç®€å•å›¾åƒï¼ˆå›¾æ ‡ã€æˆªå›¾ï¼‰â†’ PNG</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;image/png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * ç»Ÿè®¡å”¯ä¸€é¢œè‰²æ•°ï¼ˆé‡‡æ ·ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> countUniqueColors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sampleRate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> colors</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sampleRate) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i)];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> g</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> b</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        colors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (g </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> colors.size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sampleRate;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h4 id="_2-æ¸è¿›å¼åŠ è½½" tabindex="-1">2. æ¸è¿›å¼åŠ è½½ <a class="header-anchor" href="#_2-æ¸è¿›å¼åŠ è½½" aria-label="Permalink to &quot;2. æ¸è¿›å¼åŠ è½½&quot;">â€‹</a></h4><div class="language-html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- æ¸è¿›å¼å›¾ç‰‡åŠ è½½ --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">img</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    src</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;thumbnail-small.jpg&quot;</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">           &lt;!--</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> å°ç¼©ç•¥å›¾ï¼ˆ5KBï¼‰â†’</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ç«‹å³æ˜¾ç¤º</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> --</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data-src=&quot;thumbnail-medium.jpg&quot;     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- 2. ä¸­ç­‰ç¼©ç•¥å›¾ï¼ˆ50KBï¼‰â†’ 1ç§’ååŠ è½½ --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data-full=&quot;image-full.jpg&quot;          </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- 3. å®Œæ•´å›¾ç‰‡ï¼ˆ500KBï¼‰â†’ ç”¨æˆ·äº¤äº’ååŠ è½½ --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    alt=&quot;å›¾ç‰‡&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    loading=&quot;lazy&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ¸è¿›å¼åŠ è½½å®ç°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> progressiveLoad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">img</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // åŠ è½½ä¸­ç­‰è´¨é‡</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> mediumSrc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> img.dataset.src;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tempImg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        tempImg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            img.src </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mediumSrc;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        tempImg.src </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mediumSrc;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç”¨æˆ·æ»šåŠ¨åˆ°è§†å£å†…ï¼ŒåŠ è½½å®Œæ•´å›¾ç‰‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> observer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IntersectionObserver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">entries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        entries.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">entry</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (entry.isIntersecting) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fullSrc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> img.dataset.full;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tempImg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                tempImg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    img.src </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fullSrc;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                tempImg.src </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fullSrc;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                observer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unobserve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(img);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    observer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">observe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(img);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h4 id="_3-ç¼“å­˜ç­–ç•¥" tabindex="-1">3. ç¼“å­˜ç­–ç•¥ <a class="header-anchor" href="#_3-ç¼“å­˜ç­–ç•¥" aria-label="Permalink to &quot;3. ç¼“å­˜ç­–ç•¥&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * å‹ç¼©ç»“æœç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CompressionCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">maxSize</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.maxSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxSize;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * ç”Ÿæˆç¼“å­˜é”®</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    generateKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ä½¿ç”¨å›¾åƒhash + é€‰é¡¹hashä½œä¸ºé”®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> imageHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hashImageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> optionsHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(options);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">imageHash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}-\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">optionsHash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * å›¾åƒæ•°æ®hashï¼ˆé‡‡æ ·ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    hashImageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imageData;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // é‡‡æ ·100ä¸ªåƒç´ </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> step</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 400</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> step) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hash) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data[i];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è½¬ä¸º32ä½æ•´æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}-\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">width</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}x\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">height</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * è·å–ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">generateKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, options);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * è®¾ç½®ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">generateKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, options);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // LRUæ·˜æ±°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache.size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.maxSize) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> firstKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().value;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(firstKey);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cache</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CompressionCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressWithCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. å°è¯•ä»ç¼“å­˜è·å–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cached</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, options);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (cached) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ç¼“å­˜å‘½ä¸­&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cached;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. æ‰§è¡Œå‹ç¼©</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressJpg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, options);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. å­˜å…¥ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, options, result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h4 id="_4-é”™è¯¯å¤„ç†" tabindex="-1">4. é”™è¯¯å¤„ç† <a class="header-anchor" href="#_4-é”™è¯¯å¤„ç†" aria-label="Permalink to &quot;4. é”™è¯¯å¤„ç†&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * å¥å£®çš„å‹ç¼©å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> robustCompress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">imageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1. å‚æ•°éªŒè¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">imageData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">imageData.data) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Invalid imageData&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (imageData.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imageData.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Invalid image dimensions&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2. å°ºå¯¸é™åˆ¶æ£€æŸ¥</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> maxPixels</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 25000000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 25MP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (imageData.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imageData.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxPixels) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Image too large&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 3. æ‰§è¡Œå‹ç¼©ï¼ˆå¸¦è¶…æ—¶ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> timeoutMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 30ç§’è¶…æ—¶</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">race</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            compressJpg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, options),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">_</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Compression timeout&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)), timeoutMs)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 4. ç»“æœéªŒè¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.byteLength </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Compression produced empty result&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Compression failed:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // é™çº§ç­–ç•¥ï¼šè¿”å›åŸå§‹å›¾åƒçš„Blob</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> canvas</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;canvas&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        canvas.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imageData.width;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        canvas.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> imageData.height;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> canvas.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2d&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">putImageData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            canvas.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toBlob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">blob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(blob.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">arrayBuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image/jpeg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><hr><h3 id="_7-4-æ€§èƒ½æµ‹è¯•ä¸ç›‘æ§" tabindex="-1">7.4 æ€§èƒ½æµ‹è¯•ä¸ç›‘æ§ <a class="header-anchor" href="#_7-4-æ€§èƒ½æµ‹è¯•ä¸ç›‘æ§" aria-label="Permalink to &quot;7.4 æ€§èƒ½æµ‹è¯•ä¸ç›‘æ§&quot;">â€‹</a></h3><h4 id="æ€§èƒ½æŒ‡æ ‡" tabindex="-1">æ€§èƒ½æŒ‡æ ‡ <a class="header-anchor" href="#æ€§èƒ½æŒ‡æ ‡" aria-label="Permalink to &quot;æ€§èƒ½æŒ‡æ ‡&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * å‹ç¼©æ€§èƒ½ç›‘æ§</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CompressionMetrics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.metrics </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> measure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> startTime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> performance.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> startMemory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> performance.memory?.usedJSHeapSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> endTime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> performance.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> endMemory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> performance.memory?.usedJSHeapSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> metric</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                name,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                duration: endTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> startTime,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                memoryDelta: endMemory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> startMemory,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                success: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.metrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(metric);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`[\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}] \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">metric</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">duration</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toFixed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}ms, Memory: \${</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">metric</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">memoryDelta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toFixed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}MB\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.metrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                name,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                error: error.message,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                success: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> error;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    getStats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> successMetrics</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.metrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">m</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.success);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            total: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.metrics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            success: successMetrics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            failed: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.metrics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> successMetrics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            avgDuration: successMetrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reduce</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.duration, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> successMetrics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            avgMemory: successMetrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reduce</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.memoryDelta, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> successMetrics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> metrics</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CompressionMetrics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> metrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">measure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;JPEG Compression&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compressJpg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageData, { quality: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">85</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;æ€§èƒ½ç»Ÿè®¡:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, metrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getStats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><hr><h2 id="å…«ã€æ€»ç»“ä¸å±•æœ›" tabindex="-1">å…«ã€æ€»ç»“ä¸å±•æœ› <a class="header-anchor" href="#å…«ã€æ€»ç»“ä¸å±•æœ›" aria-label="Permalink to &quot;å…«ã€æ€»ç»“ä¸å±•æœ›&quot;">â€‹</a></h2><h3 id="_8-1-æ ¸å¿ƒè¦ç‚¹å›é¡¾" tabindex="-1">8.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾ <a class="header-anchor" href="#_8-1-æ ¸å¿ƒè¦ç‚¹å›é¡¾" aria-label="Permalink to &quot;8.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾&quot;">â€‹</a></h3><p><strong>1. å›¾åƒåŸºç¡€</strong></p><ul><li>åƒç´  = RGBAå››ä¸ªé€šé“</li><li>æœªå‹ç¼©å¤§å° = å®½Ã—é«˜Ã—4å­—èŠ‚</li><li>YCbCré¢œè‰²ç©ºé—´æ›´é€‚åˆå‹ç¼©</li></ul><p><strong>2. JPEGå‹ç¼©ï¼ˆæœ‰æŸï¼‰</strong></p><ul><li>æ ¸å¿ƒï¼šDCTå˜æ¢ + é‡åŒ– + ç†µç¼–ç </li><li>å…³é”®ï¼šé‡åŒ–ä¸¢å¼ƒé«˜é¢‘ä¿¡æ¯</li><li>ä¼˜åŒ–ï¼šMozJPEGçš„Trellisç®—æ³•</li></ul><p><strong>3. PNGå‹ç¼©ï¼ˆæ— æŸï¼‰</strong></p><ul><li>æ ¸å¿ƒï¼šæ»¤æ³¢ + DEFLATEï¼ˆLZ77 + Huffmanï¼‰</li><li>å…³é”®ï¼šæ»¤æ³¢å¢å¼ºå¯å‹ç¼©æ€§</li><li>ä¼˜åŒ–ï¼šImageQuanté¢œè‰²é‡åŒ–</li></ul><p><strong>4. WebAssembly</strong></p><ul><li>æ€§èƒ½ï¼šæ¥è¿‘åŸç”Ÿé€Ÿåº¦ï¼ˆ10å€äºJSï¼‰</li><li>åº”ç”¨ï¼šMozJPEG C++ â†’ WASM</li><li>å…³é”®ï¼šEmscriptenç¼–è¯‘å’Œç»‘å®š</li></ul><p><strong>5. æœ€ä½³å®è·µ</strong></p><ul><li>æ ¼å¼é€‰æ‹©ï¼šç…§ç‰‡ç”¨JPEGï¼Œå›¾æ ‡ç”¨PNG</li><li>è´¨é‡å¹³è¡¡ï¼šWebæ¨è75-85</li><li>æ€§èƒ½ä¼˜åŒ–ï¼šWorkerå¹¶è¡Œã€ç¼“å­˜ã€æ¸è¿›åŠ è½½</li></ul><hr><h3 id="_8-2-å‹ç¼©æŠ€æœ¯å¯¹æ¯”" tabindex="-1">8.2 å‹ç¼©æŠ€æœ¯å¯¹æ¯” <a class="header-anchor" href="#_8-2-å‹ç¼©æŠ€æœ¯å¯¹æ¯”" aria-label="Permalink to &quot;8.2 å‹ç¼©æŠ€æœ¯å¯¹æ¯”&quot;">â€‹</a></h3><table tabindex="0"><thead><tr><th>æŠ€æœ¯</th><th>å‹ç¼©ç‡</th><th>é€Ÿåº¦</th><th>è´¨é‡æŸå¤±</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>JPEG (Baseline)</strong></td><td>10:1 ~ 30:1</td><td>å¿«</td><td>æœ‰æŸ</td><td>Webç…§ç‰‡</td></tr><tr><td><strong>JPEG (MozJPEG)</strong></td><td>12:1 ~ 40:1</td><td>ä¸­</td><td>æœ‰æŸï¼ˆæ›´ä¼˜ï¼‰</td><td>ä¼˜åŒ–åœºæ™¯</td></tr><tr><td><strong>PNG (æ ‡å‡†)</strong></td><td>3:1 ~ 10:1</td><td>ä¸­</td><td>æ— æŸ</td><td>å›¾æ ‡ã€æˆªå›¾</td></tr><tr><td><strong>PNG (ImageQuant)</strong></td><td>5:1 ~ 15:1</td><td>å¿«</td><td>è½»å¾®æœ‰æŸ</td><td>Webå›¾æ ‡</td></tr><tr><td><strong>WebP</strong></td><td>15:1 ~ 60:1</td><td>å¿«</td><td>å¯é€‰</td><td>ç°ä»£æµè§ˆå™¨</td></tr><tr><td><strong>AVIF</strong></td><td>20:1 ~ 80:1</td><td>æ…¢</td><td>å¯é€‰</td><td>æœªæ¥è¶‹åŠ¿</td></tr></tbody></table><hr><h3 id="_8-3-æœªæ¥å±•æœ›" tabindex="-1">8.3 æœªæ¥å±•æœ› <a class="header-anchor" href="#_8-3-æœªæ¥å±•æœ›" aria-label="Permalink to &quot;8.3 æœªæ¥å±•æœ›&quot;">â€‹</a></h3><p><strong>1. æ–°ä¸€ä»£æ ¼å¼</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>WebP (2010)   â†’ å¹¿æ³›æ”¯æŒ</span></span>
<span class="line"><span>HEIF/HEIC (2015) â†’ iOSä¸»æµ</span></span>
<span class="line"><span>AVIF (2019)   â†’ é€æ­¥æ™®åŠ â† åŸºäºAV1è§†é¢‘ç¼–ç </span></span>
<span class="line"><span>JPEG XL (2021) â†’ æ–°å…´æ ¼å¼ â† æ›´å¼ºçš„å‹ç¼©</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>2. AIå‹ç¼©</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ä¼ ç»Ÿå‹ç¼©ï¼šåŸºäºæ•°å­¦å˜æ¢ï¼ˆDCTã€å°æ³¢ï¼‰</span></span>
<span class="line"><span>AIå‹ç¼©ï¼š  ç¥ç»ç½‘ç»œå­¦ä¹ æœ€ä¼˜å‹ç¼©</span></span>
<span class="line"><span>         - ç”Ÿæˆå¯¹æŠ—ç½‘ç»œï¼ˆGANï¼‰</span></span>
<span class="line"><span>         - å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVAEï¼‰</span></span>
<span class="line"><span>         - è¶…åˆ†è¾¨ç‡é‡å»º</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>3. å®æ—¶å‹ç¼©</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç¡¬ä»¶åŠ é€Ÿï¼š</span></span>
<span class="line"><span>- GPU: WebGPU Compute Shader</span></span>
<span class="line"><span>- NPU: ç¥ç»ç½‘ç»œå¤„ç†å•å…ƒ</span></span>
<span class="line"><span>- ä¸“ç”¨èŠ¯ç‰‡: JPEGç¼–è§£ç å™¨</span></span>
<span class="line"><span></span></span>
<span class="line"><span>åº”ç”¨åœºæ™¯ï¼š</span></span>
<span class="line"><span>- å®æ—¶è§†é¢‘é€šè¯å‹ç¼©</span></span>
<span class="line"><span>- AR/VRå†…å®¹æµå¼ä¼ è¾“</span></span>
<span class="line"><span>- äº‘æ¸¸æˆç”»é¢å‹ç¼©</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>4. è‡ªé€‚åº”å‹ç¼©</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ï¼š</span></span>
<span class="line"><span>- 5G/WiFi â†’ é«˜è´¨é‡ï¼ˆè´¨é‡90ï¼‰</span></span>
<span class="line"><span>- 4G     â†’ ä¸­è´¨é‡ï¼ˆè´¨é‡75ï¼‰</span></span>
<span class="line"><span>- 3G     â†’ ä½è´¨é‡ï¼ˆè´¨é‡50ï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ ¹æ®è®¾å¤‡æ€§èƒ½è°ƒæ•´ï¼š</span></span>
<span class="line"><span>- é«˜ç«¯è®¾å¤‡ â†’ WebP/AVIF</span></span>
<span class="line"><span>- ä½ç«¯è®¾å¤‡ â†’ JPEG</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr><h3 id="_8-4-å‚è€ƒèµ„æº" tabindex="-1">8.4 å‚è€ƒèµ„æº <a class="header-anchor" href="#_8-4-å‚è€ƒèµ„æº" aria-label="Permalink to &quot;8.4 å‚è€ƒèµ„æº&quot;">â€‹</a></h3><p><strong>å­¦æœ¯è®ºæ–‡ï¼š</strong></p><ol><li>Wallace, G. K. (1992). &quot;The JPEG still picture compression standard&quot;</li><li>PNG Specification: ISO/IEC 15948:2003</li><li>MozJPEG: &quot;Optimal JPEG encoding with Trellis quantization&quot;</li></ol><p><strong>å¼€æºé¡¹ç›®ï¼š</strong></p><ol><li><strong>MozJPEG</strong>: <a href="https://github.com/mozilla/mozjpeg" target="_blank" rel="noreferrer">https://github.com/mozilla/mozjpeg</a></li><li><strong>ImageQuant</strong>: <a href="https://pngquant.org/" target="_blank" rel="noreferrer">https://pngquant.org/</a></li><li><strong>Squoosh</strong>: <a href="https://squoosh.app/" target="_blank" rel="noreferrer">https://squoosh.app/</a> (Google Webå‹ç¼©å·¥å…·)</li><li><strong>Sharp</strong>: <a href="https://sharp.pixelplumbing.com/" target="_blank" rel="noreferrer">https://sharp.pixelplumbing.com/</a> (Node.jså›¾åƒå¤„ç†)</li></ol><p><strong>åœ¨çº¿å·¥å…·ï¼š</strong></p><ol><li><strong>TinyPNG</strong>: <a href="https://tinypng.com/" target="_blank" rel="noreferrer">https://tinypng.com/</a> (åœ¨çº¿PNGå‹ç¼©)</li><li><strong>JPEG.rocks</strong>: <a href="https://jpeg.rocks/" target="_blank" rel="noreferrer">https://jpeg.rocks/</a> (åœ¨çº¿JPEGä¼˜åŒ–)</li><li><strong>Squoosh</strong>: <a href="https://squoosh.app/" target="_blank" rel="noreferrer">https://squoosh.app/</a> (å¯¹æ¯”å„ç§æ ¼å¼)</li></ol><p><strong>è§„èŒƒæ–‡æ¡£ï¼š</strong></p><ol><li>JPEGæ ‡å‡†: ITU-T T.81</li><li>PNGæ ‡å‡†: RFC 2083</li><li>WebPæ–‡æ¡£: <a href="https://developers.google.com/speed/webp" target="_blank" rel="noreferrer">https://developers.google.com/speed/webp</a></li><li>AVIFè§„èŒƒ: <a href="https://aomediacodec.github.io/av1-avif/" target="_blank" rel="noreferrer">https://aomediacodec.github.io/av1-avif/</a></li></ol><hr><p><strong>æ–‡æ¡£ç‰ˆæœ¬ï¼š</strong> v1.0<br><strong>æœ€åæ›´æ–°ï¼š</strong> 2026-01-26<br><strong>ä½œè€…ï¼š</strong> Meta Frontend Team<br><strong>å­—æ•°ç»Ÿè®¡ï¼š</strong> çº¦15,000å­—</p><hr><h2 id="é™„å½•a-å¸¸è§é—®é¢˜" tabindex="-1">é™„å½•Aï¼šå¸¸è§é—®é¢˜ <a class="header-anchor" href="#é™„å½•a-å¸¸è§é—®é¢˜" aria-label="Permalink to &quot;é™„å½•Aï¼šå¸¸è§é—®é¢˜&quot;">â€‹</a></h2><h3 id="q1-jpegå’Œpngå¦‚ä½•é€‰æ‹©" tabindex="-1">Q1: JPEGå’ŒPNGå¦‚ä½•é€‰æ‹©ï¼Ÿ <a class="header-anchor" href="#q1-jpegå’Œpngå¦‚ä½•é€‰æ‹©" aria-label="Permalink to &quot;Q1: JPEGå’ŒPNGå¦‚ä½•é€‰æ‹©ï¼Ÿ&quot;">â€‹</a></h3><p><strong>A:</strong></p><ul><li><strong>ç…§ç‰‡ã€è‡ªç„¶å›¾åƒ</strong> â†’ JPEGï¼ˆå‹ç¼©ç‡é«˜ï¼‰</li><li><strong>å›¾æ ‡ã€å¾½æ ‡ã€æˆªå›¾</strong> â†’ PNGï¼ˆè¾¹ç¼˜æ¸…æ™°ï¼‰</li><li><strong>éœ€è¦é€æ˜åº¦</strong> â†’ PNGæˆ–WebP</li><li><strong>è¿½æ±‚æœ€å°ä½“ç§¯ä¸”æµè§ˆå™¨æ”¯æŒ</strong> â†’ WebP</li></ul><h3 id="q2-jpegè´¨é‡è®¾ç½®å¤šå°‘åˆé€‚" tabindex="-1">Q2: JPEGè´¨é‡è®¾ç½®å¤šå°‘åˆé€‚ï¼Ÿ <a class="header-anchor" href="#q2-jpegè´¨é‡è®¾ç½®å¤šå°‘åˆé€‚" aria-label="Permalink to &quot;Q2: JPEGè´¨é‡è®¾ç½®å¤šå°‘åˆé€‚ï¼Ÿ&quot;">â€‹</a></h3><p><strong>A:</strong></p><ul><li><strong>Webä¸€èˆ¬åœºæ™¯</strong>: 75-85</li><li><strong>ç¼©ç•¥å›¾</strong>: 50-60</li><li><strong>é«˜è´¨é‡å±•ç¤º</strong>: 90-95</li><li><strong>ä¸å»ºè®®100</strong>: æ–‡ä»¶å·¨å¤§ä½†è§†è§‰æå‡ä¸æ˜æ˜¾</li></ul><h3 id="q3-ä¸ºä»€ä¹ˆå‹ç¼©åæ–‡ä»¶åè€Œå˜å¤§äº†" tabindex="-1">Q3: ä¸ºä»€ä¹ˆå‹ç¼©åæ–‡ä»¶åè€Œå˜å¤§äº†ï¼Ÿ <a class="header-anchor" href="#q3-ä¸ºä»€ä¹ˆå‹ç¼©åæ–‡ä»¶åè€Œå˜å¤§äº†" aria-label="Permalink to &quot;Q3: ä¸ºä»€ä¹ˆå‹ç¼©åæ–‡ä»¶åè€Œå˜å¤§äº†ï¼Ÿ&quot;">â€‹</a></h3><p><strong>A:</strong> å¯èƒ½çš„åŸå› ï¼š</p><ol><li><strong>åŸå›¾å·²ç»æ˜¯å‹ç¼©è¿‡çš„JPEG</strong>: å†å‹ç¼©ä¼šå¢åŠ å¼€é”€</li><li><strong>PNGè½¬JPEG</strong>: å¦‚æœåŸPNGå¾ˆå°ï¼ˆç®€å•å›¾åƒï¼‰ï¼ŒJPEGåè€Œå¤§</li><li><strong>è´¨é‡è®¾ç½®è¿‡é«˜</strong>: æ¥è¿‘æ— æŸï¼Œå¼€é”€å¤§</li></ol><h3 id="q4-webassemblyå‹ç¼©æ¯”çº¯jså¿«å¤šå°‘" tabindex="-1">Q4: WebAssemblyå‹ç¼©æ¯”çº¯JSå¿«å¤šå°‘ï¼Ÿ <a class="header-anchor" href="#q4-webassemblyå‹ç¼©æ¯”çº¯jså¿«å¤šå°‘" aria-label="Permalink to &quot;Q4: WebAssemblyå‹ç¼©æ¯”çº¯JSå¿«å¤šå°‘ï¼Ÿ&quot;">â€‹</a></h3><p><strong>A:</strong></p><ul><li><strong>å…¸å‹åœºæ™¯</strong>: 5-15å€</li><li><strong>å¤æ‚ç®—æ³•</strong>: å¯è¾¾20å€ä»¥ä¸Š</li><li><strong>ç®€å•æ“ä½œ</strong>: 2-3å€</li></ul><h3 id="q5-å¦‚ä½•åœ¨ä¸æŸå¤±è´¨é‡çš„æƒ…å†µä¸‹å‡å°æ–‡ä»¶" tabindex="-1">Q5: å¦‚ä½•åœ¨ä¸æŸå¤±è´¨é‡çš„æƒ…å†µä¸‹å‡å°æ–‡ä»¶ï¼Ÿ <a class="header-anchor" href="#q5-å¦‚ä½•åœ¨ä¸æŸå¤±è´¨é‡çš„æƒ…å†µä¸‹å‡å°æ–‡ä»¶" aria-label="Permalink to &quot;Q5: å¦‚ä½•åœ¨ä¸æŸå¤±è´¨é‡çš„æƒ…å†µä¸‹å‡å°æ–‡ä»¶ï¼Ÿ&quot;">â€‹</a></h3><p><strong>A:</strong></p><ol><li><strong>ä½¿ç”¨MozJPEGçš„Trellisä¼˜åŒ–</strong>: ç›¸åŒè´¨é‡ï¼Œæ–‡ä»¶å‡å°5-10%</li><li><strong>ä½¿ç”¨æ¸è¿›å¼JPEG</strong>: å‡å°5-10%ï¼Œä¸”åŠ è½½ä½“éªŒæ›´å¥½</li><li><strong>PNGä½¿ç”¨ImageQuant</strong>: é‡åŒ–åˆ°256è‰²ï¼Œè§†è§‰æŸå¤±æå°</li><li><strong>å‡çº§åˆ°WebP/AVIF</strong>: æ–°æ ¼å¼å‹ç¼©æ•ˆç‡æ›´é«˜</li></ol><hr><p><strong>å®Œ</strong></p>`,730)]))}const g=a(l,[["render",e]]);export{c as __pageData,g as default};
