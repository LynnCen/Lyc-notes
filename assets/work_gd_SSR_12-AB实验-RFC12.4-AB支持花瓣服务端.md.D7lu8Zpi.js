import{_ as a,c as n,o as i,a7 as p}from"./chunks/framework.BQb8NfN9.js";const l="/Lyc-notes/assets/image2025-6-20_14-12-29.Dk_rRP-o.png",e="/Lyc-notes/assets/image2025-6-20_14-12-44.DN0sDi7s.png",b=JSON.parse('{"title":"RFC 12.4: AB æ”¯æŒèŠ±ç“£æœåŠ¡ç«¯","description":"","frontmatter":{},"headers":[],"relativePath":"work/gd/SSR/12-ABå®éªŒ-RFC12.4-ABæ”¯æŒèŠ±ç“£æœåŠ¡ç«¯.md","filePath":"work/gd/SSR/12-ABå®éªŒ-RFC12.4-ABæ”¯æŒèŠ±ç“£æœåŠ¡ç«¯.md","lastUpdated":1770089359000}'),t={name:"work/gd/SSR/12-ABå®éªŒ-RFC12.4-ABæ”¯æŒèŠ±ç“£æœåŠ¡ç«¯.md"};function h(r,s,k,d,E,c){return i(),n("div",null,s[0]||(s[0]=[p(`<h1 id="rfc-12-4-ab-æ”¯æŒèŠ±ç“£æœåŠ¡ç«¯" tabindex="-1">RFC 12.4: AB æ”¯æŒèŠ±ç“£æœåŠ¡ç«¯ <a class="header-anchor" href="#rfc-12-4-ab-æ”¯æŒèŠ±ç“£æœåŠ¡ç«¯" aria-label="Permalink to &quot;RFC 12.4: AB æ”¯æŒèŠ±ç“£æœåŠ¡ç«¯&quot;">â€‹</a></h1><blockquote><p><strong>æ–‡æ¡£æ¥æº</strong><br> Confluence: <a href="https://doc.huanleguang.com/pages/viewpage.action?pageId=459746960" target="_blank" rel="noreferrer">https://doc.huanleguang.com/pages/viewpage.action?pageId=459746960</a></p></blockquote><hr><h2 id="æ–‡æ¡£æ¦‚è¿°" tabindex="-1">æ–‡æ¡£æ¦‚è¿° <a class="header-anchor" href="#æ–‡æ¡£æ¦‚è¿°" aria-label="Permalink to &quot;æ–‡æ¡£æ¦‚è¿°&quot;">â€‹</a></h2><p>æœ¬ RFC æå‡ºäº† <strong>@gaoding/gd-abtest SDK æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰</strong> çš„æ–¹æ¡ˆï¼Œç‰¹åˆ«é’ˆå¯¹<strong>èŠ±ç“£é¡¹ç›®</strong>ï¼ˆåŸºäº Next.jsï¼‰çš„æ¶æ„ç‰¹ç‚¹ã€‚</p><p><strong>æ ¸å¿ƒç›®æ ‡</strong>ï¼š</p><ul><li>ğŸ¯ AB SDK æ”¯æŒ SSR ç¯å¢ƒ</li><li>ğŸš« æ¶ˆé™¤é¡µé¢é—ªçƒé—®é¢˜</li><li>âš¡ ä¿æŒè‰¯å¥½çš„æ€§èƒ½è¡¨ç°</li><li>ğŸ”„ ç¡®ä¿ SSR å’Œ CSR ä¸€è‡´æ€§</li></ul><p><strong>ç›¸å…³æ–‡æ¡£</strong>ï¼š</p><ul><li>å‰ç½®ï¼š<a href="./09-ABå®éªŒ-RFC12.1-SSRåœºæ™¯ä¸‹çš„ABå®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›">RFC 12.1: AB å®éªŒä¸ç¼“å­˜ç­–ç•¥æ”¹è¿›</a></li><li>å‰ç½®ï¼š<a href="./10-ABå®éªŒ-RFC12.2-SSRåœºæ™¯ä¸‹çš„ABå®éªŒæ•°æ®è·å–ä¼˜åŒ–">RFC 12.2: AB å®éªŒæ•°æ®è·å–ä¼˜åŒ–</a></li><li>å‰ç½®ï¼š<a href="./11-ABå®éªŒ-RFC12.3-æé«˜ABç¼“å­˜å‘½ä¸­ç‡">RFC 12.3: æé«˜ AB ç¼“å­˜å‘½ä¸­ç‡</a></li></ul><hr><h2 id="ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜" tabindex="-1">ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜ <a class="header-anchor" href="#ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜" aria-label="Permalink to &quot;ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜&quot;">â€‹</a></h2><h3 id="_1-1-èŠ±ç“£é¡¹ç›®æ¶æ„" tabindex="-1">1.1 èŠ±ç“£é¡¹ç›®æ¶æ„ <a class="header-anchor" href="#_1-1-èŠ±ç“£é¡¹ç›®æ¶æ„" aria-label="Permalink to &quot;1.1 èŠ±ç“£é¡¹ç›®æ¶æ„&quot;">â€‹</a></h3><p><strong>æŠ€æœ¯æ ˆ</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>èŠ±ç“£é¡¹ç›®æ¶æ„</span></span>
<span class="line"><span>â”œâ”€â”€ Next.jsï¼ˆSSR æ¡†æ¶ï¼‰</span></span>
<span class="line"><span>â”œâ”€â”€ Reactï¼ˆUI æ¡†æ¶ï¼‰</span></span>
<span class="line"><span>â””â”€â”€ @gaoding/gd-abtestï¼ˆAB SDKï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>æ¶æ„ç‰¹ç‚¹</strong>ï¼š</p><table tabindex="0"><thead><tr><th>ç‰¹æ€§</th><th>ç¨¿å®šé¡¹ç›®</th><th>èŠ±ç“£é¡¹ç›®</th></tr></thead><tbody><tr><td><strong>SSR æ¡†æ¶</strong></td><td>Meta SSRï¼ˆè‡ªç ”ï¼‰</td><td>Next.jsï¼ˆå¼€æºï¼‰</td></tr><tr><td><strong>ä¸­é—´å±‚</strong></td><td>âœ… BFF + Worker</td><td>âŒ æ— ä¸­é—´å±‚</td></tr><tr><td><strong>AB é¢„è·å–</strong></td><td>âœ… Worker å±‚è·å–</td><td>âŒ æ— æ³•é¢„è·å–</td></tr><tr><td><strong>æ¶æ„å±‚çº§</strong></td><td>3 å±‚ï¼ˆWorkerâ†’BFFâ†’SSRï¼‰</td><td>1 å±‚ï¼ˆç›´æ¥ SSRï¼‰</td></tr></tbody></table><p><strong>æ¶æ„å¯¹æ¯”å›¾</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç¨¿å®šæ¶æ„ï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  ç”¨æˆ·    â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>     â”‚</span></span>
<span class="line"><span>     â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ Worker  â”‚ â† åœ¨è¿™é‡Œè·å– AB æ•°æ®</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>     â”‚</span></span>
<span class="line"><span>     â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  BFF    â”‚ â† ç¼“å­˜å¤„ç†</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>     â”‚</span></span>
<span class="line"><span>     â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  SSR    â”‚ â† ä½¿ç”¨ä¼ é€’çš„ AB æ•°æ®</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span></span></span>
<span class="line"><span>èŠ±ç“£æ¶æ„ï¼š</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚  ç”¨æˆ·    â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜</span></span>
<span class="line"><span>     â”‚</span></span>
<span class="line"><span>     â–¼</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class="line"><span>â”‚ Next.js â”‚ â† âŒ ç›´æ¥ SSRï¼Œæ— ä¸­é—´å±‚</span></span>
<span class="line"><span>â”‚  SSR    â”‚</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="_1-2-ç°æœ‰é—®é¢˜" tabindex="-1">1.2 ç°æœ‰é—®é¢˜ <a class="header-anchor" href="#_1-2-ç°æœ‰é—®é¢˜" aria-label="Permalink to &quot;1.2 ç°æœ‰é—®é¢˜&quot;">â€‹</a></h3><h4 id="é—®é¢˜-é¡µé¢é—ªçƒ" tabindex="-1">é—®é¢˜ï¼šé¡µé¢é—ªçƒ <a class="header-anchor" href="#é—®é¢˜-é¡µé¢é—ªçƒ" aria-label="Permalink to &quot;é—®é¢˜ï¼šé¡µé¢é—ªçƒ&quot;">â€‹</a></h4><p><strong>ç°è±¡</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šæœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>@gaoding/gd-abtest ä¸æ”¯æŒ SSR</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>è¿”å›é»˜è®¤ç‰ˆæœ¬çš„é¡µé¢ï¼ˆæ—  ABï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šæµè§ˆå™¨æ¥æ”¶ HTML</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ˜¾ç¤ºé»˜è®¤ç‰ˆæœ¬</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šå®¢æˆ·ç«¯ JS æ‰§è¡Œ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>@gaoding/gd-abtest è·å– AB æ•°æ®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ç”¨æˆ·å‘½ä¸­å®éªŒç»„</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 4ï¼šé¡µé¢é‡æ–°æ¸²æŸ“</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ä»é»˜è®¤ç‰ˆæœ¬ â†’ å®éªŒç‰ˆæœ¬</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>âŒ é¡µé¢é—ªçƒ/è·³å˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>æˆªå›¾å¯¹æ¯”</strong>ï¼š</p><table tabindex="0"><thead><tr><th>æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆé»˜è®¤ç‰ˆæœ¬ï¼‰</th><th>å®¢æˆ·ç«¯æ‰§è¡Œ AB åï¼ˆå®éªŒç‰ˆæœ¬ï¼‰</th></tr></thead><tbody><tr><td><img src="`+l+'" alt="æœåŠ¡ç«¯æ¸²æŸ“"></td><td><img src="'+e+`" alt="å®¢æˆ·ç«¯AB"></td></tr></tbody></table><p><strong>å½±å“</strong>ï¼š</p><ul><li>ğŸ”´ <strong>ç”¨æˆ·ä½“éªŒå·®</strong>ï¼šé¡µé¢åŠ è½½åå‡ºç°æ˜æ˜¾é—ªçƒ</li><li>ğŸ”´ <strong>è§†è§‰è·³å˜</strong>ï¼šå¸ƒå±€ã€é¢œè‰²ã€å†…å®¹çªç„¶æ”¹å˜</li><li>ğŸ”´ <strong>å°¤ä¸ºçªå‡º</strong>ï¼šåœ¨æ¡†æ¶æ”¹ç‰ˆç­‰å¤§èŒƒå›´å®éªŒä¸­</li></ul><h4 id="æ ¹æœ¬åŸå› " tabindex="-1">æ ¹æœ¬åŸå›  <a class="header-anchor" href="#æ ¹æœ¬åŸå› " aria-label="Permalink to &quot;æ ¹æœ¬åŸå› &quot;">â€‹</a></h4><p><strong>@gaoding/gd-abtest SDK è®¾è®¡</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å½“å‰ SDK åªæ”¯æŒæµè§ˆå™¨ç¯å¢ƒ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;undefined&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æœåŠ¡ç«¯ç¯å¢ƒï¼ŒSDK æ— æ³•å·¥ä½œ âŒ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;AB SDK only works in browser&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åªèƒ½åœ¨å®¢æˆ·ç«¯è·å– AB æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/ab-experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>é™åˆ¶</strong>ï¼š</p><ul><li>âŒ æ— æ³•åœ¨ SSR é˜¶æ®µè·å– AB æ•°æ®</li><li>âŒ æ— æ³•åœ¨ SSR é˜¶æ®µåº”ç”¨ AB ç­–ç•¥</li><li>âŒ SSR å’Œ CSR ç»“æœä¸ä¸€è‡´</li></ul><h3 id="_1-3-ä¸ºä»€ä¹ˆä¸èƒ½å¤ç”¨ç¨¿å®šæ–¹æ¡ˆ" tabindex="-1">1.3 ä¸ºä»€ä¹ˆä¸èƒ½å¤ç”¨ç¨¿å®šæ–¹æ¡ˆ <a class="header-anchor" href="#_1-3-ä¸ºä»€ä¹ˆä¸èƒ½å¤ç”¨ç¨¿å®šæ–¹æ¡ˆ" aria-label="Permalink to &quot;1.3 ä¸ºä»€ä¹ˆä¸èƒ½å¤ç”¨ç¨¿å®šæ–¹æ¡ˆ&quot;">â€‹</a></h3><p><strong>ç¨¿å®šæ–¹æ¡ˆè¦æ±‚</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. Worker å±‚ï¼šé¢„å…ˆè·å– AB æ•°æ®</span></span>
<span class="line"><span>2. BFF å±‚ï¼šä¼ é€’ AB æ•°æ®åˆ° SSR</span></span>
<span class="line"><span>3. SSR å±‚ï¼šä» Header æˆ– Redis è¯»å– AB æ•°æ®</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>èŠ±ç“£é¡¹ç›®ç¼ºå¤±</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>âŒ æ—  Worker å±‚</span></span>
<span class="line"><span>âŒ æ—  BFF å±‚</span></span>
<span class="line"><span>âŒ æ— ä¸­é—´å±‚ä¼ é€’æœºåˆ¶</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>ç»“è®º</strong>ï¼šéœ€è¦ä¸ºèŠ±ç“£é¡¹ç›®è®¾è®¡æ–°çš„æ–¹æ¡ˆ</p><hr><h2 id="äºŒã€æè®®å†…å®¹" tabindex="-1">äºŒã€æè®®å†…å®¹ <a class="header-anchor" href="#äºŒã€æè®®å†…å®¹" aria-label="Permalink to &quot;äºŒã€æè®®å†…å®¹&quot;">â€‹</a></h2><h3 id="_2-1-æ ¸å¿ƒæè®®" tabindex="-1">2.1 æ ¸å¿ƒæè®® <a class="header-anchor" href="#_2-1-æ ¸å¿ƒæè®®" aria-label="Permalink to &quot;2.1 æ ¸å¿ƒæè®®&quot;">â€‹</a></h3><p><strong>æè®® 1ï¼šAB SDK æ”¯æŒ SSR</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>@gaoding/gd-abtest SDK æä¾›æœåŠ¡ç«¯æ¸²æŸ“æ”¯æŒ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>ç¡®ä¿å¼€å‘ä½“éªŒå’Œå®¢æˆ·ç«¯ä½¿ç”¨ä¸€è‡´</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>åœ¨ SSR ç¯å¢ƒä¸­ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>æè®® 2ï¼šç¡®ä¿æ¸²æŸ“ä¸€è‡´æ€§</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SSR å’Œ CSR çœ‹åˆ°ç›¸åŒçš„ AB å®éªŒç»“æœ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>é¿å… hydration mismatch æŠ¥é”™</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ¶ˆé™¤é¡µé¢é—ªçƒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_2-2-æ–¹æ¡ˆç›®æ ‡" tabindex="-1">2.2 æ–¹æ¡ˆç›®æ ‡ <a class="header-anchor" href="#_2-2-æ–¹æ¡ˆç›®æ ‡" aria-label="Permalink to &quot;2.2 æ–¹æ¡ˆç›®æ ‡&quot;">â€‹</a></h3><table tabindex="0"><thead><tr><th>ç»´åº¦</th><th>ç›®æ ‡</th></tr></thead><tbody><tr><td><strong>åŠŸèƒ½</strong></td><td>âœ… AB SDK åœ¨ SSR ä¸­æ­£å¸¸å·¥ä½œ</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>âœ… TTFB å¢åŠ  &lt; 50ms (P95)</td></tr><tr><td><strong>ä½“éªŒ</strong></td><td>âœ… æ— é¡µé¢é—ªçƒ</td></tr><tr><td><strong>å…¼å®¹</strong></td><td>âœ… æ”¯æŒ Next.js å’Œå…¶ä»– SSR æ¡†æ¶</td></tr><tr><td><strong>å¼€å‘</strong></td><td>âœ… æœ€å°åŒ–ä¸šåŠ¡ä»£ç æ”¹åŠ¨</td></tr></tbody></table><hr><h2 id="ä¸‰ã€è¯¦ç»†è®¾è®¡" tabindex="-1">ä¸‰ã€è¯¦ç»†è®¾è®¡ <a class="header-anchor" href="#ä¸‰ã€è¯¦ç»†è®¾è®¡" aria-label="Permalink to &quot;ä¸‰ã€è¯¦ç»†è®¾è®¡&quot;">â€‹</a></h2><h3 id="_3-1-ab-ç­–ç•¥è·å–" tabindex="-1">3.1 AB ç­–ç•¥è·å– <a class="header-anchor" href="#_3-1-ab-ç­–ç•¥è·å–" aria-label="Permalink to &quot;3.1 AB ç­–ç•¥è·å–&quot;">â€‹</a></h3><h4 id="è°ƒæ•´æ–¹å‘" tabindex="-1">è°ƒæ•´æ–¹å‘ <a class="header-anchor" href="#è°ƒæ•´æ–¹å‘" aria-label="Permalink to &quot;è°ƒæ•´æ–¹å‘&quot;">â€‹</a></h4><p><strong>å½“å‰</strong>ï¼šå®¢æˆ·ç«¯è·å–</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®¢æˆ·ç«¯æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useEffect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/ab-experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  setABData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, []);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>è°ƒæ•´ä¸º</strong>ï¼šæœåŠ¡ç«¯è·å–</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æœåŠ¡ç«¯æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getServerSideProps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context.req);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { props: { abData } };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="è·å–ç­–ç•¥" tabindex="-1">è·å–ç­–ç•¥ <a class="header-anchor" href="#è·å–ç­–ç•¥" aria-label="Permalink to &quot;è·å–ç­–ç•¥&quot;">â€‹</a></h4><p><strong>ç­–ç•¥ 1ï¼šRedis ä¼˜å…ˆ</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šæ£€æŸ¥ Cookie ä¸­çš„ ab-test-id</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å­˜åœ¨ ab-test-id</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šä» Redis è·å–ç¼“å­˜çš„ AB æ•°æ®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>å‘½ä¸­ç¼“å­˜ â†’ è¿”å›æ•°æ®</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æœªå‘½ä¸­ â†’ æ­¥éª¤ 3</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šæ¥å£è·å–ï¼ˆé™çº§ï¼‰</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>å®ç°ä»£ç </strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// AB æ•°æ®è·å–ï¼ˆæœåŠ¡ç«¯ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> axios </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;axios&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./redis-client&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æ­¥éª¤ 1ï¼šæ£€æŸ¥ Cookie</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.cookies[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (abTestId) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ­¥éª¤ 2ï¼šå°è¯•ä» Redis è·å–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cached</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">abTestId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (cached) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cached);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Redis get failed&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æ­¥éª¤ 3ï¼šæ¥å£è·å–ï¼ˆé™çº§ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> axios.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://ab-service.com/experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      headers: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;X-User-Id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-user-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;X-Device-Id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;x-device-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;User-Agent&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: req.headers[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user-agent&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      timeout: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 300ms è¶…æ—¶</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response.data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç”Ÿæˆ ab-test-id å¹¶ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newAbTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> md5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">newAbTestId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ›´æ–° Cookieï¼ˆåœ¨å“åº”ä¸­è®¾ç½®ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, newAbTestId, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      maxAge: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1800</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 30 åˆ†é’Ÿ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      httpOnly: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abData;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;AB service failed&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¿”å›ç©ºå¯¹è±¡ï¼ˆé™çº§ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="æŠ€æœ¯é€‰æ‹©-axios" tabindex="-1">æŠ€æœ¯é€‰æ‹©ï¼šaxios <a class="header-anchor" href="#æŠ€æœ¯é€‰æ‹©-axios" aria-label="Permalink to &quot;æŠ€æœ¯é€‰æ‹©ï¼šaxios&quot;">â€‹</a></h4><p><strong>ä¸ºä»€ä¹ˆé€‰æ‹© axios</strong>ï¼š</p><table tabindex="0"><thead><tr><th>ç‰¹æ€§</th><th>axios</th><th>node-fetch</th><th>å†…ç½® fetch</th></tr></thead><tbody><tr><td><strong>SSR æ”¯æŒ</strong></td><td>âœ… åŸç”Ÿæ”¯æŒ</td><td>âœ… éœ€å®‰è£…</td><td>âŒ Node 18+</td></tr><tr><td><strong>CSR æ”¯æŒ</strong></td><td>âœ… åŸç”Ÿæ”¯æŒ</td><td>âŒ ä»… SSR</td><td>âœ… åŸç”Ÿæ”¯æŒ</td></tr><tr><td><strong>ç¨¿å®šå·²ä½¿ç”¨</strong></td><td>âœ… æ˜¯</td><td>âŒ å¦</td><td>âŒ å¦</td></tr><tr><td><strong>èŠ±ç“£å·²ä½¿ç”¨</strong></td><td>âœ… æ˜¯</td><td>âŒ å¦</td><td>âŒ å¦</td></tr></tbody></table><p><strong>ä¾èµ–å£°æ˜</strong>ï¼ˆpeerDependenciesï¼‰ï¼š</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;@gaoding/gd-abtest&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;peerDependencies&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;axios&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^0.27.0 || ^1.0.0&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>å¥½å¤„</strong>ï¼š</p><ul><li>âœ… é¿å… SDK å†…ç½® axios ç‰ˆæœ¬å†²çª</li><li>âœ… ä¸šåŠ¡è‡ªè¡Œæ§åˆ¶ axios ç‰ˆæœ¬</li><li>âœ… å‡å°‘ bundle ä½“ç§¯</li></ul><h3 id="_3-2-æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ¸²æŸ“ä¸€è‡´æ€§" tabindex="-1">3.2 æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ¸²æŸ“ä¸€è‡´æ€§ <a class="header-anchor" href="#_3-2-æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ¸²æŸ“ä¸€è‡´æ€§" aria-label="Permalink to &quot;3.2 æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ¸²æŸ“ä¸€è‡´æ€§&quot;">â€‹</a></h3><h4 id="æ ¸å¿ƒåŸåˆ™" tabindex="-1">æ ¸å¿ƒåŸåˆ™ <a class="header-anchor" href="#æ ¸å¿ƒåŸåˆ™" aria-label="Permalink to &quot;æ ¸å¿ƒåŸåˆ™&quot;">â€‹</a></h4><blockquote><p><strong>å¿…é¡»ç¡®ä¿ SSR å’Œ CSR çœ‹åˆ°å®Œå…¨ä¸€è‡´çš„å†…å®¹</strong></p></blockquote><p><strong>å¦åˆ™ä¼šå‡ºç°</strong>ï¼š</p><ul><li>âŒ Hydration mismatch æŠ¥é”™</li><li>âŒ é¡µé¢é—ªçƒ</li><li>âŒ ç”¨æˆ·ä½“éªŒå·®</li></ul><h4 id="æ–¹æ¡ˆ-a-next-js-åº”ç”¨-æ¨è-â­" tabindex="-1">æ–¹æ¡ˆ Aï¼šNext.js åº”ç”¨ï¼ˆæ¨èï¼‰â­ <a class="header-anchor" href="#æ–¹æ¡ˆ-a-next-js-åº”ç”¨-æ¨è-â­" aria-label="Permalink to &quot;æ–¹æ¡ˆ Aï¼šNext.js åº”ç”¨ï¼ˆæ¨èï¼‰â­&quot;">â€‹</a></h4><p><strong>Next.js çš„å†…ç½®æœºåˆ¶</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SSR é˜¶æ®µï¼š</span></span>
<span class="line"><span>   1. getServerSideProps è·å–æ•°æ®</span></span>
<span class="line"><span>   2. æ•°æ®æ³¨å…¥åˆ° props</span></span>
<span class="line"><span>   3. æ¸²æŸ“ HTML</span></span>
<span class="line"><span>   4. å°†æ•°æ®åºåˆ—åŒ–åˆ° &lt;script id=&quot;__NEXT_DATA__&quot;&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CSR é˜¶æ®µï¼š</span></span>
<span class="line"><span>   1. ä» __NEXT_DATA__ è¯»å–æ•°æ®</span></span>
<span class="line"><span>   2. æ¢å¤é¡µé¢çŠ¶æ€</span></span>
<span class="line"><span>   3. hydrationï¼ˆæ— éœ€é‡æ–°è¯·æ±‚ï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç»“æœï¼šâœ… å®Œå…¨ä¸€è‡´</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>å®ç°ä»£ç </strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// pages/index.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { gdABTest } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@gaoding/gd-abtest&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getServerSideProps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æœåŠ¡ç«¯è·å– AB æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context.req);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    props: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      abData </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼ é€’ç»™ç»„ä»¶</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HomePage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">abData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // åˆå§‹åŒ– AB SDK</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ab</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ä½¿ç”¨ AB å®éªŒ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> showNewLayout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ab.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;homepage_layout&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;variant_b&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {showNewLayout </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NewLayout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OldLayout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>æ•°æ®æµ</strong>ï¼š</p><div class="language-html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;!</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">DOCTYPE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;__NEXT_DATA__&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;application/json&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &quot;props&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        &quot;pageProps&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          &quot;abData&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            &quot;homepage_layout&quot;: &quot;variant_b&quot;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            &quot;template_list&quot;: &quot;variant_a&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  &lt;!-- å·²åº”ç”¨ AB çš„å†…å®¹ --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">NewLayout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- variant_b --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>å®¢æˆ·ç«¯ hydration</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®¢æˆ·ç«¯æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Next.js è‡ªåŠ¨ä» __NEXT_DATA__ è¯»å– props</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.__NEXT_DATA__.props.pageProps.abData;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// AB SDK ä½¿ç”¨ç›¸åŒçš„æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ab</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… ç»“æœå®Œå…¨ä¸€è‡´ï¼Œæ— é—ªçƒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="æ–¹æ¡ˆ-b-é-next-js-åº”ç”¨" tabindex="-1">æ–¹æ¡ˆ Bï¼šé Next.js åº”ç”¨ <a class="header-anchor" href="#æ–¹æ¡ˆ-b-é-next-js-åº”ç”¨" aria-label="Permalink to &quot;æ–¹æ¡ˆ Bï¼šé Next.js åº”ç”¨&quot;">â€‹</a></h4><p><strong>å¯¹äºç¨¿å®šæ¡†æ¶ï¼ˆ@web-widgetï¼‰</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨ @web-widget/helpers/cache</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { cacheProvider } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@web-widget/helpers/cache&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æœåŠ¡ç«¯è·å–å¹¶ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cacheProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ab-experiments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®¾ç½®åˆ° AB SDK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨ä»ç¼“å­˜è·å–</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… ä¿æŒä¸€è‡´</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>å¯¹äºå…¶ä»–æ¡†æ¶</strong>ï¼š</p><p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼šå°† AB æ•°æ®æ³¨å…¥åˆ° HTML</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æœåŠ¡ç«¯æ¸²æŸ“</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &lt;!DOCTYPE html&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &lt;html&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &lt;head&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;script&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      window.__AB_DATA__ = \${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">abData</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">};</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;/script&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &lt;/head&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &lt;body&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &lt;!-- é¡µé¢å†…å®¹ --&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &lt;/body&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &lt;/html&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(html);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>å®¢æˆ·ç«¯ä½¿ç”¨</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®¢æˆ·ç«¯åˆå§‹åŒ–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.__AB_DATA__ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… ä½¿ç”¨æœåŠ¡ç«¯ä¼ é€’çš„æ•°æ®</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="sdk-api-è®¾è®¡" tabindex="-1">SDK API è®¾è®¡ <a class="header-anchor" href="#sdk-api-è®¾è®¡" aria-label="Permalink to &quot;SDK API è®¾è®¡&quot;">â€‹</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// @gaoding/gd-abtest SDK</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ABTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.experiments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è®¾ç½®å®éªŒæ•°æ®ï¼ˆSSR ä¼ é€’ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">experiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.experiments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> experiments;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è·å–å®éªŒæ•°æ®ï¼ˆç”¨äºä¼ é€’ç»™ setExpsï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.experiments;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // è·å–å•ä¸ªå®éªŒç»“æœ</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.experiments[name];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æ£€æŸ¥æ˜¯å¦å‘½ä¸­å®éªŒ</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  isInExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">variant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.experiments[name] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> variant;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> gdABTest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ABTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SSR é˜¶æ®µ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getABExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> layout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;homepage_layout&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// CSR é˜¶æ®µ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(window.__NEXT_DATA__.props.pageProps.abData);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… å®Œå…¨ä¸€è‡´</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-3-ç¼“å­˜ç›¸å…³" tabindex="-1">3.3 ç¼“å­˜ç›¸å…³ <a class="header-anchor" href="#_3-3-ç¼“å­˜ç›¸å…³" aria-label="Permalink to &quot;3.3 ç¼“å­˜ç›¸å…³&quot;">â€‹</a></h3><h4 id="é¡µé¢ç¼“å­˜" tabindex="-1">é¡µé¢ç¼“å­˜ <a class="header-anchor" href="#é¡µé¢ç¼“å­˜" aria-label="Permalink to &quot;é¡µé¢ç¼“å­˜&quot;">â€‹</a></h4><p><strong>ç›®æ ‡</strong>ï¼šä¸ºæœªæ¥çš„é¡µé¢ç¼“å­˜åšå‡†å¤‡</p><p><strong>ab-test-id ç”Ÿæˆ</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç”Ÿæˆ ab-test-id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">abData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // å¯¹ AB æ•°æ®è¿›è¡Œ MD5</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> md5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®¾ç½® Cookie</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">res.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">generateABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData), {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  maxAge: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1800</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 30 åˆ†é’Ÿ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  httpOnly: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  secure: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  sameSite: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;lax&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>Cache Key è®¾è®¡</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æœªæ¥çš„é¡µé¢ç¼“å­˜ Key</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getPageCacheKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">abTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> abTestId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸åŒ AB ç»„ï¼Œä¸åŒç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// url=/home, ab-test-id=abc123 â†’ cacheKey1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// url=/home, ab-test-id=def456 â†’ cacheKey2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="ab-ç­–ç•¥ç¼“å­˜" tabindex="-1">AB ç­–ç•¥ç¼“å­˜ <a class="header-anchor" href="#ab-ç­–ç•¥ç¼“å­˜" aria-label="Permalink to &quot;AB ç­–ç•¥ç¼“å­˜&quot;">â€‹</a></h4><p><strong>é—®é¢˜</strong>ï¼šæ¯æ¬¡ SSR éƒ½è¯·æ±‚ AB æ¥å£ï¼Œå½±å“ TTFB</p><p><strong>AB æ¥å£æ€§èƒ½</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å¹³å‡è€—æ—¶ï¼š100ms</span></span>
<span class="line"><span>P95 è€—æ—¶ï¼š200ms</span></span>
<span class="line"><span>P99 è€—æ—¶ï¼š500ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>å½±å“ï¼š</span></span>
<span class="line"><span>   TTFB å¢åŠ  100-500ms âŒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šRedis ç¼“å­˜</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šé¦–æ¬¡è¯·æ±‚</span></span>
<span class="line"><span>   â”œâ”€ è°ƒç”¨ AB æ¥å£ï¼ˆ100msï¼‰</span></span>
<span class="line"><span>   â”œâ”€ ç”Ÿæˆ ab-test-id</span></span>
<span class="line"><span>   â”œâ”€ ç¼“å­˜åˆ° Redisï¼ˆ30 åˆ†é’Ÿï¼‰</span></span>
<span class="line"><span>   â””â”€ è¿”å›æ•°æ®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šåç»­è¯·æ±‚ï¼ˆ30 åˆ†é’Ÿå†…ï¼‰</span></span>
<span class="line"><span>   â”œâ”€ ä» Redis è¯»å–ï¼ˆ&lt;5msï¼‰</span></span>
<span class="line"><span>   â””â”€ ç›´æ¥è¿”å› âœ…</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šç¼“å­˜è¿‡æœŸå</span></span>
<span class="line"><span>   â”œâ”€ é‡æ–°è¯·æ±‚ AB æ¥å£</span></span>
<span class="line"><span>   â””â”€ æ›´æ–°ç¼“å­˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>å®ç°ï¼ˆæ’ä»¶åŒ–ï¼‰</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// AB SDK æä¾›æ’ä»¶æ¥å£</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ABTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  setCachePlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">plugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cachePlugin </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plugin;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getExperimentsWithCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cachePlugin) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // æ— ç¼“å­˜æ’ä»¶ï¼Œç›´æ¥è¯·æ±‚</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä½¿ç”¨ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.cookies[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ab-test-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (abTestId) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cached</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cachePlugin.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abTestId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (cached) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cached;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æœªå‘½ä¸­ï¼Œè¯·æ±‚å¹¶ç¼“å­˜</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cachePlugin.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newId, data, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><strong>ä¸šåŠ¡æä¾›ç¼“å­˜å®ç°</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸šåŠ¡ä»£ç ï¼ˆèŠ±ç“£é¡¹ç›®ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ioredis&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> redis</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Redis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  host: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;redis.example.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6379</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç¼“å­˜æ’ä»¶</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> redisCachePlugin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ttl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ttl, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è®¾ç½®åˆ° AB SDK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setCachePlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redisCachePlugin);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>å¥½å¤„</strong>ï¼š</p><ul><li>âœ… AB SDK ä¸ä¾èµ–ç‰¹å®šç¼“å­˜å®ç°</li><li>âœ… ä¸šåŠ¡çµæ´»é€‰æ‹©ï¼ˆRedis / CDN / å†…å­˜ï¼‰</li><li>âœ… è§£è€¦è®¾è®¡</li></ul><h3 id="_3-4-ab-ç­–ç•¥åˆ·æ–°" tabindex="-1">3.4 AB ç­–ç•¥åˆ·æ–° <a class="header-anchor" href="#_3-4-ab-ç­–ç•¥åˆ·æ–°" aria-label="Permalink to &quot;3.4 AB ç­–ç•¥åˆ·æ–°&quot;">â€‹</a></h3><h4 id="è§¦å‘æ—¶æœº" tabindex="-1">è§¦å‘æ—¶æœº <a class="header-anchor" href="#è§¦å‘æ—¶æœº" aria-label="Permalink to &quot;è§¦å‘æ—¶æœº&quot;">â€‹</a></h4><p><strong>æ—¶æœº 1ï¼šç™»å½•çŠ¶æ€å˜åŒ–</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç”¨æˆ·æœªç™»å½• â†’ ç”¨æˆ·ç™»å½•</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>setAttributes({ userId: &#39;12345&#39;, orgId: &#39;67890&#39; })</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>è§¦å‘ AB ç­–ç•¥é‡æ–°è·å–</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ›´æ–° ab-test-id</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>åŸå› </strong>ï¼š</p><ul><li>æœ‰äº›å®éªŒåŸºäº userId æˆ– orgId</li><li>ç™»å½•å‰ååº”è¯¥çœ‹åˆ°ä¸åŒçš„å®éªŒç»“æœ</li></ul><p><strong>æ—¶æœº 2ï¼šå®šæ—¶åˆ·æ–°ï¼ˆå®¢æˆ·ç«¯ï¼‰</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ¯ 10 åˆ†é’Ÿï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨åˆ·æ–°</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>é‡æ–°è·å– AB ç­–ç•¥</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ›´æ–° ab-test-id Cookie</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ›´æ–° Redis ç¼“å­˜</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>åŸå› </strong>ï¼š</p><ul><li>ç¼“è§£æœåŠ¡ç«¯ç›´æ¥è¯·æ±‚ AB æ¥å£çš„å‹åŠ›</li><li>ä¿æŒç¼“å­˜ç›¸å¯¹æ–°é²œ</li></ul><h4 id="å®ç°" tabindex="-1">å®ç° <a class="header-anchor" href="#å®ç°" aria-label="Permalink to &quot;å®ç°&quot;">â€‹</a></h4><p><strong>ç™»å½•çŠ¶æ€å˜åŒ–</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// AB SDK</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ABTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setAttributes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">attributes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.attributes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.attributes, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">attributes };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ£€æŸ¥å…³é”®å±æ€§å˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> keyChanged</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> attributes.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> attributes.orgId;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (keyChanged) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // é‡æ–°è·å– AB ç­–ç•¥</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newExperiments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newExperiments);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // æ›´æ–° ab-test-id Cookie</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newAbTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newExperiments);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      document.cookie </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`ab-test-id=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">newAbTestId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}; max-age=1800; path=/\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸šåŠ¡ä»£ç </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç”¨æˆ·ç™»å½•å</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setAttributes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  userId: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;12345&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  orgId: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;67890&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>å®šæ—¶åˆ·æ–°</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®¢æˆ·ç«¯å®šæ—¶åˆ·æ–°</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // é‡æ–°è·å– AB ç­–ç•¥</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newExperiments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ›´æ–°æœ¬åœ°æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newExperiments);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ›´æ–° ab-test-id Cookie</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newAbTestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateABTestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newExperiments);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    document.cookie </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`ab-test-id=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">newAbTestId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}; max-age=1800; path=/\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ABç­–ç•¥å·²åˆ·æ–°&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ABç­–ç•¥åˆ·æ–°å¤±è´¥&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 10 åˆ†é’Ÿ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>å¥½å¤„</strong>ï¼š</p><ul><li>âœ… æœåŠ¡ç«¯å¯ä»¥æ›´å¤šåœ°ä½¿ç”¨ç¼“å­˜</li><li>âœ… å‡å°‘ AB æ¥å£å‹åŠ›</li><li>âœ… ä¿æŒæ•°æ®ç›¸å¯¹æ–°é²œ</li></ul><hr><h2 id="å››ã€éœ€è¦è®¨è®ºçš„é—®é¢˜" tabindex="-1">å››ã€éœ€è¦è®¨è®ºçš„é—®é¢˜ <a class="header-anchor" href="#å››ã€éœ€è¦è®¨è®ºçš„é—®é¢˜" aria-label="Permalink to &quot;å››ã€éœ€è¦è®¨è®ºçš„é—®é¢˜&quot;">â€‹</a></h2><h3 id="_4-1-é—®é¢˜-1-å½±å“æœåŠ¡ç«¯æ€§èƒ½" tabindex="-1">4.1 é—®é¢˜ 1ï¼šå½±å“æœåŠ¡ç«¯æ€§èƒ½ <a class="header-anchor" href="#_4-1-é—®é¢˜-1-å½±å“æœåŠ¡ç«¯æ€§èƒ½" aria-label="Permalink to &quot;4.1 é—®é¢˜ 1ï¼šå½±å“æœåŠ¡ç«¯æ€§èƒ½&quot;">â€‹</a></h3><p><strong>é—®é¢˜æè¿°</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å³ä½¿æœ‰ Redis ç¼“å­˜ï¼Œä½†åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä»éœ€è¯·æ±‚ AB æ¥å£ï¼š</span></span>
<span class="line"><span>   1. é¦–æ¬¡è®¿é—®ï¼ˆæ—  ab-test-idï¼‰</span></span>
<span class="line"><span>   2. ab-test-id è¿‡æœŸ</span></span>
<span class="line"><span>   3. Redis æœªå‘½ä¸­</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ¯æ¬¡ AB æ¥å£è°ƒç”¨ï¼š</span></span>
<span class="line"><span>   - å¹³å‡è€—æ—¶ï¼š100ms</span></span>
<span class="line"><span>   - P95 è€—æ—¶ï¼š200ms</span></span>
<span class="line"><span>   - P99 è€—æ—¶ï¼š500ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>å½±å“ï¼šTTFB å¢åŠ  100-500ms âŒ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>æ•°æ®å¯¹æ¯”</strong>ï¼š</p><table tabindex="0"><thead><tr><th>åœºæ™¯</th><th>TTFB (æ— AB)</th><th>TTFB (æœ‰AB)</th><th>å¢åŠ </th></tr></thead><tbody><tr><td><strong>ç¼“å­˜å‘½ä¸­</strong></td><td>300ms</td><td>305ms</td><td>+5ms âœ…</td></tr><tr><td><strong>ç¼“å­˜æœªå‘½ä¸­</strong></td><td>300ms</td><td>400ms</td><td>+100ms âš ï¸</td></tr><tr><td><strong>æ¥å£æ…¢</strong></td><td>300ms</td><td>800ms</td><td>+500ms ğŸ”´</td></tr></tbody></table><p><strong>è®¨è®ºç‚¹</strong>ï¼š</p><ol><li><p><strong>æ˜¯å¦å¯æ¥å—</strong>ï¼Ÿ</p><ul><li>âœ… ç¼“å­˜å‘½ä¸­æ—¶å½±å“å¾ˆå°ï¼ˆ+5msï¼‰</li><li>âš ï¸ ç¼“å­˜æœªå‘½ä¸­æ—¶æœ‰å½±å“ï¼ˆ+100msï¼‰</li><li>ğŸ”´ æ¥å£æ…¢æ—¶å½±å“å¤§ï¼ˆ+500msï¼‰</li></ul></li><li><p><strong>å¦‚ä½•ä¼˜åŒ–</strong>ï¼Ÿ</p><ul><li>æ–¹æ¡ˆ Aï¼šæé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼ˆå»¶é•¿TTLï¼‰</li><li>æ–¹æ¡ˆ Bï¼šAB æ¥å£æ€§èƒ½ä¼˜åŒ–</li><li>æ–¹æ¡ˆ Cï¼šæ¥å—æ€§èƒ½æŸå¤±ï¼ˆæ¢å–ä½“éªŒï¼‰</li></ul></li></ol><p><strong>å»ºè®®</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ä¼˜å…ˆçº§ 1ï¼šæé«˜ç¼“å­˜å‘½ä¸­ç‡</span></span>
<span class="line"><span>   - ab-test-id TTL: 30åˆ†é’Ÿ â†’ 60åˆ†é’Ÿ</span></span>
<span class="line"><span>   - å®¢æˆ·ç«¯å®šæ—¶åˆ·æ–°ï¼š10åˆ†é’Ÿ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ä¼˜å…ˆçº§ 2ï¼šAB æ¥å£æ€§èƒ½ä¼˜åŒ–</span></span>
<span class="line"><span>   - å¢åŠ è¶…æ—¶æ§åˆ¶ï¼ˆ300msï¼‰</span></span>
<span class="line"><span>   - é™çº§ç­–ç•¥ï¼ˆè¶…æ—¶è¿”å›ç©ºï¼‰</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ä¼˜å…ˆçº§ 3ï¼šç›‘æ§å’Œå‘Šè­¦</span></span>
<span class="line"><span>   - ç›‘æ§ AB æ¥å£è€—æ—¶</span></span>
<span class="line"><span>   - å‘Šè­¦é˜ˆå€¼ï¼šP95 &gt; 200ms</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_4-2-é—®é¢˜-2-stale-while-revalidate-ç­–ç•¥" tabindex="-1">4.2 é—®é¢˜ 2ï¼šstale-while-revalidate ç­–ç•¥ <a class="header-anchor" href="#_4-2-é—®é¢˜-2-stale-while-revalidate-ç­–ç•¥" aria-label="Permalink to &quot;4.2 é—®é¢˜ 2ï¼šstale-while-revalidate ç­–ç•¥&quot;">â€‹</a></h3><p><strong>é—®é¢˜æè¿°</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>å½“å‰ç­–ç•¥ï¼š</span></span>
<span class="line"><span>   ab-test-id è¿‡æœŸ â†’ è¯·æ±‚ AB æ¥å£ â†’ ç­‰å¾…å“åº” â†’ æ¸²æŸ“é¡µé¢</span></span>
<span class="line"><span>   </span></span>
<span class="line"><span>   é—®é¢˜ï¼šå¢åŠ  TTFB</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>stale-while-revalidate ç­–ç•¥</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>æ­¥éª¤ 1ï¼šab-test-id è¿‡æœŸ</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ­¥éª¤ 2ï¼šSSR ä½¿ç”¨æ—§çš„ï¼ˆstaleï¼‰AB ç­–ç•¥</span></span>
<span class="line"><span>   â”œâ”€ ç«‹å³æ¸²æŸ“ï¼Œä¸ç­‰å¾… AB æ¥å£</span></span>
<span class="line"><span>   â””â”€ TTFB ä¸å—å½±å“ âœ…</span></span>
<span class="line"><span></span></span>
<span class="line"><span>æ­¥éª¤ 3ï¼šCSR å¼‚æ­¥æ£€æŸ¥æ–° AB ç­–ç•¥</span></span>
<span class="line"><span>   â”œâ”€ åå°è¯·æ±‚ AB æ¥å£</span></span>
<span class="line"><span>   â”œâ”€ æ›´æ–°ç¼“å­˜</span></span>
<span class="line"><span>   â””â”€ ä¸‹æ¬¡è®¿é—®ä½¿ç”¨æ–°ç­–ç•¥</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>æµç¨‹å›¾</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ç”¨æˆ·è¯·æ±‚</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>æ£€æŸ¥ ab-test-id</span></span>
<span class="line"><span>   â”œâ”€ æ–°é²œï¼ˆ&lt;30åˆ†é’Ÿï¼‰</span></span>
<span class="line"><span>   â”‚    â†“</span></span>
<span class="line"><span>   â”‚  ç›´æ¥ä½¿ç”¨ âœ…</span></span>
<span class="line"><span>   â”‚</span></span>
<span class="line"><span>   â””â”€ è¿‡æœŸï¼ˆ&gt;30åˆ†é’Ÿï¼Œ&lt;7å¤©ï¼‰</span></span>
<span class="line"><span>        â†“</span></span>
<span class="line"><span>      SSR: ä½¿ç”¨æ—§ç­–ç•¥æ¸²æŸ“</span></span>
<span class="line"><span>        â†“</span></span>
<span class="line"><span>      è¿”å›é¡µé¢ï¼ˆå¿«é€Ÿï¼‰âœ…</span></span>
<span class="line"><span>        â†“</span></span>
<span class="line"><span>      CSR: åå°æ›´æ–°ç­–ç•¥</span></span>
<span class="line"><span>        â†“</span></span>
<span class="line"><span>      ä¸‹æ¬¡è®¿é—®ä½¿ç”¨æ–°ç­–ç•¥</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>âœ… TTFB ä¸å— AB æ¥å£å½±å“</li><li>âœ… æ€§èƒ½ç¨³å®š</li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li>âŒ AB ç»“æœå»¶è¿Ÿæ›´æ–°</li><li>âŒ å¯èƒ½ä½¿ç”¨è¿‡æœŸçš„å®éªŒé…ç½®</li></ul><p><strong>è®¨è®ºç‚¹</strong>ï¼š</p><ol><li><p><strong>æ˜¯å¦å¯æ¥å—</strong>ï¼Ÿ</p><ul><li>å–å†³äºå®éªŒçš„æ—¶æ•ˆæ€§è¦æ±‚</li><li>ä¸€èˆ¬å®éªŒï¼šå¯æ¥å—</li><li>ç´§æ€¥å®éªŒï¼šä¸å¯æ¥å—</li></ul></li><li><p><strong>å¦‚ä½•å¹³è¡¡</strong>ï¼Ÿ</p><ul><li>æ–¹æ¡ˆ Aï¼šé»˜è®¤ä½¿ç”¨ï¼Œç‰¹æ®Šå®éªŒç¦ç”¨</li><li>æ–¹æ¡ˆ Bï¼šå®éªŒçº§åˆ«é…ç½®</li><li>æ–¹æ¡ˆ Cï¼šä¸ä½¿ç”¨ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰</li></ul></li></ol><p><strong>å»ºè®®</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>é˜¶æ®µ 1ï¼šä¸ä½¿ç”¨ stale-while-revalidate</span></span>
<span class="line"><span>   - ä¼˜å…ˆä¿è¯å®éªŒæ—¶æ•ˆæ€§</span></span>
<span class="line"><span>   - è§‚å¯Ÿæ€§èƒ½å½±å“</span></span>
<span class="line"><span></span></span>
<span class="line"><span>é˜¶æ®µ 2ï¼šå¦‚æœæ€§èƒ½é—®é¢˜ä¸¥é‡ï¼Œå†è€ƒè™‘å¯ç”¨</span></span>
<span class="line"><span>   - ä»…å¯¹éå…³é”®å®éªŒå¯ç”¨</span></span>
<span class="line"><span>   - å…³é”®å®éªŒå¼ºåˆ¶åˆ·æ–°</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_4-3-é—®é¢˜-3-é¡µé¢ä½“ç§¯å˜å¤§" tabindex="-1">4.3 é—®é¢˜ 3ï¼šé¡µé¢ä½“ç§¯å˜å¤§ <a class="header-anchor" href="#_4-3-é—®é¢˜-3-é¡µé¢ä½“ç§¯å˜å¤§" aria-label="Permalink to &quot;4.3 é—®é¢˜ 3ï¼šé¡µé¢ä½“ç§¯å˜å¤§&quot;">â€‹</a></h3><p><strong>é—®é¢˜æè¿°</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>AB ç­–ç•¥ä¿¡æ¯æ³¨å…¥åˆ° HTMLï¼š</span></span>
<span class="line"><span>   &lt;script id=&quot;__NEXT_DATA__&quot;&gt;</span></span>
<span class="line"><span>     { &quot;abData&quot;: { ... } }</span></span>
<span class="line"><span>   &lt;/script&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>é—®é¢˜ï¼šHTML ä½“ç§¯å¢å¤§</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>æ•°æ®ä¼°ç®—</strong>ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å‡è®¾ 10 ä¸ªå®éªŒ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;homepage_layout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;template_list&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;editor_toolbar&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variant_c&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... 7 ä¸ªå®éªŒ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// JSON åºåˆ—åŒ–</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¤§å°ï¼šçº¦ 300-500 å­—èŠ‚</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åŠ ä¸Šæ ‡ç­¾</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`&lt;script id=&quot;__NEXT_DATA__&quot;&gt;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">json</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&lt;/script&gt;\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¤§å°ï¼šçº¦ 350-600 å­—èŠ‚</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>å½±å“åˆ†æ</strong>ï¼š</p><table tabindex="0"><thead><tr><th>é¡µé¢å¤§å°</th><th>AB æ•°æ®</th><th>å¢åŠ æ¯”ä¾‹</th></tr></thead><tbody><tr><td>50 KB</td><td>500 B</td><td>+1%</td></tr><tr><td>100 KB</td><td>500 B</td><td>+0.5%</td></tr><tr><td>200 KB</td><td>500 B</td><td>+0.25%</td></tr></tbody></table><p><strong>ç»“è®º</strong>ï¼š</p><ul><li>âœ… ç»å¯¹å¢åŠ ï¼š300-500 å­—èŠ‚</li><li>âœ… ç›¸å¯¹å¢åŠ ï¼š&lt; 1%</li><li>âœ… å½±å“å¾®ä¹å…¶å¾®</li></ul><p><strong>ä¼˜åŒ–å»ºè®®</strong>ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1. å‹ç¼©å­—æ®µå</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;h_layout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// homepage_layout: variant_b</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;t_list&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // template_list: variant_a</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2. ä½¿ç”¨æ•°ç»„ä»£æ›¿å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;c&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æŒ‰å›ºå®šé¡ºåº</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3. Base64 ç¼–ç ï¼ˆå‡å°‘ç‰¹æ®Šå­—ç¬¦ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> encoded</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> btoa</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>å»ºè®®</strong>ï¼š</p><ul><li>ğŸ¯ <strong>ä¸ä¼˜åŒ–</strong>ï¼šå½±å“å¤ªå°ï¼Œä¸å€¼å¾—å¢åŠ å¤æ‚åº¦</li><li>âš ï¸ <strong>å¿…è¦æ—¶ä¼˜åŒ–</strong>ï¼šå¦‚æœå®éªŒæ•°é‡ &gt; 50 ä¸ª</li></ul><hr><h2 id="äº”ã€å®æ–½æ–¹æ¡ˆ" tabindex="-1">äº”ã€å®æ–½æ–¹æ¡ˆ <a class="header-anchor" href="#äº”ã€å®æ–½æ–¹æ¡ˆ" aria-label="Permalink to &quot;äº”ã€å®æ–½æ–¹æ¡ˆ&quot;">â€‹</a></h2><h3 id="_5-1-sdk-æ”¹é€ " tabindex="-1">5.1 SDK æ”¹é€  <a class="header-anchor" href="#_5-1-sdk-æ”¹é€ " aria-label="Permalink to &quot;5.1 SDK æ”¹é€ &quot;">â€‹</a></h3><p><strong>ä»»åŠ¡æ¸…å•</strong>ï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. âœ… å¢åŠ  SSR æ”¯æŒ</span></span>
<span class="line"><span>   - æ£€æµ‹ SSR ç¯å¢ƒ</span></span>
<span class="line"><span>   - axios è¯·æ±‚é€‚é…</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. âœ… API è°ƒæ•´</span></span>
<span class="line"><span>   - setExps() æ–¹æ³•</span></span>
<span class="line"><span>   - getExps() æ–¹æ³•</span></span>
<span class="line"><span>   - getExperiment() æ–¹æ³•</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. âœ… ç¼“å­˜æ’ä»¶æ¥å£</span></span>
<span class="line"><span>   - setCachePlugin() æ–¹æ³•</span></span>
<span class="line"><span>   - get/set æ ‡å‡†æ¥å£</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. âœ… ç™»å½•æ€åˆ·æ–°</span></span>
<span class="line"><span>   - setAttributes() æ–¹æ³•</span></span>
<span class="line"><span>   - è‡ªåŠ¨è§¦å‘åˆ·æ–°</span></span>
<span class="line"><span></span></span>
<span class="line"><span>5. âœ… å®šæ—¶åˆ·æ–°ï¼ˆå®¢æˆ·ç«¯ï¼‰</span></span>
<span class="line"><span>   - æ¯ 10 åˆ†é’Ÿåˆ·æ–°</span></span>
<span class="line"><span>   - å¯é…ç½®</span></span>
<span class="line"><span></span></span>
<span class="line"><span>6. âœ… é”™è¯¯å¤„ç†å’Œé™çº§</span></span>
<span class="line"><span>   - è¶…æ—¶æ§åˆ¶</span></span>
<span class="line"><span>   - é™çº§ç­–ç•¥</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_5-2-èŠ±ç“£é¡¹ç›®æ¥å…¥" tabindex="-1">5.2 èŠ±ç“£é¡¹ç›®æ¥å…¥ <a class="header-anchor" href="#_5-2-èŠ±ç“£é¡¹ç›®æ¥å…¥" aria-label="Permalink to &quot;5.2 èŠ±ç“£é¡¹ç›®æ¥å…¥&quot;">â€‹</a></h3><p><strong>æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> @gaoding/gd-abtest@latest</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> axios</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ioredis</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>æ­¥éª¤ 2ï¼šé…ç½® Redis</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lib/redis.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ioredis&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> redis</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Redis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  host: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REDIS_HOST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  port: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REDIS_PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  password: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REDIS_PASSWORD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>æ­¥éª¤ 3ï¼šé…ç½® AB SDK</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lib/ab-test.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { gdABTest } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@gaoding/gd-abtest&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { redis } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./redis&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é…ç½®ç¼“å­˜æ’ä»¶</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setCachePlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ttl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`ab:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ttl, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { gdABTest };</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>æ­¥éª¤ 4ï¼šåœ¨é¡µé¢ä¸­ä½¿ç”¨</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// pages/index.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { gdABTest } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;../lib/ab-test&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getServerSideProps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // æœåŠ¡ç«¯è·å– AB æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> abData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getExperimentsWithCache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context.req);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    props: { abData }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HomePage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">abData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // åˆå§‹åŒ– AB SDK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setExps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(abData);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ä½¿ç”¨å®éªŒ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> showNewLayout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getExperiment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;homepage_layout&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;variant_b&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {showNewLayout </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NewHomePage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OldHomePage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><strong>æ­¥éª¤ 5ï¼šå®¢æˆ·ç«¯åˆ·æ–°</strong></p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// pages/_app.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { useEffect } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;react&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { gdABTest } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;../lib/ab-test&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyApp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Component</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pageProps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  useEffect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å®šæ—¶åˆ·æ–° AB ç­–ç•¥</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> interval</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gdABTest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">refreshExperiments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> clearInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(interval);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }, []);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Component</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pageProps} /&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_5-3-ç›‘æ§å’Œå‘Šè­¦" tabindex="-1">5.3 ç›‘æ§å’Œå‘Šè­¦ <a class="header-anchor" href="#_5-3-ç›‘æ§å’Œå‘Šè­¦" aria-label="Permalink to &quot;5.3 ç›‘æ§å’Œå‘Šè­¦&quot;">â€‹</a></h3><p><strong>ç›‘æ§æŒ‡æ ‡</strong>ï¼š</p><table tabindex="0"><thead><tr><th>æŒ‡æ ‡</th><th>è¯´æ˜</th><th>ç›®æ ‡</th><th>å‘Šè­¦é˜ˆå€¼</th></tr></thead><tbody><tr><td><strong>AB æ¥å£è€—æ—¶</strong></td><td>P95 å“åº”æ—¶é—´</td><td>â‰¤ 200ms</td><td>&gt; 300ms</td></tr><tr><td><strong>Redis å‘½ä¸­ç‡</strong></td><td>ç¼“å­˜å‘½ä¸­ç‡</td><td>â‰¥ 90%</td><td>&lt; 80%</td></tr><tr><td><strong>TTFB å½±å“</strong></td><td>SSR TTFB å¢åŠ </td><td>â‰¤ 50ms</td><td>&gt; 100ms</td></tr><tr><td><strong>é”™è¯¯ç‡</strong></td><td>AB è·å–å¤±è´¥ç‡</td><td>&lt; 1%</td><td>&gt; 5%</td></tr></tbody></table><hr><h2 id="å…­ã€æ€»ç»“" tabindex="-1">å…­ã€æ€»ç»“ <a class="header-anchor" href="#å…­ã€æ€»ç»“" aria-label="Permalink to &quot;å…­ã€æ€»ç»“&quot;">â€‹</a></h2><h3 id="_6-1-æ–¹æ¡ˆä»·å€¼" tabindex="-1">6.1 æ–¹æ¡ˆä»·å€¼ <a class="header-anchor" href="#_6-1-æ–¹æ¡ˆä»·å€¼" aria-label="Permalink to &quot;6.1 æ–¹æ¡ˆä»·å€¼&quot;">â€‹</a></h3><p><strong>è§£å†³çš„é—®é¢˜</strong>ï¼š</p><ol><li><p>âœ… <strong>é¡µé¢é—ªçƒ</strong></p><ul><li>SSR å’Œ CSR å®Œå…¨ä¸€è‡´</li><li>ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡</li></ul></li><li><p>âœ… <strong>SSR æ”¯æŒ</strong></p><ul><li>AB SDK åœ¨ SSR ä¸­æ­£å¸¸å·¥ä½œ</li><li>å¼€å‘ä½“éªŒä¸€è‡´</li></ul></li><li><p>âœ… <strong>æ€§èƒ½ä¼˜åŒ–</strong></p><ul><li>Redis ç¼“å­˜å‡å°‘ AB æ¥å£è°ƒç”¨</li><li>TTFB å½±å“å¯æ§ï¼ˆ&lt; 50msï¼‰</li></ul></li><li><p>âœ… <strong>æ¶æ„é€‚é…</strong></p><ul><li>é€‚é…èŠ±ç“£ï¼ˆNext.jsï¼‰æ¶æ„</li><li>æ’ä»¶åŒ–è®¾è®¡ï¼Œçµæ´»æ‰©å±•</li></ul></li></ol><h3 id="_6-2-å…³é”®è¦ç‚¹" tabindex="-1">6.2 å…³é”®è¦ç‚¹ <a class="header-anchor" href="#_6-2-å…³é”®è¦ç‚¹" aria-label="Permalink to &quot;6.2 å…³é”®è¦ç‚¹&quot;">â€‹</a></h3><p><strong>æŠ€æœ¯è¦ç‚¹</strong>ï¼š</p><ol><li><p>âœ… <strong>SDK SSR æ”¯æŒ</strong></p><ul><li>axios ç»Ÿä¸€è¯·æ±‚</li><li>setExps/getExps API</li></ul></li><li><p>âœ… <strong>æ•°æ®ä¸€è‡´æ€§</strong></p><ul><li>Next.js <strong>NEXT_DATA</strong> æœºåˆ¶</li><li>å…¶ä»–æ¡†æ¶æ³¨å…¥ window.<strong>AB_DATA</strong></li></ul></li><li><p>âœ… <strong>ç¼“å­˜ç­–ç•¥</strong></p><ul><li>Redis ç¼“å­˜ AB æ•°æ®</li><li>ab-test-id ä½œä¸º Cache Key</li></ul></li><li><p>âœ… <strong>åˆ·æ–°æœºåˆ¶</strong></p><ul><li>ç™»å½•çŠ¶æ€å˜åŒ–è§¦å‘</li><li>å®¢æˆ·ç«¯å®šæ—¶åˆ·æ–°</li></ul></li></ol><h3 id="_6-3-å¾…è§£å†³é—®é¢˜" tabindex="-1">6.3 å¾…è§£å†³é—®é¢˜ <a class="header-anchor" href="#_6-3-å¾…è§£å†³é—®é¢˜" aria-label="Permalink to &quot;6.3 å¾…è§£å†³é—®é¢˜&quot;">â€‹</a></h3><p><strong>éœ€è¦å›¢é˜Ÿè®¨è®º</strong>ï¼š</p><ol><li><p>âš ï¸ <strong>æ€§èƒ½å½±å“çš„å¯æ¥å—åº¦</strong></p><ul><li>TTFB å¢åŠ  50-100ms</li><li>å¦‚ä½•ä¼˜åŒ–</li></ul></li><li><p>âš ï¸ <strong>æ˜¯å¦ä½¿ç”¨ stale-while-revalidate</strong></p><ul><li>æ€§èƒ½ vs æ—¶æ•ˆæ€§</li><li>å¦‚ä½•å¹³è¡¡</li></ul></li><li><p>âš ï¸ <strong>AB æ¥å£æ€§èƒ½ä¼˜åŒ–</strong></p><ul><li>æ˜¯å¦éœ€è¦ä¸“é¡¹ä¼˜åŒ–</li><li>ç›®æ ‡è€—æ—¶</li></ul></li></ol><h3 id="_6-4-ä¸‹ä¸€æ­¥" tabindex="-1">6.4 ä¸‹ä¸€æ­¥ <a class="header-anchor" href="#_6-4-ä¸‹ä¸€æ­¥" aria-label="Permalink to &quot;6.4 ä¸‹ä¸€æ­¥&quot;">â€‹</a></h3><ol><li>âœ… SDK æ”¹é€ å’Œæµ‹è¯•</li><li>âœ… èŠ±ç“£é¡¹ç›®è¯•ç‚¹æ¥å…¥</li><li>âœ… ç›‘æ§æ•°æ®æ”¶é›†</li><li>âœ… æ ¹æ®æ•°æ®ä¼˜åŒ–æ–¹æ¡ˆ</li><li>âœ… æ¨å¹¿åˆ°å…¶ä»–é¡¹ç›®</li></ol><hr><p><strong>æ–‡æ¡£ç»´æŠ¤</strong>ï¼šå‰ç«¯åŸºå»ºå›¢é˜Ÿ<br><strong>RFC ä½œè€…</strong>ï¼šå‰ç«¯æ¶æ„ç»„<br><strong>æ•´ç†æ—¥æœŸ</strong>ï¼š2025-01-25<br><strong>æ–‡æ¡£ç‰ˆæœ¬</strong>ï¼šv1.0</p>`,201)]))}const y=a(t,[["render",h]]);export{b as __pageData,y as default};
