import{_ as k,C as E,c as d,o as n,a7 as p,b as e,j as r,w as a,a as i,G as t,a9 as h}from"./chunks/framework.BQb8NfN9.js";const A=JSON.parse('{"title":"稿定前端超级仓库 CI/CD 深度解析","description":"","frontmatter":{},"headers":[],"relativePath":"work/gd/稿定CICD/稿定前端CI-CD深度解析.md","filePath":"work/gd/稿定CICD/稿定前端CI-CD深度解析.md","lastUpdated":1770086731000}'),g={name:"work/gd/稿定CICD/稿定前端CI-CD深度解析.md"};function o(c,s,b,u,F,y){const l=E("Mermaid");return n(),d("div",null,[s[15]||(s[15]=p(`<h1 id="稿定前端超级仓库-ci-cd-深度解析" tabindex="-1">稿定前端超级仓库 CI/CD 深度解析 <a class="header-anchor" href="#稿定前端超级仓库-ci-cd-深度解析" aria-label="Permalink to &quot;稿定前端超级仓库 CI/CD 深度解析&quot;">​</a></h1><blockquote><p>作者:资深前端架构师、SRE专家<br> 日期:2026-01-16<br> 项目:稿定科技前端 Monorepo (@gdesign/monorepo-root)</p></blockquote><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ul><li><a href="#1-概述">1. 概述</a></li><li><a href="#2-cicd-架构设计">2. CI/CD 架构设计</a></li><li><a href="#3-核心技术栈">3. 核心技术栈</a></li><li><a href="#4-pipeline-流程详解">4. Pipeline 流程详解</a></li><li><a href="#5-自动化机器人系统">5. 自动化机器人系统</a></li><li><a href="#6-turbo-构建优化">6. Turbo 构建优化</a></li><li><a href="#7-changeset-版本管理">7. Changeset 版本管理</a></li><li><a href="#8-部署系统">8. 部署系统</a></li><li><a href="#9-最佳实践与优化">9. 最佳实践与优化</a></li></ul><hr><h2 id="_1-概述" tabindex="-1">1. 概述 <a class="header-anchor" href="#_1-概述" aria-label="Permalink to &quot;1. 概述&quot;">​</a></h2><h3 id="_1-1-ci-cd-核心价值" tabindex="-1">1.1 CI/CD 核心价值 <a class="header-anchor" href="#_1-1-ci-cd-核心价值" aria-label="Permalink to &quot;1.1 CI/CD 核心价值&quot;">​</a></h3><p>现代软件开发中，从代码提交到生产部署通常需要经历一系列标准化流程：</p><p><strong>传统手动流程的局限</strong>：</p><ol><li>代码质量检查依赖人工审查</li><li>测试执行需要手动触发和等待</li><li>构建打包过程繁琐且耗时</li><li>部署流程复杂，容易出现环境差异</li><li>回滚和故障恢复响应缓慢</li></ol><p><strong>CI/CD 自动化的价值</strong>：</p><ul><li><strong>持续集成 (CI)</strong>: 代码提交后自动触发构建、测试和质量检查，快速发现集成问题</li><li><strong>持续部署 (CD)</strong>: 通过验证的代码自动部署到目标环境，缩短交付周期</li></ul><p><strong>本质上</strong>，CI/CD 是将软件交付流程标准化、自动化，通过管道（Pipeline）机制编排各个环节，实现从代码到生产的高效流转。</p><h3 id="_1-2-项目背景" tabindex="-1">1.2 项目背景 <a class="header-anchor" href="#_1-2-项目背景" aria-label="Permalink to &quot;1.2 项目背景&quot;">​</a></h3><p>稿定科技前端超级仓库是一个基于 <strong>Monorepo</strong> 架构的大规模前端工程，整合了多个业务线的应用和共享基础设施。</p><p><strong>Monorepo 架构特点</strong>：</p><p>相比传统的多仓库（Multi-repo）模式，Monorepo 将所有相关项目集中在单一代码仓库中管理：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>多仓库模式的挑战:</span></span>
<span class="line"><span>├── 仓库A (独立版本控制)</span></span>
<span class="line"><span>├── 仓库B (独立版本控制)</span></span>
<span class="line"><span>└── 共享库仓库 (独立版本控制)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>问题:</span></span>
<span class="line"><span>- 代码复用需要跨仓库同步</span></span>
<span class="line"><span>- 依赖版本管理复杂</span></span>
<span class="line"><span>- 原子性变更困难（需要多个 PR）</span></span>
<span class="line"><span>- CI/CD 配置分散</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Monorepo 统一管理:</span></span>
<span class="line"><span>超级仓库/</span></span>
<span class="line"><span>├── apps/                    # 应用层</span></span>
<span class="line"><span>│   ├── gaoding/            # 稿定设计</span></span>
<span class="line"><span>│   ├── insmind/            # InsMind</span></span>
<span class="line"><span>│   └── open-platform/      # 开放平台</span></span>
<span class="line"><span>├── domains/                 # 领域层</span></span>
<span class="line"><span>│   ├── editor/             # 编辑器领域</span></span>
<span class="line"><span>│   └── commerce/           # 电商领域</span></span>
<span class="line"><span>└── packages/                # 基础设施层</span></span>
<span class="line"><span>    ├── ui/                 # UI 组件</span></span>
<span class="line"><span>    └── services/           # 服务层</span></span>
<span class="line"><span></span></span>
<span class="line"><span>优势:</span></span>
<span class="line"><span>- 统一的依赖管理和版本策略</span></span>
<span class="line"><span>- 原子性提交（一次 PR 可跨多个包）</span></span>
<span class="line"><span>- 共享 CI/CD 配置和工具链</span></span>
<span class="line"><span>- 更好的代码可见性和复用性</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>项目规模指标</strong>：</p><ul><li>文件总数: 15,000+</li><li>应用数量: 8+</li><li>共享包: 100+</li><li>代码量: 500,000+ 行</li></ul><h3 id="_1-3-ci-cd-设计驱动因素" tabindex="-1">1.3 CI/CD 设计驱动因素 <a class="header-anchor" href="#_1-3-ci-cd-设计驱动因素" aria-label="Permalink to &quot;1.3 CI/CD 设计驱动因素&quot;">​</a></h3><p>在 Monorepo 规模下，传统手动流程面临的挑战：</p><p><strong>手动流程的瓶颈</strong>：</p><ul><li>环境准备：手动搭建测试环境，耗时 15-20 分钟</li><li>构建验证：全量构建后发现问题，反馈周期长</li><li>依赖管理：跨包依赖变更需要人工协调</li><li>部署风险：手动操作容易引入环境差异</li><li><strong>结果</strong>：单次验证周期 &gt; 30 分钟，每日迭代次数 &lt; 5 次</li></ul><p><strong>自动化流程的效率提升</strong>：</p><ul><li>自动触发：代码提交即触发 Pipeline</li><li>增量构建：只构建变更的包及其依赖项</li><li>并行执行：多任务并发，缩短总耗时</li><li>环境一致：容器化确保环境可复现</li><li><strong>结果</strong>：单次验证周期 &lt; 5 分钟，支持高频迭代</li></ul>`,27)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-221",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5B%E6%8F%90%E9%AB%98%E6%95%88%E7%8E%87%5D%20--%3E%20B%5B%E8%87%AA%E5%8A%A8%E5%8C%96%3Cbr%2F%3E%E6%9C%BA%E5%99%A8%E4%BB%A3%E6%9B%BF%E4%BA%BA%E5%B7%A5%5D%0A%20%20%20%20A%20--%3E%20C%5B%E5%B9%B6%E8%A1%8C%E5%8C%96%3Cbr%2F%3E%E5%A4%9A%E4%B8%AA%E4%BB%BB%E5%8A%A1%E5%90%8C%E6%97%B6%E8%BF%9B%E8%A1%8C%5D%0A%20%20%20%20A%20--%3E%20D%5B%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%3Cbr%2F%3E%E9%81%BF%E5%85%8D%E9%87%8D%E5%A4%8D%E5%B7%A5%E4%BD%9C%5D%0A%0A%20%20%20%20E%5B%E4%BF%9D%E8%AF%81%E8%B4%A8%E9%87%8F%5D%20--%3E%20F%5B%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5%3Cbr%2F%3E%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E9%94%99%E8%AF%AF%5D%0A%20%20%20%20E%20--%3E%20G%5B%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%3Cbr%2F%3E%E7%A1%AE%E4%BF%9D%E5%8A%9F%E8%83%BD%E6%AD%A3%E5%B8%B8%5D%0A%20%20%20%20E%20--%3E%20H%5B%E9%83%A8%E7%BD%B2%E9%AA%8C%E8%AF%81%3Cbr%2F%3E%E4%B8%8A%E7%BA%BF%E5%89%8D%E6%9C%80%E5%90%8E%E6%A3%80%E6%9F%A5%5D%0A%0A%20%20%20%20I%5B%E9%99%8D%E4%BD%8E%E9%A3%8E%E9%99%A9%5D%20--%3E%20J%5B%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83%3Cbr%2F%3E%E9%80%90%E6%AD%A5%E6%94%BE%E9%87%8F%5D%0A%20%20%20%20I%20--%3E%20K%5B%E8%87%AA%E5%8A%A8%E5%9B%9E%E6%BB%9A%3Cbr%2F%3E%E5%87%BA%E9%97%AE%E9%A2%98%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D%5D%0A%20%20%20%20I%20--%3E%20L%5B%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB%3Cbr%2F%3E%E4%BA%92%E4%B8%8D%E5%BD%B1%E5%93%8D%5D%0A%0A%20%20%20%20style%20A%20fill%3A%23e1f5ff%0A%20%20%20%20style%20E%20fill%3A%23fff4e6%0A%20%20%20%20style%20I%20fill%3A%23ffe7e7%0A"})]),fallback:a(()=>s[0]||(s[0]=[i(" Loading... ")])),_:1})),s[16]||(s[16]=p(`<p><strong>核心设计原则</strong>:</p><p><strong>1. 自动化优先</strong></p><p>消除手动流程中的重复性工作和人为错误：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>手动流程:</span></span>
<span class="line"><span>代码提交 → 手动检查 → 手动测试 → 手动构建 → 手动部署</span></span>
<span class="line"><span>风险: 流程不一致、步骤遗漏、时间成本高</span></span>
<span class="line"><span></span></span>
<span class="line"><span>自动化流程:</span></span>
<span class="line"><span>代码提交 → Pipeline 自动编排 → 标准化流程 → 自动部署</span></span>
<span class="line"><span>优势: 流程标准化、可追溯、快速反馈</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>2. 增量构建</strong></p><p>利用缓存和依赖分析，避免不必要的重复构建：</p><ul><li><strong>全量构建策略</strong>：每次构建所有包，CI 耗时 15-20 分钟</li><li><strong>增量构建策略</strong>：基于文件变更和依赖图分析，只构建受影响的包，CI 耗时 3-5 分钟</li></ul><p>Turbo 通过内容哈希和依赖追踪实现智能缓存，显著提升构建效率。</p><p><strong>3. 并行执行</strong></p><p>充分利用 CI 资源，缩短总体执行时间：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>串行执行:</span></span>
<span class="line"><span>Task A (5min) → Task B (5min) → Task C (5min) = 15min</span></span>
<span class="line"><span></span></span>
<span class="line"><span>并行执行:</span></span>
<span class="line"><span>Task A (5min) ┐</span></span>
<span class="line"><span>Task B (5min) ├→ 并发执行 = 5min</span></span>
<span class="line"><span>Task C (5min) ┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Stage 内的独立 Job 可并行执行，最大化 CI 吞吐量。</p><p><strong>4. 环境一致性</strong></p><p>通过容器化技术确保构建和运行环境的可复现性：</p><p>常见的环境差异问题：</p><ul><li>Node.js 版本不一致</li><li>系统依赖缺失</li><li>环境变量配置差异</li></ul><p>Docker 容器化方案：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>构建镜像 = 测试环境 = 生产环境</span></span>
<span class="line"><span>（封装应用及其所有依赖，确保环境一致性）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>5. 可观测性</strong></p><p>完善的日志、监控和追踪机制：</p><ul><li><strong>Pipeline 可视化</strong>：实时查看执行进度和状态</li><li><strong>结构化日志</strong>：便于问题定位和审计</li><li><strong>性能指标</strong>：持续监控构建时间、缓存命中率等关键指标</li><li><strong>Artifacts 保留</strong>：保存构建产物和测试报告，支持问题复现</li></ul><h3 id="_1-4-技术选型" tabindex="-1">1.4 技术选型 <a class="header-anchor" href="#_1-4-技术选型" aria-label="Permalink to &quot;1.4 技术选型&quot;">​</a></h3><p>基于 Monorepo 的特性和项目规模，我们选择了以下技术栈：</p><p><strong>GitLab CI/CD - Pipeline 编排引擎</strong></p><p><strong>职责</strong>：</p><ul><li>CI/CD 流程的编排和执行</li><li>提供统一的 Runner 环境</li><li>管理 Artifacts 和缓存</li></ul><p><strong>选型原因</strong>：</p><ul><li>与 GitLab 代码仓库深度集成，单点登录</li><li>声明式配置（YAML），易于版本控制</li><li>内置 Artifacts、Cache、Registry 等基础设施</li><li>支持组件化配置（Component），便于复用</li></ul><p><strong>Turbo - Monorepo 构建编排工具</strong></p><p><strong>核心能力</strong>：</p><ul><li><strong>智能缓存</strong>：基于内容哈希的任务级缓存，避免重复构建</li><li><strong>增量构建</strong>：依赖图分析，只构建受影响的包</li><li><strong>并行执行</strong>：根据依赖关系自动并行化任务</li><li><strong>远程缓存</strong>：团队共享构建结果，加速 CI</li></ul><p><strong>性能对比</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>场景：修改登录模块代码</span></span>
<span class="line"><span></span></span>
<span class="line"><span>传统构建：全量重新构建所有包</span></span>
<span class="line"><span>- 耗时：10-15 分钟</span></span>
<span class="line"><span>- 构建包数：100+</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Turbo 增量构建：只构建受影响的包</span></span>
<span class="line"><span>- 耗时：1-2 分钟</span></span>
<span class="line"><span>- 构建包数：5-10</span></span>
<span class="line"><span>- 缓存命中率：85%+</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>pnpm - 高效的包管理器</strong></p><p><strong>技术特点</strong>：</p><ul><li><strong>内容寻址存储</strong>：全局 store 存储依赖，通过硬链接复用</li><li><strong>严格的依赖隔离</strong>：非扁平化 node_modules，避免幽灵依赖</li><li><strong>Workspace 支持</strong>：原生支持 Monorepo 管理</li></ul><p><strong>效率提升</strong>：</p><ul><li>磁盘占用减少 50%+（相比 npm/yarn）</li><li>安装速度提升 2-3 倍</li><li>支持 Catalog 功能，统一管理依赖版本</li></ul><p><strong>Changesets - 语义化版本管理</strong></p><p><strong>工作流</strong>：</p><ol><li>开发阶段：创建 changeset 文件，记录变更类型和描述</li><li>发布准备：自动分析 changesets，更新版本号和 CHANGELOG</li><li>发布执行：发布到 NPM Registry，创建 Git Tag</li></ol><p><strong>解决的问题</strong>：</p><ul><li>自动化版本管理，遵循语义化版本规范</li><li>自动生成 CHANGELOG，减少手动维护成本</li><li>支持 Monorepo 场景的依赖版本联动</li></ul><p><strong>Docker - 容器化运行时</strong></p><p><strong>价值</strong>：</p><ul><li>封装应用及其运行时依赖，确保环境一致性</li><li>通过镜像实现可复现的部署</li><li>利用分层缓存机制加速镜像构建</li></ul><p><strong>典型场景</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>问题：开发环境 Node 16，生产环境 Node 18，出现兼容性问题</span></span>
<span class="line"><span></span></span>
<span class="line"><span>解决：Docker 镜像锁定 Node 版本，所有环境使用同一镜像</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>OSS/CDN - 静态资源分发</strong></p><p><strong>架构</strong>：</p><ul><li><strong>OSS (对象存储)</strong>：持久化存储静态资源（HTML、JS、CSS、图片等）</li><li><strong>CDN (内容分发网络)</strong>：全球节点缓存，就近响应用户请求</li></ul><p><strong>性能优化</strong>：</p><ul><li>减轻源站压力，提升并发能力</li><li>降低访问延迟（边缘节点缓存）</li><li>支持 HTTPS、GZIP 压缩等优化特性</li></ul><p><strong>技术选型总结</strong>：</p><table tabindex="0"><thead><tr><th>技术</th><th>核心价值</th><th>关键指标</th></tr></thead><tbody><tr><td>GitLab CI/CD</td><td>流程编排和执行</td><td>Pipeline 耗时 &lt; 15min</td></tr><tr><td>Turbo</td><td>构建性能优化</td><td>缓存命中率 &gt; 80%</td></tr><tr><td>pnpm</td><td>依赖管理效率</td><td>安装速度提升 2-3x</td></tr><tr><td>Changesets</td><td>版本管理自动化</td><td>零人工干预发布</td></tr><tr><td>Docker</td><td>环境一致性保障</td><td>跨环境零差异</td></tr><tr><td>OSS/CDN</td><td>静态资源高性能分发</td><td>全球访问延迟 &lt; 100ms</td></tr></tbody></table><hr><h2 id="_2-ci-cd-架构设计-系统是如何工作的" tabindex="-1">2. CI/CD 架构设计（系统是如何工作的） <a class="header-anchor" href="#_2-ci-cd-架构设计-系统是如何工作的" aria-label="Permalink to &quot;2. CI/CD 架构设计（系统是如何工作的）&quot;">​</a></h2><h3 id="_2-1-整体架构" tabindex="-1">2.1 整体架构 <a class="header-anchor" href="#_2-1-整体架构" aria-label="Permalink to &quot;2.1 整体架构&quot;">​</a></h3><p>CI/CD 系统由代码仓库、Pipeline 编排、基础设施三部分组成，通过 GitLab CI/CD 实现端到端的自动化流程：</p><p><strong>架构分层</strong>：</p><ol><li><strong>代码仓库层</strong>：GitLab 托管源代码，触发 CI/CD 流程</li><li><strong>Pipeline 编排层</strong>：7 个 Stage 串行执行，每个 Stage 包含多个并行 Job</li><li><strong>基础设施层</strong>：提供镜像仓库、对象存储、CDN、容器编排等支撑服务</li></ol>`,61)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-674",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20subgraph%20%22%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93%22%0A%20%20%20%20%20%20%20%20A%5BGitLab%20Repository%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20%22CI%20Pipeline%20Stages%22%0A%20%20%20%20%20%20%20%20B%5BBot%20Stage%3Cbr%2F%3E%E8%87%AA%E5%8A%A8%E5%8C%96%E4%BB%BB%E5%8A%A1%5D%0A%20%20%20%20%20%20%20%20C%5BCheck%20Stage%3Cbr%2F%3E%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5%5D%0A%20%20%20%20%20%20%20%20D%5BTest%20Stage%3Cbr%2F%3E%E6%B5%8B%E8%AF%95%5D%0A%20%20%20%20%20%20%20%20E%5BChangeset%20Stage%3Cbr%2F%3E%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%5D%0A%20%20%20%20%20%20%20%20F%5BDeliverable%20Stage%3Cbr%2F%3E%E5%88%B6%E5%93%81%E7%94%9F%E6%88%90%5D%0A%20%20%20%20%20%20%20%20G%5BDeploy%20Stage%3Cbr%2F%3E%E9%83%A8%E7%BD%B2%5D%0A%20%20%20%20%20%20%20%20H%5BVerify%20Stage%3Cbr%2F%3E%E9%AA%8C%E8%AF%81%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20%22%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%22%0A%20%20%20%20%20%20%20%20I%5BDocker%20Registry%3Cbr%2F%3E%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%5D%0A%20%20%20%20%20%20%20%20J%5BOSS%20Storage%3Cbr%2F%3E%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%5D%0A%20%20%20%20%20%20%20%20K%5BCDN%20Network%3Cbr%2F%3E%E5%86%85%E5%AE%B9%E5%88%86%E5%8F%91%5D%0A%20%20%20%20%20%20%20%20L%5BK8s%20Cluster%3Cbr%2F%3E%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%5D%0A%20%20%20%20end%0A%0A%20%20%20%20A%20--%3E%7CPush%2FMR%7C%20B%0A%20%20%20%20B%20--%3E%20C%0A%20%20%20%20C%20--%3E%20D%0A%20%20%20%20D%20--%3E%20E%0A%20%20%20%20E%20--%3E%20F%0A%20%20%20%20F%20--%3E%20G%0A%20%20%20%20G%20--%3E%20H%0A%0A%20%20%20%20F%20-.-%3E%7CPush%20Image%7C%20I%0A%20%20%20%20F%20-.-%3E%7CUpload%20Assets%7C%20J%0A%20%20%20%20J%20-.-%3E%7CSync%7C%20K%0A%20%20%20%20G%20-.-%3E%7CDeploy%7C%20L%0A%0A%20%20%20%20style%20B%20fill%3A%23e3f2fd%0A%20%20%20%20style%20C%20fill%3A%23f3e5f5%0A%20%20%20%20style%20D%20fill%3A%23e8f5e9%0A%20%20%20%20style%20E%20fill%3A%23fff3e0%0A%20%20%20%20style%20F%20fill%3A%23fce4ec%0A%20%20%20%20style%20G%20fill%3A%23e0f2f1%0A%20%20%20%20style%20H%20fill%3A%23f1f8e9%0A"})]),fallback:a(()=>s[1]||(s[1]=[i(" Loading... ")])),_:1})),s[17]||(s[17]=p(`<h3 id="_2-2-pipeline-配置结构" tabindex="-1">2.2 Pipeline 配置结构 <a class="header-anchor" href="#_2-2-pipeline-配置结构" aria-label="Permalink to &quot;2.2 Pipeline 配置结构&quot;">​</a></h3><p>项目的 GitLab CI 配置采用<strong>组件化设计</strong>,主配置文件 <code>.gitlab-ci.yml</code> 非常简洁:</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># .gitlab-ci.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  inputs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    catalog_update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Run catalog update bot&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">boolean</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    merge_versions_mr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Run merge versions MR bot&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">boolean</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    packages_index_update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Run packages index update bot&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">boolean</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    editor_code_update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Run editor code update&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">boolean</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">include</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">component</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$CI_SERVER_FQDN/gdesign/monorepo-workflows/default@12</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    inputs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      create_gitlab_releases</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;false&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>关键设计</strong>:</p><ol><li><strong>输入参数化</strong>: 通过 <code>spec.inputs</code> 定义可配置的开关,支持灵活控制</li><li><strong>组件复用</strong>: 引入 <code>monorepo-workflows/default@12</code> 组件,封装通用流程</li><li><strong>版本管理</strong>: 通过 <code>@12</code> 指定组件版本,确保稳定性</li></ol><h3 id="_2-3-stage-设计" tabindex="-1">2.3 Stage 设计 <a class="header-anchor" href="#_2-3-stage-设计" aria-label="Permalink to &quot;2.3 Stage 设计&quot;">​</a></h3><p>Pipeline 由 7 个 Stage 组成，各 Stage 职责明确，串行执行以保证流程顺序性：</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># .gitlab-ci.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">stages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bot</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # 自动化维护任务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">check</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # 代码质量检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">test</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 自动化测试</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">changeset</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # 版本管理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">deliverable</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 制品生成</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">deploy</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 环境部署</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">verify</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 部署验证</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>各 Stage 职责详解</strong>：</p><p><strong>Bot Stage - 自动化维护</strong></p><p><strong>职责</strong>：定时或事件触发的自动化维护任务</p><ul><li>Catalog 依赖更新</li><li>Packages Index 文档生成</li><li>版本 MR 自动合并</li><li>编辑器代码同步</li></ul><p><strong>执行条件</strong>：通过 <code>spec.inputs</code> 和 <code>rules</code> 控制，支持定时触发和手动触发</p><p><strong>Check Stage - 静态分析</strong></p><p><strong>职责</strong>：代码质量门禁，确保代码符合规范</p><ul><li><strong>Lint 检查</strong>：ESLint、Stylelint、Prettier 等</li><li><strong>类型检查</strong>：TypeScript <code>tsc --noEmit</code></li><li><strong>依赖扫描</strong>：检测循环依赖、重复依赖、未使用依赖</li></ul><p><strong>关键价值</strong>：前置发现问题，避免低质量代码进入后续流程</p><p><strong>Test Stage - 自动化测试</strong></p><p><strong>职责</strong>：功能验证，确保代码正确性</p><p>测试分层：</p><ul><li><strong>单元测试</strong>：测试单个函数/模块的逻辑正确性</li><li><strong>集成测试</strong>：测试多个模块协作的正确性</li><li><strong>E2E 测试</strong>：模拟真实用户场景的端到端测试</li></ul><p><strong>输出产物</strong>：测试报告（JUnit XML）、覆盖率报告</p><p><strong>Changeset Stage - 版本管理</strong></p><p><strong>职责</strong>：自动化版本发布流程</p><ul><li>分析 <code>.changeset/*.md</code> 文件</li><li>计算新版本号（遵循语义化版本）</li><li>更新 package.json 和 CHANGELOG.md</li><li>创建版本 MR 或直接发布</li></ul><p><strong>关键特性</strong>：支持 Monorepo 场景的联动更新</p><p><strong>Deliverable Stage - 制品生成</strong></p><p><strong>职责</strong>：生成可部署的交付物</p><p>制品类型：</p><ul><li><strong>Docker 镜像</strong>：容器化应用镜像</li><li><strong>静态资源</strong>：前端构建产物（压缩、哈希）</li><li><strong>部署配置</strong>：K8s YAML、环境变量配置</li></ul><p><strong>依赖关系</strong>：依赖 Build Stage 的构建产物</p><p><strong>Deploy Stage - 环境部署</strong></p><p><strong>职责</strong>：将制品部署到目标环境</p><p>环境分类：</p><ul><li><strong>Review 环境</strong>：MR 预览环境，动态创建</li><li><strong>Staging 环境</strong>：预发布环境，验证功能</li><li><strong>Production 环境</strong>：生产环境，服务最终用户</li></ul><p><strong>环境隔离</strong>：通过 <code>CI_ENVIRONMENT_TYPE</code> 和 <code>CI_ENVIRONMENT_INSTANCE</code> 实现</p><p><strong>Verify Stage - 部署验证</strong></p><p><strong>职责</strong>：验证部署结果，确保服务可用</p><p>验证维度：</p><ul><li><strong>健康检查</strong>：HTTP 健康检查端点</li><li><strong>冒烟测试</strong>：核心业务流程快速验证</li><li><strong>性能监控</strong>：响应时间、错误率等指标</li><li><strong>业务指标</strong>：关键业务指标是否正常</li></ul><p><strong>Stage 流程关系</strong>：</p>`,41)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-921",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5Bbot%5D%20--%3E%7C%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BB%B4%E6%8A%A4%7C%20B%5Bcheck%5D%0A%20%20%20%20B%20--%3E%7C%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%7C%20C%5Btest%5D%0A%20%20%20%20C%20--%3E%7C%E5%8A%9F%E8%83%BD%E9%AA%8C%E8%AF%81%7C%20D%5Bchangeset%5D%0A%20%20%20%20D%20--%3E%7C%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%7C%20E%5Bdeliverable%5D%0A%20%20%20%20E%20--%3E%7C%E5%88%B6%E5%93%81%E7%94%9F%E6%88%90%7C%20F%5Bdeploy%5D%0A%20%20%20%20F%20--%3E%7C%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%7C%20G%5Bverify%5D%0A%20%20%20%20G%20--%3E%7C%E9%83%A8%E7%BD%B2%E9%AA%8C%E8%AF%81%7C%20H((%E5%AE%8C%E6%88%90))%0A%0A%20%20%20%20style%20A%20fill%3A%2390caf9%0A%20%20%20%20style%20B%20fill%3A%23ce93d8%0A%20%20%20%20style%20C%20fill%3A%23a5d6a7%0A%20%20%20%20style%20D%20fill%3A%23ffcc80%0A%20%20%20%20style%20E%20fill%3A%23f48fb1%0A%20%20%20%20style%20F%20fill%3A%2380deea%0A%20%20%20%20style%20G%20fill%3A%23c5e1a5%0A%20%20%20%20style%20H%20fill%3A%23ffab91%0A"})]),fallback:a(()=>s[2]||(s[2]=[i(" Loading... ")])),_:1})),s[18]||(s[18]=p(`<p>每个 stage 串行执行,同一 stage 内的 job 可以并行执行,保证了流程的顺序性和效率。</p><hr><h2 id="_3-核心技术栈" tabindex="-1">3. 核心技术栈 <a class="header-anchor" href="#_3-核心技术栈" aria-label="Permalink to &quot;3. 核心技术栈&quot;">​</a></h2><h3 id="_3-1-turbo-高性能构建编排" tabindex="-1">3.1 Turbo - 高性能构建编排 <a class="header-anchor" href="#_3-1-turbo-高性能构建编排" aria-label="Permalink to &quot;3.1 Turbo - 高性能构建编排&quot;">​</a></h3><h4 id="_3-1-1-turbo-配置" tabindex="-1">3.1.1 Turbo 配置 <a class="header-anchor" href="#_3-1-1-turbo-配置" aria-label="Permalink to &quot;3.1.1 Turbo 配置&quot;">​</a></h4><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// turbo.json</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;$schema&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://turbo.build/schema.json&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;globalPassThroughEnv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;APOLLO_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;APP_API_ENV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;APP_ENV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_SERVER_URL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_COMMIT_REF_NAME&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_COMMIT_SHA&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_COMMIT_SHORT_SHA&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_COMMIT_TAG&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_ENVIRONMENT_TYPE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_ENVIRONMENT_INSTANCE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_JOB_URL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_MERGE_REQUEST_IID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_PIPELINE_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI_PROJECT_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;CI&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;DEPLOY_API_ORIGIN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;DEPLOY_API_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;DEPLOY_PROJECT_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;GITLAB_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;DCDN_ACCESS_KEY_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;DCDN_ACCESS_KEY_SECRET&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;DEBUG_CDN_ENV_CODE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;DEPLOY_API_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;DEV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;FLAGS_SECRET&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;GAODINGX__UMS_JWT_SECRET_KEY&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;GITLAB_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;NODE_ENV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;NODE_OPTIONS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;NPM_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;OSS_ACCESS_KEY_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;OSS_ACCESS_KEY_SECRET&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;OSS_ENDPOINT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;PROD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;SSR&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;TTXS__UMS_JWT_SECRET_KEY&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;TURBO_API&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;TURBO_TEAM&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;TURBO_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;ROLLUP_OPTIONS_MAX_PARALLEL_FILE_OPS&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;tasks&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;stub&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^stub&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dist/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;dev&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;cache&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;persistent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dist/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;test&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;output/coverage/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;junit.xml&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;check-type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^check-type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;lint&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;deliverable&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;output/deliverable/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;deploy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deliverable&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;env&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CI_ENVIRONMENT_TYPE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CI_ENVIRONMENT_INSTANCE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;destroy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deploy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;env&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;verify&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deploy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;output/verify/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;editor-code-update&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;cache&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><h4 id="_3-1-2-任务依赖图" tabindex="-1">3.1.2 任务依赖图 <a class="header-anchor" href="#_3-1-2-任务依赖图" aria-label="Permalink to &quot;3.1.2 任务依赖图&quot;">​</a></h4>`,7)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-939",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20A%5Bbuild%5D%20--%3E%7C%E4%BE%9D%E8%B5%96%7C%20B%5B%5Ebuild%3Cbr%2F%3E%E4%B8%8A%E6%B8%B8%E5%8C%85%E6%9E%84%E5%BB%BA%5D%0A%0A%20%20%20%20C%5Btest%5D%20--%3E%7C%E4%BE%9D%E8%B5%96%7C%20A%0A%20%20%20%20C%20--%3E%7C%E4%BE%9D%E8%B5%96%7C%20D%5B%5Ebuild%5D%0A%0A%20%20%20%20E%5Bdeliverable%5D%20--%3E%7C%E4%BE%9D%E8%B5%96%7C%20A%0A%0A%20%20%20%20F%5Bdeploy%5D%20--%3E%7C%E4%BE%9D%E8%B5%96%7C%20E%0A%0A%20%20%20%20G%5Bverify%5D%20--%3E%7C%E4%BE%9D%E8%B5%96%7C%20F%0A%0A%20%20%20%20style%20A%20fill%3A%23bbdefb%0A%20%20%20%20style%20C%20fill%3A%23c8e6c9%0A%20%20%20%20style%20E%20fill%3A%23ffe0b2%0A%20%20%20%20style%20F%20fill%3A%23b2dfdb%0A%20%20%20%20style%20G%20fill%3A%23dcedc8%0A"})]),fallback:a(()=>s[3]||(s[3]=[i(" Loading... ")])),_:1})),s[19]||(s[19]=p(`<p><strong>关键概念</strong>:</p><ul><li><strong><code>^</code> 前缀</strong>: 表示拓扑依赖,先执行所有上游依赖包的同名任务</li><li><strong><code>dependsOn</code></strong>: 定义任务间的依赖关系</li><li><strong><code>outputs</code></strong>: 指定需要缓存的输出文件/目录</li><li><strong><code>env</code></strong>: 影响缓存 key 的环境变量</li></ul><h4 id="_3-1-3-缓存机制" tabindex="-1">3.1.3 缓存机制 <a class="header-anchor" href="#_3-1-3-缓存机制" aria-label="Permalink to &quot;3.1.3 缓存机制&quot;">​</a></h4><p>Turbo 的缓存策略:</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 缓存 Key 计算公式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CacheKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  taskName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 任务名称</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    inputs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 输入文件内容</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    env </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 环境变量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dependencyOutputs, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 依赖的输出</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div>`,5)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-972",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5B%E8%BE%93%E5%85%A5%E5%8F%98%E6%9B%B4%3F%5D%20--%3E%7C%E6%98%AF%7C%20B%5B%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%5D%0A%20%20%20%20A%20--%3E%7C%E5%90%A6%7C%20C%5B%E6%A3%80%E6%9F%A5%E7%BC%93%E5%AD%98%5D%0A%20%20%20%20C%20--%3E%7C%E5%91%BD%E4%B8%AD%7C%20D%5B%E6%81%A2%E5%A4%8D%E7%BC%93%E5%AD%98%5D%0A%20%20%20%20C%20--%3E%7C%E6%9C%AA%E5%91%BD%E4%B8%AD%7C%20B%0A%0A%20%20%20%20B%20--%3E%20E%5B%E5%86%99%E5%85%A5%E7%BC%93%E5%AD%98%5D%0A%20%20%20%20D%20--%3E%20F%5B%E8%B7%B3%E8%BF%87%E6%89%A7%E8%A1%8C%5D%0A%0A%20%20%20%20style%20D%20fill%3A%23a5d6a7%0A%20%20%20%20style%20F%20fill%3A%23a5d6a7%0A%20%20%20%20style%20B%20fill%3A%23ef9a9a%0A"})]),fallback:a(()=>s[4]||(s[4]=[i(" Loading... ")])),_:1})),s[20]||(s[20]=p(`<p><strong>缓存命中率优化</strong>:</p><ol><li>合理划分包的粒度</li><li>最小化不必要的文件变动</li><li>固定 lockfile</li><li>使用远程缓存 (TURBO_TOKEN)</li></ol><h3 id="_3-2-pnpm-workspace" tabindex="-1">3.2 pnpm Workspace <a class="header-anchor" href="#_3-2-pnpm-workspace" aria-label="Permalink to &quot;3.2 pnpm Workspace&quot;">​</a></h3><h4 id="_3-2-1-workspace-配置" tabindex="-1">3.2.1 Workspace 配置 <a class="header-anchor" href="#_3-2-1-workspace-配置" aria-label="Permalink to &quot;3.2.1 Workspace 配置&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># pnpm-workspace.yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">packages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apps/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apps/insmind</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apps/insmind/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apps/insmind/libs/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apps/insmind/routes/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">packages/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">packages/**/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">conditions/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">scripts/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/biz-framework/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/commerce/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/contents/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/dam/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/apps/**</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/packages/**</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/extensions/**</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/plugins/**</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/widgets/**</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/demos/**</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/third-party/**</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/root-config/**</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/tools/**</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/shared-partner</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/editor/infinite-shared-partner</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">domains/enterprise/*</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;!**/__tests__/**&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;!**/__template__/**&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="_3-2-2-依赖管理策略" tabindex="-1">3.2.2 依赖管理策略 <a class="header-anchor" href="#_3-2-2-依赖管理策略" aria-label="Permalink to &quot;3.2.2 依赖管理策略&quot;">​</a></h4><p><strong>Catalog 依赖目录</strong> (pnpm workspace catalog 功能):</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># pnpm-workspace.yaml (catalog section)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">catalog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;@actions/core&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">^1.11.1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;@actions/exec&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">^1.1.1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;@ant-design/icons&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">^5.5.1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # ... 更多依赖</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>优势</strong>:</p><ol><li><strong>统一版本管理</strong>: 所有包使用相同的依赖版本</li><li><strong>减少重复</strong>: 避免多处声明相同依赖</li><li><strong>易于升级</strong>: 集中升级依赖版本</li></ol><p><strong>项目使用的自动化工具</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// package.json</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bot:catalog&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;node scripts/gitlab-mr-bot/dist/cli.js mr --source-branch chore/update-catalog --target-branch master --title </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">chore: update catalog</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --description </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Automated catalog update</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --commit-message </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">chore: update catalog</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --labels </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">automation,catalog</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --reviewers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@tangbing,@qiancong,@juanbai</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -- pnpm run catalog&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>定期自动更新 catalog 并创建 MR 供审查。</p><hr><h2 id="_4-pipeline-流程详解" tabindex="-1">4. Pipeline 流程详解 <a class="header-anchor" href="#_4-pipeline-流程详解" aria-label="Permalink to &quot;4. Pipeline 流程详解&quot;">​</a></h2><h3 id="_4-1-bot-stage-自动化维护" tabindex="-1">4.1 Bot Stage - 自动化维护 <a class="header-anchor" href="#_4-1-bot-stage-自动化维护" aria-label="Permalink to &quot;4.1 Bot Stage - 自动化维护&quot;">​</a></h3><p>Bot Stage 包含多个自动化维护任务:</p><h4 id="_4-1-1-catalog-自动更新" tabindex="-1">4.1.1 Catalog 自动更新 <a class="header-anchor" href="#_4-1-1-catalog-自动更新" aria-label="Permalink to &quot;4.1.1 Catalog 自动更新&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># .gitlab-ci.yml - 定时运行 catalog 更新任务</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">catalog update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  tags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;high-concurrency&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&quot;$[[ inputs.catalog_update ]]&quot; == &quot;true&quot; &amp;&amp; ($CI_PIPELINE_SOURCE == &quot;schedule&quot; || $CI_PIPELINE_SOURCE == &quot;web&quot;)&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  extends</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.install-dependencies</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm run build</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm run bot:catalog</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>工作流程</strong>:</p>`,20)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1056",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20S%20as%20Scheduler%0A%20%20%20%20participant%20CI%20as%20GitLab%20CI%0A%20%20%20%20participant%20Bot%20as%20GitLab%20MR%20Bot%0A%20%20%20%20participant%20R%20as%20Repository%0A%0A%20%20%20%20S-%3E%3ECI%3A%20%E5%AE%9A%E6%97%B6%E8%A7%A6%E5%8F%91%20(schedule)%0A%20%20%20%20CI-%3E%3ECI%3A%20pnpm%20install%0A%20%20%20%20CI-%3E%3ECI%3A%20pnpm%20run%20build%0A%20%20%20%20CI-%3E%3EBot%3A%20pnpm%20run%20bot%3Acatalog%0A%20%20%20%20Bot-%3E%3EBot%3A%20%E6%94%B6%E9%9B%86%E4%BE%9D%E8%B5%96%20(catalog%3Acollect)%0A%20%20%20%20Bot-%3E%3EBot%3A%20%E5%88%86%E5%8F%91%E5%88%B0%E5%90%84%E5%8C%85%20(catalog%3Adistribute)%0A%20%20%20%20Bot-%3E%3EBot%3A%20pnpm%20install%0A%20%20%20%20Bot-%3E%3EBot%3A%20%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%BB%A3%E7%A0%81%0A%20%20%20%20Bot-%3E%3ER%3A%20%E5%88%9B%E5%BB%BA%2F%E6%9B%B4%E6%96%B0%20MR%0A%20%20%20%20Note%20over%20Bot%2CR%3A%20chore%2Fupdate-catalog%20%E5%88%86%E6%94%AF%0A"})]),fallback:a(()=>s[5]||(s[5]=[i(" Loading... ")])),_:1})),s[21]||(s[21]=p(`<p><strong>catalog 管理器</strong> 的核心逻辑在 <code>scripts/catalog-manager/</code>:</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 简化的核心流程</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CatalogManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 收集所有包的依赖</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> collect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> packages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getWorkspacePackages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> allDeps</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pkg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> packages) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">entries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pkg.dependencies)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 去重、合并版本</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        allDeps.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resolveVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(version));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allDeps;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 分发到 catalog</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> distribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">allDeps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> catalogConfig</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> loadCatalogConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allDeps) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      catalogConfig.catalog[name] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> writeCatalogConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(catalogConfig);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="_4-1-2-自动发布版本" tabindex="-1">4.1.2 自动发布版本 <a class="header-anchor" href="#_4-1-2-自动发布版本" aria-label="Permalink to &quot;4.1.2 自动发布版本&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># .gitlab-ci.yml - 定时运行版本 MR 合并任务</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">auto publish versions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  tags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;high-concurrency&#39;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 由于这个脚本中会锁定主分支，所以必须让它全局同时只运行一个实例</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  resource_group</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">auto-publish-versions</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 在 changeset-release 分支的 MR 上手动触发</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;$CI_PIPELINE_SOURCE == &quot;merge_request_event&quot; &amp;&amp; $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^changeset-release\\//&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">manual</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      allow_failure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 定时任务或手动触发</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&quot;$[[ inputs.merge_versions_mr ]]&quot; == &quot;true&quot; &amp;&amp; ($CI_PIPELINE_SOURCE == &quot;schedule&quot; || $CI_PIPELINE_SOURCE == &quot;web&quot;)&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  extends</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.install-dependencies</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">35m</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm run bot:merge-versions-mr</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>resource_group 机制</strong>:</p>`,5)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1068",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20A%5BJob%201%3Cbr%2F%3Eauto%20publish%20versions%5D%20-.-%3E%7C%E7%AD%89%E5%BE%85%7C%20C%7BResource%20Group%3Cbr%2F%3Eauto-publish-versions%7D%0A%20%20%20%20B%5BJob%202%3Cbr%2F%3Eauto%20publish%20versions%5D%20-.-%3E%7C%E7%AD%89%E5%BE%85%7C%20C%0A%0A%20%20%20%20C%20--%3E%7C%E8%8E%B7%E5%8F%96%E9%94%81%7C%20D%5B%E6%89%A7%E8%A1%8C%20Job%201%5D%0A%20%20%20%20D%20--%3E%7C%E9%87%8A%E6%94%BE%E9%94%81%7C%20E%5B%E6%89%A7%E8%A1%8C%20Job%202%5D%0A%0A%20%20%20%20style%20C%20fill%3A%23ffeb3b%0A%20%20%20%20style%20D%20fill%3A%23a5d6a7%0A%20%20%20%20style%20E%20fill%3A%23fff9c4%0A"})]),fallback:a(()=>s[6]||(s[6]=[i(" Loading... ")])),_:1})),s[22]||(s[22]=p(`<p><strong>为什么需要 resource_group?</strong></p><p>因为 <code>merge-versions-mr.mjs</code> 脚本会<strong>锁定主分支</strong>,防止在等待 pipeline 期间有其他代码合并导致版本分支不断更新。</p><h3 id="_4-2-check-stage-代码质量检查" tabindex="-1">4.2 Check Stage - 代码质量检查 <a class="header-anchor" href="#_4-2-check-stage-代码质量检查" aria-label="Permalink to &quot;4.2 Check Stage - 代码质量检查&quot;">​</a></h3><p>Check Stage 通过引入的 <code>monorepo-workflows</code> 组件实现,通常包括:</p><ol><li><strong>Lint 检查</strong>: ESLint、Stylelint、Prettier</li><li><strong>类型检查</strong>: TypeScript <code>tsc --noEmit</code></li><li><strong>依赖检查</strong>: 循环依赖、重复依赖扫描</li></ol><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 本地执行示例</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lint</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # 运行 lint</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> check-type</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 类型检查</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_4-3-test-stage-自动化测试" tabindex="-1">4.3 Test Stage - 自动化测试 <a class="header-anchor" href="#_4-3-test-stage-自动化测试" aria-label="Permalink to &quot;4.3 Test Stage - 自动化测试&quot;">​</a></h3><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// turbo.json</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;test&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;output/coverage/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;junit.xml&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>测试策略:</p>`,9)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1106",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5B%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%3Cbr%2F%3EVitest%5D%20--%3E%20D%5B%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A%5D%0A%20%20%20%20B%5B%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%3Cbr%2F%3EVitest%5D%20--%3E%20D%0A%20%20%20%20C%5BE2E%E6%B5%8B%E8%AF%95%3Cbr%2F%3ECypress%5D%20--%3E%20D%0A%0A%20%20%20%20D%20--%3E%20E%5B%E8%A6%86%E7%9B%96%E7%8E%87%E6%8A%A5%E5%91%8A%3Cbr%2F%3Eoutput%2Fcoverage%5D%0A%20%20%20%20D%20--%3E%20F%5BJUnit%20XML%3Cbr%2F%3Ejunit.xml%5D%0A%0A%20%20%20%20style%20A%20fill%3A%23c5e1a5%0A%20%20%20%20style%20B%20fill%3A%23fff59d%0A%20%20%20%20style%20C%20fill%3A%23ffccbc%0A%20%20%20%20style%20E%20fill%3A%23b2dfdb%0A%20%20%20%20style%20F%20fill%3A%23b2dfdb%0A"})]),fallback:a(()=>s[7]||(s[7]=[i(" Loading... ")])),_:1})),s[23]||(s[23]=p(`<p><strong>测试排除配置</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// package.json</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;testExcludePackages&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@gdesign/commerce-core&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@gdesign/smart-subtask&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@insmind/vue3-services&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@gdesign/container&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@gdesign/client-bootstrap&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@gdesign/meta-utils&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@insmind/vue3-routes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@gdesign/site&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@app/gaoding-art&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@app/example-app&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@app/gaoding&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;@gdesign/contents-app&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_4-4-changeset-stage-版本管理" tabindex="-1">4.4 Changeset Stage - 版本管理 <a class="header-anchor" href="#_4-4-changeset-stage-版本管理" aria-label="Permalink to &quot;4.4 Changeset Stage - 版本管理&quot;">​</a></h3><p>Changeset Stage 通过 <code>changesets-gitlab</code> 自动化版本发布:</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># changesets-gitlab 配置示例 (在引入的组件中)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">changeset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">changeset</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm install</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm run build</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm exec changesets-gitlab</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  variables</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    INPUT_VERSION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm run changeset:version</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    INPUT_PUBLISH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm run changeset:publish</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>版本发布流程</strong>:</p>`,6)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1121",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20D%20as%20Developer%0A%20%20%20%20participant%20MR%20as%20Merge%20Request%0A%20%20%20%20participant%20Bot%20as%20Changesets%20Bot%0A%20%20%20%20participant%20CI%20as%20CI%20Pipeline%0A%20%20%20%20participant%20NPM%20as%20NPM%20Registry%0A%20%20%20%20participant%20Git%20as%20Git%20Repository%0A%0A%20%20%20%20D-%3E%3ED%3A%20pnpm%20run%20changeset%0A%20%20%20%20D-%3E%3ED%3A%20%E5%88%9B%E5%BB%BA%20.changeset%2F*.md%0A%20%20%20%20D-%3E%3EMR%3A%20%E6%8F%90%E4%BA%A4%20changeset%20%E6%96%87%E4%BB%B6%0A%20%20%20%20MR-%3E%3EGit%3A%20%E5%90%88%E5%B9%B6%E5%88%B0%20master%0A%0A%20%20%20%20Git-%3E%3EBot%3A%20%E8%A7%A6%E5%8F%91%20Changesets%20Bot%0A%20%20%20%20Bot-%3E%3EBot%3A%20%E5%88%86%E6%9E%90%20changeset%20%E6%96%87%E4%BB%B6%0A%20%20%20%20Bot-%3E%3EBot%3A%20%E6%9B%B4%E6%96%B0%E7%89%88%E6%9C%AC%E5%8F%B7%E5%92%8C%20CHANGELOG%0A%20%20%20%20Bot-%3E%3EMR%3A%20%E5%88%9B%E5%BB%BA%E7%89%88%E6%9C%AC%20MR%3Cbr%2F%3E(changeset-release%2Fmaster)%0A%0A%20%20%20%20Note%20over%20MR%3A%20%E4%BA%BA%E5%B7%A5%E5%AE%A1%E6%9F%A5%E6%88%96%E5%AE%9A%E6%97%B6%E8%A7%A6%E5%8F%91%0A%0A%20%20%20%20MR-%3E%3ECI%3A%20%E8%A7%A6%E5%8F%91%20auto%20publish%20versions%0A%20%20%20%20CI-%3E%3ECI%3A%20%E7%AD%89%E5%BE%85%20pipeline%20%E6%88%90%E5%8A%9F%0A%20%20%20%20CI-%3E%3ECI%3A%20%E5%86%BB%E7%BB%93%E4%B8%BB%E5%88%86%E6%94%AF%0A%20%20%20%20CI-%3E%3EMR%3A%20%E5%90%88%E5%B9%B6%E7%89%88%E6%9C%AC%20MR%0A%20%20%20%20CI-%3E%3ENPM%3A%20pnpm%20publish%0A%20%20%20%20CI-%3E%3EGit%3A%20%E5%88%9B%E5%BB%BA%20Git%20Tag%0A%20%20%20%20CI-%3E%3ECI%3A%20%E8%A7%A3%E5%86%BB%E4%B8%BB%E5%88%86%E6%94%AF%0A"})]),fallback:a(()=>s[8]||(s[8]=[i(" Loading... ")])),_:1})),s[24]||(s[24]=p(`<h3 id="_4-5-deliverable-stage-制品生成" tabindex="-1">4.5 Deliverable Stage - 制品生成 <a class="header-anchor" href="#_4-5-deliverable-stage-制品生成" aria-label="Permalink to &quot;4.5 Deliverable Stage - 制品生成&quot;">​</a></h3><p>Deliverable Stage 生成可部署的制品:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// turbo.json</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deliverable&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;build&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;output/deliverable/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>制品类型</strong>:</p><table tabindex="0"><thead><tr><th>制品类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>Docker 镜像</strong></td><td>容器化应用</td><td><code>gaoding-registry.cr.aliyuncs.com/app:v1.0.0</code></td></tr><tr><td><strong>静态资源</strong></td><td>前端构建产物</td><td>HTML、CSS、JS、图片等</td></tr><tr><td><strong>NPM 包</strong></td><td>可复用的库</td><td>上传到私有 NPM Registry</td></tr><tr><td><strong>部署配置</strong></td><td>K8s YAML、Helm Chart</td><td>用于部署编排</td></tr></tbody></table><p><strong>应用示例配置</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// apps/gaoding/turbo.json</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deliverable&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;passThroughEnv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;OSS_ACCESS_KEY_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;OSS_ACCESS_KEY_SECRET&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;NPM_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;FLAGS_SECRET&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;env&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;OSS_ENDPOINT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_4-6-deploy-stage-环境部署" tabindex="-1">4.6 Deploy Stage - 环境部署 <a class="header-anchor" href="#_4-6-deploy-stage-环境部署" aria-label="Permalink to &quot;4.6 Deploy Stage - 环境部署&quot;">​</a></h3><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// turbo.json</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deploy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deliverable&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;env&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CI_ENVIRONMENT_TYPE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CI_ENVIRONMENT_INSTANCE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>多环境部署</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// package.json</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deploy:production&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CI_ENVIRONMENT_TYPE=production CI_ENVIRONMENT_INSTANCE=default APP_API_ENV=prod turbo run deploy --output-logs=new-only&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deploy:review&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CI_ENVIRONMENT_TYPE=review CI_ENVIRONMENT_INSTANCE=$([ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$CI_PIPELINE_SOURCE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">merge_request_event</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ] &amp;&amp; echo </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mr$CI_MERGE_REQUEST_IID</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> || echo </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">) APP_API_ENV=fat sh scripts/turbo-analyzer/turbo-with-report.sh turbo run deploy --output-logs=new-only&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deploy:staging&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CI_ENVIRONMENT_TYPE=staging CI_ENVIRONMENT_INSTANCE=default APP_API_ENV=stage sh scripts/turbo-analyzer/turbo-with-report.sh turbo run deploy --output-logs=new-only&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>环境隔离策略</strong>:</p>`,12)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1208",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20subgraph%20%22%E7%8E%AF%E5%A2%83%E7%B1%BB%E5%9E%8B%22%0A%20%20%20%20%20%20%20%20A%5BReview%3Cbr%2F%3EMR%20%E9%A2%84%E8%A7%88%E7%8E%AF%E5%A2%83%5D%0A%20%20%20%20%20%20%20%20B%5BStaging%3Cbr%2F%3E%E9%A2%84%E5%8F%91%E5%B8%83%E7%8E%AF%E5%A2%83%5D%0A%20%20%20%20%20%20%20%20C%5BProduction%3Cbr%2F%3E%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20%22%E5%AE%9E%E4%BE%8B%E9%9A%94%E7%A6%BB%22%0A%20%20%20%20%20%20%20%20D%5Breview%2Fmr123%3Cbr%2F%3EMR%20123%20%E4%B8%93%E5%B1%9E%5D%0A%20%20%20%20%20%20%20%20E%5Breview%2Fmr456%3Cbr%2F%3EMR%20456%20%E4%B8%93%E5%B1%9E%5D%0A%20%20%20%20%20%20%20%20F%5Bstaging%2Fdefault%3Cbr%2F%3E%E5%94%AF%E4%B8%80%E5%AE%9E%E4%BE%8B%5D%0A%20%20%20%20%20%20%20%20G%5Bproduction%2Fdefault%3Cbr%2F%3E%E5%94%AF%E4%B8%80%E5%AE%9E%E4%BE%8B%5D%0A%20%20%20%20end%0A%0A%20%20%20%20A%20-.-%3E%20D%0A%20%20%20%20A%20-.-%3E%20E%0A%20%20%20%20B%20-.-%3E%20F%0A%20%20%20%20C%20-.-%3E%20G%0A%0A%20%20%20%20style%20A%20fill%3A%23e3f2fd%0A%20%20%20%20style%20B%20fill%3A%23fff3e0%0A%20%20%20%20style%20C%20fill%3A%23c8e6c9%0A"})]),fallback:a(()=>s[9]||(s[9]=[i(" Loading... ")])),_:1})),s[25]||(s[25]=p(`<p><strong>CI_ENVIRONMENT_INSTANCE 计算</strong>:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Review 环境</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CI_ENVIRONMENT_INSTANCE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$CI_PIPELINE_SOURCE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;merge_request_event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ] </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$CI_MERGE_REQUEST_IID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;default&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 示例:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - MR#123 =&gt; CI_ENVIRONMENT_INSTANCE=mr123</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - 手动触发 =&gt; CI_ENVIRONMENT_INSTANCE=default</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_4-7-verify-stage-部署验证" tabindex="-1">4.7 Verify Stage - 部署验证 <a class="header-anchor" href="#_4-7-verify-stage-部署验证" aria-label="Permalink to &quot;4.7 Verify Stage - 部署验证&quot;">​</a></h3><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// turbo.json</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;verify&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deploy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;outputs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;output/verify/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>验证任务示例:</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 伪代码示例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> verifyDeployment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. 健康检查</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> checkHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`https://\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}.example.com/health\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. 冒烟测试</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> runSmokeTests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3. 性能监控</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> checkPerformance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 4. 错误率监控</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> checkErrorRate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><hr><h2 id="_5-自动化机器人系统" tabindex="-1">5. 自动化机器人系统 <a class="header-anchor" href="#_5-自动化机器人系统" aria-label="Permalink to &quot;5. 自动化机器人系统&quot;">​</a></h2><h3 id="_5-1-gitlab-mr-bot" tabindex="-1">5.1 GitLab MR Bot <a class="header-anchor" href="#_5-1-gitlab-mr-bot" aria-label="Permalink to &quot;5.1 GitLab MR Bot&quot;">​</a></h3><p>GitLab MR Bot 是一个通用的<strong>仓库自动维护机器人</strong>,提供标准化的 MR 工作流。</p><h4 id="_5-1-1-设计理念" tabindex="-1">5.1.1 设计理念 <a class="header-anchor" href="#_5-1-1-设计理念" aria-label="Permalink to &quot;5.1.1 设计理念&quot;">​</a></h4><p><strong>问题</strong>: 大型项目包含大量自动化脚本(代码生成、配置同步、依赖更新等),但这些更新往往依赖人工执行,容易形成&quot;更新惰性锁死&quot;。</p><p><strong>解决方案</strong>: 提供统一的自动化 MR 通道,让各种代码生成脚本能够自动提交变更,并在受控流程下被审查与合并。</p><h4 id="_5-1-2-核心功能" tabindex="-1">5.1.2 核心功能 <a class="header-anchor" href="#_5-1-2-核心功能" aria-label="Permalink to &quot;5.1.2 核心功能&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// scripts/gitlab-mr-bot/src/mr.ts 核心接口</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SyncAndCreateMROptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  sourceBranch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 源分支名称</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  targetBranch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 目标分支(默认:当前分支)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  title</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// MR 标题</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// MR 描述</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  commitMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 提交消息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  prepareWorkspace</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 准备工作区回调</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  removeSourceBranch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 合并后删除源分支</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  labels</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// MR 标签</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  reviewers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">number</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 评审人</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  assignees</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">number</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 指派人</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  gitlabToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// GitLab Token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> syncAndCreateMR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SyncAndCreateMROptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_5-1-3-工作流程" tabindex="-1">5.1.3 工作流程 <a class="header-anchor" href="#_5-1-3-工作流程" aria-label="Permalink to &quot;5.1.3 工作流程&quot;">​</a></h4>`,16)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1247",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Script%20as%20%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC%0A%20%20%20%20participant%20Bot%20as%20GitLab%20MR%20Bot%0A%20%20%20%20participant%20Git%20as%20Git%20Repository%0A%20%20%20%20participant%20GL%20as%20GitLab%20API%0A%0A%20%20%20%20Script-%3E%3EBot%3A%20syncAndCreateMR(options)%0A%20%20%20%20Bot-%3E%3EGit%3A%20%E5%88%87%E6%8D%A2%E5%88%B0%E6%BA%90%E5%88%86%E6%94%AF%0A%20%20%20%20Note%20over%20Bot%2CGit%3A%20%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%AD%98%E5%9C%A8%E5%88%99%E5%88%9B%E5%BB%BA%0A%0A%20%20%20%20Bot-%3E%3EGit%3A%20%E9%87%8D%E7%BD%AE%E5%88%B0%E7%9B%AE%E6%A0%87%E5%88%86%E6%94%AF%0A%20%20%20%20Note%20over%20Bot%2CGit%3A%20git%20reset%20--hard%20origin%2Ftarget%0A%0A%20%20%20%20Bot-%3E%3EBot%3A%20%E6%89%A7%E8%A1%8C%20prepareWorkspace()%0A%20%20%20%20Note%20over%20Bot%3A%20%E7%94%9F%E6%88%90%2F%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81%0A%0A%20%20%20%20Bot-%3E%3EGit%3A%20git%20diff%0A%0A%20%20%20%20alt%20%E6%9C%89%E5%8F%98%E6%9B%B4%0A%20%20%20%20%20%20%20%20Bot-%3E%3EGit%3A%20git%20add%20--all%0A%20%20%20%20%20%20%20%20Bot-%3E%3EGit%3A%20git%20commit%20-m%20%22message%22%0A%20%20%20%20%20%20%20%20Bot-%3E%3EGit%3A%20git%20push%0A%20%20%20%20%20%20%20%20Bot-%3E%3EGL%3A%20%E6%A3%80%E6%9F%A5%E5%B7%B2%E5%AD%98%E5%9C%A8%20MR%0A%20%20%20%20%20%20%20%20alt%20MR%20%E5%AD%98%E5%9C%A8%0A%20%20%20%20%20%20%20%20%20%20%20%20Bot-%3E%3EGL%3A%20%E6%9B%B4%E6%96%B0%20MR%20%E6%8F%8F%E8%BF%B0%0A%20%20%20%20%20%20%20%20else%20MR%20%E4%B8%8D%E5%AD%98%E5%9C%A8%0A%20%20%20%20%20%20%20%20%20%20%20%20Bot-%3E%3EGL%3A%20%E5%88%9B%E5%BB%BA%E6%96%B0%20MR%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20else%20%E6%97%A0%E5%8F%98%E6%9B%B4%0A%20%20%20%20%20%20%20%20Bot-%3E%3EBot%3A%20%E8%B7%B3%E8%BF%87%E6%8F%90%E4%BA%A4%0A%20%20%20%20end%0A"})]),fallback:a(()=>s[10]||(s[10]=[i(" Loading... ")])),_:1})),s[26]||(s[26]=p(`<h4 id="_5-1-4-实际应用示例" tabindex="-1">5.1.4 实际应用示例 <a class="header-anchor" href="#_5-1-4-实际应用示例" aria-label="Permalink to &quot;5.1.4 实际应用示例&quot;">​</a></h4><p><strong>Catalog 自动更新</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// package.json - bot:catalog</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bot:catalog&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;node scripts/gitlab-mr-bot/dist/cli.js mr --source-branch chore/update-catalog --target-branch master --title </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">chore: update catalog</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --description </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Automated catalog update</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --commit-message </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">chore: update catalog</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --labels </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">automation,catalog</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --reviewers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@tangbing,@qiancong,@juanbai</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -- pnpm run catalog&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>编辑器代码自动更新</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// package.json - bot:editor-code-update</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bot:editor-code-update&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;node scripts/gitlab-mr-bot/dist/cli.js mr --source-branch chore/editor-code-update --target-branch master --title </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">chore: update editor code</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --description </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Automated editor code update</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --commit-message </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">chore: update editor code</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --labels </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">automation,editor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --reviewers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@juanbai,@zhangliang,@facai</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -- npx turbo run editor-code-update&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>包索引自动生成</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// package.json - bot:generate-packages-index</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bot:generate-packages-index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;node scripts/gitlab-mr-bot/dist/cli.js mr --source-branch chore/update-packages-index --target-branch master --title </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">chore: update packages index</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --description </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Automated packages index update</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --commit-message </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">chore: update packages index</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --labels </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">automation,docs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> --reviewers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@tangbing,@qiancong,@juanbai</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -- pnpm run docs:generate-packages-index&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_5-2-自动版本合并机器人" tabindex="-1">5.2 自动版本合并机器人 <a class="header-anchor" href="#_5-2-自动版本合并机器人" aria-label="Permalink to &quot;5.2 自动版本合并机器人&quot;">​</a></h3><p><code>scripts/merge-versions-mr.mjs</code> 是一个专门用于<strong>自动合并版本发布 MR</strong> 的高级机器人。</p><h4 id="_5-2-1-核心挑战" tabindex="-1">5.2.1 核心挑战 <a class="header-anchor" href="#_5-2-1-核心挑战" aria-label="Permalink to &quot;5.2.1 核心挑战&quot;">​</a></h4><p><strong>问题</strong>: Changesets Bot 会创建版本 MR (changeset-release/master),但在等待 pipeline 期间,如果有新代码合并到 master,Changesets Bot 会自动更新版本 MR,导致 pipeline 重新开始,形成无限循环。</p><p><strong>解决方案</strong>: 冻结主分支,等待 pipeline 完成后再合并,然后解冻。</p><h4 id="_5-2-2-分支冻结机制" tabindex="-1">5.2.2 分支冻结机制 <a class="header-anchor" href="#_5-2-2-分支冻结机制" aria-label="Permalink to &quot;5.2.2 分支冻结机制&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 简化的核心逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> freezeBranch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. 获取当前保护规则</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  originalBranchProtection </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getBranchProtection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. 设置权限为禁止所有人推送和合并 (access_level: 0)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateBranchProtection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_BRANCH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    allowedToPush: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">buildFrozenPushAccessLevels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(originalBranchProtection?.push_access_levels),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    allowedToMerge: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">buildFrozenMergeAccessLevels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(originalBranchProtection?.merge_access_levels),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  isBranchFrozen </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> unfreezeBranch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 恢复原始保护规则</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateBranchProtection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_BRANCH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    allowedToPush: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">buildRestoredAccessLevels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(originalBranchProtection.push_access_levels),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    allowedToMerge: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">buildRestoredAccessLevels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(originalBranchProtection.merge_access_levels),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  isBranchFrozen </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="_5-2-3-完整工作流程" tabindex="-1">5.2.3 完整工作流程 <a class="header-anchor" href="#_5-2-3-完整工作流程" aria-label="Permalink to &quot;5.2.3 完整工作流程&quot;">​</a></h4>`,15)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1285",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Bot%20as%20Merge%20Bot%0A%20%20%20%20participant%20GL%20as%20GitLab%20API%0A%20%20%20%20participant%20MR%20as%20Version%20MR%0A%20%20%20%20participant%20PL%20as%20Pipeline%0A%20%20%20%20participant%20Master%20as%20Master%20Branch%0A%0A%20%20%20%20Bot-%3E%3EGL%3A%20%E6%9F%A5%E6%89%BE%20changeset-release%2Fmaster%20MR%0A%20%20%20%20Bot-%3E%3EMR%3A%20%E6%A3%80%E6%9F%A5%20MR%20%E7%8A%B6%E6%80%81%0A%20%20%20%20Bot-%3E%3EPL%3A%20%E8%8E%B7%E5%8F%96%E6%9C%80%E6%96%B0%20Pipeline%0A%0A%20%20%20%20alt%20Pipeline%20%E8%BF%90%E8%A1%8C%E4%B8%AD%0A%20%20%20%20%20%20%20%20Bot-%3E%3EMaster%3A%20%E5%86%BB%E7%BB%93%E5%88%86%E6%94%AF%20(%E7%A6%81%E6%AD%A2%E6%8E%A8%E9%80%81%E5%92%8C%E5%90%88%E5%B9%B6)%0A%20%20%20%20%20%20%20%20Note%20over%20Master%3A%20access_level%3A%200%0A%0A%20%20%20%20%20%20%20%20loop%20%E8%BD%AE%E8%AF%A2%E7%AD%89%E5%BE%85%0A%20%20%20%20%20%20%20%20%20%20%20%20Bot-%3E%3EPL%3A%20%E6%A3%80%E6%9F%A5%20Pipeline%20%E7%8A%B6%E6%80%81%0A%20%20%20%20%20%20%20%20%20%20%20%20alt%20Pipeline%20%E6%88%90%E5%8A%9F%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Note%20over%20Bot%3A%20%E9%80%80%E5%87%BA%E5%BE%AA%E7%8E%AF%0A%20%20%20%20%20%20%20%20%20%20%20%20else%20Pipeline%20%E5%A4%B1%E8%B4%A5%2F%E8%B6%85%E6%97%B6%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Bot-%3E%3EMaster%3A%20%E8%A7%A3%E5%86%BB%E5%88%86%E6%94%AF%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Bot-%3E%3EBot%3A%20%E6%8A%A5%E9%94%99%E9%80%80%E5%87%BA%0A%20%20%20%20%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20%20%20Bot-%3E%3EMaster%3A%20%E4%B8%B4%E6%97%B6%E6%81%A2%E5%A4%8D%E6%8E%A8%E9%80%81%E5%92%8C%E5%90%88%E5%B9%B6%E6%9D%83%E9%99%90%0A%20%20%20%20%20%20%20%20Bot-%3E%3EGL%3A%20%E5%90%88%E5%B9%B6%20MR%0A%20%20%20%20%20%20%20%20Bot-%3E%3EMaster%3A%20%E8%A7%A3%E5%86%BB%E5%88%86%E6%94%AF%20(%E6%81%A2%E5%A4%8D%E6%89%80%E6%9C%89%E6%9D%83%E9%99%90)%0A%20%20%20%20else%20Pipeline%20%E5%B7%B2%E5%AE%8C%E6%88%90%0A%20%20%20%20%20%20%20%20Bot-%3E%3EGL%3A%20%E7%9B%B4%E6%8E%A5%E5%90%88%E5%B9%B6%20MR%0A%20%20%20%20end%0A"})]),fallback:a(()=>s[11]||(s[11]=[i(" Loading... ")])),_:1})),s[27]||(s[27]=p(`<h4 id="_5-2-4-关键代码片段" tabindex="-1">5.2.4 关键代码片段 <a class="header-anchor" href="#_5-2-4-关键代码片段" aria-label="Permalink to &quot;5.2.4 关键代码片段&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// scripts/merge-versions-mr.mjs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> freezeBranch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (isBranchFrozen) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`   ℹ️  分支 \${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_BRANCH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} 已经冻结\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`   🔒 冻结分支 \${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_BRANCH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}（禁止所有人推送和合并 MR）...\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 先获取当前保护规则</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    originalBranchProtection </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getBranchProtection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 检查是否已经冻结（推送和合并权限都被禁止）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isPushForbidden</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isAccessForbidden</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(originalBranchProtection?.push_access_levels);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isMergeForbidden</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isAccessForbidden</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(originalBranchProtection?.merge_access_levels);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (isPushForbidden </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isMergeForbidden) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`   ℹ️  分支 \${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_BRANCH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} 已经冻结（推送和合并都已禁止），无需更新\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        isBranchFrozen </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DRY_RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`   🔍 [DRY RUN] 将冻结分支 \${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_BRANCH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        isBranchFrozen </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 构建冻结后的权限数组（禁止所有）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> frozenLevels</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            allowedToPush: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">buildFrozenPushAccessLevels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                originalBranchProtection?.push_access_levels,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            allowedToMerge: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">buildFrozenMergeAccessLevels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                originalBranchProtection?.merge_access_levels,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 使用 PATCH 方法安全地更新保护规则</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateBranchProtection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_BRANCH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, frozenLevels);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        isBranchFrozen </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`   ✅ 分支 \${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TARGET_BRANCH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} 已冻结（所有人推送和合并权限已禁止）\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`   ❌ 冻结分支失败:\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error.message);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> error;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><hr><h2 id="_6-turbo-构建优化" tabindex="-1">6. Turbo 构建优化 <a class="header-anchor" href="#_6-turbo-构建优化" aria-label="Permalink to &quot;6. Turbo 构建优化&quot;">​</a></h2><h3 id="_6-1-turbo-analyzer-性能分析" tabindex="-1">6.1 Turbo Analyzer - 性能分析 <a class="header-anchor" href="#_6-1-turbo-analyzer-性能分析" aria-label="Permalink to &quot;6.1 Turbo Analyzer - 性能分析&quot;">​</a></h3><p>项目使用自定义的 <code>turbo-analyzer</code> 包装脚本来增强 Turbo 的可观测性:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># scripts/turbo-analyzer/turbo-with-report.sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Turbo 包装脚本 - 在 CI 环境中自动生成可视化报表</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用方法: ./scripts/turbo-analyzer/turbo-with-report.sh turbo run build --filter=@app/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># GitLab CI 配置示例:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># build:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   script:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     - sh scripts/turbo-analyzer/turbo-with-report.sh turbo run build --filter=@app/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   artifacts:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     paths:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#       - .turbo/runs/</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     expire_in: 7 days</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     when: always</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_6-2-构建缓存策略" tabindex="-1">6.2 构建缓存策略 <a class="header-anchor" href="#_6-2-构建缓存策略" aria-label="Permalink to &quot;6.2 构建缓存策略&quot;">​</a></h3><p><strong>本地缓存</strong>:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>.turbo/</span></span>
<span class="line"><span>├── cache/          # 任务输出缓存</span></span>
<span class="line"><span>└── runs/           # 运行日志和分析报告</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>远程缓存</strong> (Turbo Remote Cache):</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// turbo.json - globalPassThroughEnv</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;TURBO_API&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;TURBO_TEAM&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;TURBO_TOKEN&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>启用远程缓存后,团队成员可以共享构建缓存,显著加速 CI/CD。</p><h3 id="_6-3-过滤器使用" tabindex="-1">6.3 过滤器使用 <a class="header-anchor" href="#_6-3-过滤器使用" aria-label="Permalink to &quot;6.3 过滤器使用&quot;">​</a></h3><p>Turbo 提供强大的 <code>--filter</code> 选项:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 只构建应用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">turbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --filter=@app/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --filter=@oem/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 只构建库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">turbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --filter=!@app/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --filter=!@oem/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 构建特定包及其依赖</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">turbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --filter=@app/gaoding...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 构建受影响的包 (基于 git diff)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">turbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --filter=[HEAD^1]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Filter 语法总结</strong>:</p><table tabindex="0"><thead><tr><th>语法</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>@app/*</code></td><td>匹配所有 @app scope 的包</td><td><code>@app/gaoding</code>, <code>@app/insmind</code></td></tr><tr><td><code>!@app/*</code></td><td>排除所有 @app scope 的包</td><td>用于只构建库</td></tr><tr><td><code>@app/gaoding...</code></td><td>包及其所有依赖</td><td>包含上游依赖</td></tr><tr><td><code>...@app/gaoding</code></td><td>包及其所有依赖方</td><td>包含下游依赖</td></tr><tr><td><code>[HEAD^1]</code></td><td>Git 变更的包</td><td>增量构建</td></tr></tbody></table><hr><h2 id="_7-changeset-版本管理" tabindex="-1">7. Changeset 版本管理 <a class="header-anchor" href="#_7-changeset-版本管理" aria-label="Permalink to &quot;7. Changeset 版本管理&quot;">​</a></h2><h3 id="_7-1-changeset-工作流" tabindex="-1">7.1 Changeset 工作流 <a class="header-anchor" href="#_7-1-changeset-工作流" aria-label="Permalink to &quot;7.1 Changeset 工作流&quot;">​</a></h3>`,21)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1404",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20A%5B%E5%BC%80%E5%8F%91%E6%96%B0%E5%8A%9F%E8%83%BD%2F%E4%BF%AE%E5%A4%8D%5D%20--%3E%20B%5B%E5%88%9B%E5%BB%BA%20Changeset%3Cbr%2F%3Epnpm%20run%20changeset%5D%0A%20%20%20%20B%20--%3E%20C%5B%E6%8F%90%E4%BA%A4%E5%88%B0%20MR%5D%0A%20%20%20%20C%20--%3E%20D%5B%E5%90%88%E5%B9%B6%E5%88%B0%20master%5D%0A%0A%20%20%20%20D%20--%3E%20E%5BChangesets%20Bot%20%E8%A7%A6%E5%8F%91%5D%0A%20%20%20%20E%20--%3E%20F%5B%E7%94%9F%E6%88%90%E7%89%88%E6%9C%AC%20MR%3Cbr%2F%3Echangeset-release%2Fmaster%5D%0A%0A%20%20%20%20F%20--%3E%20G%7BMR%20%E5%AE%A1%E6%9F%A5%7D%0A%20%20%20%20G%20--%3E%7C%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91%7C%20H%5BAuto%20Publish%20Versions%20Job%5D%0A%20%20%20%20G%20--%3E%7C%E5%AE%9A%E6%97%B6%E8%A7%A6%E5%8F%91%7C%20H%0A%0A%20%20%20%20H%20--%3E%20I%5B%E7%AD%89%E5%BE%85%20Pipeline%20%E6%88%90%E5%8A%9F%5D%0A%20%20%20%20I%20--%3E%20J%5B%E5%86%BB%E7%BB%93%E4%B8%BB%E5%88%86%E6%94%AF%5D%0A%20%20%20%20J%20--%3E%20K%5B%E5%90%88%E5%B9%B6%E7%89%88%E6%9C%AC%20MR%5D%0A%20%20%20%20K%20--%3E%20L%5B%E6%89%A7%E8%A1%8C%E5%8F%91%E5%B8%83%3Cbr%2F%3Epnpm%20publish%5D%0A%20%20%20%20L%20--%3E%20M%5B%E5%88%9B%E5%BB%BA%20Git%20Tag%3Cbr%2F%3Echangeset%20tag%5D%0A%20%20%20%20M%20--%3E%20N%5B%E8%A7%A3%E5%86%BB%E4%B8%BB%E5%88%86%E6%94%AF%5D%0A%0A%20%20%20%20style%20B%20fill%3A%23e3f2fd%0A%20%20%20%20style%20F%20fill%3A%23fff3e0%0A%20%20%20%20style%20H%20fill%3A%23ffcdd2%0A%20%20%20%20style%20L%20fill%3A%23c8e6c9%0A"})]),fallback:a(()=>s[12]||(s[12]=[i(" Loading... ")])),_:1})),s[28]||(s[28]=p(`<h3 id="_7-2-changeset-文件结构" tabindex="-1">7.2 Changeset 文件结构 <a class="header-anchor" href="#_7-2-changeset-文件结构" aria-label="Permalink to &quot;7.2 Changeset 文件结构&quot;">​</a></h3><div class="language-markdown vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">---</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;@gdesign/package-a&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">minor</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;@gdesign/package-b&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">patch</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">---</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">添加新功能并修复 bug</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> feat: 添加 XX 功能</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fix: 修复 YY 问题</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_7-3-版本发布策略" tabindex="-1">7.3 版本发布策略 <a class="header-anchor" href="#_7-3-版本发布策略" aria-label="Permalink to &quot;7.3 版本发布策略&quot;">​</a></h3><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// package.json - changeset scripts</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeset&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;echo &#39;对 Cursor 说：创建变更集&#39; &amp;&amp; exit 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeset:publish&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;pnpm publish -r --filter=!@app/* --no-git-checks &amp;&amp; changeset tag&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeset:snapshot:enter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;touch .changeset/snapshot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeset:snapshot:exit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rm -f .changeset/snapshot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeset:snapshot:publish&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;pnpm publish -r --filter=!@app/* --no-git-checks&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeset:snapshot:version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeset version --snapshot snapshot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeset:version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;changeset version&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>发布模式</strong>:</p><ol><li><p><strong>正式发布</strong>: <code>changeset:publish</code></p><ul><li>发布到公开/私有 NPM Registry</li><li>创建 Git Tag</li><li>更新 CHANGELOG</li></ul></li><li><p><strong>快照发布</strong>: <code>changeset:snapshot:*</code></p><ul><li>用于预发布和测试</li><li>版本号如: <code>1.2.3-snapshot-20260116</code></li><li>不创建 Git Tag</li></ul></li></ol><h3 id="_7-4-应用包与库包的发布差异" tabindex="-1">7.4 应用包与库包的发布差异 <a class="header-anchor" href="#_7-4-应用包与库包的发布差异" aria-label="Permalink to &quot;7.4 应用包与库包的发布差异&quot;">​</a></h3><p><strong>库包</strong> (<code>packages/</code>, <code>domains/</code>):</p><ul><li>发布到 NPM Registry</li><li>创建 Git Tag</li><li>生成 CHANGELOG</li></ul><p><strong>应用包</strong> (<code>apps/</code>):</p><ul><li><strong>不发布到 NPM</strong> (<code>--filter=!@app/*</code>)</li><li>仍创建 Git Tag (用于部署追踪)</li><li>版本号用于部署标识</li></ul><hr><h2 id="_8-部署系统" tabindex="-1">8. 部署系统 <a class="header-anchor" href="#_8-部署系统" aria-label="Permalink to &quot;8. 部署系统&quot;">​</a></h2><h3 id="_8-1-容器化部署" tabindex="-1">8.1 容器化部署 <a class="header-anchor" href="#_8-1-容器化部署" aria-label="Permalink to &quot;8.1 容器化部署&quot;">​</a></h3><h4 id="_8-1-1-dockerfile-示例" tabindex="-1">8.1.1 Dockerfile 示例 <a class="header-anchor" href="#_8-1-1-dockerfile-示例" aria-label="Permalink to &quot;8.1.1 Dockerfile 示例&quot;">​</a></h4><div class="language-dockerfile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># apps/example-app/Dockerfile</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Base image</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#----------------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gaoding-registry-vpc.cn-hangzhou.cr.aliyuncs.com/gaodingx/base-image:node-20-onbuild </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TZ=Asia/Shanghai</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PNPM_HOME=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/pnpm&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PATH=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$PNPM_HOME:$PATH&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COREPACK_NPM_REGISTRY=https://npm-mirror.gaoding.com</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NPM_CONFIG_REGISTRY=https://npm-mirror.gaoding.com</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COREPACK_DEFAULT_TO_LATEST=0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> npm install --global corepack@latest</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> corepack enable</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> corepack prepare pnpm@10.24.0 --activate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Runner stage</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#----------------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> runner</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NODE_ENV=production</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ARG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FLAGS_SECRET</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> FLAGS_SECRET=\${FLAGS_SECRET}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /app</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> .pruned/apps/example-app .</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">EXPOSE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 80</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CMD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ./docker-entrypoint.sh start</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HEALTHCHECK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --interval=15s --timeout=1s --start-period=60s --retries=5 \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    CMD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> curl -f http://localhost/health || exit 1</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>多阶段构建</strong>:</p><ol><li><strong>Base Stage</strong>: 准备基础环境 (Node.js, pnpm)</li><li><strong>Runner Stage</strong>: 复制构建产物并运行</li></ol><h4 id="_8-1-2-镜像构建流程" tabindex="-1">8.1.2 镜像构建流程 <a class="header-anchor" href="#_8-1-2-镜像构建流程" aria-label="Permalink to &quot;8.1.2 镜像构建流程&quot;">​</a></h4>`,19)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1534",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5BSource%20Code%5D%20--%3E%20B%5Bpnpm%20run%20deliverable%5D%0A%20%20%20%20B%20--%3E%20C%5B%E7%94%9F%E6%88%90%20.pruned%20%E7%9B%AE%E5%BD%95%5D%0A%20%20%20%20C%20--%3E%20D%5Bdocker%20build%5D%0A%20%20%20%20D%20--%3E%20E%5B%E6%8E%A8%E9%80%81%E5%88%B0%20Registry%5D%0A%20%20%20%20E%20--%3E%20F%5BK8s%20%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%5D%0A%20%20%20%20F%20--%3E%20G%5B%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%5D%0A%0A%20%20%20%20style%20C%20fill%3A%23e1f5ff%0A%20%20%20%20style%20E%20fill%3A%23fff4e6%0A%20%20%20%20style%20G%20fill%3A%23c8e6c9%0A"})]),fallback:a(()=>s[13]||(s[13]=[i(" Loading... ")])),_:1})),s[29]||(s[29]=r("p",null,[r("strong",null,[r("code",null,".pruned"),i(" 目录")]),i(":")],-1)),s[30]||(s[30]=r("p",null,[i("使用 "),r("code",null,"pnpm deploy"),i(" 或类似工具生成精简的依赖树,只包含运行时需要的依赖,减小镜像体积。")],-1)),s[31]||(s[31]=r("h3",{id:"_8-2-静态资源部署",tabindex:"-1"},[i("8.2 静态资源部署 "),r("a",{class:"header-anchor",href:"#_8-2-静态资源部署","aria-label":'Permalink to "8.2 静态资源部署"'},"​")],-1)),s[32]||(s[32]=r("p",null,[r("strong",null,"OSS + CDN 架构"),i(":")],-1)),(n(),e(h,null,{default:a(()=>[t(l,{id:"mermaid-1547",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20A%5BCI%2FCD%20Pipeline%5D%20--%3E%7C%E4%B8%8A%E4%BC%A0%7C%20B%5BOSS%20Bucket%5D%0A%20%20%20%20B%20--%3E%7C%E5%90%8C%E6%AD%A5%7C%20C%5BCDN%20%E8%8A%82%E7%82%B9%5D%0A%0A%20%20%20%20D%5B%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%5D%20--%3E%7C%E5%B0%B1%E8%BF%91%E8%AE%BF%E9%97%AE%7C%20C%0A%20%20%20%20C%20--%3E%7C%E7%BC%93%E5%AD%98%E6%9C%AA%E5%91%BD%E4%B8%AD%7C%20B%0A%0A%20%20%20%20style%20B%20fill%3A%23fff3e0%0A%20%20%20%20style%20C%20fill%3A%23e3f2fd%0A"})]),fallback:a(()=>s[14]||(s[14]=[i(" Loading... ")])),_:1})),s[33]||(s[33]=p(`<p><strong>部署脚本示例</strong>:</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 简化的部署逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> deployStatic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OSS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ali-oss&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OSS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    accessKeyId: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OSS_ACCESS_KEY_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    accessKeySecret: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OSS_ACCESS_KEY_SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    bucket: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gaoding-static&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    endpoint: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OSS_ENDPOINT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 上传构建产物</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uploadDir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dist/client&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;app/v1.0.0/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, client);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 刷新 CDN 缓存</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> refreshCDN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://cdn.gaoding.com/app/v1.0.0/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_8-3-多环境配置" tabindex="-1">8.3 多环境配置 <a class="header-anchor" href="#_8-3-多环境配置" aria-label="Permalink to &quot;8.3 多环境配置&quot;">​</a></h3><p><strong>环境变量注入</strong>:</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 通过环境变量控制运行时行为</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  apiEndpoint:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_API_ENV</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;prod&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;https://api.gaoding.com&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_API_ENV</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;stage&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;https://api-stage.gaoding.com&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;https://api-fat.gaoding.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  enableDebug: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NODE_ENV</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;production&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  featureFlags: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FLAGS_SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><hr><h2 id="_9-最佳实践与优化" tabindex="-1">9. 最佳实践与优化 <a class="header-anchor" href="#_9-最佳实践与优化" aria-label="Permalink to &quot;9. 最佳实践与优化&quot;">​</a></h2><h3 id="_9-1-ci-cd-性能优化" tabindex="-1">9.1 CI/CD 性能优化 <a class="header-anchor" href="#_9-1-ci-cd-性能优化" aria-label="Permalink to &quot;9.1 CI/CD 性能优化&quot;">​</a></h3><h4 id="_9-1-1-缓存优化" tabindex="-1">9.1.1 缓存优化 <a class="header-anchor" href="#_9-1-1-缓存优化" aria-label="Permalink to &quot;9.1.1 缓存优化&quot;">​</a></h4><p><strong>依赖缓存</strong>:</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># GitLab CI 缓存配置示例</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm-lock.yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.pnpm-store/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">node_modules/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>Turbo 缓存</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 启用远程缓存</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;TURBO_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;your-token&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;TURBO_TEAM&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;gaoding&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;TURBO_API&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://turbo.gaoding.com&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_9-1-2-并行化策略" tabindex="-1">9.1.2 并行化策略 <a class="header-anchor" href="#_9-1-2-并行化策略" aria-label="Permalink to &quot;9.1.2 并行化策略&quot;">​</a></h4><p><strong>Job 并行</strong>:</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 同一 stage 内的 job 可以并行执行</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">test:unit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">test</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm run test:unit</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">test:e2e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">test</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm run test:e2e</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>Turbo 并行</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;tasks&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;lint&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;dependsOn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 无依赖,可以并行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_9-1-3-增量构建" tabindex="-1">9.1.3 增量构建 <a class="header-anchor" href="#_9-1-3-增量构建" aria-label="Permalink to &quot;9.1.3 增量构建&quot;">​</a></h4><p><strong>基于 Git Diff</strong>:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 只测试变更的包</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">turbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --filter=[HEAD^1]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 只构建受影响的包及其依赖方</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">turbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --filter=...[HEAD^1]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_9-2-安全性" tabindex="-1">9.2 安全性 <a class="header-anchor" href="#_9-2-安全性" aria-label="Permalink to &quot;9.2 安全性&quot;">​</a></h3><h4 id="_9-2-1-敏感信息管理" tabindex="-1">9.2.1 敏感信息管理 <a class="header-anchor" href="#_9-2-1-敏感信息管理" aria-label="Permalink to &quot;9.2.1 敏感信息管理&quot;">​</a></h4><p><strong>GitLab CI Variables</strong>:</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">variables</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 通过 GitLab CI/CD Settings 配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # OSS_ACCESS_KEY_ID: (masked)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # OSS_ACCESS_KEY_SECRET: (protected)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # NPM_TOKEN: (masked)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>环境变量注入</strong>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// turbo.json</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;globalPassThroughEnv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;APOLLO_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;APP_API_ENV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;APP_ENV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_SERVER_URL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_COMMIT_REF_NAME&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_COMMIT_SHA&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_COMMIT_SHORT_SHA&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_COMMIT_TAG&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_ENVIRONMENT_TYPE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_ENVIRONMENT_INSTANCE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_JOB_URL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_MERGE_REQUEST_IID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_PIPELINE_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI_PROJECT_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;CI&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;DEPLOY_API_ORIGIN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;DEPLOY_API_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;DEPLOY_PROJECT_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;GITLAB_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;DCDN_ACCESS_KEY_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;DCDN_ACCESS_KEY_SECRET&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;DEBUG_CDN_ENV_CODE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;DEPLOY_API_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;DEV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;FLAGS_SECRET&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h4 id="_9-2-2-权限控制" tabindex="-1">9.2.2 权限控制 <a class="header-anchor" href="#_9-2-2-权限控制" aria-label="Permalink to &quot;9.2.2 权限控制&quot;">​</a></h4><p><strong>分支保护</strong>:</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// merge-versions-mr.mjs 中的分支保护逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateBranchProtection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">branchName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> body</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    allowed_to_push: options.allowedToPush,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    allowed_to_merge: options.allowedToMerge,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    code_owner_approval_required: options.codeOwnerApprovalRequired,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    allow_force_push: options.allowForcePush,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> gitlabApi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;PATCH&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`/projects/\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CI_PROJECT_ID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}/protected_branches/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">branchName</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, body);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_9-3-可观测性" tabindex="-1">9.3 可观测性 <a class="header-anchor" href="#_9-3-可观测性" aria-label="Permalink to &quot;9.3 可观测性&quot;">​</a></h3><h4 id="_9-3-1-日志管理" tabindex="-1">9.3.1 日志管理 <a class="header-anchor" href="#_9-3-1-日志管理" aria-label="Permalink to &quot;9.3.1 日志管理&quot;">​</a></h4><p><strong>结构化日志</strong>:</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 标准化的日志格式</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">level</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;info&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;warn&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      timestamp: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toISOString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      level,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      message,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      jobId: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CI_JOB_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      pipelineId: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CI_PIPELINE_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">meta,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_9-3-2-监控指标" tabindex="-1">9.3.2 监控指标 <a class="header-anchor" href="#_9-3-2-监控指标" aria-label="Permalink to &quot;9.3.2 监控指标&quot;">​</a></h4><p><strong>关键指标</strong>:</p><table tabindex="0"><thead><tr><th>指标</th><th>说明</th><th>目标值</th></tr></thead><tbody><tr><td><strong>Pipeline Duration</strong></td><td>完整流程耗时</td><td>&lt; 15 min</td></tr><tr><td><strong>Build Cache Hit Rate</strong></td><td>Turbo 缓存命中率</td><td>&gt; 80%</td></tr><tr><td><strong>Test Coverage</strong></td><td>代码覆盖率</td><td>&gt; 70%</td></tr><tr><td><strong>Deployment Success Rate</strong></td><td>部署成功率</td><td>&gt; 99%</td></tr><tr><td><strong>MTTR</strong></td><td>平均修复时间</td><td>&lt; 30 min</td></tr></tbody></table><h4 id="_9-3-3-性能分析" tabindex="-1">9.3.3 性能分析 <a class="header-anchor" href="#_9-3-3-性能分析" aria-label="Permalink to &quot;9.3.3 性能分析&quot;">​</a></h4><p><strong>Turbo 分析报告</strong>:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 生成性能分析报告</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scripts/turbo-analyzer/turbo-with-report.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> turbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看报告</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .turbo/runs/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">run-i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/summary.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_9-4-故障处理" tabindex="-1">9.4 故障处理 <a class="header-anchor" href="#_9-4-故障处理" aria-label="Permalink to &quot;9.4 故障处理&quot;">​</a></h3><h4 id="_9-4-1-回滚策略" tabindex="-1">9.4.1 回滚策略 <a class="header-anchor" href="#_9-4-1-回滚策略" aria-label="Permalink to &quot;9.4.1 回滚策略&quot;">​</a></h4><p><strong>快速回滚</strong>:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 回滚到上一个版本</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> revert</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">commit-has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或使用 Git Tag 重新部署</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> checkout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1.0.0</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 触发部署流程</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>灰度回滚</strong>:</p><ol><li>减少新版本的流量权重</li><li>观察错误率和性能指标</li><li>完全切换到旧版本</li><li>修复问题后重新发布</li></ol><h4 id="_9-4-2-常见问题" tabindex="-1">9.4.2 常见问题 <a class="header-anchor" href="#_9-4-2-常见问题" aria-label="Permalink to &quot;9.4.2 常见问题&quot;">​</a></h4><p><strong>问题1: Pipeline 超时</strong></p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 增加 timeout</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">auto publish versions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">35m</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 默认 1h</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>问题2: 缓存不一致</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 清除本地缓存</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .turbo/cache</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 清除远程缓存 (谨慎使用)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">turbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --force</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>问题3: 版本 MR 无限循环</strong></p><p>使用 <code>resource_group</code> 和分支冻结机制解决,如前文所述。</p><hr><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>稿定前端超级仓库的 CI/CD 系统是一个<strong>高度自动化、模块化、可扩展</strong>的现代化工程体系:</p><h3 id="核心优势" tabindex="-1">核心优势 <a class="header-anchor" href="#核心优势" aria-label="Permalink to &quot;核心优势&quot;">​</a></h3><ol><li><p><strong>自动化优先</strong></p><ul><li>GitLab MR Bot 实现代码自动维护</li><li>Changesets 自动化版本管理和发布</li><li>自动合并版本 MR,减少人工干预</li></ul></li><li><p><strong>高性能构建</strong></p><ul><li>Turbo 增量构建和智能缓存</li><li>并行执行最大化资源利用</li><li>远程缓存共享加速团队协作</li></ul></li><li><p><strong>多环境支持</strong></p><ul><li>Review/Staging/Production 环境隔离</li><li>基于 MR 的临时预览环境</li><li>灵活的环境变量配置</li></ul></li><li><p><strong>完善的质量保障</strong></p><ul><li>多阶段检查 (Lint、Test、Verify)</li><li>自动化测试覆盖</li><li>部署后验证</li></ul></li><li><p><strong>可观测性强</strong></p><ul><li>Turbo Analyzer 性能分析</li><li>结构化日志</li><li>完整的 artifacts 保存</li></ul></li></ol><h3 id="技术亮点" tabindex="-1">技术亮点 <a class="header-anchor" href="#技术亮点" aria-label="Permalink to &quot;技术亮点&quot;">​</a></h3><ul><li><strong>分支冻结机制</strong>: 创新性地解决版本 MR 无限循环问题</li><li><strong>组件化 Pipeline</strong>: 复用性强,易于维护</li><li><strong>Monorepo 最佳实践</strong>: pnpm + Turbo + Changesets 黄金组合</li><li><strong>渐进式部署</strong>: 支持灰度、蓝绿、金丝雀等多种策略</li></ul><h3 id="持续改进方向" tabindex="-1">持续改进方向 <a class="header-anchor" href="#持续改进方向" aria-label="Permalink to &quot;持续改进方向&quot;">​</a></h3><ol><li><strong>进一步提升缓存命中率</strong>: 优化依赖结构,减少不必要的重新构建</li><li><strong>更精细的测试策略</strong>: 基于代码变更智能选择测试用例</li><li><strong>可视化监控面板</strong>: 实时展示 Pipeline 状态和性能指标</li><li><strong>成本优化</strong>: 合理分配 CI 资源,减少不必要的计算</li></ol><hr><h2 id="附录" tabindex="-1">附录 <a class="header-anchor" href="#附录" aria-label="Permalink to &quot;附录&quot;">​</a></h2><h3 id="a-常用命令速查" tabindex="-1">A. 常用命令速查 <a class="header-anchor" href="#a-常用命令速查" aria-label="Permalink to &quot;A. 常用命令速查&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 本地开发</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               # 安装依赖</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # 启动开发服务器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            # 构建所有包</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build:apps</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # 只构建应用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build:libs</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # 只构建库</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 代码质量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lint</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             # 运行 lint</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lint:fix</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         # 自动修复 lint 问题</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> check-type</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # 类型检查</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             # 运行测试</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 版本管理</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> changeset</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 创建 changeset</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> changeset:version</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 更新版本号</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> changeset:publish</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 发布到 NPM</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 部署</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deliverable</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 生成制品</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy:review</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 部署到 Review 环境</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy:staging</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # 部署到 Staging 环境</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy:production</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 部署到生产环境</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="b-相关资源" tabindex="-1">B. 相关资源 <a class="header-anchor" href="#b-相关资源" aria-label="Permalink to &quot;B. 相关资源&quot;">​</a></h3><ul><li><a href="https://turbo.build/repo/docs" target="_blank" rel="noreferrer">Turbo 官方文档</a></li><li><a href="https://github.com/changesets/changesets" target="_blank" rel="noreferrer">Changesets 官方文档</a></li><li><a href="https://pnpm.io/" target="_blank" rel="noreferrer">pnpm 官方文档</a></li><li><a href="https://docs.gitlab.com/ee/ci/" target="_blank" rel="noreferrer">GitLab CI/CD 文档</a></li></ul><hr><p><strong>文档版本</strong>: v1.0.0<br><strong>最后更新</strong>: 2026-01-16<br><strong>维护者</strong>: 稿定科技前端架构团队</p>`,70))])}const m=k(g,[["render",o]]);export{A as __pageData,m as default};
