import{_ as e,c as o,o as u,a8 as a}from"./chunks/framework.LvkWsMUa.js";const _=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"work/sms/back.md","filePath":"work/sms/back.md","lastUpdated":1762824279000}'),q={name:"work/sms/back.md"};function s(d,t,r,n,i,m){return u(),o("div",null,[...t[0]||(t[0]=[a(`<p>一、变更概述 本次优化将消息系统重构为三个独立的 Tab：系统消息（官方消息）、动态消息、私信。主要变更包括：</p><ol><li>新增统一未读数统计接口</li><li>系统消息支持 MC extend 扩展字段</li><li>新增私信列表接口（支持分页和未读过滤）</li><li>为每个消息类型提供一键已读接口 二、消息分类说明 2.1 系统消息（官方消息） 定义：来自平台官方的通知消息 包含类型： ● 公开系统消息：所有用户可见的公告、通知 ● 私有系统消息：发送给特定用户的消息 ● MC 系统消息：来自 MC 服务的消息（新增 extend 字段支持） 相关接口： ● GET /system_dm：查询系统消息列表 ● POST /system_dm/read_all：一键已读（新增） 2.2 动态消息 定义：用户相关的社交动态通知 包含类型： ● mentions（@提及）：别人@了你的消息 ● activities（动态）：关注、点赞、转采等操作通知 相关接口： ● GET /message：查询动态消息列表 ● POST /message/read_all：一键已读（新增） 2.3 私信消息 定义：用户之间的一对一私信对话 相关接口： ● GET /dm/list：查询私信列表（新增，推荐使用） ● GET /dm：原有接口（保留，但不推荐） ● POST /dm/read_all：一键已读 三、接口变更详情 3.1 统一未读数统计接口（新增） 接口地址： GET /messages/unreads 变更类型： 新增接口 功能说明： ● 一次请求获取三个 Tab（系统消息、动态消息、私信）的未读数统计 ● 支持可选的私信每个对方的未读数详情 请求参数： 参数 类型 必填 说明 include_dm_detail String 否 是否包含私信每个对方的未读数，值为 1 或 true 响应示例： 基础响应： { &quot;system&quot;: { &quot;total&quot;: 10, &quot;public_unread&quot;: 5, &quot;private_unread&quot;: 3, &quot;mc_unread&quot;: 2 }, &quot;dynamic&quot;: { &quot;total&quot;: 8, &quot;mentions&quot;: 3, &quot;activities&quot;: 5 }, &quot;dm&quot;: { &quot;total&quot;: 6 } }</li></ol><p>包含私信详情（include_dm_detail=1）： { &quot;system&quot;: {...}, &quot;dynamic&quot;: {...}, &quot;dm&quot;: { &quot;total&quot;: 6, &quot;by_user&quot;: [ {&quot;user_id&quot;: 123, &quot;unread_count&quot;: 3}, {&quot;user_id&quot;: 456, &quot;unread_count&quot;: 2} ] } }</p><p>字段说明： system（系统消息未读数）： ● total：总未读数 ● public_unread：公开系统消息未读数 ● private_unread：私有系统消息未读数 ● mc_unread：MC 系统消息未读数 dynamic（动态消息未读数）： ● total：总未读数 ● mentions：@提及未读数 ● activities：动态未读数 dm（私信未读数）： ● total：总未读数 ● ○ user_id：对方用户 ID ○ unread_count：该对方的未读消息数</p><p>3.2 系统消息接口增强 接口地址： GET /system_dm 变更类型： 功能增强 变更说明： ● 新增 extend 字段支持：MC 系统消息现在会返回 extend 扩展字段 ● 新增 source 字段：标识消息来源（mc 表示来自 MC 服务） 请求参数： 参数 类型 必填 说明 limit Number 否 每页数量，默认 20 响应示例： { &quot;messages&quot;: [ { &quot;system_dm_id&quot;: 123, &quot;text&quot;: &quot;系统通知内容&quot;, &quot;to_user_id&quot;: 1001, &quot;created_at&quot;: 1234567890, &quot;extend&quot;: { &quot;title&quot;: &quot;消息标题&quot;, &quot;template_id&quot;: &quot;1001&quot;, // 消息模版 ID（字符串格式） &quot;cover_url&quot;: &quot;<a href="https://example.com/signed-cover.jpg" target="_blank" rel="noreferrer">https://example.com/signed-cover.jpg</a>&quot;, // 封面图 URL（已签名） &quot;icon_url&quot;: &quot;<a href="https://example.com/signed-icon.png" target="_blank" rel="noreferrer">https://example.com/signed-icon.png</a>&quot;, // 消息 icon URL（已签名，从模版获取）</p><pre><code>     &quot;contents&quot;: &quot;[{\\&quot;content_id\\&quot;:2001,\\&quot;content_url\\&quot;:\\&quot;https://example.com/signed-content/2001\\&quot;,\\&quot;content_cover_url\\&quot;:\\&quot;https://example.com/signed-content/2001/cover.jpg\\&quot;}]&quot;,  // 内容列表（JSON字符串，已签名）

     &quot;need_strong_remind&quot;: &quot;true&quot;  // 是否需要强提醒（字符串格式的布尔值，true时前端展示消息浮窗）
  },
  &quot;source&quot;: &quot;mc&quot;
},
{
  &quot;system_dm_id&quot;: 124,
  &quot;text&quot;: &quot;本地系统消息&quot;,
  &quot;to_user_id&quot;: null,
  &quot;created_at&quot;: 1234567880,
  &quot;extend&quot;: null,
  &quot;source&quot;: &quot;local&quot;
}
</code></pre><p>] }</p><p>extend 字段说明： ● 同稿定测 重要提示： ● extend 字段仅在 MC 消息时存在，本地消息为 null ● 前端需要根据 extend 字段动态渲染消息样式</p><p>3.3 系统消息一键已读（新增） 接口地址： POST /system_dm/read_all 变更类型： 新增接口 功能说明： ● 标记所有系统消息为已读（包括本地消息和 MC 消息） 请求参数： 无 响应示例： { &quot;success&quot;: true, &quot;message&quot;: &quot;已将所有系统消息标记为已读&quot; }</p><p>3.4 动态消息一键已读（新增） 接口地址： POST /message/read_all 变更类型： 新增接口 功能说明： ● 标记所有动态消息为已读（包括 mentions 和 activities） ● 支持指定类型标记已读 请求参数： 参数 类型 必填 说明 type String 否 消息类型，可选值：all、mentions、activities，默认 all 响应示例： { &quot;success&quot;: true, &quot;message&quot;: &quot;已将所有消息标记为已读&quot; }</p><p>3.5 私信每个对方未读数（新增） 接口地址： GET /dm/unreads/by_user 变更类型： 新增接口 功能说明： ● 获取每个私信对方的未读消息数量 ● 用于在私信列表中显示每个对话的未读徽章 请求参数： 无 响应示例： { &quot;unread_counts&quot;: [ {&quot;user_id&quot;: 123, &quot;unread_count&quot;: 3}, {&quot;user_id&quot;: 456, &quot;unread_count&quot;: 2} ] }</p><p>3.6 私信列表接口（新增，推荐） 接口地址： GET /dm/list 变更类型： 新增接口 功能说明： ● 私信会话列表查询（不包含系统消息） ● 支持分页（页码分页 + 游标分页） ● 支持未读过滤 ● 支持返回每个对方的未读数 ● 自动过滤空会话 请求参数： 参数 类型 必填 说明 page Number 否 页码，从 1 开始，默认 1 limit Number 否 每页数量，默认 20 max Number 否 游标值（updated_at），用于游标分页 unread_only String 否 只查询未读，值为 1 或 true include_unread_count String 否 包含每个对方的未读数，值为 1 或 true 响应示例： { &quot;conversations&quot;: [ { &quot;conversation_id&quot;: 123, &quot;user_id&quot;: 1001, &quot;with_user_id&quot;: 2001, &quot;updated_at&quot;: 1234567890, &quot;blocked&quot;: 0, &quot;hidden&quot;: 0, &quot;unread&quot;: true, &quot;unread_count&quot;: 5, &quot;last_message&quot;: { &quot;direct_message_id&quot;: 456, &quot;from_user_id&quot;: 2001, &quot;to_user_id&quot;: 1001, &quot;text&quot;: &quot;最后一条消息内容&quot;, &quot;created_at&quot;: 1234567890 }, &quot;with_user&quot;: { &quot;user_id&quot;: 2001, &quot;username&quot;: &quot;username&quot;, &quot;urlname&quot;: &quot;urlname&quot;, &quot;avatar&quot;: { &quot;id&quot;: 123, &quot;type&quot;: &quot;image/jpeg&quot;, &quot;farm&quot;: &quot;farm1&quot;, &quot;bucket&quot;: &quot;hbimg&quot;, &quot;key&quot;: &quot;avatar_key&quot;, &quot;width&quot;: 100, &quot;height&quot;: 100 } } } ], &quot;pagination&quot;: { &quot;page&quot;: 1, &quot;limit&quot;: 20, &quot;has_more&quot;: true, &quot;next_max&quot;: 1234567890 } }</p><p>字段说明： conversations（会话列表）： ● conversation_id：会话 ID ● user_id：当前用户 ID ● with_user_id：对方用户 ID ● updated_at：最后更新时间戳 ● blocked：是否屏蔽（0-否，1-是） ● hidden：是否隐藏（0-否，1-是） ● unread：是否有未读消息 ● unread_count：未读数量（需要 include_unread_count=1） ● last_message：最后一条消息对象 ● with_user：对方用户信息对象 pagination（分页信息）： ● page：当前页码 ● limit：每页数量 ● has_more：是否还有更多数据 ● next_max：下一页的游标值（用于游标分页） 分页方式说明：</p><ol><li><p>页码分页（不推荐，深度分页性能差）： GET /dm/list?page=1&amp;limit=20 GET /dm/list?page=2&amp;limit=20</p></li><li><p>游标分页（推荐，性能好）： GET /dm/list?limit=20 GET /dm/list?max=1234567890&amp;limit=20</p></li></ol><p>3.7 私信一键已读 接口地址： POST /dm/read_all 变更类型： 接口优化（原有 GET 接口保留） 功能说明： ● 标记所有私信为已读 ● 提供 POST 方法（推荐使用） 请求参数： 无 响应示例： { &quot;success&quot;: true, &quot;message&quot;: &quot;已将所有私信标记为已读&quot; }</p><p>备注： ● GET /dm/read_all 接口仍然保留，但推荐使用 POST 方法 ● POST 方法更符合 RESTful 规范（修改操作应使用 POST/PUT）</p><p>四、接口兼容性说明 4.1 保留的旧接口 以下接口保持向后兼容，前端可继续使用： 接口 说明 状态 GET /dm 获取私信列表（混合系统消息） ✅ 保留，但不推荐 GET /system_dm 获取系统消息 ✅ 保留，功能增强 GET /message 获取动态消息 ✅ 保留 GET /dm/unread 获取私信未读数 ✅ 保留 GET /message/unreads 获取动态消息未读数 ✅ 保留 GET /dm/read_all 私信一键已读（GET 方法） ✅ 保留 4.2 新增接口 接口 说明 优先级 GET /messages/unreads 统一未读数统计 ⭐⭐⭐ 推荐 GET /dm/list 私信列表（优化版） ⭐⭐⭐ 推荐 GET /dm/unreads/by_user 每个对方的未读数 ⭐⭐ 按需使用 POST /system_dm/read_all 系统消息一键已读 ⭐⭐⭐ 推荐 POST /message/read_all 动态消息一键已读 ⭐⭐⭐ 推荐 POST /dm/read_all 私信一键已读（POST 方法） ⭐⭐⭐ 推荐 4.3 功能增强的接口 接口 变更内容 影响 GET /system_dm 新增 extend 和 source 字段 ✅ 向后兼容</p><p>五、迁移指南 5.1 推荐的接口使用方案 场景 1：获取所有未读数 旧方案：需要调用 3 个接口 GET /dm/unread → 私信未读数 GET /message/unreads → 动态消息未读数 GET /system_dm (需自行统计) → 系统消息未读数</p><p>新方案：调用 1 个接口（推荐） GET /messages/unreads → 获取三个 Tab 的未读数</p><p>场景 2：获取私信列表 旧方案： GET /dm → 混合了系统消息和私信</p><p>新方案：（推荐） GET /dm/list → 纯私信列表，功能更丰富</p><p>场景 3：一键已读 旧方案： GET /dm/read_all → 使用 GET 方法</p><p>新方案：（推荐） POST /dm/read_all → 使用 POST 方法，更规范 POST /system_dm/read_all → 系统消息一键已读 POST /message/read_all → 动态消息一键已读</p><p>5.2 系统消息 extend 字段处理 前端需要适配 extend 字段的展示： // 处理系统消息 messages.forEach(msg =&gt; { if (msg.extend) { // MC 消息，有扩展字段 if (msg.extend.image) { // 显示图片 } if (msg.extend.link) { // 显示跳转按钮 } if (msg.extend.button_text) { // 自定义按钮文案 } } else { // 本地消息，只显示文本 } });</p><p>六、注意事项 6.1 性能相关</p><ol><li>统一未读数接口： ○ include_dm_detail 参数会增加查询时间，建议按需使用 ○ 建议定期轮询（如 30 秒），避免频繁请求</li><li>私信列表接口： ○ 推荐使用游标分页（max 参数）而不是页码分页 ○ include_unread_count 会增加数据库查询，按需使用</li><li>一键已读操作： ○ 执行后建议重新获取未读数统计 ○ 避免短时间内重复调用 6.2 数据一致性</li><li>未读数可能存在延迟： ○ Redis 和数据库之间可能有短暂不一致 ○ 建议使用乐观更新策略</li><li>系统消息的 extend 字段： ○ 需要判空处理，避免前端报错 ○ 本地消息的 extend 字段为 null 6.3 错误处理 所有接口都应该包含错误处理： fetch(&#39;/messages/unreads&#39;) .then(res =&gt; { if (!res.ok) { throw new Error(&#39;Network response was not ok&#39;); } return res.json(); }) .then(data =&gt; { // 处理数据 }) .catch(error =&gt; { console.error(&#39;Error:&#39;, error); // 降级处理 });</li></ol><p>七、常见问题 Q1: 为什么要区分三个 Tab？ A: 提升用户体验，让用户能快速定位不同类型的消息。系统消息是官方通知，动态消息是社交互动，私信是私密对话，三者性质不同，分开展示更清晰。 Q2: extend 字段什么时候有值？ A: 只有来自 MC 服务的系统消息才有 extend 字段，本地系统消息的 extend 为 null。可以通过 source 字段判断来源。 Q3: 应该使用哪个私信列表接口？ A: 推荐使用新的 GET /dm/list 接口，功能更丰富，支持分页和未读过滤。旧的 GET /dm 接口会混合系统消息，不够清晰。 Q4: 如何实现实时未读数更新？ A: 可以使用定期轮询（如 30 秒）调用 GET /messages/unreads 接口，或者后续实现 WebSocket 推送机制。 Q5: 游标分页和页码分页有什么区别？ A: ● 页码分页：page=1, page=2...，深度分页性能差，可能出现数据重复或遗漏 ● 游标分页（推荐）：使用 max 参数，基于时间戳，性能好，数据一致性高</p><p>八、相关文档 ● 详细设计方案 ● API 文档 ● 项目规范</p><p>附录：快速参考 接口对照表 功能 旧接口 新接口（推荐） 获取所有未读数 需调用多个接口 GET /messages/unreads 获取私信列表 GET /dm GET /dm/list 系统消息一键已读 无 POST /system_dm/read_all 动态消息一键已读 无 POST /message/read_all 私信一键已读 GET /dm/read_all POST /dm/read_all HTTP 状态码 状态码 说明 200 请求成功 400 请求参数错误 401 未授权 404 资源不存在 500 服务器内部错误</p><p>文档版本：v1.0<br> 最后更新：2024-XX-XX</p>`,30)])])}const p=e(q,[["render",s]]);export{_ as __pageData,p as default};
