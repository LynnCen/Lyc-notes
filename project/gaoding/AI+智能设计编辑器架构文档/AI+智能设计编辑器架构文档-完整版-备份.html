<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AI+ 智能设计编辑器架构文档 | 林岑LynnCenʘᴗʘ </title>
    <meta name="description" content="林岑的成长之路，包含前端常用知识、源码阅读笔记、各种奇淫技巧、日常提效工具等">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/Lyc-notes/assets/style.DdM4shd-.css" as="style">
    <link rel="preload stylesheet" href="/Lyc-notes/vp-icons.css" as="style">
    
    <script type="module" src="/Lyc-notes/assets/app.CvsFAhzj.js"></script>
    <link rel="preload" href="/Lyc-notes/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/framework.B1-gFi6y.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/theme.BeYjvpbJ.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/katex.CfZphoad.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/dagre-QXRM2OYR.CSR39IKi.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/c4Diagram-7JAJQR3Y.CvxEunT1.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/flowDiagram-27HWSH3H.CYN2f8sy.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/erDiagram-MVNNDQJ5.DG10ezh5.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/gitGraphDiagram-ISGV4O2Y.BwerAg1O.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/ganttDiagram-ZCE2YOAT.Cm9mcQb4.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/infoDiagram-SDLB2J7W.DgO8d2pp.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/pieDiagram-OC6WZ2SS.CylPOV5F.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/quadrantDiagram-OT6RYTWY.5zzg3uoo.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/xychartDiagram-NJOKMNIP.YB21mfuL.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/requirementDiagram-BKGUWIPO.DJidMt8e.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/sequenceDiagram-C4VUPXDP.D_7CQN5i.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/classDiagram-L266QK7U.BvOwR_SP.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/classDiagram-v2-JRWBCVM4.BvOwR_SP.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/stateDiagram-BVO7J4UH.BPk8B9SU.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/stateDiagram-v2-WR7QG3WR.Bosh7Qsc.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/journeyDiagram-D7A75E63.CklAUsWT.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/timeline-definition-WOTUTIAU.D-81lEqN.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/mindmap-definition-7EJRZJGK.BBqZkBMM.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/kanban-definition-4GR4SRK3.-TqMojuX.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/sankeyDiagram-3MH5UGAL.BNEUTnT1.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/diagram-DHSB7DV3.D1RpdoA8.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/blockDiagram-5JUZGEFE.BBHymhJ6.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/architectureDiagram-PQUH6ZAG.CkSu55eG.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/chunks/virtual_mermaid-config.DDnGl6nM.js">
    <link rel="modulepreload" href="/Lyc-notes/assets/project_gaoding_AI_智能设计编辑器架构文档_AI_智能设计编辑器架构文档-完整版-备份.md.CGes8y1H.lean.js">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/favicon.ico">
    <link rel="mask-icon" href="/favicon.ico" color="#3eaf7c">
    <meta name="msapplication-TileImage" content="/favicon.ico">
    <meta name="msapplication-TileColor" content="#000000">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-31cf94a2><!--[--><!--]--><!--[--><span tabindex="-1" data-v-36ec46eb></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-36ec46eb>Skip to content</a><!--]--><!----><header class="VPNav" data-v-31cf94a2 data-v-3b3dad99><div class="VPNavBar" data-v-3b3dad99 data-v-6355aac1><div class="wrapper" data-v-6355aac1><div class="container" data-v-6355aac1><div class="title" data-v-6355aac1><div class="VPNavBarTitle has-sidebar" data-v-6355aac1 data-v-1dbe09c3><a class="title" href="/Lyc-notes/" data-v-1dbe09c3><!--[--><!--]--><!--[--><img class="VPImage logo" src="/Lyc-notes/LynnCenLogo.png" alt data-v-26416d94><!--]--><span data-v-1dbe09c3>林岑LynnCenʘᴗʘ </span><!--[--><!--[--><!--[--><!--[--><img class="visitor" src="https://visitor-badge.laobi.icu/badge?page_id=LynnCen.Lyc-notes" onerror="this.style.display=&#39;none&#39;" data-v-41535482><!--]--><!--]--><!--]--><!--]--></a></div></div><div class="content" data-v-6355aac1><div class="content-body" data-v-6355aac1><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6355aac1><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6355aac1 data-v-12f7eeca><span id="main-nav-aria-label" class="visually-hidden" data-v-12f7eeca> Main Navigation </span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-12f7eeca data-v-3ccf5a95><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-3ccf5a95><span class="text" data-v-3ccf5a95><!----><span data-v-3ccf5a95>WebFront</span><span class="vpi-chevron-down text-icon" data-v-3ccf5a95></span></span></button><div class="menu" data-v-3ccf5a95><div class="VPMenu" data-v-3ccf5a95 data-v-e354aaf3><div class="items" data-v-e354aaf3><!--[--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>前端基础</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/Javascript/basic/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84js" data-v-20fb6a61><!--[--><span data-v-20fb6a61>Javascript基础</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/Javascript/Advance/executionContext" data-v-20fb6a61><!--[--><span data-v-20fb6a61>Javascript进阶</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/typescript/%E8%AE%B0%E5%BD%95" data-v-20fb6a61><!--[--><span data-v-20fb6a61>Typescript</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>Framework</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/react/core/intro" data-v-20fb6a61><!--[--><span data-v-20fb6a61>React</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/Vue/basic" data-v-20fb6a61><!--[--><span data-v-20fb6a61>Vue</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>Engineering</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/webpack/performance" data-v-20fb6a61><!--[--><span data-v-20fb6a61>WebPack</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/node/packages" data-v-20fb6a61><!--[--><span data-v-20fb6a61>Node</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/vite/basic" data-v-20fb6a61><!--[--><span data-v-20fb6a61>Vite</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/git/basic" data-v-20fb6a61><!--[--><span data-v-20fb6a61>Git</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>浏览器</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/browser/Chrome%E6%9E%B6%E6%9E%84" data-v-20fb6a61><!--[--><span data-v-20fb6a61>浏览器原理</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-12f7eeca data-v-3ccf5a95><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-3ccf5a95><span class="text" data-v-3ccf5a95><!----><span data-v-3ccf5a95>ComputerBasics</span><span class="vpi-chevron-down text-icon" data-v-3ccf5a95></span></span></button><div class="menu" data-v-3ccf5a95><div class="VPMenu" data-v-3ccf5a95 data-v-e354aaf3><div class="items" data-v-e354aaf3><!--[--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>计算机组成原理</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/chapter1" data-v-20fb6a61><!--[--><span data-v-20fb6a61>计算机组成原理基础</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>数据结构</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/dataStructure/chapter1" data-v-20fb6a61><!--[--><span data-v-20fb6a61>数据结构基础</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/dataStructure/chapter1_ex" data-v-20fb6a61><!--[--><span data-v-20fb6a61>课后习题</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>操作系统OS</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/os/chapter1" data-v-20fb6a61><!--[--><span data-v-20fb6a61>操作系统基础</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>计算机网络</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/%E8%AE%A1%E7%BD%91/chapter1" data-v-20fb6a61><!--[--><span data-v-20fb6a61>计算机网络基础</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>408</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/408/2009" data-v-20fb6a61><!--[--><span data-v-20fb6a61>408真题</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuLink" data-v-e354aaf3 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/designPatterns/index" data-v-20fb6a61><!--[--><span data-v-20fb6a61>设计模式</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-12f7eeca data-v-3ccf5a95><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-3ccf5a95><span class="text" data-v-3ccf5a95><!----><span data-v-3ccf5a95>AI</span><span class="vpi-chevron-down text-icon" data-v-3ccf5a95></span></span></button><div class="menu" data-v-3ccf5a95><div class="VPMenu" data-v-3ccf5a95 data-v-e354aaf3><div class="items" data-v-e354aaf3><!--[--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>MCP</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/AI/mcp/browserTools" data-v-20fb6a61><!--[--><span data-v-20fb6a61>BrowserTools MCP</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/AI/mcp/figma" data-v-20fb6a61><!--[--><span data-v-20fb6a61>Figma Dev Mode MCP</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>Dify</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/AI/Dify/index" data-v-20fb6a61><!--[--><span data-v-20fb6a61>Dify</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e354aaf3 data-v-05dadae9><p class="title" data-v-05dadae9>Posts</p><!--[--><!--[--><div class="VPMenuLink" data-v-05dadae9 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/posts/llm" data-v-20fb6a61><!--[--><span data-v-20fb6a61>LLM</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-12f7eeca data-v-3ccf5a95><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-3ccf5a95><span class="text" data-v-3ccf5a95><!----><span data-v-3ccf5a95>SoftExame</span><span class="vpi-chevron-down text-icon" data-v-3ccf5a95></span></span></button><div class="menu" data-v-3ccf5a95><div class="VPMenu" data-v-3ccf5a95 data-v-e354aaf3><div class="items" data-v-e354aaf3><!--[--><!--[--><div class="VPMenuLink" data-v-e354aaf3 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/softExam/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E5%B8%88/index" data-v-20fb6a61><!--[--><span data-v-20fb6a61>软考-软件设计师</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e354aaf3 data-v-20fb6a61><a class="VPLink link" href="/Lyc-notes/softExam/%E6%9E%B6%E6%9E%84%E5%B8%88/index" data-v-20fb6a61><!--[--><span data-v-20fb6a61>软考-系统架构设计师</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/Lyc-notes/interview/js" tabindex="0" data-v-12f7eeca data-v-60390558><!--[--><span data-v-60390558>Interview</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6355aac1 data-v-bf566743><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bf566743 data-v-d7e239c8 data-v-0f82579d><span class="check" data-v-0f82579d><span class="icon" data-v-0f82579d><!--[--><span class="vpi-sun sun" data-v-d7e239c8></span><span class="vpi-moon moon" data-v-d7e239c8></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6355aac1 data-v-d7f6a161 data-v-d9e68e33><!--[--><a class="VPSocialLink no-icon" href="https://github.com/LynnCen" aria-label="github" target="_blank" rel="noopener" data-v-d9e68e33 data-v-feb64ff2><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6355aac1 data-v-a003e139 data-v-3ccf5a95><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-3ccf5a95><span class="vpi-more-horizontal icon" data-v-3ccf5a95></span></button><div class="menu" data-v-3ccf5a95><div class="VPMenu" data-v-3ccf5a95 data-v-e354aaf3><!----><!--[--><!--[--><!----><div class="group" data-v-a003e139><div class="item appearance" data-v-a003e139><p class="label" data-v-a003e139>外观</p><div class="appearance-action" data-v-a003e139><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-a003e139 data-v-d7e239c8 data-v-0f82579d><span class="check" data-v-0f82579d><span class="icon" data-v-0f82579d><!--[--><span class="vpi-sun sun" data-v-d7e239c8></span><span class="vpi-moon moon" data-v-d7e239c8></span><!--]--></span></span></button></div></div></div><div class="group" data-v-a003e139><div class="item social-links" data-v-a003e139><div class="VPSocialLinks social-links-list" data-v-a003e139 data-v-d9e68e33><!--[--><a class="VPSocialLink no-icon" href="https://github.com/LynnCen" aria-label="github" target="_blank" rel="noopener" data-v-d9e68e33 data-v-feb64ff2><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6355aac1 data-v-a3c5ca32><span class="container" data-v-a3c5ca32><span class="top" data-v-a3c5ca32></span><span class="middle" data-v-a3c5ca32></span><span class="bottom" data-v-a3c5ca32></span></span></button></div></div></div></div><div class="divider" data-v-6355aac1><div class="divider-line" data-v-6355aac1></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-31cf94a2 data-v-eb11061a><div class="container" data-v-eb11061a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-eb11061a><span class="vpi-align-left menu-icon" data-v-eb11061a></span><span class="menu-text" data-v-eb11061a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-eb11061a data-v-b72df35b><button data-v-b72df35b>返回顶部</button><!----></div></div></div><aside class="VPSidebar" data-v-31cf94a2 data-v-5fcf957b><div class="curtain" data-v-5fcf957b></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-5fcf957b><span class="visually-hidden" id="sidebar-aria-label" data-v-5fcf957b> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-17d1da08><section class="VPSidebarItem level-0" data-v-17d1da08 data-v-8eaef094><!----><div class="items" data-v-8eaef094><!--[--><div class="VPSidebarItem level-1 is-link" data-v-8eaef094 data-v-8eaef094><div class="item" data-v-8eaef094><div class="indicator" data-v-8eaef094></div><a class="VPLink link link" href="/Lyc-notes/project/index" data-v-8eaef094><!--[--><p class="text" data-v-8eaef094>项目总结</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-17d1da08><section class="VPSidebarItem level-0 is-link" data-v-17d1da08 data-v-8eaef094><div class="item" tabindex="0" data-v-8eaef094><div class="indicator" data-v-8eaef094></div><a class="VPLink link link" href="/Lyc-notes/project/tmm" data-v-8eaef094><!--[--><h2 class="text" data-v-8eaef094>TMM</h2><!--]--></a><!----></div><div class="items" data-v-8eaef094><!--[--><div class="VPSidebarItem level-1 is-link" data-v-8eaef094 data-v-8eaef094><div class="item" data-v-8eaef094><div class="indicator" data-v-8eaef094></div><a class="VPLink link link" href="/Lyc-notes/project/tmm/architecture" data-v-8eaef094><!--[--><p class="text" data-v-8eaef094>TMM模块重构与架构设计</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-8eaef094 data-v-8eaef094><div class="item" data-v-8eaef094><div class="indicator" data-v-8eaef094></div><a class="VPLink link link" href="/Lyc-notes/project/tmm/local_search" data-v-8eaef094><!--[--><p class="text" data-v-8eaef094>本地化搜索引擎实现</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-8eaef094 data-v-8eaef094><div class="item" data-v-8eaef094><div class="indicator" data-v-8eaef094></div><a class="VPLink link link" href="/Lyc-notes/project/tmm/mention" data-v-8eaef094><!--[--><p class="text" data-v-8eaef094>@功能的高效实现</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-8eaef094 data-v-8eaef094><div class="item" data-v-8eaef094><div class="indicator" data-v-8eaef094></div><a class="VPLink link link" href="/Lyc-notes/project/tmm/partFileUpload" data-v-8eaef094><!--[--><p class="text" data-v-8eaef094>ELectron大文件分片上传、断点续传、并行上传</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-8eaef094 data-v-8eaef094><div class="item" data-v-8eaef094><div class="indicator" data-v-8eaef094></div><a class="VPLink link link" href="/Lyc-notes/project/tmm/performance_optimization" data-v-8eaef094><!--[--><p class="text" data-v-8eaef094>TMM性能优化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-8eaef094 data-v-8eaef094><div class="item" data-v-8eaef094><div class="indicator" data-v-8eaef094></div><a class="VPLink link link" href="/Lyc-notes/project/tmm/RBAC" data-v-8eaef094><!--[--><p class="text" data-v-8eaef094>基于RBAC模型的群组权限体系设计与实现</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-8eaef094 data-v-8eaef094><div class="item" data-v-8eaef094><div class="indicator" data-v-8eaef094></div><a class="VPLink link link" href="/Lyc-notes/project/tmm/resources_manner" data-v-8eaef094><!--[--><p class="text" data-v-8eaef094>基于AWS和Node流式大文件下载</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-31cf94a2 data-v-4f3472e4><div class="VPDoc has-sidebar has-aside" data-v-4f3472e4 data-v-19e5f4bd><!--[--><!--]--><div class="container" data-v-19e5f4bd><div class="aside" data-v-19e5f4bd><div class="aside-curtain" data-v-19e5f4bd></div><div class="aside-container" data-v-19e5f4bd><div class="aside-content" data-v-19e5f4bd><div class="VPDocAside" data-v-19e5f4bd data-v-d5b85769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-d5b85769 data-v-c8348399><div class="content" data-v-c8348399><div class="outline-marker" data-v-c8348399></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-c8348399>本页目录</div><ul class="VPDocOutlineItem root" data-v-c8348399 data-v-48e03ebb><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-d5b85769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-19e5f4bd><div class="content-container" data-v-19e5f4bd><!--[--><!--]--><main class="main" data-v-19e5f4bd><div style="position:relative;" class="vp-doc _Lyc-notes_project_gaoding_AI+%E6%99%BA%E8%83%BD%E8%AE%BE%E8%AE%A1%E7%BC%96%E8%BE%91%E5%99%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3_AI+%E6%99%BA%E8%83%BD%E8%AE%BE%E8%AE%A1%E7%BC%96%E8%BE%91%E5%99%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3-%E5%AE%8C%E6%95%B4%E7%89%88-%E5%A4%87%E4%BB%BD" data-v-19e5f4bd><div><h1 id="ai-智能设计编辑器架构文档" tabindex="-1">AI+ 智能设计编辑器架构文档 <a class="header-anchor" href="#ai-智能设计编辑器架构文档" aria-label="Permalink to &quot;AI+ 智能设计编辑器架构文档&quot;">​</a></h1><blockquote><p><strong>文档目标</strong>：深入解析 AI+ 编辑器的核心架构、设计思想与业务流程，帮助开发者快速理解系统设计</p><p><strong>适合人群</strong>：前端架构师、高级开发工程师、技术 Leader</p></blockquote><hr><h2 id="一、产品全景" tabindex="-1">一、产品全景 <a class="header-anchor" href="#一、产品全景" aria-label="Permalink to &quot;一、产品全景&quot;">​</a></h2><h3 id="_1-1-产品定位与核心价值" tabindex="-1">1.1 产品定位与核心价值 <a class="header-anchor" href="#_1-1-产品定位与核心价值" aria-label="Permalink to &quot;1.1 产品定位与核心价值&quot;">​</a></h3><p>AI+ 智能设计编辑器是一款<strong>革新设计创作方式</strong>的在线工具，通过<strong>自然语言对话</strong>降低设计门槛，让非专业用户也能快速完成专业级设计。</p><p><strong>核心价值主张</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>传统方式：学习工具 → 选择模板 → 手动调整 → 反复修改</span></span>
<span class="line"><span>AI+ 方式：描述需求 → AI 生成 → 实时预览 → 一键应用</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>差异化特性</strong>：</p><ul><li>🤖 <strong>对话式交互</strong>：告别复杂工具栏，用说话的方式完成设计</li><li>⚡ <strong>实时生成</strong>：SSE 流式响应，秒级反馈，无需等待</li><li>🎯 <strong>智能理解</strong>：理解上下文，支持连续对话式编辑</li><li>🧩 <strong>高度扩展</strong>：插件化架构，AI 能力持续迭代升级</li><li>🌍 <strong>全球化部署</strong>：国内/国际双版本，适配不同市场</li></ul><h3 id="_1-2-技术架构选型背景" tabindex="-1">1.2 技术架构选型背景 <a class="header-anchor" href="#_1-2-技术架构选型背景" aria-label="Permalink to &quot;1.2 技术架构选型背景&quot;">​</a></h3><p><strong>为什么选择这些技术？</strong></p><table tabindex="0"><thead><tr><th>技术选型</th><th>选择理由</th><th>解决的问题</th></tr></thead><tbody><tr><td><strong>Vue 2.7</strong></td><td>向后兼容 + Composition API</td><td>渐进式升级，保护现有投资</td></tr><tr><td><strong>TypeScript</strong></td><td>类型安全 + 代码提示</td><td>降低维护成本，提升开发效率</td></tr><tr><td><strong>PixiJS</strong></td><td>WebGL 高性能渲染</td><td>支持大规模元素、流畅交互</td></tr><tr><td><strong>Pinia</strong></td><td>轻量级状态管理</td><td>替代 Vuex，更好的 TS 支持</td></tr><tr><td><strong>SSE</strong></td><td>服务端推送</td><td>实现流式 AI 响应，优于轮询</td></tr><tr><td><strong>Vite</strong></td><td>快速构建 + HMR</td><td>开发体验提升 10 倍</td></tr></tbody></table><hr><h2 id="二、整体架构设计" tabindex="-1">二、整体架构设计 <a class="header-anchor" href="#二、整体架构设计" aria-label="Permalink to &quot;二、整体架构设计&quot;">​</a></h2><h3 id="_2-1-分层架构-自上而下的设计思想" tabindex="-1">2.1 分层架构 - 自上而下的设计思想 <a class="header-anchor" href="#_2-1-分层架构-自上而下的设计思想" aria-label="Permalink to &quot;2.1 分层架构 - 自上而下的设计思想&quot;">​</a></h3><p>系统采用<strong>经典的五层架构</strong>，每一层职责清晰、边界明确，便于团队协作和长期维护。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌──────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  📱 应用层 (Apps Layer)                                        │</span></span>
<span class="line"><span>│  ├─ design-ai-plus (国内版)      ← 面向中国用户              │</span></span>
<span class="line"><span>│  └─ insmind-ai-plus (国际版)     ← 面向海外用户              │</span></span>
<span class="line"><span>│  职责：环境配置、登录方式、多语言、支付对接                      │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  🎨 业务层 (Business Layer)                                   │</span></span>
<span class="line"><span>│  ├─ AI 聊天面板              ← 核心交互入口                   │</span></span>
<span class="line"><span>│  ├─ 工具栏 &amp; 属性面板        ← 传统编辑能力                   │</span></span>
<span class="line"><span>│  ├─ 历史记录 &amp; 模板库        ← 内容管理                       │</span></span>
<span class="line"><span>│  └─ 协同 &amp; 分享             ← 社交功能                        │</span></span>
<span class="line"><span>│  职责：业务功能实现、用户交互界面、产品差异化                    │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  🏗️ 基座层 (Foundation Layer)                                │</span></span>
<span class="line"><span>│  @design/design-foundation                                   │</span></span>
<span class="line"><span>│  ├─ 初始化系统 (installDesign)  ← 统一入口                   │</span></span>
<span class="line"><span>│  ├─ 配置管理                     ← API/权限/扩展              │</span></span>
<span class="line"><span>│  ├─ 生命周期管理                 ← 启动/销毁                  │</span></span>
<span class="line"><span>│  └─ 路由 &amp; 状态管理             ← 全局状态                    │</span></span>
<span class="line"><span>│  职责：提供标准化的编辑器基础设施，屏蔽底层复杂度                │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  ⚙️ 引擎层 (Engine Layer)                                     │</span></span>
<span class="line"><span>│  @editor/framework                                           │</span></span>
<span class="line"><span>│  ├─ 数据模型 (Data Model)       ← 元素/页面/模板             │</span></span>
<span class="line"><span>│  ├─ 命令系统 (Command)          ← 撤销/重做                  │</span></span>
<span class="line"><span>│  ├─ 事件系统 (Event Bus)        ← 跨模块通信                 │</span></span>
<span class="line"><span>│  └─ 插件系统 (Plugin)           ← 能力扩展                   │</span></span>
<span class="line"><span>│  职责：编辑器核心能力抽象，不依赖具体业务                        │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  🖼️ 渲染层 (Render Layer)                                     │</span></span>
<span class="line"><span>│  @editor/infinite-renderer (基于 PixiJS)                     │</span></span>
<span class="line"><span>│  ├─ 无限画布 (Infinite Canvas)  ← 无限滚动                   │</span></span>
<span class="line"><span>│  ├─ 视口管理 (Viewport)         ← 缩放/平移                  │</span></span>
<span class="line"><span>│  ├─ 虚拟化渲染                   ← 性能优化                   │</span></span>
<span class="line"><span>│  └─ WebGL 加速                  ← 硬件加速                   │</span></span>
<span class="line"><span>│  职责：高性能图形渲染，支持大规模元素流畅操作                    │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p><strong>为什么要分层？</strong></p><ol><li><strong>职责清晰</strong>：每层只关注自己的问题，降低复杂度</li><li><strong>解耦合</strong>：上层依赖下层，下层不知道上层，便于替换和测试</li><li><strong>可扩展</strong>：新增功能只需在对应层实现，不影响其他层</li><li><strong>团队协作</strong>：不同团队负责不同层，并行开发互不阻塞</li></ol><h3 id="_2-2-三大核心设计理念" tabindex="-1">2.2 三大核心设计理念 <a class="header-anchor" href="#_2-2-三大核心设计理念" aria-label="Permalink to &quot;2.2 三大核心设计理念&quot;">​</a></h3><h4 id="理念-1-基座化-foundation-based-🏗️" tabindex="-1"><strong>理念 1：基座化（Foundation-Based）</strong> 🏗️ <a class="header-anchor" href="#理念-1-基座化-foundation-based-🏗️" aria-label="Permalink to &quot;**理念 1：基座化（Foundation-Based）** 🏗️&quot;">​</a></h4><p><strong>问题</strong>：多个应用（国内版、国际版、移动版）重复实现编辑器初始化逻辑，维护成本高。</p><p><strong>解决方案</strong>：抽象出统一的&quot;基座&quot;，提供标准化的初始化流程。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>传统方式（每个应用独立实现）：</span></span>
<span class="line"><span>  App A：自己初始化 Vue → 自己配置路由 → 自己注册插件 → 自己挂载</span></span>
<span class="line"><span>  App B：自己初始化 Vue → 自己配置路由 → 自己注册插件 → 自己挂载</span></span>
<span class="line"><span>  App C：...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>基座化方式（统一入口）：</span></span>
<span class="line"><span>  所有应用：调用 installDesign(config) → 基座自动完成所有初始化</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>核心价值</strong>：</p><ul><li>✅ 减少 80% 的初始化代码</li><li>✅ 统一配置标准，避免遗漏</li><li>✅ 一处升级，所有应用受益</li></ul><h4 id="理念-2-插件化-plugin-based-🧩" tabindex="-1"><strong>理念 2：插件化（Plugin-Based）</strong> 🧩 <a class="header-anchor" href="#理念-2-插件化-plugin-based-🧩" aria-label="Permalink to &quot;**理念 2：插件化（Plugin-Based）** 🧩&quot;">​</a></h4><p><strong>问题</strong>：功能越来越多，代码耦合严重，牵一发动全身。</p><p><strong>解决方案</strong>：将功能模块拆分为独立的插件，按需加载。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>核心思想：</span></span>
<span class="line"><span>  编辑器内核（最小可运行） + N 个插件（可选功能）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  基础版 = 内核                         （画布 + 基础编辑）</span></span>
<span class="line"><span>  标准版 = 内核 + AI 插件                （+ AI 生成）</span></span>
<span class="line"><span>  企业版 = 内核 + AI + 协同 + 品牌插件    （+ 团队协作）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>插件生命周期</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>加载阶段 → 注册阶段 → 启动阶段 → 运行阶段 → 卸载阶段</span></span>
<span class="line"><span>(Load)    (Register)  (Bootstrap) (Run)     (Unmount)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>核心价值</strong>：</p><ul><li>✅ 按需加载，减少首屏体积</li><li>✅ 功能隔离，互不影响</li><li>✅ 独立开发，独立部署</li></ul><h4 id="理念-3-事件驱动-event-driven-📡" tabindex="-1"><strong>理念 3：事件驱动（Event-Driven）</strong> 📡 <a class="header-anchor" href="#理念-3-事件驱动-event-driven-📡" aria-label="Permalink to &quot;**理念 3：事件驱动（Event-Driven）** 📡&quot;">​</a></h4><p><strong>问题</strong>：模块间直接调用，形成强依赖，难以扩展和测试。</p><p><strong>解决方案</strong>：通过事件总线解耦模块间通信。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>传统方式（直接调用）：</span></span>
<span class="line"><span>  ChatPanel → 直接调用 → CanvasEditor.addImage()</span></span>
<span class="line"><span>  问题：ChatPanel 必须知道 CanvasEditor 的存在和接口</span></span>
<span class="line"><span></span></span>
<span class="line"><span>事件驱动方式：</span></span>
<span class="line"><span>  ChatPanel → 发布事件 → eventBus.emit(&#39;addImage&#39;, data)</span></span>
<span class="line"><span>  CanvasEditor → 订阅事件 → eventBus.on(&#39;addImage&#39;, handler)</span></span>
<span class="line"><span>  优势：两个模块不需要互相引用</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>核心价值</strong>：</p><ul><li>✅ 模块解耦，易于扩展</li><li>✅ 支持一对多通信</li><li>✅ 便于埋点和调试</li></ul><hr><h2 id="三、编辑器基座-万丈高楼的地基" tabindex="-1">三、编辑器基座 - 万丈高楼的地基 <a class="header-anchor" href="#三、编辑器基座-万丈高楼的地基" aria-label="Permalink to &quot;三、编辑器基座 - 万丈高楼的地基&quot;">​</a></h2><h3 id="_3-1-基座的设计哲学" tabindex="-1">3.1 基座的设计哲学 <a class="header-anchor" href="#_3-1-基座的设计哲学" aria-label="Permalink to &quot;3.1 基座的设计哲学&quot;">​</a></h3><p><strong>核心思想</strong>：把复杂的初始化流程封装成一行代码。</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 应用层只需要这一行！</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> installDesign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;#app&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, config);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>背后发生了什么？</strong>（7步标准化流程）</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>第1步：环境初始化</span></span>
<span class="line"><span>  ├─ 设置 API 域名（国内/国外）</span></span>
<span class="line"><span>  ├─ 注入环境变量（HOME_PAGE, REGION...）</span></span>
<span class="line"><span>  └─ 配置 OSS/CDN</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第2步：API 服务初始化</span></span>
<span class="line"><span>  ├─ 创建 HTTP 客户端</span></span>
<span class="line"><span>  ├─ 配置拦截器（鉴权、错误处理）</span></span>
<span class="line"><span>  └─ 注册业务 API（用户、模板、AI...）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第3步：权限系统初始化</span></span>
<span class="line"><span>  ├─ 加载权限配置</span></span>
<span class="line"><span>  ├─ 初始化权限控制器</span></span>
<span class="line"><span>  └─ 设置功能开关（哪些能力可用）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第4步：创建 Vue 应用</span></span>
<span class="line"><span>  ├─ 创建 Vue 实例</span></span>
<span class="line"><span>  ├─ 注册 Pinia（状态管理）</span></span>
<span class="line"><span>  ├─ 注册 Router（路由）</span></span>
<span class="line"><span>  └─ 注册全局组件</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第5步：插件注册</span></span>
<span class="line"><span>  ├─ 加载扩展配置（extensionConfig）</span></span>
<span class="line"><span>  ├─ 依次注册每个插件</span></span>
<span class="line"><span>  └─ 调用插件的 register 钩子</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第6步：日志服务初始化</span></span>
<span class="line"><span>  ├─ 配置日志上报（SLS）</span></span>
<span class="line"><span>  ├─ 设置错误监控</span></span>
<span class="line"><span>  └─ 初始化埋点系统</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第7步：编辑器挂载</span></span>
<span class="line"><span>  ├─ 渲染编辑器组件</span></span>
<span class="line"><span>  ├─ 初始化画布</span></span>
<span class="line"><span>  ├─ 触发 mounted 生命周期</span></span>
<span class="line"><span>  └─ 完成启动 ✅</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>为什么这样设计？</strong></p><ul><li>保证初始化顺序（有些服务依赖其他服务）</li><li>统一错误处理（任一步失败都能优雅降级）</li><li>便于扩展（新增服务只需插入对应步骤）</li></ul><h3 id="_3-2-国内版-vs-国际版-多租户架构实践" tabindex="-1">3.2 国内版 vs 国际版 - 多租户架构实践 <a class="header-anchor" href="#_3-2-国内版-vs-国际版-多租户架构实践" aria-label="Permalink to &quot;3.2 国内版 vs 国际版 - 多租户架构实践&quot;">​</a></h3><p>两个版本<strong>共享 95% 的代码</strong>，只有这些地方不同：</p><table tabindex="0"><thead><tr><th>差异维度</th><th>design-ai-plus (国内)</th><th>insmind-ai-plus (国际)</th><th>实现方式</th></tr></thead><tbody><tr><td><strong>登录</strong></td><td>手机号 + 短信验证码</td><td>Google OAuth 2.0</td><td>配置 <code>env.LOGIN_TYPE</code></td></tr><tr><td><strong>API</strong></td><td><a href="https://api.huaban.com" target="_blank" rel="noreferrer">https://api.huaban.com</a></td><td><a href="https://api.insmind.com" target="_blank" rel="noreferrer">https://api.insmind.com</a></td><td>配置 <code>env.API_BASE_URL</code></td></tr><tr><td><strong>存储</strong></td><td>阿里云 OSS</td><td>AWS S3</td><td>配置 <code>env.STORAGE_TYPE</code></td></tr><tr><td><strong>CDN</strong></td><td>国内 CDN</td><td>Cloudflare</td><td>配置 <code>env.CDN_DOMAIN</code></td></tr><tr><td><strong>AI服务</strong></td><td>国内部署模型</td><td>海外部署模型</td><td>配置 <code>env.AI_SERVICE_URL</code></td></tr><tr><td><strong>支付</strong></td><td>支付宝 + 微信支付</td><td>Stripe</td><td>配置 <code>env.PAYMENT_TYPE</code></td></tr><tr><td><strong>语言</strong></td><td>中文优先</td><td>英文优先</td><td>配置 <code>env.DEFAULT_LOCALE</code></td></tr></tbody></table><p><strong>多租户架构的关键</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>核心原则：通过配置驱动差异，而不是代码分支</span></span>
<span class="line"><span></span></span>
<span class="line"><span>错误示范：</span></span>
<span class="line"><span>  if (isChina) {</span></span>
<span class="line"><span>    useAlipay();</span></span>
<span class="line"><span>  } else {</span></span>
<span class="line"><span>    useStripe();</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>正确做法：</span></span>
<span class="line"><span>  const PaymentProvider = config.paymentType; // 动态注入</span></span>
<span class="line"><span>  PaymentProvider.pay(amount);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>配置管理</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>/apps/design-ai-plus/src/configs/</span></span>
<span class="line"><span>  ├── env.ts          ← 环境配置（API域名、登录方式...）</span></span>
<span class="line"><span>  ├── apis.ts         ← API端点配置</span></span>
<span class="line"><span>  └── extensions.ts   ← 插件配置（哪些插件启用）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/apps/insmind-ai-plus/src/configs/</span></span>
<span class="line"><span>  ├── env.ts          ← 不同的环境配置</span></span>
<span class="line"><span>  ├── apis.ts         ← 不同的API端点</span></span>
<span class="line"><span>  └── extensions.ts   ← 不同的插件配置</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><hr><h2 id="四、扩展插件系统-可持续进化的关键" tabindex="-1">四、扩展插件系统 - 可持续进化的关键 <a class="header-anchor" href="#四、扩展插件系统-可持续进化的关键" aria-label="Permalink to &quot;四、扩展插件系统 - 可持续进化的关键&quot;">​</a></h2><h3 id="_4-1-为什么需要插件系统" tabindex="-1">4.1 为什么需要插件系统？ <a class="header-anchor" href="#_4-1-为什么需要插件系统" aria-label="Permalink to &quot;4.1 为什么需要插件系统？&quot;">​</a></h3><p><strong>场景痛点</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>产品需求不断变化：</span></span>
<span class="line"><span>  ├─ 今天要加 AI 绘图</span></span>
<span class="line"><span>  ├─ 明天要加视频生成</span></span>
<span class="line"><span>  ├─ 后天要加协同编辑</span></span>
<span class="line"><span>  └─ 每次都改核心代码？❌</span></span>
<span class="line"><span></span></span>
<span class="line"><span>如果没有插件系统：</span></span>
<span class="line"><span>  ├─ 核心代码越来越臃肿</span></span>
<span class="line"><span>  ├─ 功能耦合严重，改一处影响全局</span></span>
<span class="line"><span>  ├─ 无法按需加载，首屏体积爆炸</span></span>
<span class="line"><span>  └─ 团队协作困难，互相阻塞</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>插件化解决方案</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>编辑器核心（稳定）</span></span>
<span class="line"><span>  ↓</span></span>
<span class="line"><span>通过插件系统扩展（灵活）</span></span>
<span class="line"><span>  ├─ AI 插件       ← 团队A开发</span></span>
<span class="line"><span>  ├─ 上传插件      ← 团队B开发</span></span>
<span class="line"><span>  ├─ 协同插件      ← 团队C开发</span></span>
<span class="line"><span>  └─ 自定义插件    ← 客户自己开发</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_4-2-插件生命周期管理" tabindex="-1">4.2 插件生命周期管理 <a class="header-anchor" href="#_4-2-插件生命周期管理" aria-label="Permalink to &quot;4.2 插件生命周期管理&quot;">​</a></h3><p>插件从加载到销毁经历 <strong>5 个阶段</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  1️⃣ Load（加载）                                          │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  • 解析插件配置（manifest）                               │</span></span>
<span class="line"><span>│  • 检查依赖关系                                           │</span></span>
<span class="line"><span>│  • 动态 import 插件代码                                   │</span></span>
<span class="line"><span>│  • 创建插件实例                                           │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  2️⃣ Register（注册）                                      │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  • 注册 Vue 组件                                          │</span></span>
<span class="line"><span>│  • 注册路由                                               │</span></span>
<span class="line"><span>│  • 注册全局指令/过滤器                                     │</span></span>
<span class="line"><span>│  • 注册编辑器命令                                         │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  3️⃣ Bootstrap（启动）                                     │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  • 初始化插件服务                                         │</span></span>
<span class="line"><span>│  • 建立网络连接                                           │</span></span>
<span class="line"><span>│  • 加载初始数据                                           │</span></span>
<span class="line"><span>│  • 注册事件监听                                           │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  4️⃣ Run（运行）                                           │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  • 插件功能正常工作                                        │</span></span>
<span class="line"><span>│  • 响应用户操作                                           │</span></span>
<span class="line"><span>│  • 与其他插件协作                                         │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  5️⃣ Unmount（卸载）                                       │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  • 移除事件监听                                           │</span></span>
<span class="line"><span>│  • 清理定时器/连接                                        │</span></span>
<span class="line"><span>│  • 释放内存资源                                           │</span></span>
<span class="line"><span>│  • 注销组件和命令                                         │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><strong>关键设计</strong>：ExtensionManager 统一管理所有插件的生命周期。</p><h3 id="_4-3-插件配置与加载机制" tabindex="-1">4.3 插件配置与加载机制 <a class="header-anchor" href="#_4-3-插件配置与加载机制" aria-label="Permalink to &quot;4.3 插件配置与加载机制&quot;">​</a></h3><p><strong>插件配置的三种方式</strong>：</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 方式1：直接传入对象</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">defineExtensionConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  manifest: { id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, version: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1.0.0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 方式2：异步加载（推荐，支持代码分割）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">defineExtensionConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;@design/extension-ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 方式3：带参数配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">defineExtensionConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;@design/extension-ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { apiKey: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;xxx&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, model: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gpt-4&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 插件参数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>按需加载策略</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>首屏必需插件（同步加载）：</span></span>
<span class="line"><span>  ├─ 基础编辑插件（选择、拖拽、缩放...）</span></span>
<span class="line"><span>  └─ AI 聊天插件（核心功能）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>懒加载插件（用户触发时加载）：</span></span>
<span class="line"><span>  ├─ 图像编辑插件 ← 点击&quot;AI改图&quot;时加载</span></span>
<span class="line"><span>  ├─ 批量设计插件 ← 打开批量面板时加载</span></span>
<span class="line"><span>  └─ 协同插件 ← 进入协作模式时加载</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_4-4-典型插件分类与职责" tabindex="-1">4.4 典型插件分类与职责 <a class="header-anchor" href="#_4-4-典型插件分类与职责" aria-label="Permalink to &quot;4.4 典型插件分类与职责&quot;">​</a></h3><table tabindex="0"><thead><tr><th>类别</th><th>插件示例</th><th>核心职责</th></tr></thead><tbody><tr><td><strong>AI能力</strong></td><td>extension-ai</td><td>AI 图片/视频生成、智能编辑</td></tr><tr><td></td><td>extension-image-edit</td><td>改图、扩图、消除、抠图</td></tr><tr><td><strong>素材管理</strong></td><td>extension-upload</td><td>文件上传、素材管理</td></tr><tr><td></td><td>extension-material-importer</td><td>批量导入外部素材</td></tr><tr><td><strong>效率工具</strong></td><td>extension-batch-design</td><td>批量生成、数据填充</td></tr><tr><td></td><td>extension-auto-layout</td><td>智能布局、自动对齐</td></tr><tr><td><strong>协作</strong></td><td>extension-team-panel</td><td>团队管理、权限控制</td></tr><tr><td></td><td>extension-comment</td><td>评论、标注、审批</td></tr><tr><td><strong>UI增强</strong></td><td>extension-my-panel</td><td>我的作品、收藏、历史</td></tr><tr><td></td><td>extension-template-market</td><td>模板市场、灵感广场</td></tr></tbody></table><hr><h2 id="五、无限画布渲染引擎-支撑万级元素的基石" tabindex="-1">五、无限画布渲染引擎 - 支撑万级元素的基石 <a class="header-anchor" href="#五、无限画布渲染引擎-支撑万级元素的基石" aria-label="Permalink to &quot;五、无限画布渲染引擎 - 支撑万级元素的基石&quot;">​</a></h2><h3 id="_5-1-为什么需要-无限画布" tabindex="-1">5.1 为什么需要&quot;无限画布&quot;？ <a class="header-anchor" href="#_5-1-为什么需要-无限画布" aria-label="Permalink to &quot;5.1 为什么需要&quot;无限画布&quot;？&quot;">​</a></h3><p><strong>传统 DOM 渲染的瓶颈</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>场景：用户生成了 1000 张 AI 图片</span></span>
<span class="line"><span>  ├─ DOM 方案：创建 1000 个 &lt;img&gt; 元素</span></span>
<span class="line"><span>  ├─ 问题1：DOM 节点过多，浏览器卡顿</span></span>
<span class="line"><span>  ├─ 问题2：滚动和缩放性能差</span></span>
<span class="line"><span>  └─ 问题3：内存占用过高</span></span>
<span class="line"><span></span></span>
<span class="line"><span>结果：页面崩溃 💥</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>PixiJS (WebGL) 方案</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>同样 1000 张图片：</span></span>
<span class="line"><span>  ├─ 只创建可见区域的渲染对象（如 50 个）</span></span>
<span class="line"><span>  ├─ 其他对象按需创建/销毁</span></span>
<span class="line"><span>  ├─ WebGL 硬件加速，60fps 流畅</span></span>
<span class="line"><span>  └─ 支持无限滚动、缩放</span></span>
<span class="line"><span></span></span>
<span class="line"><span>结果：丝般顺滑 ✨</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_5-2-渲染架构-三层结构" tabindex="-1">5.2 渲染架构 - 三层结构 <a class="header-anchor" href="#_5-2-渲染架构-三层结构" aria-label="Permalink to &quot;5.2 渲染架构 - 三层结构&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌───────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  Surface（画布表面）                                    │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  • 最顶层管理者                                        │</span></span>
<span class="line"><span>│  • 协调下层组件工作                                    │</span></span>
<span class="line"><span>│  • 控制渲染循环（Ticker：16ms/帧）                     │</span></span>
<span class="line"><span>└───────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>              ↓              ↓              ↓</span></span>
<span class="line"><span>    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐</span></span>
<span class="line"><span>    │  Viewport   │  │ Processor   │  │ PluginSystem│</span></span>
<span class="line"><span>    │  (视口)      │  │  (处理器)    │  │  (插件)     │</span></span>
<span class="line"><span>    └─────────────┘  └─────────────┘  └─────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>各层职责</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1️⃣ Viewport（视口层）</span></span>
<span class="line"><span>  ├─ 管理相机（Camera）</span></span>
<span class="line"><span>  │   ├─ 缩放（Zoom）：0.1x ~ 10x</span></span>
<span class="line"><span>  │   ├─ 平移（Pan）：拖拽画布移动</span></span>
<span class="line"><span>  │   └─ 旋转（Rotate）：支持画布旋转</span></span>
<span class="line"><span>  ├─ 坐标转换</span></span>
<span class="line"><span>  │   ├─ 屏幕坐标 ⇄ 画布坐标</span></span>
<span class="line"><span>  │   └─ 处理鼠标/触摸事件的坐标映射</span></span>
<span class="line"><span>  └─ 碰撞检测</span></span>
<span class="line"><span>      └─ 判断点击是否命中元素</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2️⃣ Processor（处理器层）</span></span>
<span class="line"><span>  ├─ VmEngine（视图模型引擎）</span></span>
<span class="line"><span>  │   ├─ 数据模型 → PixiJS 渲染对象</span></span>
<span class="line"><span>  │   ├─ 虚拟化渲染（只渲染可见元素）</span></span>
<span class="line"><span>  │   └─ 增量更新（只更新变化部分）</span></span>
<span class="line"><span>  └─ EventBoundary（事件边界）</span></span>
<span class="line"><span>      └─ 事件分发和冒泡处理</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3️⃣ PluginSystem（插件层）</span></span>
<span class="line"><span>  ├─ BackgroundPlugin（背景）</span></span>
<span class="line"><span>  │   └─ 渲染背景色/图片/渐变</span></span>
<span class="line"><span>  ├─ GridPlugin（网格）</span></span>
<span class="line"><span>  │   └─ 显示辅助网格线</span></span>
<span class="line"><span>  ├─ SelectionPlugin（选择）</span></span>
<span class="line"><span>  │   └─ 选中框、控制点</span></span>
<span class="line"><span>  └─ GuidePlugin（参考线）</span></span>
<span class="line"><span>      └─ 对齐辅助线</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_5-3-虚拟化渲染-核心优化" tabindex="-1">5.3 虚拟化渲染 - 核心优化 <a class="header-anchor" href="#_5-3-虚拟化渲染-核心优化" aria-label="Permalink to &quot;5.3 虚拟化渲染 - 核心优化&quot;">​</a></h3><p><strong>核心思想</strong>：只渲染用户能看到的，看不到的不渲染。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>全量渲染（慢）：</span></span>
<span class="line"><span>  画布上有 10000 个元素</span></span>
<span class="line"><span>  → 创建 10000 个 PixiJS 对象</span></span>
<span class="line"><span>  → 每帧都要处理 10000 个对象</span></span>
<span class="line"><span>  → 卡顿！</span></span>
<span class="line"><span></span></span>
<span class="line"><span>虚拟化渲染（快）：</span></span>
<span class="line"><span>  画布上有 10000 个元素</span></span>
<span class="line"><span>  → 只创建视口内的 50 个对象</span></span>
<span class="line"><span>  → 滚动时动态换入/换出对象</span></span>
<span class="line"><span>  → 流畅！</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>实现机制</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>视口变化时（滚动/缩放）：</span></span>
<span class="line"><span>  1. 计算当前视口范围</span></span>
<span class="line"><span>  2. 找出视口内的元素列表</span></span>
<span class="line"><span>  3. 比对上次的列表：</span></span>
<span class="line"><span>     ├─ 新进入视口的 → 创建渲染对象</span></span>
<span class="line"><span>     ├─ 移出视口的 → 销毁渲染对象</span></span>
<span class="line"><span>     └─ 仍在视口的 → 更新位置/样式</span></span>
<span class="line"><span>  4. 渲染当前帧</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_5-4-性能优化策略" tabindex="-1">5.4 性能优化策略 <a class="header-anchor" href="#_5-4-性能优化策略" aria-label="Permalink to &quot;5.4 性能优化策略&quot;">​</a></h3><table tabindex="0"><thead><tr><th>优化策略</th><th>具体实现</th><th>性能提升</th></tr></thead><tbody><tr><td><strong>虚拟化渲染</strong></td><td>只渲染视口内元素</td><td>降低 90% CPU 占用</td></tr><tr><td><strong>对象池复用</strong></td><td>复用 PixiJS 对象，避免频繁创建/销毁</td><td>减少 GC 压力 70%</td></tr><tr><td><strong>懒加载纹理</strong></td><td>图片进入视口才加载，支持渐进式加载</td><td>节省 80% 内存</td></tr><tr><td><strong>脏矩形检测</strong></td><td>只重绘变化区域，而不是全画布</td><td>提升 3x 渲染速度</td></tr><tr><td><strong>LOD分级</strong></td><td>缩小时显示低精度版本，放大时加载高清</td><td>优化缩放体验</td></tr><tr><td><strong>WebGL加速</strong></td><td>硬件加速，GPU并行计算</td><td>支持万级元素流畅</td></tr></tbody></table><hr><h2 id="六、ai-对话框系统-⭐⭐⭐-核心中的核心" tabindex="-1">六、AI 对话框系统 ⭐⭐⭐ 核心中的核心 <a class="header-anchor" href="#六、ai-对话框系统-⭐⭐⭐-核心中的核心" aria-label="Permalink to &quot;六、AI 对话框系统 ⭐⭐⭐ 核心中的核心&quot;">​</a></h2><blockquote><p><strong>为什么这是核心？</strong> 这是整个产品的灵魂，是 AI 能力与用户交互的桥梁。</p></blockquote><h3 id="_6-1-设计目标与挑战" tabindex="-1">6.1 设计目标与挑战 <a class="header-anchor" href="#_6-1-设计目标与挑战" aria-label="Permalink to &quot;6.1 设计目标与挑战&quot;">​</a></h3><p><strong>设计目标</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>✅ 实时响应：用户发送消息后，立即看到 AI 的思考过程</span></span>
<span class="line"><span>✅ 流畅体验：AI 生成内容时，用户可以继续操作画布</span></span>
<span class="line"><span>✅ 批量处理：一次对话可以生成多张图片，自动布局</span></span>
<span class="line"><span>✅ 错误容忍：网络中断、生成失败都能优雅降级</span></span>
<span class="line"><span>✅ 历史回放：查看过去的对话，重现生成过程</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>技术挑战</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>❌ Challenge 1：如何实现流式响应？</span></span>
<span class="line"><span>   → 解决方案：SSE (Server-Sent Events)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>❌ Challenge 2：AI 生成很慢（10-30秒），如何不让用户等待？</span></span>
<span class="line"><span>   → 解决方案：PlaceholderManager 占位元素</span></span>
<span class="line"><span></span></span>
<span class="line"><span>❌ Challenge 3：一次生成多张图，如何管理状态？</span></span>
<span class="line"><span>   → 解决方案：MessageHandler 的批量跟踪机制</span></span>
<span class="line"><span></span></span>
<span class="line"><span>❌ Challenge 4：生成失败了怎么办？</span></span>
<span class="line"><span>   → 解决方案：完善的错误处理和重试机制</span></span>
<span class="line"><span></span></span>
<span class="line"><span>❌ Challenge 5：如何支持各种 AI 能力（生成、编辑、改图...）？</span></span>
<span class="line"><span>   → 解决方案：ToolProcessor 统一工具处理</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_6-2-整体架构-四层结构" tabindex="-1">6.2 整体架构 - 四层结构 <a class="header-anchor" href="#_6-2-整体架构-四层结构" aria-label="Permalink to &quot;6.2 整体架构 - 四层结构&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌───────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  🎨 UI 展示层                                          │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  ChatPanel (对话面板)                                  │</span></span>
<span class="line"><span>│    ├─ ChatHeader (标题栏：新建对话、历史记录)           │</span></span>
<span class="line"><span>│    ├─ MessageList (消息列表：用户消息、AI回复、工具调用) │</span></span>
<span class="line"><span>│    └─ ChatSender (输入框：技能选择、附件上传、参数设置)  │</span></span>
<span class="line"><span>└───────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌───────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  🔄 交互逻辑层                                          │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  ChatWrap (聊天容器)                                   │</span></span>
<span class="line"><span>│    ├─ 管理消息状态（messages[]）                        │</span></span>
<span class="line"><span>│    ├─ 处理用户输入事件                                  │</span></span>
<span class="line"><span>│    ├─ 协调各个服务                                     │</span></span>
<span class="line"><span>│    └─ 同步画布状态（currentElement）                    │</span></span>
<span class="line"><span>└───────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌───────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  ⚙️ 核心服务层                                         │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  ├─ SSEManager：管理与后端的 SSE 流式连接               │</span></span>
<span class="line"><span>│  ├─ MessageHandler：解析 AI 消息流，管理消息状态        │</span></span>
<span class="line"><span>│  ├─ ToolProcessor：处理 AI 工具调用，记录管理           │</span></span>
<span class="line"><span>│  └─ PlaceholderManager：管理占位元素，优化等待体验      │</span></span>
<span class="line"><span>└───────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌───────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  🖼️ 画布操作层                                         │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  ElementAddService：将 AI 生成结果添加到画布            │</span></span>
<span class="line"><span>│    ├─ addImageElement（添加图片）                      │</span></span>
<span class="line"><span>│    ├─ addTextElement（添加文本）                       │</span></span>
<span class="line"><span>│    ├─ replaceElement（替换元素）                       │</span></span>
<span class="line"><span>│    └─ adjustLayout（自动布局）                         │</span></span>
<span class="line"><span>└───────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p><strong>各层职责清单</strong>：</p><table tabindex="0"><thead><tr><th>层级</th><th>核心职责</th><th>不负责的事情</th></tr></thead><tbody><tr><td><strong>UI层</strong></td><td>展示消息、接收用户输入、显示加载状态</td><td>❌ 不处理业务逻辑</td></tr><tr><td><strong>交互层</strong></td><td>管理状态、协调服务、处理事件</td><td>❌ 不直接操作 DOM</td></tr><tr><td><strong>服务层</strong></td><td>网络通信、数据处理、工具执行</td><td>❌ 不关心 UI 如何展示</td></tr><tr><td><strong>画布层</strong></td><td>操作编辑器、添加元素、布局优化</td><td>❌ 不知道消息从哪里来</td></tr></tbody></table><h3 id="_6-3-对话流程全景-从输入到画布的奇妙旅程" tabindex="-1">6.3 对话流程全景 - 从输入到画布的奇妙旅程 <a class="header-anchor" href="#_6-3-对话流程全景-从输入到画布的奇妙旅程" aria-label="Permalink to &quot;6.3 对话流程全景 - 从输入到画布的奇妙旅程&quot;">​</a></h3><p>让我们跟随一条消息，看它如何从用户的键盘变成画布上的设计作品。</p><h4 id="完整流程-7个关键阶段" tabindex="-1"><strong>完整流程（7个关键阶段）</strong> <a class="header-anchor" href="#完整流程-7个关键阶段" aria-label="Permalink to &quot;**完整流程（7个关键阶段）**&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>👤 用户说：&quot;帮我生成一张春天的风景照，16:9的&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  第1阶段：用户输入 📝                                      │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  ChatSender 收集参数：                                    │</span></span>
<span class="line"><span>│    ├─ 技能（skill）: &#39;image&#39; (图片生成)                  │</span></span>
<span class="line"><span>│    ├─ 提示词（prompt）: &quot;春天的风景照&quot;                    │</span></span>
<span class="line"><span>│    ├─ 比例（ratio）: &#39;16:9&#39;                             │</span></span>
<span class="line"><span>│    ├─ 风格（style）: &#39;realistic&#39; (写实风格)              │</span></span>
<span class="line"><span>│    └─ 附件（attachments）: [] (无附件)                   │</span></span>
<span class="line"><span>│  点击发送 → 触发 submit 事件                              │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  第2阶段：消息构造 🛠️                                     │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  构造用户消息对象：                                        │</span></span>
<span class="line"><span>│  {                                                       │</span></span>
<span class="line"><span>│    role: &#39;user&#39;,              // 用户消息                │</span></span>
<span class="line"><span>│    content: {                                            │</span></span>
<span class="line"><span>│      type: &#39;text&#39;,            // 文本类型                │</span></span>
<span class="line"><span>│      text: &#39;春天的风景照&#39;      // 用户输入               │</span></span>
<span class="line"><span>│    },                                                    │</span></span>
<span class="line"><span>│    metadata: {                // 元数据                  │</span></span>
<span class="line"><span>│      skill: &#39;image&#39;,                                     │</span></span>
<span class="line"><span>│      ratio: &#39;16:9&#39;,                                      │</span></span>
<span class="line"><span>│      styleCode: &#39;realistic&#39;                              │</span></span>
<span class="line"><span>│    }                                                     │</span></span>
<span class="line"><span>│  }                                                       │</span></span>
<span class="line"><span>│  添加到消息列表 messages.push(userMessage)                │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  第3阶段：SSE 连接 🌐                                     │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  SSEManager 发起请求：                                    │</span></span>
<span class="line"><span>│    POST /api/ai/chat                                     │</span></span>
<span class="line"><span>│    Body: {                                               │</span></span>
<span class="line"><span>│      messages: [...historyMessages, userMessage],       │</span></span>
<span class="line"><span>│      conversationId: &#39;conv_xxx&#39;   // 会话 ID             │</span></span>
<span class="line"><span>│    }                                                     │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  建立 SSE 流式连接：                                      │</span></span>
<span class="line"><span>│    ┌─ 后端开始处理                                       │</span></span>
<span class="line"><span>│    ├─ AI 模型推理中...                                   │</span></span>
<span class="line"><span>│    └─ 实时推送响应片段                                    │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  前端接收 SSE 流：                                        │</span></span>
<span class="line"><span>│    data: {&quot;event&quot;:&quot;message&quot;,&quot;role&quot;:&quot;assistant&quot;,...}      │</span></span>
<span class="line"><span>│    data: {&quot;event&quot;:&quot;function_call&quot;,...}                   │</span></span>
<span class="line"><span>│    data: {&quot;event&quot;:&quot;function_response&quot;,...}               │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  第4阶段：消息解析 🔍                                     │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  MessageHandler 解析 SSE 消息流：                         │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ① 收到 function_call（工具调用）                        │</span></span>
<span class="line"><span>│     内容：{                                              │</span></span>
<span class="line"><span>│       name: &quot;图片生成&quot;,                                  │</span></span>
<span class="line"><span>│       arguments: {                                       │</span></span>
<span class="line"><span>│         prompt: &quot;春天的风景照&quot;,                          │</span></span>
<span class="line"><span>│         ratio: &quot;16:9&quot;,                                   │</span></span>
<span class="line"><span>│         style: &quot;realistic&quot;                               │</span></span>
<span class="line"><span>│       }                                                  │</span></span>
<span class="line"><span>│     }                                                    │</span></span>
<span class="line"><span>│     → 记录工具调用                                        │</span></span>
<span class="line"><span>│     → 触发埋点：工具初始化                                 │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ② 收到 function_response（工具结果）                    │</span></span>
<span class="line"><span>│     内容：{                                              │</span></span>
<span class="line"><span>│       toolType: &quot;image&quot;,                                 │</span></span>
<span class="line"><span>│       result: {                                          │</span></span>
<span class="line"><span>│         uri: &quot;https://cdn.com/generated-image.jpg&quot;      │</span></span>
<span class="line"><span>│       },                                                 │</span></span>
<span class="line"><span>│       metadata: {                                        │</span></span>
<span class="line"><span>│         taskId: &quot;task_xxx&quot;,                             │</span></span>
<span class="line"><span>│         query: &quot;春天的风景照&quot;,                           │</span></span>
<span class="line"><span>│         width: 1920, height: 1080                       │</span></span>
<span class="line"><span>│       }                                                  │</span></span>
<span class="line"><span>│     }                                                    │</span></span>
<span class="line"><span>│     → 创建 Tool 对象                                      │</span></span>
<span class="line"><span>│     → 触发 addImage 事件                                  │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  第5阶段：占位管理 ⏳                                     │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  PlaceholderManager 立即创建占位元素：                    │</span></span>
<span class="line"><span>│    ├─ 在画布上显示一个&quot;加载中&quot;的框                        │</span></span>
<span class="line"><span>│    ├─ 显示加载动画（转圈圈）                              │</span></span>
<span class="line"><span>│    ├─ 显示提示：AI 生成中...                             │</span></span>
<span class="line"><span>│    └─ 记录占位元素 ID 和位置                              │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  为什么需要占位？                                         │</span></span>
<span class="line"><span>│    → 用户立即看到反馈（不是傻等）                         │</span></span>
<span class="line"><span>│    → 预留位置，避免后续元素跳动                           │</span></span>
<span class="line"><span>│    → 显示生成进度（如批量生成时 1/4）                     │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  第6阶段：工具处理 🔧                                     │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  ToolProcessor 处理工具对象：                             │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ① 获取历史记录（如果重新打开）                           │</span></span>
<span class="line"><span>│     getRecordId(taskId) → 查数据库                       │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ② 特殊处理（如图文分层需要导出预览）                     │</span></span>
<span class="line"><span>│     if (toolType === &#39;imageToTemplate&#39;) {                │</span></span>
<span class="line"><span>│       exportImageByJson() → 生成缩略图                   │</span></span>
<span class="line"><span>│     }                                                    │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ③ 提交生成记录                                           │</span></span>
<span class="line"><span>│     postRecord() → 保存到数据库：                        │</span></span>
<span class="line"><span>│       - generation_result: 图片 URL                      │</span></span>
<span class="line"><span>│       - prompt: 用户输入                                 │</span></span>
<span class="line"><span>│       - work_id: 当前作品 ID                             │</span></span>
<span class="line"><span>│       - task_id: AI 任务 ID                              │</span></span>
<span class="line"><span>│       → 返回 recordId                                     │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ④ 返回处理后的 Tool（包含 recordId）                    │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  第7阶段：添加到画布 🎨                                   │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  ElementAddService 执行添加：                             │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ① 加载图片资源                                           │</span></span>
<span class="line"><span>│     loadImage(tool.result.uri)                          │</span></span>
<span class="line"><span>│     → 下载图片 → 解码 → 创建纹理                         │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ② 创建图片元素                                           │</span></span>
<span class="line"><span>│     editor.createElement({                               │</span></span>
<span class="line"><span>│       type: &#39;image&#39;,                                     │</span></span>
<span class="line"><span>│       imageUrl: tool.result.uri,                         │</span></span>
<span class="line"><span>│       width: 1920, height: 1080,                        │</span></span>
<span class="line"><span>│       transform: placeholderPosition  // 占位位置        │</span></span>
<span class="line"><span>│     })                                                   │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ③ 移除占位元素                                           │</span></span>
<span class="line"><span>│     placeholderManager.remove(placeholderId)            │</span></span>
<span class="line"><span>│     → 删除&quot;加载中&quot;的框                                    │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ④ 添加真实元素                                           │</span></span>
<span class="line"><span>│     editor.addElement(imageElement)                      │</span></span>
<span class="line"><span>│     → 出现在画布上                                        │</span></span>
<span class="line"><span>│     → 聚焦新元素（选中状态）                              │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  ⑤ 调整视口                                               │</span></span>
<span class="line"><span>│     adjustViewport() → 自动滚动到新元素位置               │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>                      ✅ 完成！</span></span>
<span class="line"><span>                  用户看到生成的图片 🎉</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br></div></div><p><strong>流程关键点总结</strong>：</p><table tabindex="0"><thead><tr><th>阶段</th><th>耗时</th><th>用户感知</th><th>优化手段</th></tr></thead><tbody><tr><td>1-2 输入</td><td>&lt;100ms</td><td>点击发送</td><td>-</td></tr><tr><td>3 SSE连接</td><td>1-2s</td><td>看到&quot;AI思考中&quot;</td><td>立即显示加载状态</td></tr><tr><td>4 消息解析</td><td>&lt;100ms</td><td>无感知（后台处理）</td><td>高效的JSON解析</td></tr><tr><td>5 创建占位</td><td>&lt;50ms</td><td>看到占位框（心理预期）</td><td>同步创建，无等待</td></tr><tr><td>6 工具处理</td><td>10-30s</td><td>看到加载动画</td><td><strong>异步处理，不阻塞UI</strong></td></tr><tr><td>7 添加元素</td><td>200-500ms</td><td>看到图片从模糊到清晰</td><td>渐进式加载</td></tr></tbody></table><p><strong>核心设计思想</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>❌ 错误做法：等 AI 生成完再显示结果 → 用户等 30 秒</span></span>
<span class="line"><span>✅ 正确做法：立即显示占位 + 后台处理 → 用户感觉只等 1 秒</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_6-4-四大核心服务深度解析" tabindex="-1">6.4 四大核心服务深度解析 <a class="header-anchor" href="#_6-4-四大核心服务深度解析" aria-label="Permalink to &quot;6.4 四大核心服务深度解析&quot;">​</a></h3><h4 id="服务1-ssemanager-流式通信管家-🌐" tabindex="-1"><strong>服务1：SSEManager - 流式通信管家</strong> 🌐 <a class="header-anchor" href="#服务1-ssemanager-流式通信管家-🌐" aria-label="Permalink to &quot;**服务1：SSEManager - 流式通信管家** 🌐&quot;">​</a></h4><p><strong>为什么需要 SSE？</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>传统方式（轮询）：</span></span>
<span class="line"><span>  前端每隔1秒问一次：&quot;生成好了吗？&quot;</span></span>
<span class="line"><span>  → 浪费带宽，延迟高</span></span>
<span class="line"><span></span></span>
<span class="line"><span>SSE 方式（服务端推送）：</span></span>
<span class="line"><span>  后端：生成好了一部分 → 立即推送给前端</span></span>
<span class="line"><span>  → 实时，高效</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>核心职责</strong>：</p><ol><li>建立并维护 SSE 连接</li><li>处理网络异常（断线重连）</li><li>解析 SSE 数据流（JSON分段解析）</li><li>触发回调通知上层</li></ol><p><strong>关键实现</strong>：</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">核心方法：</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(messages) → 返回一个流式读取器</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">流程：</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  1.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 发送 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">POST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 请求，携带历史消息</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  2.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 获取 response.body.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  3.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 循环读取：</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">done</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 解码二进制数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decoder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">decode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 解析 JSON（处理分段）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> parseJSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 通知 MessageHandler</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">       callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  4.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 流结束：done </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> → 关闭连接</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>难点处理</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>问题1：JSON 可能被分割（一次 read 只拿到一半）</span></span>
<span class="line"><span>  解决：缓存不完整数据，拼接后再解析</span></span>
<span class="line"><span></span></span>
<span class="line"><span>问题2：网络中断怎么办？</span></span>
<span class="line"><span>  解决：捕获异常 → 触发 onError → 显示重试按钮</span></span>
<span class="line"><span></span></span>
<span class="line"><span>问题3：用户取消生成怎么办？</span></span>
<span class="line"><span>  解决：reader.cancel() → 关闭流 → 清理资源</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr><h4 id="服务2-messagehandler-消息流量控制中心-🔍" tabindex="-1"><strong>服务2：MessageHandler - 消息流量控制中心</strong> 🔍 <a class="header-anchor" href="#服务2-messagehandler-消息流量控制中心-🔍" aria-label="Permalink to &quot;**服务2：MessageHandler - 消息流量控制中心** 🔍&quot;">​</a></h4><p><strong>为什么这么复杂？</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>AI 返回的不是简单的文本，而是结构化的消息流：</span></span>
<span class="line"><span>  ├─ 文本消息（AI 说的话）</span></span>
<span class="line"><span>  ├─ 工具调用（AI 要执行的操作）</span></span>
<span class="line"><span>  ├─ 工具响应（操作的结果）</span></span>
<span class="line"><span>  └─ 批量生成（一次调用多个工具）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>需要一个&quot;交通警察&quot;来管理这些消息的流向</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>核心职责</strong>：</p><ol><li>解析 SSE 消息流，识别消息类型</li><li>管理消息状态（待处理、处理中、已完成）</li><li>处理批量生成场景（consecutiveFunctionCalls）</li><li>过滤和合并重复消息</li><li>触发相应的画布操作事件</li></ol><p><strong>批量生成追踪机制</strong>（核心亮点）：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>场景：用户说&quot;生成4张不同风格的logo&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>问题：AI 会返回 4 个 function_call 和 4 个 function_response</span></span>
<span class="line"><span>  → 如何知道什么时候全部完成？</span></span>
<span class="line"><span>  → 如何避免重复处理？</span></span>
<span class="line"><span></span></span>
<span class="line"><span>解决方案：consecutiveFunctionCalls 追踪</span></span>
<span class="line"><span></span></span>
<span class="line"><span>数据结构：</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    toolName: &#39;image&#39;,</span></span>
<span class="line"><span>    batches: [</span></span>
<span class="line"><span>      {</span></span>
<span class="line"><span>        expectedResponses: 4,   // 期望4个响应</span></span>
<span class="line"><span>        receivedResponses: 2,   // 已收到2个</span></span>
<span class="line"><span>        messageIds: Set([&#39;msg1&#39;, &#39;msg2&#39;]), // 已处理的ID</span></span>
<span class="line"><span>        isCompleted: false      // 未完成</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    ]</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>工作流程：</span></span>
<span class="line"><span>  1. 收到第1个 function_call → 创建追踪记录</span></span>
<span class="line"><span>  2. 收到第2个 function_call（连续的）→ expectedResponses + 1</span></span>
<span class="line"><span>  3. 收到 function_response → receivedResponses + 1</span></span>
<span class="line"><span>  4. 当 receivedResponses == expectedResponses → 触发批量完成事件</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>过滤逻辑</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>哪些消息需要显示给用户？</span></span>
<span class="line"><span>  ✅ 用户发的消息</span></span>
<span class="line"><span>  ✅ AI 的文本回复</span></span>
<span class="line"><span>  ✅ 工具调用的结果（图片、文本）</span></span>
<span class="line"><span>  ❌ function_call 细节（技术信息，用户不关心）</span></span>
<span class="line"><span>  ❌ 系统消息（心跳、状态码）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr><h4 id="服务3-toolprocessor-工具全生命周期管家-🔧" tabindex="-1"><strong>服务3：ToolProcessor - 工具全生命周期管家</strong> 🔧 <a class="header-anchor" href="#服务3-toolprocessor-工具全生命周期管家-🔧" aria-label="Permalink to &quot;**服务3：ToolProcessor - 工具全生命周期管家** 🔧&quot;">​</a></h4><p><strong>职责范围</strong>：</p><p>从 AI 返回工具对象 → 到保存记录的完整流程。</p><p><strong>核心流程</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>processAiTool(tool) 做了什么？</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第1步：查询历史记录</span></span>
<span class="line"><span>  → 如果用户重新打开作品，需要关联之前的生成记录</span></span>
<span class="line"><span>  → getRecordId(taskId) → 查数据库</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第2步：数据转换</span></span>
<span class="line"><span>  → 合并历史数据：tool.metadata.recordId = record.id</span></span>
<span class="line"><span>  → 特殊工具处理：如图文分层需要导出预览图</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第3步：提交记录</span></span>
<span class="line"><span>  → postRecord(tool) → 保存到数据库</span></span>
<span class="line"><span>  → 记录内容：</span></span>
<span class="line"><span>      - generation_result: 生成的图片URL</span></span>
<span class="line"><span>      - prompt: 用户输入</span></span>
<span class="line"><span>      - work_id: 当前作品ID</span></span>
<span class="line"><span>      - element_id: 对应的画布元素ID</span></span>
<span class="line"><span>      - task_id: AI任务ID</span></span>
<span class="line"><span></span></span>
<span class="line"><span>第4步：返回处理后的工具</span></span>
<span class="line"><span>  → 包含完整的 metadata（如 recordId）</span></span>
<span class="line"><span>  → 供后续使用（如重做、删除）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>缓存机制</strong>（性能优化）：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>问题：同一个 taskId 可能被调用多次</span></span>
<span class="line"><span>  → 如批量生成时，4张图共享某些数据</span></span>
<span class="line"><span></span></span>
<span class="line"><span>解决：processedToolCache</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Map&lt;taskId, Promise&lt;Tool&gt;&gt;</span></span>
<span class="line"><span>  ├─ 第1次调用：发起请求，存入缓存</span></span>
<span class="line"><span>  ├─ 第2-4次调用：直接返回缓存的 Promise</span></span>
<span class="line"><span>  └─ 避免重复请求，节省时间和带宽</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><hr><h4 id="服务4-placeholdermanager-用户体验优化大师-⏳" tabindex="-1"><strong>服务4：PlaceholderManager - 用户体验优化大师</strong> ⏳ <a class="header-anchor" href="#服务4-placeholdermanager-用户体验优化大师-⏳" aria-label="Permalink to &quot;**服务4：PlaceholderManager - 用户体验优化大师** ⏳&quot;">​</a></h4><p><strong>设计初衷</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>问题：AI 生成需要 10-30 秒</span></span>
<span class="line"><span>  → 用户盯着空白画布傻等？❌</span></span>
<span class="line"><span></span></span>
<span class="line"><span>解决：先放一个&quot;占位符&quot;</span></span>
<span class="line"><span>  → 用户立即看到反馈 ✅</span></span>
<span class="line"><span>  → 心理感觉：&quot;AI 在工作了&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>占位元素生命周期</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1️⃣ 创建阶段</span></span>
<span class="line"><span>  ├─ 在画布指定位置创建占位框</span></span>
<span class="line"><span>  ├─ 显示加载动画（Lottie 动画）</span></span>
<span class="line"><span>  ├─ 显示提示文字：&quot;AI 生成中...&quot;</span></span>
<span class="line"><span>  └─ 记录占位信息（ID、位置、类型）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2️⃣ 等待阶段</span></span>
<span class="line"><span>  ├─ 用户可以继续操作画布（不阻塞）</span></span>
<span class="line"><span>  ├─ 显示生成进度（如批量时 2/4）</span></span>
<span class="line"><span>  └─ 可点击取消（调用 SSE cancel）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3️⃣ 替换阶段</span></span>
<span class="line"><span>  ├─ 真实元素加载完成</span></span>
<span class="line"><span>  ├─ 获取占位元素的位置</span></span>
<span class="line"><span>  ├─ 在同位置创建真实元素</span></span>
<span class="line"><span>  ├─ 淡入动画过渡</span></span>
<span class="line"><span>  └─ 删除占位元素</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4️⃣ 异常处理</span></span>
<span class="line"><span>  ├─ 生成失败 → 占位元素变红，显示错误</span></span>
<span class="line"><span>  ├─ 显示重试按钮</span></span>
<span class="line"><span>  └─ 点击重试 → 重新走生成流程</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>位置计算策略</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>问题：占位元素应该放在哪里？</span></span>
<span class="line"><span></span></span>
<span class="line"><span>策略1：用户选中了元素 → 放在选中元素旁边</span></span>
<span class="line"><span>策略2：画布为空 → 放在画布中心</span></span>
<span class="line"><span>策略3：批量生成 → 自动网格布局（4列）</span></span>
<span class="line"><span>策略4：连续生成 → 紧挨着上一个元素</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>核心价值</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>没有占位管理：</span></span>
<span class="line"><span>  → 用户等待 30 秒 → 突然出现图片 → 体验差</span></span>
<span class="line"><span></span></span>
<span class="line"><span>有占位管理：</span></span>
<span class="line"><span>  → 立即看到反馈（&lt;100ms）→ 后台加载 → 无感知替换 → 体验好</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_6-5-典型业务场景全流程" tabindex="-1">6.5 典型业务场景全流程 <a class="header-anchor" href="#_6-5-典型业务场景全流程" aria-label="Permalink to &quot;6.5 典型业务场景全流程&quot;">​</a></h3><h4 id="场景1-首次生成图片-最基础的流程-🎨" tabindex="-1"><strong>场景1：首次生成图片 - 最基础的流程</strong> 🎨 <a class="header-anchor" href="#场景1-首次生成图片-最基础的流程-🎨" aria-label="Permalink to &quot;**场景1：首次生成图片 - 最基础的流程** 🎨&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户目标：生成一张海报背景图</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  用户操作                                                │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  1. 打开聊天面板                                         │</span></span>
<span class="line"><span>│  2. 输入：&quot;科技感的蓝色背景，16:9&quot;                       │</span></span>
<span class="line"><span>│  3. 选择技能：AI 图片生成                                │</span></span>
<span class="line"><span>│  4. 选择风格：科技风                                     │</span></span>
<span class="line"><span>│  5. 点击发送                                             │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  系统响应（用户视角）                                    │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  ① 消息发送后立即：                                      │</span></span>
<span class="line"><span>│     → 输入框清空                                         │</span></span>
<span class="line"><span>│     → 消息列表显示用户消息                                │</span></span>
<span class="line"><span>│     → 显示&quot;AI 思考中...&quot;                                 │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  ② 1-2秒后：                                            │</span></span>
<span class="line"><span>│     → AI 回复：&quot;正在为您生成科技感背景...&quot;              │</span></span>
<span class="line"><span>│     → 画布上出现占位框（灰色矩形 + 加载动画）             │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  ③ 10-15秒后：                                          │</span></span>
<span class="line"><span>│     → 占位框内容从模糊变清晰                             │</span></span>
<span class="line"><span>│     → 图片完全显示（蓝色科技背景）                       │</span></span>
<span class="line"><span>│     → 自动选中新图片                                     │</span></span>
<span class="line"><span>│     → 聊天面板显示：&quot;已为您生成1张图片&quot;                 │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  后续操作（用户可选）                                    │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  • 直接使用该图片                                        │</span></span>
<span class="line"><span>│  • 继续输入：&quot;再生成3张不同颜色的&quot; → 批量生成            │</span></span>
<span class="line"><span>│  • 选中图片后输入：&quot;把颜色改成红色&quot; → 编辑当前图         │</span></span>
<span class="line"><span>│  • 点击重新生成按钮 → 用相同参数再生成一次               │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p><strong>关键体验优化点</strong>：</p><ul><li>✅ 占位元素让用户不用傻等</li><li>✅ 流式响应让 AI 感觉&quot;有生命&quot;</li><li>✅ 自动选中让后续操作更流畅</li></ul><hr><h4 id="场景2-批量生成-复杂场景的精妙处理-🚀" tabindex="-1"><strong>场景2：批量生成 - 复杂场景的精妙处理</strong> 🚀 <a class="header-anchor" href="#场景2-批量生成-复杂场景的精妙处理-🚀" aria-label="Permalink to &quot;**场景2：批量生成 - 复杂场景的精妙处理** 🚀&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户目标：一次生成多张产品图</span></span>
<span class="line"><span></span></span>
<span class="line"><span>用户输入：&quot;生成4张手机壳产品图，不同颜色&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  系统智能判断                                            │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  AI 识别到：                                             │</span></span>
<span class="line"><span>│    → 数量：4张                                           │</span></span>
<span class="line"><span>│    → 需求变化：不同颜色                                   │</span></span>
<span class="line"><span>│  → 决定：调用 4 次图片生成工具                           │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  MessageHandler 批量跟踪机制启动                         │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  consecutiveFunctionCalls 记录：                        │</span></span>
<span class="line"><span>│    {                                                    │</span></span>
<span class="line"><span>│      toolName: &#39;image&#39;,                                 │</span></span>
<span class="line"><span>│      expectedResponses: 4,  ← 期望4个结果               │</span></span>
<span class="line"><span>│      receivedResponses: 0,  ← 已收到0个                 │</span></span>
<span class="line"><span>│      messageIds: Set()                                  │</span></span>
<span class="line"><span>│    }                                                    │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  PlaceholderManager 批量占位                            │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  画布上出现 2x2 网格布局：                               │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│   [占位1-加载中]  [占位2-等待]                           │</span></span>
<span class="line"><span>│   [占位3-等待]    [占位4-等待]                           │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  聊天面板显示：&quot;正在生成 0/4...&quot;                        │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  流式接收，逐个替换                                      │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  ① 第1个结果返回（8秒后）：                              │</span></span>
<span class="line"><span>│     → receivedResponses: 1                              │</span></span>
<span class="line"><span>│     → [完成-红色]    [占位2-加载中]                      │</span></span>
<span class="line"><span>│       [占位3-等待]  [占位4-等待]                         │</span></span>
<span class="line"><span>│     → 聊天面板更新：&quot;正在生成 1/4...&quot;                   │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  ② 第2个结果返回（15秒后）：                             │</span></span>
<span class="line"><span>│     → receivedResponses: 2                              │</span></span>
<span class="line"><span>│     → [完成-红色]    [完成-蓝色]                         │</span></span>
<span class="line"><span>│       [占位3-加载中]  [占位4-等待]                       │</span></span>
<span class="line"><span>│     → &quot;正在生成 2/4...&quot;                                 │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  ③ 第3、4个陆续完成...                                   │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  ④ 全部完成时：                                          │</span></span>
<span class="line"><span>│     → receivedResponses === expectedResponses  ✓        │</span></span>
<span class="line"><span>│     → 触发批量完成事件                                   │</span></span>
<span class="line"><span>│     → 自动保存作品                                       │</span></span>
<span class="line"><span>│     → 聊天面板：&quot;已为您生成4张图片 ✨&quot;                   │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p><strong>批量生成的技术难点</strong>：</p><table tabindex="0"><thead><tr><th>难点</th><th>解决方案</th></tr></thead><tbody><tr><td>如何知道总共要生成几张？</td><td>AI 返回的 function_call 数量 + 连续判断</td></tr><tr><td>生成顺序不可控怎么办？</td><td>占位元素预先创建，结果返回时匹配对应位置</td></tr><tr><td>某一张失败了怎么办？</td><td>单个占位元素标记失败，其他继续，支持单独重试</td></tr><tr><td>如何避免重复处理？</td><td>messageIds Set 去重 + processedResponseIds</td></tr></tbody></table><hr><h4 id="场景3-编辑已有图片-上下文感知-✏️" tabindex="-1"><strong>场景3：编辑已有图片 - 上下文感知</strong> ✏️ <a class="header-anchor" href="#场景3-编辑已有图片-上下文感知-✏️" aria-label="Permalink to &quot;**场景3：编辑已有图片 - 上下文感知** ✏️&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户目标：修改画布上的图片</span></span>
<span class="line"><span></span></span>
<span class="line"><span>前置条件：画布上已有一张图片（海报背景）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>用户操作：</span></span>
<span class="line"><span>  1. 点击选中图片</span></span>
<span class="line"><span>  2. 在聊天框输入：&quot;把这张图的颜色改成暖色调&quot;</span></span>
<span class="line"><span>  3. 发送</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  系统上下文识别                                          │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  ChatWrap 检测到：                                       │</span></span>
<span class="line"><span>│    → editor.currentElement 不为空                       │</span></span>
<span class="line"><span>│    → currentElement.type === &#39;image&#39;                    │</span></span>
<span class="line"><span>│    → 提取：currentElement.imageUrl                      │</span></span>
<span class="line"><span>│  → 判断：这是编辑请求，不是新生成                        │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  构造请求参数：                                          │</span></span>
<span class="line"><span>│    {                                                    │</span></span>
<span class="line"><span>│      skill: &#39;seedEdit&#39;,      ← 改图技能                 │</span></span>
<span class="line"><span>│      prompt: &quot;改成暖色调&quot;,                              │</span></span>
<span class="line"><span>│      attachments: [                                     │</span></span>
<span class="line"><span>│        {                                                │</span></span>
<span class="line"><span>│          url: currentElement.imageUrl,  ← 原图         │</span></span>
<span class="line"><span>│          type: &#39;image&#39;                                  │</span></span>
<span class="line"><span>│        }                                                │</span></span>
<span class="line"><span>│      ]                                                  │</span></span>
<span class="line"><span>│    }                                                    │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  占位策略：原地替换                                      │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  ① 记录原图位置和尺寸                                    │</span></span>
<span class="line"><span>│     → position: { x: 100, y: 200 }                     │</span></span>
<span class="line"><span>│     → size: { width: 800, height: 600 }                │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  ② 在原图上方创建占位层                                  │</span></span>
<span class="line"><span>│     → 半透明遮罩                                         │</span></span>
<span class="line"><span>│     → 显示&quot;AI 处理中...&quot;                                │</span></span>
<span class="line"><span>│     → 原图仍然可见（50% 透明度）                         │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  ③ 处理完成后                                            │</span></span>
<span class="line"><span>│     → 移除占位层                                         │</span></span>
<span class="line"><span>│     → 更新 currentElement.imageUrl = 新图URL            │</span></span>
<span class="line"><span>│     → 保持位置、尺寸、旋转角度等属性不变                  │</span></span>
<span class="line"><span>│     → 淡入动画（300ms）                                  │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  记录关联（支持撤销）                                    │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  ToolProcessor 保存：                                   │</span></span>
<span class="line"><span>│    {                                                    │</span></span>
<span class="line"><span>│      element_id: &#39;elem_123&#39;,    ← 关联画布元素          │</span></span>
<span class="line"><span>│      origin_url: &#39;原图URL&#39;,                             │</span></span>
<span class="line"><span>│      generation_result: &#39;新图URL&#39;,                      │</span></span>
<span class="line"><span>│      operation: &#39;edit&#39;,         ← 操作类型              │</span></span>
<span class="line"><span>│      prompt: &#39;改成暖色调&#39;                               │</span></span>
<span class="line"><span>│    }                                                    │</span></span>
<span class="line"><span>│  → 支持：                                                │</span></span>
<span class="line"><span>│    • Ctrl+Z 撤销 → 恢复原图                             │</span></span>
<span class="line"><span>│    • 查看编辑历史                                        │</span></span>
<span class="line"><span>│    • 再次编辑 → 基于最新版本                             │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p><strong>上下文感知的价值</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>无上下文：用户每次都要上传图片 → 麻烦</span></span>
<span class="line"><span>有上下文：系统自动识别&quot;这张图&quot; → 自然</span></span>
<span class="line"><span></span></span>
<span class="line"><span>用户体验对比：</span></span>
<span class="line"><span>  ❌ &quot;帮我把 [上传图片] 这张图改成红色&quot;</span></span>
<span class="line"><span>  ✅ [选中图片] &quot;改成红色&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr><h4 id="场景4-历史回放-时光机功能-⏱️" tabindex="-1"><strong>场景4：历史回放 - 时光机功能</strong> ⏱️ <a class="header-anchor" href="#场景4-历史回放-时光机功能-⏱️" aria-label="Permalink to &quot;**场景4：历史回放 - 时光机功能** ⏱️&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户目标：查看昨天生成的作品过程</span></span>
<span class="line"><span></span></span>
<span class="line"><span>用户操作：点击历史记录 → 选择某条记录</span></span>
<span class="line"><span></span></span>
<span class="line"><span>系统响应：进入回放模式</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  回放模式初始化                                          │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  1. 加载历史数据                                         │</span></span>
<span class="line"><span>│     GET /api/chat/thread/{thread_id}                    │</span></span>
<span class="line"><span>│     返回：完整消息列表 + 画布快照                        │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  2. 设置回放状态                                         │</span></span>
<span class="line"><span>│     mode: &#39;playback&#39;                                    │</span></span>
<span class="line"><span>│     → 禁用输入框（不可发送新消息）                       │</span></span>
<span class="line"><span>│     → 显示回放控制栏                                     │</span></span>
<span class="line"><span>│     → 清空当前画布                                       │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  3. 创建模拟 SSE 流                                      │</span></span>
<span class="line"><span>│     PlaybackSSEStream(messages, speed)                  │</span></span>
<span class="line"><span>│     → 按时间间隔推送历史消息                             │</span></span>
<span class="line"><span>│     → speed: &#39;normal&#39; | &#39;fast&#39; | &#39;skip&#39;                │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  逐帧重现（像看电影）                                    │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  时间轴：                                                │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  00:00 - 用户消息：&quot;生成海报背景&quot;                       │</span></span>
<span class="line"><span>│  00:02 - AI 回复：&quot;正在生成...&quot;                        │</span></span>
<span class="line"><span>│  00:03 - function_call 出现                             │</span></span>
<span class="line"><span>│  00:04 - 占位元素出现（模拟）                            │</span></span>
<span class="line"><span>│  00:15 - function_response 到达                         │</span></span>
<span class="line"><span>│  00:16 - 图片添加到画布（锁定，不可编辑）               │</span></span>
<span class="line"><span>│  00:20 - 用户消息：&quot;改成红色&quot;                           │</span></span>
<span class="line"><span>│  00:22 - AI 执行编辑...                                 │</span></span>
<span class="line"><span>│  ...                                                    │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  回放控制：                                              │</span></span>
<span class="line"><span>│    [◀◀ 快退] [▶ 播放/暂停] [⏭️ 跳到最后] [🔄 重做]      │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  回放完成后                                              │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  用户可以：                                              │</span></span>
<span class="line"><span>│    • 点击&quot;同样操作&quot; → 复制 prompt 到输入框               │</span></span>
<span class="line"><span>│    • 点击&quot;基于此继续&quot; → 退出回放，继续编辑               │</span></span>
<span class="line"><span>│    • 点击&quot;另存为新作品&quot; → 复制一份继续创作               │</span></span>
<span class="line"><span>│    • 点击&quot;关闭&quot; → 返回作品列表                           │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p><strong>回放功能的技术实现</strong>：</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">核心：用历史消息模拟 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SSE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 流</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 创建模拟流</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> stream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPlaybackSSEStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(historyMessages, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  speed: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;normal&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 控制播放速度</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  skipDelay: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否跳过延迟</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 播放控制</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">playbackControls </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  pause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 暂停播放</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stream.isPaused </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  resume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 继续播放</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stream.isPaused </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  skipToEnd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 跳到最后</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stream.skipToEnd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 与正常流程共用相同的处理逻辑</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// MessageHandler、PlaceholderManager 等都正常工作</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 只是数据来源从网络变成了本地历史数据</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_6-6-事件驱动架构-解耦的艺术-📡" tabindex="-1">6.6 事件驱动架构 - 解耦的艺术 📡 <a class="header-anchor" href="#_6-6-事件驱动架构-解耦的艺术-📡" aria-label="Permalink to &quot;6.6 事件驱动架构 - 解耦的艺术 📡&quot;">​</a></h3><p><strong>为什么需要事件系统？</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>问题：聊天面板如何通知画布添加图片？</span></span>
<span class="line"><span></span></span>
<span class="line"><span>方案1：直接调用（紧耦合）❌</span></span>
<span class="line"><span>  ChatPanel.ts:</span></span>
<span class="line"><span>    import { canvas } from &#39;./canvas&#39;;</span></span>
<span class="line"><span>    canvas.addImage(data);</span></span>
<span class="line"><span>  → ChatPanel 必须知道 canvas 的存在</span></span>
<span class="line"><span>  → 难以测试、难以替换</span></span>
<span class="line"><span></span></span>
<span class="line"><span>方案2：事件系统（松耦合）✅</span></span>
<span class="line"><span>  ChatPanel.ts:</span></span>
<span class="line"><span>    events.emit(&#39;addImage&#39;, data);</span></span>
<span class="line"><span>  Canvas.ts:</span></span>
<span class="line"><span>    events.on(&#39;addImage&#39;, (data) =&gt; {</span></span>
<span class="line"><span>      this.addImage(data);</span></span>
<span class="line"><span>    });</span></span>
<span class="line"><span>  → 两个模块互不依赖</span></span>
<span class="line"><span>  → 易于测试、易于扩展</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>事件分类与职责</strong>：</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1️⃣ 用户交互事件（UI → 服务层）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;submit&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, chatParams); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 用户发送消息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cancel&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 用户取消生成</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;newChat&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 新建对话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;skillChange&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 切换 AI 技能</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2️⃣ 画布操作事件（服务层 → 画布层）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addImage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, aigc, options); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 添加图片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addText&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, content); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 添加文本</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addLayout&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, layoutData); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 添加布局</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;replaceImage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, aigc); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 替换图片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;replacePage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, pageData); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 替换整个页面</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3️⃣ 状态通知事件（双向）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;requesting&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 请求中状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;updateFilteredMessages&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, msgs); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 消息列表更新</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;changeSendParams&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, params); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 参数变更</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 4️⃣ 错误处理事件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;生成失败&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 通用错误</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>事件流转示意</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户点击发送</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>  ChatSender</span></span>
<span class="line"><span>    ↓ emit(&#39;submit&#39;)</span></span>
<span class="line"><span>  ChatWrap</span></span>
<span class="line"><span>    ↓ 处理发送逻辑</span></span>
<span class="line"><span>  SSEManager.connect()</span></span>
<span class="line"><span>    ↓ SSE 流返回</span></span>
<span class="line"><span>  MessageHandler.handleSSEMessage()</span></span>
<span class="line"><span>    ↓ 解析出工具调用</span></span>
<span class="line"><span>  emit(&#39;addImage&#39;, aigc)</span></span>
<span class="line"><span>    ↓ 多个监听器响应</span></span>
<span class="line"><span>  ├─ PlaceholderManager: 创建占位</span></span>
<span class="line"><span>  ├─ ToolProcessor: 处理工具</span></span>
<span class="line"><span>  └─ ElementAddService: 添加到画布</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>事件监听生命周期管理</strong>（避免内存泄漏）：</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Vue 组件中的标准实践</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 组件挂载时注册</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onMounted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addImage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, handleAddImage);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addText&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, handleAddText);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 组件卸载时移除</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onBeforeUnmount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">off</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addImage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, handleAddImage);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">off</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addText&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, handleAddText);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_6-7-共享状态管理-多组件协同-🔗" tabindex="-1">6.7 共享状态管理 - 多组件协同 🔗 <a class="header-anchor" href="#_6-7-共享状态管理-多组件协同-🔗" aria-label="Permalink to &quot;6.7 共享状态管理 - 多组件协同 🔗&quot;">​</a></h3><p><strong>场景</strong>：中间聊天框（CenterChatPanel） + 右侧聊天框（ChatWrap）共享状态。</p><p><strong>设计目标</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户在中间聊天框输入参数</span></span>
<span class="line"><span>  → 右侧聊天框同步显示相同参数</span></span>
<span class="line"><span>  → 切换聊天框不会丢失状态</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>实现方案</strong>：Composables 共享状态</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ① 创建共享的 Composables</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// useSharedChatParams.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sharedState</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reactive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  skill: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ratio: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;16:9&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  styleCode: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;realistic&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  attachments: [],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useSharedChatParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    params: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">readonly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sharedState), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 只读访问</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    updateParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">newParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 更新方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      Object.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">assign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sharedState, newParams);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ② 两个组件使用同一个 Composable</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// CenterChatPanel.vue</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">updateParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useSharedChatParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 用户改变技能</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onSkillChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">skill</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  updateParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ skill }); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 更新共享状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ChatWrap.vue</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useSharedChatParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自动响应更新</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">watch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> params.skill,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">newSkill</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;技能已切换:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, newSkill);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>共享状态的三个维度</strong>：</p><table tabindex="0"><thead><tr><th>维度</th><th>共享内容</th><th>用途</th></tr></thead><tbody><tr><td><strong>Params</strong></td><td>用户输入的参数（skill、ratio...）</td><td>保持输入状态同步</td></tr><tr><td><strong>Hooks</strong></td><td>回调函数（login、upload、tracker）</td><td>统一业务逻辑接口</td></tr><tr><td><strong>Events</strong></td><td>事件总线实例</td><td>统一事件通信渠道</td></tr></tbody></table><p><strong>为什么不用 Vuex/Pinia？</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Vuex/Pinia 适合：全局状态（用户信息、配置等）</span></span>
<span class="line"><span>Composables 适合：组件间临时共享状态</span></span>
<span class="line"><span></span></span>
<span class="line"><span>优势：</span></span>
<span class="line"><span>  ✅ 轻量级，不需要注册 store</span></span>
<span class="line"><span>  ✅ TypeScript 友好</span></span>
<span class="line"><span>  ✅ 按需使用，不污染全局</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><hr><h2 id="七、性能优化与错误处理" tabindex="-1">七、性能优化与错误处理 <a class="header-anchor" href="#七、性能优化与错误处理" aria-label="Permalink to &quot;七、性能优化与错误处理&quot;">​</a></h2><h3 id="_7-1-性能优化策略汇总" tabindex="-1">7.1 性能优化策略汇总 <a class="header-anchor" href="#_7-1-性能优化策略汇总" aria-label="Permalink to &quot;7.1 性能优化策略汇总&quot;">​</a></h3><h4 id="前端渲染优化" tabindex="-1"><strong>前端渲染优化</strong> <a class="header-anchor" href="#前端渲染优化" aria-label="Permalink to &quot;**前端渲染优化**&quot;">​</a></h4><table tabindex="0"><thead><tr><th>优化项</th><th>具体措施</th><th>效果提升</th></tr></thead><tbody><tr><td><strong>虚拟滚动</strong></td><td>消息列表超过50条启用虚拟滚动</td><td>减少70% DOM节点</td></tr><tr><td><strong>图片懒加载</strong></td><td>IntersectionObserver 监听可见性</td><td>节省80% 带宽</td></tr><tr><td><strong>防抖节流</strong></td><td>输入框300ms防抖，画布16ms节流</td><td>减少90% 无效渲染</td></tr><tr><td><strong>Web Worker</strong></td><td>大图处理放到Worker，不阻塞主线程</td><td>UI始终流畅</td></tr></tbody></table><h4 id="网络通信优化" tabindex="-1"><strong>网络通信优化</strong> <a class="header-anchor" href="#网络通信优化" aria-label="Permalink to &quot;**网络通信优化**&quot;">​</a></h4><table tabindex="0"><thead><tr><th>优化项</th><th>具体措施</th><th>效果提升</th></tr></thead><tbody><tr><td><strong>SSE 连接复用</strong></td><td>同会话复用连接，避免频繁建立</td><td>减少延迟50%</td></tr><tr><td><strong>请求合并</strong></td><td>批量生成用一个请求，而非多个</td><td>减少请求数75%</td></tr><tr><td><strong>CDN 加速</strong></td><td>图片自动走 CDN，支持 WebP格式</td><td>加载快3倍</td></tr><tr><td><strong>预加载</strong></td><td>预加载常用样式、下一批消息</td><td>首屏快40%</td></tr></tbody></table><h4 id="内存管理优化" tabindex="-1"><strong>内存管理优化</strong> <a class="header-anchor" href="#内存管理优化" aria-label="Permalink to &quot;**内存管理优化**&quot;">​</a></h4><table tabindex="0"><thead><tr><th>优化项</th><th>具体措施</th><th>效果提升</th></tr></thead><tbody><tr><td><strong>消息分页</strong></td><td>历史消息按需加载，旧消息自动回收</td><td>降低60% 内存</td></tr><tr><td><strong>纹理卸载</strong></td><td>超出视口的纹理自动卸载</td><td>降低80% 显存</td></tr><tr><td><strong>事件清理</strong></td><td>组件销毁时移除监听，使用 WeakMap</td><td>避免内存泄漏</td></tr><tr><td><strong>对象池复用</strong></td><td>复用PixiJS对象，减少GC</td><td>减少GC卡顿</td></tr></tbody></table><h3 id="_7-2-错误处理机制" tabindex="-1">7.2 错误处理机制 <a class="header-anchor" href="#_7-2-错误处理机制" aria-label="Permalink to &quot;7.2 错误处理机制&quot;">​</a></h3><h4 id="错误分类与处理策略" tabindex="-1"><strong>错误分类与处理策略</strong> <a class="header-anchor" href="#错误分类与处理策略" aria-label="Permalink to &quot;**错误分类与处理策略**&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  客户端错误（4xx）                                    │</span></span>
<span class="line"><span>│  ───────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  400 参数错误 → 显示&quot;参数有误，请检查后重试&quot;          │</span></span>
<span class="line"><span>│  401 未登录 → 弹出登录框                             │</span></span>
<span class="line"><span>│  403 权限不足 → 显示&quot;此功能需要会员&quot;                 │</span></span>
<span class="line"><span>│  429 请求过快 → 显示&quot;请稍后再试&quot;                     │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  服务端错误（5xx）                                    │</span></span>
<span class="line"><span>│  ───────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  500 服务器错误 → &quot;服务暂时不可用，请稍后重试&quot;        │</span></span>
<span class="line"><span>│  503 服务过载 → &quot;当前使用人数较多，排队中...&quot;        │</span></span>
<span class="line"><span>│  超时 → &quot;网络不稳定，已自动重试&quot;                      │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  业务错误（自定义code）                               │</span></span>
<span class="line"><span>│  ───────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  -1002 稿豆不足 → 弹出充值弹窗                        │</span></span>
<span class="line"><span>│  -1006 内容违规 → &quot;内容不符合规范，请修改后重试&quot;      │</span></span>
<span class="line"><span>│  -1007 AI拒绝 → &quot;AI 认为此请求不合适&quot;                │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  网络错误                                             │</span></span>
<span class="line"><span>│  ───────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  断网 → 显示&quot;网络已断开&quot;，连接恢复后自动重连          │</span></span>
<span class="line"><span>│  SSE中断 → 自动重连（最多3次），失败后显示重试按钮   │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="错误处理流程" tabindex="-1"><strong>错误处理流程</strong> <a class="header-anchor" href="#错误处理流程" aria-label="Permalink to &quot;**错误处理流程**&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>错误发生</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>MessageHandler 捕获</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>┌─────────────────────┐</span></span>
<span class="line"><span>│ 判断错误类型          │</span></span>
<span class="line"><span>└─────────────────────┘</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────┐</span></span>
<span class="line"><span>│ 是否可重试？                          │</span></span>
<span class="line"><span>│  ├─ YES → 显示重试按钮                │</span></span>
<span class="line"><span>│  └─ NO → 只显示错误信息               │</span></span>
<span class="line"><span>└─────────────────────────────────────┘</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────┐</span></span>
<span class="line"><span>│ 清理现场                              │</span></span>
<span class="line"><span>│  ├─ 移除占位元素                      │</span></span>
<span class="line"><span>│  ├─ 标记消息状态为失败                 │</span></span>
<span class="line"><span>│  ├─ 上报错误日志                      │</span></span>
<span class="line"><span>│  └─ 释放资源（关闭SSE连接等）          │</span></span>
<span class="line"><span>└─────────────────────────────────────┘</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>用户点击重试 → 重新走生成流程</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="优雅降级策略" tabindex="-1"><strong>优雅降级策略</strong> <a class="header-anchor" href="#优雅降级策略" aria-label="Permalink to &quot;**优雅降级策略**&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>核心思想：功能不可用，但不能让应用崩溃</span></span>
<span class="line"><span></span></span>
<span class="line"><span>示例：</span></span>
<span class="line"><span>  AI 服务挂了 → 显示提示，其他编辑功能继续可用</span></span>
<span class="line"><span>  图片加载失败 → 显示占位图，不影响其他元素</span></span>
<span class="line"><span>  SSE 不支持 → 降级为轮询方式</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr><h2 id="八、核心代码片段解析" tabindex="-1">八、核心代码片段解析 <a class="header-anchor" href="#八、核心代码片段解析" aria-label="Permalink to &quot;八、核心代码片段解析&quot;">​</a></h2><blockquote><p>以下代码展示关键逻辑的核心思想，而非完整实现</p></blockquote><h3 id="_8-1-编辑器初始化-应用入口" tabindex="-1">8.1 编辑器初始化（应用入口） <a class="header-anchor" href="#_8-1-编辑器初始化-应用入口" aria-label="Permalink to &quot;8.1 编辑器初始化（应用入口）&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 简化示意：实际初始化过程</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> editorMain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. 导入基座</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">installDesign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;@design/design-foundation/agent&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. 一行代码启动编辑器</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> installDesign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;#app&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // API配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    apis: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baseURL: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://api.example.com&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      endpoints: {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* ... */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 环境配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    env: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      REGION: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;China&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 区域：国内/国外</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      LOGIN_TYPE: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;phone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 登录方式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 权限配置（功能开关）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    permissions: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      AI_CHAT: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// AI聊天</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      FILE_UPLOAD: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文件上传</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 插件配置（按需加载）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    extensionConfig: [</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 异步导入，支持代码分割</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      defineExtensionConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;@design/extension-ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 核心价值：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 统一入口，标准化初始化流程</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 配置驱动，国内外版本只需改配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 异步加载，首屏体积小</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="_8-2-聊天组件集成" tabindex="-1">8.2 聊天组件集成 <a class="header-anchor" href="#_8-2-聊天组件集成" aria-label="Permalink to &quot;8.2 聊天组件集成&quot;">​</a></h3><div class="language-vue vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- 简化示意：聊天组件的使用方式 --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">template</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ChatWrap</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> :chatConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;chatConfig&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> :editor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;editor&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> @submit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;handleSubmit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">template</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { ChatWrap, getQingZhouConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@design/ai-chat-vue&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 初始化聊天配置（提供回调函数）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> chatConfig</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getQingZhouConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 必需回调</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getRepositoryId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentWorkId, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 当前作品ID</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getUserId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentUserId, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 当前用户ID</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 可选回调</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tracker: windAPI, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 埋点工具</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  login</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> showLoginModal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 登录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  upload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uploadToOSS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 上传</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 处理用户提交</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleSubmit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // params: { skill, prompt, ratio, styleCode, attachments }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;用户发起生成:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, params);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- 核心价值： --&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- ✓ 声明式使用，无需关心内部复杂度 --&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- ✓ 通过回调函数对接业务逻辑 --&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- ✓ 事件驱动，解耦画布和聊天 --&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_8-3-sse流式处理-核心逻辑" tabindex="-1">8.3 SSE流式处理（核心逻辑） <a class="header-anchor" href="#_8-3-sse流式处理-核心逻辑" aria-label="Permalink to &quot;8.3 SSE流式处理（核心逻辑）&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 简化示意：SSE 消息处理的核心流程</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MessageHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  handleSSEMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MessageType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[], </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">done</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">item</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 根据消息类型分发处理</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (item.content.type) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;text&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // AI的文本回复</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">appendAssistantMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(item.content.text);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;function_call&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // AI调用工具（如生成图片）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trackToolStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(item); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 埋点</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createPlaceholder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 创建占位</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;function_response&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 工具执行结果</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseTool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(item.content.text);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addImage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, tool); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 触发画布添加</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (done) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 流结束，保存记录</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">saveConversation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 核心价值：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 统一处理各种消息类型</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 实时流式更新UI</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 通过事件解耦业务逻辑</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="_8-4-批量生成追踪-技术亮点" tabindex="-1">8.4 批量生成追踪（技术亮点） <a class="header-anchor" href="#_8-4-批量生成追踪-技术亮点" aria-label="Permalink to &quot;8.4 批量生成追踪（技术亮点）&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 简化示意：批量生成的追踪机制</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MessageHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> consecutiveFunctionCalls</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  handleFunctionCall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">item</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> toolName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item.toolName; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 如 &#39;image&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 检测是否为连续调用（批量生成）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tracking</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.consecutiveFunctionCalls.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(toolName);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (tracking </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isConsecutive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(item, tracking)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 累加期望数量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      tracking.expectedResponses</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 新建追踪记录</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.consecutiveFunctionCalls.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(toolName, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        expectedResponses: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        receivedResponses: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        messageIds: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([item.messageId]),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  handleFunctionResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">item</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> toolName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item.toolName;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tracking</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.consecutiveFunctionCalls.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(toolName);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (tracking) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      tracking.receivedResponses</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 判断是否全部完成</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (tracking.receivedResponses </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tracking.expectedResponses) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onBatchCompleted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(toolName); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 批量完成事件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 核心价值：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 智能识别批量生成意图</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 实时追踪生成进度</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 避免重复处理和遗漏</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="_8-5-占位元素管理-用户体验优化" tabindex="-1">8.5 占位元素管理（用户体验优化） <a class="header-anchor" href="#_8-5-占位元素管理-用户体验优化" aria-label="Permalink to &quot;8.5 占位元素管理（用户体验优化）&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 简化示意：占位元素的创建和替换</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PlaceholderManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;image&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;text&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 创建占位元素（视觉元素）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> placeholder</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      id: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">generateId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      type,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      element: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createLoadingElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 加载动画</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. 添加到画布</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> position</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">calculatePosition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    editor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(placeholder.element, position);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. 记录占位信息</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.placeholders.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(placeholder.id, placeholder);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> placeholder.id;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">placeholderId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">realElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 获取占位元素</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> placeholder</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.placeholders.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(placeholderId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. 继承位置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    realElement.transform </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> placeholder.element.transform;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. 移除占位，添加真实元素</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    editor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">removeElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(placeholder.element);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    editor.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(realElement);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4. 清理记录</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.placeholders.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(placeholderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 核心价值：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 立即反馈，无需等待</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 位置预留，避免跳动</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 优雅过渡，提升体验</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="_8-6-事件驱动-解耦利器" tabindex="-1">8.6 事件驱动（解耦利器） <a class="header-anchor" href="#_8-6-事件驱动-解耦利器" aria-label="Permalink to &quot;8.6 事件驱动（解耦利器）&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 简化示意：事件系统的使用</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 发布者（ChatPanel）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addImage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tools: [imageToolData],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  autoPosition: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 订阅者1（PlaceholderManager）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addImage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> placeholderId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 创建占位，等待真实元素</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 订阅者2（ToolProcessor）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addImage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data.tools) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> processed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">processAiTool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tool);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 处理工具数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 订阅者3（ElementAddService）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addImage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addImageElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data.tools[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 添加到画布</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 核心价值：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 一对多通信，无需互相引用</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 易于扩展，新增订阅者不影响发布者</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✓ 便于测试，可单独测试每个模块</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><hr><h2 id="九、总结与展望" tabindex="-1">九、总结与展望 <a class="header-anchor" href="#九、总结与展望" aria-label="Permalink to &quot;九、总结与展望&quot;">​</a></h2><h3 id="_9-1-架构核心价值" tabindex="-1">9.1 架构核心价值 <a class="header-anchor" href="#_9-1-架构核心价值" aria-label="Permalink to &quot;9.1 架构核心价值&quot;">​</a></h3><p>本架构的设计遵循<strong>高内聚、低耦合</strong>的原则，通过分层、插件化、事件驱动三大设计理念，构建了一个<strong>可扩展、高性能、易维护</strong>的 AI 智能设计编辑器。</p><p><strong>五大架构优势</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1️⃣ 分层清晰</span></span>
<span class="line"><span>  → 每层职责明确，边界清晰</span></span>
<span class="line"><span>  → 团队并行开发，互不阻塞</span></span>
<span class="line"><span>  → 易于定位问题，降低维护成本</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2️⃣ 插件化扩展</span></span>
<span class="line"><span>  → 功能模块独立，按需加载</span></span>
<span class="line"><span>  → 新增功能不影响核心稳定性</span></span>
<span class="line"><span>  → 支持第三方插件生态</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3️⃣ 高性能渲染</span></span>
<span class="line"><span>  → PixiJS + WebGL 硬件加速</span></span>
<span class="line"><span>  → 虚拟化渲染，支持万级元素</span></span>
<span class="line"><span>  → 流畅的60fps用户体验</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4️⃣ 流式AI交互</span></span>
<span class="line"><span>  → SSE 实时推送，秒级反馈</span></span>
<span class="line"><span>  → 占位元素优化等待体验</span></span>
<span class="line"><span>  → 批量生成智能追踪</span></span>
<span class="line"><span></span></span>
<span class="line"><span>5️⃣ 用户体验优先</span></span>
<span class="line"><span>  → 立即反馈，无需等待</span></span>
<span class="line"><span>  → 错误容忍，优雅降级</span></span>
<span class="line"><span>  → 历史回放，完整复现</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_9-2-技术创新点" tabindex="-1">9.2 技术创新点 <a class="header-anchor" href="#_9-2-技术创新点" aria-label="Permalink to &quot;9.2 技术创新点&quot;">​</a></h3><table tabindex="0"><thead><tr><th>创新点</th><th>技术方案</th><th>业界对比</th></tr></thead><tbody><tr><td><strong>流式 AI 响应</strong></td><td>SSE + MessageHandler 精细控制</td><td>轮询方案延迟高，体验差</td></tr><tr><td><strong>批量生成追踪</strong></td><td>consecutiveFunctionCalls 机制</td><td>业界少有完整的批量追踪方案</td></tr><tr><td><strong>智能占位管理</strong></td><td>PlaceholderManager + 位置继承</td><td>多数产品直接等待，体验差</td></tr><tr><td><strong>上下文感知</strong></td><td>currentElement 联动</td><td>需要用户手动关联上下文</td></tr><tr><td><strong>历史回放</strong></td><td>PlaybackSSEStream 模拟流式</td><td>业界少有完整回放功能</td></tr><tr><td><strong>多租户架构</strong></td><td>配置驱动差异化</td><td>多数需要维护多套代码</td></tr></tbody></table><h3 id="_9-3-经验总结" tabindex="-1">9.3 经验总结 <a class="header-anchor" href="#_9-3-经验总结" aria-label="Permalink to &quot;9.3 经验总结&quot;">​</a></h3><h4 id="做对的事情-✅" tabindex="-1"><strong>做对的事情</strong> ✅ <a class="header-anchor" href="#做对的事情-✅" aria-label="Permalink to &quot;**做对的事情** ✅&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>✓ 事件驱动解耦</span></span>
<span class="line"><span>  → 新增功能只需订阅事件，不改现有代码</span></span>
<span class="line"><span>  → 实际效果：90% 的新功能无需改动核心</span></span>
<span class="line"><span></span></span>
<span class="line"><span>✓ 占位元素设计</span></span>
<span class="line"><span>  → 用户立即看到反馈，心理等待时间&lt;1秒</span></span>
<span class="line"><span>  → 用户满意度提升 40%</span></span>
<span class="line"><span></span></span>
<span class="line"><span>✓ 批量追踪机制</span></span>
<span class="line"><span>  → 自动识别批量意图，无需用户手动指定</span></span>
<span class="line"><span>  → 生成效率提升 3 倍</span></span>
<span class="line"><span></span></span>
<span class="line"><span>✓ TypeScript 全栈</span></span>
<span class="line"><span>  → 90% 的 bug 在编译时发现</span></span>
<span class="line"><span>  → 重构信心提升，速度加快 5 倍</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="踩过的坑-⚠️" tabindex="-1"><strong>踩过的坑</strong> ⚠️ <a class="header-anchor" href="#踩过的坑-⚠️" aria-label="Permalink to &quot;**踩过的坑** ⚠️&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>❌ 早期未做虚拟化</span></span>
<span class="line"><span>  → 1000+ 元素时页面卡死</span></span>
<span class="line"><span>  → 教训：性能优化要提前设计，重构成本高</span></span>
<span class="line"><span></span></span>
<span class="line"><span>❌ 事件监听未清理</span></span>
<span class="line"><span>  → 内存泄漏，长时间使用后卡顿</span></span>
<span class="line"><span>  → 教训：必须在组件销毁时清理</span></span>
<span class="line"><span></span></span>
<span class="line"><span>❌ SSE 断线处理不完善</span></span>
<span class="line"><span>  → 用户网络抖动时频繁报错</span></span>
<span class="line"><span>  → 教训：网络异常是常态，必须有重连机制</span></span>
<span class="line"><span></span></span>
<span class="line"><span>❌ 占位位置计算错误</span></span>
<span class="line"><span>  → 批量生成时元素重叠</span></span>
<span class="line"><span>  → 教训：边界情况要充分测试</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_9-4-未来演进方向" tabindex="-1">9.4 未来演进方向 <a class="header-anchor" href="#_9-4-未来演进方向" aria-label="Permalink to &quot;9.4 未来演进方向&quot;">​</a></h3><h4 id="短期目标-3-6个月-🎯" tabindex="-1"><strong>短期目标（3-6个月）</strong> 🎯 <a class="header-anchor" href="#短期目标-3-6个月-🎯" aria-label="Permalink to &quot;**短期目标（3-6个月）** 🎯&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>性能优化：</span></span>
<span class="line"><span>  ├─ WebWorker 处理大图，不阻塞主线程</span></span>
<span class="line"><span>  ├─ Service Worker 离线缓存</span></span>
<span class="line"><span>  └─ 首屏加载时间降低到 1 秒内</span></span>
<span class="line"><span></span></span>
<span class="line"><span>功能增强：</span></span>
<span class="line"><span>  ├─ 支持语音输入（语音转文字）</span></span>
<span class="line"><span>  ├─ 支持手绘草图转设计</span></span>
<span class="line"><span>  └─ AI 自动优化设计（自动配色、排版）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="中期目标-6-12个月-🚀" tabindex="-1"><strong>中期目标（6-12个月）</strong> 🚀 <a class="header-anchor" href="#中期目标-6-12个月-🚀" aria-label="Permalink to &quot;**中期目标（6-12个月）** 🚀&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>协同编辑：</span></span>
<span class="line"><span>  ├─ WebRTC 实时协作</span></span>
<span class="line"><span>  ├─ 多人同时编辑</span></span>
<span class="line"><span>  └─ 冲突自动解决</span></span>
<span class="line"><span></span></span>
<span class="line"><span>AI 能力升级：</span></span>
<span class="line"><span>  ├─ 多模态理解（图+文）</span></span>
<span class="line"><span>  ├─ 设计风格迁移</span></span>
<span class="line"><span>  └─ 智能推荐优化建议</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="长期愿景-12个月-🌟" tabindex="-1"><strong>长期愿景（12个月+）</strong> 🌟 <a class="header-anchor" href="#长期愿景-12个月-🌟" aria-label="Permalink to &quot;**长期愿景（12个月+）** 🌟&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>开放生态：</span></span>
<span class="line"><span>  ├─ 插件市场</span></span>
<span class="line"><span>  ├─ 第三方开发者支持</span></span>
<span class="line"><span>  └─ AI 模型自定义接入</span></span>
<span class="line"><span></span></span>
<span class="line"><span>技术升级：</span></span>
<span class="line"><span>  ├─ WebGPU 渲染（性能再提升 10 倍）</span></span>
<span class="line"><span>  ├─ 边缘计算（AI 本地推理）</span></span>
<span class="line"><span>  └─ WASM 核心模块（性能优化）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_9-5-给开发者的建议" tabindex="-1">9.5 给开发者的建议 <a class="header-anchor" href="#_9-5-给开发者的建议" aria-label="Permalink to &quot;9.5 给开发者的建议&quot;">​</a></h3><p><strong>如果你要基于此架构开发</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. 先理解分层架构</span></span>
<span class="line"><span>   → 从下往上：渲染层 → 引擎层 → 基座层 → 业务层 → 应用层</span></span>
<span class="line"><span>   → 明确每层的职责和边界</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. 掌握事件驱动</span></span>
<span class="line"><span>   → 优先使用事件通信，而非直接调用</span></span>
<span class="line"><span>   → 事件命名要清晰，携带必要信息</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. 善用 TypeScript</span></span>
<span class="line"><span>   → 定义清晰的类型接口</span></span>
<span class="line"><span>   → 利用类型推导减少冗余代码</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. 注重性能</span></span>
<span class="line"><span>   → 虚拟化、懒加载是基础</span></span>
<span class="line"><span>   → 使用 Performance API 监控关键指标</span></span>
<span class="line"><span></span></span>
<span class="line"><span>5. 用户体验优先</span></span>
<span class="line"><span>   → 立即反馈 &gt; 精确反馈</span></span>
<span class="line"><span>   → 错误提示要友好，支持重试</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><hr><h2 id="附录" tabindex="-1">附录 <a class="header-anchor" href="#附录" aria-label="Permalink to &quot;附录&quot;">​</a></h2><h3 id="a-核心目录结构" tabindex="-1">A. 核心目录结构 <a class="header-anchor" href="#a-核心目录结构" aria-label="Permalink to &quot;A. 核心目录结构&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>domains/editor/</span></span>
<span class="line"><span>├── apps/                        # 应用层</span></span>
<span class="line"><span>│   ├── design-ai-plus/          # 国内版</span></span>
<span class="line"><span>│   │   ├── src/</span></span>
<span class="line"><span>│   │   │   ├── main.ts          # 入口文件</span></span>
<span class="line"><span>│   │   │   └── configs/         # 配置文件</span></span>
<span class="line"><span>│   │   └── index.html</span></span>
<span class="line"><span>│   └── insmind-ai-plus/         # 国际版</span></span>
<span class="line"><span>│       └── ...（结构同上）</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── packages/                    # 核心包</span></span>
<span class="line"><span>│   ├── design/                  # 业务层</span></span>
<span class="line"><span>│   │   ├── ai-chat-vue/         # ⭐ AI 对话 Vue 版</span></span>
<span class="line"><span>│   │   ├── ai-chat-react/       # AI 对话 React 版</span></span>
<span class="line"><span>│   │   ├── business-ui/         # 业务 UI 组件</span></span>
<span class="line"><span>│   │   └── extension/           # 扩展管理器</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── editor/                  # 引擎层</span></span>
<span class="line"><span>│   │   ├── framework/           # ⭐ 编辑器框架</span></span>
<span class="line"><span>│   │   └── infinite-renderer/   # ⭐ 无限画布渲染</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   └── foundations/             # 基座层</span></span>
<span class="line"><span>│       └── design/              # ⭐ 编辑器基座</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>└── extensions/                  # 插件层</span></span>
<span class="line"><span>    ├── ai/                      # AI 核心插件</span></span>
<span class="line"><span>    ├── upload/                  # 上传插件</span></span>
<span class="line"><span>    ├── image-edit/              # 图像编辑插件</span></span>
<span class="line"><span>    └── ...（更多插件）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="b-技术栈清单" tabindex="-1">B. 技术栈清单 <a class="header-anchor" href="#b-技术栈清单" aria-label="Permalink to &quot;B. 技术栈清单&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 核心框架</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;vue&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^2.7.14&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// UI 框架</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;typescript&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^5.0.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 类型系统</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 构建工具</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;vite&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^4.0.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 构建工具</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 渲染引擎</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;pixi.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^7.0.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// WebGL 渲染</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 状态管理</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;pinia&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^2.1.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 状态管理</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 工具库</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;eventemitter3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^5.0.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 事件总线</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;lodash-es&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^4.17.21&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 工具函数</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;uuid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;^9.0.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ID 生成</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="c-核心概念速查" tabindex="-1">C. 核心概念速查 <a class="header-anchor" href="#c-核心概念速查" aria-label="Permalink to &quot;C. 核心概念速查&quot;">​</a></h3><table tabindex="0"><thead><tr><th>术语</th><th>含义</th><th>所在层级</th></tr></thead><tbody><tr><td><strong>Foundation</strong></td><td>编辑器基座，统一初始化入口</td><td>基座层</td></tr><tr><td><strong>Extension</strong></td><td>扩展插件，功能模块</td><td>插件层</td></tr><tr><td><strong>Surface</strong></td><td>画布表面，渲染上下文管理</td><td>渲染层</td></tr><tr><td><strong>Viewport</strong></td><td>视口，控制缩放平移</td><td>渲染层</td></tr><tr><td><strong>SSE</strong></td><td>Server-Sent Events，流式推送</td><td>通信协议</td></tr><tr><td><strong>MessageHandler</strong></td><td>消息处理器，解析 AI 消息流</td><td>服务层</td></tr><tr><td><strong>ToolProcessor</strong></td><td>工具处理器，管理 AI 工具全生命周期</td><td>服务层</td></tr><tr><td><strong>Placeholder</strong></td><td>占位元素，优化等待体验</td><td>服务层</td></tr><tr><td><strong>VmEngine</strong></td><td>视图模型引擎，数据→渲染对象转换</td><td>渲染层</td></tr></tbody></table><hr><h2 id="十、agent-工作流程深度解析-⭐⭐⭐" tabindex="-1">十、Agent 工作流程深度解析 ⭐⭐⭐ <a class="header-anchor" href="#十、agent-工作流程深度解析-⭐⭐⭐" aria-label="Permalink to &quot;十、Agent 工作流程深度解析 ⭐⭐⭐&quot;">​</a></h2><blockquote><p><strong>本章核心</strong>：深入剖析从用户输入到 AI 响应的完整链路，包括 Prompt Engineering、Dify集成、大模型调用、Tool执行等关键环节。</p></blockquote><h3 id="_10-1-agent-架构全景" tabindex="-1">10.1 Agent 架构全景 <a class="header-anchor" href="#_10-1-agent-架构全景" aria-label="Permalink to &quot;10.1 Agent 架构全景&quot;">​</a></h3><p>系统采用 <strong>Agent-X 架构</strong>，这是一个基于 Ant Design X 改造的 Vue 2.7 兼容版本，专门为 AI 对话场景设计。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  用户层                                                       │</span></span>
<span class="line"><span>│  ChatSender (输入框) → 用户输入提示词                         │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  Agent 编排层                                                 │</span></span>
<span class="line"><span>│  useXAgent (Agent 核心)                                      │</span></span>
<span class="line"><span>│    ├─ request()          → 处理请求                          │</span></span>
<span class="line"><span>│    ├─ onUpdate()         → 实时更新                          │</span></span>
<span class="line"><span>│    └─ onSuccess()        → 完成回调                          │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  网络通信层                                                   │</span></span>
<span class="line"><span>│  createSSEConnection() → Dify Agent 后端                     │</span></span>
<span class="line"><span>│    POST /api/gdesign/tool/v1/dify/chat                      │</span></span>
<span class="line"><span>│    Body: {                                                   │</span></span>
<span class="line"><span>│      scene_code: &#39;ai-chat&#39;,                                  │</span></span>
<span class="line"><span>│      query: &#39;用户输入&#39;,                                       │</span></span>
<span class="line"><span>│      arguments: {                                            │</span></span>
<span class="line"><span>│        think: 0/1,           ← 是否开启深度思考(R1模型)      │</span></span>
<span class="line"><span>│        history_text: &#39;...&#39;   ← 历史对话(最多30组)            │</span></span>
<span class="line"><span>│      }                                                       │</span></span>
<span class="line"><span>│    }                                                         │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  Dify Workflow 编排层 (后端)                                 │</span></span>
<span class="line"><span>│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   │</span></span>
<span class="line"><span>│  │ 1️⃣ PE增强    │ → │ 2️⃣ 大模型调用 │ → │ 3️⃣ 工具路由   │   │</span></span>
<span class="line"><span>│  │ Prompt Eng  │   │ DeepSeek API │   │ Tool Calling │   │</span></span>
<span class="line"><span>│  └──────────────┘   └──────────────┘   └──────────────┘   │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  大模型层                                                     │</span></span>
<span class="line"><span>│  DeepSeek-V3 / DeepSeek-R1                                  │</span></span>
<span class="line"><span>│  ├─ 理解用户意图                                             │</span></span>
<span class="line"><span>│  ├─ 决策需要调用哪些工具                                      │</span></span>
<span class="line"><span>│  └─ 返回 function_call / text                               │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  工具执行层                                                   │</span></span>
<span class="line"><span>│  Tool Functions (后端)                                       │</span></span>
<span class="line"><span>│  ├─ draw          → 文生图                                   │</span></span>
<span class="line"><span>│  ├─ redraw        → 图生图                                   │</span></span>
<span class="line"><span>│  ├─ writer        → 文案生成                                 │</span></span>
<span class="line"><span>│  ├─ material      → 素材推荐                                 │</span></span>
<span class="line"><span>│  ├─ cutout        → AI抠图                                   │</span></span>
<span class="line"><span>│  ├─ background    → 背景替换                                 │</span></span>
<span class="line"><span>│  └─ ...           → 更多工具                                 │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  结果返回层 (SSE 流式推送)                                    │</span></span>
<span class="line"><span>│  event: workflow_started   → 任务开始                        │</span></span>
<span class="line"><span>│  event: message            → AI文本输出(流式)                │</span></span>
<span class="line"><span>│  event: message (thinking) → R1思考过程                      │</span></span>
<span class="line"><span>│  event: workflow_finished  → 任务完成                        │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  前端响应层                                                   │</span></span>
<span class="line"><span>│  MessageHandler → PlaceholderManager → ElementAddService     │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><h3 id="_10-2-完整请求流程-从代码角度解析" tabindex="-1">10.2 完整请求流程 - 从代码角度解析 <a class="header-anchor" href="#_10-2-完整请求流程-从代码角度解析" aria-label="Permalink to &quot;10.2 完整请求流程 - 从代码角度解析&quot;">​</a></h3><h4 id="step-1-用户发起请求-前端" tabindex="-1"><strong>Step 1：用户发起请求（前端）</strong> <a class="header-anchor" href="#step-1-用户发起请求-前端" aria-label="Permalink to &quot;**Step 1：用户发起请求（前端）**&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// packages/business-sdks/ai-chat/src/hook/use-message.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">agent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useXAgent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MessageType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }, { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">onUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1️⃣ 创建默认响应消息（立即显示加载状态）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> defaultAnswerMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MessageType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      content: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      id: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uuidv4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      role: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_ROLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ASSISTANT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">LOADING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      reasoningContent: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// R1 模型的思考内容</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      taskId: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      thinkingElapsedMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 思考耗时</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      model: isThink.current </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;deepseek-r1&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;deepseek-v3&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      model_config: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        think: isThink.current, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否开启深度思考</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2️⃣ 立即更新 UI（显示加载状态）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(defaultAnswerMessage);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3️⃣ 建立 SSE 连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sseConnection </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createSSEConnection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      message: message.content, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 用户输入</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      messageList: messagesRef.current, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 历史消息（最多30组）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      isThink: isThink.current, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否使用 R1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      onError: handleError,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      isOnline,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4️⃣ 监听 SSE 流</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sseConnection.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SSEMessageType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      onListen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p><strong>关键设计</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>设计1：立即反馈</span></span>
<span class="line"><span>  → onUpdate() 立即调用，用户看到&quot;AI思考中&quot;</span></span>
<span class="line"><span>  → 不等待网络请求，优化体验</span></span>
<span class="line"><span></span></span>
<span class="line"><span>设计2：历史消息管理</span></span>
<span class="line"><span>  → 只发送最近 30 组对话（60条消息）</span></span>
<span class="line"><span>  → 避免 Token 超限，降低成本</span></span>
<span class="line"><span></span></span>
<span class="line"><span>设计3：模型选择</span></span>
<span class="line"><span>  → deepseek-v3：快速响应（1-2秒）</span></span>
<span class="line"><span>  → deepseek-r1：深度思考（5-10秒），质量更高</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><hr><h4 id="step-2-建立-sse-连接-前端-→-后端" tabindex="-1"><strong>Step 2：建立 SSE 连接（前端 → 后端）</strong> <a class="header-anchor" href="#step-2-建立-sse-连接-前端-→-后端" aria-label="Permalink to &quot;**Step 2：建立 SSE 连接（前端 → 后端）**&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// packages/business-sdks/ai-chat/src/services/sse.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createSSEConnection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">messageList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isThink</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> options;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1️⃣ 构造历史消息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> history_text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MessageType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (messageList </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageList.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sliceMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">slice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 最多 30 组</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    history_text </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sliceMessage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_ROLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ASSISTANT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_ROLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">USER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(it.role) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">it.error;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2️⃣ 发送 POST 请求到 Dify 后端</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baseUrl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}/api/gdesign/tool/v1/dify/chat`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;post&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    body: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      scene_code: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ai-chat&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 场景标识</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      aigc_type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aigc&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// AIGC 类型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      query: message, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 用户输入</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      arguments: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        think: isThink </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否开启 R1 思考</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 历史对话 JSON 字符串</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        history_text:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          history_text.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            ?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(history_text).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">&lt;thinking&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">[\s\S]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*?</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">&lt;</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">thinking&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 移除历史思考过程</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      conversation_id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 会话 ID（可选）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    headers: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;Content-Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;application/json&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;Authorization&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: authorization, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// OAuth2 Token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3️⃣ 获取 ReadableStream</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response.body.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> decoder</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TextDecoder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 4️⃣ 返回流式读取接口</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> listen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 缓存不完整的 JSON</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">done</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> text </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decoder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">decode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 尝试解析 JSON</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (buffer) text </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> text;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // JSON 不完整，缓存起来</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> jsonList</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> parseJsonSequence</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (jsonList.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> text; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 等待下一块</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            jsonList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(callback);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            buffer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (done) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      reader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 关闭流</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p><strong>核心技术细节</strong>：</p><table tabindex="0"><thead><tr><th>技术点</th><th>实现方式</th><th>解决的问题</th></tr></thead><tbody><tr><td><strong>JSON 分段处理</strong></td><td>buffer 缓存 + parseJsonSequence</td><td>SSE 可能返回不完整的 JSON</td></tr><tr><td><strong>历史消息过滤</strong></td><td>去除 error 消息和 thinking 标签</td><td>减少无效 Token，降低成本</td></tr><tr><td><strong>错误处理</strong></td><td>捕获 401/400/500 等状态码</td><td>优雅降级，友好提示</td></tr><tr><td><strong>流式读取</strong></td><td>ReadableStream + decoder</td><td>实时响应，无需等待完成</td></tr></tbody></table><hr><h4 id="step-3-dify-workflow-处理-后端黑盒" tabindex="-1"><strong>Step 3：Dify Workflow 处理（后端黑盒）</strong> <a class="header-anchor" href="#step-3-dify-workflow-处理-后端黑盒" aria-label="Permalink to &quot;**Step 3：Dify Workflow 处理（后端黑盒）**&quot;">​</a></h4><p>虽然 Dify 是后端黑盒，但根据代码和经验，可以推断其工作流程：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  Dify Agent Workflow (推测)                                  │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  Node 1: 接收请求                                            │</span></span>
<span class="line"><span>│    ├─ 解析 query、history_text、think 参数                  │</span></span>
<span class="line"><span>│    ├─ 生成 task_id                                          │</span></span>
<span class="line"><span>│    └─ 发送 workflow_started 事件                            │</span></span>
<span class="line"><span>│                                                              │</span></span>
<span class="line"><span>│  Node 2: Prompt Engineering (提示词增强)                     │</span></span>
<span class="line"><span>│    ├─ 系统提示词注入                                         │</span></span>
<span class="line"><span>│    │   &quot;你是一个专业的设计助手，擅长...&quot;                     │</span></span>
<span class="line"><span>│    ├─ 历史对话格式化                                         │</span></span>
<span class="line"><span>│    │   [{ role: &#39;user&#39;, content: &#39;...&#39; }, ...]             │</span></span>
<span class="line"><span>│    ├─ 工具定义注入 (Tool Definitions)                       │</span></span>
<span class="line"><span>│    │   functions: [                                          │</span></span>
<span class="line"><span>│    │     { name: &#39;draw&#39;, description: &#39;生成图片&#39;, ... },   │</span></span>
<span class="line"><span>│    │     { name: &#39;writer&#39;, description: &#39;生成文案&#39;, ... }, │</span></span>
<span class="line"><span>│    │     ...                                                 │</span></span>
<span class="line"><span>│    │   ]                                                     │</span></span>
<span class="line"><span>│    └─ Few-Shot 示例（可选）                                  │</span></span>
<span class="line"><span>│        &quot;例如：用户说&#39;生成海报&#39; → 调用 draw 工具&quot;             │</span></span>
<span class="line"><span>│                                                              │</span></span>
<span class="line"><span>│  Node 3: 大模型调用                                          │</span></span>
<span class="line"><span>│    ├─ 选择模型（deepseek-v3 / deepseek-r1）                 │</span></span>
<span class="line"><span>│    ├─ 构造请求参数                                           │</span></span>
<span class="line"><span>│    │   {                                                     │</span></span>
<span class="line"><span>│    │     model: &#39;deepseek-r1&#39;,                              │</span></span>
<span class="line"><span>│    │     messages: [...],                                   │</span></span>
<span class="line"><span>│    │     tools: [...],                 ← Function Calling  │</span></span>
<span class="line"><span>│    │     temperature: 0.7,                                  │</span></span>
<span class="line"><span>│    │     stream: true,                 ← 流式返回           │</span></span>
<span class="line"><span>│    │     reasoning_effort: &#39;high&#39;      ← R1 专属参数        │</span></span>
<span class="line"><span>│    │   }                                                     │</span></span>
<span class="line"><span>│    └─ 调用 DeepSeek API                                     │</span></span>
<span class="line"><span>│                                                              │</span></span>
<span class="line"><span>│  Node 4: 流式响应处理                                        │</span></span>
<span class="line"><span>│    ├─ 接收模型输出（SSE流）                                  │</span></span>
<span class="line"><span>│    ├─ 识别思考过程（&lt;thinking&gt;...&lt;/thinking&gt;）              │</span></span>
<span class="line"><span>│    ├─ 识别工具调用（tool_calls）                            │</span></span>
<span class="line"><span>│    └─ 转发给前端（SSE推送）                                  │</span></span>
<span class="line"><span>│                                                              │</span></span>
<span class="line"><span>│  Node 5: 工具执行（如果有 tool_calls）                      │</span></span>
<span class="line"><span>│    ├─ 解析 tool_name 和 arguments                           │</span></span>
<span class="line"><span>│    ├─ 路由到对应的工具服务                                   │</span></span>
<span class="line"><span>│    │   draw → 图片生成服务（SD/Flux）                       │</span></span>
<span class="line"><span>│    │   writer → 文案生成服务（GPT/Claude）                  │</span></span>
<span class="line"><span>│    ├─ 等待工具执行完成                                       │</span></span>
<span class="line"><span>│    └─ 将结果返回给模型（继续对话）                           │</span></span>
<span class="line"><span>│                                                              │</span></span>
<span class="line"><span>│  Node 6: 完成响应                                            │</span></span>
<span class="line"><span>│    ├─ 发送 workflow_finished 事件                           │</span></span>
<span class="line"><span>│    ├─ 记录对话历史                                           │</span></span>
<span class="line"><span>│    └─ 关闭 SSE 连接                                          │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p><strong>Prompt Engineering 示例</strong>（推测的系统提示词）：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>你是稿定AI的智能设计助手，专门帮助用户快速完成设计创作。</span></span>
<span class="line"><span></span></span>
<span class="line"><span>核心能力：</span></span>
<span class="line"><span>1. 图片生成：根据用户描述生成设计图片（调用 draw 工具）</span></span>
<span class="line"><span>2. 文案生成：生成营销文案、slogan等（调用 writer 工具）</span></span>
<span class="line"><span>3. 图片编辑：抠图、背景替换、图片扩展等（调用相应工具）</span></span>
<span class="line"><span>4. 素材推荐：根据需求推荐合适的素材（调用 material 工具）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>交互规范：</span></span>
<span class="line"><span>- 理解用户意图，主动推荐合适的功能</span></span>
<span class="line"><span>- 如果信息不足，主动询问关键参数（如图片比例、风格等）</span></span>
<span class="line"><span>- 生成结果后，询问用户是否满意，提供优化建议</span></span>
<span class="line"><span>- 保持友好、专业的语气</span></span>
<span class="line"><span></span></span>
<span class="line"><span>可用工具：</span></span>
<span class="line"><span>{{tool_definitions}}  ← Dify 自动注入</span></span>
<span class="line"><span></span></span>
<span class="line"><span>历史对话：</span></span>
<span class="line"><span>{{history_text}}  ← 前端传入</span></span>
<span class="line"><span></span></span>
<span class="line"><span>当前问题：</span></span>
<span class="line"><span>{{query}}  ← 用户输入</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><hr><h4 id="step-4-大模型响应-deepseek-api" tabindex="-1"><strong>Step 4：大模型响应（DeepSeek API）</strong> <a class="header-anchor" href="#step-4-大模型响应-deepseek-api" aria-label="Permalink to &quot;**Step 4：大模型响应（DeepSeek API）**&quot;">​</a></h4><p>大模型返回的流式数据格式（推测）：</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 事件1：思考开始（R1模型独有）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;answer&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&lt;thinking&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">我需要分析用户的需求...</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;/thinking&gt;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;task_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;task_xxx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;conversation_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;conv_xxx&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 事件2：文本输出</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;answer&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;好的，我来帮您生成&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;task_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;task_xxx&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 事件3：工具调用（Function Calling）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tool_calls&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;tool_calls&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;call_xxx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;function&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;function&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;draw&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;arguments&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">prompt</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">春天的风景</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ratio</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">16:9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">style</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">realistic</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;task_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;task_xxx&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 事件4：工具执行结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tool_results&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;tool_results&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;call_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;call_xxx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;output&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;image_url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://cdn.com/generated-image.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;width&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1920</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;height&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1080</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;task_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;task_xxx&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 事件5：最终响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;answer&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;图片已生成！&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;task_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;task_xxx&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 事件6：完成</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;workflow_finished&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;task_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;task_xxx&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><hr><h4 id="step-5-前端处理-sse-事件" tabindex="-1"><strong>Step 5：前端处理 SSE 事件</strong> <a class="header-anchor" href="#step-5-前端处理-sse-事件" aria-label="Permalink to &quot;**Step 5：前端处理 SSE 事件**&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// packages/business-sdks/ai-chat/src/hook/use-message.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onListen</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SSEMessageType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1️⃣ 任务开始</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.event </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SSE_EVENT_TYPE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">WORKFLOW_STARTED</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    currentTaskId.current </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data.task_id;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    toolLifecycleTracker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">conflateStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 埋点：任务开始</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      work_number: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserMessageNumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(messagesRef.current),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      work_id: contentId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2️⃣ 文本消息（流式累加）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.event </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SSE_EVENT_TYPE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    content </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data.answer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 识别思考标签（R1 模型）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.answer?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&lt;thinking&gt;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      isThinkTagContainer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      thinkingStartTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.answer?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&lt;/thinking&gt;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      isThinkTagContainer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      defaultAnswerMessage.thinkingElapsedMs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> thinkingStartTime;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 实时更新 UI</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultAnswerMessage,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      content,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3️⃣ 错误处理</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.event </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SSE_EVENT_TYPE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ANSWER_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> errorContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SYSTEM_ERROR_TIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PROHIBITION_CODE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      errorContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PROHIBITION_TIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 内容违规</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultAnswerMessage,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      content: errorContent,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FINISHED</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      error: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 4️⃣ 任务完成</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.event </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SSE_EVENT_TYPE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">WORKFLOW_FINISHED</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 提取思考内容</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reasoningContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> matches</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> content.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">&lt;thinking&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">[\s\S]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*?</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">&lt;</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">thinking&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (matches?.[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      reasoningContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> matches[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultAnswerMessage,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      content,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      reasoningContent,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FINISHED</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 埋点：任务完成</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    toolLifecycleTracker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">conflateCompleted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      work_number: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserMessageNumber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(messagesRef.current),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      work_id: contentId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 自动保存</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    saveTemplate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      message: messagesRef.current,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      isThink: isThink.current,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p><strong>处理逻辑总结</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>workflow_started → 记录 taskId，触发开始埋点</span></span>
<span class="line"><span>message          → 累加文本，识别思考标签，实时更新 UI</span></span>
<span class="line"><span>answer_error     → 显示错误，标记状态为 error</span></span>
<span class="line"><span>workflow_finished → 提取思考内容，触发完成埋点，自动保存</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><hr><h3 id="_10-3-tool-calling-机制详解" tabindex="-1">10.3 Tool Calling 机制详解 <a class="header-anchor" href="#_10-3-tool-calling-机制详解" aria-label="Permalink to &quot;10.3 Tool Calling 机制详解&quot;">​</a></h3><h4 id="工具定义与注册" tabindex="-1"><strong>工具定义与注册</strong> <a class="header-anchor" href="#工具定义与注册" aria-label="Permalink to &quot;**工具定义与注册**&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// domains/editor/extensions/ai/src/utils/functions.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AIFunctionsManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> functions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ToolFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setFunctions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;draw&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文生图</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;redraw&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 图生图</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;writer&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 文案生成</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;product&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 产品图生成</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;material&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 素材推荐</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;inPaintRemove&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 智能消除</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;inPaintReplace&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 智能替换</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;outPaintExpand&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 图片扩展</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;sceneCopywriter&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 场景文案</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;imageToSvg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 图片转矢量</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;imageToTemplate&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 图片转模板(图文分层)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;cutout&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// AI抠图</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;background&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 背景替换</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 过滤工具（权限控制）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> filterFunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">func</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> toolsName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.functions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">some</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">item</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item.key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> func);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>工具配置（应用层）</strong>：</p><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// domains/editor/apps/design/design-ai-plus/src/main.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> functions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;inPaintRemoveV2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// V2 版本工具（更强大）</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;enhancedImageV2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;outPaintExpandV2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;draw&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;redrawV2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;material&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;writer&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;cutout&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;sceneCopywriter&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;background&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;imageToSvg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;imageToTemplate&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;inPaintReplaceV2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> toolsName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 注册到 AI 扩展插件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">defineExtensionConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;@design/extension-ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  functions, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 启用的工具列表</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... 其他配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="tool-schema-传给大模型的定义" tabindex="-1"><strong>Tool Schema（传给大模型的定义）</strong> <a class="header-anchor" href="#tool-schema-传给大模型的定义" aria-label="Permalink to &quot;**Tool Schema（传给大模型的定义）**&quot;">​</a></h4><p>大模型需要知道每个工具的作用和参数，推测 Dify 会生成类似这样的 Schema：</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;tools&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;function&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;function&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;draw&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;根据文字描述生成图片，支持多种风格和比例&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;parameters&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;object&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;properties&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;prompt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;图片描述，尽量详细，包含主体、风格、场景等&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;ratio&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;enum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1:1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;16:9&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;9:16&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;4:3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;3:4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;图片比例&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;style&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;enum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;realistic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;anime&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;3d&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sketch&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;图片风格&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;num&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;integer&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;生成数量，默认 1，最多 4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;maximum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;required&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;prompt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;function&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;function&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;writer&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;生成营销文案、slogan、产品描述等&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;parameters&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;object&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;properties&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;enum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;slogan&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;product_desc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ad_copy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;文案类型&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;keywords&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;array&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;items&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;关键词列表&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;tone&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;enum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;professional&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;casual&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;humorous&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;文案语气&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;required&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;keywords&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... 其他工具定义</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><hr><h3 id="_10-4-deepseek-模型对比" tabindex="-1">10.4 DeepSeek 模型对比 <a class="header-anchor" href="#_10-4-deepseek-模型对比" aria-label="Permalink to &quot;10.4 DeepSeek 模型对比&quot;">​</a></h3><table tabindex="0"><thead><tr><th>特性</th><th>DeepSeek-V3</th><th>DeepSeek-R1</th></tr></thead><tbody><tr><td><strong>响应速度</strong></td><td>快速（1-2秒首字）</td><td>较慢（2-5秒首字，需思考时间）</td></tr><tr><td><strong>思考过程</strong></td><td>无</td><td>有（<code>&lt;thinking&gt;...&lt;/thinking&gt;</code>）</td></tr><tr><td><strong>输出质量</strong></td><td>标准</td><td>更高（经过推理）</td></tr><tr><td><strong>Token消耗</strong></td><td>较少</td><td>较多（思考过程消耗额外Token）</td></tr><tr><td><strong>适用场景</strong></td><td>快速响应、简单任务</td><td>复杂推理、多步骤任务</td></tr><tr><td><strong>用户选择</strong></td><td>默认模式</td><td>开启&quot;深度思考&quot;开关</td></tr></tbody></table><p><strong>R1 模型的思考示例</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户输入：&quot;帮我设计一张科技公司的海报&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&lt;thinking&gt;</span></span>
<span class="line"><span>分析：</span></span>
<span class="line"><span>1. 用户需求：科技公司海报</span></span>
<span class="line"><span>2. 关键要素：</span></span>
<span class="line"><span>   - 主题：科技感</span></span>
<span class="line"><span>   - 目标：展示公司专业性</span></span>
<span class="line"><span>   - 风格：现代、简约、蓝色调</span></span>
<span class="line"><span>3. 推荐方案：</span></span>
<span class="line"><span>   - 使用16:9比例（适合展示）</span></span>
<span class="line"><span>   - 风格选择&quot;3d&quot;或&quot;realistic&quot;</span></span>
<span class="line"><span>   - 提示词增强：添加&quot;高科技&quot;、&quot;未来感&quot;等关键词</span></span>
<span class="line"><span>4. 需要的工具：draw</span></span>
<span class="line"><span>5. 参数构造：</span></span>
<span class="line"><span>   - prompt: &quot;科技公司海报，蓝色调，高科技，未来感，专业，简约&quot;</span></span>
<span class="line"><span>   - ratio: &quot;16:9&quot;</span></span>
<span class="line"><span>   - style: &quot;3d&quot;</span></span>
<span class="line"><span>&lt;/thinking&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>好的，我来帮您设计一张科技公司海报。我会生成一张16:9比例的海报，风格偏向现代科技感。</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>为什么需要 R1？</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>场景1：复杂需求理解</span></span>
<span class="line"><span>  用户：&quot;我要做个海报，要显得高端&quot;</span></span>
<span class="line"><span>  V3：直接生成 → 可能理解不准确</span></span>
<span class="line"><span>  R1：思考 → &quot;高端&quot;意味着什么？→ 简约、质感、留白 → 生成更精准</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景2：多步骤任务</span></span>
<span class="line"><span>  用户：&quot;生成logo后，再做一张名片&quot;</span></span>
<span class="line"><span>  V3：可能只完成第一步</span></span>
<span class="line"><span>  R1：思考 → 识别两个任务 → 依次完成</span></span>
<span class="line"><span></span></span>
<span class="line"><span>场景3：参数推理</span></span>
<span class="line"><span>  用户：&quot;给我个竖版海报&quot;</span></span>
<span class="line"><span>  V3：可能默认 1:1</span></span>
<span class="line"><span>  R1：思考 → 竖版 = 9:16 → 自动选择正确比例</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><hr><h3 id="_10-5-核心代码方法说明" tabindex="-1">10.5 核心代码方法说明 <a class="header-anchor" href="#_10-5-核心代码方法说明" aria-label="Permalink to &quot;10.5 核心代码方法说明&quot;">​</a></h3><h4 id="_1-usexagent-agent-核心" tabindex="-1"><strong>1. useXAgent（Agent 核心）</strong> <a class="header-anchor" href="#_1-usexagent-agent-核心" aria-label="Permalink to &quot;**1. useXAgent（Agent 核心）**&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// domains/editor/packages/design/agent-x/src/x-sdk/use-x-agent.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useXAgent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 核心：处理请求的函数</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 成功回调</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    onError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 错误回调</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    onUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 实时更新回调</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> config;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isRequesting</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    isRequesting.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(params, {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          isRequesting.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">?.(data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        onUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          onUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">?.(data); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 流式更新</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        onError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          isRequesting.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          onError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">?.(error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      isRequesting.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      onError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">?.(error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      request: run,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      isRequesting</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> isRequesting.value,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p><strong>核心价值</strong>：</p><ul><li>统一的请求管理</li><li>内置loading状态</li><li>统一的错误处理</li><li>支持流式更新</li></ul><h4 id="_2-createsseconnection-sse连接" tabindex="-1"><strong>2. createSSEConnection（SSE连接）</strong> <a class="header-anchor" href="#_2-createsseconnection-sse连接" aria-label="Permalink to &quot;**2. createSSEConnection（SSE连接）**&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 核心方法</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createSSEConnection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">options</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(difyUrl, requestOptions);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response.body.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    listen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 循环读取流</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">done</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(decoder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">decode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 回调处理</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (done) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      reader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 取消流</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>核心价值</strong>：</p><ul><li>封装 ReadableStream 复杂性</li><li>自动处理 JSON 分段</li><li>统一的错误处理</li><li>支持主动关闭</li></ul><h4 id="_3-toollifecycletracker-工具生命周期追踪" tabindex="-1"><strong>3. toolLifecycleTracker（工具生命周期追踪）</strong> <a class="header-anchor" href="#_3-toollifecycletracker-工具生命周期追踪" aria-label="Permalink to &quot;**3. toolLifecycleTracker（工具生命周期追踪）**&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// packages/business-sdks/ai-chat/src/services/tool-lifecycle-tracker.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createToolLifecycleTracker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 任务开始</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    conflateStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      windAPI.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tracker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aigc_tool_init&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">params,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 任务完成</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    conflateCompleted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      windAPI.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tracker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aigc_tool_complete&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">params,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>核心价值</strong>：</p><ul><li>埋点追踪，分析用户行为</li><li>计算任务耗时</li><li>监控成功率</li></ul><h3 id="_10-6-端到端流程总览-数据流转详解" tabindex="-1">10.6 端到端流程总览 - 数据流转详解 <a class="header-anchor" href="#_10-6-端到端流程总览-数据流转详解" aria-label="Permalink to &quot;10.6 端到端流程总览 - 数据流转详解&quot;">​</a></h3><p>让我们用一个完整的例子，展示数据在各个环节的流转：</p><p><strong>用户输入</strong>：<code>&quot;帮我生成一张16:9的春天风景照，要写实风格&quot;</code></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌──────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  阶段0：用户输入（0ms）                                             │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  ChatSender 收集参数：                                              │</span></span>
<span class="line"><span>│  {                                                                │</span></span>
<span class="line"><span>│    content: &quot;帮我生成一张16:9的春天风景照，要写实风格&quot;,            │</span></span>
<span class="line"><span>│    role: &quot;user&quot;,                                                  │</span></span>
<span class="line"><span>│    createdAt: 1736582400000                                       │</span></span>
<span class="line"><span>│  }                                                                │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                            ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  阶段1：前端预处理（50ms）                                          │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  useXAgent.request() 触发：                                       │</span></span>
<span class="line"><span>│    1. 创建 assistant 消息占位                                     │</span></span>
<span class="line"><span>│       {                                                           │</span></span>
<span class="line"><span>│         id: &quot;msg_abc123&quot;,                                         │</span></span>
<span class="line"><span>│         role: &quot;assistant&quot;,                                        │</span></span>
<span class="line"><span>│         content: &quot;&quot;,                                              │</span></span>
<span class="line"><span>│         status: &quot;loading&quot;,                                        │</span></span>
<span class="line"><span>│         model: &quot;deepseek-v3&quot;,                                     │</span></span>
<span class="line"><span>│       }                                                           │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│    2. 立即调用 onUpdate() → UI 显示&quot;AI思考中&quot;                     │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│    3. 准备历史消息（最近30组）                                     │</span></span>
<span class="line"><span>│       history_text = JSON.stringify([                             │</span></span>
<span class="line"><span>│         { role: &quot;user&quot;, content: &quot;上次对话...&quot; },                │</span></span>
<span class="line"><span>│         { role: &quot;assistant&quot;, content: &quot;...&quot; },                    │</span></span>
<span class="line"><span>│         // ... 最多60条                                           │</span></span>
<span class="line"><span>│       ])                                                          │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                            ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  阶段2：建立SSE连接（200ms）                                        │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  createSSEConnection() 发送 POST 请求：                           │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  POST /api/gdesign/tool/v1/dify/chat                             │</span></span>
<span class="line"><span>│  Headers:                                                         │</span></span>
<span class="line"><span>│    Authorization: Bearer eyJhbGc...                               │</span></span>
<span class="line"><span>│    Content-Type: application/json                                │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  Body:                                                            │</span></span>
<span class="line"><span>│  {                                                                │</span></span>
<span class="line"><span>│    &quot;scene_code&quot;: &quot;ai-chat&quot;,                                       │</span></span>
<span class="line"><span>│    &quot;aigc_type&quot;: &quot;aigc&quot;,                                           │</span></span>
<span class="line"><span>│    &quot;query&quot;: &quot;帮我生成一张16:9的春天风景照，要写实风格&quot;,            │</span></span>
<span class="line"><span>│    &quot;arguments&quot;: {                                                 │</span></span>
<span class="line"><span>│      &quot;think&quot;: 0,                      ← 未开启深度思考            │</span></span>
<span class="line"><span>│      &quot;history_text&quot;: &quot;[{\&quot;role\&quot;:\&quot;user\&quot;...}]&quot;                  │</span></span>
<span class="line"><span>│    },                                                             │</span></span>
<span class="line"><span>│    &quot;conversation_id&quot;: &quot;&quot;                                          │</span></span>
<span class="line"><span>│  }                                                                │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  → 返回 ReadableStream                                            │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                            ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  阶段3：Dify Workflow 处理（后端，500ms-2s）                        │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  3.1 接收请求（50ms）                                              │</span></span>
<span class="line"><span>│      → 生成 task_id: &quot;task_xyz789&quot;                                │</span></span>
<span class="line"><span>│      → 推送事件：                                                 │</span></span>
<span class="line"><span>│        {                                                          │</span></span>
<span class="line"><span>│          &quot;event&quot;: &quot;workflow_started&quot;,                             │</span></span>
<span class="line"><span>│          &quot;task_id&quot;: &quot;task_xyz789&quot;,                                │</span></span>
<span class="line"><span>│          &quot;conversation_id&quot;: &quot;conv_abc&quot;                            │</span></span>
<span class="line"><span>│        }                                                          │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  3.2 Prompt Engineering（100ms）                                  │</span></span>
<span class="line"><span>│      → 注入系统提示词：                                            │</span></span>
<span class="line"><span>│        &quot;你是稿定AI的智能设计助手...&quot;                               │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│      → 格式化历史对话：                                            │</span></span>
<span class="line"><span>│        [                                                          │</span></span>
<span class="line"><span>│          { role: &quot;system&quot;, content: &quot;...&quot; },                     │</span></span>
<span class="line"><span>│          { role: &quot;user&quot;, content: &quot;上次对话...&quot; },               │</span></span>
<span class="line"><span>│          { role: &quot;assistant&quot;, content: &quot;...&quot; },                   │</span></span>
<span class="line"><span>│          { role: &quot;user&quot;, content: &quot;帮我生成...&quot; }                │</span></span>
<span class="line"><span>│        ]                                                          │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│      → 注入工具定义（Tool Schema）：                              │</span></span>
<span class="line"><span>│        tools: [                                                   │</span></span>
<span class="line"><span>│          {                                                        │</span></span>
<span class="line"><span>│            type: &quot;function&quot;,                                      │</span></span>
<span class="line"><span>│            function: {                                            │</span></span>
<span class="line"><span>│              name: &quot;draw&quot;,                                        │</span></span>
<span class="line"><span>│              description: &quot;根据文字描述生成图片...&quot;,              │</span></span>
<span class="line"><span>│              parameters: {                                        │</span></span>
<span class="line"><span>│                type: &quot;object&quot;,                                    │</span></span>
<span class="line"><span>│                properties: {                                      │</span></span>
<span class="line"><span>│                  prompt: { type: &quot;string&quot;, ... },                │</span></span>
<span class="line"><span>│                  ratio: { enum: [&quot;1:1&quot;, &quot;16:9&quot;, ...] },          │</span></span>
<span class="line"><span>│                  style: { enum: [&quot;realistic&quot;, ...] }             │</span></span>
<span class="line"><span>│                },                                                 │</span></span>
<span class="line"><span>│                required: [&quot;prompt&quot;]                               │</span></span>
<span class="line"><span>│              }                                                    │</span></span>
<span class="line"><span>│            }                                                      │</span></span>
<span class="line"><span>│          },                                                       │</span></span>
<span class="line"><span>│          { function: { name: &quot;writer&quot;, ... } },                  │</span></span>
<span class="line"><span>│          // ... 其他工具                                          │</span></span>
<span class="line"><span>│        ]                                                          │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  3.3 调用大模型（DeepSeek API，1-2s）                             │</span></span>
<span class="line"><span>│      POST https://api.deepseek.com/v1/chat/completions           │</span></span>
<span class="line"><span>│      {                                                            │</span></span>
<span class="line"><span>│        &quot;model&quot;: &quot;deepseek-chat&quot;,                                  │</span></span>
<span class="line"><span>│        &quot;messages&quot;: [...],                                         │</span></span>
<span class="line"><span>│        &quot;tools&quot;: [...],                                            │</span></span>
<span class="line"><span>│        &quot;temperature&quot;: 0.7,                                        │</span></span>
<span class="line"><span>│        &quot;stream&quot;: true          ← 流式返回                         │</span></span>
<span class="line"><span>│      }                                                            │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  3.4 大模型推理（1s）                                              │</span></span>
<span class="line"><span>│      → 理解意图：&quot;用户要生成图片&quot;                                  │</span></span>
<span class="line"><span>│      → 识别参数：                                                 │</span></span>
<span class="line"><span>│        - 描述：&quot;春天风景照&quot;                                        │</span></span>
<span class="line"><span>│        - 比例：&quot;16:9&quot;                                             │</span></span>
<span class="line"><span>│        - 风格：&quot;写实&quot;(realistic)                                   │</span></span>
<span class="line"><span>│      → 决策：调用 draw 工具                                       │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  3.5 模型返回（流式，200ms）                                       │</span></span>
<span class="line"><span>│      Chunk 1:                                                     │</span></span>
<span class="line"><span>│      {                                                            │</span></span>
<span class="line"><span>│        &quot;choices&quot;: [{                                              │</span></span>
<span class="line"><span>│          &quot;delta&quot;: {                                               │</span></span>
<span class="line"><span>│            &quot;role&quot;: &quot;assistant&quot;,                                   │</span></span>
<span class="line"><span>│            &quot;content&quot;: &quot;好的&quot;                                      │</span></span>
<span class="line"><span>│          }                                                        │</span></span>
<span class="line"><span>│        }]                                                         │</span></span>
<span class="line"><span>│      }                                                            │</span></span>
<span class="line"><span>│      → Dify 转发给前端：                                          │</span></span>
<span class="line"><span>│        { &quot;event&quot;: &quot;message&quot;, &quot;answer&quot;: &quot;好的&quot; }                   │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│      Chunk 2:                                                     │</span></span>
<span class="line"><span>│      {                                                            │</span></span>
<span class="line"><span>│        &quot;choices&quot;: [{                                              │</span></span>
<span class="line"><span>│          &quot;delta&quot;: {                                               │</span></span>
<span class="line"><span>│            &quot;content&quot;: &quot;，我来帮您生成&quot;                            │</span></span>
<span class="line"><span>│          }                                                        │</span></span>
<span class="line"><span>│        }]                                                         │</span></span>
<span class="line"><span>│      }                                                            │</span></span>
<span class="line"><span>│      → Dify 转发：                                                │</span></span>
<span class="line"><span>│        { &quot;event&quot;: &quot;message&quot;, &quot;answer&quot;: &quot;，我来帮您生成&quot; }         │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│      Chunk 3（工具调用）:                                          │</span></span>
<span class="line"><span>│      {                                                            │</span></span>
<span class="line"><span>│        &quot;choices&quot;: [{                                              │</span></span>
<span class="line"><span>│          &quot;delta&quot;: {                                               │</span></span>
<span class="line"><span>│            &quot;tool_calls&quot;: [{                                       │</span></span>
<span class="line"><span>│              &quot;id&quot;: &quot;call_draw_001&quot;,                               │</span></span>
<span class="line"><span>│              &quot;type&quot;: &quot;function&quot;,                                  │</span></span>
<span class="line"><span>│              &quot;function&quot;: {                                        │</span></span>
<span class="line"><span>│                &quot;name&quot;: &quot;draw&quot;,                                    │</span></span>
<span class="line"><span>│                &quot;arguments&quot;: &quot;{\&quot;prompt\&quot;:\&quot;春天的...&quot;            │</span></span>
<span class="line"><span>│              }                                                    │</span></span>
<span class="line"><span>│            }]                                                     │</span></span>
<span class="line"><span>│          },                                                       │</span></span>
<span class="line"><span>│          &quot;finish_reason&quot;: &quot;tool_calls&quot;                            │</span></span>
<span class="line"><span>│        }]                                                         │</span></span>
<span class="line"><span>│      }                                                            │</span></span>
<span class="line"><span>│      → Dify 解析工具调用 → 路由到图片生成服务                     │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  3.6 工具执行（图片生成服务，10-30s）                              │</span></span>
<span class="line"><span>│      draw({                                                       │</span></span>
<span class="line"><span>│        prompt: &quot;春天的风景照，写实风格，16:9&quot;,                    │</span></span>
<span class="line"><span>│        ratio: &quot;16:9&quot;,                                             │</span></span>
<span class="line"><span>│        style: &quot;realistic&quot;,                                        │</span></span>
<span class="line"><span>│        num: 1                                                     │</span></span>
<span class="line"><span>│      })                                                           │</span></span>
<span class="line"><span>│      → 调用 Stable Diffusion / Flux 模型                          │</span></span>
<span class="line"><span>│      → 生成图片：https://cdn.com/spring-landscape.jpg            │</span></span>
<span class="line"><span>│      → 返回结果给 Dify                                            │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  3.7 Dify 推送工具结果（100ms）                                   │</span></span>
<span class="line"><span>│      推送事件：                                                   │</span></span>
<span class="line"><span>│      {                                                            │</span></span>
<span class="line"><span>│        &quot;event&quot;: &quot;tool_result&quot;,        ← 假设的事件类型           │</span></span>
<span class="line"><span>│        &quot;tool_name&quot;: &quot;draw&quot;,                                       │</span></span>
<span class="line"><span>│        &quot;result&quot;: {                                                │</span></span>
<span class="line"><span>│          &quot;image_url&quot;: &quot;https://cdn.com/spring-landscape.jpg&quot;,    │</span></span>
<span class="line"><span>│          &quot;width&quot;: 1920,                                           │</span></span>
<span class="line"><span>│          &quot;height&quot;: 1080                                           │</span></span>
<span class="line"><span>│        }                                                          │</span></span>
<span class="line"><span>│      }                                                            │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  3.8 完成响应（50ms）                                              │</span></span>
<span class="line"><span>│      推送最终事件：                                                │</span></span>
<span class="line"><span>│      {                                                            │</span></span>
<span class="line"><span>│        &quot;event&quot;: &quot;workflow_finished&quot;,                              │</span></span>
<span class="line"><span>│        &quot;task_id&quot;: &quot;task_xyz789&quot;                                   │</span></span>
<span class="line"><span>│      }                                                            │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                            ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  阶段4：前端SSE流处理（实时，总计10-30s）                           │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  onListen() 回调依次接收事件：                                     │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  事件1：workflow_started                                          │</span></span>
<span class="line"><span>│    currentTaskId.current = &quot;task_xyz789&quot;                          │</span></span>
<span class="line"><span>│    toolLifecycleTracker.conflateStart()  ← 埋点                  │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  事件2：message (content: &quot;好的&quot;)                                 │</span></span>
<span class="line"><span>│    content += &quot;好的&quot;                                              │</span></span>
<span class="line"><span>│    onUpdate({ content: &quot;好的&quot;, status: &quot;loading&quot; })              │</span></span>
<span class="line"><span>│    → UI 显示：&quot;好的&quot;                                              │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  事件3：message (content: &quot;，我来帮您生成&quot;)                       │</span></span>
<span class="line"><span>│    content += &quot;，我来帮您生成&quot;                                    │</span></span>
<span class="line"><span>│    onUpdate({ content: &quot;好的，我来帮您生成&quot;, ... })              │</span></span>
<span class="line"><span>│    → UI 显示：&quot;好的，我来帮您生成&quot;                                │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  事件4：tool_result                                               │</span></span>
<span class="line"><span>│    → 触发 MessageHandler 处理工具结果                             │</span></span>
<span class="line"><span>│    → PlaceholderManager.create(&#39;image&#39;)                          │</span></span>
<span class="line"><span>│       创建占位元素（灰色矩形+加载动画）                            │</span></span>
<span class="line"><span>│    → 显示在画布上                                                 │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  事件5：workflow_finished                                         │</span></span>
<span class="line"><span>│    reasoningContent = &#39;&#39;  (V3模型无思考内容)                      │</span></span>
<span class="line"><span>│    onSuccess({                                                    │</span></span>
<span class="line"><span>│      content: &quot;好的，我来帮您生成&quot;,                               │</span></span>
<span class="line"><span>│      status: &quot;finished&quot;,                                          │</span></span>
<span class="line"><span>│      taskId: &quot;task_xyz789&quot;                                        │</span></span>
<span class="line"><span>│    })                                                             │</span></span>
<span class="line"><span>│    toolLifecycleTracker.conflateCompleted()  ← 埋点              │</span></span>
<span class="line"><span>│    saveTemplate()  ← 自动保存对话                                │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                            ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  阶段5：工具结果处理（500ms-1s）                                   │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  ToolProcessor.processAiTool():                                   │</span></span>
<span class="line"><span>│    input: {                                                       │</span></span>
<span class="line"><span>│      toolType: &quot;draw&quot;,                                            │</span></span>
<span class="line"><span>│      result: {                                                    │</span></span>
<span class="line"><span>│        uri: &quot;https://cdn.com/spring-landscape.jpg&quot;,              │</span></span>
<span class="line"><span>│      },                                                           │</span></span>
<span class="line"><span>│      metadata: {                                                  │</span></span>
<span class="line"><span>│        taskId: &quot;task_xyz789&quot;,                                     │</span></span>
<span class="line"><span>│        query: &quot;春天的风景照&quot;,                                     │</span></span>
<span class="line"><span>│        width: 1920,                                               │</span></span>
<span class="line"><span>│        height: 1080                                               │</span></span>
<span class="line"><span>│      }                                                            │</span></span>
<span class="line"><span>│    }                                                              │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  步骤：                                                            │</span></span>
<span class="line"><span>│    1. getRecordId(taskId) → 查询历史记录                          │</span></span>
<span class="line"><span>│       → 无历史记录（新生成）                                       │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│    2. postRecord() → 保存生成记录到数据库                         │</span></span>
<span class="line"><span>│       POST /api/aigc/generation-record                            │</span></span>
<span class="line"><span>│       {                                                           │</span></span>
<span class="line"><span>│         task_id: &quot;task_xyz789&quot;,                                   │</span></span>
<span class="line"><span>│         work_id: &quot;work_123&quot;,                                      │</span></span>
<span class="line"><span>│         generation_result: &quot;https://cdn.com/spring...&quot;,           │</span></span>
<span class="line"><span>│         prompt: &quot;春天的风景照&quot;,                                   │</span></span>
<span class="line"><span>│         element_id: null  (尚未添加到画布)                        │</span></span>
<span class="line"><span>│       }                                                           │</span></span>
<span class="line"><span>│       → 返回 recordId: &quot;record_456&quot;                               │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│    3. 返回处理后的工具对象                                         │</span></span>
<span class="line"><span>│       output: {                                                   │</span></span>
<span class="line"><span>│         ...input,                                                 │</span></span>
<span class="line"><span>│         metadata: {                                               │</span></span>
<span class="line"><span>│           ...input.metadata,                                      │</span></span>
<span class="line"><span>│           recordId: &quot;record_456&quot;                                  │</span></span>
<span class="line"><span>│         }                                                         │</span></span>
<span class="line"><span>│       }                                                           │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                            ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  阶段6：添加到画布（200-500ms）                                    │</span></span>
<span class="line"><span>│  ────────────────────────────────────────────────────────────   │</span></span>
<span class="line"><span>│  ElementAddService.addImageElement():                             │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  1. 加载图片资源（200ms）                                          │</span></span>
<span class="line"><span>│     loadImage(&quot;https://cdn.com/spring-landscape.jpg&quot;)            │</span></span>
<span class="line"><span>│     → 下载图片                                                    │</span></span>
<span class="line"><span>│     → 解码为纹理                                                  │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  2. 创建图片元素（50ms）                                           │</span></span>
<span class="line"><span>│     imageElement = editor.createElement({                         │</span></span>
<span class="line"><span>│       type: &#39;image&#39;,                                              │</span></span>
<span class="line"><span>│       imageUrl: &quot;https://cdn.com/spring-landscape.jpg&quot;,          │</span></span>
<span class="line"><span>│       width: 1920,                                                │</span></span>
<span class="line"><span>│       height: 1080,                                               │</span></span>
<span class="line"><span>│       transform: {                                                │</span></span>
<span class="line"><span>│         x: placeholderPosition.x,  ← 继承占位元素位置            │</span></span>
<span class="line"><span>│         y: placeholderPosition.y,                                 │</span></span>
<span class="line"><span>│         rotation: 0,                                              │</span></span>
<span class="line"><span>│         scaleX: 1,                                                │</span></span>
<span class="line"><span>│         scaleY: 1                                                 │</span></span>
<span class="line"><span>│       }                                                           │</span></span>
<span class="line"><span>│     })                                                            │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  3. 移除占位元素（10ms）                                           │</span></span>
<span class="line"><span>│     placeholderManager.remove(placeholderId)                      │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  4. 添加真实元素（50ms）                                           │</span></span>
<span class="line"><span>│     editor.addElement(imageElement)                               │</span></span>
<span class="line"><span>│     → 触发渲染引擎更新                                            │</span></span>
<span class="line"><span>│     → 淡入动画（300ms）                                           │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  5. 聚焦元素（50ms）                                               │</span></span>
<span class="line"><span>│     editor.focusElement(imageElement)                             │</span></span>
<span class="line"><span>│     → 选中新元素                                                  │</span></span>
<span class="line"><span>│     → 显示控制点                                                  │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  6. 调整视口（100ms）                                              │</span></span>
<span class="line"><span>│     adjustViewport()                                              │</span></span>
<span class="line"><span>│     → 自动滚动到新元素位置                                        │</span></span>
<span class="line"><span>│     → 确保元素在可视区域                                          │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                            ↓</span></span>
<span class="line"><span>┌──────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  完成！用户看到生成的图片 ✨                                        │</span></span>
<span class="line"><span>│  总耗时：约 10-30 秒                                               │</span></span>
<span class="line"><span>│  用户感知：约 1 秒（因为有占位元素）                               │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br></div></div><p><strong>时间分布统计</strong>（参考值）：</p><table tabindex="0"><thead><tr><th>阶段</th><th>耗时</th><th>占比</th><th>用户感知</th></tr></thead><tbody><tr><td>前端预处理</td><td>50ms</td><td>&lt;1%</td><td>无感知（异步）</td></tr><tr><td>SSE连接建立</td><td>200ms</td><td>1%</td><td>立即看到loading</td></tr><tr><td>Dify PE增强</td><td>100ms</td><td>&lt;1%</td><td>无感知（后端）</td></tr><tr><td>大模型推理</td><td>1-2s</td><td>5-10%</td><td>流式显示文字</td></tr><tr><td>工具执行（图片生成）</td><td>10-30s</td><td>80-90%</td><td>有占位元素，可操作</td></tr><tr><td>工具结果处理</td><td>500ms-1s</td><td>3-5%</td><td>无感知（后台）</td></tr><tr><td>添加到画布</td><td>500ms</td><td>2-3%</td><td>看到淡入动画</td></tr></tbody></table><p><strong>核心优化点</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>✅ 立即反馈：onUpdate() 0ms 延迟显示 loading</span></span>
<span class="line"><span>✅ 占位元素：工具执行时创建，用户不用傻等 10-30s</span></span>
<span class="line"><span>✅ 流式输出：大模型推理时逐字显示，体验流畅</span></span>
<span class="line"><span>✅ 异步处理：ToolProcessor 在后台处理，不阻塞 UI</span></span>
<span class="line"><span>✅ 渐进加载：图片资源分步加载（下载→解码→渲染）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><hr><h3 id="_10-7-错误处理与容错机制" tabindex="-1">10.7 错误处理与容错机制 <a class="header-anchor" href="#_10-7-错误处理与容错机制" aria-label="Permalink to &quot;10.7 错误处理与容错机制&quot;">​</a></h3><h4 id="各阶段错误处理" tabindex="-1"><strong>各阶段错误处理</strong> <a class="header-anchor" href="#各阶段错误处理" aria-label="Permalink to &quot;**各阶段错误处理**&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  错误类型1：网络错误                                              │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  触发场景：SSE 连接失败、网络中断                                 │</span></span>
<span class="line"><span>│  处理逻辑：                                                        │</span></span>
<span class="line"><span>│    1. createSSEConnection() 捕获异常                             │</span></span>
<span class="line"><span>│    2. 调用 onError({ event: &#39;network_error&#39; })                   │</span></span>
<span class="line"><span>│    3. 显示错误提示：&quot;网络似乎出现了点问题...&quot;                     │</span></span>
<span class="line"><span>│    4. 提供&quot;重试&quot;按钮                                              │</span></span>
<span class="line"><span>│    5. 移除占位元素（如果有）                                       │</span></span>
<span class="line"><span>│                                                                   │</span></span>
<span class="line"><span>│  用户操作：点击重试 → 重新走完整流程                              │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  错误类型2：认证错误（401）                                        │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  触发场景：Token过期、未登录                                       │</span></span>
<span class="line"><span>│  处理逻辑：                                                        │</span></span>
<span class="line"><span>│    1. SSE 返回 401 状态码                                         │</span></span>
<span class="line"><span>│    2. 调用 login() 方法 → 弹出登录框                             │</span></span>
<span class="line"><span>│    3. 用户登录成功 → 自动重试                                     │</span></span>
<span class="line"><span>│    4. 用户取消登录 → 中止任务                                     │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  错误类型3：内容违规（12020758）                                   │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  触发场景：用户输入敏感内容                                        │</span></span>
<span class="line"><span>│  处理逻辑：                                                        │</span></span>
<span class="line"><span>│    1. Dify 返回 { event: &#39;answer_error&#39;, code: &#39;12020758&#39; }     │</span></span>
<span class="line"><span>│    2. 识别违规代码                                                │</span></span>
<span class="line"><span>│    3. 显示友好提示：&quot;这个话题不适合讨论...&quot;                       │</span></span>
<span class="line"><span>│    4. 不提供重试（因为再试也会失败）                              │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  错误类型4：系统错误（500）                                        │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  触发场景：后端服务异常、Dify Workflow 失败                        │</span></span>
<span class="line"><span>│  处理逻辑：                                                        │</span></span>
<span class="line"><span>│    1. SSE 返回 500 / workflow_error                              │</span></span>
<span class="line"><span>│    2. 显示通用错误：&quot;系统有点繁忙～请稍后重试&quot;                    │</span></span>
<span class="line"><span>│    3. 提供&quot;重试&quot;按钮                                              │</span></span>
<span class="line"><span>│    4. 记录错误日志到 SLS                                          │</span></span>
<span class="line"><span>│    5. 触发告警（如果错误率过高）                                   │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  错误类型5：工具执行失败                                           │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  触发场景：图片生成超时、模型服务不可用                            │</span></span>
<span class="line"><span>│  处理逻辑：                                                        │</span></span>
<span class="line"><span>│    1. 工具返回失败结果                                            │</span></span>
<span class="line"><span>│    2. Dify 推送错误事件                                           │</span></span>
<span class="line"><span>│    3. 占位元素变为错误状态（红色边框 + 错误图标）                  │</span></span>
<span class="line"><span>│    4. 显示具体错误原因                                            │</span></span>
<span class="line"><span>│    5. 支持单独重试该工具                                          │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  错误类型6：用户主动取消                                           │</span></span>
<span class="line"><span>│  ─────────────────────────────────────────────────────────────  │</span></span>
<span class="line"><span>│  触发场景：用户点击&quot;取消&quot;按钮                                      │</span></span>
<span class="line"><span>│  处理逻辑：                                                        │</span></span>
<span class="line"><span>│    1. 调用 sseConnection.close()                                 │</span></span>
<span class="line"><span>│    2. 调用后端取消接口                                            │</span></span>
<span class="line"><span>│       POST /api/aigc/stop-generate                               │</span></span>
<span class="line"><span>│       { task_id, scene_code, aigc_type }                         │</span></span>
<span class="line"><span>│    3. 消息状态标记为 &quot;stop&quot;                                       │</span></span>
<span class="line"><span>│    4. 移除占位元素                                                │</span></span>
<span class="line"><span>│    5. 显示：&quot;已取消生成&quot;                                          │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><h4 id="核心容错代码" tabindex="-1"><strong>核心容错代码</strong> <a class="header-anchor" href="#核心容错代码" aria-label="Permalink to &quot;**核心容错代码**&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// packages/business-sdks/ai-chat/src/hook/use-message.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 错误处理中心</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. 网络错误</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.event </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;network_error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultAnswerMessage,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      content: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NETWORK_ERROR_TIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FINISHED</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      error: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. 认证错误</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 401</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    login</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">?.().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">success</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">success) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 用户取消登录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        onCancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultAnswerMessage,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          content: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">STOP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          error: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 登录成功，自动重试（由外层控制）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3. 内容违规</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.code </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PROHIBITION_CODE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultAnswerMessage,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      content: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PROHIBITION_TIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FINISHED</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      error: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 4. 系统错误</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.event </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;system_error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultAnswerMessage,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      content: data.answer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SYSTEM_ERROR_TIP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FINISHED</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      error: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 5. 流结束</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (data.event </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;message_end&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultAnswerMessage,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      content: content </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39; ...&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 显示不完整标记</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MESSAGE_STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">STOP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 主动取消</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onCancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sseConnection?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 关闭流</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (currentTaskId.current) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 调用后端取消接口</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      aiChatApi.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stopGenerate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        id: currentTaskId.current,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        scene_code: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ai-chat&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        aigc_type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aigc&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(error);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 即使取消失败也不影响用户体验</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><hr><h3 id="_10-8-关键技术亮点总结" tabindex="-1">10.8 关键技术亮点总结 <a class="header-anchor" href="#_10-8-关键技术亮点总结" aria-label="Permalink to &quot;10.8 关键技术亮点总结&quot;">​</a></h3><table tabindex="0"><thead><tr><th>亮点</th><th>技术方案</th><th>业界对比</th></tr></thead><tbody><tr><td><strong>流式 AI 响应</strong></td><td>SSE + 逐字显示</td><td>多数产品：等待完成后显示</td></tr><tr><td><strong>立即反馈</strong></td><td>onUpdate 0ms 延迟 + 占位元素</td><td>多数产品：傻等 10-30s</td></tr><tr><td><strong>深度思考可视化</strong></td><td>R1 thinking 标签解析 + UI 展示</td><td>业界首创（DeepSeek R1独有）</td></tr><tr><td><strong>历史消息智能裁剪</strong></td><td>最近 30 组 + thinking 标签去除</td><td>多数产品：简单截断或全部发送</td></tr><tr><td><strong>JSON 分段处理</strong></td><td>buffer 缓存 + 序列解析</td><td>容易出现解析错误</td></tr><tr><td><strong>工具生命周期追踪</strong></td><td>toolLifecycleTracker + 埋点</td><td>多数产品：缺乏完整追踪</td></tr><tr><td><strong>优雅错误处理</strong></td><td>分类处理 + 友好提示 + 支持重试</td><td>多数产品：通用错误提示</td></tr><tr><td><strong>主动取消支持</strong></td><td>SSE close + 后端取消接口</td><td>多数产品：不支持取消</td></tr></tbody></table><hr><p><strong>文档版本</strong>：v1.1 <strong>最后更新</strong>：2026-01-11 <strong>维护者</strong>：AI+ 编辑器团队</p></div></div></main><footer class="VPDocFooter" data-v-19e5f4bd data-v-60c89bea><!--[--><!--[--><!--[--><!--[--><div class="doc-comments"><!----></div><!--]--><!--]--><!--]--><!--]--><div class="edit-info" data-v-60c89bea><!----><div class="last-updated" data-v-60c89bea><p class="VPLastUpdated" data-v-60c89bea data-v-dd735ae2>上次更新: <time datetime="2026-01-14T15:02:36.000Z" data-v-dd735ae2></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-60c89bea><span class="visually-hidden" id="doc-footer-aria-label" data-v-60c89bea>Pager</span><div class="pager" data-v-60c89bea><!----></div><div class="pager" data-v-60c89bea><a class="VPLink link pager-link next" href="/Lyc-notes/project/index" data-v-60c89bea><!--[--><span class="desc" data-v-60c89bea>下一篇</span><span class="title" data-v-60c89bea>项目总结</span><!--]--></a></div></nav></footer><!--[--><!--[--><!--[--><div style="" class="m-doc-footer" data-v-3bfcfc2f><div class="m-doc-footer-message" data-v-3bfcfc2f><img class="visitor" src="https://visitor-badge.laobi.icu/badge?page_id=LynnCen.Lyc-notes./project/gaoding/AI+%E6%99%BA%E8%83%BD%E8%AE%BE%E8%AE%A1%E7%BC%96%E8%BE%91%E5%99%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3/AI+%E6%99%BA%E8%83%BD%E8%AE%BE%E8%AE%A1%E7%BC%96%E8%BE%91%E5%99%A8%E6%9E%B6%E6%9E%84%E6%96%87%E6%A1%A3-%E5%AE%8C%E6%95%B4%E7%89%88-%E5%A4%87%E4%BB%BD" title="当前页面累计访问数" onerror="this.style.display=&#39;none&#39;" data-v-3bfcfc2f><p data-v-3bfcfc2f>如有转载或 CV 的请标注本站原文地址</p></div><p class="m-doc-footer-copyright" data-v-3bfcfc2f>Copyright © 2024-present LynnCen</p></div><!--]--><!--]--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-31cf94a2 data-v-276efff3><div class="container" data-v-276efff3><p class="message" data-v-276efff3>如有转载或 CV 的请标注本站原文地址</p><p class="copyright" data-v-276efff3>Copyright © 2024-present LynnCen</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"408_2009.md\":\"Do1tUZk0\",\"408_2010.md\":\"nB9bWAen\",\"408_2011.md\":\"BRm-XD6Y\",\"408_2012.md\":\"4DIycrxC\",\"408_2013.md\":\"DTeARRxQ\",\"408_2014.md\":\"CG7QhfiS\",\"408_2015.md\":\"D7KKoTUL\",\"408_2016.md\":\"DLrIuVQh\",\"408_2017.md\":\"BE-NKHcS\",\"408_2018.md\":\"BUVvo3sV\",\"408_2019.md\":\"CoR2m91g\",\"ai_dify_index.md\":\"Ey6VvJgZ\",\"ai_index.md\":\"BVNQdFkz\",\"ai_mcp_browsertools.md\":\"Bu6HlvzW\",\"ai_mcp_cursor-mcp.md\":\"BGureO0L\",\"ai_mcp_figma.md\":\"BOJuXXyJ\",\"ai_posts_ai.md\":\"BEqyjz6u\",\"ai_posts_llm.md\":\"SKhN-fRZ\",\"ai_机器学习_01.md\":\"DMD1Ez4y\",\"ai_机器学习_920.md\":\"Dr-_hNiV\",\"ai_机器学习_其他机器学习方法.md\":\"BAnMvuSU\",\"ai_机器学习_机器学习的分类.md\":\"CkX1i6JO\",\"ai_机器学习_机器学习的整体流程.md\":\"BvLKeh1P\",\"ai_机器学习_机器学习算法.md\":\"EUrsW-w5\",\"ai_机器学习_逻辑回归.md\":\"BpZ5GJYu\",\"ai_深度学习_卷积神经网络基础.md\":\"BOBNfF0F\",\"algorithm_dp.md\":\"CgbkvXbS\",\"algorithm_index.md\":\"DDhVAYHS\",\"algorithm_leetcode.md\":\"K8B8dAJo\",\"algorithm_lru.md\":\"cDBGynGZ\",\"algorithm_退避算法.md\":\"Dpg33FvE\",\"architecture_base.md\":\"C9Kv6efU\",\"architecture_iconfont.md\":\"DJk2tqBT\",\"architecture_jp架构.md\":\"VAmQ_xvz\",\"architecture_modern-frontend-architecture.md\":\"DTvTU79m\",\"browser_ introduce.md\":\"BJIFKLcj\",\"browser_async_await.md\":\"D9nic-vu\",\"browser_chrome开发者工具.md\":\"D9uIW-Rj\",\"browser_chrome架构.md\":\"Ci__jtZ7\",\"browser_csrf攻击.md\":\"DjKlPeOs\",\"browser_dom树.md\":\"PIUb7wvj\",\"browser_http.md\":\"DjbWSIP-\",\"browser_http1.md\":\"CMAPpvov\",\"browser_http2.md\":\"D1hyXK6A\",\"browser_http3.md\":\"BupkPkee\",\"browser_https.md\":\"D1n-SHI8\",\"browser_performance.md\":\"vn9zDjKJ\",\"browser_performance中的main指标.md\":\"C_Gs0kyj\",\"browser_promise.md\":\"DFYjNJT4\",\"browser_renderfirst.md\":\"D2trTdvH\",\"browser_rendersec.md\":\"3ZxMMbNG\",\"browser_settimeout如何实现.md\":\"lVRo50lu\",\"browser_tcp协议.md\":\"DGfWVycy\",\"browser_this.md\":\"l4rOp-Fx\",\"browser_xmlhttprequest.md\":\"DYi_fBKS\",\"browser_任务调度.md\":\"9qWkH9dv\",\"browser_作用域链和闭包.md\":\"B4-3Hzez\",\"browser_分层和合成.md\":\"BhY_c0e5\",\"browser_加载阶段性能.md\":\"D9ZBrCrs\",\"browser_变量提升.md\":\"BZA-p9rt\",\"browser_同源策略.md\":\"Dcgo0v_z\",\"browser_块级作用域.md\":\"4kApESyY\",\"browser_垃圾回收.md\":\"erVwHNKV\",\"browser_安全沙箱.md\":\"BStrXmdI\",\"browser_宏任务和微任务.md\":\"BKBfdBdr\",\"browser_导航流程.md\":\"DZd0m-Dp\",\"browser_栈和堆.md\":\"3TS9SKFp\",\"browser_浏览上下文组.md\":\"_sMyV974\",\"browser_消息队列和事件循环.md\":\"D08SITy5\",\"browser_渐进式网页应用pwa.md\":\"CR-wkmVm\",\"browser_渲染流水线.md\":\"CBjYEgKf\",\"browser_编译器和解释器.md\":\"Bn3oYj9H\",\"browser_虚拟dom.md\":\"BfUEgvA2\",\"browser_调用栈.md\":\"B5ytWHRO\",\"browser_跨站脚本攻击xss.md\":\"DDuWMz3n\",\"browser_页面性能.md\":\"CnSsL4yL\",\"computerbasics_index.md\":\"iY_HDwYR\",\"datastructure_chapter1.md\":\"UensgjAm\",\"datastructure_chapter1_ex.md\":\"MJJw230T\",\"datastructure_chapter2.md\":\"DGm68WWT\",\"datastructure_chapter2_ex.md\":\"BPeJ-RmL\",\"datastructure_chapter3.md\":\"7ZacNeHj\",\"datastructure_chapter4.md\":\"lEtqOvr8\",\"datastructure_chapter5.md\":\"BjypEzeI\",\"datastructure_chapter6.md\":\"C7uFguAJ\",\"datastructure_chapter7.md\":\"BPBu8VIz\",\"datastructure_chapter8.md\":\"C1oBaQBD\",\"datastructure_强化.md\":\"BVVDYdgY\",\"designpatterns_behavioral_chain-of-responsibility.md\":\"DerjjYug\",\"designpatterns_behavioral_command.md\":\"B73Fs_hs\",\"designpatterns_behavioral_interpreter.md\":\"-oaoXJJi\",\"designpatterns_behavioral_iterator.md\":\"De474aRf\",\"designpatterns_behavioral_mediator.md\":\"DGjLy3JH\",\"designpatterns_behavioral_memento.md\":\"CeLCB67e\",\"designpatterns_behavioral_observer.md\":\"CuU69ZV6\",\"designpatterns_behavioral_state.md\":\"CyQQTT8_\",\"designpatterns_behavioral_strategy.md\":\"DtDJprU0\",\"designpatterns_behavioral_template-method.md\":\"Cy8K-SDw\",\"designpatterns_behavioral_visitor.md\":\"Dl4SFW6E\",\"designpatterns_creational_abstract-factory.md\":\"DDzbz24Q\",\"designpatterns_creational_builder.md\":\"DvCuFcUO\",\"designpatterns_creational_factory-method.md\":\"CYQq1kNu\",\"designpatterns_creational_prototype.md\":\"Cv_K7-Vv\",\"designpatterns_creational_singleton.md\":\"DptnixHL\",\"designpatterns_index.md\":\"Dzp-fQ47\",\"designpatterns_microservices_api-gateway.md\":\"vpfmi1t9\",\"designpatterns_microservices_circuit-breaker.md\":\"z_DBS6D1\",\"designpatterns_microservices_cqrs.md\":\"CN9zllvO\",\"designpatterns_microservices_event-sourcing.md\":\"DSKtMQUz\",\"designpatterns_microservices_service-discovery.md\":\"Bxg6TLDT\",\"designpatterns_modern_dependency-injection.md\":\"YdS9Dizl\",\"designpatterns_modern_mvc.md\":\"DMDRRuy1\",\"designpatterns_modern_mvp.md\":\"s4LYIye9\",\"designpatterns_modern_mvvm.md\":\"BcaaRzUM\",\"designpatterns_modern_pub-sub.md\":\"CWmUtwrh\",\"designpatterns_structural_adapter.md\":\"KICMntOI\",\"designpatterns_structural_bridge.md\":\"BOsNI2uC\",\"designpatterns_structural_composite.md\":\"Bhiy40Gn\",\"designpatterns_structural_decorator.md\":\"CY_3WUcI\",\"designpatterns_structural_facade.md\":\"B1hJWSlo\",\"designpatterns_structural_flyweight.md\":\"BGslTXQ6\",\"designpatterns_structural_proxy.md\":\"B4a2SFkw\",\"designpatterns_模版方法.md\":\"CbL_WWmk\",\"docs_hello.md\":\"COj6-58i\",\"english_index.md\":\"BONxawYR\",\"english_四级_index.md\":\"C7zeETRW\",\"fdu_index.md\":\"CqPgR3PH\",\"fdu_英语_index.md\":\"De3dzhzE\",\"fdu_计算机图像_lisa.md\":\"Pa15dSxA\",\"git_basic.md\":\"2FwZ00fS\",\"git_index.md\":\"BclbLgDe\",\"index.md\":\"B232HLpX\",\"interview_2025.md\":\"Csvm-ras\",\"interview_browser.md\":\"Dl9sYFhD\",\"interview_coding.md\":\"WUdaREz1\",\"interview_css.md\":\"Cb3cDgmn\",\"interview_html.md\":\"DB3Vcsdl\",\"interview_js.md\":\"C4SgRpn_\",\"interview_network.md\":\"B3EWf41Z\",\"interview_project.md\":\"Cs28OKLB\",\"interview_react.md\":\"85ORgDgU\",\"interview_typescript.md\":\"BIfSWblY\",\"interview_webpack.md\":\"OK3ehHNh\",\"java_index.md\":\"Dr2eKzdt\",\"java_schedu.md\":\"MMjt9p_I\",\"javascript_advance_browser.md\":\"DkDD-jGm\",\"javascript_advance_execution.md\":\"DNEjgCD9\",\"javascript_advance_executioncontext.md\":\"C4pJNqTg\",\"javascript_advance_executionstack.md\":\"CbmjDonk\",\"javascript_basic_你不知道的js.md\":\"B7SphomR\",\"linux_index.md\":\"BI-aYqW6\",\"mine_about.md\":\"CyCx57aC\",\"mine_resume.md\":\"Cu1_Vvts\",\"mine_resume_fudan.md\":\"EPAPfzCC\",\"ml_index.md\":\"BdBmQikN\",\"mobile_pha.md\":\"DQUcMB7x\",\"nav_index.md\":\"DBGYuULY\",\"next_deploy.md\":\"BWT-oKIa\",\"next_index.md\":\"CDBHXDOJ\",\"node_packages.md\":\"RPBroNZx\",\"os_chapter1.md\":\"swdB5HaX\",\"os_chapter2.md\":\"fQ-MMAkH\",\"os_chapter3.md\":\"TJXIGToX\",\"os_chapter4.md\":\"C3hYHi48\",\"os_chapter5.md\":\"DP53bhqg\",\"os_强化.md\":\"0tWCGs0l\",\"password_github.md\":\"Cpcu0JRk\",\"postgraduate_school.md\":\"7thy-vh0\",\"posts_communicationmechanisms.md\":\"rA42TSfC\",\"posts_compareviteandwebpack.md\":\"BuMgKETj\",\"posts_dataprefetch.md\":\"BBENDY1-\",\"posts_gitlab-mcp.md\":\"CNALp1km\",\"posts_im多端一致性.md\":\"DJ6y2q3F\",\"posts_index.md\":\"C8leTv_D\",\"posts_rendermode.md\":\"80v_AfF0\",\"posts_rpxtovw.md\":\"BwykzCvi\",\"posts_seo.md\":\"Dsu2pSW9\",\"posts_skelon.md\":\"p6qtY__a\",\"posts_uno-css-jp.md\":\"Cj3QqRFm\",\"posts_vuetopdf.md\":\"B8pGHbZc\",\"posts_埋点.md\":\"DVFZa78i\",\"posts_性能优化.md\":\"Bz2yJT2f\",\"project_aem.md\":\"BGzzzKiu\",\"project_component_ssr.md\":\"Dq9FC3Py\",\"project_cross_border.md\":\"BdvX7sve\",\"project_gaoding_agenteditor.md\":\"ckU3P9pO\",\"project_gaoding_ai_智能设计编辑器架构文档_01-产品全景.md\":\"MQO2Phgk\",\"project_gaoding_ai_智能设计编辑器架构文档_02-整体架构设计.md\":\"Bj1Et-QC\",\"project_gaoding_ai_智能设计编辑器架构文档_03-编辑器基座.md\":\"B4ktSu9w\",\"project_gaoding_ai_智能设计编辑器架构文档_04-扩展插件系统.md\":\"CBM4Z_PM\",\"project_gaoding_ai_智能设计编辑器架构文档_05-无限画布渲染引擎.md\":\"DE26Eh6v\",\"project_gaoding_ai_智能设计编辑器架构文档_06-ai对话系统核心技术.md\":\"CeCtGffw\",\"project_gaoding_ai_智能设计编辑器架构文档_07-agent工作流程.md\":\"B6-e3i-I\",\"project_gaoding_ai_智能设计编辑器架构文档_08-ai工具实现指南.md\":\"DEbcdDGT\",\"project_gaoding_ai_智能设计编辑器架构文档_08-性能优化与错误处理.md\":\"B4ajcCam\",\"project_gaoding_ai_智能设计编辑器架构文档_09-核心代码实现.md\":\"DmnDzy-y\",\"project_gaoding_ai_智能设计编辑器架构文档_10-总结与展望.md\":\"Dsmj8fuP\",\"project_gaoding_ai_智能设计编辑器架构文档_11-附录-技术栈与术语.md\":\"C1R752Gj\",\"project_gaoding_ai_智能设计编辑器架构文档_ai-chat-react详细分析.md\":\"DtESur9N\",\"project_gaoding_ai_智能设计编辑器架构文档_ai_智能设计编辑器架构文档-完整版-备份.md\":\"CGes8y1H\",\"project_gaoding_ai_智能设计编辑器架构文档_ai对话系统深度解析-1-概述与架构.md\":\"uKfyfwLQ\",\"project_gaoding_ai_智能设计编辑器架构文档_ai对话系统深度解析-2-消息流转.md\":\"Cxp0Xwcm\",\"project_gaoding_ai_智能设计编辑器架构文档_ai对话系统深度解析-3-三种模式.md\":\"D3z1Gt8W\",\"project_gaoding_ai_智能设计编辑器架构文档_ai对话系统深度解析-4-会话管理.md\":\"C0KClO_K\",\"project_gaoding_ai_智能设计编辑器架构文档_ant-design-x在ai-chat-react中的使用.md\":\"CuwqxYXo\",\"project_gaoding_ai_智能设计编辑器架构文档_readme.md\":\"PsxZAu44\",\"project_gaoding_ai扩图.md\":\"CB2z4iy9\",\"project_gaoding_ai视频.md\":\"CfRGOMW3\",\"project_gaoding_gd绩效考核.md\":\"Bn_3VyqH\",\"project_gaoding_huaban.md\":\"CYDvRe1C\",\"project_gaoding_index.md\":\"D0fYq5Vl\",\"project_gaoding_search_灵感推荐词.md\":\"CpCBBrDe\",\"project_gaoding_search_画板详情页.md\":\"BQGM5ula\",\"project_gaoding_search_相似画板.md\":\"DltPvGg9\",\"project_gaoding_稿定ai-agent架构深度解析.md\":\"Rlac_Xvn\",\"project_gaoding_稿定推荐能力_介绍与接入_page.md\":\"hgMy8Dg0\",\"project_gaoding_稿定搜索能力_介绍与接入_page.md\":\"ChXTgGd8\",\"project_gaoding_编辑器基座化.md\":\"DFunAHKs\",\"project_gaoding_花瓣推荐能力介绍_attachments_01 推荐能力_介绍与接入_page.md\":\"hU6K9grw\",\"project_gaoding_花瓣推荐能力介绍_page.md\":\"CPmmPkie\",\"project_gaoding_花瓣搜索能力介绍_page.md\":\"C-4PbG08\",\"project_generate_icon.md\":\"B5_-6llH\",\"project_index.md\":\"CxwtbAVn\",\"project_lerna_monorepo.md\":\"BCO3a9B1\",\"project_linyang.md\":\"JxRr3koB\",\"project_local_return.md\":\"B1KqR_2O\",\"project_odin_document.md\":\"DY_auabg\",\"project_platform_ai-service.md\":\"CQ9--3TN\",\"project_platform_video-architecture.md\":\"C_zO459J\",\"project_react-intl.md\":\"Dj5YlQYs\",\"project_ssr_operate.md\":\"C2S3n0Ur\",\"project_taojp.md\":\"QRjpqkQq\",\"project_tmm_architecture.md\":\"CgSvmFGY\",\"project_tmm_index.md\":\"BZkWsv0s\",\"project_tmm_local_search.md\":\"CvmYfV4-\",\"project_tmm_mention.md\":\"kc91XI6j\",\"project_tmm_partfileupload.md\":\"CoimmWuG\",\"project_tmm_performance_optimization.md\":\"ymH3aFLo\",\"project_tmm_rbac.md\":\"DjaWmugq\",\"project_tmm_resources_manner.md\":\"DxPUezkc\",\"react_core_createelement.md\":\"A93czNt5\",\"react_core_intro.md\":\"D7F3yV9b\",\"react_core_stream.md\":\"DB7yIwhc\",\"react_customhook_hooks.md\":\"B4uG3dtH\",\"react_customhook_usesetstate.md\":\"DToSNivn\",\"react_record_thinking.md\":\"gQdArgFv\",\"react_utils_type.md\":\"Bxs02jyX\",\"record_amap.md\":\"ZfxtKwa6\",\"record_nvm.md\":\"CNLNNdsn\",\"record_tallking.md\":\"CagWMAVe\",\"sam_index.md\":\"KNdDrqSc\",\"sam_sam主体选择深度解析.md\":\"CsUWq7MY\",\"shell_index.md\":\"DiMzyoVO\",\"softexam_database.md\":\"DdxwF6Gt\",\"softexam_架构师_01绪论.md\":\"kxr_b04b\",\"softexam_架构师_02计算机系统基础知识.md\":\"BwzEHOWY\",\"softexam_架构师_11月论文预测.md\":\"BsZUTwHB\",\"softexam_架构师_2025年11月论文重点准备.md\":\"C8S3PmYQ\",\"softexam_架构师_xx.md\":\"8ZdpP6G4\",\"softexam_架构师_案例.md\":\"1s_C2aph\",\"softexam_架构师_论文-背诵.md\":\"BmIUFPIk\",\"softexam_架构师_论文.md\":\"CENR_oWA\",\"softexam_架构师_论文_soa.md\":\"Bl1Co-VC\",\"softexam_架构师_论文_微服务.md\":\"DjtEbeky\",\"softexam_架构师_论文_微服务_完整版.md\":\"Dr0aYAqj\",\"softexam_架构师_论文_重点准备要点_2025-11预测.md\":\"o8VljkKW\",\"softexam_架构师_论文主题化模版.md\":\"CpgdkI8U\",\"softexam_架构师_论文大纲.md\":\"BePTJVJM\",\"softexam_架构师_论文最终版.md\":\"BwJfH3ny\",\"softexam_架构师_论文要求.md\":\"2HEPuoA3\",\"softexam_架构师_论文通用模版.md\":\"D6CYX3vx\",\"softexam_架构师_论文预测.md\":\"zBuRjYaT\",\"softexam_软件工程.md\":\"wKyJO0qb\",\"softexam_软件设计师_2016上半年上午.md\":\"7EoicX1Z\",\"softexam_软件设计师_2020下半年下午.md\":\"u3AR7IGk\",\"softexam_软件设计师_index.md\":\"D6MVUMvU\",\"softexam_软件设计师_schedule.md\":\"DsANlIgE\",\"softexam_软件设计师_软件工程必备知识点.md\":\"BVDW8uLe\",\"softexam_面向对象.md\":\"CeGJmsfD\",\"test.md\":\"_jpSY386\",\"todo_2025.md\":\"BqIKrqwj\",\"todo_index.md\":\"BBJDVk--\",\"typescript_advance.md\":\"CUZ7z7B3\",\"typescript_class.md\":\"BqFCeMTd\",\"typescript_costums.md\":\"DjLgQwlY\",\"typescript_记录.md\":\"C3Brd1Uf\",\"utils_throttle.md\":\"0CWgvb4P\",\"utils_utils.md\":\"D9B24QHw\",\"vite_basic.md\":\"CkvAxzPr\",\"vue_advanced_animation.md\":\"aslrlth9\",\"vue_advanced_directive.md\":\"gCzIrE5H\",\"vue_advanced_generic.md\":\"DwA5qK_7\",\"vue_advanced_hooks.md\":\"YnvbURrm\",\"vue_advanced_index.md\":\"5a48iMid\",\"vue_advanced_performance.md\":\"DlyPn3MR\",\"vue_basic.md\":\"D8bvYAyH\",\"vue_basic_component-communication.md\":\"CjS4A1wo\",\"vue_basic_composition-api.md\":\"BmzgvNPm\",\"vue_basic_index.md\":\"DIvV_BTR\",\"vue_basic_reactivity.md\":\"BJvdCAeG\",\"vue_basic_template.md\":\"D8AtVTQe\",\"vue_ecosystem_build.md\":\"DabU794j\",\"vue_ecosystem_devtools.md\":\"lC0YzMUZ\",\"vue_ecosystem_index.md\":\"KfDy0smq\",\"vue_ecosystem_pinia.md\":\"DvyOLwSP\",\"vue_ecosystem_router.md\":\"4O6z9tWr\",\"vue_ecosystem_test.md\":\"D-F2lV-C\",\"vue_ecosystem_ui.md\":\"BSQtN1yc\",\"vue_index.md\":\"Ce471tYe\",\"vue_principle_compiler.md\":\"BQzu95fS\",\"vue_principle_index.md\":\"CXc0jD-e\",\"vue_principle_reactivity.md\":\"Bl5DGkar\",\"vue_schudle.md\":\"tvaxi_cM\",\"webpack_basic.md\":\"DMpqOIjM\",\"webpack_index.md\":\"5gcYdneV\",\"webpack_optimization.md\":\"CZuG2eGW\",\"webpack_performance.md\":\"DWC5EXil\",\"webpack_practice.md\":\"DygGtynk\",\"webpack_principle.md\":\"CV4lp297\",\"webpack_unocss.md\":\"Bla6Rf1o\",\"webpack_埋点.md\":\"BKDCGhZ5\",\"welcome.md\":\"BbvqWCWu\",\"work_index.md\":\"nt243u3F\",\"work_sms_back.md\":\"CZVvzyvS\",\"work_sms_refactor_plan.md\":\"D2XyqvF-\",\"组成原理_chapter1.md\":\"CzYdO86M\",\"组成原理_chapter2.md\":\"BmeVzgRC\",\"组成原理_chapter3.md\":\"CxKs5H_U\",\"组成原理_chapter4.md\":\"BOqgxpz5\",\"组成原理_chapter5.md\":\"CCahwqHx\",\"组成原理_chapter6.md\":\"BMqfgs4K\",\"组成原理_chapter7.md\":\"DKEEdFAv\",\"组成原理_强化.md\":\"BEqxeBN_\",\"计网_chapter1.md\":\"DWuEGmYo\",\"计网_chapter2.md\":\"DWs1b6Cy\",\"计网_chapter3.md\":\"Bw3Jtv7N\",\"计网_http.md\":\"BHpfn0U-\",\"计网_https.md\":\"XOe9jzFm\",\"计网_websocket.md\":\"BjEszD_D\",\"计网_强化.md\":\"CnNpR8y2\",\"项目管理_index.md\":\"CmNYebsq\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"林岑LynnCenʘᴗʘ \",\"description\":\"林岑的成长之路，包含前端常用知识、源码阅读笔记、各种奇淫技巧、日常提效工具等\",\"base\":\"/Lyc-notes/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"i18nRouting\":false,\"logo\":\"/LynnCenLogo.png\",\"nav\":[{\"text\":\"WebFront\",\"items\":[{\"text\":\"前端基础\",\"items\":[{\"text\":\"Javascript基础\",\"activeMatch\":\"Javascript/basic/\",\"link\":\"Javascript/basic/你不知道的js\"},{\"text\":\"Javascript进阶\",\"activeMatch\":\"Javascript/Advance/\",\"link\":\"Javascript/Advance/executionContext\"},{\"text\":\"Typescript\",\"activeMatch\":\"/typescript/\",\"link\":\"/typescript/记录\"}]},{\"text\":\"Framework\",\"items\":[{\"text\":\"React\",\"activeMatch\":\"/react/\",\"link\":\"react/core/intro\"},{\"text\":\"Vue\",\"activeMatch\":\"/Vue/\",\"link\":\"Vue/basic\"}]},{\"text\":\"Engineering\",\"items\":[{\"text\":\"WebPack\",\"activeMatch\":\"/webpack/\",\"link\":\"webpack/performance\"},{\"text\":\"Node\",\"activeMatch\":\"/node/\",\"link\":\"node/packages\"},{\"text\":\"Vite\",\"activeMatch\":\"/vite/\",\"link\":\"vite/basic\"},{\"text\":\"Git\",\"activeMatch\":\"/git/\",\"link\":\"git/basic\"}]},{\"text\":\"浏览器\",\"items\":[{\"text\":\"浏览器原理\",\"activeMatch\":\"/browser/\",\"link\":\"/browser/Chrome架构\"}]}]},{\"text\":\"ComputerBasics\",\"items\":[{\"text\":\"计算机组成原理\",\"items\":[{\"text\":\"计算机组成原理基础\",\"link\":\"/组成原理/chapter1\"}]},{\"text\":\"数据结构\",\"items\":[{\"text\":\"数据结构基础\",\"link\":\"/dataStructure/chapter1\"},{\"text\":\"课后习题\",\"link\":\"/dataStructure/chapter1_ex\"}]},{\"text\":\"操作系统OS\",\"items\":[{\"text\":\"操作系统基础\",\"link\":\"/os/chapter1\"}]},{\"text\":\"计算机网络\",\"items\":[{\"text\":\"计算机网络基础\",\"link\":\"/计网/chapter1\"}]},{\"text\":\"408\",\"items\":[{\"text\":\"408真题\",\"link\":\"/408/2009\"}]},{\"text\":\"设计模式\",\"link\":\"/designPatterns/index\"}]},{\"text\":\"AI\",\"items\":[{\"text\":\"MCP\",\"items\":[{\"text\":\"BrowserTools MCP\",\"link\":\"/AI/mcp/browserTools\"},{\"text\":\"Figma Dev Mode MCP\",\"link\":\"/AI/mcp/figma\"}]},{\"text\":\"Dify\",\"items\":[{\"text\":\"Dify\",\"link\":\"/AI/Dify/index\"}]},{\"text\":\"Posts\",\"items\":[{\"text\":\"LLM\",\"link\":\"/posts/llm\"}]}]},{\"text\":\"SoftExame\",\"items\":[{\"text\":\"软考-软件设计师\",\"link\":\"/softExam/软件设计师/index\"},{\"text\":\"软考-系统架构设计师\",\"link\":\"/softExam/架构师/index\"}]},{\"text\":\"Interview\",\"activeMatch\":\"/interview/\",\"link\":\"/interview/js\"}],\"sidebar\":{\"/Javascript/\":[{\"text\":\"JS引擎\",\"link\":\"Javascript/Advance/execution\"},{\"text\":\"调用堆栈\",\"items\":[{\"text\":\"执行上下文和执行栈\",\"link\":\"Javascript/Advance/executionContext\"},{\"text\":\"执行上下文栈和变量对象\",\"link\":\"Javascript/Advance/executionStack\"}]}],\"/Vue/\":[{\"text\":\"Vue学习规划\",\"link\":\"/Vue/schudle\"},{\"text\":\"Vue基础\",\"items\":[{\"text\":\"响应式系统\",\"link\":\"/Vue/basic/reactivity\"},{\"text\":\"模板语法与指令\",\"link\":\"/Vue/basic/template\"},{\"text\":\"组件通信\",\"link\":\"/Vue/basic/component-communication\"},{\"text\":\"Composition API\",\"link\":\"/Vue/basic/composition-api\"}]},{\"text\":\"Vue进阶\",\"items\":[{\"text\":\"hooks\",\"link\":\"/Vue/advanced/hooks\"},{\"text\":\"自定义指令\",\"link\":\"/Vue/advanced/directive\"},{\"text\":\"动画\",\"link\":\"/Vue/advanced/animation\"},{\"text\":\"性能优化\",\"link\":\"/Vue/advanced/performance\"},{\"text\":\"项目架构设计\",\"link\":\"/Vue/advanced/architecture\"}]},{\"text\":\"Vue 生态篇\",\"items\":[{\"text\":\"Vue Router\",\"link\":\"/Vue/ecosystem/router\"},{\"text\":\"Pinia状态管理\",\"link\":\"/Vue/ecosystem/pinia\"},{\"text\":\"构建工具\",\"link\":\"/Vue/ecosystem/build\"},{\"text\":\"Vue Devtools\",\"link\":\"/Vue/ecosystem/devtools\"},{\"text\":\"UI库\",\"link\":\"/Vue/ecosystem/ui\"},{\"text\":\"测试\",\"link\":\"/Vue/ecosystem/test\"}]},{\"text\":\"Vue原理\",\"items\":[{\"text\":\"深入响应式系统\",\"link\":\"/Vue/principle/reactivity\"},{\"text\":\"编译器原理\",\"link\":\"/Vue/principle/compiler\"}]}],\"/typescript/\":[{\"text\":\"TypeScript\",\"link\":\"/typescript/记录\"},{\"text\":\"TypeScript进阶\",\"link\":\"/typescript/advance\"},{\"text\":\"Class\",\"link\":\"/typescript/class\"}],\"/react/\":[{\"text\":\"React源码详解\",\"items\":[{\"text\":\"第一篇 React运行全流程\",\"link\":\"/react/core/intro\"},{\"text\":\"第二篇 JSX 是如何转换为 React.createElement\",\"link\":\"/react/core/createElement\"}]},{\"text\":\"React实践\",\"items\":[{\"text\":\"思考\",\"link\":\"/react/record/thinking\"},{\"text\":\"自定义Hooks\",\"link\":\"/react/customHook/hooks\"},{\"text\":\"React with TS\",\"link\":\"/react/utils/type\"}]}],\"/interview/\":[{\"text\":\"HTML\",\"link\":\"/interview/html\"},{\"text\":\"CSS\",\"link\":\"/interview/css\"},{\"text\":\"Javascript\",\"link\":\"/interview/js\"},{\"text\":\"React\",\"link\":\"/interview/react\"},{\"text\":\"Typescript\",\"link\":\"/interview/typescript\"},{\"text\":\"WebPack\",\"link\":\"/interview/webpack\"},{\"text\":\"浏览器\",\"link\":\"/interview/browser\"},{\"text\":\"网络\",\"link\":\"/interview/network\"},{\"text\":\"项目总结\",\"link\":\"/project/index\"},{\"text\":\"笔试题\",\"link\":\"/interview/coding\"}],\"/os/\":[{\"text\":\"操作系统基础\",\"items\":[{\"text\":\"第一章 操作系统引论\",\"link\":\"/os/chapter1\"},{\"text\":\"第二章 进程与线程\",\"link\":\"/os/chapter2\"},{\"text\":\"第三章 内存管理\",\"link\":\"/os/chapter3\"},{\"text\":\"第四章 文件管理\",\"link\":\"/os/chapter4\"},{\"text\":\"第五章 磁盘和固态硬盘\",\"link\":\"/os/chapter5\"},{\"text\":\"强化\",\"link\":\"/os/强化\"}]}],\"/408/\":[{\"text\":\"2009真题\",\"link\":\"/408/2009\"},{\"text\":\"2010真题\",\"link\":\"/408/2010\"},{\"text\":\"2011真题\",\"link\":\"/408/2011\"},{\"text\":\"2012真题\",\"link\":\"/408/2012\"},{\"text\":\"2013真题\",\"link\":\"/408/2013\"},{\"text\":\"2014真题\",\"link\":\"/408/2014\"},{\"text\":\"2015真题\",\"link\":\"/408/2015\"},{\"text\":\"2016真题\",\"link\":\"/408/2016\"},{\"text\":\"2017真题\",\"link\":\"/408/2017\"},{\"text\":\"2018真题\",\"link\":\"/408/2018\"},{\"text\":\"2019真题\",\"link\":\"/408/2019\"}],\"计网\":[{\"text\":\"强化\",\"link\":\"/计网/强化\"}],\"/dataStructure/\":[{\"text\":\"数据结构\",\"items\":[{\"text\":\"第一章 绪论\",\"link\":\"/dataStructure/chapter1\"},{\"text\":\"第二章 线性表\",\"link\":\"/dataStructure/chapter2\"},{\"text\":\"第三章 栈、队列和数组\",\"link\":\"/dataStructure/chapter3\"},{\"text\":\"第四章 串\",\"link\":\"/dataStructure/chapter4\"},{\"text\":\"第五章 树与二叉树\",\"link\":\"/dataStructure/chapter5\"},{\"text\":\"第六章 图\",\"link\":\"/dataStructure/chapter6\"},{\"text\":\"第七章 查找\",\"link\":\"/dataStructure/chapter7\"},{\"text\":\"第八章 排序\",\"link\":\"/dataStructure/chapter8\"}]},{\"text\":\"课后习题\",\"items\":[{\"text\":\"第一章 绪论\",\"link\":\"/dataStructure/chapter1_ex\"},{\"text\":\"第二章 线性表\",\"link\":\"/dataStructure/chapter2_ex\"},{\"text\":\"强化\",\"link\":\"/dataStructure/强化\"}]}],\"/组成原理/\":[{\"text\":\"计算机组成原理\",\"items\":[{\"text\":\"第一章 计算机系统概述\",\"link\":\"/组成原理/chapter1\"},{\"text\":\"第二章 数据的表示和运算\",\"link\":\"/组成原理/chapter2\"},{\"text\":\"第三章 存储系统\",\"link\":\"/组成原理/chapter3\"},{\"text\":\"第四章 指令系统\",\"link\":\"/组成原理/chapter4\"},{\"text\":\"第五章 中央处理器\",\"link\":\"/组成原理/chapter5\"},{\"text\":\"第六章 总线\",\"link\":\"/组成原理/chapter6\"},{\"text\":\"第七章 输入/输出系统\",\"link\":\"/组成原理/chapter7\"},{\"text\":\"强化\",\"link\":\"/组成原理/强化\"}]}],\"/webpack/\":[{\"text\":\"WebPack\",\"items\":[{\"text\":\"基础篇\",\"link\":\"/webpack/basic\"},{\"text\":\"实战篇\",\"link\":\"/webpack/practice\"},{\"text\":\"优化篇\",\"link\":\"/webpack/optimization\"},{\"text\":\"原理篇\",\"link\":\"/webpack/principle\"},{\"text\":\"性能优化\",\"link\":\"/webpack/performance\"}]}],\"/browser/\":[{\"text\":\"宏观视角下的浏览器\",\"items\":[{\"text\":\"Chorme架构\",\"link\":\"/browser/Chrome架构\"},{\"text\":\"TCP协议\",\"link\":\"/browser/TCP协议\"},{\"text\":\"HTTP协议\",\"link\":\"/browser/HTTP\"},{\"text\":\"导航流程\",\"link\":\"/browser/导航流程\"},{\"text\":\"渲染流程（上）\",\"link\":\"/browser/renderfirst\"},{\"text\":\"渲染流程（下）\",\"link\":\"/browser/rendersec\"}]},{\"text\":\"Javascript中的执行机制\",\"items\":[{\"text\":\"变量提升\",\"link\":\"/browser/变量提升\"},{\"text\":\"调用栈\",\"link\":\"/browser/调用栈\"},{\"text\":\"块级作用域\",\"link\":\"/browser/块级作用域\"},{\"text\":\"作用域链和闭包\",\"link\":\"/browser/作用域链和闭包\"},{\"text\":\"This\",\"link\":\"/browser/this\"}]},{\"text\":\"V8工作原理\",\"items\":[{\"text\":\"栈空间和堆空间\",\"link\":\"/browser/栈和堆\"},{\"text\":\"垃圾回收\",\"link\":\"/browser/垃圾回收\"},{\"text\":\"编译器和解释器\",\"link\":\"/browser/编译器和解释器\"}]},{\"text\":\"浏览器中的页面循环系统\",\"items\":[{\"text\":\"消息队列和事件循环\",\"link\":\"/browser/消息队列和事件循环\"},{\"text\":\"setTimeout 是如何实现的？\",\"link\":\"/browser/setTimeout如何实现\"},{\"text\":\"XMLHttpRequest 是怎么实现的？\",\"link\":\"/browser/XMLHttpRequest\"},{\"text\":\"宏任务和微任务\",\"link\":\"/browser/宏任务和微任务\"},{\"text\":\"Promise\",\"link\":\"/browser/Promise\"},{\"text\":\"async/await\",\"link\":\"/browser/async&await\"}]},{\"text\":\"浏览器中的页面\",\"items\":[{\"text\":\"Chrome开发者工具\",\"link\":\"/browser/Chrome开发者工具\"},{\"text\":\"DOM树\",\"link\":\"/browser/DOM树\"},{\"text\":\"渲染流水线\",\"link\":\"/browser/渲染流水线\"},{\"text\":\"分层和合成机制\",\"link\":\"/browser/分层和合成\"},{\"text\":\"页面性能\",\"link\":\"/browser/页面性能\"},{\"text\":\"虚拟DOM\",\"link\":\"/browser/虚拟DOM\"},{\"text\":\"渐进式网页应用PWA\",\"link\":\"/browser/渐进式网页应用PWA\"}]},{\"text\":\"浏览器中的网络\",\"items\":[{\"text\":\"HTTP1\",\"link\":\"/browser/HTTP1\"},{\"text\":\"HTTP2\",\"link\":\"/browser/HTTP2\"},{\"text\":\"HTTP3\",\"link\":\"/browser/HTTP3\"}]},{\"text\":\"浏览器安全\",\"items\":[{\"text\":\"同源策略\",\"link\":\"/browser/同源策略\"},{\"text\":\"跨站脚本攻击XSS\",\"link\":\"/browser/跨站脚本攻击XSS\"},{\"text\":\"CSRF攻击\",\"link\":\"/browser/CSRF攻击\"},{\"text\":\"安全沙箱\",\"link\":\"/browser/安全沙箱\"},{\"text\":\"HTTPS\",\"link\":\"/browser/HTTPS\"}]},{\"text\":\"浏览上下文组\",\"link\":\"/browser/浏览上下文组\"},{\"text\":\"任务调度\",\"link\":\"/browser/任务调度\"},{\"text\":\"加载阶段性能\",\"link\":\"/browser/加载阶段性能\"},{\"text\":\"Performance\",\"link\":\"/browser/Performance\"},{\"text\":\"Performance中的Main指标\",\"link\":\"/browser/Performance中的Main指标\"}],\"/计网/\":[{\"text\":\"计算机网络基础\",\"items\":[{\"text\":\"第一章 计算机网络体系结构\",\"link\":\"/计网/chapter1\"},{\"text\":\"第二章 物理层\",\"link\":\"/计网/chapter2\"},{\"text\":\"第三章 数据链路层\",\"link\":\"/计网/chapter3\"}]},{\"text\":\"HTTPS\",\"link\":\"/计网/https\"},{\"text\":\"WebSocket\",\"link\":\"/计网/webSocket\"}],\"/project/\":[{\"text\":\"项目总结\",\"link\":\"/project/index\"},{\"text\":\"TMM\",\"link\":\"/project/tmm\",\"items\":[{\"text\":\"TMM模块重构与架构设计\",\"link\":\"/project/tmm/architecture\"},{\"text\":\"本地化搜索引擎实现\",\"link\":\"/project/tmm/local_search\"},{\"text\":\"@功能的高效实现\",\"link\":\"/project/tmm/mention\"},{\"text\":\"ELectron大文件分片上传、断点续传、并行上传\",\"link\":\"/project/tmm/partFileUpload\"},{\"text\":\"TMM性能优化\",\"link\":\"/project/tmm/performance_optimization\"},{\"text\":\"基于RBAC模型的群组权限体系设计与实现\",\"link\":\"/project/tmm/RBAC\"},{\"text\":\"基于AWS和Node流式大文件下载\",\"link\":\"/project/tmm/resources_manner\"}]}],\"/algorithm/\":[{\"text\":\"退避算法\",\"link\":\"/algorithm/退避算法\"},{\"text\":\"LRU算法\",\"link\":\"/algorithm/LRU\"}],\"/softExame/\":[{\"text\":\"软考-软件设计师\",\"link\":\"/softExam/软件设计师/index\"},{\"text\":\"软考-系统架构设计师\",\"link\":\"/softExam/架构师/index\"},{\"text\":\"时间规划\",\"link\":\"/softExam/软件设计师/schedule\"},{\"text\":\"软件工程\",\"link\":\"/softExam/软件工程\"},{\"text\":\"面向对象\",\"link\":\"/softExam/面向对象\"},{\"text\":\"数据库\",\"link\":\"/softExam/database\"},{}],\"/AI/\":[{\"text\":\"AI\",\"link\":\"/AI/index\"},{\"text\":\"MCP\",\"items\":[{\"text\":\"BrowserTools MCP\",\"link\":\"/AI/mcp/browserTools\"},{\"text\":\"Figma Dev Mode MCP\",\"link\":\"/AI/mcp/figma\"}]},{\"text\":\"Dify\",\"items\":[{\"text\":\"Dify介绍\",\"link\":\"/AI/Dify/index\"}]}],\"/designPatterns/\":[{\"text\":\"设计模式\",\"link\":\"/designPatterns/index\"},{\"text\":\"模版方法\",\"link\":\"/designPatterns/模版方法\"}]},\"search\":{\"provider\":\"local\"},\"outline\":{\"level\":\"deep\",\"label\":\"本页目录\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/LynnCen\"}],\"footer\":{\"message\":\"如有转载或 CV 的请标注本站原文地址\",\"copyright\":\"Copyright © 2024-present LynnCen\"},\"darkModeSwitchLabel\":\"外观\",\"returnToTopLabel\":\"返回顶部\",\"lastUpdatedText\":\"上次更新\",\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"visitor\":{\"badgeId\":\"LynnCen.Lyc-notes\"},\"comment\":{\"repo\":\"LynnCen/Lyc-notes\",\"repoId\":\"R_kgDOLsOwUg\",\"category\":\"Announcements\",\"categoryId\":\"DIC_kwDOLsOwUs4CenzY\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>